# VS_Codebase_v2.md

## Generation Info

- **Repository**: cat_website_execution
- **Generated**: 2026-02-10T04:37:23.996Z
- **Command**: `pnpm run export:vs_codebase:v2`

## REDACTIONS

The following content has been intentionally redacted from this export:

| File Path | What Was Redacted | Reason |
|-----------|-------------------|--------|
| .env, .env.local, .env.*.local | All content | Environment files may contain secrets (API keys, database credentials) |
| scripts/export-vs-codebase-v2.mjs | Entire file excluded | Exclude the export process file itself from the export output |
| VS_Codebase_v2.md | Entire file excluded | Exclude the generated export file from the export output |
| VS_Codebase.md | Entire file excluded | Avoid nesting previous exports into this export |

---

This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

# File Summary

## Purpose
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*
- Files matching these patterns are excluded: .env, .env.local, .env.*.local, .env.development, .env.production, *.pem, *.key, *.p12, *.pfx, id_rsa*, *.jks, service-account*.json, .next/**, node_modules/**, .venv/**, .export_sanitized/**, .export_tmp/**, .repomix-vs-codebase-v2.json, scripts/export-vs-codebase-v2.mjs, VS_Codebase.md, VS_Codebase_v2.md
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)

# Directory Structure
```
.editorconfig
.gitattributes
.github/workflows/ci.yml
.gitignore
.nvmrc
.repomixignore
cat_2025_slot_1.json
cat_2025_slot_1.md
data_sanitized/Cat_2023_slot_1.json
data_sanitized/CAT-2023-Slot-2-v3.json
data_sanitized/cat-2024-mock-1-full.json
data_sanitized/CAT-2024-Slot-1-parsed.json
data_sanitized/cat-2024-slot-1-varc.jsonc
data_sanitized/cat-2024-slot-1.json
data_sanitized/CAT-2024-Slot-2-parsed.json
data_sanitized/CAT-2024-Slot-3-parsed.json
data_sanitized/cat-2024-slot1.json
data_sanitized/CAT-2025-Slot-1-parsed.json
data_sanitized/CAT-2025-Slot-1.json
data_sanitized/CAT-2025-Slot-2-parsed.json
data_sanitized/CAT-2025-Slot-3-v3.json
data_sanitized/paper_schema_v3.template.json
data_sanitized/sample-paper-template.json
docs/AI_ANALYSIS_EXPORT.md
docs/archive/SCHEMA_FIREBASE.md
docs/AUDIT_QUERY_PATHS.md
docs/BLUEPRINT.md
docs/BUG_REPRO_CHECKLIST.md
docs/bug-repro.md
docs/BUGFIX_9FEB_CHECKLIST.md
docs/CONTENT-SCHEMA.md
docs/DECISIONS.md
docs/landing-page.md
docs/MIGRATION_CONTEXTS.sql
docs/MIGRATION_M5_SCORING.sql
docs/MIGRATION_M6_RBAC.sql
docs/MIGRATION_RLS_VIEWS.sql
docs/MIGRATION_STATS.sql
docs/migrations/002_session_locking.sql
docs/migrations/003_question_container_architecture.sql
docs/migrations/004_fetch_attempt_solutions.sql
docs/migrations/005_attempt_state_lockdown.sql
docs/migrations/006_force_resume_session.sql
docs/migrations/006_response_flags.sql
docs/migrations/007_content_ingestion_phases.sql
docs/migrations/008_ingestion_semantic_keys.sql
docs/migrations/009_attempt_submit_rls.sql
docs/migrations/010_force_resume_lenient.sql
docs/migrations/011_prevent_paper_delete_with_attempts.sql
docs/migrations/012_phase1_security_hardening.sql
docs/migrations/013_phase1_security_complete.sql
docs/migrations/014_soften_submit_rls.sql
docs/migrations/015_landing_assets.sql
docs/migrations/016_bug_reports.sql
docs/migrations/017_bug_report_status.sql
docs/migrations/018_purge_attempts_on_auth_delete.sql
docs/migrations/019_force_resume_ultra_lenient.sql
docs/migrations/020_pause_tracking.sql
docs/migrations/021_validate_session_token_atomic.sql
docs/migrations/022_validate_session_token_single_signature.sql
docs/migrations/023_access_control_foundations.sql
docs/migrations/024_access_control_rls.sql
docs/migrations/025_is_admin_safe.sql
docs/migrations/026_access_control_auth_delete_cleanup.sql
docs/migrations/027_access_requests_user_update_policy.sql
docs/migrations/028_cleanup_orphaned_access_control_rows.sql
docs/migrations/029_fix_access_requests_fk_cascade.sql
docs/migrations/030_add_telemetry_columns.sql
docs/migrations/031_add_ai_analysis_columns.sql
docs/Milestone_Change_Log.md
docs/PHASE_0_LAYOUT_GUARDRAILS.md
docs/README.md
docs/REFACTOR_PLAN_5_PROMPTS.md
docs/research/convert_paper_metadata.py
docs/research/stack-evaluation.md
docs/ROOT_CAUSE_ANALYSIS_SUBMIT_ERROR.md
docs/SCHEMA_SUPABASE.sql
eslint.config.mjs
knip.json
middleware.ts
next-env.d.ts
next.config.ts
package.json
paper_v3.json
postcss.config.js
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/window.svg
README.md
schemas/ai_analysis_export.schema.v1.json
schemas/paper_schema_v3.json
scripts/ajv-validator.mjs
scripts/backfill-paper-versions.mjs
scripts/blueprint-guard.mjs
scripts/check-bundle.mjs
scripts/export-paper.mjs
scripts/export-vs-codebase.mjs
scripts/import-paper-v3.mjs
scripts/maintenance/update-paper-descriptions.mjs
scripts/markdown_to_json_parser_v3.mjs
scripts/parse-md-to-v3.mjs
scripts/sanitize-question-data.mjs
scripts/transform-cat-2025-slot-3-md.mjs
scripts/validate-ai-export.mjs
src/app/admin/access-control/actions.ts
src/app/admin/access-control/page.tsx
src/app/admin/ai-analysis/DownloadExportButton.tsx
src/app/admin/ai-analysis/page.tsx
src/app/admin/bug-reports/actions.ts
src/app/admin/bug-reports/BugReportStatusSelect.tsx
src/app/admin/bug-reports/page.tsx
src/app/admin/contexts/new/page.tsx
src/app/admin/contexts/page.tsx
src/app/admin/landing-page/LandingAssetsClient.tsx
src/app/admin/landing-page/page.tsx
src/app/admin/layout.tsx
src/app/admin/page.tsx
src/app/admin/papers/[paperId]/edit/actions.ts
src/app/admin/papers/[paperId]/edit/ExamEditorClient.tsx
src/app/admin/papers/[paperId]/edit/page.tsx
src/app/admin/papers/[paperId]/preview/page.tsx
src/app/admin/papers/[paperId]/preview/PreviewClient.tsx
src/app/admin/papers/[paperId]/questions/page.tsx
src/app/admin/papers/[paperId]/settings/page.tsx
src/app/admin/papers/actions.ts
src/app/admin/papers/ImportPaperButton.tsx
src/app/admin/papers/new/page.tsx
src/app/admin/papers/page.tsx
src/app/admin/papers/PaperActions.tsx
src/app/admin/question-sets/new/NewQuestionSetClient.tsx
src/app/admin/question-sets/new/page.tsx
src/app/admin/question-sets/page.tsx
src/app/admin/questions/actions.ts
src/app/admin/questions/new/page.tsx
src/app/admin/questions/page.tsx
src/app/admin/questions/QuestionRowActions.tsx
src/app/api/_utils/validation.ts
src/app/api/admin/ai-analysis/[attemptId]/export/route.ts
src/app/api/admin/papers/[paperId]/export/route.ts
src/app/api/admin/papers/import/route.ts
src/app/api/admin/question-sets/route.ts
src/app/api/attempt-status/route.ts
src/app/api/pause/route.ts
src/app/api/progress/route.ts
src/app/api/save-batch/route.ts
src/app/api/save/route.ts
src/app/api/session/route.ts
src/app/api/submit/route.ts
src/app/auth/callback/route.ts
src/app/auth/logout/route.ts
src/app/auth/sign-in/page.tsx
src/app/auth/test-login/page.tsx
src/app/coming-soon/page.tsx
src/app/dashboard/page.tsx
src/app/exam/[attemptId]/ExamClient.tsx
src/app/exam/[attemptId]/page.tsx
src/app/favicon.ico
src/app/globals.css
src/app/layout.tsx
src/app/mock/[paperId]/page.tsx
src/app/mocks/page.tsx
src/app/page.module.css
src/app/page.tsx
src/app/result/[attemptId]/AIAnalysisButton.tsx
src/app/result/[attemptId]/page.tsx
src/app/result/[attemptId]/ResultReviewClient.tsx
src/app/result/[attemptId]/ResultTabsClient.tsx
src/components/AuthenticatedOverlays.tsx
src/components/BackToDashboard.tsx
src/components/BugReportFab.tsx
src/components/landing/LandingPageClient.tsx
src/components/TopProgressBar.tsx
src/components/useFocusTrap.ts
src/features/admin/config/topicOptions.ts
src/features/admin/index.ts
src/features/admin/ui/EditableExamLayout.tsx
src/features/admin/ui/EditableQuestion.tsx
src/features/admin/ui/MarkdownToolbar.tsx
src/features/admin/ui/QuestionSetEditor.tsx
src/features/exam-engine/api/client.ts
src/features/exam-engine/hooks/useExamTimer.ts
src/features/exam-engine/index.ts
src/features/exam-engine/lib/__tests__/scoring.test.ts
src/features/exam-engine/lib/actions.ts
src/features/exam-engine/lib/assemblePaper.ts
src/features/exam-engine/lib/ExamClient.tsx
src/features/exam-engine/lib/index.ts
src/features/exam-engine/lib/scoring.ts
src/features/exam-engine/lib/validation.ts
src/features/exam-engine/model/useExamStore.ts
src/features/exam-engine/ui/Calculator.tsx
src/features/exam-engine/ui/DevToolsPanel.tsx
src/features/exam-engine/ui/ExamFooter.tsx
src/features/exam-engine/ui/ExamLayout.tsx
src/features/exam-engine/ui/ExamTimer.tsx
src/features/exam-engine/ui/index.ts
src/features/exam-engine/ui/MathText.tsx
src/features/exam-engine/ui/MCQRenderer.tsx
src/features/exam-engine/ui/NavigationButtons.tsx
src/features/exam-engine/ui/QuestionAnalysis.tsx
src/features/exam-engine/ui/QuestionPalette.tsx
src/features/exam-engine/ui/QuestionRenderer.tsx
src/features/exam-engine/ui/ResultHeader.tsx
src/features/exam-engine/ui/SectionalPerformance.tsx
src/features/exam-engine/ui/TITARenderer.tsx
src/features/shared/ui/PaletteShell.tsx
src/lib/access-control.ts
src/lib/ajv-validator.ts
src/lib/analysis/generateCompositeContextPacket.ts
src/lib/analysis/validateAiAnalysisExport.ts
src/lib/cloudinary.ts
src/lib/devTools.ts
src/lib/examDebug.ts
src/lib/landing-assets.ts
src/lib/logger.ts
src/lib/rate-limit.ts
src/lib/supabase/client.ts
src/lib/supabase/server.ts
src/lib/supabase/service-role.ts
src/lib/telemetry.ts
src/lib/useLandingAssets.ts
src/types/exam.ts
src/types/react-katex.d.ts
src/utils/question-sets.ts
src/utils/update-session.ts
tailwind.config.js
test.json
test.md
tsconfig.json
tsconfig.tsbuildinfo
vitest.config.ts
vs-codebase-export.bat
vs-codebase-export.ps1
```

# Files

## File: docs/AI_ANALYSIS_EXPORT.md
````markdown
# AI Analysis Export — Integration Map & Implementation Plan

> **Generated**: 2026-02-10
> **Phase**: 0 (Reconnaissance) + Phase 1 (DB lifecycle)
> **Schema version**: `1.0.0`

---

## A) Reuse Patterns

### 1. Admin Auth Guard

| Aspect | Detail |
|---|---|
| **Reference file** | `src/app/api/admin/papers/[paperId]/export/route.ts` L64–L102 |
| **Functions** | `verifyAdmin()` → `verifyAdminRole()` |
| **How it works** | Creates SSR client via `createActionClient()` (anon key + cookies). Calls `getUser()`, falls back to `getSession()`. Checks `app_metadata.user_role` for `'admin'` / `'dev'`. Falls back to JWT decode, then `is_admin` RPC. Dev bypass: `SKIP_ADMIN_CHECK=true` (non-production only). |
| **Pattern to copy** | The `verifyAdmin()` + `verifyAdminRole()` block (~40 lines). Self-contained, battle-tested. |
| **Note** | Middleware (L68–L72) **skips** `/api/` routes — API routes must self-guard. |

### 2. Paper Export Route Structure (file download)

| Aspect | Detail |
|---|---|
| **Handler signature** | `export async function GET(req: NextRequest, { params }: { params: Promise<{ paperId: string }> })` |
| **Content-Type** | `application/json` |
| **Content-Disposition** | `attachment; filename="${filename}"` |
| **Cache-Control** | `no-store` |
| **Filename convention** | `${slug}_v3.json`, `paper_${id}_assembled.json`, etc. |
| **Response** | `new NextResponse(jsonString, { status: 200, headers: {...} })` |
| **Error pattern** | `NextResponse.json({ error: message }, { status: 4xx/5xx })` |
| **For AI export** | Same pattern. Filename: `${slug}_attempt_${attemptId}_ai_context.json` |

### 3. Supabase Admin Client (service role)

| Aspect | Detail |
|---|---|
| **Shared module** | `src/lib/supabase/service-role.ts` → `getServiceRoleClient()` |
| **Import guard** | `import 'server-only'` prevents client-side import |
| **Inline version** | Paper export has its own `getAdminClient()` at L22–L35 (identical logic) |
| **SSR client** | `src/lib/supabase/server.ts` → `sbSSR()` (cookie-aware, user-scoped) |
| **For AI export** | Use `getServiceRoleClient()` to fetch questions with correct answers (bypasses `questions_exam` view that strips answers). Use SSR client for auth check only. |

### 4. Result Tabs / CTA Insertion Point

| Aspect | Detail |
|---|---|
| **File** | `src/app/result/[attemptId]/page.tsx` L500–L524 |
| **Action buttons div** | `<div className="flex flex-wrap justify-center gap-4 pt-4">` with "Back to Dashboard" + "Take Another Mock" links |
| **CTA placement** | Add a third button/link after "Take Another Mock" for "Export AI Context" |
| **Data available** | `attempt.id`, `attempt.paper_id`, user is authenticated at this point |
| **Implementation** | `<a href="/api/result/${attempt.id}/export-ai-context" download>` or client-side fetch + blob download |

### 5. Paper Version Snapshot

| Aspect | Detail |
|---|---|
| **papers table** | Has `latest_ingest_run_id UUID` (FK to `paper_ingest_runs(id)`) — added in migration 007 |
| **paper_ingest_runs** | Has `version_number`, `canonical_paper_json JSONB`, `schema_version`, `canonical_json_hash` |
| **Attempt-time snapshot** | Currently **not captured**. Must store `paper_ingest_run_id` on `attempts` at creation time to freeze the paper version. |

---

## B) Minimal New Files

| # | File Path | Purpose |
|---|---|---|
| 1 | `src/app/api/result/[attemptId]/export-ai-context/route.ts` | **API route** — GET handler. Auth check (own attempt OR admin), assembles composite JSON, returns as file download. |
| 2 | `src/features/exam-engine/lib/generateCompositeContext.ts` | **Service function** — `generateCompositeContextPacket()`. Queries attempt + paper + questions (with answers) + responses + contexts. Returns typed export object. |
| 3 | `docs/migrations/031_add_ai_analysis_columns.sql` | **Migration** — Adds `ai_analysis_status` enum, lifecycle columns, `paper_ingest_run_id` snapshot on `attempts`. |

No new type files needed — extend `src/types/exam.ts` with `AIAnalysisStatus` and updated `Attempt` interface.

---

## C) Existing Files to Modify

| # | File | Change | Location |
|---|---|---|---|
| 1 | `src/app/result/[attemptId]/page.tsx` | Add "Export AI Context" CTA button in action buttons div | After "Take Another Mock" link (~L519) |
| 2 | `src/types/exam.ts` | Add `AIAnalysisStatus` type + new fields on `Attempt` interface | After `AttemptStatus` type (~L362) and within `Attempt` interface (~L370) |
| 3 | `src/features/exam-engine/lib/actions.ts` | Set `paper_ingest_run_id` when creating attempt (Phase 2/3) | In `startExam` or equivalent attempt creation logic |

---

## D) Risk List

| # | Risk | Severity | Mitigation |
|---|---|---|---|
| 1 | **Paper snapshot mismatch** — Questions edited after attempt taken. Export uses current DB state, not snapshot. | **Medium** | Store `paper_ingest_run_id` on `attempts` at creation time (migration 031). Add `_warning` field in export metadata noting potential drift for older attempts without snapshot. |
| 2 | **RLS bypass risk** — Export needs `correct_answer`, `solution_text` which are stripped by `questions_exam` view. | **High** | Use `getServiceRoleClient()` with explicit paper_id filter. **Never expose service-role to client.** Use existing `fetch_attempt_solutions` RPC as alternative (already scoped). |
| 3 | **Authorization — viewing others' attempts** | **High** | API route MUST verify `attempt.user_id === session.user.id` (or user is admin). Copy pattern from `fetchExamResults` in `actions.ts`. |
| 4 | **Size / token risk** — RC passages + 66 questions + solutions + responses ≈ 50–150KB JSON. | **Low-Medium** | Add `compact` query param that omits `solution_text` and passage bodies. Include `token_estimate` in export metadata. |
| 5 | **Telemetry columns may not exist** | **Low** | Migration 030 adds `telemetry_log` on `attempts` and `answer_history` on `responses`. If not applied, use `COALESCE` or omit gracefully (nullable fields in type). |
| 6 | **Rate limiting / abuse** | **Low** | No rate limiting on API routes currently. Consider simple throttle (5 exports/user/hour) in Phase 2+. |

---

## E) Acceptance Checklist

### Phase 0 (this doc) ✅
- [x] Integration map written with exact file paths and function names
- [x] Reuse patterns identified (auth guard, export headers, Supabase client)
- [x] CTA insertion point identified (result page action buttons)
- [x] Risk list with mitigations documented

### Phase 1 (migration + types)
- [ ] Migration `031_add_ai_analysis_columns.sql` is idempotent (`IF NOT EXISTS`, `DO $$` blocks)
- [ ] Enum `ai_analysis_status_type` created: `none`, `requested`, `exported`, `processed`, `failed`
- [ ] Columns added to `attempts`: `ai_analysis_status`, `ai_analysis_requested_at`, `ai_analysis_exported_at`, `ai_analysis_error`, `paper_ingest_run_id`
- [ ] Existing rows backfilled with `ai_analysis_status = 'none'`
- [ ] Composite index added: `(ai_analysis_status, submitted_at DESC)`
- [ ] `paper_ingest_run_id` FK added to `paper_ingest_runs(id)` (nullable, no cascade)
- [ ] TypeScript types updated in `src/types/exam.ts`
- [ ] `pnpm exec tsc --noEmit` passes
- [ ] No RLS policies widened or changed
- [ ] Existing migrations unaffected (migration numbering consistent)

### Phase 2+ (API route + service + CTA)
- [ ] GET `/api/result/[attemptId]/export-ai-context` returns 401 for unauthenticated
- [ ] Returns 403 if `attempt.user_id !== session.user.id` and user is not admin
- [ ] Admin users can export any attempt
- [ ] Response has `Content-Disposition: attachment` header
- [ ] Response has `Cache-Control: no-store`
- [ ] Export includes: paper metadata, all questions with correct answers/solutions, responses with timing/visit data, attempt summary, passage/context bodies, schema version + export timestamp
- [ ] Result page shows "Export AI Context" CTA
- [ ] No regression on existing result page, paper export, or exam flow
- [ ] `pnpm lint` passes
- [ ] `node scripts/check-bundle.mjs` passes

---

## Appendix: Composite Context JSON Schema (Draft)

```jsonc
{
  "_meta": {
    "schema_version": "1.0.0",
    "exported_at": "2026-02-10T12:00:00Z",
    "export_format": "composite_context",
    "paper_snapshot_warning": "Paper may have been edited after attempt. paper_ingest_run_id captures version at attempt time.",
    "token_estimate": 12500
  },
  "attempt": {
    "id": "uuid",
    "user_id": "uuid",
    "paper_id": "uuid",
    "paper_ingest_run_id": "uuid | null",
    "status": "submitted",
    "started_at": "iso8601",
    "completed_at": "iso8601",
    "time_taken_seconds": 7200,
    "total_score": 42,
    "max_possible_score": 198,
    "correct_count": 20,
    "incorrect_count": 10,
    "unanswered_count": 36,
    "accuracy": 0.667,
    "attempt_rate": 0.455,
    "percentile": 85.5,
    "section_scores": { "VARC": {}, "DILR": {}, "QA": {} },
    "telemetry_log": [],
    "ai_analysis_status": "exported"
  },
  "paper": {
    "id": "uuid",
    "title": "CAT 2025 Slot 1",
    "slug": "cat-2025-slot-1",
    "year": 2025,
    "sections": [],
    "total_questions": 66,
    "total_marks": 198,
    "duration_minutes": 120
  },
  "questions": [
    {
      "id": "uuid",
      "section": "VARC",
      "question_number": 1,
      "question_type": "MCQ",
      "question_text": "...",
      "options": [],
      "correct_answer": "B",
      "solution_text": "...",
      "positive_marks": 3,
      "negative_marks": 1,
      "topic": "Reading Comprehension",
      "difficulty_level": "medium",
      "ideal_time_seconds": 180,
      "context_id": "uuid | null"
    }
  ],
  "responses": [
    {
      "question_id": "uuid",
      "answer": "A",
      "is_correct": false,
      "marks_obtained": -1,
      "status": "answered",
      "time_spent_seconds": 120,
      "visit_count": 3,
      "is_marked_for_review": false,
      "answer_history": []
    }
  ],
  "contexts": [
    {
      "id": "uuid",
      "title": "Passage 1",
      "content_text": "...",
      "content_type": "passage",
      "section": "VARC"
    }
  ],
  "user_summary": {
    "total_attempts": 5,
    "average_score": 55.2,
    "strongest_section": "QA",
    "weakest_section": "VARC"
  }
}
```
````

## File: docs/archive/SCHEMA_FIREBASE.md
````markdown
# Firebase Firestore Schema (Fallback Option)

## Overview
This document outlines the Firestore database structure as a fallback to Supabase. Firestore uses a document-based NoSQL structure with collections and subcollections.

## Collections Structure

### /users/{userId}
```json
{
  "email": "user@example.com",
  "name": "User Name",
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-01T00:00:00Z"
}
```

### /papers/{paperId}
```json
{
  "title": "CAT 2024 Paper",
  "year": 2024,
  "totalQuestions": 66,
  "durationMinutes": 180,
  "sections": [
    {"name": "VAR", "questions": 24, "timeMinutes": 40},
    {"name": "DILR", "questions": 20, "timeMinutes": 40},
    {"name": "QA", "questions": 22, "timeMinutes": 40}
  ],
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-01T00:00:00Z"
}
```

### /papers/{paperId}/questions/{questionId}
```json
{
  "section": "VAR",
  "questionNumber": 1,
  "questionText": "What is the probability...",
  "questionType": "MCQ", // or "TITA"
  "options": ["Option A", "Option B", "Option C", "Option D"], // null for TITA
  "correctAnswer": "A", // or "42" for TITA
  "solutionText": "The correct answer is A because...",
  "solutionImageUrl": "https://storage.googleapis.com/bucket/solution1.png",
  "difficulty": "medium",
  "topic": "Probability",
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-01T00:00:00Z"
}
```

### /users/{userId}/attempts/{attemptId}
```json
{
  "paperId": "paper123",
  "startedAt": "2025-01-01T10:00:00Z",
  "completedAt": null,
  "status": "in_progress", // "in_progress", "completed", "abandoned"
  "currentSection": "VAR",
  "timeRemaining": {
    "VAR": 2400, // seconds
    "DILR": 2400,
    "QA": 2400
  },
  "totalScore": null,
  "sectionScores": null,
  "createdAt": "2025-01-01T10:00:00Z",
  "updatedAt": "2025-01-01T10:00:00Z"
}
```

### /users/{userId}/attempts/{attemptId}/responses/{questionId}
```json
{
  "questionId": "question123",
  "answer": "A",
  "isMarkedForReview": false,
  "timeSpentSeconds": 45,
  "createdAt": "2025-01-01T10:00:45Z",
  "updatedAt": "2025-01-01T10:00:45Z"
}
```

## Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Users can read papers (public)
    match /papers/{paperId} {
      allow read: if request.auth != null;
      allow write: if false; // Admin only
    }

    // Users can read questions (public)
    match /papers/{paperId}/questions/{questionId} {
      allow read: if request.auth != null;
      allow write: if false; // Admin only
    }

    // Users can manage their own attempts
    match /users/{userId}/attempts/{attemptId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Users can manage their own responses
    match /users/{userId}/attempts/{attemptId}/responses/{questionId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

## Indexes Required

### Automatic Indexes
Firestore automatically creates indexes for simple queries.

### Composite Indexes Needed
- `papers/{paperId}/questions` on `section` (for section filtering)
- `users/{userId}/attempts` on `status` (for filtering active attempts)
- `users/{userId}/attempts` on `startedAt` (for attempt history)

## Migration Notes

### From Supabase to Firestore
- UUIDs become Firestore document IDs
- Foreign keys become reference paths
- JSON fields become nested objects
- RLS policies become Firestore security rules

### Data Export/Import
- Use Firestore Admin SDK for bulk operations
- Export from Supabase as JSON, transform, import to Firestore
- Handle image URLs (Supabase Storage → Firebase Storage)

## Cost Considerations

### Free Tier Limits
- 50k reads/day
- 20k writes/day
- 1GB storage
- 10GB/month egress

### Usage Estimation
- 200 users × 6 saves/min × 60 min = 72k writes/hour (exceeds free limit)
- Need to reduce autosave frequency (every 15-30 seconds instead of 10)

## Advantages over Supabase
- Better offline support
- Real-time listeners built-in
- Simpler client-side integration

## Disadvantages vs Supabase
- Fixed daily quotas (vs Supabase's flexible throughput limits)
- No built-in SQL queries
- More complex data modeling
````

## File: docs/AUDIT_QUERY_PATHS.md
````markdown
# Query Path Audit — Supabase Read Inventory

> Generated: 2026-01-24  
> Purpose: Complete inventory of all Supabase queries touching questions/answers/solutions  
> Classification: exam-runtime | results-only | admin-only | scoring-only

---

## Summary

| Classification | Safe? | Notes |
|----------------|-------|-------|
| exam-runtime | ✅ | Must only read `questions_exam` or `question_sets_with_questions` |
| results-only | ✅ | Must use `fetch_attempt_solutions` RPC (gated) |
| admin-only | ✅ | Uses service-role client (`getAdminClient()` / `getServiceRoleClient()`) |
| scoring-only | ✅ | Uses service-role client server-side only |

---

## Detailed Callsite Inventory

### 1. Exam Runtime (MUST be safe views only)

| File | Function/Component | Server/Client | Table/View/RPC | Columns | Classification | Boundary risk | Status |
|------|-------------------|---------------|----------------|---------|----------------|---------------|--------|
| `src/features/exam-engine/lib/actions.ts` | `fetchPaperForExam()` | Server (`'use server'`) | `questions_exam` | `*` (safe view) | exam-runtime | None | ✅ SAFE |
| `src/features/exam-engine/lib/actions.ts` | `fetchPaperForExam()` | Server (`'use server'`) | `question_sets` | `id, display_order` | exam-runtime | None | ✅ SAFE (non-sensitive cols) |
| `src/features/exam-engine/lib/actions.ts` | `saveResponse()` | Server (`'use server'`) | `questions_exam` | `id, paper_id` | exam-runtime | None | ✅ SAFE |
| `src/app/exam/[attemptId]/page.tsx` | Server Component | Server | `questions_exam` | `*` (safe view) | exam-runtime | None | ✅ SAFE |
| `src/app/exam/[attemptId]/ExamClient.tsx` | `ExamClient` | Client | imports `@/features/exam-engine/lib/actions` | N/A | exam-runtime | client imports server-actions module that also defines service-role helper | ⚠️ REVIEW (client ↔ server boundary) |

### 2. Results (MUST use gated RPC only)

| File | Function/Component | Server/Client | Table/View/RPC | Columns | Classification | Boundary risk | Status |
|------|-------------------|---------------|----------------|---------|----------------|---------------|--------|
| `src/features/exam-engine/lib/actions.ts` | `fetchExamResults()` | Server (`'use server'`) | `questions_exam` + `fetch_attempt_solutions` RPC | safe view + RPC solutions | results-only | None | ✅ SAFE |
| `src/app/result/[attemptId]/page.tsx` | Server Component | Server | calls `fetchExamResults()` | via action | results-only | None | ✅ SAFE |

### 3. Scoring (service-role only)

| File | Function/Component | Server/Client | Table/View/RPC | Columns | Classification | Boundary risk | Status |
|------|-------------------|---------------|----------------|---------|----------------|---------------|--------|
| `src/features/exam-engine/lib/actions.ts` | `submitExam()` | Server (`'use server'`) | `questions` via service-role client | `*` (includes `correct_answer`) | scoring-only | None | ✅ SAFE (service-role) |

### 4. Admin (service-role only)

| File | Function/Component | Server/Client | Table/View/RPC | Columns | Classification | Boundary risk | Status |
|------|-------------------|---------------|----------------|---------|----------------|---------------|--------|
| `src/app/admin/papers/[paperId]/edit/page.tsx` | Server Component | Server | `questions` via `getAdminClient()` | `*` (includes `correct_answer`) | admin-only | None | ✅ SAFE (service-role) |
| `src/app/admin/papers/[paperId]/edit/actions.ts` | `saveQuestion()`, `deleteQuestion()`, etc. | Server (`'use server'`) | `questions` via `getAdminClient()` | `*` | admin-only | None | ✅ SAFE (service-role) |
| `src/app/admin/questions/new/page.tsx` | Server Component | Server | `questions` (insert only) | insert columns | admin-only | None | ✅ SAFE |
| `src/app/admin/questions/page.tsx` | Server Component | Server | `questions` via service-role (SUPABASE_SERVICE_ROLE_KEY) | `*` (includes `correct_answer`) | admin-only | None | ✅ SAFE (service-role) |
| `src/app/admin/page.tsx` | Server Component | Server | `questions` | `id` (count only) | admin-only | None | ✅ SAFE (count only) |
| `src/app/api/admin/question-sets/route.ts` | API Route | Server | `questions`, `question_sets`, `question_sets_with_questions` | various | admin-only | None | ⚠️ REVIEW (uses user-session for some) |

### 5. Question Sets Views

| File | Function/Component | Server/Client | Table/View/RPC | Columns | Classification | Boundary risk | Status |
|------|-------------------|---------------|----------------|---------|----------------|---------------|--------|
| `src/app/api/admin/question-sets/route.ts` | GET | Server | `question_sets_with_questions` | `*` | admin-only | None | ✅ SAFE (view excludes solutions) |

### 6. Mutation Surfaces (API Routes)

| File | Function/Component | Server/Client | Table/View/RPC | Columns | Classification | Boundary risk | Status |
|------|-------------------|---------------|----------------|---------|----------------|---------------|--------|
| `src/app/api/save/route.ts` | POST | Server | `responses` + `validate_session_token` RPC | `attempt_id, question_id, answer` | mutation-surface | None | ✅ SAFE (uses RPC; reads attempts.session_token) |

---

## Sensitive Column References

The following columns are sensitive and must NEVER appear in exam-runtime reads:

- `correct_answer`
- `solution_text`
- `solution_image_url`
- `video_solution_url`

### Files referencing sensitive columns (expected admin/results/scoring contexts):

| File | Context | Status |
|------|---------|--------|
| `src/features/exam-engine/lib/actions.ts` | `submitExam()` scoring (service-role) | ✅ OK |
| `src/features/exam-engine/lib/actions.ts` | `fetchExamResults()` via RPC | ✅ OK |
| `src/app/result/[attemptId]/page.tsx` | Results display | ✅ OK |
| `src/features/admin/ui/EditableExamLayout.tsx` | Admin editor | ✅ OK |
| `src/features/admin/ui/EditableQuestion.tsx` | Admin editor | ✅ OK |
| `src/app/admin/questions/new/page.tsx` | Admin create | ✅ OK |
| `src/app/admin/question-sets/new/NewQuestionSetClient.tsx` | Admin create | ✅ OK |
| `src/features/exam-engine/ui/QuestionAnalysis.tsx` | Results analysis | ✅ OK |
| `src/types/exam.ts` | Type definitions | ✅ OK |

---

## `.select('*')` Usage Audit

| File | Table/View | Classification | Status |
|------|------------|----------------|--------|
| `src/features/exam-engine/lib/actions.ts:81` | `papers` | exam-runtime | ✅ OK (no sensitive cols) |
| `src/features/exam-engine/lib/actions.ts:94` | `questions_exam` | exam-runtime | ✅ OK (safe view) |
| `src/features/exam-engine/lib/actions.ts:142` | `attempts` | exam-runtime | ✅ OK (no sensitive cols) |
| `src/features/exam-engine/lib/actions.ts:567` | `questions` | scoring-only | ✅ OK (service-role) |
| `src/features/exam-engine/lib/actions.ts:702` | `attempts` | results-only | ✅ OK (no sensitive cols) |
| `src/features/exam-engine/lib/actions.ts:722` | `questions_exam` | results-only | ✅ OK (safe view) |
| `src/app/exam/[attemptId]/page.tsx:103` | `questions_exam` | exam-runtime | ✅ OK (safe view) |
| `src/app/api/admin/question-sets/route.ts:142` | `question_sets_with_questions` | admin-only | ✅ OK (safe view) |
| `src/app/admin/papers/page.tsx:15` | `papers` | admin-only | ✅ OK (no sensitive cols) |

---

## Verification Checklist

- [x] All exam-runtime reads use `questions_exam` (safe view)
- [x] All results reads use `fetch_attempt_solutions` RPC
- [x] All scoring reads use service-role client
- [x] All admin reads use service-role client OR safe views
- [x] No client components import service-role helpers
- [x] No `.from('questions')` in exam-runtime paths (except via service-role)

---

## Remediation Notes

1. **`src/app/admin/questions/page.tsx`**: Uses user-session client to read questions. Since column-level revokes are in place, this will fail for `correct_answer`/`solution_*`. Either:
   - Change to use service-role via server action, OR
   - Explicitly select only safe columns

2. **`src/app/api/admin/question-sets/route.ts`**: Some operations use user-session. Admin API routes should use service-role for any writes/reads needing privileged columns.

---

*End of Audit*
````

## File: docs/BUG_REPRO_CHECKLIST.md
````markdown
# Bug Reproduction Checklist

> Phase 0 Safety Rails: Use this checklist to verify fixes before and after each change.
> Last updated: 2026-02-07

---

## Issue 1: Mock Session Resume vs Restart
Status: Fixed (2026-02-07)

Description (pre-fix)
When a user started a mock while another attempt was in progress, the session restarted from Q1 instead of resuming.

Current behavior
- /mocks shows "Continue Mock" when an in-progress attempt with remaining time exists.
- /mock/[paperId] shows "Start New Attempt" which abandons any in-progress attempt for that paper.

Verification steps
1. Start a mock test and answer a few questions.
2. Close the tab without submitting.
3. Go to /mocks and click "Continue Mock".
4. Expected: resume at the last saved section/question.

Optional validation
- From /mock/[paperId], click "Start New Attempt".
- Expected: previous in-progress attempt is marked abandoned and a new attempt is created.

Verification checklist
- DevTools -> Application -> Local Storage
- Key `cat-exam-state-{attemptId}` exists (not `cat-exam-state-temp`)
- `currentSectionIndex` and `currentQuestionIndex` are preserved
- With `NEXT_PUBLIC_EXAM_DEBUG=true`, look for `[EXAM_DEBUG] Resume detection`

---

## Issue 2: TITA Double-Fire / Duplicate Script Execution
Status: Fixed (Phase 3.4)

Description (pre-fix)
TITA keypad input fired twice due to a useEffect sync loop.

Verification steps
1. Open any TITA question.
2. DevTools -> Console.
3. Press a keypad digit.

Expected
- One input change and one log line per keypress.

Verification checklist
- `[EXAM_DEBUG] TITA input` appears once per keypress
- No duplicate renders or state updates in React DevTools

---

## Issue 3: Mark for Review & Next Behavior
Status: Fixed (Phase 2)

Description (pre-fix)
"Mark for Review & Next" could incorrectly mark unanswered questions as answered_marked.

Current status categories
1. Answered (green, hexagon-up)
2. Not Answered/Visited (red, hexagon-down)
3. Not Visited (gray, square)
4. Marked for Review (purple, circle)
5. Attempted & Marked (answered_marked)

Test matrix
| Starting State | Action | Expected Status | Expected Answer |
|----------------|--------|-----------------|-----------------|
| not_visited | Mark & Next | marked | null |
| visited (no answer) | Mark & Next | marked | null |
| answered | Mark & Next | answered_marked | preserved |
| marked | Unmark | visited | null |
| answered_marked | Unmark | answered | preserved |

Verification checklist
- Palette color matches expected status
- `[EXAM_DEBUG] Mark for Review` shows correct newStatus
- `[EXAM_DEBUG] Response status change` aligns with transitions

---

## Issue 4: Quant Section Submission Failure
Status: Mitigated (2026-02-07)

Description (pre-fix)
Submissions in QA sometimes returned "Failed to submit exam" due to races or stale attempt IDs.

Current behavior
- `/api/submit` is idempotent; repeated submits return success with `already_submitted`.
- Session conflicts return `SESSION_CONFLICT` and can be force-resumed.
- `ATTEMPT_NOT_FOUND` triggers localStorage cleanup and redirects to `/dashboard`.

Potential causes (if still reproducible)
- Multi-device/tab session conflict
- Rate limiting on submit
- Attempt deleted server-side

Verification steps
1. Complete all sections (VARC, DILR, QA).
2. Submit from the last QA question.
3. Check the `/api/submit` response in Network tab.

Verification checklist
- `/api/submit` returns 200 on success, or 409 with `SESSION_CONFLICT` when applicable
- If `ATTEMPT_NOT_FOUND`, exam state keys are cleared and user is redirected to `/dashboard`
- Server logs show `SUBMIT_*` diagnostics when debugging

---

## Debug Mode Instructions

### Enabling Debug Logging
Set in `.env.local`:
```bash
NEXT_PUBLIC_EXAM_DEBUG=true
```

### Debug Log Outputs
With debug mode enabled, check console for:
- `[EXAM_DEBUG] Store initialized` - attemptId, storeName, sessionToken, section, question
- `[EXAM_DEBUG] Resume detection` - attemptId, section, question, preservedState
- `[EXAM_DEBUG] Response status change` - questionId, status, hasAnswer, isMarked
- `[EXAM_DEBUG] Mark for Review` - questionId, newStatus, isMarking
- `[EXAM_DEBUG] TITA input` - key, oldValue, newValue
- `[EXAM_DEBUG] Submit attempt` - attemptId, submissionId, responses
- `[EXAM_DEBUG] Submit result` - success, error, attemptId

### LocalStorage Keys to Monitor
- `cat-exam-state-{attemptId}` - per-attempt state
- `cat-exam-state-temp` - should not exist for real attempts; cleaned up on startup if stale

---

## Quick Verification Commands

```bash
# Check localStorage in browser console
localStorage.getItem('cat-exam-state-temp')  // Should be null for real attempts
Object.keys(localStorage).filter(k => k.startsWith('cat-exam-state'))

# Force clear all exam state (for testing)
Object.keys(localStorage).filter(k => k.startsWith('cat-exam-state')).forEach(k => localStorage.removeItem(k))
```
````

## File: docs/bug-repro.md
````markdown
# Bug Repro Steps (Phase 0)

Last reviewed: 2026-02-07
Status: Unverified (re-run after admin editor changes)

Keep these steps up to date so regressions are easy to spot.

## Editor refresh bug

Scenario: "Edit Q -> refresh -> jumps to VARC Q1".

Steps:
1. Open the admin editor for any paper.
2. Navigate to a non-VARC section (e.g., DILR) and open a question that is not Q1.
3. Make a small edit (e.g., add a space and remove it).
4. Refresh the page.

Expected:
- Editor stays on the same section and question.

Observed bug:
- Editor jumps back to VARC, Q1.

## Freeze bug

Scenario: "Do X -> UI freezes (Editor + Preview)".

Steps:
1. Open the admin editor for any paper.
2. Rapidly change sections and questions (palette clicks + section tab changes).
3. Keep typing in the editor for 10-20 seconds.

Expected:
- UI remains responsive; no long stalls.

Observed bug:
- Editor and preview freeze or become unresponsive.

## Duplication bug

Scenario: "Edit Q text (delete + rewrite) -> Preview/Mock shows old + new".

Steps:
1. Open the admin editor for any paper.
2. Select a question with text in the stem.
3. Delete the entire question text and retype a new sentence.
4. Open Admin Preview or Mock view for the same paper.

Expected:
- Preview/Mock shows only the new text.

Observed bug:
- Preview/Mock shows both the old and new text.
````

## File: docs/BUGFIX_9FEB_CHECKLIST.md
````markdown
# BUGFIX 9 Feb Checklist

Use this checklist to manually verify the Phase 0/1/2 fixes.

## 1) Request Access loop (/coming-soon)
Steps to verify:
1. Sign in with a waitlisted account (status pending).
2. Visit `/coming-soon`.
3. Click "Request access".
4. Expected: stay on `/coming-soon`, see "Access request received"; no redirect to `/auth/sign-in`.

## 2) Exam header overlap + remove Sync button
Steps to verify:
1. Start any exam attempt.
2. Confirm the Back button does not overlap the section tabs/label (e.g., VARC/LRDI/Quant).
3. Confirm there is no "Sync" button visible anywhere in the exam header.

## 3) MCQ options radio layout
Steps to verify:
1. Open a MCQ question.
2. Confirm all options render with aligned radio controls and consistent spacing.
3. Resize the window (desktop ? tablet width) and confirm layout remains intact.

## 4) Hide topic labels during exam (keep in analysis)
Steps to verify:
1. During an active exam, confirm topic labels are not shown.
2. After submitting, open Result/Analysis view and confirm topic labels are visible there.
````

## File: docs/CONTENT-SCHEMA.md
````markdown
# CONTENT-SCHEMA

## Schema v3.0 (Sets-First)

Schema v3.0 mirrors the actual DB architecture: `question_sets` are the parent containers, and `questions` are children that reference sets via `set_ref`.

### Root Structure

```json
{
  "schema_version": "v3.0",
  "paper": { ... },
  "question_sets": [ ... ],
  "questions": [ ... ]
}
```

### Key Concepts

1. **Sets are inserted FIRST** — the importer creates all `question_sets` before any questions
2. **Questions link via `set_ref`** — each question's `set_ref` must match a `client_set_id` in `question_sets[]`
3. **Deterministic linking** — no text matching or UUID guessing; explicit client IDs

### `question_sets[]` Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `client_set_id` | string | Stable ID (e.g., `VARC_RC_1`, `DILR_SET_3`). Pattern: `^[A-Z0-9_]+$` |
| `section` | enum | `VARC`, `DILR`, or `QA` |
| `set_type` | enum | `VARC`, `DILR`, `CASELET`, or `ATOMIC` |
| `display_order` | integer | Order within section (for deterministic export) |
| `context_body` | string | **Required** for `VARC`/`DILR`/`CASELET`. The passage/data content. |

Optional: `context_title`, `context_image_url`, `context_type`, `content_layout`, `metadata`

### `questions[]` Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `client_question_id` | string | Stable ID (e.g., `Q1`, `VARC_RC1_Q3`). Unique within paper. |
| `set_ref` | string | Must match a `client_set_id` in `question_sets[]` |
| `sequence_order` | integer | Order within the set (1-based) |
| `question_number` | integer | Global question number in paper |
| `question_text` | string | The question content |
| `question_type` | enum | `MCQ` or `TITA` |

MCQ questions must also include `options[]` array.

### Example (minimal)

```json
{
  "schema_version": "v3.0",
  "paper": {
    "title": "CAT 2024 Mock",
    "slug": "cat-2024-mock"
  },
  "question_sets": [
    {
      "client_set_id": "VARC_RC_1",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 1,
      "context_body": "Reading passage text here..."
    },
    {
      "client_set_id": "QA_ATOMIC_1",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 1
    }
  ],
  "questions": [
    {
      "client_question_id": "Q1",
      "set_ref": "VARC_RC_1",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 1,
      "question_text": "What is the main idea?",
      "question_type": "MCQ",
      "options": [
        { "id": "A", "text": "Option A" },
        { "id": "B", "text": "Option B" }
      ],
      "correct_answer": "A"
    },
    {
      "client_question_id": "Q2",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 2,
      "question_text": "Find the value of x if $x^2 = 16$",
      "question_type": "TITA",
      "correct_answer": "4"
    }
  ]
}
```

### Full Schema Reference

See: `schemas/paper_schema_v3.json`

See: `data_sanitized/paper_schema_v3.template.json` (full example)

### How to Import v3

**CLI Import (Recommended for bulk imports):**
```bash
# Dry run to validate without writing
node scripts/import-paper-v3.mjs path/to/paper.json --dry-run

# Import as draft
node scripts/import-paper-v3.mjs path/to/paper.json

# Import and publish immediately
node scripts/import-paper-v3.mjs path/to/paper.json --publish

# Skip if identical JSON already imported
node scripts/import-paper-v3.mjs path/to/paper.json --skip-if-duplicate

# With notes
node scripts/import-paper-v3.mjs path/to/paper.json --notes "Initial import"

# Upsert mode (requires migration 008 semantic keys)
node scripts/import-paper-v3.mjs path/to/paper.json --upsert
```

**Admin UI Import:**
1. Navigate to `/admin/papers`
2. Click the green "Import JSON" button
3. Select options (publish, skip duplicates, notes)
4. Upload your Schema v3.0 JSON file
5. Review the import result

**API Import:**
```bash
curl -X POST /api/admin/papers/import \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <admin-token>" \
  -d '{
    "data": { /* Schema v3.0 payload */ },
    "publish": false,
    "skipIfDuplicate": true,
    "notes": "API import"
  }'
```

### Semantic Keys (Migration 008)

For idempotent imports (upsert mode), apply migration 008:

| Table | Column | Description |
|-------|--------|-------------|
| `papers` | `paper_key` | Global unique key (defaults to slug) |
| `question_sets` | `client_set_id` | Unique within paper |
| `questions` | `client_question_id` | Unique within paper |

With semantic keys, re-importing the same paper updates existing records instead of duplicating.

---

## Common Fields

### Formatting
- Math content uses KaTeX inline `$...$` and block `$$...$$` notation.
- Rich text stays Markdown-compatible for bold, italics, and ordered or unordered lists.

### Assets & Delivery
- Store diagrams and images in Supabase Storage with signed URLs; record paths within `assets[]`.
- Attach fallback copies under `docs/assets/*` if external sources become private.

### Taxonomy Types (Optional)

Common values for `taxonomy_type`:

**VARC:**
- `rc_main_idea`, `rc_inference`, `rc_tone`, `rc_vocab_in_context`
- `para_jumble`, `para_summary`, `odd_sentence`

**DILR:**
- `di_table_analysis`, `di_chart`, `di_caselets`
- `lr_arrangement`, `lr_puzzles`, `lr_syllogism`

**QA:**
- `arithmetic_percentages`, `arithmetic_profit_loss`, `arithmetic_time_work`
- `algebra_equations`, `algebra_inequalities`
- `geometry_triangles`, `geometry_circles`
- `number_theory_divisibility`, `modern_math_permutations`
````

## File: docs/DECISIONS.md
````markdown
# DECISIONS.md - Architecture & SSOT Freeze (v0.1)

## Changelog

### 2026-02-07: Controlled Soft Launch Access Control (Phase 0-7)
- **Added**: Access control foundations (signup_mode, user_access, access_requests) with RLS + signup trigger.
  - Evidence: `docs/migrations/023_access_control_foundations.sql`
- **Added**: RLS gating for attempts/responses based on active access.
  - Evidence: `docs/migrations/024_access_control_rls.sql`
- **Added**: Middleware + server-side access checks and waitlist flow.
  - Evidence: `middleware.ts`, `src/lib/access-control.ts`, `src/app/coming-soon/page.tsx`
- **Added**: Admin controls for signup mode and approvals.
  - Evidence: `src/app/admin/access-control/page.tsx`, `src/app/admin/access-control/actions.ts`, `src/app/admin/page.tsx`
- **Added**: Basic rate limits + telemetry for auth callback, access request, and mock start.
  - Evidence: `src/lib/rate-limit.ts`, `src/lib/telemetry.ts`, `src/app/auth/callback/route.ts`, `src/app/coming-soon/page.tsx`, `src/app/mock/[paperId]/page.tsx`

### 2026-01-24: Phase A/B Security Verification (Runtime Reads + RBAC Hook)
- **Verified**: Runtime read paths only use safe view `questions_exam` for exam fetches and result rendering.
	- Evidence: `fetchPaperForExam()` and `fetchExamResults()` in [src/features/exam-engine/lib/actions.ts](src/features/exam-engine/lib/actions.ts)
	- Evidence: Exam page uses `questions_exam` in [src/app/exam/[attemptId]/page.tsx](src/app/exam/[attemptId]/page.tsx)
- **Verified**: Results are gated via `fetch_attempt_solutions` RPC and only consumed through `fetchExamResults()`.
	- Evidence: RPC definition in [docs/migrations/004_fetch_attempt_solutions.sql](docs/migrations/004_fetch_attempt_solutions.sql)
	- Evidence: Results page in [src/app/result/[attemptId]/page.tsx](src/app/result/[attemptId]/page.tsx)
- **Verified**: RBAC hook enablement checklist documented and current.
	- Evidence: RBAC hook verification steps in [docs/BLUEPRINT.md](docs/BLUEPRINT.md)
	- Evidence: Auth hook function + grants in [docs/MIGRATION_M6_RBAC.sql](docs/MIGRATION_M6_RBAC.sql)

### 2026-01-22: Mirror Principle Admin Editor (M6+)
- **Added**: `EditableExamLayout.tsx` - Admin editor that mirrors exam UI exactly
- **Added**: `ImageUploadZone` component with Supabase Storage integration
- **Added**: Back button navigation throughout admin panel
- **Added**: Toast notifications for save success/error feedback
- **Updated**: `MIGRATION_M6_RBAC.sql` - Added `question-images` Storage bucket with RLS policies
- **Changed**: "Pause" button -> "Exit Mock" with red styling in exam interface
- **UI**: Editor now matches student exam view 1:1 (Mirror Principle)
- **Storage**: Images upload to `question-images` bucket (5MB limit, admin-only upload)

### 2026-01-21: M6+ RBAC Implementation
- **Added**: `MIGRATION_M6_RBAC.sql` - Complete RBAC migration script
- **Added**: `user_roles` table with `app_role` ENUM
- **Added**: `custom_access_token_hook` for JWT claims injection
- **Added**: RLS policies for admin-only write access
- **Updated**: Middleware to check JWT claims for admin routes
- **Updated**: Admin layout with RBAC enforcement + dev bypass

---

## 1. Tech Stack Choice
**Frontend:** Next.js 16 (App Router)  
**Backend/DB:** Supabase (Auth + Database + Storage)  
**UI Styling:** TailwindCSS  
**TypeScript:** Yes  
**Deployment:** Netlify (Next.js on Netlify + serverless functions) + Supabase (DB/Auth/Storage)  

**Rationale:**  
Next.js App Router allows clean SSR + static hybrid. Supabase offers integrated Auth and SQL DB for free tier. Both integrate smoothly with GitHub for CI/CD.

**Netlify note:** Use the Netlify Next.js runtime/plugin with `netlify.toml`. Env vars live in Netlify -> Site settings -> Environment.
---

## 2. Trade-offs
| Choice | Advantage | Limitation |
|--------|------------|-------------|
| Supabase | Quick setup, Auth, SQL | Slight vendor lock-in |
| Next.js | SEO + Performance | Learning curve for routing |

---

## 3. Next Steps
- Freeze data model & routes in `BLUEPRINT.md`
- Define performance budget & sign-off as SSOT
````

## File: docs/landing-page.md
````markdown
# Landing v2 integration note (Phase 0)

## Current landing entry + structure
- Route entry: `src/app/page.tsx`
  - Wraps `src/components/landing/LandingPageClient.tsx` (hero, mentor, roadmap, CAT hub, footer).
  - Dynamic images via `useLandingAssets` with skeleton placeholders and safe fallbacks.
- App shell: `src/app/layout.tsx`
  - Global styles via Tailwind (`src/app/globals.css`).
  - KaTeX CSS is globally included.
- Styling system: Tailwind utility classes (no component library). `src/app/page.module.css` exists but is not used by the landing route.

## Auth modal location (current)
- Auth modal lives in `src/components/landing/LandingPageClient.tsx` (Google OAuth only).
- Sign-in is a dedicated page: `src/app/auth/sign-in/page.tsx`.
- Test login page: `src/app/auth/test-login/page.tsx`.

## Admin content ingestion (current)
- Admin RBAC + routing: `src/app/admin/layout.tsx` (JWT claims + RPC fallback, with DEV skip).
- Paper ingestion UI: `src/app/admin/papers/ImportPaperButton.tsx`.
- Paper ingestion API: `src/app/api/admin/papers/import/route.ts`.
- Admin editor UIs (context/questions) with image upload:
  - `src/features/admin/ui/EditableExamLayout.tsx`
  - `src/features/admin/ui/EditableQuestion.tsx`
- Image upload helper: `src/lib/cloudinary.ts` (Cloudinary unsigned upload).

## What we can safely extend (no refactor)
- Add landing assets DB layer + admin UI in **new** routes (e.g., `src/app/admin/landing-assets/*`) using existing admin RBAC in `src/app/admin/layout.tsx`.
- Reuse the image upload pattern from `src/lib/cloudinary.ts` or add a Supabase Storage variant in parallel (no changes to existing exam editor flows).
- Update `src/app/page.tsx` to consume a new `getLandingAssets()` data source (server-side or client hydration) while keeping current sections intact.
- Reuse the existing Auth modal and OAuth redirect flow from `src/app/auth/sign-in/page.tsx`.

## What we should NOT refactor right now
- Do not restructure the Next.js route layout (keep landing at `src/app/page.tsx`).
- Do not change existing admin RBAC logic (keep `src/app/admin/layout.tsx`).
- Do not rewrite the exam admin upload/ingest pipeline.

## Minimal extension plan (Phase 1 readiness)
- Add a new `landing_assets` table + storage prefix and a typed client util.
- Add admin UI for replacing landing assets using the existing admin surface + auth.
- Wire landing sections in `src/app/page.tsx` to the new assets map.

Acceptance checklist
- Landing v2 work can proceed by **adding** components/utilities without touching existing exam/admin flow.
- File paths above are the safe entry points for the PRD requirements.

## Phase 2 update log
- Added admin panel: `src/app/admin/landing-page/page.tsx`
- Client UI for drag/drop asset replacement: `src/app/admin/landing-page/LandingAssetsClient.tsx`
- Navigation entry: `src/app/admin/layout.tsx` (Landing Page link)

## Phase 3/4 update log
- Landing UI refactor: src/components/landing/LandingPageClient.tsx (hero, mentor, roadmap, feature showcase, CAT hub, footer).
- Landing route now wraps the client component: src/app/page.tsx.
- Dynamic images wired via useLandingAssets with skeleton placeholders and safe fallbacks.
- Mobile drawer and auth modal (Google-only) with focus trap and ESC close.
- Added landing-specific keyframes for subtle motion in src/app/globals.css.

## Phase 5 update log
- Updated AuthModal copy to "Claim Early Access" with Google-only primary CTA and INR value nudge.
- Added localStorage flag `first_login_banner_eligible` before OAuth redirect.

## Phase 6 update log
- Mentor spotlight bubble now delayed (3s) with localStorage guard and mobile tap reveal.
- Added hover capability detection helper and quote placeholder TODO.

## Phase 7/8 update log
- Added authenticated overlays with early access banner gating (first 3 sessions) and bug report FAB.
- Bug report modal submits to bug_reports with optional screenshot uploads to bug-screenshots.
- Added shared focus trap hook in src/components/useFocusTrap.ts.

## Phase 9 update log
- Added CAT info hub mini-nav with scroll-to-section buttons and accordion panels.
- Added back-to-top button that appears after the hero section.
````

## File: docs/MIGRATION_CONTEXTS.sql
````sql
-- Question Contexts Migration
-- This table stores shared passages/contexts that questions can reference

-- ============================================================================
-- QUESTION_CONTEXTS TABLE
-- ============================================================================
CREATE TABLE public.question_contexts (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  paper_id UUID REFERENCES public.papers(id) ON DELETE CASCADE NOT NULL,
  section TEXT NOT NULL CHECK (section IN ('VARC', 'DILR', 'QA')),
  title TEXT NOT NULL,                -- Descriptive title for admin
  text TEXT NOT NULL,                 -- The actual passage/context text
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- Add context_id to questions table
ALTER TABLE public.questions 
ADD COLUMN context_id UUID REFERENCES public.question_contexts(id) ON DELETE SET NULL;

-- Index for faster lookups
CREATE INDEX idx_question_contexts_paper_id ON public.question_contexts(paper_id);
CREATE INDEX idx_questions_context_id ON public.questions(context_id);

-- RLS Policies
ALTER TABLE public.question_contexts ENABLE ROW LEVEL SECURITY;

-- Anyone can read contexts (needed for exam display)
CREATE POLICY "Anyone can view question contexts" ON public.question_contexts
  FOR SELECT
  USING (true);

-- Only authenticated users can insert/update (for admin)
CREATE POLICY "Authenticated users can insert contexts" ON public.question_contexts
  FOR INSERT
  WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can update contexts" ON public.question_contexts
  FOR UPDATE
  USING (auth.role() = 'authenticated');

-- Trigger to update updated_at
CREATE TRIGGER update_question_contexts_updated_at
  BEFORE UPDATE ON public.question_contexts
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
````

## File: docs/MIGRATION_M5_SCORING.sql
````sql
-- =============================================================================
-- MILESTONE 5: Results & Analytics Engine - Database Migration
-- =============================================================================
-- 
-- This migration adds necessary columns for the scoring engine and analytics.
-- EXECUTE IN SUPABASE SQL EDITOR
--
-- Prerequisites:
--   - Tables: attempts, responses, questions must exist
--   - You must have admin/service_role access
--
-- =============================================================================

-- -----------------------------------------------------------------------------
-- SECTION 1: Attempts Table Enhancements
-- -----------------------------------------------------------------------------

-- Add scoring and analytics columns to attempts table
ALTER TABLE public.attempts
ADD COLUMN IF NOT EXISTS total_score DECIMAL(6,2) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS max_possible_score INTEGER DEFAULT NULL,
ADD COLUMN IF NOT EXISTS section_scores JSONB DEFAULT '{}'::jsonb,
ADD COLUMN IF NOT EXISTS correct_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS incorrect_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS unanswered_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS time_taken_seconds INTEGER DEFAULT NULL,
ADD COLUMN IF NOT EXISTS accuracy DECIMAL(5,2) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS attempt_rate DECIMAL(5,2) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS percentile DECIMAL(5,2) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS rank INTEGER DEFAULT NULL;

-- Add submitted_at if not exists (completed exam timestamp)
ALTER TABLE public.attempts
ADD COLUMN IF NOT EXISTS submitted_at TIMESTAMPTZ DEFAULT NULL;

-- Comment on columns for documentation
COMMENT ON COLUMN public.attempts.total_score IS 'Final calculated score after applying marking scheme';
COMMENT ON COLUMN public.attempts.max_possible_score IS 'Maximum possible score for the paper';
COMMENT ON COLUMN public.attempts.section_scores IS 'JSONB with section-wise breakdown: {VARC: {score, correct, incorrect, unanswered}, ...}';
COMMENT ON COLUMN public.attempts.accuracy IS 'Percentage of attempted questions that were correct';
COMMENT ON COLUMN public.attempts.attempt_rate IS 'Percentage of total questions that were attempted';
COMMENT ON COLUMN public.attempts.percentile IS 'Percentile rank among all attempts on this paper';
COMMENT ON COLUMN public.attempts.rank IS 'Absolute rank among all attempts on this paper';

-- -----------------------------------------------------------------------------
-- SECTION 2: Responses Table Enhancements
-- -----------------------------------------------------------------------------

-- Add per-question scoring columns to responses table
ALTER TABLE public.responses
ADD COLUMN IF NOT EXISTS is_correct BOOLEAN DEFAULT NULL,
ADD COLUMN IF NOT EXISTS marks_obtained DECIMAL(5,2) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS answer TEXT DEFAULT NULL;

-- Comment on columns
COMMENT ON COLUMN public.responses.is_correct IS 'Whether the response was correct (null if unanswered)';
COMMENT ON COLUMN public.responses.marks_obtained IS 'Points awarded/deducted for this response';
COMMENT ON COLUMN public.responses.answer IS 'Unified answer field (selected_option or tita_answer)';

-- -----------------------------------------------------------------------------
-- SECTION 3: Questions Table - Ensure Required Columns
-- -----------------------------------------------------------------------------

-- Ensure questions table has all required columns for scoring
ALTER TABLE public.questions
ADD COLUMN IF NOT EXISTS section VARCHAR(20) DEFAULT 'QA',
ADD COLUMN IF NOT EXISTS question_type VARCHAR(10) DEFAULT 'MCQ',
ADD COLUMN IF NOT EXISTS marks INTEGER DEFAULT 3,
ADD COLUMN IF NOT EXISTS negative_marks DECIMAL(3,2) DEFAULT 1,
ADD COLUMN IF NOT EXISTS correct_answer TEXT NOT NULL DEFAULT '',
ADD COLUMN IF NOT EXISTS solution_text TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS topic VARCHAR(100) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS difficulty VARCHAR(20) DEFAULT 'Medium';

-- Add check constraints (drop first if exists to avoid errors)
DO $$ 
BEGIN
    -- Drop existing constraints if they exist
    ALTER TABLE public.questions DROP CONSTRAINT IF EXISTS questions_section_check;
    ALTER TABLE public.questions DROP CONSTRAINT IF EXISTS questions_type_check;
    
    -- Add constraints
    ALTER TABLE public.questions 
    ADD CONSTRAINT questions_section_check CHECK (section IN ('VARC', 'DILR', 'QA'));
    
    ALTER TABLE public.questions 
    ADD CONSTRAINT questions_type_check CHECK (question_type IN ('MCQ', 'TITA'));
EXCEPTION
    WHEN others THEN
        RAISE NOTICE 'Constraints may already exist or table structure differs: %', SQLERRM;
END $$;

COMMENT ON COLUMN public.questions.section IS 'CAT section: VARC, DILR, or QA';
COMMENT ON COLUMN public.questions.question_type IS 'MCQ (Multiple Choice) or TITA (Type In The Answer)';
COMMENT ON COLUMN public.questions.marks IS 'Positive marks for correct answer (CAT: 3)';
COMMENT ON COLUMN public.questions.negative_marks IS 'Negative marks for incorrect MCQ (CAT: 1)';

-- -----------------------------------------------------------------------------
-- SECTION 4: Indexes for Performance
-- -----------------------------------------------------------------------------

-- Index for leaderboard queries (ranking by score)
CREATE INDEX IF NOT EXISTS idx_attempts_total_score 
ON public.attempts (total_score DESC NULLS LAST);

-- Composite index for paper-specific leaderboards
CREATE INDEX IF NOT EXISTS idx_attempts_paper_score 
ON public.attempts (paper_id, total_score DESC NULLS LAST);

-- Index for user's attempt history
CREATE INDEX IF NOT EXISTS idx_attempts_user_status 
ON public.attempts (user_id, status, submitted_at DESC);

-- Index for responses by attempt (for result page)
CREATE INDEX IF NOT EXISTS idx_responses_attempt 
ON public.responses (attempt_id);

-- Index for questions by paper (for scoring)
CREATE INDEX IF NOT EXISTS idx_questions_paper_section 
ON public.questions (paper_id, section, question_number);

-- -----------------------------------------------------------------------------
-- SECTION 5: RLS Policies for Scoring Updates
-- -----------------------------------------------------------------------------

-- Drop and recreate policies to avoid "already exists" errors
DROP POLICY IF EXISTS "Users can update own attempts" ON public.attempts;
DROP POLICY IF EXISTS "Users can update own responses" ON public.responses;
DROP POLICY IF EXISTS "Users can read questions for their completed attempts" ON public.questions;

-- Allow authenticated users to update their own attempts
CREATE POLICY "Users can update own attempts"
ON public.attempts FOR UPDATE
TO authenticated
USING (auth.uid() = user_id)
WITH CHECK (
  auth.uid() = user_id
  AND status = (SELECT status FROM public.attempts a WHERE a.id = attempts.id)
  AND submitted_at IS NOT DISTINCT FROM (SELECT submitted_at FROM public.attempts a WHERE a.id = attempts.id)
  AND completed_at IS NOT DISTINCT FROM (SELECT completed_at FROM public.attempts a WHERE a.id = attempts.id)
);

-- Allow authenticated users to update their own responses
CREATE POLICY "Users can update own responses"
ON public.responses FOR UPDATE
TO authenticated
USING (
  attempt_id IN (
    SELECT id FROM public.attempts WHERE user_id = auth.uid()
  )
);

-- Allow reading questions for completed attempts (for result page)
-- Note: correct_answer is needed for result display but should be protected during exam
CREATE POLICY "Users can read questions for their completed attempts"
ON public.questions FOR SELECT
TO authenticated
USING (
  paper_id IN (
    SELECT paper_id FROM public.attempts 
    WHERE user_id = auth.uid()
      AND status IN ('submitted', 'completed')
      AND submitted_at IS NOT NULL
  )
);

-- -----------------------------------------------------------------------------
-- SECTION 5.5: Legacy scoring cleanup (optional, after verification)
-- -----------------------------------------------------------------------------
-- If TypeScript scoring is the single source of truth, retire legacy DB scoring.
-- Checklist before dropping:
-- 1) Confirm no API route, trigger, or cron calls public.finalize_attempt
-- 2) Confirm results page uses fetch_attempt_solutions RPC + questions_exam
-- 3) Confirm scoring happens only in TypeScript submit path
--
-- DROP FUNCTION IF EXISTS public.finalize_attempt(UUID);

-- -----------------------------------------------------------------------------
-- SECTION 6: Verification Queries
-- -----------------------------------------------------------------------------

-- Run these after migration to verify columns exist:

-- Check attempts table columns:
-- SELECT column_name, data_type, is_nullable 
-- FROM information_schema.columns 
-- WHERE table_name = 'attempts' AND table_schema = 'public'
-- ORDER BY ordinal_position;

-- Check responses table columns:
-- SELECT column_name, data_type, is_nullable 
-- FROM information_schema.columns 
-- WHERE table_name = 'responses' AND table_schema = 'public'
-- ORDER BY ordinal_position;

-- Check questions table columns:
-- SELECT column_name, data_type, is_nullable 
-- FROM information_schema.columns 
-- WHERE table_name = 'questions' AND table_schema = 'public'
-- ORDER BY ordinal_position;

-- -----------------------------------------------------------------------------
-- VERIFICATION SQL (RLS safety check)
-- -----------------------------------------------------------------------------
-- 1) Should return rows for a submitted/completed attempt:
-- SELECT q.id
-- FROM public.questions q
-- WHERE q.paper_id IN (
--   SELECT paper_id FROM public.attempts
--   WHERE user_id = auth.uid()
--     AND status IN ('submitted','completed')
--     AND submitted_at IS NOT NULL
-- );

-- 2) Should return 0 rows for an in_progress attempt:
-- SELECT q.id
-- FROM public.questions q
-- WHERE q.paper_id IN (
--   SELECT paper_id FROM public.attempts
--   WHERE user_id = auth.uid()
--     AND status = 'in_progress'
-- );

-- =============================================================================
-- END OF MIGRATION
-- =============================================================================
````

## File: docs/MIGRATION_M6_RBAC.sql
````sql
-- ============================================================================
-- MILESTONE 6: RBAC (Role-Based Access Control) Migration
-- ============================================================================
-- This script implements the Hybrid Claims Model for admin access control.
-- 
-- Architecture:
-- 1. Source of Truth: public.user_roles table
-- 2. Performance: Supabase Auth Hook injects custom claims into JWT
-- 3. Enforcement: Middleware + RLS policies check JWT claims
--
-- Run this in Supabase SQL Editor in order.
-- ============================================================================

-- ============================================================================
-- STEP 1: Create Role ENUM and user_roles table
-- ============================================================================

-- Create role enum type (if not exists)
DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'app_role') THEN
        CREATE TYPE public.app_role AS ENUM ('user', 'admin', 'editor', 'dev');
    END IF;
END $$;

-- Create user_roles table
CREATE TABLE IF NOT EXISTS public.user_roles (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
    role public.app_role NOT NULL DEFAULT 'user',
    granted_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    granted_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- Create index for fast role lookups
CREATE INDEX IF NOT EXISTS idx_user_roles_user_id ON public.user_roles(user_id);
CREATE INDEX IF NOT EXISTS idx_user_roles_role ON public.user_roles(role);

-- Add comment for documentation
COMMENT ON TABLE public.user_roles IS 'Stores user roles for RBAC. Source of truth for access control.';
COMMENT ON COLUMN public.user_roles.granted_by IS 'The admin who granted this role (NULL for system grants)';

-- ============================================================================
-- STEP 2: Enable RLS on user_roles table
-- ============================================================================

ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they exist (for re-runs)
DROP POLICY IF EXISTS "Users can view their own role" ON public.user_roles;
DROP POLICY IF EXISTS "Admins can view all roles" ON public.user_roles;
DROP POLICY IF EXISTS "Admins can insert roles" ON public.user_roles;
DROP POLICY IF EXISTS "Admins can update roles" ON public.user_roles;
DROP POLICY IF EXISTS "Admins can delete roles" ON public.user_roles;

-- Policy: Users can view their own role
CREATE POLICY "Users can view their own role" ON public.user_roles
    FOR SELECT USING (auth.uid() = user_id);

-- Policy: Admins can view all roles
CREATE POLICY "Admins can view all roles" ON public.user_roles
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM public.user_roles 
            WHERE user_id = auth.uid() AND role IN ('admin', 'dev')
        )
    );

-- Policy: Admins can insert new roles
CREATE POLICY "Admins can insert roles" ON public.user_roles
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM public.user_roles 
            WHERE user_id = auth.uid() AND role IN ('admin', 'dev')
        )
    );

-- Policy: Admins can update roles (except their own admin role)
CREATE POLICY "Admins can update roles" ON public.user_roles
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM public.user_roles 
            WHERE user_id = auth.uid() AND role IN ('admin', 'dev')
        )
        AND user_id != auth.uid() -- Cannot modify own role
    );

-- Policy: Admins can delete roles (except their own)
CREATE POLICY "Admins can delete roles" ON public.user_roles
    FOR DELETE USING (
        EXISTS (
            SELECT 1 FROM public.user_roles 
            WHERE user_id = auth.uid() AND role IN ('admin', 'dev')
        )
        AND user_id != auth.uid()
    );

-- ============================================================================
-- STEP 3: Auth Hook Function for Custom JWT Claims
-- ============================================================================
-- This function is called during token generation and injects the user's role
-- into the JWT access_token as a custom claim.

CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event JSONB)
RETURNS JSONB
LANGUAGE plpgsql
STABLE
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    claims JSONB;
    user_role public.app_role;
BEGIN
    -- Get the user's role from user_roles table
    SELECT role INTO user_role
    FROM public.user_roles
    WHERE user_id = (event->>'user_id')::UUID;
    
    -- Default to 'user' if no role found
    IF user_role IS NULL THEN
        user_role := 'user';
    END IF;

    -- Get existing claims
    claims := event->'claims';
    
    -- Check if 'app_metadata' exists; if not, initialize it
    IF claims->'app_metadata' IS NULL THEN
        claims := jsonb_set(claims, '{app_metadata}', '{}');
    END IF;
    
    -- Set the user_role in app_metadata
    claims := jsonb_set(claims, '{app_metadata, user_role}', to_jsonb(user_role::TEXT));
    
    -- Also set at root level for easier access
    claims := jsonb_set(claims, '{user_role}', to_jsonb(user_role::TEXT));
    
    -- Return the modified event
    RETURN jsonb_set(event, '{claims}', claims);
END;
$$;

-- Grant execute permission to supabase_auth_admin (required for Auth Hooks)
GRANT EXECUTE ON FUNCTION public.custom_access_token_hook TO supabase_auth_admin;

-- Revoke from public for security
REVOKE EXECUTE ON FUNCTION public.custom_access_token_hook FROM PUBLIC;
REVOKE EXECUTE ON FUNCTION public.custom_access_token_hook FROM anon;
REVOKE EXECUTE ON FUNCTION public.custom_access_token_hook FROM authenticated;

-- ============================================================================
-- STEP 4: Auto-assign 'user' role on signup
-- ============================================================================
-- This trigger automatically creates a user_roles entry when a new user signs up.

CREATE OR REPLACE FUNCTION public.handle_new_user_role()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
BEGIN
    INSERT INTO public.user_roles (user_id, role)
    VALUES (NEW.id, 'user')
    ON CONFLICT (user_id) DO NOTHING;
    RETURN NEW;
END;
$$;

-- Create trigger (drop first if exists to avoid conflicts)
DROP TRIGGER IF EXISTS on_auth_user_created_role ON auth.users;
CREATE TRIGGER on_auth_user_created_role
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_new_user_role();

-- ============================================================================
-- STEP 5: Update RLS policies for admin operations on content tables
-- ============================================================================

-- Drop existing policies if they exist (for re-runs)
DROP POLICY IF EXISTS "Admins can insert papers" ON public.papers;
DROP POLICY IF EXISTS "Admins can update papers" ON public.papers;
DROP POLICY IF EXISTS "Admins can delete papers" ON public.papers;
DROP POLICY IF EXISTS "Admins can insert questions" ON public.questions;
DROP POLICY IF EXISTS "Admins can update questions" ON public.questions;
DROP POLICY IF EXISTS "Admins can delete questions" ON public.questions;
DROP POLICY IF EXISTS "Admins can view all questions" ON public.questions;

-- Papers: Admins can manage all papers
CREATE POLICY "Admins can insert papers" ON public.papers
    FOR INSERT WITH CHECK (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

CREATE POLICY "Admins can update papers" ON public.papers
    FOR UPDATE USING (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

CREATE POLICY "Admins can delete papers" ON public.papers
    FOR DELETE USING (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

-- Questions: Admins can manage all questions
CREATE POLICY "Admins can insert questions" ON public.questions
    FOR INSERT WITH CHECK (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

CREATE POLICY "Admins can update questions" ON public.questions
    FOR UPDATE USING (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

CREATE POLICY "Admins can delete questions" ON public.questions
    FOR DELETE USING (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

-- Admins can view ALL questions (including inactive ones)
CREATE POLICY "Admins can view all questions" ON public.questions
    FOR SELECT USING (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

-- ============================================================================
-- STEP 6: Question Contexts table (if not exists)
-- ============================================================================
-- For VARC passages, DILR data sets shared across multiple questions

CREATE TABLE IF NOT EXISTS public.question_contexts (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    paper_id UUID REFERENCES public.papers(id) ON DELETE CASCADE NOT NULL,
    section TEXT NOT NULL CHECK (section IN ('VARC', 'DILR', 'QA')),
    context_type TEXT NOT NULL CHECK (context_type IN ('passage', 'data_set', 'image', 'table')),
    title TEXT, -- Optional title/label for the context
    content TEXT NOT NULL, -- The actual passage/data content (supports Markdown)
    image_url TEXT, -- Optional image for DI sets
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- Add context_id to questions table (if not exists)
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_schema = 'public' 
        AND table_name = 'questions' 
        AND column_name = 'context_id'
    ) THEN
        ALTER TABLE public.questions 
        ADD COLUMN context_id UUID REFERENCES public.question_contexts(id) ON DELETE SET NULL;
    END IF;
END $$;

-- Create index for context lookups
CREATE INDEX IF NOT EXISTS idx_questions_context ON public.questions(context_id);
CREATE INDEX IF NOT EXISTS idx_question_contexts_paper ON public.question_contexts(paper_id, section);

-- Enable RLS on question_contexts
ALTER TABLE public.question_contexts ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they exist (for re-runs)
DROP POLICY IF EXISTS "Authenticated users can view active contexts" ON public.question_contexts;
DROP POLICY IF EXISTS "Admins can view all contexts" ON public.question_contexts;
DROP POLICY IF EXISTS "Admins can insert contexts" ON public.question_contexts;
DROP POLICY IF EXISTS "Admins can update contexts" ON public.question_contexts;
DROP POLICY IF EXISTS "Admins can delete contexts" ON public.question_contexts;

-- RLS policies for question_contexts
CREATE POLICY "Authenticated users can view active contexts" ON public.question_contexts
    FOR SELECT TO authenticated USING (is_active = true);

CREATE POLICY "Admins can view all contexts" ON public.question_contexts
    FOR SELECT USING (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

CREATE POLICY "Admins can insert contexts" ON public.question_contexts
    FOR INSERT WITH CHECK (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

CREATE POLICY "Admins can update contexts" ON public.question_contexts
    FOR UPDATE USING (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

CREATE POLICY "Admins can delete contexts" ON public.question_contexts
    FOR DELETE USING (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

-- ============================================================================
-- STEP 7: Admin Audit Log table
-- ============================================================================
-- Track all admin actions for security and compliance

CREATE TABLE IF NOT EXISTS public.admin_audit_log (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    admin_id UUID REFERENCES auth.users(id) ON DELETE SET NULL NOT NULL,
    action TEXT NOT NULL, -- 'create', 'update', 'delete', 'publish', etc.
    entity_type TEXT NOT NULL, -- 'paper', 'question', 'context', 'user_role'
    entity_id UUID NOT NULL,
    changes JSONB, -- Before/after snapshot for updates
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- Create indexes for audit queries
CREATE INDEX IF NOT EXISTS idx_audit_admin ON public.admin_audit_log(admin_id);
CREATE INDEX IF NOT EXISTS idx_audit_entity ON public.admin_audit_log(entity_type, entity_id);
CREATE INDEX IF NOT EXISTS idx_audit_created ON public.admin_audit_log(created_at DESC);

-- Enable RLS
ALTER TABLE public.admin_audit_log ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they exist (for re-runs)
DROP POLICY IF EXISTS "Admins can view audit logs" ON public.admin_audit_log;
DROP POLICY IF EXISTS "Admins can insert audit logs" ON public.admin_audit_log;

-- Only admins can view audit logs
CREATE POLICY "Admins can view audit logs" ON public.admin_audit_log
    FOR SELECT USING (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

-- System/admin can insert logs
CREATE POLICY "Admins can insert audit logs" ON public.admin_audit_log
    FOR INSERT WITH CHECK (
        (auth.jwt() ->> 'user_role') IN ('admin', 'dev')
        OR (auth.jwt() -> 'app_metadata' ->> 'user_role') IN ('admin', 'dev')
    );

-- ============================================================================
-- STEP 8: Helper function to check admin status
-- ============================================================================

CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
    SELECT EXISTS (
        SELECT 1 FROM public.user_roles
        WHERE user_id = auth.uid() AND role IN ('admin', 'dev')
    );
$$;

CREATE OR REPLACE FUNCTION public.get_user_role()
RETURNS TEXT
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
    SELECT COALESCE(
        (SELECT role::TEXT FROM public.user_roles WHERE user_id = auth.uid()),
        'user'
    );
$$;

-- Grant execute permissions
GRANT EXECUTE ON FUNCTION public.is_admin TO authenticated;
GRANT EXECUTE ON FUNCTION public.get_user_role TO authenticated;

-- ============================================================================
-- STEP 9: Bootstrap First Admin (MANUAL STEP)
-- ============================================================================
-- IMPORTANT: Run this ONCE after the first admin user signs up.
-- Replace 'your-user-id-here' with the actual UUID from auth.users
-- 
-- You can find your user ID by running:
-- SELECT id, email FROM auth.users WHERE email = 'your-email@example.com';
--
-- Then run:
-- INSERT INTO public.user_roles (user_id, role) 
-- VALUES ('your-user-id-here', 'admin')
-- ON CONFLICT (user_id) DO UPDATE SET role = 'admin';

-- ============================================================================
-- STEP 10: Activate the Auth Hook in Supabase Dashboard
-- ============================================================================
-- IMPORTANT: After running this migration, you must enable the Auth Hook
-- in the Supabase Dashboard:
-- 
-- 1. Go to Authentication > Hooks
-- 2. Enable "Customize Access Token (JWT) Hook"
-- 3. Select the function: public.custom_access_token_hook
-- 4. Save
--
-- This will inject the user_role claim into every JWT token.

-- ============================================================================
-- STEP 8: Create Storage Bucket for Question Images
-- ============================================================================
-- This bucket stores diagrams and images for questions.
-- Admins can upload, authenticated users can view.

-- Create the storage bucket (run this separately in Storage or via SQL)
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
    'question-images',
    'question-images',
    true,  -- Public bucket for easy image serving
    5242880,  -- 5MB max file size
    ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml']
) ON CONFLICT (id) DO NOTHING;

-- Drop existing storage policies if they exist (for re-runs)
DROP POLICY IF EXISTS "Public read access for question images" ON storage.objects;
DROP POLICY IF EXISTS "Admins can upload question images" ON storage.objects;
DROP POLICY IF EXISTS "Admins can update question images" ON storage.objects;
DROP POLICY IF EXISTS "Admins can delete question images" ON storage.objects;

-- Policy: Anyone can view images (public bucket)
CREATE POLICY "Public read access for question images" ON storage.objects
    FOR SELECT
    USING (bucket_id = 'question-images');

-- Policy: Only admins can upload images
CREATE POLICY "Admins can upload question images" ON storage.objects
    FOR INSERT
    WITH CHECK (
        bucket_id = 'question-images' 
        AND public.is_admin()
    );

-- Policy: Only admins can update images
CREATE POLICY "Admins can update question images" ON storage.objects
    FOR UPDATE
    USING (
        bucket_id = 'question-images' 
        AND public.is_admin()
    );

-- Policy: Only admins can delete images
CREATE POLICY "Admins can delete question images" ON storage.objects
    FOR DELETE
    USING (
        bucket_id = 'question-images' 
        AND public.is_admin()
    );

-- ============================================================================
-- VERIFICATION QUERIES
-- ============================================================================
-- Run these to verify the migration was successful:

-- Check if user_roles table exists
-- SELECT * FROM public.user_roles LIMIT 5;

-- Check if hook function exists
-- SELECT proname FROM pg_proc WHERE proname = 'custom_access_token_hook';

-- Check RLS policies
-- SELECT policyname, tablename FROM pg_policies WHERE schemaname = 'public';

-- ============================================================================
-- ROLLBACK SCRIPT (if needed)
-- ============================================================================
/*
DROP TRIGGER IF EXISTS on_auth_user_created_role ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user_role;
DROP FUNCTION IF EXISTS public.custom_access_token_hook;
DROP FUNCTION IF EXISTS public.is_admin;
DROP FUNCTION IF EXISTS public.get_user_role;
DROP TABLE IF EXISTS public.admin_audit_log;
DROP TABLE IF EXISTS public.user_roles;
DROP TYPE IF EXISTS public.app_role;
*/
````

## File: docs/MIGRATION_RLS_VIEWS.sql
````sql
-- ============================================================================
-- MIGRATION: Update RLS Policies + Add Secure Views
-- Run this on an EXISTING database to apply the new security changes
-- Version: 2.1 - RLS & Views Update
-- ============================================================================

-- ============================================================================
-- STEP 1: DROP OLD POLICIES (if they exist)
-- ============================================================================

-- Drop old papers policy
DROP POLICY IF EXISTS "Authenticated users can view published papers" ON public.papers;
DROP POLICY IF EXISTS "Authenticated users can view available papers" ON public.papers;

-- Drop old questions policy
DROP POLICY IF EXISTS "Authenticated users can view active questions" ON public.questions;
DROP POLICY IF EXISTS "Users can read questions for their completed attempts" ON public.questions;

-- ============================================================================
-- STEP 2: CREATE UPDATED RLS POLICIES
-- ============================================================================

-- Papers: Now checks published + availability window
CREATE POLICY "Authenticated users can view available papers" ON public.papers
  FOR SELECT TO authenticated 
  USING (
    -- Admins can see everything
    public.is_admin()
    OR (
      -- Published papers within availability window
      published = true
      AND (available_from IS NULL OR available_from <= NOW())
      AND (available_until IS NULL OR available_until >= NOW())
    )
  );

-- Questions: Only allow reads after submission/completion (prevents in-progress leaks)
CREATE POLICY "Users can read questions for their completed attempts" ON public.questions
  FOR SELECT TO authenticated 
  USING (
    is_active = true
    AND paper_id IN (
      SELECT paper_id FROM public.attempts
      WHERE user_id = auth.uid()
        AND status IN ('submitted', 'completed')
        AND submitted_at IS NOT NULL
    )
  );

-- ============================================================================
-- STEP 3: CREATE SECURE VIEWS
-- ============================================================================

-- Drop views if they exist (for idempotent migration)
DROP VIEW IF EXISTS public.questions_exam CASCADE;
DROP VIEW IF EXISTS public.questions_with_solutions CASCADE;

-- ============================================================================
-- NOTE: questions_exam view is created in STEP 4.5 with security_invoker
-- This ensures RLS policies are enforced when querying through the view
-- ============================================================================

-- View for results/solutions: questions WITH answers (for post-submission review)
-- NOTE: This view is NOT granted to any role - use fetch_attempt_solutions RPC instead
CREATE VIEW public.questions_with_solutions AS
SELECT 
  id,
  paper_id,
  section,
  question_number,
  question_text,
  question_type,
  options,
  correct_answer,
  positive_marks,
  negative_marks,
  question_image_url,
  solution_text,
  solution_image_url,
  video_solution_url,
  context_id,
  set_id,
  sequence_order,
  difficulty,
  topic,
  subtopic
FROM public.questions
WHERE is_active = true;

-- Do NOT grant solutions view to authenticated users; results must use RPC
REVOKE ALL ON public.questions_with_solutions FROM PUBLIC;
REVOKE ALL ON public.questions_with_solutions FROM anon;
REVOKE ALL ON public.questions_with_solutions FROM authenticated;

-- ============================================================================
-- STEP 3.5: COLUMN-LEVEL LOCKDOWN (Pattern A - required)
-- Prevent direct SELECT of sensitive fields from public.questions
-- NOTE: After revokes, SELECT * on public.questions by authenticated will fail.
-- Runtime must use public.questions_exam; solutions must use RPC.
-- ============================================================================

REVOKE SELECT (correct_answer, solution_text, solution_image_url, video_solution_url)
ON public.questions FROM PUBLIC;
REVOKE SELECT (correct_answer, solution_text, solution_image_url, video_solution_url)
ON public.questions FROM anon;
REVOKE SELECT (correct_answer, solution_text, solution_image_url, video_solution_url)
ON public.questions FROM authenticated;

-- ============================================================================
-- STEP 4: question_sets_with_questions safe view (published only + no answers)
-- ============================================================================

-- Drop and recreate to ensure it excludes sensitive fields and enforces published-only
DROP VIEW IF EXISTS public.question_sets_with_questions CASCADE;

CREATE VIEW public.question_sets_with_questions
WITH (security_invoker = true)
AS
SELECT 
    qs.id,
    qs.paper_id,
    qs.section,
    qs.set_type,
    qs.content_layout,
    qs.context_title,
    qs.context_body,
    qs.context_image_url,
    qs.context_additional_images,
    qs.display_order,
    qs.question_count,
    qs.metadata,
    qs.is_active,
    qs.is_published,
    qs.created_at,
    qs.updated_at,
    COALESCE(
        json_agg(
            json_build_object(
                'id', q.id,
                'question_text', q.question_text,
                'question_type', q.question_type,
                'options', q.options,
                'positive_marks', q.positive_marks,
                'negative_marks', q.negative_marks,
                'question_number', q.question_number,
                'sequence_order', q.sequence_order,
                'question_image_url', q.question_image_url,
                'difficulty', q.difficulty,
                'topic', q.topic,
                'subtopic', q.subtopic,
                'is_active', q.is_active
                -- EXCLUDED: correct_answer, solution_text, solution_image_url, video_solution_url
            ) ORDER BY q.sequence_order
        ) FILTER (WHERE q.id IS NOT NULL),
        '[]'::json
    ) AS questions
FROM public.question_sets qs
LEFT JOIN public.questions q ON q.set_id = qs.id AND q.is_active = TRUE
WHERE qs.is_active = TRUE
  AND qs.is_published = TRUE
  AND qs.paper_id IN (SELECT id FROM public.papers WHERE published = TRUE)
GROUP BY qs.id;

-- Grant SELECT to authenticated only
REVOKE ALL ON public.question_sets_with_questions FROM PUBLIC;
REVOKE ALL ON public.question_sets_with_questions FROM anon;
GRANT SELECT ON public.question_sets_with_questions TO authenticated;

-- ============================================================================
-- STEP 4.5: Recreate questions_exam with security_invoker (Postgres 15+)
-- ============================================================================

DROP VIEW IF EXISTS public.questions_exam CASCADE;

CREATE VIEW public.questions_exam
WITH (security_invoker = true)
AS
SELECT 
  id,
  paper_id,
  section,
  question_number,
  question_text,
  question_type,
  options,
  positive_marks,
  negative_marks,
  question_image_url,
  context_id,
  set_id,
  sequence_order,
  difficulty,
  topic,
  subtopic,
  is_active,
  created_at,
  updated_at
  -- EXCLUDED: correct_answer, solution_text, solution_image_url, video_solution_url
FROM public.questions
WHERE is_active = true;

-- Grant SELECT to authenticated only
REVOKE ALL ON public.questions_exam FROM PUBLIC;
REVOKE ALL ON public.questions_exam FROM anon;
GRANT SELECT ON public.questions_exam TO authenticated;

-- ============================================================================
-- STEP 5: VERIFY MIGRATION
-- ============================================================================
-- Run these queries to verify the migration worked:

-- Check policies exist:
-- SELECT policyname FROM pg_policies WHERE tablename IN ('papers', 'questions');

-- Check views exist:
-- SELECT table_name FROM information_schema.views WHERE table_schema = 'public';

-- Test questions_exam doesn't have correct_answer:
-- SELECT column_name FROM information_schema.columns WHERE table_name = 'questions_exam';

-- -----------------------------------------------------------------------------
-- VERIFICATION SQL (Answer Leak Prevention) — RUN IN SUPABASE SQL EDITOR
-- -----------------------------------------------------------------------------

-- TEST 1: Direct SELECT on sensitive columns MUST FAIL (column privilege denied)
-- As authenticated user (not service role):
-- SELECT correct_answer FROM public.questions LIMIT 1;
-- Expected: ERROR permission denied for column correct_answer

-- TEST 2: SELECT * on public.questions MUST FAIL
-- As authenticated user:
-- SELECT * FROM public.questions LIMIT 1;
-- Expected: ERROR permission denied (due to column revokes)

-- TEST 3: Safe view questions_exam works for in-progress attempts
-- As authenticated user with an in_progress attempt:
-- SELECT id, question_text, options FROM public.questions_exam WHERE paper_id = '<your_paper_id>' LIMIT 1;
-- Expected: SUCCESS, returns question without correct_answer

-- TEST 4: Safe view question_sets_with_questions works for published sets
-- As authenticated user:
-- SELECT id, context_title, questions FROM public.question_sets_with_questions WHERE paper_id = '<your_paper_id>' LIMIT 1;
-- Expected: SUCCESS, returns set with questions (no correct_answer in nested JSON)

-- TEST 5: RPC fetch_attempt_solutions works for completed attempts
-- As authenticated user with a submitted attempt:
-- SELECT public.fetch_attempt_solutions('<your_attempt_id>');
-- Expected: SUCCESS, returns JSON with correct_answer, solution_text, etc.

-- TEST 6: RPC fetch_attempt_solutions FAILS for in_progress attempts
-- As authenticated user with an in_progress attempt:
-- SELECT public.fetch_attempt_solutions('<your_in_progress_attempt_id>');
-- Expected: ERROR Attempt not submitted

-- ============================================================================
-- DONE! The migration is complete.
-- Run in Supabase SQL Editor as EXTERNAL WORK.
-- ============================================================================
````

## File: docs/MIGRATION_STATS.sql
````sql
-- ============================================================================
-- MIGRATION: Peer Statistics RPC Function
-- Creates a secure function to calculate option-level statistics for papers
-- Version: 1.0
-- ============================================================================

-- ============================================================================
-- STEP 1: DROP EXISTING FUNCTION (if exists)
-- ============================================================================
DROP FUNCTION IF EXISTS public.get_paper_stats(UUID);

-- ============================================================================
-- STEP 2: CREATE THE STATS FUNCTION
-- ============================================================================
-- Returns aggregated response statistics for a given paper
-- Output format: { [questionId]: { total: number, options: { [optionLabel]: count } } }
-- Security: SECURITY DEFINER ensures the function runs with definer's privileges
-- Only aggregates from 'completed' attempts to ensure data integrity

CREATE OR REPLACE FUNCTION public.get_paper_stats(p_paper_id UUID)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    result JSONB := '{}'::JSONB;
    rec RECORD;
    question_stats JSONB;
    option_counts JSONB;
BEGIN
    -- Validate input
    IF p_paper_id IS NULL THEN
        RETURN '{}'::JSONB;
    END IF;

    -- Verify paper exists and user has access (paper must be published)
    IF NOT EXISTS (
        SELECT 1 FROM papers 
        WHERE id = p_paper_id 
        AND published = true
    ) THEN
        RETURN '{}'::JSONB;
    END IF;

    -- Aggregate responses for completed attempts only
    FOR rec IN (
        SELECT 
            r.question_id,
            r.answer,
            COUNT(*) as answer_count
        FROM responses r
        INNER JOIN attempts a ON a.id = r.attempt_id
        WHERE a.paper_id = p_paper_id
        AND a.status = 'completed'
        AND r.answer IS NOT NULL
        AND r.answer != ''
        GROUP BY r.question_id, r.answer
        ORDER BY r.question_id, r.answer
    )
    LOOP
        -- Get existing stats for this question or initialize
        question_stats := COALESCE(result->rec.question_id::TEXT, '{"total": 0, "options": {}}'::JSONB);
        option_counts := COALESCE(question_stats->'options', '{}'::JSONB);
        
        -- Update total and option count
        question_stats := jsonb_set(
            question_stats,
            '{total}',
            to_jsonb((question_stats->>'total')::INT + rec.answer_count::INT)
        );
        
        option_counts := jsonb_set(
            option_counts,
            ARRAY[rec.answer],
            to_jsonb(rec.answer_count::INT)
        );
        
        question_stats := jsonb_set(question_stats, '{options}', option_counts);
        
        -- Update result
        result := jsonb_set(result, ARRAY[rec.question_id::TEXT], question_stats);
    END LOOP;

    RETURN result;
END;
$$;

-- ============================================================================
-- STEP 3: GRANT PERMISSIONS
-- ============================================================================
-- Allow authenticated users to call this function
GRANT EXECUTE ON FUNCTION public.get_paper_stats(UUID) TO authenticated;

-- ============================================================================
-- STEP 4: CREATE INDEX FOR PERFORMANCE (if not exists)
-- ============================================================================
-- Index on responses(question_id) for faster aggregation
CREATE INDEX IF NOT EXISTS idx_responses_question_id ON public.responses(question_id);

-- Index on attempts(paper_id, status) for faster filtering
CREATE INDEX IF NOT EXISTS idx_attempts_paper_status ON public.attempts(paper_id, status);

-- ============================================================================
-- STEP 5: VERIFICATION QUERIES
-- ============================================================================
-- Run these to verify the function works:

-- Check function exists:
-- SELECT proname FROM pg_proc WHERE proname = 'get_paper_stats';

-- Test with a paper_id (replace with actual UUID):
-- SELECT get_paper_stats('your-paper-uuid-here');

-- ============================================================================
-- DONE! The migration is complete.
-- ============================================================================
````

## File: docs/migrations/002_session_locking.sql
````sql
-- ============================================================================
-- Migration: Session Locking for Exam Security
-- @blueprint Security Audit - P0 Fix - Multi-device/tab Prevention
-- ============================================================================
-- Purpose: Prevent users from opening exam in multiple devices/tabs
-- How it works:
--   1. When exam starts, a session_token (UUID) is generated and stored
--   2. All save/submit requests must include matching session_token
--   3. last_activity_at tracks when user was last active
--   4. Stale sessions (>5 min inactive) can be invalidated
-- ============================================================================

-- Add session locking columns to attempts table
ALTER TABLE attempts 
ADD COLUMN IF NOT EXISTS session_token UUID,
ADD COLUMN IF NOT EXISTS last_activity_at TIMESTAMPTZ;

-- Add pause control flag to papers
ALTER TABLE public.papers
ADD COLUMN IF NOT EXISTS allow_pause BOOLEAN DEFAULT FALSE;

COMMENT ON COLUMN public.papers.allow_pause IS 'Whether attempts on this paper can be paused/resumed';

-- Create index for session token lookups
CREATE INDEX IF NOT EXISTS idx_attempts_session_token 
ON attempts(session_token) 
WHERE session_token IS NOT NULL;

-- Create index for activity tracking (useful for cleanup queries)
CREATE INDEX IF NOT EXISTS idx_attempts_last_activity 
ON attempts(last_activity_at) 
WHERE status = 'in_progress';

-- ============================================================================
-- Helper function to validate session token
-- Returns TRUE if session is valid, FALSE otherwise
-- ============================================================================
CREATE OR REPLACE FUNCTION validate_session_token(
    p_attempt_id UUID,
    p_session_token UUID,
    p_user_id UUID
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_stored_token UUID;
    v_user_id UUID;
    v_status TEXT;
BEGIN
    -- Get current attempt state
    SELECT session_token, user_id, status 
    INTO v_stored_token, v_user_id, v_status
    FROM attempts 
    WHERE id = p_attempt_id;
    
    -- Check ownership
    IF v_user_id IS NULL OR v_user_id != p_user_id THEN
        RETURN FALSE;
    END IF;
    
    -- Check status
    IF v_status != 'in_progress' THEN
        RETURN FALSE;
    END IF;
    
    -- If no session token set yet (first request), accept and set it
    IF v_stored_token IS NULL THEN
        UPDATE attempts 
        SET session_token = p_session_token, last_activity_at = NOW()
        WHERE id = p_attempt_id AND user_id = p_user_id;
        RETURN TRUE;
    END IF;
    
    -- Validate token matches
    IF v_stored_token = p_session_token THEN
        -- Update activity timestamp
        UPDATE attempts 
        SET last_activity_at = NOW()
        WHERE id = p_attempt_id;
        RETURN TRUE;
    END IF;
    
    -- Token mismatch - possible multi-device attack
    RETURN FALSE;
END;
$$;

-- ============================================================================
-- Function to initialize session for an attempt
-- Called when user starts the exam
-- ============================================================================
CREATE OR REPLACE FUNCTION initialize_exam_session(
    p_attempt_id UUID,
    p_user_id UUID
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_session_token UUID;
    v_current_token UUID;
    v_rows_updated INTEGER;
BEGIN
    -- Check if session already exists
    SELECT session_token INTO v_current_token
    FROM attempts
    WHERE id = p_attempt_id AND user_id = p_user_id AND status = 'in_progress';
    
    IF v_current_token IS NOT NULL THEN
        -- Session already initialized - return existing token
        -- This allows page refresh without breaking the session
        UPDATE attempts SET last_activity_at = NOW() WHERE id = p_attempt_id;
        RETURN v_current_token;
    END IF;
    
    -- Generate new session token
    v_session_token := gen_random_uuid();
    
    -- Store session token
    UPDATE attempts 
    SET session_token = v_session_token, last_activity_at = NOW()
    WHERE id = p_attempt_id 
      AND user_id = p_user_id 
      AND status = 'in_progress';

    GET DIAGNOSTICS v_rows_updated = ROW_COUNT;
    IF v_rows_updated = 0 THEN
        RAISE EXCEPTION 'Attempt not found or not in progress';
    END IF;

    RETURN v_session_token;
END;
$$;

-- ============================================================================
-- Function to check for stale sessions (admin utility)
-- Sessions with no activity for >5 minutes are considered stale
-- ============================================================================
CREATE OR REPLACE FUNCTION get_stale_exam_sessions(
    p_inactive_minutes INTEGER DEFAULT 5
)
RETURNS TABLE(
    attempt_id UUID,
    user_id UUID,
    started_at TIMESTAMPTZ,
    last_activity_at TIMESTAMPTZ,
    inactive_minutes INTEGER
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        a.id AS attempt_id,
        a.user_id,
        a.started_at,
        a.last_activity_at,
        EXTRACT(EPOCH FROM (NOW() - a.last_activity_at))::INTEGER / 60 AS inactive_minutes
    FROM attempts a
    WHERE a.status = 'in_progress'
      AND a.last_activity_at IS NOT NULL
      AND a.last_activity_at < NOW() - (p_inactive_minutes || ' minutes')::INTERVAL
    ORDER BY a.last_activity_at ASC;
END;
$$;

-- ============================================================================
-- RLS Policy Updates
-- Ensure session_token column is protected from direct client access
-- ============================================================================

-- Note: The session_token should NOT be directly readable by clients
-- It should only be validated server-side via the validate_session_token function
-- If you have RLS policies that SELECT *, consider excluding session_token

-- Example policy (adjust based on your existing RLS setup):
-- CREATE POLICY "Users cannot see session_token directly" 
-- ON attempts FOR SELECT 
-- USING (auth.uid() = user_id)
-- WITH CHECK (false);  -- Prevent updates to session_token from client

-- Lock down attempt status transitions via PostgREST
-- Users can update progress fields only; status/submitted_at/completed_at must remain unchanged
DROP POLICY IF EXISTS "Users can update own attempts" ON public.attempts;
CREATE POLICY "Users can update own attempts" ON public.attempts
    FOR UPDATE TO authenticated
    USING (auth.uid() = user_id)
    WITH CHECK (
        auth.uid() = user_id
        AND status = (SELECT status FROM public.attempts a WHERE a.id = attempts.id)
        AND submitted_at IS NOT DISTINCT FROM (SELECT submitted_at FROM public.attempts a WHERE a.id = attempts.id)
        AND completed_at IS NOT DISTINCT FROM (SELECT completed_at FROM public.attempts a WHERE a.id = attempts.id)
    );

-- ============================================================================
-- Rollback script (if needed)
-- ============================================================================
-- DROP FUNCTION IF EXISTS get_stale_exam_sessions(INTEGER);
-- DROP FUNCTION IF EXISTS initialize_exam_session(UUID, UUID);
-- DROP FUNCTION IF EXISTS validate_session_token(UUID, UUID, UUID);
-- DROP INDEX IF EXISTS idx_attempts_last_activity;
-- DROP INDEX IF EXISTS idx_attempts_session_token;
-- ALTER TABLE attempts DROP COLUMN IF EXISTS last_activity_at;
-- ALTER TABLE attempts DROP COLUMN IF EXISTS session_token;
````

## File: docs/migrations/003_question_container_architecture.sql
````sql
-- ============================================================================
-- MIGRATION: Question Container Architecture
-- ============================================================================
-- Purpose: Implement Parent-Child relationship for question sets
-- 
-- Architecture:
--   - question_sets (Parent): Contains context/passage for composite questions
--   - questions (Child): Individual questions linked to a set
--
-- Set Types:
--   - VARC: Reading Comprehension passages with 4-6 questions
--   - DILR: Data Interpretation / Logical Reasoning with charts/tables
--   - CASELET: Case-based questions with shared scenario
--   - ATOMIC: Single standalone question (Quant, standalone Logic)
--
-- Note: Atomic questions create a set with exactly 1 child question
--       This normalizes rendering logic across all question types
-- ============================================================================

-- ============================================================================
-- STEP 0: CLEANUP - Remove any partial objects from failed runs
-- ============================================================================
-- Use DO blocks to handle cases where objects don't exist

DO $$ 
BEGIN
    -- Drop triggers (may fail if tables don't exist)
    DROP TRIGGER IF EXISTS trg_update_question_set_count ON public.questions;
EXCEPTION WHEN undefined_table THEN NULL;
END $$;

DO $$ 
BEGIN
    DROP TRIGGER IF EXISTS trg_validate_question_set_publish ON public.question_sets;
EXCEPTION WHEN undefined_table THEN NULL;
END $$;

-- Drop view
DROP VIEW IF EXISTS public.question_sets_with_questions;

-- Drop policies (ignore errors if table doesn't exist)
DO $$ 
BEGIN
    DROP POLICY IF EXISTS "Anyone can read published question sets" ON public.question_sets;
    DROP POLICY IF EXISTS "Admins can manage question sets" ON public.question_sets;
EXCEPTION WHEN undefined_table THEN
    NULL; -- Table doesn't exist, skip
END $$;

-- Drop indexes (these are safe - IF EXISTS handles missing)
DROP INDEX IF EXISTS idx_questions_set_sequence;
DROP INDEX IF EXISTS idx_question_sets_paper_section;
DROP INDEX IF EXISTS idx_questions_set_id;
DROP INDEX IF EXISTS idx_question_sets_type;

-- Drop dependent views BEFORE altering columns they depend on
DROP VIEW IF EXISTS public.questions_exam CASCADE;
DROP VIEW IF EXISTS public.question_sets_with_questions CASCADE;

-- Remove columns from questions if they exist
ALTER TABLE public.questions DROP COLUMN IF EXISTS set_id;
ALTER TABLE public.questions DROP COLUMN IF EXISTS sequence_order;

-- Drop functions (will cascade to triggers)
DROP FUNCTION IF EXISTS update_question_set_count() CASCADE;
DROP FUNCTION IF EXISTS validate_question_set_publish() CASCADE;

-- Drop the table
DROP TABLE IF EXISTS public.question_sets CASCADE;

-- ============================================================================
-- STEP 1: Create question_sets table (Parent)
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.question_sets (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    paper_id UUID REFERENCES public.papers(id) ON DELETE CASCADE NOT NULL,
    section TEXT NOT NULL CHECK (section IN ('VARC', 'DILR', 'QA')),
    
    -- Set classification
    set_type TEXT NOT NULL CHECK (set_type IN ('VARC', 'DILR', 'CASELET', 'ATOMIC')),
    
    -- Content Layout determines how to render the context
    -- Options: 'split_passage', 'split_chart', 'split_table', 'single_focus', 'image_top'
    content_layout TEXT NOT NULL DEFAULT 'single_focus',
    
    -- Context content (The passage, chart description, data table, or image)
    context_title TEXT,                      -- Optional title for the context (e.g., "Passage 1")
    context_body TEXT,                       -- Rich text / HTML / Markdown content
    context_image_url TEXT,                  -- Primary image (chart, diagram, table image)
    context_additional_images JSONB,         -- Additional images if needed [{url, caption}]
    
    -- Display configuration
    display_order INTEGER NOT NULL DEFAULT 1, -- Order within the section
    question_count INTEGER NOT NULL DEFAULT 0, -- Denormalized count of child questions
    
    -- Metadata for filtering, analytics, difficulty
    metadata JSONB DEFAULT '{}'::jsonb,
    -- Example metadata structure:
    -- {
    --   "difficulty": "hard",
    --   "topic": "Reading Comprehension",
    --   "subtopic": "Inference",
    --   "tags": ["CAT-2024", "VARC", "RC"],
    --   "source": "CAT 2024 Slot 1",
    --   "estimated_time_minutes": 8
    -- }
    
    -- Publishing state
    is_active BOOLEAN DEFAULT TRUE,
    is_published BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    
    -- Ensure unique ordering within section
    UNIQUE(paper_id, section, display_order)
);

-- ============================================================================
-- STEP 2: Alter questions table to add set relationship
-- ============================================================================

-- Add foreign key to question_sets
ALTER TABLE public.questions 
ADD COLUMN IF NOT EXISTS set_id UUID REFERENCES public.question_sets(id) ON DELETE CASCADE;

-- Add sequence order within the set (1, 2, 3... for questions in a passage)
ALTER TABLE public.questions 
ADD COLUMN IF NOT EXISTS sequence_order INTEGER DEFAULT 1;

-- Add constraint for unique sequence within a set
-- Note: Only applies when set_id is NOT NULL
CREATE UNIQUE INDEX IF NOT EXISTS idx_questions_set_sequence 
ON public.questions(set_id, sequence_order) 
WHERE set_id IS NOT NULL;

-- ============================================================================
-- STEP 3: Create helper function to update question_count
-- ============================================================================
CREATE OR REPLACE FUNCTION update_question_set_count()
RETURNS TRIGGER AS $$
BEGIN
    -- Update count on the affected set
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        UPDATE public.question_sets 
        SET question_count = (
            SELECT COUNT(*) FROM public.questions WHERE set_id = NEW.set_id
        ),
        updated_at = NOW()
        WHERE id = NEW.set_id;
    END IF;
    
    IF TG_OP = 'DELETE' OR TG_OP = 'UPDATE' THEN
        UPDATE public.question_sets 
        SET question_count = (
            SELECT COUNT(*) FROM public.questions WHERE set_id = OLD.set_id
        ),
        updated_at = NOW()
        WHERE id = OLD.set_id;
    END IF;
    
    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- Create trigger for automatic count updates
DROP TRIGGER IF EXISTS trg_update_question_set_count ON public.questions;
CREATE TRIGGER trg_update_question_set_count
AFTER INSERT OR UPDATE OF set_id OR DELETE ON public.questions
FOR EACH ROW
EXECUTE FUNCTION update_question_set_count();

-- ============================================================================
-- STEP 4: Create indexes for performance
-- ============================================================================

-- Index for fetching sets by paper and section
CREATE INDEX IF NOT EXISTS idx_question_sets_paper_section 
ON public.question_sets(paper_id, section, display_order);

-- Index for fetching questions by set
CREATE INDEX IF NOT EXISTS idx_questions_set_id 
ON public.questions(set_id, sequence_order);

-- Index for set_type filtering
CREATE INDEX IF NOT EXISTS idx_question_sets_type 
ON public.question_sets(set_type);

-- ============================================================================
-- STEP 5: Create view for complete question sets with questions
-- NOTE: This is a LEGACY view definition. The canonical hardened view is in
-- docs/MIGRATION_RLS_VIEWS.sql (Phase C) which adds:
--   - security_invoker = true
--   - is_published = TRUE filter
--   - published papers filter
--   - excludes sensitive columns (correct_answer, solution_*)
-- Run Phase C migration AFTER this one to overwrite with secure version.
-- ============================================================================
DROP VIEW IF EXISTS public.question_sets_with_questions CASCADE;

-- Placeholder: Phase C will create the canonical secure view
-- CREATE VIEW public.question_sets_with_questions ... (see MIGRATION_RLS_VIEWS.sql)

-- ============================================================================
-- STEP 6: RLS Policies for question_sets
-- ============================================================================

-- Enable RLS
ALTER TABLE public.question_sets ENABLE ROW LEVEL SECURITY;

-- Drop existing policies to avoid conflicts
DROP POLICY IF EXISTS "Anyone can read published question sets" ON public.question_sets;
DROP POLICY IF EXISTS "Admins can manage question sets" ON public.question_sets;

-- Public can read published sets from published papers
CREATE POLICY "Anyone can read published question sets" ON public.question_sets
    FOR SELECT
    USING (
        is_active = TRUE 
        AND is_published = TRUE
        AND paper_id IN (SELECT id FROM public.papers WHERE published = TRUE)
    );

-- Admins can do everything
CREATE POLICY "Admins can manage question sets" ON public.question_sets
    FOR ALL
    USING (
        public.is_admin()
    );

-- ============================================================================
-- STEP 7: Validation function - Set cannot be published with 0 questions
-- ============================================================================
CREATE OR REPLACE FUNCTION validate_question_set_publish()
RETURNS TRIGGER AS $$
BEGIN
    -- Only check when publishing (is_published changing to TRUE)
    IF NEW.is_published = TRUE AND (OLD.is_published = FALSE OR OLD.is_published IS NULL) THEN
        -- Check if set has at least 1 question
        IF NEW.question_count = 0 THEN
            RAISE EXCEPTION 'Cannot publish question set with 0 questions. Set ID: %', NEW.id;
        END IF;
        
        -- For non-ATOMIC types, require context_body
        IF NEW.set_type != 'ATOMIC' AND (NEW.context_body IS NULL OR TRIM(NEW.context_body) = '') THEN
            RAISE EXCEPTION 'Cannot publish composite set without context body. Set ID: %', NEW.id;
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_validate_question_set_publish ON public.question_sets;
CREATE TRIGGER trg_validate_question_set_publish
BEFORE UPDATE ON public.question_sets
FOR EACH ROW
EXECUTE FUNCTION validate_question_set_publish();

-- ============================================================================
-- COMMENTS
-- ============================================================================
COMMENT ON TABLE public.question_sets IS 'Parent container for grouped questions (RC passages, DI sets, or atomic wrappers)';
COMMENT ON COLUMN public.question_sets.set_type IS 'VARC=Reading Comp, DILR=Data Interp, CASELET=Case Study, ATOMIC=Single Question';
COMMENT ON COLUMN public.question_sets.content_layout IS 'Rendering hint: split_passage, split_chart, single_focus, etc.';
COMMENT ON COLUMN public.question_sets.context_body IS 'The shared passage, chart description, or data for composite questions';
COMMENT ON COLUMN public.question_sets.metadata IS 'JSON with difficulty, topic, tags, source, estimated_time, etc.';
COMMENT ON COLUMN public.questions.set_id IS 'FK to parent question_set. NULL for legacy questions.';
COMMENT ON COLUMN public.questions.sequence_order IS 'Order of question within its set (1, 2, 3...)';
````

## File: docs/migrations/004_fetch_attempt_solutions.sql
````sql
-- =============================================================================
-- MILESTONE 6: Results Gating RPC (Step 0.95)
-- =============================================================================
-- Adds a SECURITY DEFINER RPC to safely return solution fields for completed attempts
-- EXECUTE IN SUPABASE SQL EDITOR
-- =============================================================================

-- Drop existing function to allow updates
DROP FUNCTION IF EXISTS public.fetch_attempt_solutions(uuid);

CREATE FUNCTION public.fetch_attempt_solutions(p_attempt_id uuid)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_attempt record;
BEGIN
    SELECT id, user_id, status, submitted_at, paper_id
    INTO v_attempt
    FROM public.attempts
    WHERE id = p_attempt_id;

    IF v_attempt.id IS NULL THEN
        RAISE EXCEPTION 'Attempt not found' USING ERRCODE = 'P0002';
    END IF;

    IF v_attempt.user_id <> auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized' USING ERRCODE = '42501';
    END IF;

    IF v_attempt.status NOT IN ('submitted', 'completed') OR v_attempt.submitted_at IS NULL THEN
        RAISE EXCEPTION 'Attempt not submitted' USING ERRCODE = '42501';
    END IF;

    RETURN (
        SELECT COALESCE(
            jsonb_agg(
                jsonb_build_object(
                    'question_id', q.id,
                    'correct_answer', q.correct_answer,
                    'solution_text', q.solution_text,
                    'solution_image_url', q.solution_image_url,
                    'video_solution_url', q.video_solution_url
                )
                ORDER BY q.section, q.question_number
            ),
            '[]'::jsonb
        )
        FROM public.questions q
        WHERE q.paper_id = v_attempt.paper_id
          AND q.is_active = true
    );
END;
$$;

REVOKE ALL ON FUNCTION public.fetch_attempt_solutions(uuid) FROM PUBLIC;
REVOKE ALL ON FUNCTION public.fetch_attempt_solutions(uuid) FROM anon;
GRANT EXECUTE ON FUNCTION public.fetch_attempt_solutions(uuid) TO authenticated;

-- =============================================================================
-- END OF MIGRATION
-- =============================================================================
````

## File: docs/migrations/005_attempt_state_lockdown.sql
````sql
-- =============================================================================
-- MIGRATION 005: Attempt State Lockdown (Phase B Step 2.25)
-- =============================================================================
-- Prevents direct PostgREST mutation of server-authoritative fields.
-- All progress updates must go through the save_attempt_state RPC.
-- EXECUTE IN SUPABASE SQL EDITOR
-- =============================================================================

-- =============================================================================
-- STEP 1: Revoke UPDATE on server-authoritative columns from authenticated
-- =============================================================================
-- These columns can only be modified via SECURITY DEFINER functions.

REVOKE UPDATE (time_remaining, current_section, current_question, 
               last_activity_at, session_token)
ON public.attempts FROM authenticated;

-- Note: status, submitted_at, completed_at are already protected by RLS policy
-- in 002_session_locking.sql that requires they remain unchanged on UPDATE.

-- =============================================================================
-- STEP 2: Create save_attempt_state RPC (SECURITY DEFINER)
-- =============================================================================
-- Server-side only function for updating attempt progress.
-- Validates ownership and prevents time inflation.

DROP FUNCTION IF EXISTS public.save_attempt_state(uuid, jsonb, text, int, timestamptz);

CREATE OR REPLACE FUNCTION public.save_attempt_state(
    p_attempt_id uuid,
    p_time_remaining jsonb,
    p_current_section text,
    p_current_question int,
    p_client_now timestamptz DEFAULT NOW()
)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_attempt record;
    v_stored_time_remaining jsonb;
    v_new_varc int;
    v_new_dilr int;
    v_new_qa int;
    v_stored_varc int;
    v_stored_dilr int;
    v_stored_qa int;
    v_tolerance int := 5; -- 5 second tolerance for network latency
BEGIN
    -- Fetch current attempt state
    SELECT id, user_id, status, time_remaining, started_at, paper_id
    INTO v_attempt
    FROM public.attempts
    WHERE id = p_attempt_id;

    -- Validate attempt exists
    IF v_attempt.id IS NULL THEN
        RAISE EXCEPTION 'Attempt not found' USING ERRCODE = 'P0002';
    END IF;

    -- Validate ownership
    IF v_attempt.user_id <> auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized' USING ERRCODE = '42501';
    END IF;

    -- Validate status
    IF v_attempt.status <> 'in_progress' THEN
        RAISE EXCEPTION 'Attempt is not in progress' USING ERRCODE = '42501';
    END IF;

    -- Extract time values
    v_stored_time_remaining := v_attempt.time_remaining;
    
    v_new_varc := COALESCE((p_time_remaining->>'VARC')::int, 0);
    v_new_dilr := COALESCE((p_time_remaining->>'DILR')::int, 0);
    v_new_qa := COALESCE((p_time_remaining->>'QA')::int, 0);
    
    v_stored_varc := COALESCE((v_stored_time_remaining->>'VARC')::int, 0);
    v_stored_dilr := COALESCE((v_stored_time_remaining->>'DILR')::int, 0);
    v_stored_qa := COALESCE((v_stored_time_remaining->>'QA')::int, 0);

    -- Validate time_remaining cannot increase beyond stored + tolerance
    IF v_new_varc > v_stored_varc + v_tolerance 
       OR v_new_dilr > v_stored_dilr + v_tolerance 
       OR v_new_qa > v_stored_qa + v_tolerance THEN
        RAISE EXCEPTION 'Invalid timer state: time cannot increase' USING ERRCODE = '42501';
    END IF;

    -- Clamp to valid bounds (0 to stored value)
    v_new_varc := GREATEST(0, LEAST(v_new_varc, v_stored_varc));
    v_new_dilr := GREATEST(0, LEAST(v_new_dilr, v_stored_dilr));
    v_new_qa := GREATEST(0, LEAST(v_new_qa, v_stored_qa));

    -- Update the attempt
    UPDATE public.attempts
    SET 
        time_remaining = jsonb_build_object(
            'VARC', v_new_varc,
            'DILR', v_new_dilr,
            'QA', v_new_qa
        ),
        current_section = p_current_section,
        current_question = p_current_question,
        last_activity_at = NOW()
    WHERE id = p_attempt_id;

    -- Return updated state
    RETURN jsonb_build_object(
        'attempt_id', p_attempt_id,
        'time_remaining', jsonb_build_object(
            'VARC', v_new_varc,
            'DILR', v_new_dilr,
            'QA', v_new_qa
        ),
        'current_section', p_current_section,
        'current_question', p_current_question,
        'last_activity_at', NOW()
    );
END;
$$;

-- Grant execute to authenticated users only
REVOKE ALL ON FUNCTION public.save_attempt_state(uuid, jsonb, text, int, timestamptz) FROM PUBLIC;
REVOKE ALL ON FUNCTION public.save_attempt_state(uuid, jsonb, text, int, timestamptz) FROM anon;
GRANT EXECUTE ON FUNCTION public.save_attempt_state(uuid, jsonb, text, int, timestamptz) TO authenticated;

-- =============================================================================
-- STEP 3: Create pause_exam_state RPC (SECURITY DEFINER)
-- =============================================================================
-- Dedicated RPC for pausing exams with server-calculated time.

DROP FUNCTION IF EXISTS public.pause_exam_state(uuid, text, int);

CREATE OR REPLACE FUNCTION public.pause_exam_state(
    p_attempt_id uuid,
    p_current_section text,
    p_current_question int
)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_attempt record;
    v_paper record;
    v_elapsed_seconds int;
    v_section_durations jsonb;
    v_varc_duration int;
    v_dilr_duration int;
    v_qa_duration int;
    v_remaining_elapsed int;
    v_calc_varc int;
    v_calc_dilr int;
    v_calc_qa int;
BEGIN
    -- Fetch attempt
    SELECT id, user_id, status, started_at, paper_id
    INTO v_attempt
    FROM public.attempts
    WHERE id = p_attempt_id;

    IF v_attempt.id IS NULL THEN
        RAISE EXCEPTION 'Attempt not found' USING ERRCODE = 'P0002';
    END IF;

    IF v_attempt.user_id <> auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized' USING ERRCODE = '42501';
    END IF;

    IF v_attempt.status <> 'in_progress' THEN
        RAISE EXCEPTION 'Attempt is not in progress' USING ERRCODE = '42501';
    END IF;

    -- Fetch paper to check allow_pause and get section durations
    SELECT id, allow_pause, sections
    INTO v_paper
    FROM public.papers
    WHERE id = v_attempt.paper_id;

    IF v_paper.id IS NULL THEN
        RAISE EXCEPTION 'Paper not found' USING ERRCODE = 'P0002';
    END IF;

    IF NOT COALESCE(v_paper.allow_pause, false) THEN
        RAISE EXCEPTION 'Pause is not allowed for this paper' USING ERRCODE = '42501';
    END IF;

    -- Calculate elapsed time
    v_elapsed_seconds := GREATEST(0, EXTRACT(EPOCH FROM (NOW() - v_attempt.started_at))::int);

    -- Get section durations (default 40 min = 2400 sec each)
    v_varc_duration := 2400;
    v_dilr_duration := 2400;
    v_qa_duration := 2400;

    IF v_paper.sections IS NOT NULL AND jsonb_array_length(v_paper.sections) > 0 THEN
        SELECT COALESCE((elem->>'time')::int * 60, 2400)
        INTO v_varc_duration
        FROM jsonb_array_elements(v_paper.sections) AS elem
        WHERE elem->>'name' = 'VARC'
        LIMIT 1;

        SELECT COALESCE((elem->>'time')::int * 60, 2400)
        INTO v_dilr_duration
        FROM jsonb_array_elements(v_paper.sections) AS elem
        WHERE elem->>'name' = 'DILR'
        LIMIT 1;

        SELECT COALESCE((elem->>'time')::int * 60, 2400)
        INTO v_qa_duration
        FROM jsonb_array_elements(v_paper.sections) AS elem
        WHERE elem->>'name' = 'QA'
        LIMIT 1;
    END IF;

    -- Calculate remaining time per section based on elapsed
    v_remaining_elapsed := v_elapsed_seconds;

    -- VARC
    IF v_remaining_elapsed >= v_varc_duration THEN
        v_calc_varc := 0;
        v_remaining_elapsed := v_remaining_elapsed - v_varc_duration;
    ELSE
        v_calc_varc := v_varc_duration - v_remaining_elapsed;
        v_remaining_elapsed := 0;
    END IF;

    -- DILR
    IF v_remaining_elapsed >= v_dilr_duration THEN
        v_calc_dilr := 0;
        v_remaining_elapsed := v_remaining_elapsed - v_dilr_duration;
    ELSE
        v_calc_dilr := v_dilr_duration - v_remaining_elapsed;
        v_remaining_elapsed := 0;
    END IF;

    -- QA
    IF v_remaining_elapsed >= v_qa_duration THEN
        v_calc_qa := 0;
    ELSE
        v_calc_qa := v_qa_duration - v_remaining_elapsed;
    END IF;

    -- Update attempt with server-calculated time
    UPDATE public.attempts
    SET 
        time_remaining = jsonb_build_object(
            'VARC', v_calc_varc,
            'DILR', v_calc_dilr,
            'QA', v_calc_qa
        ),
        current_section = p_current_section,
        current_question = p_current_question,
        last_activity_at = NOW()
    WHERE id = p_attempt_id;

    RETURN jsonb_build_object(
        'attempt_id', p_attempt_id,
        'time_remaining', jsonb_build_object(
            'VARC', v_calc_varc,
            'DILR', v_calc_dilr,
            'QA', v_calc_qa
        ),
        'current_section', p_current_section,
        'current_question', p_current_question,
        'paused_at', NOW()
    );
END;
$$;

REVOKE ALL ON FUNCTION public.pause_exam_state(uuid, text, int) FROM PUBLIC;
REVOKE ALL ON FUNCTION public.pause_exam_state(uuid, text, int) FROM anon;
GRANT EXECUTE ON FUNCTION public.pause_exam_state(uuid, text, int) TO authenticated;

-- =============================================================================
-- VERIFICATION QUERIES (run as authenticated user, not service role)
-- =============================================================================

-- TEST 1: Direct UPDATE on revoked columns should fail
-- UPDATE public.attempts SET time_remaining = '{"VARC": 9999}' WHERE id = '<attempt_id>';
-- Expected: ERROR permission denied for column time_remaining

-- TEST 2: RPC should work for attempt owner
-- SELECT public.save_attempt_state('<attempt_id>', '{"VARC": 1000, "DILR": 2000, "QA": 2400}', 'VARC', 1, NOW());
-- Expected: SUCCESS with updated state

-- TEST 3: RPC should reject time inflation
-- SELECT public.save_attempt_state('<attempt_id>', '{"VARC": 9999, "DILR": 9999, "QA": 9999}', 'VARC', 1, NOW());
-- Expected: ERROR Invalid timer state: time cannot increase

-- TEST 4: pause_exam_state should work for papers with allow_pause=true
-- SELECT public.pause_exam_state('<attempt_id>', 'VARC', 1);
-- Expected: SUCCESS with server-calculated time

-- =============================================================================
-- END OF MIGRATION
-- =============================================================================
````

## File: docs/migrations/006_force_resume_session.sql
````sql
-- ============================================================================
-- Migration: Force Resume Exam Session (SECURITY DEFINER)
-- @blueprint Security Audit - P0 Fix - Session Locking Compatibility
-- ============================================================================
-- Purpose: Allow server-authoritative session token rotation for force-resume
-- ============================================================================

CREATE OR REPLACE FUNCTION force_resume_exam_session(
    p_attempt_id UUID,
    p_new_session_token UUID
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_user_id UUID;
    v_status TEXT;
    v_last_activity TIMESTAMPTZ;
    v_stale_threshold INTERVAL := INTERVAL '5 minutes';
BEGIN
    SELECT user_id, status, last_activity_at
    INTO v_user_id, v_status, v_last_activity
    FROM attempts
    WHERE id = p_attempt_id;

    IF v_user_id IS NULL OR v_user_id != auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized';
    END IF;

    IF v_status != 'in_progress' THEN
        RAISE EXCEPTION 'Attempt is not in progress';
    END IF;

    IF v_last_activity IS NULL OR v_last_activity < NOW() - v_stale_threshold THEN
        RAISE EXCEPTION 'FORCE_RESUME_STALE';
    END IF;

    UPDATE attempts
    SET session_token = p_new_session_token,
        last_activity_at = NOW()
    WHERE id = p_attempt_id;

    RETURN TRUE;
END;
$$;

GRANT EXECUTE ON FUNCTION force_resume_exam_session(UUID, UUID) TO authenticated;

-- ============================================================================
-- Rollback (if needed)
-- DROP FUNCTION IF EXISTS force_resume_exam_session(UUID, UUID);
-- ============================================================================
````

## File: docs/migrations/006_response_flags.sql
````sql
-- =============================================================================
-- MIGRATION 006: Response Flags (Mark for Review + Visited)
-- =============================================================================
-- Adds is_marked_for_review and is_visited flags to responses for TCS ION palette
-- EXECUTE IN SUPABASE SQL EDITOR
-- =============================================================================

ALTER TABLE public.responses 
ADD COLUMN IF NOT EXISTS is_marked_for_review BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS is_visited BOOLEAN DEFAULT FALSE;

-- =============================================================================
-- END OF MIGRATION
-- =============================================================================
````

## File: docs/migrations/007_content_ingestion_phases.sql
````sql
-- ============================================================================
-- MIGRATION: Content Ingestion Phases (0, 1, 2)
-- ============================================================================
-- Purpose: Implement robust export/import system with versioning
-- 
-- Phase 0: Export assembler function (export_paper_json)
-- Phase 1: Schema hardening (context types, question taxonomy)
-- Phase 2: Versioned ingestion tracking (paper_ingest_runs)
-- ============================================================================

-- ============================================================================
-- PHASE 0: EXPORT ASSEMBLER FUNCTION
-- ============================================================================
-- Creates a SQL function that assembles a complete paper JSON from normalized tables
-- Returns JSON matching docs/CONTENT-SCHEMA.md format
CREATE OR REPLACE FUNCTION public.export_paper_json(p_paper_id uuid)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_paper RECORD;
    v_result jsonb;
    v_contexts jsonb;
    v_questions jsonb;
BEGIN
    -- Fetch paper metadata
    SELECT * INTO v_paper
    FROM public.papers
    WHERE id = p_paper_id;

    IF NOT FOUND THEN
        RETURN jsonb_build_object('error', 'Paper not found', 'paper_id', p_paper_id);
    END IF;

    -- Build contexts array (from question_contexts)
    -- Ordered by section (VARC, DILR, QA) then display_order for determinism
    SELECT COALESCE(
        jsonb_agg(
            jsonb_build_object(
                'id', qc.id,
                'section', qc.section,
                'context_type', qc.context_type,
                'title', qc.title,
                'content', qc.content,
                'image_url', qc.image_url,
                'display_order', qc.display_order
            )
            ORDER BY 
                CASE qc.section 
                    WHEN 'VARC' THEN 1 
                    WHEN 'DILR' THEN 2 
                    WHEN 'QA' THEN 3 
                END,
                qc.display_order,
                qc.id
        ),
        '[]'::jsonb
    ) INTO v_contexts
    FROM public.question_contexts qc
    WHERE qc.paper_id = p_paper_id
      AND qc.is_active = TRUE;

    -- Build questions array
    -- Ordered by section, then question_number for determinism
    SELECT COALESCE(
        jsonb_agg(
            jsonb_build_object(
                'id', q.id,
                'section', q.section,
                'question_number', q.question_number,
                'question_text', q.question_text,
                'question_type', q.question_type,
                'question_format', COALESCE(q.question_format, q.question_type),
                'taxonomy_type', q.taxonomy_type,
                'topic_tag', q.topic_tag,
                'difficulty_rationale', q.difficulty_rationale,
                'options', q.options,
                'correct_answer', q.correct_answer,
                'positive_marks', q.positive_marks,
                'negative_marks', q.negative_marks,
                'difficulty', q.difficulty,
                'topic', q.topic,
                'subtopic', q.subtopic,
                'solution_text', q.solution_text,
                'solution_image_url', q.solution_image_url,
                'video_solution_url', q.video_solution_url,
                'context_id', COALESCE(q.context_id, q.set_id),
                'sequence_order', q.sequence_order
            )
            ORDER BY 
                CASE q.section 
                    WHEN 'VARC' THEN 1 
                    WHEN 'DILR' THEN 2 
                    WHEN 'QA' THEN 3 
                END,
                q.question_number
        ),
        '[]'::jsonb
    ) INTO v_questions
    FROM public.questions q
    WHERE q.paper_id = p_paper_id
      AND q.is_active = TRUE;

    -- Build final result
    v_result := jsonb_build_object(
        'schema_version', 'v1.0',
        'exported_at', NOW(),
        'paper', jsonb_build_object(
            'id', v_paper.id,
            'slug', v_paper.slug,
            'title', v_paper.title,
            'description', v_paper.description,
            'year', v_paper.year,
            'total_questions', v_paper.total_questions,
            'total_marks', v_paper.total_marks,
            'duration_minutes', v_paper.duration_minutes,
            'sections', v_paper.sections,
            'default_positive_marks', v_paper.default_positive_marks,
            'default_negative_marks', v_paper.default_negative_marks,
            'difficulty_level', v_paper.difficulty_level,
            'is_free', v_paper.is_free,
            'published', v_paper.published,
            'available_from', v_paper.available_from,
            'available_until', v_paper.available_until,
            'allow_pause', v_paper.allow_pause,
            'attempt_limit', v_paper.attempt_limit,
            'created_at', v_paper.created_at,
            'updated_at', v_paper.updated_at
        ),
        'contexts', v_contexts,
        'questions', v_questions
    );

    RETURN v_result;
END;
$$;

-- Grant execute permission to authenticated users (admin check happens in API layer)
GRANT EXECUTE ON FUNCTION public.export_paper_json(uuid) TO authenticated;
GRANT EXECUTE ON FUNCTION public.export_paper_json(uuid) TO service_role;

COMMENT ON FUNCTION public.export_paper_json IS 'Assembles complete paper JSON from normalized tables. Returns JSON matching CONTENT-SCHEMA.md format.';

-- ============================================================================
-- PHASE 1.1: CONTEXT TYPE ENUM EXPANSION
-- ============================================================================
-- Expand context_type to include: rc_passage, dilr_set, caselet, data_table, graph, other_shared_stimulus

-- Note: We use set_type on question_sets, but add a context_type column for explicit categorization
-- First, add the context_type column if it doesn't exist
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_schema = 'public' 
        AND table_name = 'question_sets' 
        AND column_name = 'context_type'
    ) THEN
        ALTER TABLE public.question_sets 
        ADD COLUMN context_type TEXT;
    END IF;
END $$;

-- Add CHECK constraint for valid context types
ALTER TABLE public.question_sets 
DROP CONSTRAINT IF EXISTS question_sets_context_type_check;

ALTER TABLE public.question_sets
ADD CONSTRAINT question_sets_context_type_check 
CHECK (context_type IS NULL OR context_type IN (
    'rc_passage',           -- VARC reading comprehension passages
    'dilr_set',             -- DILR data/logical reasoning sets
    'caselet',              -- Case-based scenarios
    'data_table',           -- Explicit data tables
    'graph',                -- Charts, graphs, diagrams
    'other_shared_stimulus' -- Catch-all for other shared content
));

-- Migrate existing set_type to context_type where NULL
UPDATE public.question_sets
SET context_type = CASE set_type
    WHEN 'VARC' THEN 'rc_passage'
    WHEN 'DILR' THEN 'dilr_set'
    WHEN 'CASELET' THEN 'caselet'
    ELSE NULL
END
WHERE context_type IS NULL AND set_type != 'ATOMIC';

COMMENT ON COLUMN public.question_sets.context_type IS 'Explicit context categorization: rc_passage, dilr_set, caselet, data_table, graph, other_shared_stimulus';

-- ============================================================================
-- PHASE 1.2: QUESTION TAXONOMY COLUMNS
-- ============================================================================
-- Add question_format (MCQ|TITA) to separate from question_type (taxonomy)
-- Add topic_tag and difficulty_rationale columns

-- Add question_format column (MCQ or TITA)
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_schema = 'public' 
        AND table_name = 'questions' 
        AND column_name = 'question_format'
    ) THEN
        ALTER TABLE public.questions 
        ADD COLUMN question_format TEXT;
    END IF;
END $$;

-- Add CHECK constraint for question_format
ALTER TABLE public.questions 
DROP CONSTRAINT IF EXISTS questions_question_format_check;

ALTER TABLE public.questions
ADD CONSTRAINT questions_question_format_check 
CHECK (question_format IS NULL OR question_format IN ('MCQ', 'TITA'));

-- Add taxonomy_type column (the semantic question type like rc_inference, para_summary, etc.)
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_schema = 'public' 
        AND table_name = 'questions' 
        AND column_name = 'taxonomy_type'
    ) THEN
        ALTER TABLE public.questions 
        ADD COLUMN taxonomy_type TEXT;
    END IF;
END $$;

-- Add topic_tag column (finer-grained categorization)
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_schema = 'public' 
        AND table_name = 'questions' 
        AND column_name = 'topic_tag'
    ) THEN
        ALTER TABLE public.questions 
        ADD COLUMN topic_tag TEXT;
    END IF;
END $$;

-- Add difficulty_rationale column (explanation for difficulty rating)
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_schema = 'public' 
        AND table_name = 'questions' 
        AND column_name = 'difficulty_rationale'
    ) THEN
        ALTER TABLE public.questions 
        ADD COLUMN difficulty_rationale TEXT;
    END IF;
END $$;

-- Migrate existing question_type to question_format
UPDATE public.questions
SET question_format = question_type
WHERE question_format IS NULL AND question_type IN ('MCQ', 'TITA');

COMMENT ON COLUMN public.questions.question_format IS 'Answer format: MCQ or TITA (replaces old question_type semantics)';
COMMENT ON COLUMN public.questions.taxonomy_type IS 'Question taxonomy: rc_inference, para_summary, di_table_analysis, geometry_triangles, etc.';
COMMENT ON COLUMN public.questions.topic_tag IS 'Fine-grained topic tag for categorization and analytics';
COMMENT ON COLUMN public.questions.difficulty_rationale IS 'Optional explanation for the difficulty rating';

-- ============================================================================
-- PHASE 1.3: PARA SUMMARY CONSTRAINT
-- ============================================================================
-- Enforce: If taxonomy_type = 'para_summary' then set_id (context reference) must be NULL
-- Para summary questions should have their content in question_text, not as a shared context

CREATE OR REPLACE FUNCTION public.validate_para_summary_no_context()
RETURNS TRIGGER AS $$
BEGIN
    -- If taxonomy_type is para_summary, context (set_id) must be NULL
    -- Exception: ATOMIC sets are fine (they're just wrappers)
    IF NEW.taxonomy_type = 'para_summary' AND NEW.set_id IS NOT NULL THEN
        -- Check if the set is ATOMIC (wrapper) - that's allowed
        PERFORM 1 FROM public.question_sets 
        WHERE id = NEW.set_id AND set_type = 'ATOMIC';
        
        IF NOT FOUND THEN
            RAISE EXCEPTION 'Para Summary questions must not reference a shared context. The paragraph belongs in question_text, not context_body. Question ID: %', NEW.id;
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_validate_para_summary ON public.questions;
CREATE TRIGGER trg_validate_para_summary
BEFORE INSERT OR UPDATE ON public.questions
FOR EACH ROW
EXECUTE FUNCTION public.validate_para_summary_no_context();

COMMENT ON FUNCTION public.validate_para_summary_no_context IS 'Enforces rule: Para Summary questions must have paragraph in question_text, not as shared context';

-- ============================================================================
-- PHASE 2.1: PAPER INGEST RUNS TABLE (Versioning)
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.paper_ingest_runs (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    paper_id UUID REFERENCES public.papers(id) ON DELETE CASCADE NOT NULL,
    
    -- Version tracking
    schema_version TEXT NOT NULL DEFAULT 'v1.0',
    version_number INTEGER NOT NULL DEFAULT 1,
    
    -- Source tracking
    raw_source_text TEXT,                    -- Original raw input (optional, for debugging)
    raw_source_hash TEXT,                    -- SHA256 hash of raw_source_text
    
    -- Canonical JSON snapshot
    canonical_paper_json JSONB NOT NULL,     -- The exact JSON that was imported
    canonical_json_hash TEXT NOT NULL,       -- SHA256 hash for deduplication
    
    -- Audit
    created_by UUID REFERENCES auth.users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    
    -- Notes
    import_notes TEXT,                       -- Optional notes about this import
    
    -- Ensure unique version numbers per paper
    UNIQUE(paper_id, version_number)
);

DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name = 'paper_ingest_runs'
          AND column_name = 'schema_version'
    ) THEN
        ALTER TABLE public.paper_ingest_runs ADD COLUMN schema_version TEXT NOT NULL DEFAULT 'v1.0';
    END IF;
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name = 'paper_ingest_runs'
          AND column_name = 'version_number'
    ) THEN
        ALTER TABLE public.paper_ingest_runs ADD COLUMN version_number INTEGER NOT NULL DEFAULT 1;
    END IF;
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name = 'paper_ingest_runs'
          AND column_name = 'raw_source_text'
    ) THEN
        ALTER TABLE public.paper_ingest_runs ADD COLUMN raw_source_text TEXT;
    END IF;
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name = 'paper_ingest_runs'
          AND column_name = 'raw_source_hash'
    ) THEN
        ALTER TABLE public.paper_ingest_runs ADD COLUMN raw_source_hash TEXT;
    END IF;
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name = 'paper_ingest_runs'
          AND column_name = 'canonical_paper_json'
    ) THEN
        ALTER TABLE public.paper_ingest_runs ADD COLUMN canonical_paper_json JSONB;
        ALTER TABLE public.paper_ingest_runs ALTER COLUMN canonical_paper_json SET NOT NULL;
    END IF;
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name = 'paper_ingest_runs'
          AND column_name = 'canonical_json_hash'
    ) THEN
        ALTER TABLE public.paper_ingest_runs ADD COLUMN canonical_json_hash TEXT;
        ALTER TABLE public.paper_ingest_runs ALTER COLUMN canonical_json_hash SET NOT NULL;
    END IF;
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name = 'paper_ingest_runs'
          AND column_name = 'created_by'
    ) THEN
        ALTER TABLE public.paper_ingest_runs ADD COLUMN created_by UUID REFERENCES auth.users(id);
    END IF;
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name = 'paper_ingest_runs'
          AND column_name = 'created_at'
    ) THEN
        ALTER TABLE public.paper_ingest_runs ADD COLUMN created_at TIMESTAMPTZ NOT NULL DEFAULT TIMEZONE('utc'::text, NOW());
    END IF;
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name = 'paper_ingest_runs'
          AND column_name = 'import_notes'
    ) THEN
        ALTER TABLE public.paper_ingest_runs ADD COLUMN import_notes TEXT;
    END IF;
END $$;

DO $$
DECLARE
    v_table oid;
    v_paper_id_attnum int;
    v_version_num_attnum int;
BEGIN
    SELECT c.oid INTO v_table
    FROM pg_class c
    JOIN pg_namespace n ON n.oid = c.relnamespace
    WHERE n.nspname = 'public' AND c.relname = 'paper_ingest_runs';

    SELECT attnum INTO v_paper_id_attnum
    FROM pg_attribute WHERE attrelid = v_table AND attname = 'paper_id';

    SELECT attnum INTO v_version_num_attnum
    FROM pg_attribute WHERE attrelid = v_table AND attname = 'version_number';

    IF NOT EXISTS (
        SELECT 1
        FROM pg_constraint c
        WHERE c.conrelid = v_table
          AND c.contype = 'u'
          AND c.conkey = ARRAY[v_paper_id_attnum::smallint, v_version_num_attnum::smallint]
    ) THEN
        ALTER TABLE public.paper_ingest_runs
        ADD CONSTRAINT paper_ingest_runs_paper_version_unique UNIQUE (paper_id, version_number);
    END IF;
END $$;

-- Index for efficient lookups
CREATE INDEX IF NOT EXISTS idx_paper_ingest_runs_paper_id ON public.paper_ingest_runs(paper_id, version_number DESC);
CREATE INDEX IF NOT EXISTS idx_paper_ingest_runs_hash ON public.paper_ingest_runs(canonical_json_hash);

-- Add latest_ingest_run_id to papers table
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_schema = 'public' 
        AND table_name = 'papers' 
        AND column_name = 'latest_ingest_run_id'
    ) THEN
        ALTER TABLE public.papers 
        ADD COLUMN latest_ingest_run_id UUID REFERENCES public.paper_ingest_runs(id);
    END IF;
END $$;

COMMENT ON TABLE public.paper_ingest_runs IS 'Stores versioned snapshots of imported paper JSON for audit and re-export';
COMMENT ON COLUMN public.paper_ingest_runs.canonical_paper_json IS 'Exact JSON as imported - used for export to recreate original';
COMMENT ON COLUMN public.paper_ingest_runs.canonical_json_hash IS 'SHA256 hash for detecting duplicate imports';
COMMENT ON COLUMN public.papers.latest_ingest_run_id IS 'Pointer to the most recent ingest run for quick export';

-- RLS for paper_ingest_runs
ALTER TABLE public.paper_ingest_runs ENABLE ROW LEVEL SECURITY;

DO $$
BEGIN
    IF EXISTS (
        SELECT 1
        FROM pg_policies
        WHERE schemaname = 'public'
          AND tablename = 'paper_ingest_runs'
          AND policyname = 'Admins can manage ingest runs'
    ) THEN
        ALTER POLICY "Admins can manage ingest runs" ON public.paper_ingest_runs
            USING (public.is_admin())
            WITH CHECK (public.is_admin());
    ELSE
        CREATE POLICY "Admins can manage ingest runs" ON public.paper_ingest_runs
            FOR ALL
            USING (public.is_admin())
            WITH CHECK (public.is_admin());
    END IF;
END $$;

-- ============================================================================
-- PHASE 2.2: Helper function to get next version number
-- ============================================================================

CREATE OR REPLACE FUNCTION public.get_next_paper_version(p_paper_id uuid)
RETURNS INTEGER
LANGUAGE plpgsql
AS $$
DECLARE
    v_next_version INTEGER;
BEGIN
    SELECT COALESCE(MAX(version_number), 0) + 1 INTO v_next_version
    FROM public.paper_ingest_runs
    WHERE paper_id = p_paper_id;
    
    RETURN v_next_version;
END;
$$;

-- ============================================================================
-- PHASE 2.3: Function to check if import would be duplicate
-- ============================================================================

CREATE OR REPLACE FUNCTION public.check_import_duplicate(p_paper_id uuid, p_json_hash text)
RETURNS TABLE(is_duplicate boolean, existing_run_id uuid, existing_version integer)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        TRUE as is_duplicate,
        pir.id as existing_run_id,
        pir.version_number as existing_version
    FROM public.paper_ingest_runs pir
    WHERE pir.paper_id = p_paper_id
      AND pir.canonical_json_hash = p_json_hash
    ORDER BY pir.version_number DESC
    LIMIT 1;
    
    -- If no rows returned, return is_duplicate = FALSE
    IF NOT FOUND THEN
        RETURN QUERY SELECT FALSE, NULL::uuid, NULL::integer;
    END IF;
END;
$$;

-- ============================================================================
-- PHASE 2.4: Updated export function that prefers canonical snapshot
-- ============================================================================
CREATE OR REPLACE FUNCTION public.export_paper_json_versioned(
    p_paper_id uuid,
    p_ingest_run_id uuid DEFAULT NULL
)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_canonical_json jsonb;
    v_run_id uuid;
BEGIN
    -- If specific run_id provided, use that
    IF p_ingest_run_id IS NOT NULL THEN
        SELECT canonical_paper_json INTO v_canonical_json
        FROM public.paper_ingest_runs
        WHERE id = p_ingest_run_id AND paper_id = p_paper_id;
        
        IF FOUND THEN
            RETURN v_canonical_json || jsonb_build_object('_ingest_run_id', p_ingest_run_id);
        END IF;
    END IF;
    
    -- Try to get latest ingest run
    SELECT pir.id, pir.canonical_paper_json INTO v_run_id, v_canonical_json
    FROM public.papers p
    LEFT JOIN public.paper_ingest_runs pir ON p.latest_ingest_run_id = pir.id
    WHERE p.id = p_paper_id;
    
    IF v_canonical_json IS NOT NULL THEN
        RETURN v_canonical_json || jsonb_build_object('_ingest_run_id', v_run_id);
    END IF;
    
    -- Fallback: assemble from current database state
    RETURN public.export_paper_json(p_paper_id) || jsonb_build_object(
        '_assembled_from_db', TRUE,
        '_note', 'No canonical snapshot found, assembled from current database state'
    );
END;
$$;

GRANT EXECUTE ON FUNCTION public.export_paper_json_versioned(uuid, uuid) TO authenticated;
GRANT EXECUTE ON FUNCTION public.export_paper_json_versioned(uuid, uuid) TO service_role;

COMMENT ON FUNCTION public.export_paper_json_versioned IS 'Export paper JSON, preferring canonical snapshot from ingest run if available';

-- ============================================================================
-- SUMMARY
-- ============================================================================
-- 
-- Phase 0 Complete:
--   ✓ export_paper_json(paper_id) - assembles paper from normalized tables
--   ✓ Deterministic ordering (section, then display_order/question_number)
--
-- Phase 1 Complete:
--   ✓ context_type column on question_sets with expanded enum
--   ✓ question_format (MCQ|TITA) separate from taxonomy_type
--   ✓ topic_tag and difficulty_rationale columns
--   ✓ Trigger to prevent para_summary questions from having shared context
--
-- Phase 2 Complete:
--   ✓ paper_ingest_runs table for version tracking
--   ✓ canonical_paper_json storage with hash deduplication
--   ✓ export_paper_json_versioned() prefers canonical snapshot
--   ✓ Helper functions for version management
--
-- ============================================================================
````

## File: docs/migrations/008_ingestion_semantic_keys.sql
````sql
-- ==============================================================================
-- Migration 008: Semantic Keys for Content Ingestion (Upsert Support)
-- ==============================================================================
-- Purpose: Add semantic keys to enable idempotent imports via upserts
-- Author: System
-- Date: 2025-01-XX
-- Dependencies: 007_content_ingestion_phases.sql
-- 
-- This migration adds:
--   1. papers.paper_key (unique business key for papers)
--   2. question_sets.client_set_id (unique per paper)
--   3. questions.client_question_id (unique per paper)
--   4. Composite unique indexes for upsert operations
--   5. Upsert-enabled import functions
-- ==============================================================================

-- ============================================================================
-- STEP 1: Add Semantic Key Columns (Safe if they exist)
-- ============================================================================

-- papers.paper_key - Global unique identifier for papers (e.g., "cat-2024-slot-1")
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'papers' AND column_name = 'paper_key'
    ) THEN
        ALTER TABLE papers ADD COLUMN paper_key TEXT;
        COMMENT ON COLUMN papers.paper_key IS 'Unique business key for the paper (e.g., cat-2024-slot-1). Used for upserts.';
    END IF;
END $$;

-- question_sets.client_set_id - Unique within a paper (e.g., "VARC_RC_1", "ATOMIC_QA_45")
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'question_sets' AND column_name = 'client_set_id'
    ) THEN
        ALTER TABLE question_sets ADD COLUMN client_set_id TEXT;
        COMMENT ON COLUMN question_sets.client_set_id IS 'Client-provided unique ID within paper (e.g., VARC_RC_1). Used for v3 imports.';
    END IF;
END $$;

-- questions.client_question_id - Unique within a paper (e.g., "Q1", "Q2")
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'questions' AND column_name = 'client_question_id'
    ) THEN
        ALTER TABLE questions ADD COLUMN client_question_id TEXT;
        COMMENT ON COLUMN questions.client_question_id IS 'Client-provided unique ID within paper (e.g., Q1, Q2). Used for v3 imports.';
    END IF;
END $$;

-- ============================================================================
-- STEP 2: Create Unique Indexes for Upsert Support
-- ============================================================================

-- papers.paper_key must be globally unique
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'papers_paper_key_unique'
    ) THEN
        CREATE UNIQUE INDEX papers_paper_key_unique ON papers (paper_key) WHERE paper_key IS NOT NULL;
    END IF;
END $$;

-- question_sets.client_set_id must be unique within a paper
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'question_sets_paper_client_set_id_unique'
    ) THEN
        CREATE UNIQUE INDEX question_sets_paper_client_set_id_unique 
            ON question_sets (paper_id, client_set_id) 
            WHERE client_set_id IS NOT NULL;
    END IF;
END $$;

-- questions.client_question_id must be unique within a paper
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'questions_paper_client_question_id_unique'
    ) THEN
        -- Deferred until after backfill to avoid duplicate conflicts
        NULL;
    END IF;
END $$;


-- ============================================================================
-- STEP 3: Backfill Existing Records with Semantic Keys
-- ============================================================================

-- Backfill papers.paper_key from slug (if not already set)
UPDATE papers 
SET paper_key = slug 
WHERE paper_key IS NULL AND slug IS NOT NULL;

-- Backfill question_sets.client_set_id using set_type + ROW_NUMBER within paper
-- This ensures uniqueness even when multiple sets have same display_order
WITH numbered_sets AS (
    SELECT 
        id,
        UPPER(set_type) || '_' || LPAD(ROW_NUMBER() OVER (
            PARTITION BY paper_id 
            ORDER BY 
                CASE section WHEN 'VARC' THEN 1 WHEN 'DILR' THEN 2 WHEN 'QA' THEN 3 END,
                display_order,
                created_at,
                id
        )::TEXT, 3, '0') AS new_client_set_id
    FROM question_sets
    WHERE client_set_id IS NULL
)
UPDATE question_sets qs
SET client_set_id = ns.new_client_set_id
FROM numbered_sets ns
WHERE qs.id = ns.id;

-- Backfill questions.client_question_id using "Q" + question_number
WITH question_ids AS (
    SELECT
        id,
        paper_id,
        client_question_id,
        row_number() OVER (
            PARTITION BY paper_id
            ORDER BY question_number, created_at, id
        ) AS seq,
        row_number() OVER (
            PARTITION BY paper_id, COALESCE(client_question_id, '__NULL__')
            ORDER BY question_number, created_at, id
        ) AS rn,
        count(*) OVER (
            PARTITION BY paper_id, COALESCE(client_question_id, '__NULL__')
        ) AS cnt
    FROM questions
)
UPDATE questions q
SET client_question_id = CASE
    WHEN q.client_question_id IS NULL THEN 'Q' || LPAD(qi.seq::TEXT, 3, '0')
    WHEN qi.cnt > 1 THEN q.client_question_id || '_' || qi.rn::TEXT
    ELSE q.client_question_id
END
FROM question_ids qi
WHERE q.id = qi.id
  AND (q.client_question_id IS NULL OR qi.cnt > 1);

-- Now create unique index for questions after backfill
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'questions_paper_client_question_id_unique'
    ) THEN
        CREATE UNIQUE INDEX questions_paper_client_question_id_unique 
            ON questions (paper_id, client_question_id) 
            WHERE client_question_id IS NOT NULL;
    END IF;
END $$;


-- ============================================================================
-- STEP 4: Upsert Functions for v3 Importer
-- ============================================================================

-- Upsert a question_set by (paper_id, client_set_id)
CREATE OR REPLACE FUNCTION upsert_question_set(
    p_paper_id UUID,
    p_client_set_id TEXT,
    p_section TEXT,
    p_set_type TEXT,
    p_context_type TEXT DEFAULT NULL,
    p_content_layout TEXT DEFAULT 'text_only',
    p_context_title TEXT DEFAULT NULL,
    p_context_body TEXT DEFAULT NULL,
    p_context_image_url TEXT DEFAULT NULL,
    p_context_additional_images JSONB DEFAULT NULL,
    p_display_order INT DEFAULT 0,
    p_is_active BOOLEAN DEFAULT TRUE,
    p_metadata JSONB DEFAULT '{}'::JSONB
) RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_set_id UUID;
BEGIN
    -- Try update first
    UPDATE question_sets SET
        section = p_section,
        set_type = p_set_type,
        context_type = p_context_type,
        content_layout = p_content_layout,
        context_title = p_context_title,
        context_body = p_context_body,
        context_image_url = p_context_image_url,
        context_additional_images = p_context_additional_images,
        display_order = p_display_order,
        is_active = p_is_active,
        metadata = p_metadata,
        updated_at = NOW()
    WHERE paper_id = p_paper_id AND client_set_id = p_client_set_id
    RETURNING id INTO v_set_id;
    
    -- If no update, insert
    IF v_set_id IS NULL THEN
        INSERT INTO question_sets (
            id, paper_id, client_set_id, section, set_type, context_type,
            content_layout, context_title, context_body, context_image_url,
            context_additional_images, display_order, is_active, metadata
        ) VALUES (
            gen_random_uuid(), p_paper_id, p_client_set_id, p_section, p_set_type, p_context_type,
            p_content_layout, p_context_title, p_context_body, p_context_image_url,
            p_context_additional_images, p_display_order, p_is_active, p_metadata
        )
        RETURNING id INTO v_set_id;
    END IF;
    
    RETURN v_set_id;
END;
$$;

-- Upsert a question by (paper_id, client_question_id)
CREATE OR REPLACE FUNCTION upsert_question(
    p_paper_id UUID,
    p_client_question_id TEXT,
    p_set_id UUID,
    p_section TEXT,
    p_question_number INT,
    p_sequence_order INT,
    p_question_text TEXT,
    p_question_type TEXT,
    p_question_format TEXT DEFAULT NULL,
    p_taxonomy_type TEXT DEFAULT NULL,
    p_topic_tag TEXT DEFAULT NULL,
    p_difficulty_rationale TEXT DEFAULT NULL,
    p_options JSONB DEFAULT NULL,
    p_correct_answer TEXT DEFAULT NULL,
    p_positive_marks NUMERIC DEFAULT 3.0,
    p_negative_marks NUMERIC DEFAULT 1.0,
    p_difficulty TEXT DEFAULT NULL,
    p_topic TEXT DEFAULT NULL,
    p_subtopic TEXT DEFAULT NULL,
    p_solution_text TEXT DEFAULT NULL,
    p_solution_image_url TEXT DEFAULT NULL,
    p_video_solution_url TEXT DEFAULT NULL
) RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_question_id UUID;
BEGIN
    -- Try update first
    UPDATE questions SET
        set_id = p_set_id,
        section = p_section,
        question_number = p_question_number,
        sequence_order = p_sequence_order,
        question_text = p_question_text,
        question_type = p_question_type,
        question_format = COALESCE(p_question_format, p_question_type),
        taxonomy_type = p_taxonomy_type,
        topic_tag = p_topic_tag,
        difficulty_rationale = p_difficulty_rationale,
        options = p_options,
        correct_answer = p_correct_answer,
        positive_marks = p_positive_marks,
        negative_marks = p_negative_marks,
        difficulty = p_difficulty,
        topic = p_topic,
        subtopic = p_subtopic,
        solution_text = p_solution_text,
        solution_image_url = p_solution_image_url,
        video_solution_url = p_video_solution_url,
        updated_at = NOW()
    WHERE paper_id = p_paper_id AND client_question_id = p_client_question_id
    RETURNING id INTO v_question_id;
    
    -- If no update, insert
    IF v_question_id IS NULL THEN
        INSERT INTO questions (
            id, paper_id, client_question_id, set_id, section, question_number,
            sequence_order, question_text, question_type, question_format,
            taxonomy_type, topic_tag, difficulty_rationale, options, correct_answer,
            positive_marks, negative_marks, difficulty, topic, subtopic,
            solution_text, solution_image_url, video_solution_url
        ) VALUES (
            gen_random_uuid(), p_paper_id, p_client_question_id, p_set_id, p_section, p_question_number,
            p_sequence_order, p_question_text, p_question_type, COALESCE(p_question_format, p_question_type),
            p_taxonomy_type, p_topic_tag, p_difficulty_rationale, p_options, p_correct_answer,
            p_positive_marks, p_negative_marks, p_difficulty, p_topic, p_subtopic,
            p_solution_text, p_solution_image_url, p_video_solution_url
        )
        RETURNING id INTO v_question_id;
    END IF;
    
    RETURN v_question_id;
END;
$$;


-- ============================================================================
-- STEP 5: Lookup Functions for Semantic Keys
-- ============================================================================

-- Get question_set.id by (paper_id, client_set_id)
CREATE OR REPLACE FUNCTION get_set_id_by_client_id(
    p_paper_id UUID,
    p_client_set_id TEXT
) RETURNS UUID
LANGUAGE sql
STABLE
AS $$
    SELECT id FROM question_sets 
    WHERE paper_id = p_paper_id AND client_set_id = p_client_set_id;
$$;

-- Get question.id by (paper_id, client_question_id)
CREATE OR REPLACE FUNCTION get_question_id_by_client_id(
    p_paper_id UUID,
    p_client_question_id TEXT
) RETURNS UUID
LANGUAGE sql
STABLE
AS $$
    SELECT id FROM questions 
    WHERE paper_id = p_paper_id AND client_question_id = p_client_question_id;
$$;


-- ============================================================================
-- STEP 6: Grant Permissions
-- ============================================================================

GRANT EXECUTE ON FUNCTION upsert_question_set TO service_role;
GRANT EXECUTE ON FUNCTION upsert_question TO service_role;
GRANT EXECUTE ON FUNCTION get_set_id_by_client_id TO service_role;
GRANT EXECUTE ON FUNCTION get_question_id_by_client_id TO service_role;


-- ============================================================================
-- STEP 7: V3 Export Function (Sets-First Format)
-- ============================================================================
-- Export function that outputs Schema v3.0 format for content creation context

CREATE OR REPLACE FUNCTION public.export_paper_json_v3(p_paper_id uuid)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_paper RECORD;
    v_result jsonb;
    v_question_sets jsonb;
    v_questions jsonb;
BEGIN
    -- Fetch paper metadata
    SELECT * INTO v_paper
    FROM public.papers
    WHERE id = p_paper_id;

    IF NOT FOUND THEN
        RETURN jsonb_build_object('error', 'Paper not found', 'paper_id', p_paper_id);
    END IF;

    -- Build question_sets array (sets-first)
    -- Ordered by section (VARC, DILR, QA) then display_order for determinism
    WITH sets AS (
        SELECT
            qs.*,
            COALESCE(
                qs.client_set_id,
                UPPER(qs.set_type) || '_' || LPAD(ROW_NUMBER() OVER (
                    PARTITION BY qs.paper_id
                    ORDER BY 
                        CASE qs.section WHEN 'VARC' THEN 1 WHEN 'DILR' THEN 2 WHEN 'QA' THEN 3 END,
                        qs.display_order,
                        qs.id
                )::TEXT, 3, '0')
            ) AS computed_client_set_id
        FROM public.question_sets qs
        WHERE qs.paper_id = p_paper_id
          AND qs.is_active = TRUE
    )
    SELECT COALESCE(
        jsonb_agg(
            jsonb_build_object(
                'client_set_id', sets.computed_client_set_id,
                'section', sets.section,
                'set_type', sets.set_type,
                'context_type', sets.context_type,
                'content_layout', COALESCE(sets.content_layout, 'text_only'),
                'context_title', sets.context_title,
                'context_body', sets.context_body,
                'context_image_url', sets.context_image_url,
                'context_additional_images', sets.context_additional_images,
                'display_order', sets.display_order,
                'is_active', sets.is_active,
                'metadata', COALESCE(sets.metadata, '{}'::jsonb)
            )
            ORDER BY 
                CASE sets.section 
                    WHEN 'VARC' THEN 1 
                    WHEN 'DILR' THEN 2 
                    WHEN 'QA' THEN 3 
                END,
                sets.display_order,
                sets.id
        ),
        '[]'::jsonb
    ) INTO v_question_sets
    FROM sets;

    -- Build questions array with set_ref linking
    -- Ordered by section, then question_number for determinism
    WITH sets AS (
        SELECT
            qs.id,
            COALESCE(
                qs.client_set_id,
                UPPER(qs.set_type) || '_' || LPAD(ROW_NUMBER() OVER (
                    PARTITION BY qs.paper_id
                    ORDER BY 
                        CASE qs.section WHEN 'VARC' THEN 1 WHEN 'DILR' THEN 2 WHEN 'QA' THEN 3 END,
                        qs.display_order,
                        qs.id
                )::TEXT, 3, '0')
            ) AS computed_client_set_id
        FROM public.question_sets qs
        WHERE qs.paper_id = p_paper_id
          AND qs.is_active = TRUE
    ), qrows AS (
        SELECT
            q.*,
            sets.computed_client_set_id AS computed_set_ref
        FROM public.questions q
        LEFT JOIN sets ON sets.id = q.set_id
        WHERE q.paper_id = p_paper_id
          AND q.is_active = TRUE
    )
    SELECT COALESCE(
        jsonb_agg(
            jsonb_build_object(
                'client_question_id', COALESCE(q.client_question_id, 'Q' || q.question_number::TEXT),
                'set_ref', COALESCE(q.computed_set_ref, 'ATOMIC_' || LPAD(q.question_number::TEXT, 3, '0')),
                'section', q.section,
                'question_number', q.question_number,
                'sequence_order', COALESCE(q.sequence_order, 1),
                'question_text', q.question_text,
                'question_type', q.question_type,
                'question_format', COALESCE(q.question_format, q.question_type),
                'taxonomy_type', q.taxonomy_type,
                'topic_tag', q.topic_tag,
                'difficulty_rationale', q.difficulty_rationale,
                'options', q.options,
                'correct_answer', q.correct_answer,
                'positive_marks', q.positive_marks,
                'negative_marks', q.negative_marks,
                'difficulty', q.difficulty,
                'topic', q.topic,
                'subtopic', q.subtopic,
                'solution_text', q.solution_text,
                'solution_image_url', q.solution_image_url,
                'video_solution_url', q.video_solution_url
            )
            ORDER BY 
                CASE q.section 
                    WHEN 'VARC' THEN 1 
                    WHEN 'DILR' THEN 2 
                    WHEN 'QA' THEN 3 
                END,
                q.question_number
        ),
        '[]'::jsonb
    ) INTO v_questions
    FROM qrows q;

    -- Build final result in Schema v3.0 format
    v_result := jsonb_build_object(
        'schema_version', 'v3.0',
        'exported_at', NOW(),
        'paper', jsonb_build_object(
            'slug', v_paper.slug,
            'title', v_paper.title,
            'description', v_paper.description,
            'year', v_paper.year,
            'total_questions', v_paper.total_questions,
            'total_marks', v_paper.total_marks,
            'duration_minutes', v_paper.duration_minutes,
            'sections', v_paper.sections,
            'default_positive_marks', v_paper.default_positive_marks,
            'default_negative_marks', v_paper.default_negative_marks,
            'difficulty_level', v_paper.difficulty_level,
            'is_free', v_paper.is_free,
            'published', v_paper.published,
            'allow_pause', v_paper.allow_pause,
            'attempt_limit', v_paper.attempt_limit,
            'paper_key', COALESCE(v_paper.paper_key, v_paper.slug)
        ),
        'question_sets', v_question_sets,
        'questions', v_questions
    );

    RETURN v_result;
END;
$$;

GRANT EXECUTE ON FUNCTION public.export_paper_json_v3(uuid) TO authenticated;
GRANT EXECUTE ON FUNCTION public.export_paper_json_v3(uuid) TO service_role;

COMMENT ON FUNCTION public.export_paper_json_v3 IS 'Exports paper in Schema v3.0 sets-first format. Use for content creation context.';


-- ============================================================================
-- ROLLBACK SCRIPT (Run manually if needed)
-- ============================================================================
/*
-- Drop functions
DROP FUNCTION IF EXISTS export_paper_json_v3;
DROP FUNCTION IF EXISTS upsert_question_set;
DROP FUNCTION IF EXISTS upsert_question;
DROP FUNCTION IF EXISTS get_set_id_by_client_id;
DROP FUNCTION IF EXISTS get_question_id_by_client_id;

-- Drop indexes
DROP INDEX IF EXISTS papers_paper_key_unique;
DROP INDEX IF EXISTS question_sets_paper_client_set_id_unique;
DROP INDEX IF EXISTS questions_paper_client_question_id_unique;

-- Drop columns (CAREFUL - data loss!)
ALTER TABLE papers DROP COLUMN IF EXISTS paper_key;
ALTER TABLE question_sets DROP COLUMN IF EXISTS client_set_id;
ALTER TABLE questions DROP COLUMN IF EXISTS client_question_id;
*/
````

## File: docs/migrations/009_attempt_submit_rls.sql
````sql
-- ============================================================================
-- Migration: Allow submit transition for attempts
-- @blueprint Security Audit - RLS submit transition
-- ============================================================================
-- Purpose: Allow authenticated users to mark their own attempts as submitted
--          while keeping completed_at and other protected fields locked down.

DROP POLICY IF EXISTS "Users can update their own attempts" ON public.attempts;

CREATE POLICY "Users can update their own attempts" ON public.attempts
    FOR UPDATE TO authenticated
    USING (auth.uid() = user_id)
    WITH CHECK (
        auth.uid() = user_id
        AND (
            -- Default: no status/submitted/completed changes
            (
                status = (SELECT status FROM public.attempts a WHERE a.id = attempts.id)
                AND submitted_at IS NOT DISTINCT FROM (SELECT submitted_at FROM public.attempts a WHERE a.id = attempts.id)
                AND completed_at IS NOT DISTINCT FROM (SELECT completed_at FROM public.attempts a WHERE a.id = attempts.id)
            )
            OR
            -- Allow in_progress -> submitted transition for the owner
            (
                (SELECT status FROM public.attempts a WHERE a.id = attempts.id) = 'in_progress'
                AND status = 'submitted'
                AND submitted_at IS NOT NULL
                AND completed_at IS NOT DISTINCT FROM (SELECT completed_at FROM public.attempts a WHERE a.id = attempts.id)
            )
        )
    );
````

## File: docs/migrations/010_force_resume_lenient.sql
````sql
-- ============================================================================
-- Migration: Force Resume Exam Session V2 (Lenient Stale Threshold)
-- @blueprint Security Audit - Phase 3 Fix - Lenient force-resume for real exams
-- ============================================================================
-- Purpose: Allow force resume even after long connectivity gaps during exams.
-- The 5-minute stale threshold was too aggressive for CAT-style 2-hour exams.
-- Now uses 180 minutes (3 hours) as the threshold - covers full exam + buffer.
-- ============================================================================

CREATE OR REPLACE FUNCTION force_resume_exam_session(
    p_attempt_id UUID,
    p_new_session_token UUID
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_user_id UUID;
    v_status TEXT;
    v_last_activity TIMESTAMPTZ;
    -- Phase 3: Increased from 5 minutes to 180 minutes (3 hours)
    -- This accommodates full exam duration + connectivity hiccups
    v_stale_threshold INTERVAL := INTERVAL '180 minutes';
BEGIN
    SELECT user_id, status, last_activity_at
    INTO v_user_id, v_status, v_last_activity
    FROM attempts
    WHERE id = p_attempt_id;

    -- Ownership check
    IF v_user_id IS NULL OR v_user_id != auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized';
    END IF;

    -- Status check
    IF v_status != 'in_progress' THEN
        RAISE EXCEPTION 'Attempt is not in progress';
    END IF;

    -- Phase 3: Only reject if truly stale (>3 hours of inactivity)
    -- This prevents "FORCE_RESUME_STALE" during normal exam flow
    IF v_last_activity IS NOT NULL AND v_last_activity < NOW() - v_stale_threshold THEN
        RAISE EXCEPTION 'FORCE_RESUME_STALE';
    END IF;

    -- Rotate session token and update activity
    UPDATE attempts
    SET session_token = p_new_session_token,
        last_activity_at = NOW()
    WHERE id = p_attempt_id;

    RETURN TRUE;
END;
$$;

-- Ensure authenticated users can execute
GRANT EXECUTE ON FUNCTION force_resume_exam_session(UUID, UUID) TO authenticated;

-- ============================================================================
-- Rollback (if needed)
-- Run the original 006_force_resume_session.sql to restore 5-minute threshold
-- ============================================================================
````

## File: docs/migrations/011_prevent_paper_delete_with_attempts.sql
````sql
-- ==============================================================================
-- Migration 011: Prevent paper deletion when attempts exist
-- ==============================================================================
-- Purpose: Replace attempts.paper_id FK to use RESTRICT/NO ACTION instead of CASCADE
-- Author: System
-- Date: 2026-01-31
-- Dependencies: 010_force_resume_lenient.sql
-- ==============================================================================

-- Drop existing FK constraint from attempts.paper_id to papers.id (if any)
DO $$
DECLARE
    v_constraint text;
BEGIN
    SELECT c.conname
    INTO v_constraint
    FROM pg_constraint c
    JOIN pg_class t ON c.conrelid = t.oid
    JOIN pg_class r ON c.confrelid = r.oid
    WHERE t.relname = 'attempts'
      AND r.relname = 'papers'
      AND c.contype = 'f'
    LIMIT 1;

    IF v_constraint IS NOT NULL THEN
        EXECUTE format('ALTER TABLE public.attempts DROP CONSTRAINT %I', v_constraint);
    END IF;
END $$;

-- Recreate FK with RESTRICT to prevent accidental cascading deletes
ALTER TABLE public.attempts
    ADD CONSTRAINT attempts_paper_id_fkey
    FOREIGN KEY (paper_id)
    REFERENCES public.papers(id)
    ON DELETE RESTRICT;

-- ==============================================================================
-- Verification
-- ==============================================================================
-- SELECT conname, confdeltype FROM pg_constraint
-- WHERE conrelid = 'public.attempts'::regclass AND contype = 'f';
````

## File: docs/migrations/012_phase1_security_hardening.sql
````sql
-- ==========================================================================
-- Migration 012: Phase 1 Security Hardening (Initial - DEPRECATED)
-- ==========================================================================
-- NOTE: This migration has been SUPERSEDED by 013_phase1_security_complete.sql
-- which provides a more comprehensive implementation of Phase 1 security.
--
-- Use migration 013 instead for new deployments.
-- This file is kept for reference and backwards compatibility with existing
-- deployments that already ran this migration.
-- ==========================================================================

-- 1) Disable legacy SQL scoring function (use TS scoring only)
DROP FUNCTION IF EXISTS public.finalize_attempt(UUID);

-- 2) Enforce per-user attempt limits (status != 'expired')
DROP POLICY IF EXISTS "Users can create their own attempts" ON public.attempts;
CREATE POLICY "Users can create attempts within limit" ON public.attempts
    FOR INSERT TO authenticated
    WITH CHECK (
        auth.uid() = user_id
        AND (
            (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id) IS NULL
            OR (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id) <= 0
            OR (
                SELECT COUNT(*)
                FROM public.attempts a
                WHERE a.user_id = auth.uid()
                  AND a.paper_id = attempts.paper_id
                  AND a.status <> 'expired'
            ) < (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id)
        )
    );

-- 3) Column-level protection for sensitive fields
REVOKE SELECT (correct_answer) ON public.questions FROM authenticated;
REVOKE SELECT (session_token) ON public.attempts FROM authenticated;
REVOKE UPDATE (session_token) ON public.attempts FROM authenticated;
````

## File: docs/migrations/013_phase1_security_complete.sql
````sql
-- ==========================================================================
-- Migration 013: Phase 1 Security Hardening - Complete Implementation
-- Date: February 2026
-- ==========================================================================
-- This migration addresses all Phase 1 security requirements:
-- 1. Remove legacy SQL finalize_attempt (TS scoring is source of truth)
-- 2. Enforce attempt limits via RLS policy
-- 3. Protect sensitive columns (correct_answer, session_token)
-- 4. Add pause_exam_state RPC with allow_pause check
-- 5. Harden session token validation
-- ==========================================================================

-- ==========================================================================
-- STEP 1: Drop Legacy SQL Scoring Function
-- ==========================================================================
-- The TypeScript scoring engine in submitExam() is now the sole source of truth.
-- Remove any legacy SQL scoring paths to prevent divergent outcomes.

DROP FUNCTION IF EXISTS public.finalize_attempt(UUID);
DROP FUNCTION IF EXISTS public.score_attempt(UUID);
DROP FUNCTION IF EXISTS public.calculate_attempt_score(UUID);

-- ==========================================================================
-- STEP 2: Enforce Attempt Limits via RLS Policy
-- ==========================================================================
-- Users cannot create more attempts than the paper's attempt_limit allows.
-- Status != 'expired' are counted (in_progress, submitted, completed, abandoned).

DROP POLICY IF EXISTS "Users can create their own attempts" ON public.attempts;
DROP POLICY IF EXISTS "Users can create attempts within limit" ON public.attempts;

CREATE POLICY "Users can create attempts within limit" ON public.attempts
    FOR INSERT TO authenticated
    WITH CHECK (
        auth.uid() = user_id
        AND (
            -- No limit set (NULL or 0 means unlimited)
            (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id) IS NULL
            OR (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id) <= 0
            OR (
                -- Count existing non-expired attempts
                (
                    SELECT COUNT(*)
                    FROM public.attempts a
                    WHERE a.user_id = auth.uid()
                      AND a.paper_id = attempts.paper_id
                      AND a.status <> 'expired'
                ) < (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id)
            )
        )
    );

-- ==========================================================================
-- STEP 3: Protect Sensitive Columns
-- ==========================================================================
-- Revoke direct access to sensitive columns from authenticated users.
-- These can only be accessed via SECURITY DEFINER functions.

-- Prevent direct read of correct_answer (use questions_exam view during exam,
-- fetch_attempt_solutions RPC after completion)
REVOKE SELECT (correct_answer) ON public.questions FROM authenticated;
REVOKE SELECT (correct_answer) ON public.questions FROM anon;

-- Prevent direct read/write of session_token (managed by session RPCs only)
REVOKE SELECT (session_token) ON public.attempts FROM authenticated;
REVOKE UPDATE (session_token) ON public.attempts FROM authenticated;
REVOKE SELECT (session_token) ON public.attempts FROM anon;

-- Prevent direct write to scoring columns (managed by submitExam TS only)
REVOKE UPDATE (total_score, correct_count, incorrect_count, unanswered_count, 
               accuracy, attempt_rate, section_scores) ON public.attempts FROM authenticated;

-- ==========================================================================
-- STEP 4: Pause Exam RPC with allow_pause Enforcement
-- ==========================================================================
-- This RPC respects the paper's allow_pause flag.
-- If allow_pause is false, pausing is denied.

DROP FUNCTION IF EXISTS public.pause_exam_state(UUID, TEXT, INT);

CREATE OR REPLACE FUNCTION public.pause_exam_state(
    p_attempt_id UUID,
    p_current_section TEXT,
    p_current_question INT
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_attempt RECORD;
    v_allow_pause BOOLEAN;
BEGIN
    -- Fetch attempt with paper info
    SELECT a.id, a.user_id, a.status, a.paper_id, a.time_remaining,
           p.allow_pause
    INTO v_attempt
    FROM public.attempts a
    JOIN public.papers p ON p.id = a.paper_id
    WHERE a.id = p_attempt_id;

    -- Validate attempt exists
    IF v_attempt.id IS NULL THEN
        RAISE EXCEPTION 'Attempt not found' USING ERRCODE = 'P0002';
    END IF;

    -- Validate ownership
    IF v_attempt.user_id <> auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized' USING ERRCODE = '42501';
    END IF;

    -- Validate status
    IF v_attempt.status <> 'in_progress' THEN
        RAISE EXCEPTION 'Attempt is not in progress' USING ERRCODE = '42501';
    END IF;

    -- Check if pausing is allowed for this paper
    v_allow_pause := COALESCE(v_attempt.allow_pause, FALSE);
    IF NOT v_allow_pause THEN
        RAISE EXCEPTION 'Pausing is not allowed for this exam' USING ERRCODE = '42501';
    END IF;

    -- Update attempt to paused state
    UPDATE public.attempts
    SET 
        status = 'paused',
        current_section = p_current_section,
        current_question = p_current_question,
        last_activity_at = NOW(),
        updated_at = NOW()
    WHERE id = p_attempt_id
      AND user_id = auth.uid();

    RETURN jsonb_build_object('success', TRUE, 'paused_at', NOW());
END;
$$;

GRANT EXECUTE ON FUNCTION public.pause_exam_state(UUID, TEXT, INT) TO authenticated;

-- ==========================================================================
-- STEP 5: Add 'paused' to attempt status enum
-- ==========================================================================
-- First check if the constraint exists and drop it, then recreate with 'paused'

DO $$
BEGIN
    -- Drop existing constraint if it exists
    ALTER TABLE public.attempts DROP CONSTRAINT IF EXISTS attempts_status_check;
    
    -- Add new constraint with 'paused' status
    ALTER TABLE public.attempts ADD CONSTRAINT attempts_status_check 
        CHECK (status IN ('in_progress', 'paused', 'submitted', 'completed', 'abandoned', 'expired'));
EXCEPTION
    WHEN others THEN
        RAISE NOTICE 'Could not update status constraint: %', SQLERRM;
END $$;

-- ==========================================================================
-- STEP 6: Enhanced Session Token Validation
-- ==========================================================================
-- More robust validation with explicit error codes

DROP FUNCTION IF EXISTS public.validate_session_token(UUID, UUID, UUID);

CREATE OR REPLACE FUNCTION public.validate_session_token(
    p_attempt_id UUID,
    p_session_token UUID,
    p_user_id UUID
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_stored_token UUID;
    v_user_id UUID;
    v_status TEXT;
BEGIN
    -- Get current attempt state
    SELECT session_token, user_id, status 
    INTO v_stored_token, v_user_id, v_status
    FROM public.attempts 
    WHERE id = p_attempt_id;
    
    -- Check if attempt exists
    IF v_user_id IS NULL THEN
        RETURN FALSE;
    END IF;
    
    -- Check ownership
    IF v_user_id != p_user_id THEN
        RETURN FALSE;
    END IF;
    
    -- Check status (allow in_progress and paused)
    IF v_status NOT IN ('in_progress', 'paused') THEN
        RETURN FALSE;
    END IF;
    
    -- If no session token set yet (first request), accept and set it
    IF v_stored_token IS NULL THEN
        UPDATE public.attempts 
        SET session_token = p_session_token, 
            last_activity_at = NOW()
        WHERE id = p_attempt_id 
          AND user_id = p_user_id;
        RETURN TRUE;
    END IF;
    
    -- Validate token matches
    IF v_stored_token = p_session_token THEN
        -- Update activity timestamp
        UPDATE public.attempts 
        SET last_activity_at = NOW()
        WHERE id = p_attempt_id;
        RETURN TRUE;
    END IF;
    
    -- Token mismatch - possible multi-device attack
    RETURN FALSE;
END;
$$;

GRANT EXECUTE ON FUNCTION public.validate_session_token(UUID, UUID, UUID) TO authenticated;

-- ==========================================================================
-- STEP 7: Force Resume Session (with staleness check)
-- ==========================================================================
-- Allows user to take over session from another device.
-- Rejects if session is too stale (configurable threshold).

DROP FUNCTION IF EXISTS public.force_resume_exam_session(UUID, UUID);

CREATE OR REPLACE FUNCTION public.force_resume_exam_session(
    p_attempt_id UUID,
    p_new_session_token UUID
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_attempt RECORD;
    v_stale_threshold INTERVAL := INTERVAL '30 minutes';
BEGIN
    -- Get current attempt state
    SELECT id, user_id, status, session_token, last_activity_at, started_at
    INTO v_attempt
    FROM public.attempts
    WHERE id = p_attempt_id;

    -- Validate attempt exists
    IF v_attempt.id IS NULL THEN
        RAISE EXCEPTION 'Attempt not found' USING ERRCODE = 'P0002';
    END IF;

    -- Validate ownership
    IF v_attempt.user_id <> auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized' USING ERRCODE = '42501';
    END IF;

    -- Validate status (allow in_progress and paused)
    IF v_attempt.status NOT IN ('in_progress', 'paused') THEN
        RAISE EXCEPTION 'Attempt is not resumable (status: %)', v_attempt.status 
            USING ERRCODE = '42501';
    END IF;

    -- Check staleness (optional - can be disabled by setting threshold very high)
    -- If last_activity_at is very old, reject force resume
    IF v_attempt.last_activity_at IS NOT NULL 
       AND v_attempt.last_activity_at < (NOW() - v_stale_threshold) THEN
        -- Allow force resume but log it (don't block for now)
        -- In production, you might want to be stricter
        RAISE NOTICE 'FORCE_RESUME_STALE: Session inactive for > 30 minutes';
    END IF;

    -- Update session token and resume
    UPDATE public.attempts
    SET 
        session_token = p_new_session_token,
        status = CASE WHEN status = 'paused' THEN 'in_progress' ELSE status END,
        last_activity_at = NOW(),
        updated_at = NOW()
    WHERE id = p_attempt_id
      AND user_id = auth.uid();

    RETURN p_new_session_token;
END;
$$;

GRANT EXECUTE ON FUNCTION public.force_resume_exam_session(UUID, UUID) TO authenticated;

-- ==========================================================================
-- STEP 8: Initialize Exam Session
-- ==========================================================================
-- Creates a new session token for an attempt.

DROP FUNCTION IF EXISTS public.initialize_exam_session(UUID, UUID);

CREATE OR REPLACE FUNCTION public.initialize_exam_session(
    p_attempt_id UUID,
    p_user_id UUID
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_attempt RECORD;
    v_new_token UUID;
BEGIN
    -- Fetch attempt
    SELECT id, user_id, status, session_token
    INTO v_attempt
    FROM public.attempts
    WHERE id = p_attempt_id;

    -- Validate
    IF v_attempt.id IS NULL THEN
        RAISE EXCEPTION 'Attempt not found' USING ERRCODE = 'P0002';
    END IF;

    IF v_attempt.user_id <> p_user_id THEN
        RAISE EXCEPTION 'Unauthorized' USING ERRCODE = '42501';
    END IF;

    IF v_attempt.status NOT IN ('in_progress', 'paused') THEN
        RAISE EXCEPTION 'Attempt is not active' USING ERRCODE = '42501';
    END IF;

    -- Generate new token
    v_new_token := gen_random_uuid();

    -- Update attempt
    UPDATE public.attempts
    SET 
        session_token = v_new_token,
        status = CASE WHEN status = 'paused' THEN 'in_progress' ELSE status END,
        last_activity_at = NOW(),
        updated_at = NOW()
    WHERE id = p_attempt_id
      AND user_id = p_user_id;

    RETURN v_new_token;
END;
$$;

GRANT EXECUTE ON FUNCTION public.initialize_exam_session(UUID, UUID) TO authenticated;

-- ==========================================================================
-- STEP 9: Questions RLS Policy Update
-- ==========================================================================
-- Ensure questions table RLS only allows reading for completed attempts.
-- During exam, use questions_exam view which excludes correct_answer.

DROP POLICY IF EXISTS "Users can read questions for their completed attempts" ON public.questions;

CREATE POLICY "Users can read questions for their completed attempts" ON public.questions
    FOR SELECT TO authenticated 
    USING (
        is_active = true
        AND (
            -- Admins can see all questions
            public.is_admin()
            OR
            -- Users can only see questions for papers they've completed
            paper_id IN (
                SELECT paper_id FROM public.attempts
                WHERE user_id = auth.uid()
                  AND status IN ('submitted', 'completed')
                  AND submitted_at IS NOT NULL
            )
        )
    );

-- ==========================================================================
-- STEP 10: Ensure questions_exam view is properly granted
-- ==========================================================================
-- This view excludes correct_answer and is safe for exam runtime.

-- Grant access to the secure exam view
GRANT SELECT ON public.questions_exam TO authenticated;
GRANT SELECT ON public.questions_exam TO anon;

-- ==========================================================================
-- STEP 11: Attempt UPDATE Policy Hardening
-- ==========================================================================
-- Restrict what fields can be updated and under what conditions.

DROP POLICY IF EXISTS "Users can update their own attempts" ON public.attempts;

CREATE POLICY "Users can update their own in-progress attempts" ON public.attempts
    FOR UPDATE TO authenticated
    USING (auth.uid() = user_id)
    WITH CHECK (
        auth.uid() = user_id
        AND (
            -- Allow normal progress updates (no status change)
            (
                status = (SELECT status FROM public.attempts a WHERE a.id = attempts.id)
                AND submitted_at IS NOT DISTINCT FROM (SELECT submitted_at FROM public.attempts a WHERE a.id = attempts.id)
                AND completed_at IS NOT DISTINCT FROM (SELECT completed_at FROM public.attempts a WHERE a.id = attempts.id)
            )
            OR
            -- Allow transition from in_progress to submitted
            (
                (SELECT status FROM public.attempts a WHERE a.id = attempts.id) = 'in_progress'
                AND status = 'submitted'
                AND submitted_at IS NOT NULL
                AND completed_at IS NOT DISTINCT FROM (SELECT completed_at FROM public.attempts a WHERE a.id = attempts.id)
            )
        )
    );

-- ==========================================================================
-- STEP 12: Responses RLS Policy
-- ==========================================================================
-- Users can only see/modify responses for their own attempts.

DROP POLICY IF EXISTS "Users can view their own responses" ON public.responses;
DROP POLICY IF EXISTS "Users can create their own responses" ON public.responses;
DROP POLICY IF EXISTS "Users can update their own responses" ON public.responses;

CREATE POLICY "Users can view their own responses" ON public.responses
    FOR SELECT TO authenticated
    USING (
        attempt_id IN (
            SELECT id FROM public.attempts WHERE user_id = auth.uid()
        )
    );

CREATE POLICY "Users can create their own responses" ON public.responses
    FOR INSERT TO authenticated
    WITH CHECK (
        attempt_id IN (
            SELECT id FROM public.attempts 
            WHERE user_id = auth.uid() 
              AND status IN ('in_progress', 'paused')
        )
    );

CREATE POLICY "Users can update their own responses" ON public.responses
    FOR UPDATE TO authenticated
    USING (
        attempt_id IN (
            SELECT id FROM public.attempts 
            WHERE user_id = auth.uid() 
              AND status IN ('in_progress', 'paused')
        )
    );

-- ==========================================================================
-- STEP 13: Fetch Attempt Solutions RPC
-- ==========================================================================
-- Secure way to fetch solutions only for completed attempts.

DROP FUNCTION IF EXISTS public.fetch_attempt_solutions(UUID);

CREATE OR REPLACE FUNCTION public.fetch_attempt_solutions(p_attempt_id UUID)
RETURNS TABLE (
    question_id UUID,
    correct_answer TEXT,
    solution_text TEXT,
    solution_image_url TEXT,
    video_solution_url TEXT
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_attempt RECORD;
BEGIN
    -- Get attempt info
    SELECT id, user_id, status, paper_id, submitted_at
    INTO v_attempt
    FROM public.attempts
    WHERE id = p_attempt_id;

    -- Validate attempt exists
    IF v_attempt.id IS NULL THEN
        RAISE EXCEPTION 'Attempt not found' USING ERRCODE = 'P0002';
    END IF;

    -- Validate ownership
    IF v_attempt.user_id <> auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized' USING ERRCODE = '42501';
    END IF;

    -- Validate attempt is completed
    IF v_attempt.status NOT IN ('submitted', 'completed') OR v_attempt.submitted_at IS NULL THEN
        RAISE EXCEPTION 'Solutions only available after submission' USING ERRCODE = '42501';
    END IF;

    -- Return solutions
    RETURN QUERY
    SELECT 
        q.id AS question_id,
        q.correct_answer,
        q.solution_text,
        q.solution_image_url,
        q.video_solution_url
    FROM public.questions q
    WHERE q.paper_id = v_attempt.paper_id
      AND q.is_active = TRUE
    ORDER BY q.section, q.question_number;
END;
$$;

GRANT EXECUTE ON FUNCTION public.fetch_attempt_solutions(UUID) TO authenticated;

-- ==========================================================================
-- VERIFICATION QUERIES (Run to verify migration)
-- ==========================================================================
-- SELECT * FROM pg_policies WHERE tablename = 'attempts';
-- SELECT * FROM pg_policies WHERE tablename = 'questions';
-- SELECT * FROM pg_policies WHERE tablename = 'responses';
-- SELECT proname FROM pg_proc WHERE proname LIKE '%session%' OR proname LIKE '%attempt%';
````

## File: docs/migrations/014_soften_submit_rls.sql
````sql
-- ==========================================================================
-- Migration 014: Soften Submit RLS (Allow scoring update)
-- Date: February 2026
-- ==========================================================================
-- Purpose:
-- 1) Allow authenticated users to transition submitted -> completed
-- 2) Allow authenticated users to update scoring columns
--
-- NOTE: This is a security relaxation. Apply only if you accept the risk.

-- --------------------------------------------------------------------------
-- STEP 1: Allow submitted -> completed transition
-- --------------------------------------------------------------------------
-- Replace the restrictive policy with a relaxed version that permits:
--  - in_progress -> submitted
--  - submitted -> completed

DROP POLICY IF EXISTS "Users can update their own in-progress attempts" ON public.attempts;
DROP POLICY IF EXISTS "Users can update their own attempts (relaxed)" ON public.attempts;

CREATE POLICY "Users can update their own attempts (relaxed)" ON public.attempts
    FOR UPDATE TO authenticated
    USING (auth.uid() = user_id)
    WITH CHECK (
        auth.uid() = user_id
        AND (
            -- Allow normal progress updates (no status change)
            (
                status = (SELECT status FROM public.attempts a WHERE a.id = attempts.id)
                AND submitted_at IS NOT DISTINCT FROM (SELECT submitted_at FROM public.attempts a WHERE a.id = attempts.id)
                AND completed_at IS NOT DISTINCT FROM (SELECT completed_at FROM public.attempts a WHERE a.id = attempts.id)
            )
            OR
            -- Allow transition from in_progress to submitted
            (
                (SELECT status FROM public.attempts a WHERE a.id = attempts.id) = 'in_progress'
                AND status = 'submitted'
                AND submitted_at IS NOT NULL
                AND completed_at IS NOT DISTINCT FROM (SELECT completed_at FROM public.attempts a WHERE a.id = attempts.id)
            )
            OR
            -- Allow transition from submitted to completed
            (
                (SELECT status FROM public.attempts a WHERE a.id = attempts.id) = 'submitted'
                AND status = 'completed'
                AND completed_at IS NOT NULL
            )
        )
    );

-- --------------------------------------------------------------------------
-- STEP 2: Re-grant scoring column updates to authenticated users
-- --------------------------------------------------------------------------
-- WARNING: This enables clients to write scores directly.
-- If you can, prefer using service-role updates instead.

GRANT UPDATE (total_score, correct_count, incorrect_count, unanswered_count,
              accuracy, attempt_rate, section_scores, max_possible_score, time_taken_seconds)
ON public.attempts TO authenticated;
````

## File: docs/migrations/015_landing_assets.sql
````sql
-- ============================================================================
-- MIGRATION 015: Landing Assets (DB + Storage)
-- ============================================================================
-- Purpose: Provide a minimal landing asset layer for dynamic image swapping.
--
-- Table: public.landing_assets
-- Columns: key, storage_path, public_url, alt_text, updated_at, updated_by
-- RLS: public read, admin-only write
-- Storage: landing-assets bucket (public read), admin-only write
-- ============================================================================

-- ==========================================================================
-- STEP 1: Create landing_assets table
-- ==========================================================================
CREATE TABLE IF NOT EXISTS public.landing_assets (
    key TEXT PRIMARY KEY,
    storage_path TEXT,
    public_url TEXT,
    alt_text TEXT,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    updated_by UUID REFERENCES auth.users(id) ON DELETE SET NULL
);

CREATE INDEX IF NOT EXISTS idx_landing_assets_updated_at ON public.landing_assets(updated_at DESC);

COMMENT ON TABLE public.landing_assets IS 'Public landing page asset registry (image keys, URLs, alt text).';
COMMENT ON COLUMN public.landing_assets.key IS 'Unique asset key (hero_mock_ui, mentor_photo, feature_exam_ui, etc).';

-- ==========================================================================
-- STEP 2: Enable RLS
-- ==========================================================================
ALTER TABLE public.landing_assets ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if re-running
DROP POLICY IF EXISTS "Public read landing assets" ON public.landing_assets;
DROP POLICY IF EXISTS "Admins can insert landing assets" ON public.landing_assets;
DROP POLICY IF EXISTS "Admins can update landing assets" ON public.landing_assets;
DROP POLICY IF EXISTS "Admins can delete landing assets" ON public.landing_assets;

-- Public read (anon + authenticated)
CREATE POLICY "Public read landing assets" ON public.landing_assets
    FOR SELECT USING (true);

-- Admin-only writes
CREATE POLICY "Admins can insert landing assets" ON public.landing_assets
    FOR INSERT WITH CHECK (public.is_admin());

CREATE POLICY "Admins can update landing assets" ON public.landing_assets
    FOR UPDATE USING (public.is_admin());

CREATE POLICY "Admins can delete landing assets" ON public.landing_assets
    FOR DELETE USING (public.is_admin());

-- ==========================================================================
-- STEP 3: Storage bucket for landing assets
-- ==========================================================================
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
    'landing-assets',
    'landing-assets',
    true,
    10485760,
    ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml']
) ON CONFLICT (id) DO NOTHING;

-- Drop existing storage policies if they exist
DROP POLICY IF EXISTS "Public read access for landing assets" ON storage.objects;
DROP POLICY IF EXISTS "Admins can upload landing assets" ON storage.objects;
DROP POLICY IF EXISTS "Admins can update landing assets" ON storage.objects;
DROP POLICY IF EXISTS "Admins can delete landing assets" ON storage.objects;

-- Public read
CREATE POLICY "Public read access for landing assets" ON storage.objects
    FOR SELECT
    USING (bucket_id = 'landing-assets');

-- Admin-only writes
CREATE POLICY "Admins can upload landing assets" ON storage.objects
    FOR INSERT
    WITH CHECK (bucket_id = 'landing-assets' AND public.is_admin());

CREATE POLICY "Admins can update landing assets" ON storage.objects
    FOR UPDATE
    USING (bucket_id = 'landing-assets' AND public.is_admin());

CREATE POLICY "Admins can delete landing assets" ON storage.objects
    FOR DELETE
    USING (bucket_id = 'landing-assets' AND public.is_admin());

-- ==========================================================================
-- VERIFICATION QUERIES
-- ==========================================================================
-- SELECT * FROM public.landing_assets LIMIT 5;
-- SELECT * FROM storage.buckets WHERE id = 'landing-assets';
-- SELECT policyname, tablename FROM pg_policies WHERE schemaname = 'public' AND tablename = 'landing_assets';
````

## File: docs/migrations/016_bug_reports.sql
````sql
-- ============================================================================
-- MIGRATION 016: Bug Reports (DB + Storage)
-- ============================================================================
-- Purpose: Allow authenticated users to submit bug reports with optional screenshots.
--
-- Table: public.bug_reports
-- Columns: id, user_id, route, description, screenshot_path, meta, created_at
-- RLS: authenticated insert, admin read
-- Storage: bug-screenshots bucket (private), authenticated upload, admin read/delete
-- ============================================================================

-- ==========================================================================
-- STEP 1: Create bug_reports table
-- ==========================================================================
CREATE TABLE IF NOT EXISTS public.bug_reports (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    route TEXT,
    description TEXT NOT NULL,
    screenshot_path TEXT,
    meta JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_bug_reports_created_at ON public.bug_reports(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_bug_reports_user_id ON public.bug_reports(user_id);

COMMENT ON TABLE public.bug_reports IS 'User-submitted bug reports with optional screenshots.';

-- ==========================================================================
-- STEP 2: Enable RLS
-- ==========================================================================
ALTER TABLE public.bug_reports ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can insert bug reports" ON public.bug_reports;
DROP POLICY IF EXISTS "Admins can read bug reports" ON public.bug_reports;

CREATE POLICY "Users can insert bug reports" ON public.bug_reports
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Admins can read bug reports" ON public.bug_reports
    FOR SELECT USING (public.is_admin());

-- ==========================================================================
-- STEP 3: Storage bucket for screenshots
-- ==========================================================================
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
    'bug-screenshots',
    'bug-screenshots',
    false,
    5242880,
    ARRAY['image/jpeg', 'image/png', 'image/webp']
) ON CONFLICT (id) DO NOTHING;

DROP POLICY IF EXISTS "Authenticated upload bug screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Admins read bug screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Admins delete bug screenshots" ON storage.objects;

CREATE POLICY "Authenticated upload bug screenshots" ON storage.objects
    FOR INSERT
    WITH CHECK (bucket_id = 'bug-screenshots' AND auth.role() = 'authenticated');

CREATE POLICY "Admins read bug screenshots" ON storage.objects
    FOR SELECT
    USING (bucket_id = 'bug-screenshots' AND public.is_admin());

CREATE POLICY "Admins delete bug screenshots" ON storage.objects
    FOR DELETE
    USING (bucket_id = 'bug-screenshots' AND public.is_admin());

-- ==========================================================================
-- VERIFICATION QUERIES
-- ==========================================================================
-- SELECT * FROM public.bug_reports LIMIT 5;
-- SELECT * FROM storage.buckets WHERE id = 'bug-screenshots';
````

## File: docs/migrations/017_bug_report_status.sql
````sql
-- ============================================================================
-- MIGRATION 017: Bug Report Status (Admin Workflow)
-- ============================================================================
-- Purpose: Allow admins to track bug report status (unchecked/in_progress/resolved).
-- ============================================================================

ALTER TABLE public.bug_reports
    ADD COLUMN IF NOT EXISTS status TEXT NOT NULL DEFAULT 'unchecked';

-- Enable admin updates for status changes
DROP POLICY IF EXISTS "Admins can update bug reports" ON public.bug_reports;

CREATE POLICY "Admins can update bug reports" ON public.bug_reports
    FOR UPDATE USING (public.is_admin());

-- ============================================================================
-- VERIFICATION QUERIES
-- ============================================================================
-- SELECT id, status FROM public.bug_reports LIMIT 5;
````

## File: docs/migrations/018_purge_attempts_on_auth_delete.sql
````sql
-- ============================================================================
-- Migration 018: Purge Attempts/Responses on Auth User Deletion
-- ============================================================================
-- Purpose: Ensure attempts (and cascading responses) are deleted when a user
--          is removed from auth.users. This prevents stale results from
--          appearing after account deletion.
-- ============================================================================

CREATE OR REPLACE FUNCTION public.handle_auth_user_delete()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
BEGIN
    -- Delete responses explicitly in case FK cascade is missing.
    DELETE FROM public.responses
    WHERE attempt_id IN (SELECT id FROM public.attempts WHERE user_id = OLD.id);

    -- Delete attempts for the auth user.
    DELETE FROM public.attempts WHERE user_id = OLD.id;

    RETURN OLD;
END;
$$;

DROP TRIGGER IF EXISTS on_auth_user_deleted_cleanup ON auth.users;
CREATE TRIGGER on_auth_user_deleted_cleanup
    AFTER DELETE ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_auth_user_delete();

-- ============================================================================
-- Verification
-- ============================================================================
-- 1) Delete a user from auth.users in Supabase.
-- 2) Confirm their attempts are removed:
--    SELECT * FROM public.attempts WHERE user_id = '<deleted_user_id>';
````

## File: docs/migrations/019_force_resume_ultra_lenient.sql
````sql
-- ============================================================================
-- Migration 019: Force Resume Exam Session (Ultra-Lenient Threshold)
-- ============================================================================
-- Purpose: Allow force resume even after long gaps (e.g., next-day continuation).
-- This aligns with mock behavior where attempts can be resumed later.
-- ============================================================================

DROP FUNCTION IF EXISTS force_resume_exam_session(UUID, UUID);

CREATE FUNCTION force_resume_exam_session(
    p_attempt_id UUID,
    p_new_session_token UUID
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_user_id UUID;
    v_status TEXT;
    v_last_activity TIMESTAMPTZ;
    -- Ultra-lenient: allow resume up to 7 days of inactivity.
    v_stale_threshold INTERVAL := INTERVAL '7 days';
BEGIN
    SELECT user_id, status, last_activity_at
    INTO v_user_id, v_status, v_last_activity
    FROM attempts
    WHERE id = p_attempt_id;

    IF v_user_id IS NULL OR v_user_id != auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized';
    END IF;

    IF v_status != 'in_progress' THEN
        RAISE EXCEPTION 'Attempt is not in progress';
    END IF;

    IF v_last_activity IS NOT NULL AND v_last_activity < NOW() - v_stale_threshold THEN
        RAISE EXCEPTION 'FORCE_RESUME_STALE';
    END IF;

    UPDATE attempts
    SET session_token = p_new_session_token,
        last_activity_at = NOW()
    WHERE id = p_attempt_id;

    RETURN TRUE;
END;
$$;

GRANT EXECUTE ON FUNCTION force_resume_exam_session(UUID, UUID) TO authenticated;

-- ============================================================================
-- Rollback
-- Run 010_force_resume_lenient.sql to restore 3-hour threshold.
-- ============================================================================
````

## File: docs/migrations/020_pause_tracking.sql
````sql
-- ============================================================================
-- Migration 020: Pause Tracking for Accurate Time Taken
-- ============================================================================
-- Purpose: Track total paused duration so scoring/analytics exclude pause time.
-- Adds:
--   - attempts.paused_at
--   - attempts.total_paused_seconds
-- Updates:
--   - pause_exam_state
--   - initialize_exam_session
--   - force_resume_exam_session
-- ============================================================================

ALTER TABLE public.attempts
    ADD COLUMN IF NOT EXISTS paused_at TIMESTAMPTZ,
    ADD COLUMN IF NOT EXISTS total_paused_seconds INTEGER NOT NULL DEFAULT 0;

COMMENT ON COLUMN public.attempts.paused_at IS 'Timestamp when the attempt was last paused.';
COMMENT ON COLUMN public.attempts.total_paused_seconds IS 'Accumulated paused duration (seconds).';

-- Backfill paused_at for currently paused attempts (best-effort)
UPDATE public.attempts
SET paused_at = COALESCE(paused_at, last_activity_at, updated_at, NOW())
WHERE status = 'paused' AND paused_at IS NULL;

-- --------------------------------------------------------------------------
-- Pause RPC: set paused_at and keep total_paused_seconds unchanged
-- --------------------------------------------------------------------------
DROP FUNCTION IF EXISTS public.pause_exam_state(UUID, TEXT, INT);

CREATE OR REPLACE FUNCTION public.pause_exam_state(
    p_attempt_id UUID,
    p_current_section TEXT,
    p_current_question INT
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_attempt RECORD;
    v_allow_pause BOOLEAN;
BEGIN
    -- Fetch attempt with paper info
    SELECT a.id, a.user_id, a.status, a.paper_id, a.time_remaining, p.allow_pause
    INTO v_attempt
    FROM public.attempts a
    JOIN public.papers p ON p.id = a.paper_id
    WHERE a.id = p_attempt_id;

    -- Validate attempt exists
    IF v_attempt.id IS NULL THEN
        RAISE EXCEPTION 'Attempt not found' USING ERRCODE = 'P0002';
    END IF;

    -- Validate ownership
    IF v_attempt.user_id <> auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized' USING ERRCODE = '42501';
    END IF;

    -- Validate status
    IF v_attempt.status <> 'in_progress' THEN
        RAISE EXCEPTION 'Attempt is not in progress' USING ERRCODE = '42501';
    END IF;

    -- Check if pausing is allowed for this paper
    v_allow_pause := COALESCE(v_attempt.allow_pause, FALSE);
    IF NOT v_allow_pause THEN
        RAISE EXCEPTION 'Pausing is not allowed for this exam' USING ERRCODE = '42501';
    END IF;

    -- Update attempt to paused state
    UPDATE public.attempts
    SET
        status = 'paused',
        current_section = p_current_section,
        current_question = p_current_question,
        last_activity_at = NOW(),
        updated_at = NOW(),
        paused_at = NOW()
    WHERE id = p_attempt_id
      AND user_id = auth.uid();

    RETURN jsonb_build_object('success', TRUE, 'paused_at', NOW());
END;
$$;

GRANT EXECUTE ON FUNCTION public.pause_exam_state(UUID, TEXT, INT) TO authenticated;

-- --------------------------------------------------------------------------
-- Initialize session: resume paused attempts and add pause duration
-- --------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION public.initialize_exam_session(
    p_attempt_id UUID,
    p_user_id UUID
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_attempt RECORD;
    v_new_token UUID;
    v_paused_delta INTEGER := 0;
BEGIN
    -- Fetch attempt
    SELECT id, user_id, status, session_token, paused_at, total_paused_seconds
    INTO v_attempt
    FROM public.attempts
    WHERE id = p_attempt_id;

    -- Validate
    IF v_attempt.id IS NULL THEN
        RAISE EXCEPTION 'Attempt not found' USING ERRCODE = 'P0002';
    END IF;

    IF v_attempt.user_id <> p_user_id THEN
        RAISE EXCEPTION 'Unauthorized' USING ERRCODE = '42501';
    END IF;

    IF v_attempt.status NOT IN ('in_progress', 'paused') THEN
        RAISE EXCEPTION 'Attempt is not active' USING ERRCODE = '42501';
    END IF;

    IF v_attempt.status = 'paused' AND v_attempt.paused_at IS NOT NULL THEN
        v_paused_delta := GREATEST(0, EXTRACT(EPOCH FROM (NOW() - v_attempt.paused_at))::INT);
    END IF;

    -- Generate new token
    v_new_token := gen_random_uuid();

    -- Update attempt
    UPDATE public.attempts
    SET
        session_token = v_new_token,
        status = CASE WHEN v_attempt.status = 'paused' THEN 'in_progress' ELSE status END,
        last_activity_at = NOW(),
        updated_at = NOW(),
        paused_at = CASE WHEN v_attempt.status = 'paused' THEN NULL ELSE paused_at END,
        total_paused_seconds = COALESCE(total_paused_seconds, 0) + v_paused_delta
    WHERE id = p_attempt_id
      AND user_id = p_user_id;

    RETURN v_new_token;
END;
$$;

GRANT EXECUTE ON FUNCTION public.initialize_exam_session(UUID, UUID) TO authenticated;

-- --------------------------------------------------------------------------
-- Force resume: resume paused attempts and add pause duration
-- --------------------------------------------------------------------------
DROP FUNCTION IF EXISTS public.force_resume_exam_session(UUID, UUID);

CREATE OR REPLACE FUNCTION public.force_resume_exam_session(
    p_attempt_id UUID,
    p_new_session_token UUID
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_attempt RECORD;
    v_paused_delta INTEGER := 0;
    v_stale_threshold INTERVAL := INTERVAL '7 days';
BEGIN
    -- Get current attempt state
    SELECT id, user_id, status, session_token, last_activity_at, paused_at, total_paused_seconds
    INTO v_attempt
    FROM public.attempts
    WHERE id = p_attempt_id;

    -- Validate attempt exists
    IF v_attempt.id IS NULL THEN
        RAISE EXCEPTION 'Attempt not found' USING ERRCODE = 'P0002';
    END IF;

    -- Validate ownership
    IF v_attempt.user_id <> auth.uid() THEN
        RAISE EXCEPTION 'Unauthorized' USING ERRCODE = '42501';
    END IF;

    -- Validate status (allow in_progress and paused)
    IF v_attempt.status NOT IN ('in_progress', 'paused') THEN
        RAISE EXCEPTION 'Attempt is not resumable (status: %)', v_attempt.status
            USING ERRCODE = '42501';
    END IF;

    -- Check staleness (allow long gaps for mocks)
    IF v_attempt.last_activity_at IS NOT NULL
       AND v_attempt.last_activity_at < (NOW() - v_stale_threshold) THEN
        RAISE EXCEPTION 'FORCE_RESUME_STALE';
    END IF;

    IF v_attempt.status = 'paused' AND v_attempt.paused_at IS NOT NULL THEN
        v_paused_delta := GREATEST(0, EXTRACT(EPOCH FROM (NOW() - v_attempt.paused_at))::INT);
    END IF;

    -- Update session token and resume
    UPDATE public.attempts
    SET
        session_token = p_new_session_token,
        status = CASE WHEN v_attempt.status = 'paused' THEN 'in_progress' ELSE status END,
        last_activity_at = NOW(),
        updated_at = NOW(),
        paused_at = CASE WHEN v_attempt.status = 'paused' THEN NULL ELSE paused_at END,
        total_paused_seconds = COALESCE(total_paused_seconds, 0) + v_paused_delta
    WHERE id = p_attempt_id
      AND user_id = auth.uid();

    RETURN TRUE;
END;
$$;

GRANT EXECUTE ON FUNCTION public.force_resume_exam_session(UUID, UUID) TO authenticated;
````

## File: docs/migrations/021_validate_session_token_atomic.sql
````sql
-- ============================================================================
-- Migration 021: Validate Session Token (Atomic Init)
-- ============================================================================
-- Purpose: Fix TOCTOU race when initializing session_token for the first time.
-- This makes the "token is NULL -> set token" branch atomic.
-- ============================================================================

DROP FUNCTION IF EXISTS public.validate_session_token(UUID, UUID, UUID, BOOLEAN);
DROP FUNCTION IF EXISTS public.validate_session_token(UUID, UUID, UUID);

CREATE OR REPLACE FUNCTION public.validate_session_token(
    p_attempt_id UUID,
    p_session_token UUID,
    p_user_id UUID
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_stored_token UUID;
    v_user_id UUID;
    v_status TEXT;
    v_rows_updated INTEGER := 0;
BEGIN
    -- Get current attempt state
    SELECT session_token, user_id, status
    INTO v_stored_token, v_user_id, v_status
    FROM public.attempts
    WHERE id = p_attempt_id;

    -- Check if attempt exists
    IF v_user_id IS NULL THEN
        RETURN FALSE;
    END IF;

    -- Check ownership
    IF v_user_id != p_user_id THEN
        RETURN FALSE;
    END IF;

    -- Check status (allow in_progress and paused)
    IF v_status NOT IN ('in_progress', 'paused') THEN
        RETURN FALSE;
    END IF;

    -- If no session token set yet (first request), try to set it atomically
    IF v_stored_token IS NULL THEN
        UPDATE public.attempts
        SET session_token = p_session_token,
            last_activity_at = NOW()
        WHERE id = p_attempt_id
          AND user_id = p_user_id
          AND session_token IS NULL;

        GET DIAGNOSTICS v_rows_updated = ROW_COUNT;

        IF v_rows_updated > 0 THEN
            RETURN TRUE;
        END IF;

        -- Another request set the token first; re-read it.
        SELECT session_token INTO v_stored_token
        FROM public.attempts
        WHERE id = p_attempt_id;
    END IF;

    -- Validate token matches
    IF v_stored_token = p_session_token THEN
        UPDATE public.attempts
        SET last_activity_at = NOW()
        WHERE id = p_attempt_id;
        RETURN TRUE;
    END IF;

    -- Token mismatch
    RETURN FALSE;
END;
$$;

-- Overloaded signature used by API routes (keeps compatibility with named args)
CREATE OR REPLACE FUNCTION public.validate_session_token(
    p_attempt_id UUID,
    p_session_token UUID,
    p_user_id UUID,
    p_force_resume BOOLEAN DEFAULT FALSE
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
BEGIN
    RETURN public.validate_session_token(p_attempt_id, p_session_token, p_user_id);
END;
$$;

GRANT EXECUTE ON FUNCTION public.validate_session_token(UUID, UUID, UUID) TO authenticated;
GRANT EXECUTE ON FUNCTION public.validate_session_token(UUID, UUID, UUID, BOOLEAN) TO authenticated;
````

## File: docs/migrations/022_validate_session_token_single_signature.sql
````sql
-- ============================================================================
-- Migration 022: Validate Session Token (Single Signature)
-- ============================================================================
-- Purpose: Remove overloaded signatures to avoid PostgREST ambiguity.
-- Keeps the atomic init logic from migration 021.
-- ============================================================================

DROP FUNCTION IF EXISTS public.validate_session_token(UUID, UUID, UUID, BOOLEAN);

CREATE OR REPLACE FUNCTION public.validate_session_token(
    p_attempt_id UUID,
    p_session_token UUID,
    p_user_id UUID
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_stored_token UUID;
    v_user_id UUID;
    v_status TEXT;
    v_rows_updated INTEGER := 0;
BEGIN
    -- Get current attempt state
    SELECT session_token, user_id, status
    INTO v_stored_token, v_user_id, v_status
    FROM public.attempts
    WHERE id = p_attempt_id;

    -- Check if attempt exists
    IF v_user_id IS NULL THEN
        RETURN FALSE;
    END IF;

    -- Check ownership
    IF v_user_id != p_user_id THEN
        RETURN FALSE;
    END IF;

    -- Check status (allow in_progress and paused)
    IF v_status NOT IN ('in_progress', 'paused') THEN
        RETURN FALSE;
    END IF;

    -- If no session token set yet (first request), try to set it atomically
    IF v_stored_token IS NULL THEN
        UPDATE public.attempts
        SET session_token = p_session_token,
            last_activity_at = NOW()
        WHERE id = p_attempt_id
          AND user_id = p_user_id
          AND session_token IS NULL;

        GET DIAGNOSTICS v_rows_updated = ROW_COUNT;

        IF v_rows_updated > 0 THEN
            RETURN TRUE;
        END IF;

        -- Another request set the token first; re-read it.
        SELECT session_token INTO v_stored_tokenSELECT
        u.id AS user_id,
        u.email,
        p.id AS paper_id,
        p.slug AS paper_slug,
        p.title AS paper_title,
        a.id AS attempt_id,
        a.status AS attempt_status,
        a.started_at,
        a.submitted_at,
        a.completed_at,
        a.time_taken_seconds,
        q.id AS question_id,
        q.section,
        q.question_number,
        q.question_type,
        q.question_text,
        q.options,
        r.answer AS user_answer,
        r.is_correct,
        r.marks_obtained,
        r.status AS response_status,
        r.is_marked_for_review,
        r.time_spent_seconds,
        r.visit_count,
        r.created_at AS response_created_at,
        r.updated_at AS response_updated_at
        FROM public.users u
        JOIN public.attempts a ON a.user_id = u.id
        JOIN public.papers p ON p.id = a.paper_id
        JOIN public.responses r ON r.attempt_id = a.id
        JOIN public.questions q ON q.id = r.question_id
        ORDER BY u.email, p.title, a.started_at, q.section, q.question_number;
        FROM public.attempts
        WHERE id = p_attempt_id;
    END IF;

    -- Validate token matches
    IF v_stored_token = p_session_token THEN
        UPDATE public.attempts
        SET last_activity_at = NOW()
        WHERE id = p_attempt_id;
        RETURN TRUE;
    END IF;

    -- Token mismatch
    RETURN FALSE;
END;
$$;

GRANT EXECUTE ON FUNCTION public.validate_session_token(UUID, UUID, UUID) TO authenticated;
````

## File: docs/migrations/023_access_control_foundations.sql
````sql
-- ============================================================================
-- Migration 023: Access Control Foundations (Signup Mode + Waitlist)
-- ============================================================================
-- Purpose:
--   1) Central app settings for signup mode (OPEN/GATED)
--   2) Per-user access status (active/pending/rejected)
--   3) Waitlist/access requests inbox
--   4) Deterministic status assignment on signup (fail-closed)
-- ============================================================================

-- ============================================================================
-- STEP 1: ENUM TYPES
-- ============================================================================

DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'signup_mode') THEN
        CREATE TYPE public.signup_mode AS ENUM ('OPEN', 'GATED');
    END IF;
END $$;

DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'access_status') THEN
        CREATE TYPE public.access_status AS ENUM ('active', 'pending', 'rejected');
    END IF;
END $$;

DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'access_request_status') THEN
        CREATE TYPE public.access_request_status AS ENUM ('pending', 'approved', 'rejected');
    END IF;
END $$;

-- ============================================================================
-- STEP 2: APP SETTINGS (CENTRAL BRAIN)
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.app_settings (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    setting_key TEXT NOT NULL UNIQUE,
    setting_value TEXT NOT NULL,
    updated_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

ALTER TABLE public.app_settings
DROP CONSTRAINT IF EXISTS app_settings_signup_mode_check;

ALTER TABLE public.app_settings
ADD CONSTRAINT app_settings_signup_mode_check
CHECK (
    setting_key <> 'signup_mode' OR setting_value IN ('OPEN', 'GATED')
);

-- Seed default signup mode (OPEN)
INSERT INTO public.app_settings (setting_key, setting_value)
VALUES ('signup_mode', 'OPEN')
ON CONFLICT (setting_key) DO NOTHING;

-- ============================================================================
-- STEP 3: USER ACCESS STATUS (PASSPORT)
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.user_access (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
    status public.access_status NOT NULL DEFAULT 'pending',
    reason TEXT,
    decided_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    decided_at TIMESTAMP WITH TIME ZONE,
    source TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_user_access_status ON public.user_access(status);

-- ============================================================================
-- STEP 4: WAITLIST / ACCESS REQUESTS (INBOX)
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.access_requests (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    email TEXT NOT NULL,
    status public.access_request_status NOT NULL DEFAULT 'pending',
    source TEXT,
    notes TEXT,
    decided_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    decided_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE UNIQUE INDEX IF NOT EXISTS access_requests_email_unique
ON public.access_requests (LOWER(email));

CREATE UNIQUE INDEX IF NOT EXISTS access_requests_user_unique
ON public.access_requests (user_id)
WHERE user_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_access_requests_status
ON public.access_requests (status);

-- ============================================================================
-- STEP 5: UPDATED_AT TRIGGERS (REUSE handle_updated_at)
-- ============================================================================

DROP TRIGGER IF EXISTS handle_updated_at_app_settings ON public.app_settings;
CREATE TRIGGER handle_updated_at_app_settings
BEFORE UPDATE ON public.app_settings
FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

DROP TRIGGER IF EXISTS handle_updated_at_user_access ON public.user_access;
CREATE TRIGGER handle_updated_at_user_access
BEFORE UPDATE ON public.user_access
FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

DROP TRIGGER IF EXISTS handle_updated_at_access_requests ON public.access_requests;
CREATE TRIGGER handle_updated_at_access_requests
BEFORE UPDATE ON public.access_requests
FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

-- ============================================================================
-- STEP 6: RLS POLICIES
-- ============================================================================

ALTER TABLE public.app_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_access ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.access_requests ENABLE ROW LEVEL SECURITY;

-- App settings: admins only
DROP POLICY IF EXISTS "Admins can manage app settings" ON public.app_settings;
CREATE POLICY "Admins can manage app settings" ON public.app_settings
    FOR ALL
    USING (public.is_admin())
    WITH CHECK (public.is_admin());

-- User access: users can view own, admins can manage
DROP POLICY IF EXISTS "Users can view own access status" ON public.user_access;
CREATE POLICY "Users can view own access status" ON public.user_access
    FOR SELECT
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can self-create pending access status" ON public.user_access;
CREATE POLICY "Users can self-create pending access status" ON public.user_access
    FOR INSERT
    WITH CHECK (auth.uid() = user_id AND status = 'pending');

DROP POLICY IF EXISTS "Admins can manage access status" ON public.user_access;
CREATE POLICY "Admins can manage access status" ON public.user_access
    FOR ALL
    USING (public.is_admin())
    WITH CHECK (public.is_admin());

-- Access requests: users can create/view own, admins can manage
DROP POLICY IF EXISTS "Users can create own access request" ON public.access_requests;
CREATE POLICY "Users can create own access request" ON public.access_requests
    FOR INSERT
    WITH CHECK (auth.uid() = user_id AND status = 'pending');

DROP POLICY IF EXISTS "Users can view own access request" ON public.access_requests;
CREATE POLICY "Users can view own access request" ON public.access_requests
    FOR SELECT
    USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Admins can manage access requests" ON public.access_requests;
CREATE POLICY "Admins can manage access requests" ON public.access_requests
    FOR ALL
    USING (public.is_admin())
    WITH CHECK (public.is_admin());

-- ============================================================================
-- STEP 7: DEFAULT ACCESS STATUS ASSIGNMENT (ON SIGNUP)
-- ============================================================================

CREATE OR REPLACE FUNCTION public.assign_access_status_on_signup()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
DECLARE
    v_mode TEXT;
    v_status public.access_status;
BEGIN
    -- Default to GATED if settings are missing or invalid (fail-closed)
    SELECT CASE
        WHEN setting_value = 'OPEN' THEN 'OPEN'
        WHEN setting_value = 'GATED' THEN 'GATED'
        ELSE 'GATED'
    END
    INTO v_mode
    FROM public.app_settings
    WHERE setting_key = 'signup_mode'
    LIMIT 1;

    IF v_mode IS NULL THEN
        v_mode := 'GATED';
    END IF;

    v_status := CASE WHEN v_mode = 'OPEN'
        THEN 'active'::public.access_status
        ELSE 'pending'::public.access_status
    END;

    INSERT INTO public.user_access (user_id, status, source)
    VALUES (NEW.id, v_status, 'auto_signup')
    ON CONFLICT (user_id) DO NOTHING;

    RETURN NEW;
END;
$$;

DROP TRIGGER IF EXISTS on_auth_user_created_access_status ON auth.users;
CREATE TRIGGER on_auth_user_created_access_status
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.assign_access_status_on_signup();

-- Backfill existing users as active (do not retroactively lock)
INSERT INTO public.user_access (user_id, status, source)
SELECT id, 'active'::public.access_status, 'backfill'
FROM auth.users
ON CONFLICT (user_id) DO NOTHING;

-- ============================================================================
-- VERIFICATION QUERIES (RUN MANUALLY)
-- ============================================================================
-- SELECT * FROM public.app_settings WHERE setting_key = 'signup_mode';
-- SELECT status, COUNT(*) FROM public.user_access GROUP BY status;
-- SELECT * FROM public.access_requests ORDER BY created_at DESC LIMIT 5;
-- SELECT proname FROM pg_proc WHERE proname = 'assign_access_status_on_signup';

-- ============================================================================
-- ROLLBACK (MANUAL)
-- ============================================================================
-- DROP TRIGGER IF EXISTS on_auth_user_created_access_status ON auth.users;
-- DROP FUNCTION IF EXISTS public.assign_access_status_on_signup();
-- DROP TABLE IF EXISTS public.access_requests;
-- DROP TABLE IF EXISTS public.user_access;
-- DROP TABLE IF EXISTS public.app_settings;
-- DROP TYPE IF EXISTS public.access_request_status;
-- DROP TYPE IF EXISTS public.access_status;
-- DROP TYPE IF EXISTS public.signup_mode;
````

## File: docs/migrations/024_access_control_rls.sql
````sql
-- ============================================================================
-- Migration 024: Access Control RLS Gate for Attempts/Responses
-- ============================================================================
-- Purpose: Prevent non-active users from creating attempts or writing responses.
-- Dependencies: 023_access_control_foundations.sql (user_access table + enums)
-- ============================================================================

-- --------------------------------------------------------------------------
-- STEP 1: Attempts INSERT policy (require active access or admin)
-- --------------------------------------------------------------------------

DROP POLICY IF EXISTS "Users can create attempts within limit" ON public.attempts;

CREATE POLICY "Users can create attempts within limit" ON public.attempts
    FOR INSERT TO authenticated
    WITH CHECK (
        auth.uid() = user_id
        AND (
            public.is_admin()
            OR EXISTS (
                SELECT 1
                FROM public.user_access ua
                WHERE ua.user_id = auth.uid()
                  AND ua.status = 'active'
            )
        )
        AND (
            (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id) IS NULL
            OR (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id) <= 0
            OR (
                SELECT COUNT(*)
                FROM public.attempts a
                WHERE a.user_id = auth.uid()
                  AND a.paper_id = attempts.paper_id
                  AND a.status <> 'expired'
            ) < (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id)
        )
    );

-- --------------------------------------------------------------------------
-- STEP 2: Responses INSERT/UPDATE policies (require active access or admin)
-- --------------------------------------------------------------------------

DROP POLICY IF EXISTS "Users can create their own responses" ON public.responses;
CREATE POLICY "Users can create their own responses" ON public.responses
    FOR INSERT TO authenticated
    WITH CHECK (
        attempt_id IN (
            SELECT id
            FROM public.attempts
            WHERE user_id = auth.uid()
              AND status IN ('in_progress', 'paused')
        )
        AND (
            public.is_admin()
            OR EXISTS (
                SELECT 1
                FROM public.user_access ua
                WHERE ua.user_id = auth.uid()
                  AND ua.status = 'active'
            )
        )
    );

DROP POLICY IF EXISTS "Users can update their own responses" ON public.responses;
CREATE POLICY "Users can update their own responses" ON public.responses
    FOR UPDATE TO authenticated
    USING (
        attempt_id IN (
            SELECT id
            FROM public.attempts
            WHERE user_id = auth.uid()
              AND status IN ('in_progress', 'paused')
        )
    )
    WITH CHECK (
        attempt_id IN (
            SELECT id
            FROM public.attempts
            WHERE user_id = auth.uid()
              AND status IN ('in_progress', 'paused')
        )
        AND (
            public.is_admin()
            OR EXISTS (
                SELECT 1
                FROM public.user_access ua
                WHERE ua.user_id = auth.uid()
                  AND ua.status = 'active'
            )
        )
    );

-- ============================================================================
-- VERIFICATION (RUN MANUALLY)
-- ============================================================================
-- As pending user:
--   INSERT INTO attempts (...) should fail.
--   INSERT/UPDATE responses should fail.
-- As active user:
--   INSERT INTO attempts (...) should succeed (within attempt limit).

Now I see the issue. The code is using window.location.origin which is correct on the client side. The problem is that Supabase needs the redirect URL whitelisted, and after Google auth completes, Supabase redirects back - but if the URL isn't in the whitelist OR the cookies aren't being set properly, it fails.

Let me check the Supabase client configuration:

Read client.ts, lines 1 to 50

The code looks correct. The issue is external configuration in Supabase and Google Cloud Console.

Here's the exact problem and fix:

When a user signs in via nexams.online, Google OAuth redirects to Supabase, then Supabase redirects back to nexams.online/auth/callback. But if nexams.online isn't properly configured in:

Supabase Auth URL Configuration
Google Cloud Console OAuth Credentials
...then the auth fails silently and the user bounces back to landing.

Fix Step 1: Supabase Dashboard
Go to Supabase → Authentication → URL Configuration:

Site URL: https://nexams.online
Redirect URLs (add ALL of these):
Fix Step 2: Google Cloud Console
Go to Google Cloud Console → APIs & Services → Credentials → OAuth 2.0 Client IDs (the one with ID 649504644405-120c3fib9ddt41us9vs0a6fv2h84bi7e):

In Authorized redirect URIs, add:

This is Supabase's callback URL that Google redirects to. Without this, Google blocks the auth.

Fix Step 3: Netlify Environment Variable
In Netlify → Site settings → Build & deploy → Environment variables:

Then trigger a redeploy.

Fix Step 4: Test
Open incognito browser
Go to https://nexams.online
Click "Sign in with Google"
You should land on /dashboard
The #1 most likely cause is the Google Cloud Console redirect URI is missing. That 649504644405-... client ID must have Supabase's callback URL whitelisted.

Cla
````

## File: docs/migrations/026_access_control_auth_delete_cleanup.sql
````sql
-- ============================================================================
-- Migration 026: Cleanup Access Control Rows on Auth User Deletion
-- ============================================================================
-- Purpose:
--   Remove access control rows when an auth user is deleted to prevent
--   zombie access requests and stale access status records.
-- ============================================================================

CREATE OR REPLACE FUNCTION public.handle_auth_user_delete()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
BEGIN
    -- Delete responses explicitly in case FK cascade is missing.
    DELETE FROM public.responses
    WHERE attempt_id IN (SELECT id FROM public.attempts WHERE user_id = OLD.id);

    -- Delete attempts for the auth user.
    DELETE FROM public.attempts WHERE user_id = OLD.id;

    -- Remove access control rows tied to the deleted user.
    DELETE FROM public.user_access WHERE user_id = OLD.id;
    DELETE FROM public.access_requests WHERE user_id = OLD.id;

    RETURN OLD;
END;
$$;

DROP TRIGGER IF EXISTS on_auth_user_deleted_cleanup ON auth.users;
CREATE TRIGGER on_auth_user_deleted_cleanup
    AFTER DELETE ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_auth_user_delete();

-- ============================================================================
-- Verification
-- ==========================================================================
-- 1) Delete a user from auth.users in Supabase.
-- 2) Confirm access control rows are removed:
--    SELECT * FROM public.user_access WHERE user_id = '<deleted_user_id>';
--    SELECT * FROM public.access_requests WHERE user_id = '<deleted_user_id>';
````

## File: docs/migrations/027_access_requests_user_update_policy.sql
````sql
-- ============================================================================
-- Migration 027: Allow Users to Re-Submit Access Requests
-- ============================================================================
-- Purpose:
--   Enable authenticated users to update their own access_requests row
--   to reset status to pending after deletion/re-registration.
-- ============================================================================

ALTER TABLE public.access_requests ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can update own access request" ON public.access_requests;
CREATE POLICY "Users can update own access request" ON public.access_requests
    FOR UPDATE
    USING (
        auth.uid() = user_id
        OR (user_id IS NULL AND lower(email) = lower(auth.jwt() ->> 'email'))
    )
    WITH CHECK (
        auth.uid() = user_id
        AND status = 'pending'
    );

-- ============================================================================
-- Verification
-- ============================================================================
-- 1) Sign in as a user with a previously approved request (deleted & re-created).
-- 2) Submit request access.
-- 3) Confirm row updates:
--    SELECT * FROM public.access_requests WHERE user_id = auth.uid();
````

## File: docs/migrations/028_cleanup_orphaned_access_control_rows.sql
````sql
-- ============================================================================
-- Migration 028: Cleanup Orphaned Access Control Rows
-- ============================================================================
-- Purpose:
--   Remove access_requests / user_access / user_roles rows that no longer
--   reference an existing auth.users record ("ghost" rows).
-- ============================================================================

-- Access requests tied to deleted auth users or left with NULL user_id
DELETE FROM public.access_requests
WHERE user_id IS NULL
   OR user_id NOT IN (SELECT id FROM auth.users);

-- User access rows for deleted auth users
DELETE FROM public.user_access
WHERE user_id NOT IN (SELECT id FROM auth.users);

-- User roles for deleted auth users (if RBAC is enabled)
DELETE FROM public.user_roles
WHERE user_id NOT IN (SELECT id FROM auth.users);

-- ============================================================================
-- Verification
-- ============================================================================
-- SELECT COUNT(*) FROM public.access_requests WHERE user_id IS NULL;
-- SELECT COUNT(*) FROM public.access_requests WHERE user_id NOT IN (SELECT id FROM auth.users);
-- SELECT COUNT(*) FROM public.user_access WHERE user_id NOT IN (SELECT id FROM auth.users);
-- SELECT COUNT(*) FROM public.user_roles WHERE user_id NOT IN (SELECT id FROM auth.users);
````

## File: docs/migrations/029_fix_access_requests_fk_cascade.sql
````sql
-- ============================================================================
-- Migration 029: Fix access_requests FK + Cleanup Trigger
-- ============================================================================
-- Root Cause:
--   access_requests.user_id has ON DELETE SET NULL. When a user is deleted
--   from auth.users, the FK nullifies user_id BEFORE our AFTER DELETE trigger
--   fires. The trigger then cannot find the row to delete, leaving a "zombie"
--   row that blocks re-registration via the email unique index.
--
-- Fix:
--   1) Change FK to ON DELETE CASCADE so rows are auto-deleted with the user
--   2) Replace the cleanup trigger with BEFORE DELETE so it runs before cascades
--   3) Purge existing orphaned rows (user_id IS NULL)
-- ============================================================================

-- ============================================================================
-- STEP 1: Purge existing orphaned rows first
-- ============================================================================

DELETE FROM public.access_requests
WHERE user_id IS NULL
   OR user_id NOT IN (SELECT id FROM auth.users);

DELETE FROM public.user_access
WHERE user_id NOT IN (SELECT id FROM auth.users);

-- ============================================================================
-- STEP 2: Change FK from ON DELETE SET NULL to ON DELETE CASCADE
-- ============================================================================

-- Drop the existing FK constraint on user_id
ALTER TABLE public.access_requests
    DROP CONSTRAINT IF EXISTS access_requests_user_id_fkey;

-- Re-add with CASCADE
ALTER TABLE public.access_requests
    ADD CONSTRAINT access_requests_user_id_fkey
    FOREIGN KEY (user_id) REFERENCES auth.users(id)
    ON DELETE CASCADE;

-- ============================================================================
-- STEP 3: Fix the cleanup trigger to use BEFORE DELETE
-- ============================================================================
-- This ensures our cleanup code runs BEFORE FK cascades null/delete the rows.

CREATE OR REPLACE FUNCTION public.handle_auth_user_delete()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
BEGIN
    -- Delete responses explicitly in case FK cascade is missing.
    DELETE FROM public.responses
    WHERE attempt_id IN (SELECT id FROM public.attempts WHERE user_id = OLD.id);

    -- Delete attempts for the auth user.
    DELETE FROM public.attempts WHERE user_id = OLD.id;

    -- Access control cleanup (belt-and-suspenders with CASCADE)
    DELETE FROM public.access_requests WHERE user_id = OLD.id;
    DELETE FROM public.user_access WHERE user_id = OLD.id;

    RETURN OLD;
END;
$$;

-- Switch from AFTER to BEFORE so it runs before FK cascades
DROP TRIGGER IF EXISTS on_auth_user_deleted_cleanup ON auth.users;
CREATE TRIGGER on_auth_user_deleted_cleanup
    BEFORE DELETE ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_auth_user_delete();

-- ============================================================================
-- STEP 4: Fix RLS - allow users to update orphaned rows matched by email
-- ============================================================================

DROP POLICY IF EXISTS "Users can update own access request" ON public.access_requests;
CREATE POLICY "Users can update own access request" ON public.access_requests
    FOR UPDATE
    USING (
        auth.uid() = user_id
        OR (user_id IS NULL AND lower(email) = lower(auth.jwt() ->> 'email'))
    )
    WITH CHECK (
        status = 'pending'
    );

-- Also allow users to delete their own rejected request and re-insert
DROP POLICY IF EXISTS "Users can delete own rejected request" ON public.access_requests;
CREATE POLICY "Users can delete own rejected request" ON public.access_requests
    FOR DELETE
    USING (auth.uid() = user_id);

-- ============================================================================
-- Verification
-- ============================================================================
-- SELECT COUNT(*) FROM public.access_requests WHERE user_id IS NULL;
-- \d public.access_requests  -- Verify FK is ON DELETE CASCADE
-- SELECT tgname, tgtype FROM pg_trigger WHERE tgname = 'on_auth_user_deleted_cleanup';
````

## File: docs/migrations/030_add_telemetry_columns.sql
````sql
-- ============================================================================
-- Migration 030: Add Telemetry & Granular Difficulty Columns
-- ============================================================================
-- Purpose:
--   Add lightweight JSONB columns for behavioral telemetry without new tables,
--   plus granular timing fields for question difficulty logic.
-- ============================================================================

-- 1) Store behavioral replay data per attempt
ALTER TABLE public.attempts
ADD COLUMN IF NOT EXISTS telemetry_log JSONB DEFAULT '[]'::jsonb;

-- 2) Track answer switching / timeline events per response
ALTER TABLE public.responses
ADD COLUMN IF NOT EXISTS answer_history JSONB DEFAULT '[]'::jsonb;

-- 3) Add granular timing to questions
ALTER TABLE public.questions
ADD COLUMN IF NOT EXISTS ideal_time_seconds INTEGER DEFAULT 180;

-- Optional: finer difficulty ranking (if needed later)
ALTER TABLE public.questions
ADD COLUMN IF NOT EXISTS difficulty_index INTEGER;

-- ============================================================================
-- Verification
-- ============================================================================
-- \d public.attempts
-- \d public.responses
-- \d public.questions
````

## File: docs/migrations/031_add_ai_analysis_columns.sql
````sql
-- ============================================================================
-- Migration 031: Add AI Analysis Lifecycle Columns to Attempts
-- ============================================================================
-- Purpose:
--   Add a small state machine for AI analysis requests so the
--   request → export → process lifecycle is robust and auditable.
--   Also snapshot the paper version at attempt time to prevent
--   post-attempt paper edits from corrupting AI analysis reports.
--
-- Depends on: 030_add_telemetry_columns.sql (telemetry_log, answer_history)
-- Safe to re-run: All statements are idempotent (IF NOT EXISTS / DO $$ guards)
-- RLS impact: NONE — no policies added, modified, or removed.
-- ============================================================================

-- ─────────────────────────────────────────────────────────────────────────────
-- 1) Create enum type for AI analysis status
-- ─────────────────────────────────────────────────────────────────────────────
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'ai_analysis_status_type') THEN
        CREATE TYPE public.ai_analysis_status_type AS ENUM (
            'none',        -- default: no analysis requested
            'requested',   -- user/admin clicked "Request AI Analysis"
            'exported',    -- composite context JSON was downloaded
            'processed',   -- AI model finished processing (future use)
            'failed'       -- export or processing encountered an error
        );
    END IF;
END
$$;

COMMENT ON TYPE public.ai_analysis_status_type IS
    'Lifecycle states for AI analysis: none → requested → exported → processed | failed';

-- ─────────────────────────────────────────────────────────────────────────────
-- 2) Add AI analysis lifecycle columns to attempts
-- ─────────────────────────────────────────────────────────────────────────────

-- 2a) Status column (enum with safe default)
ALTER TABLE public.attempts
ADD COLUMN IF NOT EXISTS ai_analysis_status public.ai_analysis_status_type
    NOT NULL DEFAULT 'none';

-- 2b) Timestamp: when analysis was first requested
ALTER TABLE public.attempts
ADD COLUMN IF NOT EXISTS ai_analysis_requested_at TIMESTAMPTZ;

-- 2c) Timestamp: when composite context was exported/downloaded
ALTER TABLE public.attempts
ADD COLUMN IF NOT EXISTS ai_analysis_exported_at TIMESTAMPTZ;

-- 2d) Error message if export or processing failed
ALTER TABLE public.attempts
ADD COLUMN IF NOT EXISTS ai_analysis_error TEXT;

-- ─────────────────────────────────────────────────────────────────────────────
-- 3) Snapshot paper version at attempt time
-- ─────────────────────────────────────────────────────────────────────────────
-- Stores papers.latest_ingest_run_id at the moment the attempt is created.
-- This ensures AI analysis always references the exact paper version the
-- student saw, even if the paper is re-ingested later.

DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_schema = 'public'
          AND table_name   = 'attempts'
          AND column_name  = 'paper_ingest_run_id'
    ) THEN
        ALTER TABLE public.attempts
        ADD COLUMN paper_ingest_run_id UUID;

        -- FK to paper_ingest_runs (no CASCADE — orphan is acceptable, we keep the UUID)
        ALTER TABLE public.attempts
        ADD CONSTRAINT fk_attempts_paper_ingest_run
            FOREIGN KEY (paper_ingest_run_id)
            REFERENCES public.paper_ingest_runs(id)
            ON DELETE SET NULL;
    END IF;
END
$$;

COMMENT ON COLUMN public.attempts.paper_ingest_run_id IS
    'Snapshot of papers.latest_ingest_run_id at attempt creation time. '
    'Ensures AI analysis references the exact paper version the student saw.';

-- ─────────────────────────────────────────────────────────────────────────────
-- 4) Backfill existing rows
-- ─────────────────────────────────────────────────────────────────────────────
-- ai_analysis_status defaults to 'none' via column default, so existing rows
-- are already correct. paper_ingest_run_id is nullable, so no backfill needed.
-- Explicit backfill for safety (no-op if default already applied):
UPDATE public.attempts
SET ai_analysis_status = 'none'
WHERE ai_analysis_status IS NULL;

-- ─────────────────────────────────────────────────────────────────────────────
-- 5) Indexes for admin dashboard queries
-- ─────────────────────────────────────────────────────────────────────────────
-- Fast filter: "show me all attempts that have been requested for analysis"
-- + sorted by most recent submission first.
CREATE INDEX IF NOT EXISTS idx_attempts_ai_analysis_status_submitted
    ON public.attempts (ai_analysis_status, submitted_at DESC);

-- Fast lookup: "find all attempts for a specific paper ingest run"
CREATE INDEX IF NOT EXISTS idx_attempts_paper_ingest_run_id
    ON public.attempts (paper_ingest_run_id)
    WHERE paper_ingest_run_id IS NOT NULL;

-- ─────────────────────────────────────────────────────────────────────────────
-- 6) Column comments for documentation
-- ─────────────────────────────────────────────────────────────────────────────
COMMENT ON COLUMN public.attempts.ai_analysis_status IS
    'AI analysis lifecycle state: none → requested → exported → processed | failed';

COMMENT ON COLUMN public.attempts.ai_analysis_requested_at IS
    'Timestamp when AI analysis was first requested for this attempt';

COMMENT ON COLUMN public.attempts.ai_analysis_exported_at IS
    'Timestamp when composite context JSON was exported/downloaded';

COMMENT ON COLUMN public.attempts.ai_analysis_error IS
    'Error message if AI analysis export or processing failed (nullable)';

-- ============================================================================
-- Verification Queries (run manually to confirm)
-- ============================================================================
-- Count attempts by AI analysis status:
--   SELECT ai_analysis_status, COUNT(*) FROM public.attempts GROUP BY 1;
--
-- Show recent requested attempts:
--   SELECT id, user_id, paper_id, ai_analysis_status, ai_analysis_requested_at
--   FROM public.attempts
--   WHERE ai_analysis_status != 'none'
--   ORDER BY ai_analysis_requested_at DESC NULLS LAST
--   LIMIT 20;
--
-- Verify columns exist:
--   SELECT column_name, data_type, column_default, is_nullable
--   FROM information_schema.columns
--   WHERE table_schema = 'public'
--     AND table_name = 'attempts'
--     AND column_name LIKE 'ai_analysis%'
--   ORDER BY ordinal_position;
--
-- Verify paper_ingest_run_id:
--   SELECT column_name, data_type, is_nullable
--   FROM information_schema.columns
--   WHERE table_schema = 'public'
--     AND table_name = 'attempts'
--     AND column_name = 'paper_ingest_run_id';
--
-- Verify indexes:
--   SELECT indexname, indexdef
--   FROM pg_indexes
--   WHERE tablename = 'attempts'
--     AND indexname LIKE '%ai_analysis%' OR indexname LIKE '%paper_ingest_run%';
-- ============================================================================
````

## File: docs/Milestone_Change_Log.md
````markdown
# M5 Architecture Log (Milestone 5 - Results & Analytics Engine)

> **Core Philosophy**: "Log the Delta -> Code the Change"
> **Created**: January 21, 2026
> **Status**: ACTIVE

This document serves as the evolutionary change log for Milestone 5. No code or database changes are made without first documenting the "Before vs. After" state here.

---

## Change 001: Server-Side Scoring Engine Implementation

### Change Title
TypeScript-based Scoring Engine (Replace RPC Dependency)

### Context (Before)
- The `submitExam` action in `actions.ts` relies on a Supabase RPC function `finalize_attempt(attempt_id)`
- This creates a logic split where business logic (marking scheme) lives in SQL while application logic lives in TypeScript
- Debugging TITA normalization in SQL is difficult
- The RPC function may not exist in the current Supabase instance

### Proposal (After)
- Create `src/features/exam-engine/lib/scoring.ts` with pure TypeScript scoring logic
- The `submitExam` action will:
  1. Fetch all questions WITH correct_answer from `questions` table (server-side only)
  2. Fetch all user responses from `responses` table
  3. Calculate scores using TypeScript `calculateScore()` function
  4. Apply TITA normalization (trim, lowercase, numeric parsing)
  5. Apply CAT marking scheme: +3 correct, -1 wrong MCQ, 0 wrong TITA, 0 unanswered
  6. Update `attempts` table with calculated scores
  7. Update `responses` table with `is_correct` and `marks_obtained`

### Rationale
- Single source of truth for scoring logic in TypeScript
- Easier unit testing and debugging
- No dependency on external RPC function deployment
- Aligns with Feature-Sliced Design principles

### Schema Impact
None - uses existing columns in `attempts` and `responses` tables

### Migration SQL
None required for this change

### Status: ✅ COMPLETED

**Implementation Details:**
- Created `src/features/exam-engine/lib/scoring.ts`
- Implemented `calculateScore()`, `normalizeString()`, `parseAsNumber()`, `compareAnswers()`, `calculateQuestionMarks()`, `calculateTimeTaken()`
- Updated `submitExam()` in `actions.ts` to use TypeScript scoring instead of RPC
- Exports added to `lib/index.ts`
- Legacy `finalize_attempt(UUID)` SQL path disabled (see Phase 1 hardening migration)
- Unit tests added for scoring logic

---

## Change 002: Enhanced Result Page Components

### Change Title
Modular Result Dashboard with Sectional Analysis

### Context (Before)
- Result page exists at `src/app/result/[attemptId]/page.tsx`
- Basic display of scores, inline styles, no component separation
- Limited analytics presentation

### Proposal (After)
- Create modular components:
  - `ResultHeader.tsx` - Summary card with total score, accuracy metrics
  - `SectionalPerformance.tsx` - Section-wise breakdown table/grid
  - `QuestionAnalysis.tsx` - Detailed question-by-question review
- Use proper Tailwind CSS styling
- Display:
  - Total score / max score
  - Section-wise scores (VARC, DILR, QA)
  - Correct/Incorrect/Unanswered counts
  - Accuracy percentage
  - Time taken
  - Rank/Percentile (when available)

### Rationale
- Better user experience
- Modular components for maintainability
- Matches MVP Plan "Detailed Analysis Report" requirements

### Schema Impact
None

### Status: ✅ COMPLETED

**Implementation Details:**
- Created `src/features/exam-engine/ui/ResultHeader.tsx` - Summary card with score, accuracy, percentile, rank, time taken
- Created `src/features/exam-engine/ui/SectionalPerformance.tsx` - Section-wise breakdown with progress bars
- Created `src/features/exam-engine/ui/QuestionAnalysis.tsx` - Client component with filtering, expandable questions, solution display
- Updated `src/app/result/[attemptId]/page.tsx` - Uses new components, fetches questions/responses for analysis
- Exports added to `ui/index.ts`
- Full Tailwind CSS styling applied

---

## Change 003: Scoring Utility with TITA Normalization

### Change Title
TITA Answer Normalization for Accurate Scoring

### Context (Before)
- No TITA normalization logic exists
- Direct string comparison would fail for "42" vs "42 " (trailing space)
- No handling for numeric equivalence ("42" vs "42.0")

### Proposal (After)
Create normalization utility in `scoring.ts`:
```typescript
const normalize = (val: string | number | null): string => {
  if (val === null || val === undefined) return '';
  return String(val).trim().toLowerCase().replace(/\s+/g, ' ');
};
```

For TITA questions:
1. Trim whitespace
2. Convert to lowercase (for text answers)
3. Attempt numeric parsing - if both parse as numbers, compare numerically
4. Handle edge cases: multiple spaces, trailing zeros for decimals

### Rationale
- Prevents user frustration from incorrect marking due to formatting
- Matches expected CAT scoring behavior
- Robust edge case handling

### Schema Impact
None

### Status: ✅ COMPLETED

**Implementation Details:**
- Implemented in `scoring.ts` with `normalizeString()` and `parseAsNumber()` functions
- Handles whitespace, case-insensitivity, numeric equivalence
- Used in `compareAnswers()` for TITA scoring

---

## Change 004: Supabase Schema Extension for Analytics

### Change Title
Add Scoring and Analytics Columns to Attempts Table

### Context (Before)
The `attempts` table may lack some analytics columns needed for complete result storage:
- `total_score` exists but may be nullable
- `section_scores` JSONB may not exist
- Time metrics may need enhancement

### Proposal (After)
Ensure the following columns exist (add if missing):
```sql
ALTER TABLE public.attempts
ADD COLUMN IF NOT EXISTS total_score INTEGER DEFAULT NULL,
ADD COLUMN IF NOT EXISTS section_scores JSONB DEFAULT '{}'::jsonb,
ADD COLUMN IF NOT EXISTS correct_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS incorrect_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS unanswered_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS time_taken_seconds INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS completed_at TIMESTAMPTZ DEFAULT NULL,
ADD COLUMN IF NOT EXISTS accuracy DECIMAL(5,2) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS attempt_rate DECIMAL(5,2) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS max_possible_score INTEGER DEFAULT NULL;

-- Indexing for Leaderboard performance
CREATE INDEX IF NOT EXISTS idx_attempts_total_score ON public.attempts (total_score DESC);
CREATE INDEX IF NOT EXISTS idx_attempts_paper_id_score ON public.attempts (paper_id, total_score DESC);
```

### Rationale
- Denormalization for analytics prevents read amplification
- Computed persistence maintains historical integrity
- JSONB for flexible section-wise storage
- Indexes for future leaderboard queries

### Schema Impact
EXTERNAL - Requires Supabase SQL Editor execution

### Migration SQL
See above

### Status: EXTERNAL DEPENDENCY - DOCUMENT FOR MANUAL EXECUTION

---

## Change 005: Response Table Scoring Fields

### Change Title
Ensure Response Table Has Scoring Fields

### Context (Before)
Need to verify `responses` table has:
- `is_correct` BOOLEAN
- `marks_obtained` DECIMAL

### Proposal (After)
```sql
ALTER TABLE public.responses
ADD COLUMN IF NOT EXISTS is_correct BOOLEAN DEFAULT NULL,
ADD COLUMN IF NOT EXISTS marks_obtained DECIMAL(5,2) DEFAULT NULL;
```

### Rationale
- Per-question scoring for detailed analysis
- Enables question-by-question review in results

### Schema Impact
EXTERNAL - Requires Supabase SQL Editor execution

### Status: EXTERNAL DEPENDENCY - DOCUMENT FOR MANUAL EXECUTION

---

## Implementation Order

1. [x] Create Milestone_Change_Log.md (this document)
2. [x] Create scoring.ts utility
3. [x] Update actions.ts with TypeScript scoring logic
4. [x] Create Result page components (ResultHeader, SectionalPerformance, QuestionAnalysis)
5. [x] Update result page to use new components
6. [x] Document SQL migrations for external execution
7. [ ] Execute SQL migrations in Supabase (EXTERNAL)
8. [ ] Test full flow

---

## External Dependencies (Require Manual Action)

### Supabase Changes Required:
1. Execute schema migration SQL (Change 004, 005)
2. Verify RLS policies allow UPDATE on attempts by authenticated users
3. Verify INSERT policy on responses table

### Post-Code Deployment:
1. Run migration SQL in Supabase Dashboard -> SQL Editor
2. Verify indexes are created
3. Test with a sample exam submission

---

*Last Updated: January 21, 2026*

---

## Change 006: Security Audit P0 Fixes (Pre-Pilot Hardening)

### Change Title
Security Hardening for Pilot Launch - Rate Limiting, Timer Validation, Integrity Checks

### Context (Before)
- No rate limiting on API endpoints (frontend loop could overwhelm Supabase)
- Timer enforcement purely client-side (manipulable)
- No session locking (multi-device/tab exam abuse possible)
- No submission integrity validation (malicious question IDs possible)
- No security headers (XSS, clickjacking risks)

### Proposal (After)
1. **Rate Limiting** - In-memory per-user rate limiter:
   - `/api/save`: 60 saves per minute
   - `/api/submit`: 5 submissions per minute
   - Pilot-appropriate; upgrade to Redis/Upstash for production

2. **Server-Side Timer Validation** - `submitExam()` validates:
   - Maximum exam duration: 120 minutes (3 sections × 40 min)
   - Grace period: 2 minutes for network latency
   - Late submissions rejected with clear error

3. **Atomic Status Transitions** - Prevent race conditions:
   - Use `.eq('status', 'in_progress')` on updates to prevent double-submission

4. **Submission Integrity Checks**:
   - `saveResponse()` validates questionId belongs to attempt's paper
   - `submitExam()` filters invalid responses before scoring

5. **Security Headers** - Middleware applies:
   - `X-Content-Type-Options: nosniff`
   - `X-Frame-Options: SAMEORIGIN`
   - `X-XSS-Protection: 1; mode=block`
   - `Referrer-Policy: strict-origin-when-cross-origin`
   - `Cache-Control: no-store` (prevent caching exam content)

6. **Session Locking** (SQL migration prepared):
   - New columns: `session_token UUID`, `last_activity_at TIMESTAMPTZ`
   - Helper functions: `initialize_exam_session()`, `validate_session_token()`
   - Prevents multi-device abuse

### Files Modified
- `src/lib/rate-limit.ts` (NEW) - In-memory rate limiting utility
- `src/features/exam-engine/lib/actions.ts` - Timer validation, integrity checks
- `src/app/api/save/route.ts` - Rate limiting, status checks
- `src/app/api/submit/route.ts` - Rate limiting, uses submitExam action
- `middleware.ts` - Security headers

### Files Created
- `docs/migrations/002_session_locking.sql` - Session locking schema migration

### Schema Impact
EXTERNAL - Requires Supabase SQL Editor execution of `002_session_locking.sql`

### Rationale
- Protect against security vulnerabilities identified in audit
- Prevent abuse of Supabase free tier rate limits
- Ensure exam integrity for pilot launch

### Status: ✅ COMPLETED (Application Code)

**External Dependencies:**
- Execute `docs/migrations/002_session_locking.sql` in Supabase Dashboard
- Implement session token validation in save/submit routes (after migration)

---

## External Dependencies Update

### Supabase Changes Required:
1. Execute schema migration SQL (Change 004, 005)
2. **NEW: Execute session locking migration (Change 006 - `002_session_locking.sql`)**
3. Verify RLS policies allow UPDATE on attempts by authenticated users
4. Verify INSERT policy on responses table

---

## Change 007: Controlled Soft Launch Access Control

### Change Title
Signup Mode + Waitlist + Access Gate

### Context (Before)
- No global signup mode toggle; all new users were active by default.
- No waitlist or access request tracking.
- Access enforcement relied on auth only; pending users could start mocks.

### Proposal (After)
- Add `app_settings.signup_mode` (OPEN/GATED) with admin toggle.
- Add `user_access` (active/pending/rejected) assigned on signup (fail-closed).
- Add `access_requests` waitlist inbox (unique by email).
- Enforce active access in middleware, server actions, and RLS (attempts/responses).
- Add `/coming-soon` waitlist page and admin approvals UI.

### Files Modified
- `docs/migrations/023_access_control_foundations.sql`
- `docs/migrations/024_access_control_rls.sql`
- `middleware.ts`
- `src/lib/access-control.ts`
- `src/app/coming-soon/page.tsx`
- `src/app/admin/access-control/page.tsx`
- `src/app/admin/access-control/actions.ts`
- `src/lib/rate-limit.ts`
- `src/lib/telemetry.ts`

### Schema Impact
EXTERNAL - Requires Supabase SQL Editor execution of `023_access_control_foundations.sql` and `024_access_control_rls.sql`

### Status: COMPLETED (Application + DB migrations prepared)

---

*Last Updated: February 7, 2026*
````

## File: docs/PHASE_0_LAYOUT_GUARDRAILS.md
````markdown
# Phase 0 — Layout Refactor Guardrails

## Goal
Ship layout changes safely with a feature-flagged UI path while preserving current runtime behavior.

## Feature Flag
- `NEXT_PUBLIC_EXAM_LAYOUT_MODE` controls the runtime layout.
- Allowed values:
  - `current` (default)
  - `three-column`

## Definition of Done (per phase)
Run all of the following before marking a phase complete:
1. `pnpm lint`
2. `pnpm exec tsc --noEmit`
3. `pnpm build`
````

## File: docs/README.md
````markdown
# Documentation Index

This folder contains all project documentation. Start here to understand the codebase.

## Core Documentation

| Document | Description |
|----------|-------------|
| [BLUEPRINT.md](BLUEPRINT.md) | Feature anchors, milestones, and implementation status |
| [DECISIONS.md](DECISIONS.md) | Architecture decisions and rationale |
| [SCHEMA_SUPABASE.sql](SCHEMA_SUPABASE.sql) | Database schema snapshot (see migrations for latest) |
| [CONTENT-SCHEMA.md](CONTENT-SCHEMA.md) | Question/paper content format specification |

## Operational Docs

| Document | Description |
|----------|-------------|
| [Milestone_Change_Log.md](Milestone_Change_Log.md) | Release notes and milestone history |
| [AUDIT_QUERY_PATHS.md](AUDIT_QUERY_PATHS.md) | API and data flow audit notes |

## Migrations

SQL migration scripts in [`migrations/`](migrations/) folder (apply in numeric order):
- `002_session_locking.sql` - Session locking mechanism
- `003_question_container_architecture.sql` - Question container design
- `004_fetch_attempt_solutions.sql` - Solution fetching RPC
- `005_attempt_state_lockdown.sql` - Attempt state management
- `006_response_flags.sql` - Response flag system
- `006_force_resume_session.sql` - Force resume functionality
- `007_content_ingestion_phases.sql` - Export/import + versioned ingestion
- `008_ingestion_semantic_keys.sql` - Semantic keys + upsert support
- `009_attempt_submit_rls.sql` - Submit transition RLS
- `010_force_resume_lenient.sql` - Lenient force resume threshold
- `011_prevent_paper_delete_with_attempts.sql` - Prevent delete with attempts
- `012_phase1_security_hardening.sql` - Deprecated (use 013)
- `013_phase1_security_complete.sql` - Full Phase 1 security hardening
- `014_soften_submit_rls.sql` - Optional relaxations (use with care)
- `015_landing_assets.sql` - Landing assets table
- `016_bug_reports.sql` - Bug report table
- `017_bug_report_status.sql` - Bug report status enum
- `018_purge_attempts_on_auth_delete.sql` - Cleanup on auth delete
- `019_force_resume_ultra_lenient.sql` - Ultra lenient resume
- `020_pause_tracking.sql` - Pause tracking
- `021_validate_session_token_atomic.sql` - Session validation updates
- `022_validate_session_token_single_signature.sql` - Token signature hardening
- `023_access_control_foundations.sql` - Signup mode + user access + waitlist
- `024_access_control_rls.sql` - RLS gating for attempts/responses

Standalone migration files (legacy):
- `MIGRATION_CONTEXTS.sql`, `MIGRATION_M5_SCORING.sql`, `MIGRATION_M6_RBAC.sql`, `MIGRATION_RLS_VIEWS.sql`, `MIGRATION_STATS.sql`

## Archived / Historical

Documents in [`archive/`](archive/) are kept for reference but are **not canonical**:
- `SCHEMA_FIREBASE.md` - Firebase fallback schema (not in use)

## Research

Documents in [`research/`](research/) capture initial explorations:
- `stack-evaluation.md` - Original stack comparison (deployment now on Netlify)
- `convert_paper_metadata.py` - Paper conversion utility script
````

## File: docs/REFACTOR_PLAN_5_PROMPTS.md
````markdown
# Complete Refactor Plan - 5 Copilot Agent Prompts

> **Goal**: Fix the exam submit "ATTEMPT_NOT_FOUND" error and clean up the codebase architecture
> 
> **Commit**: `191409b` - "fix: race condition fixes for exam submit + middleware rewrite"
> 
> **Date**: February 2, 2026

---

## Current Problems Summary

1. **Duplicate ExamClient Components** - Two versions exist causing confusion
2. **Race Conditions** - Timer auto-submit vs manual submit (partially fixed)
3. **Session Token Flow** - Complex validation with multiple failure points
4. **Supabase Client Sprawl** - Multiple clients created inconsistently
5. **RLS Policy Complexity** - Hard to debug which policy is blocking
6. **No Centralized Error Handling** - Errors scattered across components

---

## Prompt 1: Consolidate ExamClient & Create Single Source of Truth

```
TASK: Consolidate the two ExamClient components into one authoritative version

CONTEXT:
- src/app/exam/[attemptId]/ExamClient.tsx (app router version)
- src/features/exam-engine/lib/ExamClient.tsx (feature version)
- Both have similar logic with race condition fixes already applied

DO:
1. Keep src/features/exam-engine/lib/ExamClient.tsx as the SINGLE source
2. Update src/app/exam/[attemptId]/page.tsx to import from features
3. DELETE src/app/exam/[attemptId]/ExamClient.tsx entirely
4. Ensure all imports across the codebase point to the consolidated version
5. Verify the mutex lock pattern (submitLockRef) is preserved
6. Test that the exam page still renders correctly

VERIFY:
- Run `pnpm type-check` - no errors
- Run `pnpm lint` - no errors  
- Manually test /exam/[attemptId] loads correctly
```

---

## Prompt 2: Centralize Supabase Client Creation

```
TASK: Create a single, centralized Supabase client factory pattern

CONTEXT:
- Currently creating Supabase clients in: middleware.ts, actions.ts, API routes, components
- Each creates its own instance with different cookie handling
- This causes session state inconsistencies

DO:
1. Create src/lib/supabase/clients.ts with:
   - createBrowserClient() - for client components
   - createServerClient(cookies) - for server components/actions
   - createRouteHandlerClient(cookies) - for API routes
   - getServiceRoleClient() - for admin operations (already exists)

2. Update all files to use the centralized factories:
   - src/features/exam-engine/lib/actions.ts
   - src/app/api/submit/route.ts
   - src/app/api/save/route.ts
   - src/app/api/pause/route.ts
   - src/app/api/session/route.ts
   - All admin API routes

3. Add JSDoc comments explaining when to use each client type

VERIFY:
- Run `pnpm type-check`
- Grep for `createServerClient` outside src/lib/supabase - should be minimal
- Test auth flow works end-to-end
```

---

## Prompt 3: Simplify Submit Flow & Add Comprehensive Logging

```
TASK: Refactor the exam submit flow to be linear and debuggable

CONTEXT:
- Current flow: Timer → useExamTimer → ExamLayout → ExamClient → actions.ts → API
- Multiple entry points for submit (timer auto-submit, manual button, beforeunload)
- Hard to trace where failures occur

DO:
1. Create src/features/exam-engine/lib/submitExam.ts as the SINGLE entry point:
   ```typescript
   export async function submitExam(params: {
     attemptId: string;
     sessionToken: string;
     responses: Record<string, UserResponse>;
     source: 'timer' | 'manual' | 'beforeunload';
   }): Promise<SubmitResult>
   ```

2. Add structured logging at every step:
   - [SUBMIT:START] source, attemptId, responseCount
   - [SUBMIT:VALIDATE] sessionToken status
   - [SUBMIT:SAVE] saving responses
   - [SUBMIT:STATUS] updating attempt status
   - [SUBMIT:COMPLETE] or [SUBMIT:ERROR] with details

3. Update ExamClient and ExamLayout to use the new submitExam function

4. Remove duplicate submit logic from:
   - useExamTimer hook (it should only CALL submitExam)
   - ExamLayout (should only call submitExam)

5. Add a debug panel (only in dev) showing submit state

VERIFY:
- Console shows clear [SUBMIT:*] logs during submission
- Only ONE code path for actual submission
- Run `pnpm type-check`
```

---

## Prompt 4: Fix RLS & Database Layer

```
TASK: Audit and fix the Supabase RLS policies for exam attempts

CONTEXT:
- ATTEMPT_NOT_FOUND error suggests RLS is blocking the query
- Multiple migration files with overlapping policies
- Service role bypasses RLS, hiding issues during admin testing

DO:
1. Create docs/migrations/015_rls_audit_and_fix.sql with:
   - DROP all existing attempt-related policies
   - CREATE clean, minimal policies:
     - attempts_select_own: user can SELECT their own attempts
     - attempts_update_own_in_progress: user can UPDATE if status='in_progress'
     - attempts_submit_own: user can UPDATE status to 'submitted' if currently 'in_progress'

2. Create a test script scripts/test-rls-policies.mjs that:
   - Creates a test user
   - Creates an attempt as that user
   - Verifies SELECT works
   - Verifies UPDATE works for in_progress
   - Verifies UPDATE to 'submitted' works
   - Cleans up test data

3. Document the expected RLS behavior in docs/RLS_POLICIES.md

4. Update the submitExam action to include better error messages:
   - If attempt not found: check if attemptId exists at all (service role query)
   - If exists but query failed: "RLS policy blocked access"
   - Include user_id and attempt_id in error for debugging

VERIFY:
- Run the RLS test script against local Supabase
- Submit flow should show clear error if RLS blocks
```

---

## Prompt 5: End-to-End Testing & Cleanup

```
TASK: Add E2E tests for critical flows and clean up dead code

CONTEXT:
- No automated tests for the submit flow
- Dead code from previous iterations
- Need confidence the refactored code works

DO:
1. Create src/features/exam-engine/lib/__tests__/submitExam.test.ts:
   - Test successful submission
   - Test mutex lock prevents double submit
   - Test handles network errors gracefully
   - Test handles RLS errors with clear message

2. Create src/features/exam-engine/lib/__tests__/examFlow.integration.test.ts:
   - Mock Supabase responses
   - Test full flow: start exam → answer questions → submit → verify result

3. Remove dead code:
   - Delete src/utils/update-session.ts (no longer used by middleware)
   - Remove any orphaned imports
   - Remove commented-out code blocks

4. Update docs/BLUEPRINT.md with:
   - New architecture diagram showing single submit flow
   - Updated file locations after consolidation
   - Testing instructions

5. Final verification checklist:
   - [ ] `pnpm type-check` passes
   - [ ] `pnpm lint` passes
   - [ ] `pnpm test` passes (if vitest configured)
   - [ ] Manual test: start exam, answer, submit, see results
   - [ ] Manual test: let timer expire, auto-submit works
   - [ ] Manual test: refresh during exam, session restored

VERIFY:
- All tests pass
- No TypeScript errors
- Submit works end-to-end
```

---

## Execution Order

| Prompt | Focus Area | Risk Level | Estimated Files Changed |
|--------|------------|------------|------------------------|
| 1 | ExamClient consolidation | Medium | 3-5 files |
| 2 | Supabase client factory | Medium | 10-15 files |
| 3 | Submit flow simplification | High | 5-8 files |
| 4 | RLS policies | High | 2-3 SQL files + 1 script |
| 5 | Testing & cleanup | Low | 5-10 files |

---

## Pre-Requisites Before Starting

1. **Push to GitHub** (fix the credential issue first):
   ```bash
   # Option 1: Use SSH
   git remote set-url origin git@github.com:Aakarsh-Arya/cat_mock_website.git
   git push origin main
   
   # Option 2: Re-authenticate via GitHub CLI
   gh auth login
   git push origin main
   ```

2. **Verify local Supabase is running** for RLS testing

3. **Create a test branch**:
   ```bash
   git checkout -b refactor/exam-submit-fix
   ```

---

## Rollback Plan

If any prompt causes breaking changes:

```bash
# Return to known good state
git checkout main
git reset --hard 191409b

# Or revert specific prompt's changes
git revert HEAD
```

---

## Success Criteria

After all 5 prompts:
- ✅ Single ExamClient component
- ✅ Centralized Supabase client factory
- ✅ One linear submit flow with logging
- ✅ Clean RLS policies with test script
- ✅ E2E tests for critical paths
- ✅ No TypeScript/lint errors
- ✅ Exam submit works reliably
````

## File: docs/research/convert_paper_metadata.py
````python
#!/usr/bin/env python3
"""
Convert a CAT paper metadata DOCX into the JSON schema used by scripts/import-paper.mjs
and optionally upload it to Supabase.

Usage:
  python docs/research/convert_paper_metadata.py --docx "/path/to/PAPER METADATA_CAT2024_slot1.docx" --out data/cat-2024-slot1.json --publish

Dependencies:
  pip install python-docx supabase python-dotenv

Env vars (same as import-paper.mjs):
  NEXT_PUBLIC_SUPABASE_URL
  SUPABASE_SERVICE_ROLE_KEY
"""

import argparse
import json
import os
import re
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List, Optional, Sequence

from docx import Document
from supabase import create_client, Client

# -----------------------------------------------------------------------------
# Parsing helpers
# -----------------------------------------------------------------------------

def _clean_text(text: str) -> str:
    return re.sub(r"\s+", " ", text).strip()


def _cell_text(cell) -> str:
    return _clean_text("\n".join(p.text for p in cell.paragraphs))


def _normalize_key(key: str) -> str:
    key = re.sub(r"[^A-Za-z0-9]+", "_", key).strip("_").lower()
    return key


def parse_paper_metadata(table) -> Dict[str, Any]:
    meta: Dict[str, Any] = {}
    for row in table.rows:
        if len(row.cells) < 2:
            continue
        key = _normalize_key(_cell_text(row.cells[0]))
        value = _cell_text(row.cells[1])
        if not key:
            continue
        meta[key] = value
    return meta


def parse_sections(meta: Dict[str, Any]) -> List[Dict[str, Any]]:
    sections: List[Dict[str, Any]] = []
    raw = meta.get("sections") or meta.get("section_breakup") or meta.get("sectionwise_breakup")
    if not raw:
        return sections

    lines = [p for chunk in raw.split("\n") for p in chunk.split(";") if p.strip()]
    for line in lines:
        parts = [p.strip() for p in re.split(r"[|,:]", line) if p.strip()]
        if len(parts) < 2:
            continue
        name = parts[0].upper()
        as_int = lambda x: int(float(x)) if x not in ("", None) else None  # noqa: E731
        try:
            questions = as_int(parts[1])
            time_val = as_int(parts[2]) if len(parts) > 2 else None
            marks_val = as_int(parts[3]) if len(parts) > 3 else None
        except ValueError:
            continue
        sections.append({
            "name": name,
            "questions": questions,
            "time": time_val,
            "marks": marks_val,
        })
    return sections


def detect_question_table(table) -> bool:
    headers = [_normalize_key(_cell_text(cell)) for cell in table.rows[0].cells]
    needed = {"question", "question_text", "question_number"}
    has_needed = any(h in needed for h in headers)
    has_answer = any("answer" in h for h in headers)
    return has_needed and has_answer


def parse_questions(tables: Sequence[Any]) -> List[Dict[str, Any]]:
    questions: List[Dict[str, Any]] = []
    for table in tables:
        if not table.rows:
            continue
        headers = [_normalize_key(_cell_text(cell)) for cell in table.rows[0].cells]
        if not detect_question_table(table):
            continue
        for row in table.rows[1:]:
            cells = row.cells
            row_map = {headers[i]: _cell_text(cells[i]) for i in range(min(len(headers), len(cells)))}
            q_text = row_map.get("question_text") or row_map.get("question")
            if not q_text:
                continue
            section = (row_map.get("section") or "").upper() or "VARC"
            q_type = (row_map.get("type") or row_map.get("question_type") or "MCQ").upper()
            q_num_raw = row_map.get("question_number") or row_map.get("qno") or row_map.get("sno")
            try:
                q_number = int(float(q_num_raw)) if q_num_raw else len(questions) + 1
            except ValueError:
                q_number = len(questions) + 1

            option_keys = [k for k in headers if re.match(r"option[a-d]", k)]
            options = [row_map.get(k) for k in option_keys if row_map.get(k)]
            if q_type == "MCQ" and not options:
                options = [row_map.get(k) for k in ["a", "b", "c", "d"] if row_map.get(k)]

            answer = row_map.get("answer") or row_map.get("correct_answer")
            difficulty = row_map.get("difficulty") or None
            topic = row_map.get("topic") or None
            subtopic = row_map.get("subtopic") or None
            solution = row_map.get("solution") or row_map.get("solution_text") or None

            q_entry = {
                "section": section or "VARC",
                "question_number": q_number,
                "question_text": q_text,
                "question_type": "TITA" if q_type == "TITA" else "MCQ",
                "options": options or None,
                "correct_answer": answer or "",
                "positive_marks": 3.0,
                "negative_marks": 0 if q_type == "TITA" else 1.0,
                "difficulty": difficulty,
                "topic": topic,
                "subtopic": subtopic,
                "solution_text": solution,
            }
            questions.append(q_entry)
    return questions


# -----------------------------------------------------------------------------
# Supabase upload
# -----------------------------------------------------------------------------

def get_supabase_client() -> Client:
    url = os.getenv("NEXT_PUBLIC_SUPABASE_URL") or os.getenv("SUPABASE_URL")
    key = os.getenv("SUPABASE_SERVICE_ROLE_KEY")
    if not url or not key:
        raise RuntimeError("Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY")
    return create_client(url, key)


def upsert_paper(client: Client, paper: Dict[str, Any]) -> Dict[str, Any]:
    existing = client.table("papers").select("id").eq("slug", paper["slug"]).maybe_single().execute()
    rows = existing.data if hasattr(existing, "data") else existing.get("data")
    paper_payload = {
        "slug": paper["slug"],
        "title": paper["title"],
        "description": paper.get("description"),
        "year": int(paper.get("year") or datetime.now().year),
        "total_questions": int(paper.get("total_questions") or len(paper.get("questions", []))),
        "total_marks": paper.get("total_marks") or 198,
        "duration_minutes": paper.get("duration_minutes") or 120,
        "sections": paper.get("sections") or [],
        "default_positive_marks": float(paper.get("default_positive_marks") or 3.0),
        "default_negative_marks": float(paper.get("default_negative_marks") or 1.0),
        "difficulty_level": paper.get("difficulty_level") or "cat-level",
        "is_free": bool(paper.get("is_free", True)),
        "published": bool(paper.get("published", False)),
        "available_from": paper.get("available_from") or None,
        "available_until": paper.get("available_until") or None,
    }

    if rows:
        paper_id = rows[0]["id"]
        res = client.table("papers").update(paper_payload).eq("id", paper_id).execute()
        return {"id": paper_id, **paper_payload, "_supabase": res}
    res = client.table("papers").insert(paper_payload).execute()
    paper_id = res.data[0]["id"]
    return {"id": paper_id, **paper_payload, "_supabase": res}


def replace_questions(client: Client, paper_id: int, questions: List[Dict[str, Any]]) -> int:
    client.table("questions").delete().eq("paper_id", paper_id).execute()
    batch_size = 50
    total = 0
    for i in range(0, len(questions), batch_size):
        batch = questions[i:i + batch_size]
        payload = []
        for q in batch:
            payload.append({
                "paper_id": paper_id,
                "section": q.get("section"),
                "question_number": int(q.get("question_number", total + 1)),
                "question_text": q.get("question_text"),
                "question_type": q.get("question_type", "MCQ"),
                "options": q.get("options"),
                "correct_answer": q.get("correct_answer"),
                "positive_marks": q.get("positive_marks", 3.0),
                "negative_marks": q.get("negative_marks", 1.0),
                "difficulty": q.get("difficulty"),
                "topic": q.get("topic"),
                "subtopic": q.get("subtopic"),
                "solution_text": q.get("solution_text"),
                "solution_image_url": q.get("solution_image_url"),
                "video_solution_url": q.get("video_solution_url"),
                "is_active": True,
            })
        client.table("questions").insert(payload).execute()
        total += len(batch)
    return total


def publish_paper(client: Client, paper_id: int) -> None:
    client.table("papers").update({"published": True}).eq("id", paper_id).execute()


# -----------------------------------------------------------------------------
# Orchestration
# -----------------------------------------------------------------------------

def build_json(meta: Dict[str, Any], questions: List[Dict[str, Any]]) -> Dict[str, Any]:
    slug = meta.get("slug") or meta.get("paper_slug") or "cat-2024"
    title = meta.get("title") or meta.get("paper_title") or "CAT 2024"
    description = meta.get("description") or meta.get("desc")
    year_val = meta.get("year") or meta.get("exam_year") or datetime.now().year
    total_questions = meta.get("total_questions") or len(questions)
    total_marks = meta.get("total_marks") or None
    duration = meta.get("duration_minutes") or meta.get("duration") or 120

    sections = parse_sections(meta)
    if not sections and questions:
        counts: Dict[str, int] = {}
        for q in questions:
            sec = q.get("section", "VARC")
            counts[sec] = counts.get(sec, 0) + 1
        sections = [{"name": k, "questions": v, "time": None, "marks": None} for k, v in counts.items()]

    paper = {
        "slug": slug,
        "title": title,
        "description": description,
        "year": int(float(year_val)) if year_val else datetime.now().year,
        "total_questions": int(float(total_questions)) if total_questions else len(questions),
        "total_marks": int(float(total_marks)) if total_marks else None,
        "duration_minutes": int(float(duration)) if duration else 120,
        "sections": sections,
        "default_positive_marks": 3.0,
        "default_negative_marks": 1.0,
        "difficulty_level": meta.get("difficulty_level") or "cat-level",
        "is_free": True,
        "published": False,
        "available_from": None,
        "available_until": None,
    }

    return {"paper": paper, "questions": questions}


def convert_docx(docx_path: Path) -> Dict[str, Any]:
    doc = Document(docx_path)
    if not doc.tables:
        raise ValueError("DOCX contains no tables to parse")

    paper_meta = parse_paper_metadata(doc.tables[0])
    question_tables = doc.tables[1:] if len(doc.tables) > 1 else []
    questions = parse_questions(question_tables)
    return build_json(paper_meta, questions)


def save_json(data: Dict[str, Any], out_path: Path) -> None:
    out_path.parent.mkdir(parents=True, exist_ok=True)
    with out_path.open("w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


def main() -> None:
    parser = argparse.ArgumentParser(description="Convert CAT paper DOCX to JSON and upload to Supabase")
    parser.add_argument("--docx", required=True, help="Path to PAPER METADATA docx")
    parser.add_argument("--out", default="data/cat-2024.json", help="Where to write the JSON")
    parser.add_argument("--publish", action="store_true", help="Publish paper after upload")
    parser.add_argument("--upload", action="store_true", help="Upload to Supabase")
    args = parser.parse_args()

    docx_path = Path(args.docx)
    out_path = Path(args.out)

    data = convert_docx(docx_path)
    save_json(data, out_path)
    print(f"✅ JSON written to {out_path}")

    if args.upload:
        client = get_supabase_client()
        paper = data["paper"]
        questions = data["questions"]
        supa_paper = upsert_paper(client, paper)
        count = replace_questions(client, supa_paper["id"], questions)
        if args.publish:
            publish_paper(client, supa_paper["id"])
        print(f"✅ Uploaded paper id={supa_paper['id']} with {count} questions; published={args.publish}")
    else:
        print("ℹ️ Skipped upload (run with --upload to push to Supabase)")


if __name__ == "__main__":
    main()
````

## File: docs/research/stack-evaluation.md
````markdown
# Stack Evaluation (SSOT Export)

> Note: This document captures initial stack research. Deployment platform is now Netlify (not Vercel as originally considered).

## Primary: Next.js + Supabase (Free Tier)
- Netlify serves the Next.js App Router with SSR/ISR; Supabase provides Auth, Postgres, and Storage.
- Free tier covers 50k MAU, 500 MB database, 1 GB storage, and 5 GB egress, which supports roughly 200 concurrent exam takers.
- Row-Level Security and signed URLs secure exam data while the JS SDK avoids maintaining custom servers.

## Fallback: Firebase (Firestore + Auth + Storage)
- Daily quotas of 50k reads, 20k writes, 1 GB storage, and 10 GB egress remain sufficient if autosave is optimized.
- Strong real-time and offline support is available, but strict daily limits require monitoring under sudden spikes.

## Deferred: Cloudflare Workers + D1
- Free plan allows about 100k requests per day with global edge delivery, yet D1 is still beta and would add engineering overhead.
- Kept as a future consideration once the MVP stabilizes or if multi-region scaling is required.

## Cost Posture
- All primary services stay within INR 0/month now; a INR 500/month reserve covers Supabase Pro or Firestore Blaze upgrades if usage increases.
````

## File: docs/ROOT_CAUSE_ANALYSIS_SUBMIT_ERROR.md
````markdown
# Root Cause Analysis: Exam Submit "Attempt Not Found" Error

## Executive Summary

After comprehensive analysis of the exam submission flow, I've identified **6 potential root causes** and **3 race conditions** that could lead to the "ATTEMPT_NOT_FOUND" or "This exam attempt was removed" error during submission.

---

## Status (2026-02-07)

This issue is mitigated in current code. Key fixes implemented:

- Submit mutex lock in ExamClient (submitLockRef) to prevent double submits.
- Auto-submit guards and expiry processing gates in useExamTimer.
- Idempotent submit in /api/submit and submitExam (already_submitted responses).
- AttemptId recovery via referer and latest in-progress attempt in /api/submit.
- Session validation + force resume path (validate_session_token + force_resume_exam_session).
- Aggressive localStorage cleanup on ATTEMPT_NOT_FOUND and stale attempt IDs.

Remaining monitoring:
- If an attempt is deleted server-side, the user is redirected to /dashboard after cleanup.
- Session conflicts are still possible with multi-device use; force resume is supported.

## Historical Analysis (pre-2026-02-07)

Note: Line numbers below refer to the pre-fix snapshot and may not match current files.

## Critical Finding: Multiple Submit Triggers Can Race

### The Problem

There are **TWO independent paths** that can trigger exam submission:

1. **Timer Auto-Submit** (`useExamTimer.ts` -> `handleAutoSubmitExam`)
2. **Manual Click Submit** (`ExamClient.tsx` -> `handleSubmitExam`)

Both can fire nearly simultaneously, causing race conditions.

---

## Root Cause Analysis

### Root Cause #1: Timer Auto-Submit and Manual Submit Race Condition

**Location:** 
- [useExamTimer.ts#L133-L165](src/features/exam-engine/hooks/useExamTimer.ts#L133-L165)
- [ExamClient.tsx#L500-L700](src/app/exam/[attemptId]/ExamClient.tsx#L500-L700)

**Problem:**
When the timer expires AND the user clicks submit at the same time:

1. `useExamTimer` calls `handleSectionExpiry('QA')` -> triggers `onExamComplete` -> `handleAutoSubmitExam`
2. User clicks "Submit" -> triggers `handleSubmitExam`
3. Both call `submitExam()` with the same `attemptId`

**Race Timeline:**
```
T+0ms:   Timer expires, QA section -> handleSectionExpiry()
T+1ms:   setAutoSubmitting(true)
T+2ms:   User clicks submit (sees UI before state update)
T+3ms:   handleSubmitExam() starts (checks isAutoSubmitting - may be false in closure!)
T+50ms:  First submitExam() -> status changes to 'submitted'
T+100ms: Second submitExam() -> Attempt is now 'submitted', not 'in_progress' -> ERROR
```

**Current Guard (Insufficient):**
```typescript
// ExamClient.tsx line 406
if (isSubmittingRef.current || isAutoSubmittingRef.current) return;
```

This guard uses refs, but there's a **window between checking the ref and setting it** where both paths can pass through.

---

### Root Cause #2: Double Submit via Atomic Status Transition Failure

**Location:** [actions.ts#L650-L665](src/features/exam-engine/lib/actions.ts#L650-L665)

**Problem:**
The submit action uses an atomic status transition:

```typescript
let updateQuery = adminClient
    .from('attempts')
    .update({ status: 'submitted', submitted_at: submittedAt, submission_id: submissionId })
    .eq('id', normalizedAttemptId)
    .eq('status', 'in_progress');  // <- Only matches if still 'in_progress'
```

If two submits race:
1. First submit: Changes `in_progress` -> `submitted` OK
2. Second submit: `.eq('status', 'in_progress')` returns **no rows** because status is now `submitted`
3. `updatedAttempt` is `null` -> Returns error: "Attempt already submitted by another request"

**But the actual error returned is:** `ATTEMPT_NOT_FOUND` or `Attempt not found`

This happens because of a **fallback lookup that fails** at line 500-530 in actions.ts.

---

### Root Cause #3: Session Token Refresh During Submit

**Location:** [ExamClient.tsx#L504-L510](src/app/exam/[attemptId]/ExamClient.tsx#L504-L510)

**Problem:**
```typescript
const handleSubmitExam = useCallback(async () => {
    // ...
    setSubmitting(true);  // This is AFTER session check, not before!
    
    try {
        const activeSessionToken = await forceRefreshSessionToken();  // <- Can race
```

If `forceRefreshSessionToken()` is called by **two concurrent submits**:
1. First call: Gets new token, writes to DB
2. Second call: Gets different token, overwrites in DB
3. First submit uses old token -> `validate_session_token` fails -> SESSION_CONFLICT

---

### Root Cause #4: Attempt Lookup Fails Before RLS Check

**Location:** [actions.ts#L487-L530](src/features/exam-engine/lib/actions.ts#L487-L530)

**The Actual Error Flow:**
```typescript
let { data: attempt, error: attemptError } = await adminClient
    .from('attempts')
    .select('user_id, status, paper_id, started_at, submission_id')
    .eq('id', normalizedAttemptId)
    .maybeSingle();

if (attemptError || !attempt) {
    // ... fallback logic ...
    return { success: false, error: 'Attempt not found' };  // <- This is your error!
}
```

**Why the lookup fails:**
1. **UUID mismatch**: The `attemptId` being passed is not a valid UUID format
2. **Wrong attempt ID**: Frontend sends stale/cached attemptId from localStorage
3. **Timing**: Attempt was deleted/modified between lookup and submit

---

### Root Cause #5: localStorage State Mismatch

**Location:** [useExamStore.ts#L115-L130](src/features/exam-engine/model/useExamStore.ts#L115-L130)

**Problem:**
```typescript
// PHASE 1 FIX: Check if we're resuming the same attempt with persisted state
if (currentState.attemptId === attempt.id && currentState.hasHydrated) {
    examDebug.resume({...});
    return;  // <- Preserves OLD state including OLD attemptId
}
```

Scenario:
1. User starts exam -> attemptId = `abc-123`
2. User closes browser mid-exam
3. Admin deletes/resets the attempt in Supabase
4. User returns -> localStorage still has `attemptId = abc-123`
5. User submits -> looks for non-existent attempt -> ATTEMPT_NOT_FOUND

---

### Root Cause #6: Concurrent API Calls via Refs Not Protecting Correctly

**Location:** [ExamClient.tsx#L145-L165](src/app/exam/[attemptId]/ExamClient.tsx#L145-L165)

```typescript
const isSubmittingRef = useRef(isSubmitting);
const isAutoSubmittingRef = useRef(isAutoSubmitting);

// Keep refs fresh every render
isSubmittingRef.current = isSubmitting;  // <- Updated on re-render, not immediately
```

**Problem:** Refs are updated on re-render, but the state change triggers re-render asynchronously. There's a gap where the ref still has the old value.

---

## Race Condition Summary

### Race #1: Timer vs Manual Submit
```
useExamTimer.handleSectionExpiry() 
    -> setAutoSubmitting(true)
    -> expireSection()
    -> onExamComplete()
        -> ExamLayout.handleAutoSubmitExam()
            -> syncPendingResponses()
            -> onSubmitExam()
                -> ExamClient.handleSubmitExam()
                    -> submitExam()

CONCURRENT WITH:

User clicks Submit
    -> ExamLayout.handleManualSubmitExam()
        -> syncPendingResponses()
        -> onSubmitExam()
            -> ExamClient.handleSubmitExam()
                -> submitExam()
```

### Race #2: Section Expire vs User Navigation
When QA section expires while user is clicking around, the section expiry handler runs, but user action handlers also run.

### Race #3: Session Token Refresh Collision
```
Call A: initializeExamSession() -> generates token ABC
Call B: initializeExamSession() -> generates token XYZ (overwrites ABC in DB)
Call A: submitExam(token: ABC) -> validate_session_token fails -> SESSION_CONFLICT
```

---

## Fixes Implemented (2026-02-07)

- Submit mutex lock in ExamClient (submitLockRef).
- Auto-submit coordination in useExamTimer (submit guards + expiry gating).
- Idempotent submit in /api/submit and submitExam (already_submitted on retries).
- Attempt lookup recovery (referer + latest in-progress attempt).
- Session token validation + force-resume recovery.
- LocalStorage cleanup on ATTEMPT_NOT_FOUND and stale attempt IDs.

## Diagnostic Steps (current) to Identify Your Specific Issue

### Step 1: Check Browser Console
Look for these log messages before the error:
- `SUBMIT_ATTEMPT_ID_RECEIVED:` - What attemptId is being sent
- `SUBMIT_ATTEMPT_QUERY_RESULT:` - Is the query returning data
- `SUBMIT_ATTEMPT_QUERY_ERROR:` - Any database errors

### Step 2: Check Supabase Logs
In Supabase Dashboard -> Logs -> API:
- Filter for your user ID
- Look for the sequence of calls around submission time
- Check if multiple submits are happening

### Step 3: Verify Attempt Status
```sql
SELECT id, status, submitted_at, completed_at, session_token, created_at
FROM attempts
WHERE user_id = 'YOUR_USER_ID'
ORDER BY created_at DESC
LIMIT 5;
```

### Step 4: Check for Race Condition
Add temporary logging:
```typescript
// In handleSubmitExam
console.log('[SUBMIT] Starting', { 
    attemptId: aId, 
    isSubmitting: isSubmittingRef.current,
    isAutoSubmitting: isAutoSubmittingRef.current,
    timestamp: Date.now()
});
```

---

## Quick Checklist (current)

- [ ] Is `isSubmitting` or `isAutoSubmitting` true when submit is called
- [ ] Is the attemptId a valid UUID format
- [ ] Does the attempt exist in Supabase with status `in_progress`
- [ ] Is the session token valid (not expired)
- [ ] Are there multiple submits in quick succession in the logs
- [ ] Is localStorage holding stale attempt data

---

## Next Steps

1. **Re-run submit flow tests** - Manual submit, auto-submit, and force-resume paths.
2. **Monitor SUBMIT_* logs** - Watch for repeat ATTEMPT_NOT_FOUND or SESSION_CONFLICT spikes.
3. **Validate auth/session hooks** - Confirm validate_session_token and force_resume_exam_session are live.
4. **Verify environment** - Ensure service role key matches the Supabase project in each environment.
````

## File: docs/SCHEMA_SUPABASE.sql
````sql
-- Supabase Database Schema for CAT Mocks
-- This schema defines the core data model for the CAT mock testing platform
-- Version: 2.0 - Production Ready

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================================================
-- USERS TABLE (extends Supabase auth.users)
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.users (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  name TEXT,
  avatar_url TEXT,                    -- Profile picture URL
  target_percentile DECIMAL(5,2),     -- User's target CAT percentile (e.g., 99.5)
  target_iims TEXT[],                 -- Target IIMs array (e.g., ['IIM-A', 'IIM-B'])
  total_mocks_taken INTEGER DEFAULT 0,
  best_percentile DECIMAL(5,2),       -- Best percentile achieved
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- ============================================================================
-- PAPERS TABLE (exam papers)
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.papers (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  slug TEXT UNIQUE,                   -- URL-friendly identifier (e.g., 'cat-2024-mock-1')
  title TEXT NOT NULL,
  description TEXT,                   -- Brief description of the paper
  year INTEGER NOT NULL,
  
  -- Question & Marking Configuration
  total_questions INTEGER NOT NULL,
  total_marks INTEGER NOT NULL DEFAULT 198,  -- CAT: 66 questions × 3 marks = 198
  
  -- Timing
  duration_minutes INTEGER NOT NULL DEFAULT 120, -- CAT 2024: 120 minutes total
  
  -- Section configuration as JSONB
  -- Format: [{"name": "VARC", "questions": 24, "time": 40, "marks": 72}, ...]
  sections JSONB NOT NULL DEFAULT '[]'::jsonb,
  
  -- Marking scheme (can be overridden per question)
  default_positive_marks DECIMAL(3,1) NOT NULL DEFAULT 3.0,
  default_negative_marks DECIMAL(3,1) NOT NULL DEFAULT 1.0,
  
  -- Publishing & Scheduling
  published BOOLEAN DEFAULT FALSE,
  available_from TIMESTAMP WITH TIME ZONE,  -- When paper becomes available
  available_until TIMESTAMP WITH TIME ZONE, -- When paper expires
  
  -- Metadata
  difficulty_level TEXT CHECK (difficulty_level IN ('easy', 'medium', 'hard', 'cat-level')),
  is_free BOOLEAN DEFAULT TRUE,       -- For monetization later
  attempt_limit INTEGER,              -- NULL = unlimited attempts
  allow_pause BOOLEAN DEFAULT FALSE,  -- Whether this paper allows pausing attempts
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- ============================================================================
-- QUESTIONS TABLE
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.questions (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  paper_id UUID REFERENCES public.papers(id) ON DELETE CASCADE NOT NULL,
  section TEXT NOT NULL CHECK (section IN ('VARC', 'DILR', 'QA')), -- CAT sections
  question_number INTEGER NOT NULL,
  
  -- Question content
  question_text TEXT NOT NULL,
  question_type TEXT NOT NULL CHECK (question_type IN ('MCQ', 'TITA')),
  options JSONB,                      -- For MCQ: ["Option A", "Option B", "Option C", "Option D"]
  correct_answer TEXT NOT NULL,       -- For MCQ: "A"/"B"/"C"/"D", for TITA: exact answer
  
  -- Marking (per question override)
  positive_marks DECIMAL(3,1) NOT NULL DEFAULT 3.0,
  negative_marks DECIMAL(3,1) NOT NULL DEFAULT 1.0, -- 0 for TITA questions
  
  -- Solution & Explanation
  solution_text TEXT,
  solution_image_url TEXT,
  video_solution_url TEXT,            -- YouTube/Vimeo link for video solutions
  
  -- Categorization
  difficulty TEXT CHECK (difficulty IN ('easy', 'medium', 'hard')),
  topic TEXT,                         -- e.g., 'Reading Comprehension', 'Arithmetic'
  subtopic TEXT,                      -- e.g., 'Inference', 'Percentages'
  
  -- Management
  is_active BOOLEAN DEFAULT TRUE,     -- Soft delete / hide questions
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,

  UNIQUE(paper_id, section, question_number)
);

-- ============================================================================
-- ATTEMPTS TABLE (user attempts at papers)
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.attempts (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
  paper_id UUID REFERENCES public.papers(id) ON DELETE CASCADE NOT NULL,
  
  -- Timing
  started_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  submitted_at TIMESTAMP WITH TIME ZONE,      -- When user clicked submit
  completed_at TIMESTAMP WITH TIME ZONE,      -- When scoring completed
  time_taken_seconds INTEGER,                  -- Actual time taken
  session_token UUID,                          -- Server-managed session token
  last_activity_at TIMESTAMP WITH TIME ZONE,   -- Server-managed activity tracking
  
  -- Status
  status TEXT NOT NULL DEFAULT 'in_progress' CHECK (status IN ('in_progress', 'paused', 'submitted', 'completed', 'abandoned', 'expired')),
  current_section TEXT,
  current_question INTEGER DEFAULT 1,
  time_remaining JSONB,               -- {"VARC": 2400, "DILR": 2400, "QA": 2400}
  
  -- Scores (populated after submission)
  total_score DECIMAL(6,2),           -- Can be negative due to negative marking
  max_possible_score DECIMAL(6,2),    -- Usually 198 for CAT
  
  -- Detailed Analytics
  correct_count INTEGER DEFAULT 0,
  incorrect_count INTEGER DEFAULT 0,
  unanswered_count INTEGER DEFAULT 0,
  
  accuracy DECIMAL(5,2),              -- (correct / attempted) * 100
  attempt_rate DECIMAL(5,2),          -- (attempted / total) * 100
  
  -- Section-wise scores
  section_scores JSONB,               -- {"VARC": {"score": 45, "correct": 15, "incorrect": 3, "unanswered": 6}}
  
  -- Ranking (populated by background job or trigger)
  percentile DECIMAL(5,2),            -- Percentile among all attempts on this paper
  rank INTEGER,                       -- Rank among all attempts on this paper
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- ============================================================================
-- RESPONSES TABLE (user answers)
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.responses (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  attempt_id UUID REFERENCES public.attempts(id) ON DELETE CASCADE NOT NULL,
  question_id UUID REFERENCES public.questions(id) ON DELETE CASCADE NOT NULL,
  
  -- Answer data
  answer TEXT,                        -- User's answer (NULL = unanswered)
  is_correct BOOLEAN,                 -- Populated after submission
  marks_obtained DECIMAL(4,2),        -- +3, -1, or 0
  
  -- State tracking
  status TEXT DEFAULT 'not_visited' CHECK (status IN ('not_visited', 'visited', 'answered', 'marked', 'answered_marked')),
  is_marked_for_review BOOLEAN DEFAULT FALSE,
  is_visited BOOLEAN DEFAULT FALSE,
  
  -- Time analytics
  time_spent_seconds INTEGER DEFAULT 0,
  visit_count INTEGER DEFAULT 0,      -- How many times user visited this question
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,

  UNIQUE(attempt_id, question_id)
);

-- ============================================================================
-- LEADERBOARD TABLE (for efficient ranking queries)
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.leaderboard (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  paper_id UUID REFERENCES public.papers(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
  attempt_id UUID REFERENCES public.attempts(id) ON DELETE CASCADE NOT NULL,
  
  score DECIMAL(6,2) NOT NULL,
  percentile DECIMAL(5,2),
  rank INTEGER,
  
  -- For filtering
  submitted_at TIMESTAMP WITH TIME ZONE NOT NULL,
  
  UNIQUE(paper_id, user_id, attempt_id)
);

-- ============================================================================
-- ANALYTICS TABLE (for tracking user progress over time)
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.user_analytics (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
  
  -- Aggregate stats
  total_attempts INTEGER DEFAULT 0,
  average_score DECIMAL(6,2),
  average_percentile DECIMAL(5,2),
  best_score DECIMAL(6,2),
  best_percentile DECIMAL(5,2),
  
  -- Section-wise averages
  varc_average DECIMAL(5,2),
  dilr_average DECIMAL(5,2),
  qa_average DECIMAL(5,2),
  
  -- Weak areas (computed periodically)
  weak_topics JSONB,                  -- [{"topic": "Percentages", "accuracy": 45}, ...]
  strong_topics JSONB,
  
  last_updated TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  
  UNIQUE(user_id)
);

-- ============================================================================
-- ACCESS CONTROL (SOFT LAUNCH)
-- ============================================================================

-- Enums
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'signup_mode') THEN
    CREATE TYPE public.signup_mode AS ENUM ('OPEN', 'GATED');
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'access_status') THEN
    CREATE TYPE public.access_status AS ENUM ('active', 'pending', 'rejected');
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'access_request_status') THEN
    CREATE TYPE public.access_request_status AS ENUM ('pending', 'approved', 'rejected');
  END IF;
END $$;

-- App settings (central brain)
CREATE TABLE IF NOT EXISTS public.app_settings (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  setting_key TEXT NOT NULL UNIQUE,
  setting_value TEXT NOT NULL,
  updated_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- User access status
CREATE TABLE IF NOT EXISTS public.user_access (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
  status public.access_status NOT NULL DEFAULT 'pending',
  reason TEXT,
  decided_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  decided_at TIMESTAMP WITH TIME ZONE,
  source TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_user_access_status ON public.user_access(status);

-- Access requests (waitlist inbox)
CREATE TABLE IF NOT EXISTS public.access_requests (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  email TEXT NOT NULL,
  status public.access_request_status NOT NULL DEFAULT 'pending',
  source TEXT,
  notes TEXT,
  decided_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  decided_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE UNIQUE INDEX IF NOT EXISTS access_requests_email_unique
ON public.access_requests (LOWER(email));

CREATE UNIQUE INDEX IF NOT EXISTS access_requests_user_unique
ON public.access_requests (user_id)
WHERE user_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_access_requests_status
ON public.access_requests (status);

-- ============================================================================
-- INDEXES FOR PERFORMANCE
-- ============================================================================
CREATE INDEX idx_questions_paper_section ON public.questions(paper_id, section);
CREATE INDEX idx_questions_active ON public.questions(paper_id, is_active);
CREATE INDEX idx_attempts_user_status ON public.attempts(user_id, status);
CREATE INDEX idx_attempts_paper_score ON public.attempts(paper_id, total_score DESC);
CREATE INDEX idx_responses_attempt ON public.responses(attempt_id);
CREATE INDEX idx_leaderboard_paper_rank ON public.leaderboard(paper_id, rank);
CREATE INDEX idx_leaderboard_paper_percentile ON public.leaderboard(paper_id, percentile DESC);

-- ============================================================================
-- ROW LEVEL SECURITY (RLS) POLICIES
-- ============================================================================

-- Enable RLS on all tables
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.papers ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.attempts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.responses ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.leaderboard ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_analytics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.app_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_access ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.access_requests ENABLE ROW LEVEL SECURITY;

-- Access control policies
CREATE POLICY "Admins can manage app settings" ON public.app_settings
  FOR ALL USING (public.is_admin()) WITH CHECK (public.is_admin());

CREATE POLICY "Users can view own access status" ON public.user_access
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can self-create pending access status" ON public.user_access
  FOR INSERT WITH CHECK (auth.uid() = user_id AND status = 'pending');

CREATE POLICY "Admins can manage access status" ON public.user_access
  FOR ALL USING (public.is_admin()) WITH CHECK (public.is_admin());

CREATE POLICY "Users can create own access request" ON public.access_requests
  FOR INSERT WITH CHECK (auth.uid() = user_id AND status = 'pending');

CREATE POLICY "Users can view own access request" ON public.access_requests
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Admins can manage access requests" ON public.access_requests
  FOR ALL USING (public.is_admin()) WITH CHECK (public.is_admin());

-- Users policies
CREATE POLICY "Users can view their own profile" ON public.users
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update their own profile" ON public.users
  FOR UPDATE USING (auth.uid() = id);

-- Papers policies (read-only for authenticated users, must be published AND within availability window)
CREATE POLICY "Authenticated users can view available papers" ON public.papers
  FOR SELECT TO authenticated 
  USING (
    -- Admins can see everything
    public.is_admin()
    OR (
      -- Published papers within availability window
      published = true
      AND (available_from IS NULL OR available_from <= NOW())
      AND (available_until IS NULL OR available_until >= NOW())
    )
  );

-- Questions policies (SECURITY HARDENED - Step 0.8)
-- Users can ONLY read questions (including correct_answer) for COMPLETED attempts.
-- This prevents answer leakage during in_progress exams.
-- For exam runtime, use the questions_exam view which excludes correct_answer.
CREATE POLICY "Users can read questions for their completed attempts" ON public.questions
  FOR SELECT TO authenticated 
  USING (
    is_active = true
    AND paper_id IN (
      SELECT paper_id FROM public.attempts
      WHERE user_id = auth.uid()
        AND status IN ('submitted', 'completed')
        AND submitted_at IS NOT NULL
    )
  );

-- Attempts policies
CREATE POLICY "Users can view their own attempts" ON public.attempts
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create attempts within limit" ON public.attempts
  FOR INSERT TO authenticated
  WITH CHECK (
    auth.uid() = user_id
    AND (
      public.is_admin()
      OR EXISTS (
        SELECT 1 FROM public.user_access ua
        WHERE ua.user_id = auth.uid() AND ua.status = 'active'
      )
    )
    AND (
      (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id) IS NULL
      OR (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id) <= 0
      OR (
        SELECT COUNT(*)
        FROM public.attempts a
        WHERE a.user_id = auth.uid()
          AND a.paper_id = attempts.paper_id
          AND a.status <> 'expired'
      ) < (SELECT attempt_limit FROM public.papers p WHERE p.id = attempts.paper_id)
    )
  );

CREATE POLICY "Users can update their own attempts" ON public.attempts
  FOR UPDATE USING (auth.uid() = user_id)
  WITH CHECK (
    auth.uid() = user_id
    AND (
      (
        status = (SELECT status FROM public.attempts a WHERE a.id = attempts.id)
        AND submitted_at IS NOT DISTINCT FROM (SELECT submitted_at FROM public.attempts a WHERE a.id = attempts.id)
        AND completed_at IS NOT DISTINCT FROM (SELECT completed_at FROM public.attempts a WHERE a.id = attempts.id)
      )
      OR
      (
        (SELECT status FROM public.attempts a WHERE a.id = attempts.id) = 'in_progress'
        AND status = 'submitted'
        AND submitted_at IS NOT NULL
        AND completed_at IS NOT DISTINCT FROM (SELECT completed_at FROM public.attempts a WHERE a.id = attempts.id)
      )
    )
  );

-- Responses policies
CREATE POLICY "Users can view their own responses" ON public.responses
  FOR SELECT USING (
    auth.uid() = (SELECT user_id FROM public.attempts WHERE id = attempt_id)
  );

-- Column-level security (restrict sensitive fields from direct client access)
REVOKE SELECT (correct_answer) ON public.questions FROM authenticated;
REVOKE SELECT (session_token) ON public.attempts FROM authenticated;
REVOKE UPDATE (session_token) ON public.attempts FROM authenticated;

CREATE POLICY "Users can create their own responses" ON public.responses
  FOR INSERT WITH CHECK (
    auth.uid() = (SELECT user_id FROM public.attempts WHERE id = attempt_id)
    AND (
      public.is_admin()
      OR EXISTS (
        SELECT 1 FROM public.user_access ua
        WHERE ua.user_id = auth.uid() AND ua.status = 'active'
      )
    )
  );

CREATE POLICY "Users can update their own responses" ON public.responses
  FOR UPDATE USING (
    auth.uid() = (SELECT user_id FROM public.attempts WHERE id = attempt_id)
  )
  WITH CHECK (
    auth.uid() = (SELECT user_id FROM public.attempts WHERE id = attempt_id)
    AND (
      public.is_admin()
      OR EXISTS (
        SELECT 1 FROM public.user_access ua
        WHERE ua.user_id = auth.uid() AND ua.status = 'active'
      )
    )
  );

-- Leaderboard policies (everyone can view, system inserts)
CREATE POLICY "Authenticated users can view leaderboard" ON public.leaderboard
  FOR SELECT TO authenticated USING (true);

-- User analytics policies
CREATE POLICY "Users can view their own analytics" ON public.user_analytics
  FOR SELECT USING (auth.uid() = user_id);

-- ============================================================================
-- SECURE VIEWS (for column-level security)
-- ============================================================================

-- View for exam runtime: questions WITHOUT correct_answer, solution
-- Use this view in app code when fetching questions during an active exam
CREATE OR REPLACE VIEW public.questions_exam AS
SELECT 
  id,
  paper_id,
  section,
  question_number,
  question_text,
  question_type,
  options,
  positive_marks,
  negative_marks,
  difficulty,
  topic,
  subtopic,
  is_active,
  created_at,
  updated_at
  -- EXCLUDED: correct_answer, solution_text, solution_image_url, video_solution_url
FROM public.questions
WHERE is_active = true;

-- Grant access to authenticated users
GRANT SELECT ON public.questions_exam TO authenticated;

-- ============================================================================
-- DEPRECATED — do not apply after MIGRATION_RLS_VIEWS.sql
-- The safe perimeter is enforced via questions_exam + fetch_attempt_solutions RPC.
-- Any solution-bearing view must NOT be granted to authenticated users.
-- ============================================================================

-- View for results/solutions: questions WITH answers (for post-submission review)
-- NOTE: This view is deprecated; do NOT grant to authenticated. Use RPC instead.
CREATE OR REPLACE VIEW public.questions_with_solutions AS
SELECT 
  q.id,
  q.paper_id,
  q.section,
  q.question_number,
  q.question_text,
  q.question_type,
  q.options,
  q.correct_answer,
  q.positive_marks,
  q.negative_marks,
  q.solution_text,
  q.solution_image_url,
  q.video_solution_url,
  q.difficulty,
  q.topic,
  q.subtopic
FROM public.questions q
WHERE q.is_active = true;

-- REVOKE ALL and rely on fetch_attempt_solutions RPC (see migrations/004_fetch_attempt_solutions.sql)
REVOKE ALL ON public.questions_with_solutions FROM PUBLIC;
REVOKE ALL ON public.questions_with_solutions FROM anon;
REVOKE ALL ON public.questions_with_solutions FROM authenticated;

-- ============================================================================
-- FUNCTIONS & TRIGGERS
-- ============================================================================

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = TIMEZONE('utc'::text, NOW());
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Add updated_at triggers to all tables
CREATE TRIGGER handle_updated_at_users
  BEFORE UPDATE ON public.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER handle_updated_at_papers
  BEFORE UPDATE ON public.papers
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER handle_updated_at_questions
  BEFORE UPDATE ON public.questions
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER handle_updated_at_attempts
  BEFORE UPDATE ON public.attempts
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER handle_updated_at_responses
  BEFORE UPDATE ON public.responses
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER handle_updated_at_app_settings
  BEFORE UPDATE ON public.app_settings
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER handle_updated_at_user_access
  BEFORE UPDATE ON public.user_access
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER handle_updated_at_access_requests
  BEFORE UPDATE ON public.access_requests
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

-- Function to create user profile on signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.users (id, email, name, avatar_url)
  VALUES (
    NEW.id, 
    NEW.email, 
    COALESCE(NEW.raw_user_meta_data->>'name', NEW.raw_user_meta_data->>'full_name'),
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public, pg_catalog;

-- Trigger to create user profile
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Assign access status on signup (fail-closed to pending)
CREATE OR REPLACE FUNCTION public.assign_access_status_on_signup()
RETURNS TRIGGER AS $$
DECLARE
  v_mode TEXT;
  v_status public.access_status;
BEGIN
  SELECT CASE
    WHEN setting_value = 'OPEN' THEN 'OPEN'
    WHEN setting_value = 'GATED' THEN 'GATED'
    ELSE 'GATED'
  END
  INTO v_mode
  FROM public.app_settings
  WHERE setting_key = 'signup_mode'
  LIMIT 1;

  IF v_mode IS NULL THEN
    v_mode := 'GATED';
  END IF;

  v_status := CASE WHEN v_mode = 'OPEN'
    THEN 'active'::public.access_status
    ELSE 'pending'::public.access_status
  END;

  INSERT INTO public.user_access (user_id, status, source)
  VALUES (NEW.id, v_status, 'auto_signup')
  ON CONFLICT (user_id) DO NOTHING;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public, pg_catalog;

CREATE TRIGGER on_auth_user_created_access_status
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.assign_access_status_on_signup();

-- Seed default signup mode (OPEN)
INSERT INTO public.app_settings (setting_key, setting_value)
VALUES ('signup_mode', 'OPEN')
ON CONFLICT (setting_key) DO NOTHING;

-- ============================================================================
-- SCORING FUNCTION (DEPRECATED)
-- ============================================================================
-- Legacy SQL scoring via public.finalize_attempt(attempt_id) is deprecated.
-- Scoring is now handled by the TypeScript scoring engine in submitExam().
-- If present in your database, drop it via migration 012_phase1_security_hardening.sql.

-- ============================================================================
-- PERCENTILE CALCULATION FUNCTION (Run periodically or on-demand)
-- ============================================================================
CREATE OR REPLACE FUNCTION public.calculate_percentiles(p_paper_id UUID)
RETURNS VOID AS $$
DECLARE
  v_total_attempts INTEGER;
  v_record RECORD;
  v_rank INTEGER := 0;
  v_prev_score DECIMAL(6,2) := NULL;
BEGIN
  -- Count total completed attempts for this paper
  SELECT COUNT(*) INTO v_total_attempts 
  FROM public.attempts 
  WHERE paper_id = p_paper_id AND status = 'completed';

  IF v_total_attempts = 0 THEN
    RETURN;
  END IF;

  -- Calculate rank and percentile for each attempt
  FOR v_record IN 
    SELECT id, total_score
    FROM public.attempts
    WHERE paper_id = p_paper_id AND status = 'completed'
    ORDER BY total_score DESC, completed_at ASC
  LOOP
    v_rank := v_rank + 1;
    
    UPDATE public.attempts SET
      rank = v_rank,
      percentile = ((v_total_attempts - v_rank)::DECIMAL / v_total_attempts) * 100
    WHERE id = v_record.id;
    
    -- Also update leaderboard
    UPDATE public.leaderboard SET
      rank = v_rank,
      percentile = ((v_total_attempts - v_rank)::DECIMAL / v_total_attempts) * 100
    WHERE attempt_id = v_record.id;
  END LOOP;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public, pg_catalog;

-- ============================================================================
-- SEED DATA: Sample CAT Mock Test
-- ============================================================================

-- Insert a sample CAT 2024 Mock Paper
INSERT INTO public.papers (
  slug, title, description, year, 
  total_questions, total_marks, duration_minutes, 
  sections, default_positive_marks, default_negative_marks,
  published, difficulty_level, is_free
) VALUES (
  'cat-2024-mock-1',
  'CAT 2024 Mock Test 1',
  'Full-length CAT mock test following the 2024 pattern with 66 questions across VARC, DILR, and QA sections.',
  2024,
  66, 198, 120,
  '[
    {"name": "VARC", "questions": 24, "time": 40, "marks": 72},
    {"name": "DILR", "questions": 20, "time": 40, "marks": 60},
    {"name": "QA", "questions": 22, "time": 40, "marks": 66}
  ]'::jsonb,
  3.0, 1.0,
  true, 'cat-level', true
);

-- Insert sample VARC questions
INSERT INTO public.questions (paper_id, section, question_number, question_text, question_type, options, correct_answer, positive_marks, negative_marks, difficulty, topic, is_active)
SELECT 
  p.id, 'VARC', 1,
  'Read the following passage and answer the question:\n\nThe rise of artificial intelligence has fundamentally altered our understanding of creativity. While machines can now compose music, write poetry, and create visual art, the question of whether this constitutes "true" creativity remains contentious.\n\nBased on the passage, the author''s primary purpose is to:',
  'MCQ',
  '["Argue that AI cannot be truly creative", "Present a debate about AI and creativity", "Prove that machines are superior to humans", "Dismiss concerns about artificial intelligence"]'::jsonb,
  'B', 3.0, 1.0, 'medium', 'Reading Comprehension', true
FROM public.papers p WHERE p.slug = 'cat-2024-mock-1';

INSERT INTO public.questions (paper_id, section, question_number, question_text, question_type, options, correct_answer, positive_marks, negative_marks, difficulty, topic, is_active)
SELECT 
  p.id, 'VARC', 2,
  'Choose the sentence that best completes the paragraph:\n\nThe company had been struggling for months. Revenue was declining, employees were leaving, and investor confidence was at an all-time low. ___________',
  'MCQ',
  '["Despite this, the CEO remained optimistic about the future.", "The weather that day was particularly pleasant.", "Similar companies in the industry were thriving.", "The stock market had been volatile for years."]'::jsonb,
  'A', 3.0, 1.0, 'easy', 'Para Completion', true
FROM public.papers p WHERE p.slug = 'cat-2024-mock-1';

-- Insert sample DILR questions
INSERT INTO public.questions (paper_id, section, question_number, question_text, question_type, options, correct_answer, positive_marks, negative_marks, difficulty, topic, is_active)
SELECT 
  p.id, 'DILR', 1,
  'Study the following data and answer:\n\nFive friends A, B, C, D, and E are sitting in a row. A is to the left of B. C is to the right of D. E is not at any end. D is not adjacent to A.\n\nWho is sitting in the middle?',
  'MCQ',
  '["A", "B", "C", "E"]'::jsonb,
  'D', 3.0, 1.0, 'medium', 'Seating Arrangement', true
FROM public.papers p WHERE p.slug = 'cat-2024-mock-1';

INSERT INTO public.questions (paper_id, section, question_number, question_text, question_type, options, correct_answer, positive_marks, negative_marks, difficulty, topic, is_active)
SELECT 
  p.id, 'DILR', 2,
  'A set contains 6 elements. How many subsets of this set contain exactly 3 elements?',
  'TITA',
  NULL,
  '20', 3.0, 0.0, 'easy', 'Combinatorics', true
FROM public.papers p WHERE p.slug = 'cat-2024-mock-1';

-- Insert sample QA questions
INSERT INTO public.questions (paper_id, section, question_number, question_text, question_type, options, correct_answer, positive_marks, negative_marks, difficulty, topic, is_active)
SELECT 
  p.id, 'QA', 1,
  'If the price of an item is increased by 20% and then decreased by 20%, what is the net percentage change in the price?',
  'MCQ',
  '["No change", "4% decrease", "4% increase", "2% decrease"]'::jsonb,
  'B', 3.0, 1.0, 'easy', 'Percentages', true
FROM public.papers p WHERE p.slug = 'cat-2024-mock-1';

INSERT INTO public.questions (paper_id, section, question_number, question_text, question_type, options, correct_answer, positive_marks, negative_marks, difficulty, topic, is_active)
SELECT 
  p.id, 'QA', 2,
  'Find the value of x if: log₂(x) + log₂(x-2) = 3',
  'TITA',
  NULL,
  '4', 3.0, 0.0, 'medium', 'Logarithms', true
FROM public.papers p WHERE p.slug = 'cat-2024-mock-1';

INSERT INTO public.questions (paper_id, section, question_number, question_text, question_type, options, correct_answer, positive_marks, negative_marks, difficulty, topic, is_active)
SELECT 
  p.id, 'QA', 3,
  'A train travels from station A to station B at 60 km/h and returns at 40 km/h. What is the average speed for the entire journey?',
  'MCQ',
  '["50 km/h", "48 km/h", "45 km/h", "52 km/h"]'::jsonb,
  'B', 3.0, 1.0, 'medium', 'Time Speed Distance', true
FROM public.papers p WHERE p.slug = 'cat-2024-mock-1';

-- ============================================================================
-- MIGRATION SCRIPT (Run this to update existing database)
-- ============================================================================
-- To migrate an existing database, run these ALTER statements:
/*
-- Add missing columns to papers
ALTER TABLE public.papers ADD COLUMN IF NOT EXISTS total_marks INTEGER DEFAULT 198;
ALTER TABLE public.papers ADD COLUMN IF NOT EXISTS default_positive_marks DECIMAL(3,1) DEFAULT 3.0;
ALTER TABLE public.papers ADD COLUMN IF NOT EXISTS default_negative_marks DECIMAL(3,1) DEFAULT 1.0;
ALTER TABLE public.papers ADD COLUMN IF NOT EXISTS available_from TIMESTAMP WITH TIME ZONE;
ALTER TABLE public.papers ADD COLUMN IF NOT EXISTS available_until TIMESTAMP WITH TIME ZONE;
ALTER TABLE public.papers ADD COLUMN IF NOT EXISTS difficulty_level TEXT;
ALTER TABLE public.papers ADD COLUMN IF NOT EXISTS is_free BOOLEAN DEFAULT TRUE;
ALTER TABLE public.papers ADD COLUMN IF NOT EXISTS attempt_limit INTEGER;

-- Add missing columns to questions
ALTER TABLE public.questions ADD COLUMN IF NOT EXISTS positive_marks DECIMAL(3,1) DEFAULT 3.0;
ALTER TABLE public.questions ADD COLUMN IF NOT EXISTS negative_marks DECIMAL(3,1) DEFAULT 1.0;
ALTER TABLE public.questions ADD COLUMN IF NOT EXISTS video_solution_url TEXT;
ALTER TABLE public.questions ADD COLUMN IF NOT EXISTS subtopic TEXT;
ALTER TABLE public.questions ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT TRUE;

-- Add missing columns to attempts
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS submitted_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS time_taken_seconds INTEGER;
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS session_token UUID;
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS last_activity_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS max_possible_score DECIMAL(6,2);
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS correct_count INTEGER DEFAULT 0;
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS incorrect_count INTEGER DEFAULT 0;
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS unanswered_count INTEGER DEFAULT 0;
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS accuracy DECIMAL(5,2);
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS attempt_rate DECIMAL(5,2);
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS percentile DECIMAL(5,2);
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS rank INTEGER;
ALTER TABLE public.attempts ADD COLUMN IF NOT EXISTS current_question INTEGER DEFAULT 1;

-- Add missing columns to responses
ALTER TABLE public.responses ADD COLUMN IF NOT EXISTS is_correct BOOLEAN;
ALTER TABLE public.responses ADD COLUMN IF NOT EXISTS marks_obtained DECIMAL(4,2);
ALTER TABLE public.responses ADD COLUMN IF NOT EXISTS status TEXT DEFAULT 'not_visited';
ALTER TABLE public.responses ADD COLUMN IF NOT EXISTS visit_count INTEGER DEFAULT 0;

-- Add missing columns to users
ALTER TABLE public.users ADD COLUMN IF NOT EXISTS avatar_url TEXT;
ALTER TABLE public.users ADD COLUMN IF NOT EXISTS target_percentile DECIMAL(5,2);
ALTER TABLE public.users ADD COLUMN IF NOT EXISTS target_iims TEXT[];
ALTER TABLE public.users ADD COLUMN IF NOT EXISTS total_mocks_taken INTEGER DEFAULT 0;
ALTER TABLE public.users ADD COLUMN IF NOT EXISTS best_percentile DECIMAL(5,2);

-- Update status check constraint for attempts
ALTER TABLE public.attempts DROP CONSTRAINT IF EXISTS attempts_status_check;
ALTER TABLE public.attempts ADD CONSTRAINT attempts_status_check 
  CHECK (status IN ('in_progress', 'paused', 'submitted', 'completed', 'abandoned', 'expired'));

-- Update section check constraint for questions
ALTER TABLE public.questions DROP CONSTRAINT IF EXISTS questions_section_check;
ALTER TABLE public.questions ADD CONSTRAINT questions_section_check 
  CHECK (section IN ('VARC', 'DILR', 'QA'));
*/
````

## File: schemas/ai_analysis_export.schema.v1.json
````json
{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://nexams.app/schemas/ai_analysis_export.schema.v1.json",
    "title": "Nexams AI Analysis Export (Composite Context JSON) v1",
    "type": "object",
    "additionalProperties": false,
    "required": [
        "schema_meta",
        "generated_at",
        "meta",
        "paper",
        "attempt",
        "sections"
    ],
    "properties": {
        "schema_meta": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "name",
                "version",
                "paper_schema_version"
            ],
            "properties": {
                "name": {
                    "type": "string",
                    "const": "nexams.ai_analysis_export"
                },
                "version": {
                    "type": "string",
                    "const": "1.0.0"
                },
                "paper_schema_version": {
                    "type": "string"
                }
            }
        },
        "generated_at": {
            "type": "string",
            "format": "date-time"
        },
        "meta": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "attempt_id",
                "user_id",
                "paper_id"
            ],
            "properties": {
                "attempt_id": {
                    "type": "string"
                },
                "user_id": {
                    "type": "string"
                },
                "paper_id": {
                    "type": "string"
                },
                "paper_key": {
                    "type": "string"
                },
                "exam_name": {
                    "type": "string"
                },
                "source": {
                    "type": "string",
                    "enum": [
                        "admin_export"
                    ]
                },
                "created_from_ingest_run_id": {
                    "type": [
                        "string",
                        "null"
                    ]
                },
                "notes": {
                    "type": [
                        "string",
                        "null"
                    ]
                }
            }
        },
        "paper": {
            "type": "object",
            "additionalProperties": true,
            "description": "Full static paper snapshot (canonical JSON) + any DB-enriched fields if needed"
        },
        "attempt": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "status",
                "started_at",
                "submitted_at",
                "scores",
                "counts",
                "timing",
                "telemetry"
            ],
            "properties": {
                "status": {
                    "type": "string"
                },
                "started_at": {
                    "type": "string",
                    "format": "date-time"
                },
                "submitted_at": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "format": "date-time"
                },
                "scores": {
                    "type": "object",
                    "additionalProperties": false,
                    "required": [
                        "total_score",
                        "percentile",
                        "rank",
                        "section_scores"
                    ],
                    "properties": {
                        "total_score": {
                            "type": [
                                "number",
                                "null"
                            ]
                        },
                        "max_possible_score": {
                            "type": [
                                "number",
                                "null"
                            ]
                        },
                        "percentile": {
                            "type": [
                                "number",
                                "null"
                            ]
                        },
                        "rank": {
                            "type": [
                                "number",
                                "null"
                            ]
                        },
                        "section_scores": {
                            "type": "object"
                        }
                    }
                },
                "counts": {
                    "type": "object",
                    "additionalProperties": false,
                    "required": [
                        "correct",
                        "incorrect",
                        "unanswered"
                    ],
                    "properties": {
                        "correct": {
                            "type": "integer"
                        },
                        "incorrect": {
                            "type": "integer"
                        },
                        "unanswered": {
                            "type": "integer"
                        }
                    }
                },
                "timing": {
                    "type": "object",
                    "additionalProperties": false,
                    "required": [
                        "time_taken_seconds"
                    ],
                    "properties": {
                        "time_taken_seconds": {
                            "type": [
                                "integer",
                                "null"
                            ]
                        },
                        "total_paused_seconds": {
                            "type": [
                                "integer",
                                "null"
                            ]
                        },
                        "pause_count": {
                            "type": [
                                "integer",
                                "null"
                            ]
                        },
                        "last_activity_at": {
                            "type": [
                                "string",
                                "null"
                            ],
                            "format": "date-time"
                        }
                    }
                },
                "telemetry": {
                    "type": "object",
                    "additionalProperties": false,
                    "required": [
                        "telemetry_log"
                    ],
                    "properties": {
                        "telemetry_log": {
                            "type": [
                                "array",
                                "object",
                                "null"
                            ]
                        }
                    }
                }
            }
        },
        "user_progress": {
            "type": [
                "object",
                "null"
            ],
            "additionalProperties": false,
            "properties": {
                "average_score": {
                    "type": [
                        "number",
                        "null"
                    ]
                },
                "average_percentile": {
                    "type": [
                        "number",
                        "null"
                    ]
                },
                "best_score": {
                    "type": [
                        "number",
                        "null"
                    ]
                },
                "best_percentile": {
                    "type": [
                        "number",
                        "null"
                    ]
                },
                "total_mocks_taken": {
                    "type": [
                        "integer",
                        "null"
                    ]
                },
                "varc_average": {
                    "type": [
                        "number",
                        "null"
                    ]
                },
                "dilr_average": {
                    "type": [
                        "number",
                        "null"
                    ]
                },
                "qa_average": {
                    "type": [
                        "number",
                        "null"
                    ]
                },
                "weak_topics": {
                    "type": [
                        "object",
                        "array",
                        "null"
                    ]
                },
                "strong_topics": {
                    "type": [
                        "object",
                        "array",
                        "null"
                    ]
                },
                "target_percentile": {
                    "type": [
                        "number",
                        "null"
                    ]
                },
                "target_iims": {
                    "type": [
                        "object",
                        "array",
                        "null"
                    ]
                }
            }
        },
        "sections": {
            "type": "array",
            "minItems": 1,
            "items": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                    "name",
                    "summary",
                    "items"
                ],
                "properties": {
                    "name": {
                        "type": "string",
                        "enum": [
                            "VARC",
                            "DILR",
                            "QA"
                        ]
                    },
                    "summary": {
                        "type": "object",
                        "additionalProperties": false,
                        "required": [
                            "score",
                            "time_spent_seconds",
                            "attempted",
                            "correct",
                            "incorrect",
                            "unanswered"
                        ],
                        "properties": {
                            "score": {
                                "type": [
                                    "number",
                                    "null"
                                ]
                            },
                            "time_spent_seconds": {
                                "type": [
                                    "integer",
                                    "null"
                                ]
                            },
                            "attempted": {
                                "type": "integer"
                            },
                            "correct": {
                                "type": "integer"
                            },
                            "incorrect": {
                                "type": "integer"
                            },
                            "unanswered": {
                                "type": "integer"
                            }
                        }
                    },
                    "items": {
                        "type": "array",
                        "items": {
                            "type": "object",
                            "additionalProperties": false,
                            "required": [
                                "question",
                                "context",
                                "user_result",
                                "derived"
                            ],
                            "properties": {
                                "question": {
                                    "type": "object",
                                    "additionalProperties": true,
                                    "required": [
                                        "question_uuid",
                                        "client_question_id",
                                        "question_number",
                                        "question_type",
                                        "marks",
                                        "negative_marks"
                                    ]
                                },
                                "context": {
                                    "type": [
                                        "object",
                                        "null"
                                    ],
                                    "additionalProperties": true
                                },
                                "user_result": {
                                    "type": "object",
                                    "additionalProperties": false,
                                    "required": [
                                        "answer",
                                        "is_correct",
                                        "marks_obtained",
                                        "time_spent_seconds",
                                        "visit_count",
                                        "is_visited",
                                        "is_marked_for_review",
                                        "answer_history"
                                    ],
                                    "properties": {
                                        "answer": {
                                            "type": [
                                                "string",
                                                "null"
                                            ]
                                        },
                                        "selected_option": {
                                            "type": [
                                                "integer",
                                                "null"
                                            ]
                                        },
                                        "is_correct": {
                                            "type": [
                                                "boolean",
                                                "null"
                                            ]
                                        },
                                        "marks_obtained": {
                                            "type": [
                                                "number",
                                                "null"
                                            ]
                                        },
                                        "time_spent_seconds": {
                                            "type": [
                                                "integer",
                                                "null"
                                            ]
                                        },
                                        "visit_count": {
                                            "type": [
                                                "integer",
                                                "null"
                                            ]
                                        },
                                        "is_visited": {
                                            "type": [
                                                "boolean",
                                                "null"
                                            ]
                                        },
                                        "is_marked_for_review": {
                                            "type": [
                                                "boolean",
                                                "null"
                                            ]
                                        },
                                        "answer_history": {
                                            "type": [
                                                "array",
                                                "object",
                                                "null"
                                            ]
                                        }
                                    }
                                },
                                "derived": {
                                    "type": "object",
                                    "additionalProperties": false,
                                    "required": [
                                        "attempt_state",
                                        "did_switch_answer"
                                    ],
                                    "properties": {
                                        "attempt_state": {
                                            "type": "string",
                                            "enum": [
                                                "correct",
                                                "incorrect",
                                                "unanswered"
                                            ]
                                        },
                                        "did_switch_answer": {
                                            "type": "boolean"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        "raw": {
            "type": [
                "object",
                "null"
            ],
            "additionalProperties": true,
            "description": "Optional raw DB rows for debugging (attempt row, responses rows, user_analytics row)"
        }
    }
}
````

## File: scripts/maintenance/update-paper-descriptions.mjs
````javascript
#!/usr/bin/env node
/**
 * @fileoverview One-off maintenance script to update paper descriptions
 * @description Replaces internal "Converted from PDF..." notes with user-facing copy
 * 
 * Usage: 
 *   node scripts/maintenance/update-paper-descriptions.mjs [--dry-run]
 * 
 * Options:
 *   --dry-run    Preview changes without updating the database
 * 
 * Environment:
 *   Requires SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY in .env.local
 */

import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import path from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const ROOT_DIR = path.resolve(__dirname, '../..');

// Load environment variables
dotenv.config({ path: path.join(ROOT_DIR, '.env.local') });
dotenv.config({ path: path.join(ROOT_DIR, '.env') });

// =============================================================================
// CONFIGURATION
// =============================================================================

const DESCRIPTION_TEMPLATES = [
    "Official CAT {year} Slot {slot} Question Paper. Enhanced with Nexams' advanced analytics and percentile prediction engine.",
    "Full-length simulation of the actual CAT {year} Slot {slot} exam. Experience the real pattern with deep performance insights.",
    "Authentic CAT {year} Slot {slot} paper. Includes detailed solutions and comprehensive difficulty analysis.",
    "Practice with the official CAT {year} Slot {slot} paper. Benchmark your score using our proprietary analytics suite.",
    "Standardized CAT {year} Slot {slot} Test. Optimized for digital practice with instant scoring and metrics.",
];

// Patterns that indicate internal/conversion notes (case-insensitive)
const INTERNAL_DESCRIPTION_PATTERNS = [
    /converted from pdf/i,
    /imported from/i,
    /parsed from/i,
    /advertisements removed/i,
    /tables converted/i,
    /answers mapped/i,
    /migration/i,
    /test paper/i,
    /placeholder/i,
];

// =============================================================================
// HELPERS
// =============================================================================

function isInternalDescription(description) {
    if (!description) return false;
    return INTERNAL_DESCRIPTION_PATTERNS.some(pattern => pattern.test(description));
}

function extractYearAndSlot(paper) {
    // Try to extract year and slot from title
    const title = paper.title || '';

    // Pattern 1: "CAT 2024 Slot 1" or "CAT-2024-Slot-1"
    const match1 = title.match(/CAT[- ]?(\d{4})[- ]?Slot[- ]?(\d)/i);
    if (match1) {
        return { year: match1[1], slot: match1[2] };
    }

    // Pattern 2: Just use the year from paper.year and try to find slot in title
    if (paper.year) {
        const slotMatch = title.match(/Slot[- ]?(\d)/i);
        const slot = slotMatch ? slotMatch[1] : '1';
        return { year: String(paper.year), slot };
    }

    // Pattern 3: Extract year from title "CAT 2024"
    const yearMatch = title.match(/CAT[- ]?(\d{4})/i);
    if (yearMatch) {
        const slotMatch = title.match(/Slot[- ]?(\d)/i);
        return { year: yearMatch[1], slot: slotMatch ? slotMatch[1] : '1' };
    }

    return null;
}

function generateDescription(paper) {
    const extracted = extractYearAndSlot(paper);
    if (!extracted) {
        // Generic fallback for papers without clear year/slot
        return "Full-length CAT mock test. Enhanced with Nexams' advanced analytics and percentile prediction engine.";
    }

    const { year, slot } = extracted;

    // Use a deterministic template based on paper ID for variety
    const templateIndex = paper.id ?
        parseInt(paper.id.replace(/[^0-9]/g, '').slice(-1) || '0', 10) % DESCRIPTION_TEMPLATES.length :
        0;

    const template = DESCRIPTION_TEMPLATES[templateIndex];
    return template.replace('{year}', year).replace('{slot}', slot);
}

// =============================================================================
// MAIN
// =============================================================================

async function main() {
    const isDryRun = process.argv.includes('--dry-run');

    console.log('═'.repeat(60));
    console.log('  Paper Description Cleanup Script');
    console.log('═'.repeat(60));
    console.log();

    if (isDryRun) {
        console.log('🔍 DRY RUN MODE - No changes will be made\n');
    }

    // Validate environment
    const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;
    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!supabaseUrl) {
        console.error('❌ Error: SUPABASE_URL or NEXT_PUBLIC_SUPABASE_URL not set');
        process.exit(1);
    }

    if (!supabaseServiceKey) {
        console.error('❌ Error: SUPABASE_SERVICE_ROLE_KEY not set');
        console.error('   This script requires the service role key to bypass RLS.');
        process.exit(1);
    }

    // Create Supabase client with service role key (bypasses RLS)
    const supabase = createClient(supabaseUrl, supabaseServiceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });

    // Fetch all papers
    console.log('📥 Fetching papers from database...\n');

    const { data: papers, error: fetchError } = await supabase
        .from('papers')
        .select('id, title, description, year, slug')
        .order('year', { ascending: false })
        .order('created_at', { ascending: false });

    if (fetchError) {
        console.error('❌ Error fetching papers:', fetchError.message);
        process.exit(1);
    }

    if (!papers || papers.length === 0) {
        console.log('ℹ️  No papers found in database.');
        process.exit(0);
    }

    console.log(`📄 Found ${papers.length} papers\n`);

    // Identify papers needing updates
    const papersToUpdate = [];
    const papersSkipped = [];

    for (const paper of papers) {
        if (isInternalDescription(paper.description)) {
            const newDescription = generateDescription(paper);
            papersToUpdate.push({
                ...paper,
                oldDescription: paper.description,
                newDescription,
            });
        } else {
            papersSkipped.push(paper);
        }
    }

    console.log(`🔄 Papers to update: ${papersToUpdate.length}`);
    console.log(`✅ Papers already clean: ${papersSkipped.length}\n`);

    if (papersToUpdate.length === 0) {
        console.log('✨ All paper descriptions are already clean!');
        process.exit(0);
    }

    // Show planned changes
    console.log('─'.repeat(60));
    console.log('PLANNED CHANGES:');
    console.log('─'.repeat(60));

    for (const paper of papersToUpdate) {
        console.log(`\n📝 ${paper.title}`);
        console.log(`   ID: ${paper.id}`);
        console.log(`   OLD: "${paper.oldDescription?.substring(0, 60)}..."`);
        console.log(`   NEW: "${paper.newDescription}"`);
    }

    console.log('\n' + '─'.repeat(60));

    if (isDryRun) {
        console.log('\n🔍 DRY RUN COMPLETE - No changes were made.');
        console.log('   Run without --dry-run to apply changes.\n');
        process.exit(0);
    }

    // Apply updates
    console.log('\n⚡ Applying updates...\n');

    let successCount = 0;
    let failCount = 0;

    for (const paper of papersToUpdate) {
        const { error: updateError } = await supabase
            .from('papers')
            .update({
                description: paper.newDescription,
                updated_at: new Date().toISOString(),
            })
            .eq('id', paper.id);

        if (updateError) {
            console.error(`   ❌ Failed to update "${paper.title}": ${updateError.message}`);
            failCount++;
        } else {
            console.log(`   ✅ Updated: ${paper.title}`);
            successCount++;
        }
    }

    // Summary
    console.log('\n' + '═'.repeat(60));
    console.log('SUMMARY');
    console.log('═'.repeat(60));
    console.log(`   ✅ Successfully updated: ${successCount}`);
    console.log(`   ❌ Failed: ${failCount}`);
    console.log(`   ⏭️  Skipped (already clean): ${papersSkipped.length}`);
    console.log('═'.repeat(60));

    if (failCount > 0) {
        process.exit(1);
    }

    console.log('\n✨ Done! Paper descriptions have been updated.\n');
}

main().catch((err) => {
    console.error('Fatal error:', err);
    process.exit(1);
});
````

## File: scripts/validate-ai-export.mjs
````javascript
#!/usr/bin/env node
/**
 * @fileoverview Validate AI Analysis Export JSON files against schema v1
 * @description CLI tool for local/CI validation of exported composite context packets.
 *
 * Usage:
 *   node scripts/validate-ai-export.mjs <path-to-json> [path-to-json ...]
 *   node scripts/validate-ai-export.mjs data/exports/*.json
 *
 * Exit codes:
 *   0 — all files valid
 *   1 — one or more files invalid or missing
 */

import Ajv from 'ajv';
import addFormats from 'ajv-formats';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join, resolve } from 'path';

const __dirname = dirname(fileURLToPath(import.meta.url));
const schemaPath = join(__dirname, '..', 'schemas', 'ai_analysis_export.schema.v1.json');

// ── Load schema ──────────────────────────────────────────────────────────────
let schema;
try {
    schema = JSON.parse(readFileSync(schemaPath, 'utf8'));
} catch (err) {
    console.error(`❌ Could not load schema at ${schemaPath}:`, err.message);
    process.exit(1);
}

// ── Build Ajv ────────────────────────────────────────────────────────────────
const ajv = new Ajv({ allErrors: true, strict: false, verbose: true });
addFormats(ajv);
const validate = ajv.compile(schema);

// ── Process files ────────────────────────────────────────────────────────────
const files = process.argv.slice(2);

if (files.length === 0) {
    console.log('Usage: node scripts/validate-ai-export.mjs <file.json> [file2.json ...]');
    console.log('');
    console.log('Validates AI Analysis Export JSON files against schema v1.');
    process.exit(0);
}

let hasErrors = false;

for (const filePath of files) {
    const absPath = resolve(filePath);

    let data;
    try {
        data = JSON.parse(readFileSync(absPath, 'utf8'));
    } catch (err) {
        console.error(`❌ ${filePath}: Could not read/parse — ${err.message}`);
        hasErrors = true;
        continue;
    }

    const valid = validate(data);

    if (valid) {
        const sectionCount = data.sections?.length ?? '?';
        const itemCount = (data.sections ?? []).reduce((sum, s) => sum + (s.items?.length ?? 0), 0);
        console.log(`✅ ${filePath} — valid (${sectionCount} sections, ${itemCount} items)`);
    } else {
        hasErrors = true;
        console.error(`❌ ${filePath} — INVALID`);
        for (const err of validate.errors ?? []) {
            console.error(`   ${err.instancePath || '/'}: ${err.message}`);
            if (err.params) {
                console.error(`     params: ${JSON.stringify(err.params)}`);
            }
        }
    }
}

console.log('');
if (hasErrors) {
    console.error('⚠️  Some files failed validation.');
    process.exit(1);
} else {
    console.log('🎉 All files valid.');
    process.exit(0);
}
````

## File: src/app/admin/ai-analysis/DownloadExportButton.tsx
````typescript
'use client';

/**
 * @fileoverview Download button for AI Analysis export
 * @description Uses fetch() to call the export API with proper cookie auth,
 *   then triggers a programmatic download of the JSON file.
 */

import { useState } from 'react';

interface DownloadExportButtonProps {
    attemptId: string;
}

export default function DownloadExportButton({ attemptId }: DownloadExportButtonProps) {
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);

    async function handleDownload() {
        setLoading(true);
        setError(null);

        try {
            const res = await fetch(`/api/admin/ai-analysis/${attemptId}/export`, {
                method: 'GET',
                credentials: 'include',
            });

            if (!res.ok) {
                const body = await res.json().catch(() => ({ error: res.statusText }));
                setError(body.error || `Export failed (${res.status})`);
                return;
            }

            // Extract filename from Content-Disposition header or use fallback
            const disposition = res.headers.get('Content-Disposition');
            let filename = `analysis_${attemptId.slice(0, 8)}.json`;
            if (disposition) {
                const match = disposition.match(/filename="?([^";\n]+)"?/);
                if (match?.[1]) filename = match[1];
            }

            // Create blob and trigger download
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Download failed');
        } finally {
            setLoading(false);
        }
    }

    return (
        <div className="flex flex-col items-end gap-1">
            <button
                onClick={handleDownload}
                disabled={loading}
                className="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
                {loading ? (
                    <>
                        <svg className="animate-spin w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
                        </svg>
                        Exporting…
                    </>
                ) : (
                    <>
                        <svg className="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Download JSON
                    </>
                )}
            </button>
            {error && (
                <p className="text-xs text-red-500 max-w-[200px] text-right">{error}</p>
            )}
        </div>
    );
}
````

## File: src/app/admin/ai-analysis/page.tsx
````typescript
/**
 * @fileoverview Admin AI Analysis Dashboard
 * @description Lists attempts with ai_analysis_status='requested' for admin
 *   to review and download composite context JSON exports.
 * @route /admin/ai-analysis
 * @blueprint AI Analysis Export — Phase 3 (docs/AI_ANALYSIS_EXPORT.md)
 */

import Link from 'next/link';
import { getServiceRoleClient } from '@/lib/supabase/service-role';
import DownloadExportButton from './DownloadExportButton';

export const dynamic = 'force-dynamic';

export default async function AIAnalysisDashboard() {
    const admin = getServiceRoleClient();

    // Fetch all attempts with analysis requested/exported/failed — most recent first
    const { data: attempts, error } = await admin
        .from('attempts')
        .select('id, user_id, paper_id, total_score, percentile, ai_analysis_status, ai_analysis_requested_at, ai_analysis_exported_at, ai_analysis_error, submitted_at')
        .neq('ai_analysis_status', 'none')
        .order('ai_analysis_requested_at', { ascending: false, nullsFirst: false });

    // Collect unique user and paper IDs for lookup
    const userIds = Array.from(new Set((attempts ?? []).map(a => a.user_id).filter(Boolean)));
    const paperIds = Array.from(new Set((attempts ?? []).map(a => a.paper_id).filter(Boolean)));

    // Batch-fetch user emails from auth.users via service role
    const userEmailMap = new Map<string, string>();
    if (userIds.length > 0) {
        // Use admin API to list users — batched approach
        for (const uid of userIds) {
            const { data: { user } } = await admin.auth.admin.getUserById(uid);
            if (user?.email) userEmailMap.set(uid, user.email);
        }
    }

    // Batch-fetch paper slugs/titles
    const paperMap = new Map<string, { slug: string; title: string }>();
    if (paperIds.length > 0) {
        const { data: papers } = await admin
            .from('papers')
            .select('id, slug, title')
            .in('id', paperIds);

        (papers ?? []).forEach(p => paperMap.set(p.id, { slug: p.slug, title: p.title }));
    }

    const statusBadge = (status: string) => {
        const config: Record<string, { bg: string; text: string; label: string }> = {
            requested: { bg: 'bg-yellow-100', text: 'text-yellow-800', label: 'Requested' },
            exported: { bg: 'bg-green-100', text: 'text-green-800', label: 'Exported' },
            processed: { bg: 'bg-blue-100', text: 'text-blue-800', label: 'Processed' },
            failed: { bg: 'bg-red-100', text: 'text-red-800', label: 'Failed' },
        };
        const c = config[status] ?? { bg: 'bg-gray-100', text: 'text-gray-800', label: status };
        return (
            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${c.bg} ${c.text}`}>
                {c.label}
            </span>
        );
    };

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-bold text-gray-900">AI Analysis Requests</h1>
                    <p className="text-gray-500 text-sm mt-1">
                        Download composite context JSON packets for AI-powered analysis.
                    </p>
                </div>
                <Link
                    href="/admin"
                    className="text-sm text-blue-600 hover:text-blue-800 transition-colors"
                >
                    ← Back to Admin
                </Link>
            </div>

            {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700 text-sm">
                    Failed to load analysis requests: {error.message}
                </div>
            )}

            {(!attempts || attempts.length === 0) && !error && (
                <div className="bg-white rounded-lg border border-gray-200 p-12 text-center">
                    <svg className="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    <p className="text-gray-500">No analysis requests yet.</p>
                    <p className="text-gray-400 text-sm mt-1">
                        Users can request AI analysis from their result page after completing a mock.
                    </p>
                </div>
            )}

            {attempts && attempts.length > 0 && (
                <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Attempt
                                    </th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        User
                                    </th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Paper
                                    </th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Score
                                    </th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Percentile
                                    </th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Status
                                    </th>
                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Requested At
                                    </th>
                                    <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Action
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {attempts.map((a) => {
                                    const paperInfo = paperMap.get(a.paper_id);
                                    const email = userEmailMap.get(a.user_id);

                                    return (
                                        <tr key={a.id} className="hover:bg-gray-50">
                                            <td className="px-4 py-3 text-sm font-mono text-gray-600">
                                                {a.id.slice(0, 8)}…
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-700">
                                                {email ?? (
                                                    <span className="text-gray-400 font-mono text-xs">
                                                        {a.user_id.slice(0, 8)}…
                                                    </span>
                                                )}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-700">
                                                {paperInfo?.title ?? (
                                                    <span className="text-gray-400 font-mono text-xs">
                                                        {a.paper_id.slice(0, 8)}…
                                                    </span>
                                                )}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-900 font-medium">
                                                {a.total_score != null ? a.total_score : '—'}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-900">
                                                {a.percentile != null ? `${a.percentile}%` : '—'}
                                            </td>
                                            <td className="px-4 py-3 text-sm">
                                                {statusBadge(a.ai_analysis_status)}
                                                {a.ai_analysis_error && (
                                                    <p className="text-xs text-red-500 mt-1 max-w-[200px] truncate" title={a.ai_analysis_error}>
                                                        {a.ai_analysis_error}
                                                    </p>
                                                )}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-500">
                                                {a.ai_analysis_requested_at
                                                    ? new Date(a.ai_analysis_requested_at).toLocaleString()
                                                    : '—'}
                                            </td>
                                            <td className="px-4 py-3 text-sm text-right">
                                                <DownloadExportButton attemptId={a.id} />
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
        </div>
    );
}
````

## File: src/app/api/admin/ai-analysis/[attemptId]/export/route.ts
````typescript
/**
 * @fileoverview Admin AI Analysis Export API Endpoint
 * @description Admin-only endpoint to download the Composite Context JSON for an attempt.
 *   After successful export, marks the attempt as "exported" in the lifecycle.
 * @route GET /api/admin/ai-analysis/[attemptId]/export
 * @blueprint AI Analysis Export — Phase 3 (docs/AI_ANALYSIS_EXPORT.md)
 */

import { NextRequest, NextResponse } from 'next/server';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';
import { getServiceRoleClient } from '@/lib/supabase/service-role';
import { generateCompositeContextPacket } from '@/lib/analysis/generateCompositeContextPacket';

// ─── Auth helpers (mirrored from paper export route) ─────────────────────────

async function createActionClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string;
    const cookieStore = await cookies();

    return createServerClient(url, anon, {
        cookies: {
            getAll() {
                return cookieStore.getAll();
            },
            setAll(cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options }) =>
                        cookieStore.set(name, value, options)
                    );
                } catch {
                    // Ignore — cookies can't be set during render
                }
            },
        },
    });
}

async function verifyAdmin(): Promise<{ userId: string; email: string }> {
    const supabase = await createActionClient();
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error || !user) {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
            return verifyAdminRole(supabase, session);
        }
        throw new Error('Not authenticated');
    }

    const { data: { session } } = await supabase.auth.getSession();
    return verifyAdminRole(supabase, session);
}

async function verifyAdminRole(
    supabase: ReturnType<typeof createServerClient>,
    session: { user: { id: string; email?: string }; access_token?: string } | null
): Promise<{ userId: string; email: string }> {
    if (!session?.user) {
        throw new Error('Not authenticated');
    }

    const skipAdminCheck = process.env.SKIP_ADMIN_CHECK === 'true' && process.env.NODE_ENV !== 'production';
    if (!skipAdminCheck) {
        let role: string | null = (session.user as { app_metadata?: { user_role?: string } }).app_metadata?.user_role ?? null;

        if (!role && session.access_token) {
            try {
                const payload = JSON.parse(
                    Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')
                ) as { user_role?: string; app_metadata?: { user_role?: string } };
                role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
            } catch {
                role = null;
            }
        }

        if (role !== 'admin' && role !== 'dev') {
            const { data: isAdmin, error: rpcError } = await supabase.rpc('is_admin');
            if (rpcError || !isAdmin) {
                throw new Error('Unauthorized: Admin access required');
            }
        }
    }

    return { userId: session.user.id, email: session.user.email || '' };
}

// ─── GET handler ─────────────────────────────────────────────────────────────

export async function GET(
    _req: NextRequest,
    { params }: { params: Promise<{ attemptId: string }> }
) {
    const admin = getServiceRoleClient();
    let attemptId: string;

    try {
        await verifyAdmin();
        attemptId = (await params).attemptId;

        if (!attemptId) {
            return NextResponse.json({ error: 'Attempt ID required' }, { status: 400 });
        }
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        if (message.includes('Not authenticated') || message.includes('Unauthorized')) {
            return NextResponse.json({ error: message }, { status: 401 });
        }
        return NextResponse.json({ error: message }, { status: 500 });
    }

    try {
        // Generate the composite context packet
        const { data: packet, error: genError, validationWarnings } = await generateCompositeContextPacket(attemptId);

        if (genError || !packet) {
            // Mark as failed
            await admin
                .from('attempts')
                .update({
                    ai_analysis_status: 'failed',
                    ai_analysis_error: genError ?? 'Unknown generation error',
                })
                .eq('id', attemptId);

            return NextResponse.json({ error: genError ?? 'Failed to generate context packet' }, { status: 500 });
        }

        // Log validation warnings if any (non-fatal — still export)
        if (validationWarnings && validationWarnings.length > 0) {
            console.warn(`[AI Analysis Export] ${validationWarnings.length} schema validation warning(s) for attempt ${attemptId}:`, validationWarnings);
        }

        // Mark as exported
        await admin
            .from('attempts')
            .update({
                ai_analysis_status: 'exported',
                ai_analysis_exported_at: new Date().toISOString(),
                ai_analysis_error: validationWarnings?.length
                    ? `Schema warnings: ${validationWarnings.join('; ')}`
                    : null,
            })
            .eq('id', attemptId);

        // Build filename
        const slug = (packet.paper as Record<string, unknown>).slug || (packet.paper as Record<string, unknown>).id || packet.meta.paper_id;
        const filename = `analysis_${slug}_${attemptId.slice(0, 8)}.json`;

        const jsonString = JSON.stringify(packet, null, 2);

        return new NextResponse(jsonString, {
            status: 200,
            headers: {
                'Content-Type': 'application/json',
                'Content-Disposition': `attachment; filename="${filename}"`,
                'Cache-Control': 'no-store',
            },
        });
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        console.error('AI Analysis export error:', message);

        // Mark as failed
        await admin
            .from('attempts')
            .update({
                ai_analysis_status: 'failed',
                ai_analysis_error: message,
            })
            .eq('id', attemptId);

        return NextResponse.json({ error: message }, { status: 500 });
    }
}
````

## File: src/app/result/[attemptId]/AIAnalysisButton.tsx
````typescript
/**
 * @fileoverview AI Analysis Request Button
 * @description Client component for the "Request AI Analysis" CTA on the result page.
 *   Shows status pill and handles the request action with optimistic UI.
 * @blueprint AI Analysis Export — Phase 2 (docs/AI_ANALYSIS_EXPORT.md)
 */

'use client';

import { useCallback, useState, useTransition } from 'react';
import { requestAIAnalysis } from '@/features/exam-engine/lib/actions';
import type { AIAnalysisStatus } from '@/types/exam';

interface AIAnalysisButtonProps {
    attemptId: string;
    initialStatus: AIAnalysisStatus;
}

const STATUS_CONFIG: Record<AIAnalysisStatus, {
    label: string;
    className: string;
    disabled: boolean;
    icon: 'sparkle' | 'clock' | 'check' | 'download' | 'error';
}> = {
    none: {
        label: 'Request AI Analysis',
        className: 'bg-purple-600 text-white hover:bg-purple-700',
        disabled: false,
        icon: 'sparkle',
    },
    requested: {
        label: 'Analysis Requested',
        className: 'bg-purple-100 text-purple-700 cursor-default',
        disabled: true,
        icon: 'clock',
    },
    exported: {
        label: 'Analysis Exported',
        className: 'bg-green-100 text-green-700 cursor-default',
        disabled: true,
        icon: 'download',
    },
    processed: {
        label: 'Analysis Complete',
        className: 'bg-green-100 text-green-700 cursor-default',
        disabled: true,
        icon: 'check',
    },
    failed: {
        label: 'Analysis Failed — Retry',
        className: 'bg-red-600 text-white hover:bg-red-700',
        disabled: false,
        icon: 'error',
    },
};

function StatusIcon({ icon }: { icon: string }) {
    switch (icon) {
        case 'sparkle':
            return (
                <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
            );
        case 'clock':
            return (
                <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            );
        case 'check':
            return (
                <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
            );
        case 'download':
            return (
                <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
            );
        case 'error':
            return (
                <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            );
        default:
            return null;
    }
}

export function AIAnalysisButton({ attemptId, initialStatus }: AIAnalysisButtonProps) {
    const [status, setStatus] = useState<AIAnalysisStatus>(initialStatus || 'none');
    const [errorMessage, setErrorMessage] = useState<string | null>(null);
    const [isPending, startTransition] = useTransition();

    const config = STATUS_CONFIG[status];

    const handleRequest = useCallback(() => {
        if (config.disabled && status !== 'failed') return;

        setErrorMessage(null);

        // Optimistic: show requested immediately
        const prevStatus = status;
        setStatus('requested');

        startTransition(async () => {
            const result = await requestAIAnalysis(attemptId);

            if (result.success) {
                // Use the server-confirmed status
                setStatus((result.data?.status as AIAnalysisStatus) || 'requested');
            } else {
                // Revert optimistic update
                setStatus(prevStatus);
                setErrorMessage(result.error ?? 'Failed to request analysis');
            }
        });
    }, [attemptId, config.disabled, status, startTransition]);

    return (
        <div className="flex flex-col items-center gap-2">
            <button
                type="button"
                onClick={handleRequest}
                disabled={config.disabled || isPending}
                className={`inline-flex items-center px-6 py-3 font-medium rounded-lg transition-colors shadow-sm ${config.className} ${isPending ? 'opacity-60 cursor-wait' : ''}`}
            >
                {isPending ? (
                    <svg className="w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                    </svg>
                ) : (
                    <StatusIcon icon={config.icon} />
                )}
                {isPending ? 'Requesting…' : config.label}
            </button>

            {errorMessage && (
                <p className="text-sm text-red-600 text-center max-w-xs">
                    {errorMessage}
                </p>
            )}
        </div>
    );
}
````

## File: src/components/TopProgressBar.tsx
````typescript
'use client';

import { useEffect, useRef, useState } from 'react';
import { usePathname, useSearchParams } from 'next/navigation';

type ProgressState = {
    active: boolean;
    startedAt: number | null;
};

function isSamePageNavigation(url: URL): boolean {
    return (
        url.origin === window.location.origin &&
        url.pathname === window.location.pathname &&
        url.search === window.location.search &&
        url.hash !== window.location.hash
    );
}

function isInternalNavigation(url: URL): boolean {
    return url.origin === window.location.origin;
}

export default function TopProgressBar() {
    const pathname = usePathname();
    const searchParams = useSearchParams();

    const [progress, setProgress] = useState(0);
    const [visible, setVisible] = useState(false);
    const [reduceMotion, setReduceMotion] = useState(false);

    const progressRef = useRef(0);
    const animationRef = useRef<number | null>(null);
    const stateRef = useRef<ProgressState>({ active: false, startedAt: null });
    const pendingStartRef = useRef(false);
    const mountedRef = useRef(true);

    const stopAnimation = () => {
        if (animationRef.current !== null) {
            cancelAnimationFrame(animationRef.current);
            animationRef.current = null;
        }
    };

    const tick = () => {
        if (!stateRef.current.active) return;

        let next = progressRef.current;
        const speed = next < 0.3 ? 0.025 : next < 0.8 ? 0.006 : next < 0.95 ? 0.003 : 0;
        next = Math.min(next + speed, 0.95);

        progressRef.current = next;
        setProgress(next);

        animationRef.current = requestAnimationFrame(tick);
    };

    const start = () => {
        if (stateRef.current.active) return;

        stateRef.current = { active: true, startedAt: Date.now() };
        setVisible(true);

        if (reduceMotion) {
            progressRef.current = 0.9;
            setProgress(0.9);
            return;
        }

        progressRef.current = 0;
        setProgress(0);
        stopAnimation();
        animationRef.current = requestAnimationFrame(tick);
    };

    const scheduleStart = () => {
        if (stateRef.current.active || pendingStartRef.current) return;
        pendingStartRef.current = true;

        const run = () => {
            pendingStartRef.current = false;
            if (!mountedRef.current) return;
            start();
        };

        if (typeof queueMicrotask === 'function') {
            queueMicrotask(run);
        } else {
            window.setTimeout(run, 0);
        }
    };

    const complete = () => {
        if (!stateRef.current.active) return;

        stateRef.current.active = false;
        stopAnimation();

        progressRef.current = 1;
        setProgress(1);

        const minVisibleMs = 150;
        const elapsed = stateRef.current.startedAt ? Date.now() - stateRef.current.startedAt : 0;
        const remaining = Math.max(minVisibleMs - elapsed, 0);

        window.setTimeout(() => {
            setVisible(false);
            window.setTimeout(() => {
                progressRef.current = 0;
                setProgress(0);
                stateRef.current.startedAt = null;
            }, 200);
        }, remaining);
    };

    useEffect(() => {
        mountedRef.current = true;
        return () => {
            mountedRef.current = false;
        };
    }, []);

    useEffect(() => {
        const media = window.matchMedia('(prefers-reduced-motion: reduce)');
        const update = () => setReduceMotion(media.matches);
        update();
        media.addEventListener('change', update);
        return () => media.removeEventListener('change', update);
    }, []);

    useEffect(() => {
        const handleClick = (event: MouseEvent) => {
            if (event.defaultPrevented) return;
            if (event.button !== 0) return;
            if (event.metaKey || event.altKey || event.ctrlKey || event.shiftKey) return;

            const target = event.target as HTMLElement | null;
            const anchor = target?.closest('a');
            if (!anchor) return;

            if (anchor.hasAttribute('download')) return;
            if (anchor.getAttribute('target') && anchor.getAttribute('target') !== '_self') return;
            if (anchor.dataset.noProgress === 'true') return;

            const href = anchor.getAttribute('href');
            if (!href || href.startsWith('#')) return;

            try {
                const url = new URL(href, window.location.href);
                if (!isInternalNavigation(url)) return;
                if (isSamePageNavigation(url)) return;
            } catch {
                return;
            }

            scheduleStart();
        };

        const handlePopState = () => {
            scheduleStart();
        };

        const patchHistory = () => {
            const originalPushState = history.pushState.bind(history);
            const originalReplaceState = history.replaceState.bind(history);

            const notify = (url?: string | URL | null) => {
                if (!url) return;
                try {
                    const nextUrl = new URL(String(url), window.location.href);
                    if (isSamePageNavigation(nextUrl)) return;
                    scheduleStart();
                } catch {
                    return;
                }
            };

            history.pushState = ((data, unused, url) => {
                notify(url ?? null);
                return originalPushState(data, unused, url);
            }) as typeof history.pushState;

            history.replaceState = ((data, unused, url) => {
                notify(url ?? null);
                return originalReplaceState(data, unused, url);
            }) as typeof history.replaceState;

            return () => {
                history.pushState = originalPushState;
                history.replaceState = originalReplaceState;
            };
        };

        document.addEventListener('click', handleClick, true);
        window.addEventListener('popstate', handlePopState);
        const restoreHistory = patchHistory();

        return () => {
            document.removeEventListener('click', handleClick, true);
            window.removeEventListener('popstate', handlePopState);
            restoreHistory();
        };
    }, [reduceMotion]);

    useEffect(() => {
        complete();
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [pathname, searchParams?.toString()]);

    return (
        <div
            className="top-progress-bar"
            style={{
                transform: `scaleX(${progress})`,
                opacity: visible ? 1 : 0,
            }}
            aria-hidden="true"
        />
    );
}
````

## File: src/lib/analysis/generateCompositeContextPacket.ts
````typescript
/**
 * @fileoverview Composite Context Packet Generator — Schema v1
 * @description Builds a complete AI-analysis-ready JSON packet in sections[]-based format.
 *   Merges static paper data (questions, contexts, correct answers, solutions)
 *   with dynamic attempt data (responses, timing, telemetry, derived metrics)
 *   and user aggregate analytics.  Validates output against schema v1 before returning.
 * @blueprint AI Analysis Export — Phases 3 + 5 (docs/AI_ANALYSIS_EXPORT.md)
 */

import 'server-only';

import { getServiceRoleClient } from '@/lib/supabase/service-role';
import type { SectionName, SectionScore } from '@/types/exam';
import { validateAiAnalysisExport } from './validateAiAnalysisExport';

// =============================================================================
// INTERNAL DB ROW TYPES (for .select() results)
// =============================================================================

interface QuestionRow {
    id: string;
    section: string;
    question_number: number;
    question_type: string;
    question_text: string;
    options: unknown;
    correct_answer?: string | null;
    solution_text?: string | null;
    solution_image_url?: string | null;
    video_solution_url?: string | null;
    positive_marks: number;
    negative_marks: number;
    topic?: string | null;
    subtopic?: string | null;
    difficulty?: string | null;
    ideal_time_seconds?: number | null;
    set_id?: string | null;
    context_id?: string | null;
    question_image_url?: string | null;
}

interface ResponseRow {
    question_id: string;
    answer?: string | null;
    is_correct?: boolean | null;
    marks_obtained?: number | null;
    status?: string | null;
    time_spent_seconds?: number | null;
    visit_count?: number | null;
    is_visited?: boolean | null;
    is_marked_for_review?: boolean;
    answer_history?: unknown;
}

interface ContextRow {
    id: string;
    title?: string | null;
    content?: string | null;
    context_type?: string | null;
    section?: string | null;
    image_url?: string | null;
}

// =============================================================================
// EXPORT PAYLOAD TYPES (Schema v1)
// =============================================================================

export interface SchemaExportItem {
    question: Record<string, unknown>;
    context: Record<string, unknown> | null;
    user_result: {
        answer: string | null;
        selected_option: number | null;
        is_correct: boolean | null;
        marks_obtained: number | null;
        time_spent_seconds: number | null;
        visit_count: number | null;
        is_visited: boolean | null;
        is_marked_for_review: boolean | null;
        answer_history: unknown;
    };
    derived: {
        attempt_state: 'correct' | 'incorrect' | 'unanswered';
        did_switch_answer: boolean;
    };
}

export interface SchemaExportSection {
    name: SectionName;
    summary: {
        score: number | null;
        time_spent_seconds: number | null;
        attempted: number;
        correct: number;
        incorrect: number;
        unanswered: number;
    };
    items: SchemaExportItem[];
}

export interface CompositeContextPacket {
    schema_meta: {
        name: 'nexams.ai_analysis_export';
        version: '1.0.0';
        paper_schema_version: string;
    };
    generated_at: string;
    meta: {
        attempt_id: string;
        user_id: string;
        paper_id: string;
        paper_key: string;
        exam_name: string;
        source: 'admin_export';
        created_from_ingest_run_id: string | null;
        notes: string | null;
    };
    paper: Record<string, unknown>;
    attempt: {
        status: string;
        started_at: string;
        submitted_at: string | null;
        scores: {
            total_score: number | null;
            max_possible_score: number | null;
            percentile: number | null;
            rank: number | null;
            section_scores: Record<string, SectionScore> | object;
        };
        counts: {
            correct: number;
            incorrect: number;
            unanswered: number;
        };
        timing: {
            time_taken_seconds: number | null;
            total_paused_seconds: number | null;
            pause_count: number | null;
            last_activity_at: string | null;
        };
        telemetry: {
            telemetry_log: unknown;
        };
    };
    user_progress: {
        average_score: number | null;
        average_percentile: number | null;
        best_score: number | null;
        best_percentile: number | null;
        total_mocks_taken: number | null;
        varc_average: number | null;
        dilr_average: number | null;
        qa_average: number | null;
        weak_topics: unknown;
        strong_topics: unknown;
        target_percentile: number | null;
        target_iims: unknown;
    } | null;
    sections: SchemaExportSection[];
    raw?: Record<string, unknown> | null;
}

// =============================================================================
// DERIVED METRICS HELPERS
// =============================================================================

/** Determine attempt_state from response data */
function deriveAttemptState(
    response: ResponseRow | undefined,
): 'correct' | 'incorrect' | 'unanswered' {
    if (!response || response.answer == null || response.answer === '') {
        return 'unanswered';
    }
    if (response.is_correct === true) return 'correct';
    if (response.is_correct === false) return 'incorrect';
    // Fallback: answered but is_correct is null (shouldn't happen for graded exams)
    return 'unanswered';
}

/** Check if user changed their answer at least once */
function deriveDidSwitchAnswer(response: ResponseRow | undefined): boolean {
    if (!response) return false;
    const history = response.answer_history;
    if (!Array.isArray(history)) return false;
    return history.length > 1;
}

// =============================================================================
// GENERATOR
// =============================================================================

export async function generateCompositeContextPacket(
    attemptId: string
): Promise<{ data: CompositeContextPacket | null; error: string | null; validationWarnings?: string[] }> {
    const admin = getServiceRoleClient();

    // ── 1) Fetch attempt ─────────────────────────────────────────────────────
    const { data: attempt, error: attemptError } = await admin
        .from('attempts')
        .select('*')
        .eq('id', attemptId)
        .single();

    if (attemptError || !attempt) {
        return { data: null, error: attemptError?.message ?? 'Attempt not found' };
    }

    // ── 2) Fetch paper ───────────────────────────────────────────────────────
    const { data: paper, error: paperError } = await admin
        .from('papers')
        .select('*')
        .eq('id', attempt.paper_id)
        .single();

    if (paperError || !paper) {
        return { data: null, error: paperError?.message ?? 'Paper not found' };
    }

    // ── 3) Fetch questions with answers (service role bypasses questions_exam) ─
    const { data: questions, error: questionsError } = await admin
        .from('questions')
        .select('id, section, question_number, question_type, question_text, options, correct_answer, solution_text, solution_image_url, video_solution_url, positive_marks, negative_marks, topic, subtopic, difficulty, ideal_time_seconds, set_id, context_id, question_image_url')
        .eq('paper_id', attempt.paper_id)
        .eq('is_active', true)
        .order('section')
        .order('question_number');

    if (questionsError) {
        return { data: null, error: questionsError.message };
    }

    // ── 4) Fetch responses ───────────────────────────────────────────────────
    const { data: responses, error: responsesError } = await admin
        .from('responses')
        .select('question_id, answer, is_correct, marks_obtained, status, time_spent_seconds, visit_count, is_visited, is_marked_for_review, answer_history')
        .eq('attempt_id', attemptId);

    if (responsesError) {
        return { data: null, error: responsesError.message };
    }

    // ── 5) Fetch contexts for RC / DILR passages ─────────────────────────────
    const contextIds = Array.from(
        new Set(
            (questions ?? [])
                .map((q: QuestionRow) => q.context_id)
                .filter((id): id is string => Boolean(id))
        )
    );

    const contextsMap = new Map<string, ContextRow>();
    if (contextIds.length > 0) {
        const { data: ctxRows } = await admin
            .from('question_contexts')
            .select('id, title, content, context_type, section, image_url')
            .in('id', contextIds);

        for (const c of (ctxRows ?? []) as ContextRow[]) {
            contextsMap.set(c.id, c);
        }
    }

    // ── 6) Fetch user aggregate analytics ────────────────────────────────────
    let userProgress: CompositeContextPacket['user_progress'] = null;
    {
        const { data: analytics } = await admin
            .from('user_analytics')
            .select('total_attempts, average_score, average_percentile, best_score, best_percentile, varc_average, dilr_average, qa_average, weak_topics, strong_topics')
            .eq('user_id', attempt.user_id)
            .maybeSingle();

        if (analytics) {
            userProgress = {
                average_score: analytics.average_score != null ? Number(analytics.average_score) : null,
                average_percentile: analytics.average_percentile != null ? Number(analytics.average_percentile) : null,
                best_score: analytics.best_score != null ? Number(analytics.best_score) : null,
                best_percentile: analytics.best_percentile != null ? Number(analytics.best_percentile) : null,
                total_mocks_taken: analytics.total_attempts ?? null,
                varc_average: analytics.varc_average != null ? Number(analytics.varc_average) : null,
                dilr_average: analytics.dilr_average != null ? Number(analytics.dilr_average) : null,
                qa_average: analytics.qa_average != null ? Number(analytics.qa_average) : null,
                weak_topics: analytics.weak_topics ?? null,
                strong_topics: analytics.strong_topics ?? null,
                target_percentile: null,
                target_iims: null,
            };
        }
    }

    // ── 7) Build response lookup ─────────────────────────────────────────────
    const responseMap = new Map<string, ResponseRow>();
    for (const r of (responses ?? []) as ResponseRow[]) {
        responseMap.set(r.question_id, r);
    }

    // ── 8) Group questions by section & build sections[] ─────────────────────
    const sectionOrder: SectionName[] = ['VARC', 'DILR', 'QA'];
    const sectionQuestions = new Map<SectionName, QuestionRow[]>();
    for (const s of sectionOrder) {
        sectionQuestions.set(s, []);
    }
    for (const q of (questions ?? []) as QuestionRow[]) {
        const sec = q.section as SectionName;
        if (sectionQuestions.has(sec)) {
            sectionQuestions.get(sec)!.push(q);
        } else {
            // Unknown section — append to last section or create new
            if (!sectionQuestions.has(sec)) {
                sectionQuestions.set(sec, []);
            }
            sectionQuestions.get(sec)!.push(q);
        }
    }

    // Pre-parsed section_scores from attempt row
    const sectionScores: Record<string, SectionScore> = attempt.section_scores ?? {};

    const sections: SchemaExportSection[] = [];

    for (const sectionName of sectionOrder) {
        const sQuestions = sectionQuestions.get(sectionName) ?? [];
        if (sQuestions.length === 0 && !sectionScores[sectionName]) continue;

        // Sort by question_number within section
        sQuestions.sort((a, b) => a.question_number - b.question_number);

        // Compute section summary from individual items
        let sectionCorrect = 0;
        let sectionIncorrect = 0;
        let sectionUnanswered = 0;
        let sectionTimeSpent = 0;

        const items: SchemaExportItem[] = sQuestions.map((q) => {
            const resp = responseMap.get(q.id);
            const attemptState = deriveAttemptState(resp);
            const didSwitch = deriveDidSwitchAnswer(resp);

            // Count for summary
            if (attemptState === 'correct') sectionCorrect++;
            else if (attemptState === 'incorrect') sectionIncorrect++;
            else sectionUnanswered++;

            const timeSpent = resp?.time_spent_seconds ?? 0;
            sectionTimeSpent += typeof timeSpent === 'number' ? timeSpent : 0;

            // Build context object if this question has a passage/context
            let contextObj: Record<string, unknown> | null = null;
            if (q.context_id && contextsMap.has(q.context_id)) {
                const ctx = contextsMap.get(q.context_id)!;
                contextObj = {
                    id: ctx.id,
                    title: ctx.title ?? null,
                    content_text: ctx.content ?? null,
                    content_type: ctx.context_type ?? null,
                    section: ctx.section ?? null,
                    image_url: ctx.image_url ?? null,
                };
            }

            return {
                question: {
                    question_uuid: q.id,
                    client_question_id: `${q.section}-${q.question_number}`,
                    question_number: q.question_number,
                    question_type: q.question_type,
                    question_text: q.question_text,
                    options: q.options ?? null,
                    correct_answer: q.correct_answer ?? null,
                    solution_text: q.solution_text ?? null,
                    solution_image_url: q.solution_image_url ?? null,
                    video_solution_url: q.video_solution_url ?? null,
                    marks: q.positive_marks,
                    negative_marks: q.negative_marks,
                    topic: q.topic ?? null,
                    subtopic: q.subtopic ?? null,
                    difficulty_level: q.difficulty ?? null,
                    ideal_time_seconds: q.ideal_time_seconds ?? null,
                    set_id: q.set_id ?? null,
                    context_id: q.context_id ?? null,
                    question_image_url: q.question_image_url ?? null,
                },
                context: contextObj,
                user_result: {
                    answer: resp?.answer ?? null,
                    selected_option: null,
                    is_correct: resp?.is_correct ?? null,
                    marks_obtained: resp?.marks_obtained != null ? Number(resp.marks_obtained) : null,
                    time_spent_seconds: resp?.time_spent_seconds != null ? Number(resp.time_spent_seconds) : null,
                    visit_count: resp?.visit_count != null ? Number(resp.visit_count) : null,
                    is_visited: resp?.is_visited ?? null,
                    is_marked_for_review: resp?.is_marked_for_review ?? null,
                    answer_history: Array.isArray(resp?.answer_history) ? resp.answer_history : null,
                },
                derived: {
                    attempt_state: attemptState,
                    did_switch_answer: didSwitch,
                },
            };
        });

        // Use DB section_scores if available, fall back to computed counts
        const dbSectionScore = sectionScores[sectionName];
        const sectionScore = dbSectionScore?.score ?? null;

        sections.push({
            name: sectionName,
            summary: {
                score: sectionScore,
                time_spent_seconds: sectionTimeSpent > 0 ? sectionTimeSpent : null,
                attempted: sectionCorrect + sectionIncorrect,
                correct: sectionCorrect,
                incorrect: sectionIncorrect,
                unanswered: sectionUnanswered,
            },
            items,
        });
    }

    // ── 9) Build composite packet (schema v1) ────────────────────────────────
    const snapshotRunId: string | null = attempt.paper_ingest_run_id ?? paper.latest_ingest_run_id ?? null;

    const packet: CompositeContextPacket = {
        schema_meta: {
            name: 'nexams.ai_analysis_export',
            version: '1.0.0',
            paper_schema_version: '3.0.0',
        },
        generated_at: new Date().toISOString(),
        meta: {
            attempt_id: attempt.id,
            user_id: attempt.user_id,
            paper_id: attempt.paper_id,
            paper_key: paper.slug ?? paper.id,
            exam_name: paper.title ?? 'Untitled',
            source: 'admin_export',
            created_from_ingest_run_id: snapshotRunId,
            notes: !attempt.paper_ingest_run_id
                ? 'This attempt was created before paper version snapshotting. Question content may have changed since the attempt was taken.'
                : null,
        },
        paper: {
            id: paper.id,
            slug: paper.slug,
            title: paper.title,
            year: paper.year,
            description: paper.description ?? null,
            sections: paper.sections ?? [],
            total_questions: paper.total_questions,
            total_marks: paper.total_marks,
            duration_minutes: paper.duration_minutes,
            difficulty_level: paper.difficulty_level ?? null,
            published: paper.published,
        },
        attempt: {
            status: attempt.status,
            started_at: attempt.started_at ?? attempt.created_at,
            submitted_at: attempt.submitted_at ?? null,
            scores: {
                total_score: attempt.total_score ?? null,
                max_possible_score: attempt.max_possible_score ?? null,
                percentile: attempt.percentile ?? null,
                rank: attempt.rank ?? null,
                section_scores: attempt.section_scores ?? {},
            },
            counts: {
                correct: attempt.correct_count ?? 0,
                incorrect: attempt.incorrect_count ?? 0,
                unanswered: attempt.unanswered_count ?? 0,
            },
            timing: {
                time_taken_seconds: attempt.time_taken_seconds ?? null,
                total_paused_seconds: attempt.total_paused_seconds ?? null,
                pause_count: null,
                last_activity_at: attempt.last_activity_at ?? null,
            },
            telemetry: {
                telemetry_log: attempt.telemetry_log ?? null,
            },
        },
        user_progress: userProgress,
        sections,
    };

    // ── 10) Validate against schema v1 (non-fatal) ──────────────────────────
    const validationWarnings: string[] = [];
    try {
        const { valid, errors } = validateAiAnalysisExport(packet);
        if (!valid && errors) {
            const summaries = errors.slice(0, 10).map(
                (e) => `${e.instancePath || '/'}: ${e.message}`
            );
            console.warn('[AI Analysis Export] Schema validation warnings:', summaries);
            validationWarnings.push(...summaries);
        }
    } catch (validationErr) {
        console.warn('[AI Analysis Export] Schema validator threw:', validationErr);
        validationWarnings.push(
            `Validator error: ${validationErr instanceof Error ? validationErr.message : String(validationErr)}`
        );
    }

    return { data: packet, error: null, validationWarnings };
}
````

## File: src/lib/analysis/validateAiAnalysisExport.ts
````typescript
/**
 * @fileoverview Ajv validator for the AI Analysis Export (Composite Context JSON) schema v1
 * @description Compiles the JSON Schema lazily on first use to avoid module-load crashes.
 *   Uses the same Ajv configuration as scripts/ajv-validator.mjs.
 * @blueprint AI Analysis Export — Phase 4 (docs/AI_ANALYSIS_EXPORT.md)
 */

import 'server-only';

import { readFileSync } from 'fs';
import { join } from 'path';

export interface ValidationResult {
    valid: boolean;
    errors?: Array<{ instancePath?: string; message?: string; params?: unknown }>;
}

let _validate: ((data: unknown) => boolean) | null = null;
let _validateFn: { errors?: Array<{ instancePath?: string; message?: string; params?: unknown }> | null } | null = null;
let _initError: string | null = null;

/**
 * Lazily compile the Ajv validator on first call.
 * If Ajv or the schema can't be loaded, logs the error once and
 * returns a no-op validator so the export still succeeds.
 */
function getValidator(): ((data: unknown) => boolean) | null {
    if (_validate) return _validate;
    if (_initError) return null; // already failed once

    try {
        // eslint-disable-next-line @typescript-eslint/no-require-imports
        const Ajv = require('ajv').default || require('ajv');
        // eslint-disable-next-line @typescript-eslint/no-require-imports
        const addFormats = require('ajv-formats').default || require('ajv-formats');

        const schemaPath = join(process.cwd(), 'schemas', 'ai_analysis_export.schema.v1.json');
        const schema = JSON.parse(readFileSync(schemaPath, 'utf8'));

        const ajv = new Ajv({ allErrors: true, strict: false, verbose: true });
        if (typeof addFormats === 'function') {
            addFormats(ajv);
        }

        _validate = ajv.compile(schema);
        _validateFn = _validate as unknown as typeof _validateFn;
        return _validate;
    } catch (err) {
        _initError = err instanceof Error ? err.message : String(err);
        console.error('[AI Analysis Export] Failed to initialize Ajv validator:', _initError);
        return null;
    }
}

/**
 * Validates a composite context JSON payload against the v1 schema.
 * Returns `{ valid: true }` or `{ valid: false, errors: [...] }`.
 * If the validator can't be loaded, returns `{ valid: true }` (skip validation).
 */
export function validateAiAnalysisExport(data: unknown): ValidationResult {
    const validate = getValidator();
    if (!validate) {
        // Validator couldn't load — skip validation, don't block export
        return { valid: true };
    }

    const valid = validate(data);
    return {
        valid: Boolean(valid),
        errors: valid ? undefined : (_validateFn?.errors ?? []),
    };
}
````

## File: .editorconfig
````
# EditorConfig helps maintain consistent coding styles
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
indent_style = space
indent_size = 2

[*.{ts,tsx,js,jsx,css,scss,md}]
charset = utf-8
trim_trailing_whitespace = true
````

## File: .gitattributes
````
.nvmrc text eol=lf
*.sh text eol=lf
````

## File: .repomixignore
````
# Repomix ignore list
# Secrets and environment files
.env
.env.*
.env.local
.env.*.local
*.pem
*.key
*.p12
*.pfx
id_rsa*
service-account*.json

# Build artifacts and dependencies
.next/
node_modules/
.venv/

# Large/generated files
pnpm-lock.yaml
gemini_*.md
repomix-output*
VS_Codebase.md

# Temp export files
.export_sanitized/
.export_tmp/
.repomix-vs-codebase.json

# Original question paper data (use sanitized versions)
data/*.json
data/*.jsonc
````

## File: cat_2025_slot_1.json
````json
{
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "cat-2025-slot-1",
    "title": "CAT 2025 Slot 1",
    "slug": "cat-2025-slot-1",
    "description": "Official CAT 2025 Slot 1 Question Paper",
    "year": 2025,
    "total_questions": 68,
    "total_marks": 204,
    "duration_minutes": 120,
    "sections": [
      "VARC",
      "DILR",
      "QA"
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "hard",
    "is_free": false,
    "published": false,
    "allow_pause": true,
    "attempt_limit": 2
  },
  "question_sets": [
    {
      "client_set_id": "VARC_VA_1",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 1,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_RC_1",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 2,
      "context_type": "rc_passage",
      "context_title": "Electronic Music",
      "content_layout": "single_focus",
      "context_image_url": null,
      "context_body": "Often the well intentioned music lover or the traditionally-minded professional composer asks two basic questions when faced with the electronic music phenomena: (1) is this type of artistic creation music at all? and, (2) given that the product is accepted as music of a new type or order, is not such music \"inhuman\"?... As Lejaren Hiller points out in his book Experimental Music (coauthor Leonard M. Isaacson), two questions which often arise when music is discussed are: (a) the substance of musical communication and its symbolic and semantic significance, if any, and (b) the particular processes, both mental and technical, which are involved in creating and responding to musical composition.\nThe ever-present popular concept of music as a direct, open, emotional expression and as a subjective form of communication from the composer, is, of course still that of the nineteenth century, when composers themselves spoke of music in those terms.... But since the third decade of our century many composers have preferred more objective definitions of music, epitomized in Stravinsky's description of it as \"a form of speculation in terms of sound and time\".\nAn acceptance of this more characteristic twentieth-century view of the art of musical composition will of course immediately bring the layman closer to an understanding of, and sympathetic response to, electronic music, even if the forms, sounds and approaches it uses will still be of a foreign nature to him. A communication problem however will still remain. The principal barrier that electronic music presents at large, in relation to the communication process, is that composers in this medium are employing a new language of forms where terms like 'densities', 'indefinite pitch relations', 'dynamic serialization', 'permutation', etc., are substitutes (or remote equivalents) for the traditional concepts of harmony, melody, rhythm, etc.... When the new structural procedures of electronic music are at last fully understood by the listener the barriers between him and the work he faces will be removed...\nThe medium of electronic music has of course tempted many kinds of composers to try their hand at it.... But the serious-minded composer approaches the world of electronic music with a more sophisticated and profound concept of creation. Although he knows that he can reproduce and employ melodic, rhythmic patterns and timbres of a traditional nature, he feels that it is in the exploration of sui generis languages and forms that the aesthetic magic of the new medium lies. And, conscientiously, he plunges into this search."
    },
    {
      "client_set_id": "VARC_VA_2",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 3,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_RC_2",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 4,
      "context_type": "rc_passage",
      "context_title": "Complex Systems and Tail Events",
      "content_layout": "single_focus",
      "context_image_url": null,
      "context_body": "Understanding the key properties of complex systems can help us clarify and deal with many new and existing global challenges, from pandemics to poverty... A recent study in Nature Physics found transitions to orderly states such as schooling in fish (all fish swimming in the same direction), can be caused, paradoxically, by randomness, or 'noise' feeding back on itself. That is, a misalignment among the fish causes further misalignment, eventually inducing a transition to schooling. Most of us wouldn't guess that noise can produce predictable behaviour.\nThe result invites us to consider how technology such as contact-tracing apps, although informing us locally, might negatively impact our collective movement. If each of us changes our behaviour to avoid the infected, we might generate a collective pattern we had aimed to avoid: higher levels of interaction between the infected and susceptible, or high levels of interaction among the asymptomatic.\nComplex systems also suffer from a special vulnerability to events that don't follow a normal distribution or 'bell curve'. When events are distributed normally, most outcomes are familiar and don't seem particularly striking. Height is a good example: it's pretty unusual for a man to be over 7 feet tall; most adults are between 5 and 6 feet, and there is no known person over 9 feet tall. But in collective settings where contagion shapes behaviour - a run on the banks, a scramble to buy toilet paper - the probability distributions for possible events are often heavy-tailed. There is a much higher probability of extreme events, such as a stock market crash or a massive surge in infections. These events are still unlikely, but they occur more frequently and are larger than would be expected under normal distributions.\nWhat's more, once a rare but hugely significant 'tail' event takes place, this raises the probability of further tail events. We might call them second-order tail events; they include stock market gyrations after a big fall and earthquake aftershocks. The initial probability of second-order tail events is so tiny it's almost impossible to calculate - but once a first-order tail event occurs, the rules change, and the probability of a second-order tail event increases. The dynamics of tail events are complicated by the fact that they result from cascades of other unlikely events.\nWhen COVID-19 first struck, the stock market suffered stunning losses followed by an equally stunning recovery. Some of these dynamics are potentially attributable to former sports bettors, with no sports to bet on, entering the market as speculators rather than investors. The arrival of these new players might have increased inefficiencies and allowed savvy long-term investors to gain an edge over bettors with different goals. One reason a first-order tail event can induce further tail events is that it changes the perceived costs of our actions and changes the rules that we play by. This game-change is an example of another key complex systems concept: nonstationarity. A second, canonical example of nonstationarity is adaptation, as illustrated by the arms race involved in the coevolution of hosts and parasites [in which] each has to 'run' faster, just to keep up with the novel solutions the other one presents as they battle it out in evolutionary time."
    },
    {
      "client_set_id": "VARC_VA_3",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 5,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_RC_3",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 6,
      "context_type": "rc_passage",
      "context_title": "Criminal Responsibility and Mental Science",
      "content_layout": "single_focus",
      "context_image_url": null,
      "context_body": "How can we know what someone else is thinking or feeling, let alone prove it in court? In his 1863 book, A General View of the Criminal Law of England, James Fitzjames Stephen, among the most celebrated legal thinkers of his generation, was of the opinion that the assessment of a person's mental state was an inference made with \"little consciousness.\" In a criminal case, jurors, doctors, and lawyers could watch defendants-scrutinizing clothing, mannerisms, tone of voice-but the best they could hope for were clues. Rounding these clues up to a judgment about a defendant's guilt, or a defendant's life, was an act of empathy and imagination.... The closer the resemblance between defendants and their judges, the easier it was to overlook the gap that inference filled. Conversely, when a defendant struck officials as unlike themselves, whether by dint of disease, gender, confession, or race, the precariousness of judgments about mental state was exposed.\nIn the nineteenth century, physicians who specialized in the study of madness and the care of the insane held themselves out as experts in the new field of mental science. Often called alienists or mad doctors, they were the predecessors of modern psychiatrists, neurologists, and psychologists. The opinions of family and neighbors had once been sufficient to sift the sane from the insane, but a growing belief that insanity was a subtle condition that required expert, medical diagnosis pushed physicians into the witness box.... Lawyers for both prosecution and defense began to recruit alienists to assess defendants' sanity and to testify to it in court.\nIrresponsibility and insanity were not identical, however. Criminal responsibility was a legal concept and not, fundamentally, a medical one. Stephen explained: \"The question 'What are the mental elements of responsibility?' is, and must be, a legal question. It cannot be anything else, for the meaning of responsibility is liability to punishment.\" ... Nonetheless, medical and legal accounts of what it meant to be mentally sound became entangled and mutually referential throughout the nineteenth century. Lawyers relied on medical knowledge to inform their opinions and arguments about the sanity of their clients. Doctors commented on the legal responsibility of their patients. Ultimately, the fields of criminal law and mental science were both invested in constructing an image of the broken and damaged psyche that could be contrasted with the whole and healthy one. This shared interest, and the shared space of the criminal courtroom, made it nearly impossible to consider responsibility without medicine, or insanity without law.\nPhysicians and lawyers shared more than just concern for the mind. Class, race, and gender bound these middle-class, white, professional men together, as did family ties, patriotism, Protestantism, business ventures, the alumni networks of elite schools and universities, and structures of political patronage. But for all their affinities, men of medicine and law were divided by contests over the borders of criminal responsibility, as much within each profession as between them. Alienists steadily pushed the boundaries of their field, developing increasingly complex and capacious definitions of insanity. Eccentricity and aggression came to be classified as symptoms of mental disease, at least by some."
    },
    {
      "client_set_id": "VARC_VA_4",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 7,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_RC_4",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 8,
      "context_type": "rc_passage",
      "context_title": "Income Inequality and Economic Growth",
      "content_layout": "single_focus",
      "context_image_url": null,
      "context_body": "Studies showing that income inequality plays a positive role in economic growth are largely based on three arguments. The first argument focuses on investment indivisibilities wherein large sunk costs are required when implementing new fundamental innovations. Without stock markets and financial institutions to mobilize large sums of money, a high concentration of wealth is needed for individuals to undertake new industrial activities accompanied by high sunk costs... [One study] shows the relation between economic growth and income inequality for 45 countries during 1966-1995. [It was found that the increase in income inequality has a significant positive relationship with economic growth in the short and medium term. Using system GMM, [another study estimated] the relation between income inequality and economic growth for 106 countries during 1965-2005 period. The results show that income inequality has a positive impact on economic growth in the short run, but the two are negatively correlated in the long run.\nThe second argument is related to moral hazard and incentives... Because economic performance is determined by the unobservable level of effort that agents make, paying compensations without taking into account the economic performance achieved by individual agents will fail to elicit optimum effort from the agents. Thus, certain income inequalities contribute to growth by enhancing worker motivation. and by giving motivation to innovators and entrepreneurs... Finally, [another study] point[s] out that the concentration of wealth or stock ownership in relation to corporate governance contributes to growth. If stock ownership is distributed and owned by a large number of shareholders, it is not easy to make quick decisions due to the conflicting interests among shareholders, and this may also cause a free-rider problem in terms of monitoring and supervising managers and workers.\nVarious studies have examined the relationships between income inequality and economic growth, and most of these assert that a negative correlation exists between the two. Analyzing 159 countries for 1980-2012, they conclude that there exists a negative relation between income inequality and economic growth; when the income share of the richest 20% of population increases by 1%, the GDP decreases by 0.08%, whereas when the income share of the poorest 20% of population increases by 1%, the GDP increases by 0.38%. Some studies find that inequality has a negative impact on growth due to poor human capital accumulation and low fertility rates... while [others] point out that inequality creates political instability, resulting in lower investment.... [Some economists] argue that widening income inequality has a negative impact on economic growth because it negatively affects social consensus or social capital formation.\nOne important research topic is the correlation between democratization and income redistribution. [Some scholars] explain that social pressure for income redistribution rises as income inequality increases in a democratic society. In other words, when democratization extends suffrage to a wider class of people, the increased political power of low- and middle-income voters results in broader support for income redistribution and social welfare expansion. However... if the rich have more political influence than the poor, the democratic system actually worsens income inequality rather than improving it."
    },
    {
      "client_set_id": "VARC_VA_5",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 9,
      "context_image_url": null
    },
    {
      "client_set_id": "DILR_SET_1",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 1,
      "context_type": "dilr_set",
      "context_title": "Round Table Seating",
      "content_layout": "split_table",
      "context_image_url": null,
      "context_body": "A round table has seven chairs around it. The chairs are numbered 1 through 7 in a clockwise direction. Four friends, Aslam, Bashir, Chhavi, and Davies, sit on four of the chairs. In the starting position, Aslam and Chhavi are sitting next to each other, while for Bashir as well as Davies, there are empty chairs on either side of the chairs that are sitting on. The friends take turns moving either clockwise or counterclockwise from their chair. The friend who has to move in a turn occupies the first empty chair in whichever direction (s) he chooses to move.\nAslam moves first (Turn 1), followed by Bashir, Chhavi, and Davies (Turns 2, 3, and 4, respectively). Then Aslam moves again followed by Bashir, and Chhavi (Turns 5, 6, and 7, respectively).\nThe following information is known:\n1. The four friends occupy adjacent chairs only at the end of Turn 2 and Turn 6.\n2. Davies occupies Chair 2 after Turn 1 and Chair 4 after Turn 5, and Chhavi occupies Chair 7 after Turn 2."
    },
    {
      "client_set_id": "DILR_SET_2",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 2,
      "context_type": "dilr_set",
      "context_title": "InnovateX Ratings",
      "content_layout": "split_table",
      "context_image_url": null,
      "context_body": "At InnovateX, six employees, Asha, Bunty, Chintu, Dolly, Eklavya, and Falguni, were split into two groups of three each: Elite led by Manager Kuku, and Novice led by Manager Lalu. At the end of each quarter, Kuku and Lalu handed out ratings to all members in their respective groups. In each group, each employee received a distinct integer rating from 1 to 3. The score for an employee at the end of a quarter is defined as their cumulative rating from the beginning of the year.\nAt the end of each quarter the employee in Novice with the highest score was promoted to Elite, and the employee in Elite with the minimum score was demoted to Novice. If there was a tie in scores, the employee with a higher rating in the latest quarter was ranked higher.\nAsha, Bunty, and Chintu were in Elite at the beginning of Quarter 1. All of them were in Novice at the beginning of Quarter 4. Dolly and Falguni were the only employees who got the same rating across all the quarters.\nThe following is known about ratings given by Lalu:\n1. Bunty received a rating of 1 in Quarter 2.\n2. Asha and Dolly received ratings of 1 and 2, respectively, in Quarter 3."
    },
    {
      "client_set_id": "DILR_SET_3",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 3,
      "context_type": "dilr_set",
      "context_title": "Import Tariffs",
      "content_layout": "split_table",
      "context_image_url": null,
      "context_body": "Five countries engage in trade with each other. Each country levies import tariffs on the other countries. The import tariff levied by Country X on Country Y is calculated by multiplying the corresponding tariff percentage with the total imports of Country X from Country Y.\nThe radar chart (not shown) depicts different import tariff percentages charged by each of the five countries on the others. For example, US (the blue line in the chart) charges 20%, 40%, 30%, and 30% import tariff percentages on imports from France, India, Japan, and UK, respectively. The bar chart (not shown) depicts the import tariffs levied by each county on other countries. For example, US charged import tariff of 3 billion USD on UK.\nAssume that imports from one country to another equals the exports from the latter to the former. The trade surplus of Country X with Country Y is defined as: Exports from Country X to Country Y - Imports to Country X from Country Y."
    },
    {
      "client_set_id": "DILR_SET_4",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 4,
      "context_type": "dilr_set",
      "context_title": "Train Booking",
      "content_layout": "split_table",
      "context_image_url": null,
      "context_body": "A train travels from Station A to Station E, passing through stations B, C, and D, in that order. The train has a seating capacity of 200. A ticket may be booked from any station to any other station ahead on the route. A ticket reserves one seat on every intermediate segment. The occupancy factor for a segment is the total number of seats reserved in the segment as a percentage of the seating capacity.\nInformation:\n1. Segment C - D had an occupancy factor of 95%. Only segment B - C had a higher occupancy factor.\n2. Exactly 40 tickets were booked from B to C and 30 tickets were booked from B to E.\n3. Among the seats reserved on segment D - E, exactly four-sevenths were from stations before C.\n4. The number of tickets booked from A to C was equal to that booked from A to E, and it was higher than that from B to E.\n5. No tickets were booked from A to B, from B to D and from D to E.\n6. The number of tickets booked for any segment was a multiple of 10."
    },
    {
      "client_set_id": "DILR_SET_5",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 5,
      "context_type": "dilr_set",
      "context_title": "Foot Tapping Game",
      "content_layout": "split_table",
      "context_image_url": null,
      "context_body": "Alia, Badal, Clive, Dilshan, and Ehsaan played a game where each asks a unique question to all others, who respond by tapping feet: 1 tap (\"Yes\"), 2 taps (\"No\"), 3 taps (\"Maybe\").\nTotal taps = 40. Each question got at least one Yes, No, and Maybe.\nInformation:\n1. Alia tapped 6 times total and received 9 taps. She said \"Yes\" to Clive and Dilshan.\n2. Dilshan tapped 11 times, Ehsaan tapped 9 times. Dilshan said \"No\" to Badal.\n3. Badal, Dilshan, and Ehsaan received equal number of taps.\n4. No one said \"Yes\" more than twice.\n5. No one's answer to Alia matched Alia's answer to them. Same for Ehsaan.\n6. Clive tapped more times than Badal."
    },
    {
      "client_set_id": "QA_ATOMIC_47",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 1,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_48",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 2,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_49",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 3,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_50",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 4,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_51",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 5,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_52",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 6,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_53",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 7,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_54",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 8,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_55",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 9,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_56",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 10,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_57",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 11,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_58",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 12,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_59",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 13,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_60",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 14,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_61",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 15,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_62",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 16,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_63",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 17,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_64",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 18,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_65",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 19,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_66",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 20,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_67",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 21,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_68",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 22,
      "context_image_url": null
    }
  ],
  "questions": [
    {
      "client_question_id": "cat-2025-slot-1_Q1",
      "set_ref": "VARC_VA_1",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 1,
      "question_type": "TITA",
      "taxonomy_type": "va_odd_one",
      "topic": "Verbal Ability",
      "subtopic": "Para Jumbles (Odd One Out)",
      "difficulty": "medium",
      "correct_answer": "4",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Five jumbled sentences (labelled 1, 2, 3, 4, and 5), related to a topic, are given below. Four of them can be put together to form a coherent paragraph. Identify the odd sentence out and key in the number of that sentence as your answer.\n1. Developments both technological and sociocultural have afforded us far greater freedom over death than we had in the past, and while we are still adapting ourselves to that freedom, we now appreciate the moral importance of this freedom.\n2. But I believe that a type of freedom we can call freedom over death that is, a freedom in which we shape the timing and circumstances of how we die - should be central to this conversation.\n3. Legalising assisted dying is but a further step in realising this freedom over death.\n4. Many people endorse, through their opinions or their choices, our freedom over death, encompassing a right to medical assistance in hastening our deaths.\n5. Freedom is a notoriously complex and contested philosophical notion, and I won't pretend to settle any of the big controversies it raises.",
      "solution_text": "The paragraph discusses \"freedom over death\" specifically in the context of assisted dying and shaping the timing of death (Sentences 1, 2, 3, 4). Sentence 5 discusses \"freedom\" as a general philosophical notion, which is too broad and disconnects from the specific argument about death and assisted dying."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q2",
      "set_ref": "VARC_RC_1",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 2,
      "question_type": "MCQ",
      "taxonomy_type": "rc_structure",
      "topic": "Reading Comprehension",
      "subtopic": "Music",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The goal of the author over the course of this passage is to:",
      "options": [
        {
          "id": "A",
          "text": "differentiate the modern composer from the nineteenth century composer"
        },
        {
          "id": "B",
          "text": "differentiate between electronic music and other forms of music."
        },
        {
          "id": "C",
          "text": "defend the \"serious-minded composer\" from Lejaren Hill and Stravinsky."
        },
        {
          "id": "D",
          "text": "defend electronic music from certain common charges."
        }
      ],
      "solution_text": "The author starts by listing charges against electronic music (is it music? is it inhuman?) and then addresses the definitions of music and the \"communication problem\" to bridge the gap for the listener, effectively defending the genre."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q3",
      "set_ref": "VARC_RC_1",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 3,
      "question_type": "MCQ",
      "taxonomy_type": "rc_structure",
      "topic": "Reading Comprehension",
      "subtopic": "Music",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "What relation does the \"communication problem\" mentioned in paragraph 2 have to the questions that the author recounts at the beginning of the passage?",
      "options": [
        {
          "id": "A",
          "text": "Unfamiliar forms and terms might get in the way of our seeing electronic music as music, but this can be overcome."
        },
        {
          "id": "B",
          "text": "Its unfamiliar \"language of forms\" and novel terms mean that we cannot see electronic music as music since it does not employ traditional musical concepts."
        },
        {
          "id": "C",
          "text": "None; they are unrelated to one another and form parts of different discussions."
        },
        {
          "id": "D",
          "text": "The communication problem is what allows us to see electronic music as music because music must be difficult to understand."
        }
      ],
      "solution_text": "The initial questions ask if it is music at all. The communication problem explains *why* it might not seem like music (unfamiliar language of forms) but argues that understanding these procedures removes the barrier."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q4",
      "set_ref": "VARC_RC_1",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 4,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Music",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The mention of Stravinsky's description of music in the first paragraph does all the following EXCEPT:",
      "options": [
        {
          "id": "A",
          "text": "help us determine which sounds are musical and which are not."
        },
        {
          "id": "B",
          "text": "respond to and expand upon earlier understandings of music."
        },
        {
          "id": "C",
          "text": "complicate our notion of what is communicated through music."
        },
        {
          "id": "D",
          "text": "allow us to classify electronic music as music."
        }
      ],
      "solution_text": "Stravinsky's definition (\"speculation in terms of sound and time\") is used to move away from 19th-century emotional definitions (B), allows for a broader view including electronic music (D), and shifts focus from subjective communication (C). It does not provide a rubric for determining which specific *sounds* are musical (A)."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q5",
      "set_ref": "VARC_RC_1",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 5,
      "question_type": "MCQ",
      "taxonomy_type": "rc_vocab",
      "topic": "Reading Comprehension",
      "subtopic": "Music",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "From the context in which it is placed, the phrase \"sui generis\" in paragraph 3 suggests which one of the following?",
      "options": [
        {
          "id": "A",
          "text": "Particular"
        },
        {
          "id": "B",
          "text": "Generic"
        },
        {
          "id": "C",
          "text": "Unaesthetic"
        },
        {
          "id": "D",
          "text": "Indescribable"
        }
      ],
      "solution_text": "\"Sui generis\" means unique or of its own kind/particular to itself. The context contrasts reproducing traditional patterns with exploring languages unique to the new medium."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q6",
      "set_ref": "VARC_VA_2",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 6,
      "question_type": "TITA",
      "taxonomy_type": "va_jumble",
      "topic": "Verbal Ability",
      "subtopic": "Para Jumbles",
      "difficulty": "medium",
      "correct_answer": "2143",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The four sentences (labelled 1, 2, 3, and 4) given below, when properly sequenced, would yield a coherent paragraph. Decide on the proper sequencing of the order of the sentences and key in the sequence of the four numbers as your answer.\n1. it can increase the effect of this function, by being linked closely with it;\n2. It can in fact be integrated into any function (education, medical treatment, production, punishment);\n3. it can establish a direct proportion between 'surplus power' and 'surplus production'.\n4. it can constitute a mixed mechanism in which relations of power (and of knowledge) may be precisely adjusted, in the smallest detail, to the processes that are to be supervised;\n[Context sentences provided in source for flow check, but strict sequencing relies on 1-4]:\n(Source text indicates: \"The panoptic mechanism is not simply... It's a case of 'it's easy once you've thought of it'...\" followed by the sentences).",
      "solution_text": "2 introduces the idea that \"it\" can be integrated into any function. 1 follows by saying it increases the effect of \"this function\" (linking back to 2). 4 expands on how it constitutes a mechanism within that function. 3 concludes with the result (surplus power/production)."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q7",
      "set_ref": "VARC_VA_2",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 7,
      "question_type": "MCQ",
      "taxonomy_type": "va_placement",
      "topic": "Verbal Ability",
      "subtopic": "Sentence Placement",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The given sentence is missing in the paragraph below. Decide where it best fits among the options 1, 2, 3, or 4 indicated in the paragraph.\nSentence: \"Everything is old-world, traditional techniques from Mexico,\" Ava emphasizes.\nParagraph: The sisters embrace the ways their great-grandfather built and repaired instruments. (1) When crafting a Mexican guitarron used in mariachi music, they use tacote wood for the top of the instrument. Once the wood is cut, they carve the neck and heel from a single block using tools like hand saws, chisels and sandpaper rather than modern power tools and believe that this traditional method improves the tone of the instrument. (2) Their store has a three-year waitlist for instruments that take months to create. (3) The family's artisanship has attracted stars like Los Lobos, who own custom guitars made by all three generations of the Delgado family. (4) For the sisters, involvement in the family business started at an early age. They each built their first instruments at age 9.",
      "options": [
        {
          "id": "A",
          "text": "Option 1"
        },
        {
          "id": "B",
          "text": "Option 4"
        },
        {
          "id": "C",
          "text": "Option 2"
        },
        {
          "id": "D",
          "text": "Option 3"
        }
      ],
      "solution_text": "The sentence mentions \"old-world, traditional techniques\". The sentence following (1) describes these techniques in detail (\"carve... hand saws... rather than modern power tools\"). Thus, the sentence introduces the description that follows immediately at (1)."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q8",
      "set_ref": "VARC_VA_2",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 8,
      "question_type": "MCQ",
      "taxonomy_type": "va_placement",
      "topic": "Verbal Ability",
      "subtopic": "Sentence Placement",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The given sentence is missing in the paragraph below. Decide where it best fits among the options 1, 2, 3, or 4 indicated in the paragraph.\nSentence: Historically, silver has been, and still is, an important element in the business of 'show' visible in private houses, churches, government and diplomacy.\nParagraph: (1) Timothy Schroder put it succinctly in suggesting that electric light and eating in the kitchen eroded this need. As he explained to the author, 'Silver, when illuminated by flickering candlelight, comes alive and almost dances before the eyes, but when lit by electric light, it becomes flat and dead.' (2) Domestic and economic changes may have worked against the market, but the London silver trade remained buoyant, thanks to the competition of collectors seeking grand display silver at the top end, and the buyers of 'collectables', like spoons and wine labels and 'novelties', at the bottom. (3) Another factor that came into play was the systematic collection building of certain American museums over the period. Boston, Huntington Art Gallery and Williamsburg, among others, were largely supplied by London dealers. (4)",
      "options": [
        {
          "id": "A",
          "text": "Option 4"
        },
        {
          "id": "B",
          "text": "Option 3"
        },
        {
          "id": "C",
          "text": "Option 1"
        },
        {
          "id": "D",
          "text": "Option 2"
        }
      ],
      "solution_text": "Option 3 is the correct answer (Key: B). The sentence introduces the historical importance of silver in \"show\". The paragraph following (1) discusses the decline of this need (electric light). The sentence actually seems to fit best as an intro, but given the options, placing it at (3) doesn't seem right contextually compared to the start. *Correction*: Let's re-read carefully. The sentence is about silver being an element of 'show'. (1) discusses the erosion of \"this need\" (implying the need for show/silver was mentioned prior). However, if we look at Option 3 (Source: B), the sentence might be unrelated to the museum factor. Let's look at the Official Answer provided in source. Source says `Correct Answer: B` which corresponds to `Option 3`."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q9",
      "set_ref": "VARC_RC_2",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 9,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Sociology/Economics",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "All of the following inferences are supported by the passage EXCEPT that:",
      "options": [
        {
          "id": "A",
          "text": "examples like runs on banks and toilet paper scrambles illustrate how contagion can amplify local choices into system-wide cascades that surprise participants and lead to patterns they did not intend to create."
        },
        {
          "id": "B",
          "text": "learning can change the rules that actors face. So, a rare shock can alter payoffs and raise the odds of subsequent large disturbances within the same system, which supports the idea of second-order tail events."
        },
        {
          "id": "C",
          "text": "heavy-tailed events make extreme outcomes more frequent and larger than bell curve expectations. This complicates forecasting and risk management in collective settings shaped by contagion and copying behaviour."
        },
        {
          "id": "D",
          "text": "the text attributes the COVID-19 pandemic rebound in financial markets solely to displaced sports bettors and treats their entry as the overriding cause of the rapid recovery across assets and time horizons."
        }
      ],
      "solution_text": "The text states \"Some of these dynamics are potentially attributable to former sports bettors...\" (probability/partial attribution), whereas Option D claims it attributes the rebound *solely* to them and treats it as the *overriding* cause. This is too strong and not supported."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q10",
      "set_ref": "VARC_RC_2",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 10,
      "question_type": "MCQ",
      "taxonomy_type": "rc_summary",
      "topic": "Reading Comprehension",
      "subtopic": "Sociology/Economics",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the options below best summarises the passage?",
      "options": [
        {
          "id": "A",
          "text": "The passage explains how social outcomes generally follow normal distributions. So, extreme events are negligible, and policy should stabilise averages rather than learn from large shocks in fast-changing collective settings."
        },
        {
          "id": "B",
          "text": "The passage explains how noise can create order, then shows why complex systems with contagion are vulnerable to heavy-tailed cascades. It also explains why early shocks change rules through nonstationarity with a market illustration during the COVID-19 disruption."
        },
        {
          "id": "C",
          "text": "The passage explains how speculative entrants always produce inefficiency after health shocks. Therefore, long-term investors invariably profit when new participants push prices away from fundamentals under pandemic conditions and comparable crises."
        },
        {
          "id": "D",
          "text": "The passage explains how nonstationarity works in evolutionary biology and rejects applications in markets or public health because adaptation is exclusive to parasite-host systems and cannot arise in technology-mediated social dynamics."
        }
      ],
      "solution_text": "Option B captures the key points: noise creating order (fish/apps), vulnerability to heavy-tailed events (contagion), and nonstationarity (rules changing after shocks, COVID/market example)."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q11",
      "set_ref": "VARC_RC_2",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 11,
      "question_type": "MCQ",
      "taxonomy_type": "rc_strengthen",
      "topic": "Reading Comprehension",
      "subtopic": "Sociology/Economics",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following observations would most strengthen the passage's claim that a first-order tail event raises the probability of further tail events in complex systems?",
      "options": [
        {
          "id": "A",
          "text": "In epidemic networks, initial super-spreading episodes are isolated spikes after which outbreak sizes match the baseline distribution from independent contact models across comparable cities with no rise in the frequency or size of later extreme clusters."
        },
        {
          "id": "B",
          "text": "River discharge records show water levels fit a normal distribution with thin tails that match laboratory data, regardless of storms or floods."
        },
        {
          "id": "C",
          "text": "After a major equity crash, researchers find dense clusters of large daily moves for several weeks, with extreme days occurring far more often than in normal circumstances for assets with customarily low volatility profiles."
        },
        {
          "id": "D",
          "text": "Following large earthquakes, regional seismic activity returns to baseline within hours with no aftershock sequence once data are adjusted for reporting effects, which suggests independence across events rather than any elevation in subsequent tail probabilities."
        }
      ],
      "solution_text": "The claim is that a first tail event *increases* the probability of subsequent ones (clustering). Option C explicitly describes this: after a crash (first event), extreme days occur \"far more often\" (increased probability of second-order events)."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q12",
      "set_ref": "VARC_RC_2",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 12,
      "question_type": "MCQ",
      "taxonomy_type": "rc_assumption",
      "topic": "Reading Comprehension",
      "subtopic": "Sociology/Economics",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The passage suggests that contact tracing apps could inadvertently raise risky interactions by altering local behaviour. Which one of the assumptions below is most necessary for that suggestion to hold?",
      "options": [
        {
          "id": "A",
          "text": "Most users uninstall apps within a week, which leaves only highly exposed individuals participating. This neutralises any systematic bias in routing decisions and prevents any predictable change in aggregate contact patterns."
        },
        {
          "id": "B",
          "text": "Individuals base movement choices partly on observed infections and on the behaviour of others. So, local responses interact, which turns many small adjustments into large scale patterns that can frustrate the intended aim of risk reduction."
        },
        {
          "id": "C",
          "text": "App alerts always include precise location to within one metre and deliver real time updates for all users, which ensures that the data feed is perfectly accurate regardless of privacy settings, power limits, or network conditions."
        },
        {
          "id": "D",
          "text": "Urban networks have uniform traffic conditions at all hours, which allows perfectly predictable routing independent of personal choices, social signals, or crowd reactions and, therefore, makes interdependence negligible in city movement decisions."
        }
      ],
      "solution_text": "For local changes to generate a collective pattern (as argued in the passage), individuals must be reacting to the information (observed infections/others' behavior) and these reactions must interact to form the new pattern. Option B articulates this mechanism."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q13",
      "set_ref": "VARC_VA_3",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 13,
      "question_type": "TITA",
      "taxonomy_type": "va_jumble",
      "topic": "Verbal Ability",
      "subtopic": "Para Jumbles",
      "difficulty": "medium",
      "correct_answer": "3421",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The four sentences (labelled 1, 2, 3, and 4) given below, when properly sequenced, would yield a coherent paragraph. Decide on the proper sequencing of the order of the sentences and key in the sequence of the four numbers as your answer.\n1. But man, woman or otherwise, there is no denying that the quality of our life and character will be significantly shaped by the way we handle our anger.\n2. Once the taboos have been broken, women usually experience letting their fists fly as intensely liberating.\n3. Though this might seem a stereotype, women-unlike men, who are frequently applauded for unbridled aggression are often socialized to keep a lid on their ire.\n4. Many of them are so at odds with their aggressive feelings that, as a coach, I often have to stop them from pulling their punches and encourage them to extend their arms so their blows might actually reach their fleshy target.",
      "solution_text": "3 introduces the topic (women socialized to hide anger vs men). 4 elaborates on the consequence (pulling punches). 2 describes the result of overcoming this (liberating). 1 concludes with a general statement about handling anger."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q14",
      "set_ref": "VARC_VA_3",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 14,
      "question_type": "MCQ",
      "taxonomy_type": "va_summary",
      "topic": "Verbal Ability",
      "subtopic": "Paragraph Summary",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The passage given below is followed by four summaries. Choose the option that best captures the essence of the passage.\nZombie cells may contribute to age-related chronic inflammation: this finding could help scientists understand more about the aging process and why the immune system becomes less effective as we get older. Zombie or \"senescent\" cells are damaged cells that can no longer divide and grow like normal cells. Scientists think that these cells can contribute to chronic health problems when they accumulate in the body. In younger people, the immune system is more effective at clearing senescent cells from the body through a process called apoptosis, but as we age, this process becomes less efficient. As a result, there is an accumulation of senescent cells in different organs in the body, either through increased production or reduced clearance by the immune system. The zombie cells continue to use energy though they do not divide, and often secrete chemicals that cause inflammation, which if persistent for longer periods of time can damage healthy cells leading to chronic diseases.",
      "options": [
        {
          "id": "A",
          "text": "Senescent \"zombie\" cells are inactive or malfunctioning cells that can be found throughout the body."
        },
        {
          "id": "B",
          "text": "A younger person's immune system is healthy and is able to clear the damaged cells, but as people age, the zombie cells resist apoptosis, and start accumulating in the body."
        },
        {
          "id": "C",
          "text": "Aging leads to less effective apoptosis, and therefore zombie cells start to accumulate in the body, causing inflammation, which accelerates aging and leads to chronic diseases."
        },
        {
          "id": "D",
          "text": "Dead cells accelerate chronic inflammation weakening the immune system and lead to aging."
        }
      ],
      "solution_text": "Option C covers the causal chain: Aging -> less effective apoptosis -> accumulation of zombie cells -> inflammation -> chronic disease/aging."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q15",
      "set_ref": "VARC_RC_3",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 15,
      "question_type": "MCQ",
      "taxonomy_type": "rc_detail",
      "topic": "Reading Comprehension",
      "subtopic": "History/Law",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The last paragraph of the passage refers to \"middle-class, white, professional men\". Which one of the following qualities best describes the connection among them?",
      "options": [
        {
          "id": "A",
          "text": "The borders of criminal responsibility."
        },
        {
          "id": "B",
          "text": "The opinions of family and neighbours."
        },
        {
          "id": "C",
          "text": "Eccentricity and aggression."
        },
        {
          "id": "D",
          "text": "Empathy and imagination."
        }
      ],
      "solution_text": "The paragraph states they were bound by class, race, gender, etc., BUT \"divided by contests over the borders of criminal responsibility\". The question asks what describes the *connection*? Actually, looking at the options, A, B, C, D are phrases from the text. The question asks for the connection. The text says \"Class, race, and gender bound these... men together\". However, the options don't list those. Let's re-read carefully. The men were *divided* by \"contests over the borders of criminal responsibility\". This seems to be the point of *tension* or the defining professional struggle connecting their interaction in the courtroom. Wait, looking at the official answer A (\"The borders of criminal responsibility\"), it seems the question implies what issue connected/involved them professionally, even if it was a contest. Or perhaps it implies they were connected by the *debate* over it."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q16",
      "set_ref": "VARC_RC_3",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 16,
      "question_type": "MCQ",
      "taxonomy_type": "rc_factual",
      "topic": "Reading Comprehension",
      "subtopic": "History/Law",
      "difficulty": "easy",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "According to the passage, who or what was an \"alienist\"?",
      "options": [
        {
          "id": "A",
          "text": "Professionals who pushed the boundaries of their fields till they became unrecognisable in the nineteenth century."
        },
        {
          "id": "B",
          "text": "Physicians who specialised in the study of madness and the care of the insane in the nineteenth century."
        },
        {
          "id": "C",
          "text": "Physicians and lawyers who were responsible for the condition of immigrants or 'aliens' in the nineteenth century."
        },
        {
          "id": "D",
          "text": "Physicians and lawyers who were responsible for examining accounts of extraterrestrials or 'aliens' in the nineteenth century."
        }
      ],
      "solution_text": "Direct quote: \"physicians who specialized in the study of madness and the care of the insane... Often called alienists\"."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q17",
      "set_ref": "VARC_RC_3",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 17,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "History/Law",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Study the following sets of concepts and identify the set that is conceptually closest to the concerns and arguments of the passage.",
      "options": [
        {
          "id": "A",
          "text": "Empathy, Prosecution, Knowledge, Business."
        },
        {
          "id": "B",
          "text": "Judgement, Belief, Accounts, Patronage."
        },
        {
          "id": "C",
          "text": "Assessment, Empathy, Prosecution, Patriotism."
        },
        {
          "id": "D",
          "text": "Judgement, Insanity, Punishment, Responsibility."
        }
      ],
      "solution_text": "The passage discusses the judgment of mental states, the definition of insanity vs legal responsibility, and liability to punishment. Set D covers the core legal/medical intersection discussed."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q18",
      "set_ref": "VARC_RC_3",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 18,
      "question_type": "MCQ",
      "taxonomy_type": "rc_vocab",
      "topic": "Reading Comprehension",
      "subtopic": "History/Law",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "\"Conversely, when a defendant struck officials as unlike themselves, whether by dint of disease, gender, confession, or race, the precariousness of judgments about mental state was exposed.\" Which one of the following best describes the use of the word \"confession\" in this sentence?",
      "options": [
        {
          "id": "A",
          "text": "Referring to the practice of 'confession' in some faiths, here it is a metaphor for the religion of the defendant."
        },
        {
          "id": "B",
          "text": "Referring to the gender, race or disease claimed as a defence by the defendant, here it is a synonym for 'professing' a gender, race, or disease."
        },
        {
          "id": "C",
          "text": "Referring to the defendant's confession of his or her crime as false, because 'didn't' is an archaic form of 'didn't' or 'did not'."
        },
        {
          "id": "D",
          "text": "The defendants struck out at the officials and then confessed to the act."
        }
      ],
      "solution_text": "The list \"disease, gender, confession, or race\" refers to attributes that make the defendant \"unlike\" the officials (who are Protestant, white, men). \"Confession\" here likely refers to religious confession (Catholicism etc.), serving as a marker for religion/faith, contrasting with the \"Protestantism\" of the officials mentioned later."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q19",
      "set_ref": "VARC_VA_4",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 19,
      "question_type": "TITA",
      "taxonomy_type": "va_odd_one",
      "topic": "Verbal Ability",
      "subtopic": "Para Jumbles (Odd One Out)",
      "difficulty": "medium",
      "correct_answer": "1",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Five jumbled sentences (labelled 1, 2, 3, 4, and 5), related to a topic, are given below. Four of them can be put together to form a coherent paragraph. Identify the odd sentence out and key in the number of that sentence as your answer.\n1. The Bayeux tapestry was, therefore, an obvious way to tell people about the downfall of the English and the rise of the Normans.\n2. So if we take expert in Anglo-Saxon culture Gale Owen-Crocker's idea that the tapestry was originally hung in a square with certain scenes facing each other, people would have stood in the centre.\n3. Art historian Linda Neagley has argued that pre-Renaissance people interacted with art visually, kinaesthetically (sensory perception through bodily movement) and physically.\n4. That would make it an 11th-century immersive space with scenes corresponding and echoing each other, drawing the viewer's attention, playing on their senses and understanding of the story they thought they knew.\n5. The Bayeux tapestry would have been hung at eye level to enable this.",
      "solution_text": "Sentences 3, 2, 4, 5 connect logically: 3 introduces how people interacted with art (visually/physically). 2 applies this to the Bayeux tapestry (hung in a square, people in center). 4 explains the effect (immersive space). 5 adds the detail about hanging at eye level to enable this interaction. Sentence 1 discusses the *content/purpose* (propaganda about Normans), which is distinct from the *physical experience/installation* theme of the other four."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q20",
      "set_ref": "VARC_RC_4",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 20,
      "question_type": "MCQ",
      "taxonomy_type": "rc_summary",
      "topic": "Reading Comprehension",
      "subtopic": "Economics",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the options below best summarises the passage?",
      "options": [
        {
          "id": "A",
          "text": "The passage claims that evaluating the effect of income inequality on economic growth without considering both short- and long-term consequences is misguided"
        },
        {
          "id": "B",
          "text": "The passage confines its discussion to financing gaps and corporate control while undercutting cross country evidence and overlooking the significance of concerns regarding human capital accumulation, fertility rates, and income redistribution under democratisation."
        },
        {
          "id": "C",
          "text": "The passage argues that income inequality accelerates economic growth while also emphasising the significance of concerns regarding human capital accumulation, fertility rates, and political instability."
        },
        {
          "id": "D",
          "text": "The passage outlines investment, incentive, and governance channels through which income inequality may support economic growth and reports short-term gains while noting longterm drawbacks"
        }
      ],
      "solution_text": "Option D covers the first half (investment, incentive, governance channels for positive growth) and the second half (short-term gains vs long-term negative correlations/drawbacks found in other studies)."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q21",
      "set_ref": "VARC_RC_4",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 21,
      "question_type": "MCQ",
      "taxonomy_type": "rc_vocab",
      "topic": "Reading Comprehension",
      "subtopic": "Economics",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The passage refers to \"democratization\". Choose the one option below that comes closest to the opposite of this process.",
      "options": [
        {
          "id": "A",
          "text": "After the emergency decree, the regime shifted toward authoritarianism as suffrage narrowed and opposition parties were deregistered."
        },
        {
          "id": "B",
          "text": "Corporate donations were capped and parties received public funding which was portrayed as establishing an oligarchy."
        },
        {
          "id": "C",
          "text": "Municipalities adopted participatory budgeting and recall elections which a press release called totalitarianism."
        },
        {
          "id": "D",
          "text": "The coalition imposed term limits and strengthened judicial review in order to further entrench autocratic rule."
        }
      ],
      "solution_text": "Democratization involves extending suffrage and political power to a wider class. Option A describes the opposite: narrowing suffrage and deregistering parties (authoritarianism)."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q22",
      "set_ref": "VARC_RC_4",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 22,
      "question_type": "MCQ",
      "taxonomy_type": "rc_structure",
      "topic": "Reading Comprehension",
      "subtopic": "Economics",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The primary function of the three-part case for a positive income inequality-economic growth link in the first half of the passage is to show that:",
      "options": [
        {
          "id": "A",
          "text": "inequality boosts growth in every period and type of economy, regardless of finance or governance conditions."
        },
        {
          "id": "B",
          "text": "mature stock markets make wealth concentration unnecessary, yet they might still be harmful to investment."
        },
        {
          "id": "C",
          "text": "inequality can aid short-term growth in settings with high sunk costs, incentive alignment, and concentrated ownership."
        },
        {
          "id": "D",
          "text": "dispersed ownership speeds corporate decision-making and removes free rider problems."
        }
      ],
      "solution_text": "The arguments focus on specific conditions: high sunk costs (investment indivisibilities), incentive alignment (moral hazard), and corporate governance (concentrated ownership). The studies cited mentioned positive impact in the \"short run\". Option C captures these specific conditions and the temporal aspect."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q23",
      "set_ref": "VARC_RC_4",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 23,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Economics",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "According to the incentive or moral hazard argument, which one of the designs below is most consistent with the claim that some inequality can raise growth?",
      "options": [
        {
          "id": "A",
          "text": "Pay rewards on verifiable performance for highly productive workers."
        },
        {
          "id": "B",
          "text": "Rents protected by market power that enlarge top incomes without linking pay to results."
        },
        {
          "id": "C",
          "text": "Wages are determined by tenure rather than output to ensure equity."
        },
        {
          "id": "D",
          "text": "A regime that concentrates stock ownership in relation to corporate governance."
        }
      ],
      "solution_text": "The text says: \"paying compensations without taking into account the economic performance... will fail to elicit optimum effort... income inequalities contribute to growth by enhancing worker motivation.\" Option A (rewards on performance) aligns with this logic."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q24",
      "set_ref": "VARC_VA_5",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 24,
      "question_type": "MCQ",
      "taxonomy_type": "va_summary",
      "topic": "Verbal Ability",
      "subtopic": "Paragraph Summary",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The passage given below is followed by four summaries. Choose the option that best captures the essence of the passage.\nIn the dynamic realm of creativity, artists often find themselves at the crossroads between drawing inspiration from diverse cultures and inadvertently crossing into the territory of cultural appropriation. Inspiration is the lifeblood of creativity, driving artists to create works that resonate across borders. The globalized nature of the modern world invites artists to draw from a vast array of cultural influences. When approached respectfully, inspiration becomes a bridge, fostering understanding and appreciation of cultural diversity. However, the line between inspiration and cultural appropriation can be thin and easily blurred. Cultural appropriation occurs when elements from a particular culture are borrowed without proper understanding, respect, or acknowledgement. This leads to the commodification of sacred symbols, the reinforcement of stereotypes, and the erasure of the cultural context from which these elements originated. It's essential to recognize that the impact of cultural appropriation extends beyond the realm of artistic expression, influencing societal perceptions and perpetuating power imbalances.",
      "options": [
        {
          "id": "A",
          "text": "Artists in a globalised world must navigate between drawing inspiration from diverse cultures respectfully and cultural appropriation that involves borrowing without proper acknowledgement which has broader societal impacts including perpetuating power imbalances."
        },
        {
          "id": "B",
          "text": "In today's world of creativity, artists have to decide between respectfully acknowledging works that are inspired by diverse cultures and appropriating elements without respect for their contexts."
        },
        {
          "id": "C",
          "text": "In a globalised world, artists must draw from diverse cultural influences to create works that appeal to all, and this results in instances of both inspiration and cultural appropriation."
        },
        {
          "id": "D",
          "text": "Artists must navigate the thin line between inspiration and cultural appropriation, where respectful inspiration fosters cultural understanding whereas appropriation involves borrowing without acknowledgement leading to commodification and reinforcement of stereotypes."
        }
      ],
      "solution_text": "Option A captures the balance (inspiration vs appropriation), the definition of appropriation (borrowing without acknowledgment), and the critical consequence (societal impacts/power imbalances), which is the concluding point of the passage. Option D is close but misses the \"power imbalances\" aspect mentioned in the final sentence."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q25",
      "set_ref": "DILR_SET_1",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 25,
      "question_type": "TITA",
      "taxonomy_type": "lr_arrangement",
      "topic": "Logical Reasoning",
      "subtopic": "Seating Arrangement",
      "difficulty": "hard",
      "correct_answer": "4",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "What is the number of the chair initially occupied by Bashir?",
      "solution_text": "[cite_start]Based on the movement rules and the constraint that Bashir has empty chairs on both sides initially, tracing the moves backward from the known positions (Davies at 2 after Turn 1, etc.) reveals Bashir started at Chair 4[cite: 978]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q26",
      "set_ref": "DILR_SET_1",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 26,
      "question_type": "MCQ",
      "taxonomy_type": "lr_arrangement",
      "topic": "Logical Reasoning",
      "subtopic": "Seating Arrangement",
      "difficulty": "hard",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Who sits on the chair numbered 4 at the end of Turn 3?",
      "options": [
        {
          "id": "A",
          "text": "Bashir"
        },
        {
          "id": "B",
          "text": "Chhavi"
        },
        {
          "id": "C",
          "text": "Davies"
        },
        {
          "id": "D",
          "text": "No one"
        }
      ],
      "solution_text": "[cite_start]Tracing the movements to Turn 3, Chair 4 is unoccupied[cite: 980]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q27",
      "set_ref": "DILR_SET_1",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 27,
      "question_type": "MCQ",
      "taxonomy_type": "lr_arrangement",
      "topic": "Logical Reasoning",
      "subtopic": "Seating Arrangement",
      "difficulty": "hard",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the chairs are occupied at the end of Turn 6?",
      "options": [
        {
          "id": "A",
          "text": "Chairs numbered 4, 5, 6, and 7"
        },
        {
          "id": "B",
          "text": "Chairs numbered 1, 2, 3, and 4"
        },
        {
          "id": "C",
          "text": "Chairs numbered 2, 3, 4, and 5"
        },
        {
          "id": "D",
          "text": "Chairs numbered 1, 2, 6, and 7"
        }
      ],
      "solution_text": "At the end of Turn 6, the friends occupy a contiguous block of chairs (rule 1). [cite_start]The positions correspond to 4, 5, 6, and 7[cite: 987]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q28",
      "set_ref": "DILR_SET_1",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 28,
      "question_type": "MCQ",
      "taxonomy_type": "lr_arrangement",
      "topic": "Logical Reasoning",
      "subtopic": "Seating Arrangement",
      "difficulty": "hard",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following BEST describes the friends sitting on chairs adjacent to the one occupied by Bashir at the end of Turn 7?",
      "options": [
        {
          "id": "A",
          "text": "Chhavi only"
        },
        {
          "id": "B",
          "text": "Davies only"
        },
        {
          "id": "C",
          "text": "Chhavi and Davies"
        },
        {
          "id": "D",
          "text": "Aslam and Chhavi"
        }
      ],
      "solution_text": "[cite_start]After the final moves, only Davies is adjacent to Bashir[cite: 992]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q29",
      "set_ref": "DILR_SET_2",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 29,
      "question_type": "TITA",
      "taxonomy_type": "lr_ranking",
      "topic": "Logical Reasoning",
      "subtopic": "Ranking",
      "difficulty": "medium",
      "correct_answer": "4",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "What was Eklavya's score at the end of Quarter 2?",
      "solution_text": "[cite_start]Calculating the cumulative scores based on promotions/demotions and known ratings yields 4[cite: 1010]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q30",
      "set_ref": "DILR_SET_2",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 30,
      "question_type": "TITA",
      "taxonomy_type": "lr_ranking",
      "topic": "Logical Reasoning",
      "subtopic": "Ranking",
      "difficulty": "medium",
      "correct_answer": "0",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many employees changed groups more than once up to the beginning of Quarter 4?",
      "solution_text": "[cite_start]Tracking the movements shows that no employee moved back and forth more than once[cite: 1012]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q31",
      "set_ref": "DILR_SET_2",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 31,
      "question_type": "TITA",
      "taxonomy_type": "lr_ranking",
      "topic": "Logical Reasoning",
      "subtopic": "Ranking",
      "difficulty": "medium",
      "correct_answer": "5",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "What was Bunty's score at the end of Quarter 3?",
      "solution_text": "[cite_start]Bunty's cumulative score sums to 5[cite: 1014]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q32",
      "set_ref": "DILR_SET_2",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 32,
      "question_type": "TITA",
      "taxonomy_type": "lr_ranking",
      "topic": "Logical Reasoning",
      "subtopic": "Ranking",
      "difficulty": "medium",
      "correct_answer": "4",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "For how many employees can the scores at the end of Quarter 3 be determined with certainty?",
      "solution_text": "[cite_start]The scores can be uniquely determined for 4 employees[cite: 1016]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q33",
      "set_ref": "DILR_SET_2",
      "sequence_order": 5,
      "section": "DILR",
      "question_number": 33,
      "question_type": "MCQ",
      "taxonomy_type": "lr_ranking",
      "topic": "Logical Reasoning",
      "subtopic": "Ranking",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following statements is/are NECESSARILY true?\nII. Asha received a rating of 1 in Quarter 2.",
      "options": [
        {
          "id": "I",
          "text": "Asha received a rating of 2 in Quarter 1."
        },
        {
          "id": "A",
          "text": "Neither I nor II"
        },
        {
          "id": "B",
          "text": "Both I and II"
        },
        {
          "id": "C",
          "text": "Only I"
        },
        {
          "id": "D",
          "text": "Only II"
        }
      ],
      "solution_text": "[cite_start]Only statement II is necessarily true[cite: 1024]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q34",
      "set_ref": "DILR_SET_3",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 34,
      "question_type": "MCQ",
      "taxonomy_type": "di_calculation",
      "topic": "Data Interpretation",
      "subtopic": "Charts",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "How much is Japan's export to India worth?",
      "options": [
        {
          "id": "A",
          "text": "8.5 Billion USD"
        },
        {
          "id": "B",
          "text": "16.0 Billion USD"
        },
        {
          "id": "C",
          "text": "7.0 Billion USD"
        },
        {
          "id": "D",
          "text": "1.75 Billion USD"
        }
      ],
      "solution_text": "[cite_start]Calculated from the tariff percentage and total tariff value provided in the charts[cite: 1042]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q35",
      "set_ref": "DILR_SET_3",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 35,
      "question_type": "MCQ",
      "taxonomy_type": "di_calculation",
      "topic": "Data Interpretation",
      "subtopic": "Charts",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which among the following is the highest?",
      "options": [
        {
          "id": "A",
          "text": "Exports by Japan to UK"
        },
        {
          "id": "B",
          "text": "Imports by US from France"
        },
        {
          "id": "C",
          "text": "Exports by France to Japan"
        },
        {
          "id": "D",
          "text": "Imports by France from India"
        }
      ],
      "solution_text": "[cite_start]Comparing the calculated trade values shows Imports by US from France is the highest[cite: 1048]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q36",
      "set_ref": "DILR_SET_3",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 36,
      "question_type": "MCQ",
      "taxonomy_type": "di_calculation",
      "topic": "Data Interpretation",
      "subtopic": "Charts",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "What is the trade surplus/trade deficit of India with UK?",
      "options": [
        {
          "id": "A",
          "text": "Surplus of 15.0 Billion USD"
        },
        {
          "id": "B",
          "text": "Deficit of 15.0 Billion USD"
        },
        {
          "id": "C",
          "text": "Surplus of 10.0 Billion USD"
        },
        {
          "id": "D",
          "text": "Deficit of 10.0 Billion USD"
        }
      ],
      "solution_text": "[cite_start]India has a deficit of 15.0 Billion USD with the UK[cite: 1054]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q37",
      "set_ref": "DILR_SET_4",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 37,
      "question_type": "MCQ",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Logical Reasoning",
      "difficulty": "hard",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "What was the occupancy factor for segment D - E?",
      "options": [
        {
          "id": "A",
          "text": "35%"
        },
        {
          "id": "B",
          "text": "70%"
        },
        {
          "id": "C",
          "text": "77%"
        },
        {
          "id": "D",
          "text": "84%"
        }
      ],
      "solution_text": "[cite_start]Based on the ticket distribution constraints, the occupancy factor is 70%[cite: 1075]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q38",
      "set_ref": "DILR_SET_4",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 38,
      "question_type": "TITA",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Logical Reasoning",
      "difficulty": "hard",
      "correct_answer": "50",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many tickets were booked from Station A to Station E?",
      "solution_text": "[cite_start]The number of tickets is 50[cite: 1077]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q39",
      "set_ref": "DILR_SET_4",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 39,
      "question_type": "TITA",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Logical Reasoning",
      "difficulty": "hard",
      "correct_answer": "80",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many tickets were booked from Station C?",
      "solution_text": "[cite_start]The total booked from C (to D and E) is 80[cite: 1079]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q40",
      "set_ref": "DILR_SET_4",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 40,
      "question_type": "TITA",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Logical Reasoning",
      "difficulty": "hard",
      "correct_answer": "40",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "What is the difference between the number of tickets booked to Station C and the number of tickets booked to Station D?",
      "solution_text": "[cite_start]The difference is 40[cite: 1081]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q41",
      "set_ref": "DILR_SET_4",
      "sequence_order": 5,
      "section": "DILR",
      "question_number": 41,
      "question_type": "TITA",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Logical Reasoning",
      "difficulty": "hard",
      "correct_answer": "60",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many tickets were booked to travel in exactly one segment?",
      "solution_text": "[cite_start]Summing tickets for A-B (0), B-C, C-D, D-E (0) etc., yields 60[cite: 1083]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q42",
      "set_ref": "DILR_SET_5",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 42,
      "question_type": "TITA",
      "taxonomy_type": "lr_logic",
      "topic": "Logical Reasoning",
      "subtopic": "Games",
      "difficulty": "hard",
      "correct_answer": "7",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many taps did Clive receive for his question?",
      "solution_text": "[cite_start]Solving the grid of responses shows Clive received 7 taps[cite: 1100]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q43",
      "set_ref": "DILR_SET_5",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 43,
      "question_type": "MCQ",
      "taxonomy_type": "lr_logic",
      "topic": "Logical Reasoning",
      "subtopic": "Games",
      "difficulty": "hard",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which two people tapped an equal number of times in total?",
      "options": [
        {
          "id": "A",
          "text": "Badal and Dilshan"
        },
        {
          "id": "B",
          "text": "Clive and Ehsaan"
        },
        {
          "id": "C",
          "text": "Dilshan and Clive"
        },
        {
          "id": "D",
          "text": "Alia and Badal"
        }
      ],
      "solution_text": "[cite_start]Alia and Badal tapped the same number of times[cite: 1106]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q44",
      "set_ref": "DILR_SET_5",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 44,
      "question_type": "MCQ",
      "taxonomy_type": "lr_logic",
      "topic": "Logical Reasoning",
      "subtopic": "Games",
      "difficulty": "hard",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "What was Clive's response to Ehsaan's question?",
      "options": [
        {
          "id": "A",
          "text": "No"
        },
        {
          "id": "B",
          "text": "Maybe"
        },
        {
          "id": "C",
          "text": "Cannot be determined"
        },
        {
          "id": "D",
          "text": "Yes"
        }
      ],
      "solution_text": "[cite_start]Clive responded \"No\"[cite: 1112]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q45",
      "set_ref": "DILR_SET_5",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 45,
      "question_type": "TITA",
      "taxonomy_type": "lr_logic",
      "topic": "Logical Reasoning",
      "subtopic": "Games",
      "difficulty": "hard",
      "correct_answer": "6",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many \"Yes\" responses were received across all the questions?",
      "solution_text": "[cite_start]There were 6 \"Yes\" responses total[cite: 1114]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q46",
      "set_ref": "QA_ATOMIC_47",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 46,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Functions",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "A value of $c$ for which the minimum value of $f(x)=x^{2}-4cx+8c$ is greater than the maximum value of $g(x)=-x^{2}+3cx-2c,$ is",
      "options": [
        {
          "id": "A",
          "text": "$2$"
        },
        {
          "id": "B",
          "text": "$\\frac{1}{2}$"
        },
        {
          "id": "C",
          "text": "$-\\frac{1}{2}$"
        },
        {
          "id": "D",
          "text": "$-2$"
        }
      ],
      "solution_text": "Find the vertex of the parabolas. Min of $f(x)$ occurs at $x=2c$, value is $8c - 4c^2$. Max of $g(x)$ occurs at $x=1.5c$, value is $2.25c^2 - 2c$. [cite_start]Set inequality $8c - 4c^2 > 2.25c^2 - 2c$ and solve for $c$[cite: 1117]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q47",
      "set_ref": "QA_ATOMIC_48",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 47,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Time Speed Distance",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Shruti travels a distance of $224$ km in four parts for a total travel time of $3$ hours. Her speeds in these four parts follow an arithmetic progression, and the corresponding time taken to cover these four parts follow another arithmetic progression. If she travels at a speed of $960$ meters per minute for $30$ minutes to cover the first part, then the distance, in meters, she travels in the fourth part is",
      "options": [
        {
          "id": "A",
          "text": "$76800$"
        },
        {
          "id": "B",
          "text": "$112000$"
        },
        {
          "id": "C",
          "text": "$96000$"
        },
        {
          "id": "D",
          "text": "$86400$"
        }
      ],
      "solution_text": "Convert units to km/h or consistent metric. $S_1 = 960$ m/min. $T_1 = 30$ min. Total distance 224 km. [cite_start]Use sum of AP properties for speed and time to find variables [cite: 1125-1127]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q48",
      "set_ref": "QA_ATOMIC_49",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 48,
      "question_type": "TITA",
      "taxonomy_type": "qa_number_theory",
      "topic": "Quant",
      "subtopic": "Numbers",
      "difficulty": "medium",
      "correct_answer": "6",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "In a 3-digit number $N$, the digits are non-zero and distinct such that none of the digits is a perfect square, and only one of the digits is a prime number. Then, the number of factors of the minimum possible value of $N$ is",
      "solution_text": "Identify valid digits (non-zero, non-square: 2, 3, 5, 6, 7, 8). Primes: 2, 3, 5, 7. Non-primes: 6, 8. Construct min $N$ with one prime and distinct digits (e.g., using small digits). [cite_start]Calculate factors of that $N$[cite: 1135]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q49",
      "set_ref": "QA_ATOMIC_50",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 49,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Inequalities",
      "difficulty": "hard",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Let $3\\le x\\le6$ and $[x^{2}]=[x]^{2}$, where $[z]$ is the greatest integer not exceeding $z$. If set $S$ represents all feasible values of $x$, then a possible subset of $S$ is",
      "options": [
        {
          "id": "A",
          "text": "$[3,\\sqrt{10})\\cup[5,\\sqrt{26})\\cup\\{6\\}$"
        },
        {
          "id": "B",
          "text": "$[3,\\sqrt{10}]\\cup[5,\\sqrt{26}]$"
        },
        {
          "id": "C",
          "text": "$[3,\\sqrt{10}]\\cup[4,\\sqrt{17}]\\cup\\{6\\}$"
        },
        {
          "id": "D",
          "text": "$(4,\\sqrt{18})\\cup[5,\\sqrt{27})\\cup\\{6\\}$"
        }
      ],
      "solution_text": "Analyze intervals where $[x]$ is constant (3, 4, 5, 6). For $[x]=3$, require $[x^2]=9$. For $[x]=4$, require $[x^2]=16$. [cite_start]Check validity in range [cite: 1140-1141]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q50",
      "set_ref": "QA_ATOMIC_51",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 50,
      "question_type": "TITA",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Profit and Loss",
      "difficulty": "easy",
      "correct_answer": "15",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Stocks A, B and C are priced at rupees $120$, $90$ and $150$ per share, respectively. A trader holds a portfolio consisting of $10$ shares of stock A, and $20$ shares of stocks B and C put together. If the total value of her portfolio is rupees $3300$, then the number of shares of stock B that she holds, is",
      "solution_text": "Let $b$ be shares of B, then $c = 20-b$. Equation: $10(120) + 90b + 150(20-b) = 3300$. [cite_start]Solve for $b$ [cite: 1149-1151]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q51",
      "set_ref": "QA_ATOMIC_52",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 51,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Sequences",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "For any natural number $k$, let $a_{k}=3^{k}$. The smallest natural number $m$ for which $\\{(a_{1})^{1}\\times(a_{2})^{2}\\times...\\times(a_{20})^{20}\\}<\\{a_{21}\\times a_{22}\\times...\\times a_{20+m}\\},$ is",
      "options": [
        {
          "id": "A",
          "text": "$58$"
        },
        {
          "id": "B",
          "text": "$59$"
        },
        {
          "id": "C",
          "text": "$56$"
        },
        {
          "id": "D",
          "text": "$57$"
        }
      ],
      "solution_text": "Exponents of 3 form a sequence. LHS exponent is $\\sum k^2$. RHS exponent is arithmetic series sum. [cite_start]Set inequality and solve for min $m$[cite: 1155]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q52",
      "set_ref": "QA_ATOMIC_53",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 52,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Logarithms",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The number of distinct integers $n$ for which $\\log_{\\frac{1}{4}}(n^{2}-7n+11)>0$ is",
      "options": [
        {
          "id": "A",
          "text": "$2$"
        },
        {
          "id": "B",
          "text": "infinite"
        },
        {
          "id": "C",
          "text": "$1$"
        },
        {
          "id": "D",
          "text": "$0$"
        }
      ],
      "solution_text": "Inequality $\\log_{1/4}(A) > 0 \\implies 0 < A < 1$ (base < 1 reverses sign). [cite_start]Solve $0 < n^2-7n+11 < 1$ for integers $n$[cite: 1163]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q53",
      "set_ref": "QA_ATOMIC_54",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 53,
      "question_type": "TITA",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Inequalities",
      "difficulty": "medium",
      "correct_answer": "16",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The number of distinct pairs of integers $(x, y)$ satisfying the inequalities $x>y\\ge3$ and $x+y<14$ is",
      "solution_text": "[cite_start]Iterate through possible integer values of $y$ starting from 3 ($y=3, 4, 5...$) and find corresponding valid $x$ values ($y < x < 14-y$)[cite: 1171]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q54",
      "set_ref": "QA_ATOMIC_55",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 54,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Interest",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "At a certain simple rate of interest, a given sum amounts to Rs $13920$ in $3$ years, and to Rs $18960$ in $6$ years and $6$ months. If the same given sum had been invested for $2$ years at the same rate as before but with interest compounded every $6$ months, then the total interest earned, in rupees, would have been nearest to",
      "options": [
        {
          "id": "A",
          "text": "$3221$"
        },
        {
          "id": "B",
          "text": "$3180$"
        },
        {
          "id": "C",
          "text": "$3150$"
        },
        {
          "id": "D",
          "text": "$3096$"
        }
      ],
      "solution_text": "Find Principal $P$ and Rate $R$ from SI data (Difference in amount / difference in time = yearly interest). [cite_start]Then calculate CI for 2 years compounded semi-annually [cite: 1175-1176]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q55",
      "set_ref": "QA_ATOMIC_56",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 55,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Mixtures",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "A container holds $200$ litres of a solution of acid and water, having $30\\%$ acid by volume. Atul replaces $20\\%$ of this solution with water, then replaces $10\\%$ of the resulting solution with acid, and finally replaces $15\\%$ of the solution thus obtained, with water. The percentage of acid by volume in the final solution obtained after these three replacements, is nearest to",
      "options": [
        {
          "id": "A",
          "text": "$23$"
        },
        {
          "id": "B",
          "text": "$25$"
        },
        {
          "id": "C",
          "text": "$29$"
        },
        {
          "id": "D",
          "text": "$27$"
        }
      ],
      "solution_text": "Track the volume of acid remaining after each step. Step 1 (Water replace): Acid decreases. Step 2 (Acid replace): Acid increases. [cite_start]Step 3 (Water replace): Acid decreases [cite: 1184-1186]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q56",
      "set_ref": "QA_ATOMIC_57",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 56,
      "question_type": "TITA",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Word Problems",
      "difficulty": "medium",
      "correct_answer": "55",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "In a class, there were more than $10$ boys and a certain number of girls. After $40\\%$ of the girls and $60\\%$ of the boys left the class, the remaining number of girls was $8$ more than the remaining number of boys. Then, the minimum possible number of students initially in the class was",
      "solution_text": "Let $B, G$ be initial numbers. Remaining: $0.6G = 0.4B + 8$. Simplify equation ($3G = 2B + 40$). [cite_start]Find integer solutions for $B > 10$ that minimize $B+G$ [cite: 1194-1196]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q57",
      "set_ref": "QA_ATOMIC_58",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 57,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Permutations Combinations",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "A cafeteria offers $5$ types of sandwiches. Moreover, for each type of sandwich, a customer can choose one of $4$ breads and opt for either small or large sized sandwich. Optionally, the customer may also add up to $2$ out of $6$ available sauces. The number of different ways in which an order can be placed for a sandwich, is",
      "options": [
        {
          "id": "A",
          "text": "$880$"
        },
        {
          "id": "B",
          "text": "$840$"
        },
        {
          "id": "C",
          "text": "$800$"
        },
        {
          "id": "D",
          "text": "$600$"
        }
      ],
      "solution_text": "Main choices: $5 \\times 4 \\times 2 = 40$. Sauces: 0, 1, or 2 sauces from 6. Ways = $\\binom{6}{0} + \\binom{6}{1} + \\binom{6}{2}$. [cite_start]Total = Main $\\times$ Sauces [cite: 1200-1202]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q58",
      "set_ref": "QA_ATOMIC_59",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 58,
      "question_type": "MCQ",
      "taxonomy_type": "qa_number_theory",
      "topic": "Quant",
      "subtopic": "Progressions",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "In the set of consecutive odd numbers $\\{1,3,5,...,57\\}$, there is a number $k$ such that the sum of all the elements less than $k$ is equal to the sum of all the elements greater than $k$. Then, $k$ equals",
      "options": [
        {
          "id": "A",
          "text": "$41$"
        },
        {
          "id": "B",
          "text": "$39$"
        },
        {
          "id": "C",
          "text": "$43$"
        },
        {
          "id": "D",
          "text": "$37$"
        }
      ],
      "solution_text": "Series is arithmetic. Let $k$ be the $m$-th term. Sum of first $(m-1)$ terms equals sum of terms from $(m+1)$ to end. [cite_start]Solve for $k$ [cite: 1210-1211]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q59",
      "set_ref": "QA_ATOMIC_60",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 59,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Time and Work",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Arun, Varun and Tarun, if working alone, can complete a task in $24$, $21$, and $15$ days, respectively. They charge Rs $2160$, Rs $2400$, and Rs $2160$ per day, respectively, even if they are employed for a partial day. On any given day, any of the workers may or may not be employed to work. If the task needs to be completed in $10$ days or less, then the minimum possible amount, in rupees, required to be paid for the entire task is",
      "options": [
        {
          "id": "A",
          "text": "$38400$"
        },
        {
          "id": "B",
          "text": "$38880$"
        },
        {
          "id": "C",
          "text": "$34400$"
        },
        {
          "id": "D",
          "text": "$47040$"
        }
      ],
      "solution_text": "Calculate efficiency and cost per unit work for each. [cite_start]Optimize the mix of workers to finish $\\ge 1$ unit of work within 10 days at min cost [cite: 1219-1222]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q60",
      "set_ref": "QA_ATOMIC_61",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 60,
      "question_type": "TITA",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Interest",
      "difficulty": "medium",
      "correct_answer": "900",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Kamala divided her investment of Rs $100000$ between stocks, bonds, and gold. Her investment in bonds was $25\\%$ of her investment in gold. With annual returns of $10\\%$, $6\\%$, $8\\%$ on stocks, bonds, and gold, respectively, she gained a total amount of Rs $8200$ in one year. The amount, in rupees, that she gained from the bonds, was",
      "solution_text": "Let Gold $= G$, Bonds $= 0.25G$, Stocks $= 100000 - 1.25G$. Total return equation: $0.10(Stocks) + 0.06(Bonds) + 0.08(Gold) = 8200$. [cite_start]Solve for $G$ then Bond interest [cite: 1230-1232]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q61",
      "set_ref": "QA_ATOMIC_62",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 61,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Linear Equations",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "If $a-6b+6c=4$ and $6a+3b-3c=50$ where $a, b$ and $c$ are real numbers, the value of $2a+3b-3c$ is",
      "options": [
        {
          "id": "A",
          "text": "$20$"
        },
        {
          "id": "B",
          "text": "$14$"
        },
        {
          "id": "C",
          "text": "$18$"
        },
        {
          "id": "D",
          "text": "$15$"
        }
      ],
      "solution_text": "Let $X = 3b-3c$. Rewrite equations: $a - 2X = 4$ and $6a + X = 50$. Solve system for $a$ and $X$. [cite_start]Evaluate $2a + X$[cite: 1237]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q62",
      "set_ref": "QA_ATOMIC_63",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 62,
      "question_type": "MCQ",
      "taxonomy_type": "qa_geometry",
      "topic": "Quant",
      "subtopic": "Coordinate Geometry",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The $(x, y)$ coordinates of vertices P, Q and R of a parallelogram PQRS are $(-3,-2)$, $(1, -5)$ and $(9, 1)$, respectively. If the diagonal SQ intersects the x-axis at $(a, 0)$, then the value of $a$ is",
      "options": [
        {
          "id": "A",
          "text": "$\\frac{27}{7}$"
        },
        {
          "id": "B",
          "text": "$\\frac{10}{3}$"
        },
        {
          "id": "C",
          "text": "$\\frac{13}{4}$"
        },
        {
          "id": "D",
          "text": "$\\frac{29}{9}$"
        }
      ],
      "solution_text": "Find vertex S using midpoint formula (midpoint of PR = midpoint of QS). Find equation of line SQ. [cite_start]Find x-intercept ($y=0$) [cite: 1245-1246]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q63",
      "set_ref": "QA_ATOMIC_64",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 63,
      "question_type": "MCQ",
      "taxonomy_type": "qa_geometry",
      "topic": "Quant",
      "subtopic": "Geometry",
      "difficulty": "hard",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "In a circle with center C and radius $6\\sqrt{2}$ cm, PQ and SR are two parallel chords separated by one of the diameters. If $\\angle PQC=45^{\\circ}$ and the ratio of the perpendicular distance of PQ and SR from C is $3: 2$, then the area, in sq. cm, of the quadrilateral PQRS is",
      "options": [
        {
          "id": "A",
          "text": "$4(3+\\sqrt{14})$"
        },
        {
          "id": "B",
          "text": "$4(3\\sqrt{2}+\\sqrt{7})$"
        },
        {
          "id": "C",
          "text": "$20(3+\\sqrt{14})$"
        },
        {
          "id": "D",
          "text": "$20(3\\sqrt{2}+\\sqrt{7})$"
        }
      ],
      "solution_text": "Use trigonometry to find chord lengths and perpendicular distances. [cite_start]Calculate area of trapezoid PQRS [cite: 1254-1255]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q64",
      "set_ref": "QA_ATOMIC_65",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 64,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Ratios",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The ratio of the number of students in the morning shift and afternoon shift of a school was $13: 9$. After $21$ students moved from the morning shift to the afternoon shift, this ratio became $19: 14$. Next, some new students joined the morning and afternoon shifts in the ratio $3: 8$ and then the ratio of the number of students in the morning shift and the afternoon shift became $5: 4$. The number of new students who joined is",
      "options": [
        {
          "id": "A",
          "text": "$110$"
        },
        {
          "id": "B",
          "text": "$88$"
        },
        {
          "id": "C",
          "text": "$121$"
        },
        {
          "id": "D",
          "text": "$99$"
        }
      ],
      "solution_text": "Use variables for initial students (13x, 9x). Apply transfer logic to find x. [cite_start]Then apply new joining ratio (3y, 8y) to find y and total new students (11y) [cite: 1263-1265]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q65",
      "set_ref": "QA_ATOMIC_66",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 65,
      "question_type": "TITA",
      "taxonomy_type": "qa_geometry",
      "topic": "Quant",
      "subtopic": "Geometry",
      "difficulty": "medium",
      "correct_answer": "60",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "If the length of a side of a rhombus is $36$ cm and the area of the rhombus is $396$ sq. cm, then the absolute value of the difference between the lengths, in cm, of the diagonals of the rhombus is",
      "solution_text": "Area $A = \\frac{1}{2} d_1 d_2 = 396$. Side $s = \\sqrt{(d_1/2)^2 + (d_2/2)^2} = 36$. [cite_start]Use identities to find $(d_1 - d_2)$[cite: 1274]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q66",
      "set_ref": "QA_ATOMIC_67",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 66,
      "question_type": "TITA",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Quadratic Equations",
      "difficulty": "medium",
      "correct_answer": "3",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The number of non-negative integer values of $k$ for which the quadratic equation $x^{2}-5x+k=0$ has only integer roots, is",
      "solution_text": "Discriminant $D = 25 - 4k$ must be a perfect square. [cite_start]Check non-negative integers $k$ satisfying this[cite: 1278]."
    },
    {
      "client_question_id": "cat-2025-slot-1_Q67",
      "set_ref": "QA_ATOMIC_68",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 67,
      "question_type": "TITA",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Profit and Loss",
      "difficulty": "medium",
      "correct_answer": "175",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "A shopkeeper offers a discount of $22\\%$ on the marked price of each chair, and gives $13$ chairs to a customer for the discounted price of $12$ chairs to earn a profit of $26\\%$ on the transaction. If the cost price of each chair is Rs $100$, then the marked price, in rupees, of each chair is",
      "solution_text": "Let MP be $M$. SP per chair (effectively) involves discount and free item logic. Total Revenue = $12 \\times 0.78M$. Total Cost = $13 \\times 100$. Profit = 26%. [cite_start]Equate and solve for $M$ [cite: 1282-1283]."
    }
  ]
}
````

## File: cat_2025_slot_1.md
````markdown
@P v=3.0 | key=cat-2025-slot-1 | title=CAT 2025 Slot 1 | slug=cat-2025-slot-1 | year=2025 | tq=68 | tm=204 | dur=120 | diff=hard | secs=VARC,DILR,QA | dm=3,1 | flags=is_free=false;published=false;allow_pause=true;attempt_limit=2 | desc=Official CAT 2025 Slot 1 Question Paper

@S VARC

@SET VARC_VA_1 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=va_odd_one | topic=Verbal Ability | sub=Para Jumbles (Odd One Out) | diff=medium | m=3,0 | ans=4
? Five jumbled sentences (labelled 1, 2, 3, 4, and 5), related to a topic, are given below. Four of them can be put together to form a coherent paragraph. Identify the odd sentence out and key in the number of that sentence as your answer.
1. Developments both technological and sociocultural have afforded us far greater freedom over death than we had in the past, and while we are still adapting ourselves to that freedom, we now appreciate the moral importance of this freedom.
2. But I believe that a type of freedom we can call freedom over death that is, a freedom in which we shape the timing and circumstances of how we die - should be central to this conversation.
3. Legalising assisted dying is but a further step in realising this freedom over death.
4. Many people endorse, through their opinions or their choices, our freedom over death, encompassing a right to medical assistance in hastening our deaths.
5. Freedom is a notoriously complex and contested philosophical notion, and I won't pretend to settle any of the big controversies it raises.
> The paragraph discusses "freedom over death" specifically in the context of assisted dying and shaping the timing of death (Sentences 1, 2, 3, 4). Sentence 5 discusses "freedom" as a general philosophical notion, which is too broad and disconnects from the specific argument about death and assisted dying.
@END_Q
@END_SET

@SET VARC_RC_1 | type=VARC | ctx=rc_passage | layout=text_only | title=Electronic Music
@CTX
Often the well intentioned music lover or the traditionally-minded professional composer asks two basic questions when faced with the electronic music phenomena: (1) is this type of artistic creation music at all? and, (2) given that the product is accepted as music of a new type or order, is not such music "inhuman"?... As Lejaren Hiller points out in his book Experimental Music (coauthor Leonard M. Isaacson), two questions which often arise when music is discussed are: (a) the substance of musical communication and its symbolic and semantic significance, if any, and (b) the particular processes, both mental and technical, which are involved in creating and responding to musical composition.

The ever-present popular concept of music as a direct, open, emotional expression and as a subjective form of communication from the composer, is, of course still that of the nineteenth century, when composers themselves spoke of music in those terms.... But since the third decade of our century many composers have preferred more objective definitions of music, epitomized in Stravinsky's description of it as "a form of speculation in terms of sound and time".

An acceptance of this more characteristic twentieth-century view of the art of musical composition will of course immediately bring the layman closer to an understanding of, and sympathetic response to, electronic music, even if the forms, sounds and approaches it uses will still be of a foreign nature to him. A communication problem however will still remain. The principal barrier that electronic music presents at large, in relation to the communication process, is that composers in this medium are employing a new language of forms where terms like 'densities', 'indefinite pitch relations', 'dynamic serialization', 'permutation', etc., are substitutes (or remote equivalents) for the traditional concepts of harmony, melody, rhythm, etc.... When the new structural procedures of electronic music are at last fully understood by the listener the barriers between him and the work he faces will be removed...

The medium of electronic music has of course tempted many kinds of composers to try their hand at it.... But the serious-minded composer approaches the world of electronic music with a more sophisticated and profound concept of creation. Although he knows that he can reproduce and employ melodic, rhythmic patterns and timbres of a traditional nature, he feels that it is in the exploration of sui generis languages and forms that the aesthetic magic of the new medium lies. And, conscientiously, he plunges into this search.
@END_CTX

@Q type=MCQ | tax=rc_structure | topic=Reading Comprehension | sub=Music | diff=medium | m=3,1 | ans=D
? The goal of the author over the course of this passage is to:
A. differentiate the modern composer from the nineteenth century composer
B. differentiate between electronic music and other forms of music.
C. defend the "serious-minded composer" from Lejaren Hill and Stravinsky.
D. defend electronic music from certain common charges.
> The author starts by listing charges against electronic music (is it music? is it inhuman?) and then addresses the definitions of music and the "communication problem" to bridge the gap for the listener, effectively defending the genre.

@Q type=MCQ | tax=rc_structure | topic=Reading Comprehension | sub=Music | diff=medium | m=3,1 | ans=A
? What relation does the "communication problem" mentioned in paragraph 2 have to the questions that the author recounts at the beginning of the passage?
A. Unfamiliar forms and terms might get in the way of our seeing electronic music as music, but this can be overcome.
B. Its unfamiliar "language of forms" and novel terms mean that we cannot see electronic music as music since it does not employ traditional musical concepts.
C. None; they are unrelated to one another and form parts of different discussions.
D. The communication problem is what allows us to see electronic music as music because music must be difficult to understand.
> The initial questions ask if it is music at all. The communication problem explains *why* it might not seem like music (unfamiliar language of forms) but argues that understanding these procedures removes the barrier.

@Q type=MCQ | tax=rc_inference | topic=Reading Comprehension | sub=Music | diff=medium | m=3,1 | ans=A
? The mention of Stravinsky's description of music in the first paragraph does all the following EXCEPT:
A. help us determine which sounds are musical and which are not.
B. respond to and expand upon earlier understandings of music.
C. complicate our notion of what is communicated through music.
D. allow us to classify electronic music as music.
> Stravinsky's definition ("speculation in terms of sound and time") is used to move away from 19th-century emotional definitions (B), allows for a broader view including electronic music (D), and shifts focus from subjective communication (C). It does not provide a rubric for determining which specific *sounds* are musical (A).

@Q type=MCQ | tax=rc_vocab | topic=Reading Comprehension | sub=Music | diff=medium | m=3,1 | ans=A
? From the context in which it is placed, the phrase "sui generis" in paragraph 3 suggests which one of the following?
A. Particular
B. Generic
C. Unaesthetic
D. Indescribable
> "Sui generis" means unique or of its own kind/particular to itself. The context contrasts reproducing traditional patterns with exploring languages unique to the new medium.
@END_Q
@END_SET

@SET VARC_VA_2 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=va_jumble | topic=Verbal Ability | sub=Para Jumbles | diff=medium | m=3,0 | ans=2143
? The four sentences (labelled 1, 2, 3, and 4) given below, when properly sequenced, would yield a coherent paragraph. Decide on the proper sequencing of the order of the sentences and key in the sequence of the four numbers as your answer.
1. it can increase the effect of this function, by being linked closely with it;
2. It can in fact be integrated into any function (education, medical treatment, production, punishment);
3. it can establish a direct proportion between 'surplus power' and 'surplus production'.
4. it can constitute a mixed mechanism in which relations of power (and of knowledge) may be precisely adjusted, in the smallest detail, to the processes that are to be supervised;
[Context sentences provided in source for flow check, but strict sequencing relies on 1-4]:
(Source text indicates: "The panoptic mechanism is not simply... It's a case of 'it's easy once you've thought of it'..." followed by the sentences).
> 2 introduces the idea that "it" can be integrated into any function. 1 follows by saying it increases the effect of "this function" (linking back to 2). 4 expands on how it constitutes a mechanism within that function. 3 concludes with the result (surplus power/production).
@END_Q

@Q type=MCQ | tax=va_placement | topic=Verbal Ability | sub=Sentence Placement | diff=medium | m=3,1 | ans=A
? The given sentence is missing in the paragraph below. Decide where it best fits among the options 1, 2, 3, or 4 indicated in the paragraph.
Sentence: "Everything is old-world, traditional techniques from Mexico," Ava emphasizes.
Paragraph: The sisters embrace the ways their great-grandfather built and repaired instruments. (1) When crafting a Mexican guitarron used in mariachi music, they use tacote wood for the top of the instrument. Once the wood is cut, they carve the neck and heel from a single block using tools like hand saws, chisels and sandpaper rather than modern power tools and believe that this traditional method improves the tone of the instrument. (2) Their store has a three-year waitlist for instruments that take months to create. (3) The family's artisanship has attracted stars like Los Lobos, who own custom guitars made by all three generations of the Delgado family. (4) For the sisters, involvement in the family business started at an early age. They each built their first instruments at age 9.
A. Option 1
B. Option 4
C. Option 2
D. Option 3
> The sentence mentions "old-world, traditional techniques". The sentence following (1) describes these techniques in detail ("carve... hand saws... rather than modern power tools"). Thus, the sentence introduces the description that follows immediately at (1).

@Q type=MCQ | tax=va_placement | topic=Verbal Ability | sub=Sentence Placement | diff=medium | m=3,1 | ans=B
? The given sentence is missing in the paragraph below. Decide where it best fits among the options 1, 2, 3, or 4 indicated in the paragraph.
Sentence: Historically, silver has been, and still is, an important element in the business of 'show' visible in private houses, churches, government and diplomacy.
Paragraph: (1) Timothy Schroder put it succinctly in suggesting that electric light and eating in the kitchen eroded this need. As he explained to the author, 'Silver, when illuminated by flickering candlelight, comes alive and almost dances before the eyes, but when lit by electric light, it becomes flat and dead.' (2) Domestic and economic changes may have worked against the market, but the London silver trade remained buoyant, thanks to the competition of collectors seeking grand display silver at the top end, and the buyers of 'collectables', like spoons and wine labels and 'novelties', at the bottom. (3) Another factor that came into play was the systematic collection building of certain American museums over the period. Boston, Huntington Art Gallery and Williamsburg, among others, were largely supplied by London dealers. (4)
A. Option 4
B. Option 3
C. Option 1
D. Option 2
> Option 3 is the correct answer (Key: B). The sentence introduces the historical importance of silver in "show". The paragraph following (1) discusses the decline of this need (electric light). The sentence actually seems to fit best as an intro, but given the options, placing it at (3) doesn't seem right contextually compared to the start. *Correction*: Let's re-read carefully. The sentence is about silver being an element of 'show'. (1) discusses the erosion of "this need" (implying the need for show/silver was mentioned prior). However, if we look at Option 3 (Source: B), the sentence might be unrelated to the museum factor. Let's look at the Official Answer provided in source. Source says `Correct Answer: B` which corresponds to `Option 3`.
@END_Q
@END_SET

@SET VARC_RC_2 | type=VARC | ctx=rc_passage | layout=text_only | title=Complex Systems and Tail Events
@CTX
Understanding the key properties of complex systems can help us clarify and deal with many new and existing global challenges, from pandemics to poverty... A recent study in Nature Physics found transitions to orderly states such as schooling in fish (all fish swimming in the same direction), can be caused, paradoxically, by randomness, or 'noise' feeding back on itself. That is, a misalignment among the fish causes further misalignment, eventually inducing a transition to schooling. Most of us wouldn't guess that noise can produce predictable behaviour.

The result invites us to consider how technology such as contact-tracing apps, although informing us locally, might negatively impact our collective movement. If each of us changes our behaviour to avoid the infected, we might generate a collective pattern we had aimed to avoid: higher levels of interaction between the infected and susceptible, or high levels of interaction among the asymptomatic.

Complex systems also suffer from a special vulnerability to events that don't follow a normal distribution or 'bell curve'. When events are distributed normally, most outcomes are familiar and don't seem particularly striking. Height is a good example: it's pretty unusual for a man to be over 7 feet tall; most adults are between 5 and 6 feet, and there is no known person over 9 feet tall. But in collective settings where contagion shapes behaviour - a run on the banks, a scramble to buy toilet paper - the probability distributions for possible events are often heavy-tailed. There is a much higher probability of extreme events, such as a stock market crash or a massive surge in infections. These events are still unlikely, but they occur more frequently and are larger than would be expected under normal distributions.

What's more, once a rare but hugely significant 'tail' event takes place, this raises the probability of further tail events. We might call them second-order tail events; they include stock market gyrations after a big fall and earthquake aftershocks. The initial probability of second-order tail events is so tiny it's almost impossible to calculate - but once a first-order tail event occurs, the rules change, and the probability of a second-order tail event increases. The dynamics of tail events are complicated by the fact that they result from cascades of other unlikely events.

When COVID-19 first struck, the stock market suffered stunning losses followed by an equally stunning recovery. Some of these dynamics are potentially attributable to former sports bettors, with no sports to bet on, entering the market as speculators rather than investors. The arrival of these new players might have increased inefficiencies and allowed savvy long-term investors to gain an edge over bettors with different goals. One reason a first-order tail event can induce further tail events is that it changes the perceived costs of our actions and changes the rules that we play by. This game-change is an example of another key complex systems concept: nonstationarity. A second, canonical example of nonstationarity is adaptation, as illustrated by the arms race involved in the coevolution of hosts and parasites [in which] each has to 'run' faster, just to keep up with the novel solutions the other one presents as they battle it out in evolutionary time.
@END_CTX

@Q type=MCQ | tax=rc_inference | topic=Reading Comprehension | sub=Sociology/Economics | diff=medium | m=3,1 | ans=D
? All of the following inferences are supported by the passage EXCEPT that:
A. examples like runs on banks and toilet paper scrambles illustrate how contagion can amplify local choices into system-wide cascades that surprise participants and lead to patterns they did not intend to create.
B. learning can change the rules that actors face. So, a rare shock can alter payoffs and raise the odds of subsequent large disturbances within the same system, which supports the idea of second-order tail events.
C. heavy-tailed events make extreme outcomes more frequent and larger than bell curve expectations. This complicates forecasting and risk management in collective settings shaped by contagion and copying behaviour.
D. the text attributes the COVID-19 pandemic rebound in financial markets solely to displaced sports bettors and treats their entry as the overriding cause of the rapid recovery across assets and time horizons.
> The text states "Some of these dynamics are potentially attributable to former sports bettors..." (probability/partial attribution), whereas Option D claims it attributes the rebound *solely* to them and treats it as the *overriding* cause. This is too strong and not supported.

@Q type=MCQ | tax=rc_summary | topic=Reading Comprehension | sub=Sociology/Economics | diff=medium | m=3,1 | ans=B
? Which one of the options below best summarises the passage?
A. The passage explains how social outcomes generally follow normal distributions. So, extreme events are negligible, and policy should stabilise averages rather than learn from large shocks in fast-changing collective settings.
B. The passage explains how noise can create order, then shows why complex systems with contagion are vulnerable to heavy-tailed cascades. It also explains why early shocks change rules through nonstationarity with a market illustration during the COVID-19 disruption.
C. The passage explains how speculative entrants always produce inefficiency after health shocks. Therefore, long-term investors invariably profit when new participants push prices away from fundamentals under pandemic conditions and comparable crises.
D. The passage explains how nonstationarity works in evolutionary biology and rejects applications in markets or public health because adaptation is exclusive to parasite-host systems and cannot arise in technology-mediated social dynamics.
> Option B captures the key points: noise creating order (fish/apps), vulnerability to heavy-tailed events (contagion), and nonstationarity (rules changing after shocks, COVID/market example).

@Q type=MCQ | tax=rc_strengthen | topic=Reading Comprehension | sub=Sociology/Economics | diff=medium | m=3,1 | ans=C
? Which one of the following observations would most strengthen the passage's claim that a first-order tail event raises the probability of further tail events in complex systems?
A. In epidemic networks, initial super-spreading episodes are isolated spikes after which outbreak sizes match the baseline distribution from independent contact models across comparable cities with no rise in the frequency or size of later extreme clusters.
B. River discharge records show water levels fit a normal distribution with thin tails that match laboratory data, regardless of storms or floods.
C. After a major equity crash, researchers find dense clusters of large daily moves for several weeks, with extreme days occurring far more often than in normal circumstances for assets with customarily low volatility profiles.
D. Following large earthquakes, regional seismic activity returns to baseline within hours with no aftershock sequence once data are adjusted for reporting effects, which suggests independence across events rather than any elevation in subsequent tail probabilities.
> The claim is that a first tail event *increases* the probability of subsequent ones (clustering). Option C explicitly describes this: after a crash (first event), extreme days occur "far more often" (increased probability of second-order events).

@Q type=MCQ | tax=rc_assumption | topic=Reading Comprehension | sub=Sociology/Economics | diff=medium | m=3,1 | ans=B
? The passage suggests that contact tracing apps could inadvertently raise risky interactions by altering local behaviour. Which one of the assumptions below is most necessary for that suggestion to hold?
A. Most users uninstall apps within a week, which leaves only highly exposed individuals participating. This neutralises any systematic bias in routing decisions and prevents any predictable change in aggregate contact patterns.
B. Individuals base movement choices partly on observed infections and on the behaviour of others. So, local responses interact, which turns many small adjustments into large scale patterns that can frustrate the intended aim of risk reduction.
C. App alerts always include precise location to within one metre and deliver real time updates for all users, which ensures that the data feed is perfectly accurate regardless of privacy settings, power limits, or network conditions.
D. Urban networks have uniform traffic conditions at all hours, which allows perfectly predictable routing independent of personal choices, social signals, or crowd reactions and, therefore, makes interdependence negligible in city movement decisions.
> For local changes to generate a collective pattern (as argued in the passage), individuals must be reacting to the information (observed infections/others' behavior) and these reactions must interact to form the new pattern. Option B articulates this mechanism.
@END_Q
@END_SET

@SET VARC_VA_3 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=va_jumble | topic=Verbal Ability | sub=Para Jumbles | diff=medium | m=3,0 | ans=3421
? The four sentences (labelled 1, 2, 3, and 4) given below, when properly sequenced, would yield a coherent paragraph. Decide on the proper sequencing of the order of the sentences and key in the sequence of the four numbers as your answer.
1. But man, woman or otherwise, there is no denying that the quality of our life and character will be significantly shaped by the way we handle our anger.
2. Once the taboos have been broken, women usually experience letting their fists fly as intensely liberating.
3. Though this might seem a stereotype, women-unlike men, who are frequently applauded for unbridled aggression are often socialized to keep a lid on their ire.
4. Many of them are so at odds with their aggressive feelings that, as a coach, I often have to stop them from pulling their punches and encourage them to extend their arms so their blows might actually reach their fleshy target.
> 3 introduces the topic (women socialized to hide anger vs men). 4 elaborates on the consequence (pulling punches). 2 describes the result of overcoming this (liberating). 1 concludes with a general statement about handling anger.
@END_Q

@Q type=MCQ | tax=va_summary | topic=Verbal Ability | sub=Paragraph Summary | diff=medium | m=3,1 | ans=C
? The passage given below is followed by four summaries. Choose the option that best captures the essence of the passage.
Zombie cells may contribute to age-related chronic inflammation: this finding could help scientists understand more about the aging process and why the immune system becomes less effective as we get older. Zombie or "senescent" cells are damaged cells that can no longer divide and grow like normal cells. Scientists think that these cells can contribute to chronic health problems when they accumulate in the body. In younger people, the immune system is more effective at clearing senescent cells from the body through a process called apoptosis, but as we age, this process becomes less efficient. As a result, there is an accumulation of senescent cells in different organs in the body, either through increased production or reduced clearance by the immune system. The zombie cells continue to use energy though they do not divide, and often secrete chemicals that cause inflammation, which if persistent for longer periods of time can damage healthy cells leading to chronic diseases.
A. Senescent "zombie" cells are inactive or malfunctioning cells that can be found throughout the body.
B. A younger person's immune system is healthy and is able to clear the damaged cells, but as people age, the zombie cells resist apoptosis, and start accumulating in the body.
C. Aging leads to less effective apoptosis, and therefore zombie cells start to accumulate in the body, causing inflammation, which accelerates aging and leads to chronic diseases.
D. Dead cells accelerate chronic inflammation weakening the immune system and lead to aging.
> Option C covers the causal chain: Aging -> less effective apoptosis -> accumulation of zombie cells -> inflammation -> chronic disease/aging.
@END_Q
@END_SET

@SET VARC_RC_3 | type=VARC | ctx=rc_passage | layout=text_only | title=Criminal Responsibility and Mental Science
@CTX
How can we know what someone else is thinking or feeling, let alone prove it in court? In his 1863 book, A General View of the Criminal Law of England, James Fitzjames Stephen, among the most celebrated legal thinkers of his generation, was of the opinion that the assessment of a person's mental state was an inference made with "little consciousness." In a criminal case, jurors, doctors, and lawyers could watch defendants-scrutinizing clothing, mannerisms, tone of voice-but the best they could hope for were clues. Rounding these clues up to a judgment about a defendant's guilt, or a defendant's life, was an act of empathy and imagination.... The closer the resemblance between defendants and their judges, the easier it was to overlook the gap that inference filled. Conversely, when a defendant struck officials as unlike themselves, whether by dint of disease, gender, confession, or race, the precariousness of judgments about mental state was exposed.

In the nineteenth century, physicians who specialized in the study of madness and the care of the insane held themselves out as experts in the new field of mental science. Often called alienists or mad doctors, they were the predecessors of modern psychiatrists, neurologists, and psychologists. The opinions of family and neighbors had once been sufficient to sift the sane from the insane, but a growing belief that insanity was a subtle condition that required expert, medical diagnosis pushed physicians into the witness box.... Lawyers for both prosecution and defense began to recruit alienists to assess defendants' sanity and to testify to it in court.

Irresponsibility and insanity were not identical, however. Criminal responsibility was a legal concept and not, fundamentally, a medical one. Stephen explained: "The question 'What are the mental elements of responsibility?' is, and must be, a legal question. It cannot be anything else, for the meaning of responsibility is liability to punishment." ... Nonetheless, medical and legal accounts of what it meant to be mentally sound became entangled and mutually referential throughout the nineteenth century. Lawyers relied on medical knowledge to inform their opinions and arguments about the sanity of their clients. Doctors commented on the legal responsibility of their patients. Ultimately, the fields of criminal law and mental science were both invested in constructing an image of the broken and damaged psyche that could be contrasted with the whole and healthy one. This shared interest, and the shared space of the criminal courtroom, made it nearly impossible to consider responsibility without medicine, or insanity without law.

Physicians and lawyers shared more than just concern for the mind. Class, race, and gender bound these middle-class, white, professional men together, as did family ties, patriotism, Protestantism, business ventures, the alumni networks of elite schools and universities, and structures of political patronage. But for all their affinities, men of medicine and law were divided by contests over the borders of criminal responsibility, as much within each profession as between them. Alienists steadily pushed the boundaries of their field, developing increasingly complex and capacious definitions of insanity. Eccentricity and aggression came to be classified as symptoms of mental disease, at least by some.
@END_CTX

@Q type=MCQ | tax=rc_detail | topic=Reading Comprehension | sub=History/Law | diff=medium | m=3,1 | ans=A
? The last paragraph of the passage refers to "middle-class, white, professional men". Which one of the following qualities best describes the connection among them?
A. The borders of criminal responsibility.
B. The opinions of family and neighbours.
C. Eccentricity and aggression.
D. Empathy and imagination.
> The paragraph states they were bound by class, race, gender, etc., BUT "divided by contests over the borders of criminal responsibility". The question asks what describes the *connection*? Actually, looking at the options, A, B, C, D are phrases from the text. The question asks for the connection. The text says "Class, race, and gender bound these... men together". However, the options don't list those. Let's re-read carefully. The men were *divided* by "contests over the borders of criminal responsibility". This seems to be the point of *tension* or the defining professional struggle connecting their interaction in the courtroom. Wait, looking at the official answer A ("The borders of criminal responsibility"), it seems the question implies what issue connected/involved them professionally, even if it was a contest. Or perhaps it implies they were connected by the *debate* over it.

@Q type=MCQ | tax=rc_factual | topic=Reading Comprehension | sub=History/Law | diff=easy | m=3,1 | ans=B
? According to the passage, who or what was an "alienist"?
A. Professionals who pushed the boundaries of their fields till they became unrecognisable in the nineteenth century.
B. Physicians who specialised in the study of madness and the care of the insane in the nineteenth century.
C. Physicians and lawyers who were responsible for the condition of immigrants or 'aliens' in the nineteenth century.
D. Physicians and lawyers who were responsible for examining accounts of extraterrestrials or 'aliens' in the nineteenth century.
> Direct quote: "physicians who specialized in the study of madness and the care of the insane... Often called alienists".

@Q type=MCQ | tax=rc_inference | topic=Reading Comprehension | sub=History/Law | diff=medium | m=3,1 | ans=D
? Study the following sets of concepts and identify the set that is conceptually closest to the concerns and arguments of the passage.
A. Empathy, Prosecution, Knowledge, Business.
B. Judgement, Belief, Accounts, Patronage.
C. Assessment, Empathy, Prosecution, Patriotism.
D. Judgement, Insanity, Punishment, Responsibility.
> The passage discusses the judgment of mental states, the definition of insanity vs legal responsibility, and liability to punishment. Set D covers the core legal/medical intersection discussed.

@Q type=MCQ | tax=rc_vocab | topic=Reading Comprehension | sub=History/Law | diff=medium | m=3,1 | ans=A
? "Conversely, when a defendant struck officials as unlike themselves, whether by dint of disease, gender, confession, or race, the precariousness of judgments about mental state was exposed." Which one of the following best describes the use of the word "confession" in this sentence?
A. Referring to the practice of 'confession' in some faiths, here it is a metaphor for the religion of the defendant.
B. Referring to the gender, race or disease claimed as a defence by the defendant, here it is a synonym for 'professing' a gender, race, or disease.
C. Referring to the defendant's confession of his or her crime as false, because 'didn't' is an archaic form of 'didn't' or 'did not'.
D. The defendants struck out at the officials and then confessed to the act.
> The list "disease, gender, confession, or race" refers to attributes that make the defendant "unlike" the officials (who are Protestant, white, men). "Confession" here likely refers to religious confession (Catholicism etc.), serving as a marker for religion/faith, contrasting with the "Protestantism" of the officials mentioned later.
@END_Q
@END_SET

@SET VARC_VA_4 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=va_odd_one | topic=Verbal Ability | sub=Para Jumbles (Odd One Out) | diff=medium | m=3,0 | ans=1
? Five jumbled sentences (labelled 1, 2, 3, 4, and 5), related to a topic, are given below. Four of them can be put together to form a coherent paragraph. Identify the odd sentence out and key in the number of that sentence as your answer.
1. The Bayeux tapestry was, therefore, an obvious way to tell people about the downfall of the English and the rise of the Normans.
2. So if we take expert in Anglo-Saxon culture Gale Owen-Crocker's idea that the tapestry was originally hung in a square with certain scenes facing each other, people would have stood in the centre.
3. Art historian Linda Neagley has argued that pre-Renaissance people interacted with art visually, kinaesthetically (sensory perception through bodily movement) and physically.
4. That would make it an 11th-century immersive space with scenes corresponding and echoing each other, drawing the viewer's attention, playing on their senses and understanding of the story they thought they knew.
5. The Bayeux tapestry would have been hung at eye level to enable this.
> Sentences 3, 2, 4, 5 connect logically: 3 introduces how people interacted with art (visually/physically). 2 applies this to the Bayeux tapestry (hung in a square, people in center). 4 explains the effect (immersive space). 5 adds the detail about hanging at eye level to enable this interaction. Sentence 1 discusses the *content/purpose* (propaganda about Normans), which is distinct from the *physical experience/installation* theme of the other four.
@END_Q
@END_SET

@SET VARC_RC_4 | type=VARC | ctx=rc_passage | layout=text_only | title=Income Inequality and Economic Growth
@CTX
Studies showing that income inequality plays a positive role in economic growth are largely based on three arguments. The first argument focuses on investment indivisibilities wherein large sunk costs are required when implementing new fundamental innovations. Without stock markets and financial institutions to mobilize large sums of money, a high concentration of wealth is needed for individuals to undertake new industrial activities accompanied by high sunk costs... [One study] shows the relation between economic growth and income inequality for 45 countries during 1966-1995. [It was found that the increase in income inequality has a significant positive relationship with economic growth in the short and medium term. Using system GMM, [another study estimated] the relation between income inequality and economic growth for 106 countries during 1965-2005 period. The results show that income inequality has a positive impact on economic growth in the short run, but the two are negatively correlated in the long run.

The second argument is related to moral hazard and incentives... Because economic performance is determined by the unobservable level of effort that agents make, paying compensations without taking into account the economic performance achieved by individual agents will fail to elicit optimum effort from the agents. Thus, certain income inequalities contribute to growth by enhancing worker motivation. and by giving motivation to innovators and entrepreneurs... Finally, [another study] point[s] out that the concentration of wealth or stock ownership in relation to corporate governance contributes to growth. If stock ownership is distributed and owned by a large number of shareholders, it is not easy to make quick decisions due to the conflicting interests among shareholders, and this may also cause a free-rider problem in terms of monitoring and supervising managers and workers.

Various studies have examined the relationships between income inequality and economic growth, and most of these assert that a negative correlation exists between the two. Analyzing 159 countries for 1980-2012, they conclude that there exists a negative relation between income inequality and economic growth; when the income share of the richest 20% of population increases by 1%, the GDP decreases by 0.08%, whereas when the income share of the poorest 20% of population increases by 1%, the GDP increases by 0.38%. Some studies find that inequality has a negative impact on growth due to poor human capital accumulation and low fertility rates... while [others] point out that inequality creates political instability, resulting in lower investment.... [Some economists] argue that widening income inequality has a negative impact on economic growth because it negatively affects social consensus or social capital formation.

One important research topic is the correlation between democratization and income redistribution. [Some scholars] explain that social pressure for income redistribution rises as income inequality increases in a democratic society. In other words, when democratization extends suffrage to a wider class of people, the increased political power of low- and middle-income voters results in broader support for income redistribution and social welfare expansion. However... if the rich have more political influence than the poor, the democratic system actually worsens income inequality rather than improving it.
@END_CTX

@Q type=MCQ | tax=rc_summary | topic=Reading Comprehension | sub=Economics | diff=medium | m=3,1 | ans=D
? Which one of the options below best summarises the passage?
A. The passage claims that evaluating the effect of income inequality on economic growth without considering both short- and long-term consequences is misguided
B. The passage confines its discussion to financing gaps and corporate control while undercutting cross country evidence and overlooking the significance of concerns regarding human capital accumulation, fertility rates, and income redistribution under democratisation.
C. The passage argues that income inequality accelerates economic growth while also emphasising the significance of concerns regarding human capital accumulation, fertility rates, and political instability.
D. The passage outlines investment, incentive, and governance channels through which income inequality may support economic growth and reports short-term gains while noting longterm drawbacks
> Option D covers the first half (investment, incentive, governance channels for positive growth) and the second half (short-term gains vs long-term negative correlations/drawbacks found in other studies).

@Q type=MCQ | tax=rc_vocab | topic=Reading Comprehension | sub=Economics | diff=medium | m=3,1 | ans=A
? The passage refers to "democratization". Choose the one option below that comes closest to the opposite of this process.
A. After the emergency decree, the regime shifted toward authoritarianism as suffrage narrowed and opposition parties were deregistered.
B. Corporate donations were capped and parties received public funding which was portrayed as establishing an oligarchy.
C. Municipalities adopted participatory budgeting and recall elections which a press release called totalitarianism.
D. The coalition imposed term limits and strengthened judicial review in order to further entrench autocratic rule.
> Democratization involves extending suffrage and political power to a wider class. Option A describes the opposite: narrowing suffrage and deregistering parties (authoritarianism).

@Q type=MCQ | tax=rc_structure | topic=Reading Comprehension | sub=Economics | diff=medium | m=3,1 | ans=C
? The primary function of the three-part case for a positive income inequality-economic growth link in the first half of the passage is to show that:
A. inequality boosts growth in every period and type of economy, regardless of finance or governance conditions.
B. mature stock markets make wealth concentration unnecessary, yet they might still be harmful to investment.
C. inequality can aid short-term growth in settings with high sunk costs, incentive alignment, and concentrated ownership.
D. dispersed ownership speeds corporate decision-making and removes free rider problems.
> The arguments focus on specific conditions: high sunk costs (investment indivisibilities), incentive alignment (moral hazard), and corporate governance (concentrated ownership). The studies cited mentioned positive impact in the "short run". Option C captures these specific conditions and the temporal aspect.

@Q type=MCQ | tax=rc_inference | topic=Reading Comprehension | sub=Economics | diff=medium | m=3,1 | ans=A
? According to the incentive or moral hazard argument, which one of the designs below is most consistent with the claim that some inequality can raise growth?
A. Pay rewards on verifiable performance for highly productive workers.
B. Rents protected by market power that enlarge top incomes without linking pay to results.
C. Wages are determined by tenure rather than output to ensure equity.
D. A regime that concentrates stock ownership in relation to corporate governance.
> The text says: "paying compensations without taking into account the economic performance... will fail to elicit optimum effort... income inequalities contribute to growth by enhancing worker motivation." Option A (rewards on performance) aligns with this logic.
@END_Q
@END_SET

@SET VARC_VA_5 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=va_summary | topic=Verbal Ability | sub=Paragraph Summary | diff=medium | m=3,1 | ans=A
? The passage given below is followed by four summaries. Choose the option that best captures the essence of the passage.
In the dynamic realm of creativity, artists often find themselves at the crossroads between drawing inspiration from diverse cultures and inadvertently crossing into the territory of cultural appropriation. Inspiration is the lifeblood of creativity, driving artists to create works that resonate across borders. The globalized nature of the modern world invites artists to draw from a vast array of cultural influences. When approached respectfully, inspiration becomes a bridge, fostering understanding and appreciation of cultural diversity. However, the line between inspiration and cultural appropriation can be thin and easily blurred. Cultural appropriation occurs when elements from a particular culture are borrowed without proper understanding, respect, or acknowledgement. This leads to the commodification of sacred symbols, the reinforcement of stereotypes, and the erasure of the cultural context from which these elements originated. It's essential to recognize that the impact of cultural appropriation extends beyond the realm of artistic expression, influencing societal perceptions and perpetuating power imbalances.
A. Artists in a globalised world must navigate between drawing inspiration from diverse cultures respectfully and cultural appropriation that involves borrowing without proper acknowledgement which has broader societal impacts including perpetuating power imbalances.
B. In today's world of creativity, artists have to decide between respectfully acknowledging works that are inspired by diverse cultures and appropriating elements without respect for their contexts.
C. In a globalised world, artists must draw from diverse cultural influences to create works that appeal to all, and this results in instances of both inspiration and cultural appropriation.
D. Artists must navigate the thin line between inspiration and cultural appropriation, where respectful inspiration fosters cultural understanding whereas appropriation involves borrowing without acknowledgement leading to commodification and reinforcement of stereotypes.
> Option A captures the balance (inspiration vs appropriation), the definition of appropriation (borrowing without acknowledgment), and the critical consequence (societal impacts/power imbalances), which is the concluding point of the passage. Option D is close but misses the "power imbalances" aspect mentioned in the final sentence.
@END_Q
@END_SET

@END_S



@S DILR

@SET DILR_SET_1 | type=DILR | ctx=dilr_set | layout=split_view | title=Round Table Seating
@CTX
A round table has seven chairs around it. The chairs are numbered 1 through 7 in a clockwise direction. Four friends, Aslam, Bashir, Chhavi, and Davies, sit on four of the chairs. In the starting position, Aslam and Chhavi are sitting next to each other, while for Bashir as well as Davies, there are empty chairs on either side of the chairs that are sitting on. The friends take turns moving either clockwise or counterclockwise from their chair. The friend who has to move in a turn occupies the first empty chair in whichever direction (s) he chooses to move.

Aslam moves first (Turn 1), followed by Bashir, Chhavi, and Davies (Turns 2, 3, and 4, respectively). Then Aslam moves again followed by Bashir, and Chhavi (Turns 5, 6, and 7, respectively).

The following information is known:
1. The four friends occupy adjacent chairs only at the end of Turn 2 and Turn 6.
2. Davies occupies Chair 2 after Turn 1 and Chair 4 after Turn 5, and Chhavi occupies Chair 7 after Turn 2.
@END_CTX

@Q type=TITA | tax=lr_arrangement | topic=Logical Reasoning | sub=Seating Arrangement | diff=hard | m=3,0 | ans=4
? What is the number of the chair initially occupied by Bashir?
> [cite_start]Based on the movement rules and the constraint that Bashir has empty chairs on both sides initially, tracing the moves backward from the known positions (Davies at 2 after Turn 1, etc.) reveals Bashir started at Chair 4[cite: 978].

@Q type=MCQ | tax=lr_arrangement | topic=Logical Reasoning | sub=Seating Arrangement | diff=hard | m=3,1 | ans=D
? Who sits on the chair numbered 4 at the end of Turn 3?
A. Bashir
B. Chhavi
C. Davies
D. No one
> [cite_start]Tracing the movements to Turn 3, Chair 4 is unoccupied[cite: 980].

@Q type=MCQ | tax=lr_arrangement | topic=Logical Reasoning | sub=Seating Arrangement | diff=hard | m=3,1 | ans=A
? Which of the chairs are occupied at the end of Turn 6?
A. Chairs numbered 4, 5, 6, and 7
B. Chairs numbered 1, 2, 3, and 4
C. Chairs numbered 2, 3, 4, and 5
D. Chairs numbered 1, 2, 6, and 7
> At the end of Turn 6, the friends occupy a contiguous block of chairs (rule 1). [cite_start]The positions correspond to 4, 5, 6, and 7[cite: 987].

@Q type=MCQ | tax=lr_arrangement | topic=Logical Reasoning | sub=Seating Arrangement | diff=hard | m=3,1 | ans=B
? Which of the following BEST describes the friends sitting on chairs adjacent to the one occupied by Bashir at the end of Turn 7?
A. Chhavi only
B. Davies only
C. Chhavi and Davies
D. Aslam and Chhavi
> [cite_start]After the final moves, only Davies is adjacent to Bashir[cite: 992].
@END_SET

@SET DILR_SET_2 | type=DILR | ctx=dilr_set | layout=split_view | title=InnovateX Ratings
@CTX
At InnovateX, six employees, Asha, Bunty, Chintu, Dolly, Eklavya, and Falguni, were split into two groups of three each: Elite led by Manager Kuku, and Novice led by Manager Lalu. At the end of each quarter, Kuku and Lalu handed out ratings to all members in their respective groups. In each group, each employee received a distinct integer rating from 1 to 3. The score for an employee at the end of a quarter is defined as their cumulative rating from the beginning of the year.

At the end of each quarter the employee in Novice with the highest score was promoted to Elite, and the employee in Elite with the minimum score was demoted to Novice. If there was a tie in scores, the employee with a higher rating in the latest quarter was ranked higher.

Asha, Bunty, and Chintu were in Elite at the beginning of Quarter 1. All of them were in Novice at the beginning of Quarter 4. Dolly and Falguni were the only employees who got the same rating across all the quarters.

The following is known about ratings given by Lalu:
1. Bunty received a rating of 1 in Quarter 2.
2. Asha and Dolly received ratings of 1 and 2, respectively, in Quarter 3.
@END_CTX

@Q type=TITA | tax=lr_ranking | topic=Logical Reasoning | sub=Ranking | diff=medium | m=3,0 | ans=4
? What was Eklavya's score at the end of Quarter 2?
> [cite_start]Calculating the cumulative scores based on promotions/demotions and known ratings yields 4[cite: 1010].

@Q type=TITA | tax=lr_ranking | topic=Logical Reasoning | sub=Ranking | diff=medium | m=3,0 | ans=0
? How many employees changed groups more than once up to the beginning of Quarter 4?
> [cite_start]Tracking the movements shows that no employee moved back and forth more than once[cite: 1012].

@Q type=TITA | tax=lr_ranking | topic=Logical Reasoning | sub=Ranking | diff=medium | m=3,0 | ans=5
? What was Bunty's score at the end of Quarter 3?
> [cite_start]Bunty's cumulative score sums to 5[cite: 1014].

@Q type=TITA | tax=lr_ranking | topic=Logical Reasoning | sub=Ranking | diff=medium | m=3,0 | ans=4
? For how many employees can the scores at the end of Quarter 3 be determined with certainty?
> [cite_start]The scores can be uniquely determined for 4 employees[cite: 1016].

@Q type=MCQ | tax=lr_ranking | topic=Logical Reasoning | sub=Ranking | diff=medium | m=3,1 | ans=D
? Which of the following statements is/are NECESSARILY true?
I. Asha received a rating of 2 in Quarter 1.
II. Asha received a rating of 1 in Quarter 2.
A. Neither I nor II
B. Both I and II
C. Only I
D. Only II
> [cite_start]Only statement II is necessarily true[cite: 1024].
@END_SET

@SET DILR_SET_3 | type=DILR | ctx=dilr_set | layout=split_view | title=Import Tariffs
@CTX
Five countries engage in trade with each other. Each country levies import tariffs on the other countries. The import tariff levied by Country X on Country Y is calculated by multiplying the corresponding tariff percentage with the total imports of Country X from Country Y.

The radar chart (not shown) depicts different import tariff percentages charged by each of the five countries on the others. For example, US (the blue line in the chart) charges 20%, 40%, 30%, and 30% import tariff percentages on imports from France, India, Japan, and UK, respectively. The bar chart (not shown) depicts the import tariffs levied by each county on other countries. For example, US charged import tariff of 3 billion USD on UK.

Assume that imports from one country to another equals the exports from the latter to the former. The trade surplus of Country X with Country Y is defined as: Exports from Country X to Country Y - Imports to Country X from Country Y.
@END_CTX

@Q type=MCQ | tax=di_calculation | topic=Data Interpretation | sub=Charts | diff=medium | m=3,1 | ans=C
? How much is Japan's export to India worth?
A. 8.5 Billion USD
B. 16.0 Billion USD
C. 7.0 Billion USD
D. 1.75 Billion USD
> [cite_start]Calculated from the tariff percentage and total tariff value provided in the charts[cite: 1042].

@Q type=MCQ | tax=di_calculation | topic=Data Interpretation | sub=Charts | diff=medium | m=3,1 | ans=B
? Which among the following is the highest?
A. Exports by Japan to UK
B. Imports by US from France
C. Exports by France to Japan
D. Imports by France from India
> [cite_start]Comparing the calculated trade values shows Imports by US from France is the highest[cite: 1048].

@Q type=MCQ | tax=di_calculation | topic=Data Interpretation | sub=Charts | diff=medium | m=3,1 | ans=B
? What is the trade surplus/trade deficit of India with UK?
A. Surplus of 15.0 Billion USD
B. Deficit of 15.0 Billion USD
C. Surplus of 10.0 Billion USD
D. Deficit of 10.0 Billion USD
> [cite_start]India has a deficit of 15.0 Billion USD with the UK[cite: 1054].
@END_SET

@SET DILR_SET_4 | type=DILR | ctx=dilr_set | layout=split_view | title=Train Booking
@CTX
A train travels from Station A to Station E, passing through stations B, C, and D, in that order. The train has a seating capacity of 200. A ticket may be booked from any station to any other station ahead on the route. A ticket reserves one seat on every intermediate segment. The occupancy factor for a segment is the total number of seats reserved in the segment as a percentage of the seating capacity.

Information:
1. Segment C - D had an occupancy factor of 95%. Only segment B - C had a higher occupancy factor.
2. Exactly 40 tickets were booked from B to C and 30 tickets were booked from B to E.
3. Among the seats reserved on segment D - E, exactly four-sevenths were from stations before C.
4. The number of tickets booked from A to C was equal to that booked from A to E, and it was higher than that from B to E.
5. No tickets were booked from A to B, from B to D and from D to E.
6. The number of tickets booked for any segment was a multiple of 10.
@END_CTX

@Q type=MCQ | tax=di_reasoning | topic=Data Interpretation | sub=Logical Reasoning | diff=hard | m=3,1 | ans=B
? What was the occupancy factor for segment D - E?
A. 35%
B. 70%
C. 77%
D. 84%
> [cite_start]Based on the ticket distribution constraints, the occupancy factor is 70%[cite: 1075].

@Q type=TITA | tax=di_reasoning | topic=Data Interpretation | sub=Logical Reasoning | diff=hard | m=3,0 | ans=50
? How many tickets were booked from Station A to Station E?
> [cite_start]The number of tickets is 50[cite: 1077].

@Q type=TITA | tax=di_reasoning | topic=Data Interpretation | sub=Logical Reasoning | diff=hard | m=3,0 | ans=80
? How many tickets were booked from Station C?
> [cite_start]The total booked from C (to D and E) is 80[cite: 1079].

@Q type=TITA | tax=di_reasoning | topic=Data Interpretation | sub=Logical Reasoning | diff=hard | m=3,0 | ans=40
? What is the difference between the number of tickets booked to Station C and the number of tickets booked to Station D?
> [cite_start]The difference is 40[cite: 1081].

@Q type=TITA | tax=di_reasoning | topic=Data Interpretation | sub=Logical Reasoning | diff=hard | m=3,0 | ans=60
? How many tickets were booked to travel in exactly one segment?
> [cite_start]Summing tickets for A-B (0), B-C, C-D, D-E (0) etc., yields 60[cite: 1083].
@END_SET

@SET DILR_SET_5 | type=DILR | ctx=dilr_set | layout=split_view | title=Foot Tapping Game
@CTX
Alia, Badal, Clive, Dilshan, and Ehsaan played a game where each asks a unique question to all others, who respond by tapping feet: 1 tap ("Yes"), 2 taps ("No"), 3 taps ("Maybe").
Total taps = 40. Each question got at least one Yes, No, and Maybe.

Information:
1. Alia tapped 6 times total and received 9 taps. She said "Yes" to Clive and Dilshan.
2. Dilshan tapped 11 times, Ehsaan tapped 9 times. Dilshan said "No" to Badal.
3. Badal, Dilshan, and Ehsaan received equal number of taps.
4. No one said "Yes" more than twice.
5. No one's answer to Alia matched Alia's answer to them. Same for Ehsaan.
6. Clive tapped more times than Badal.
@END_CTX

@Q type=TITA | tax=lr_logic | topic=Logical Reasoning | sub=Games | diff=hard | m=3,0 | ans=7
? How many taps did Clive receive for his question?
> [cite_start]Solving the grid of responses shows Clive received 7 taps[cite: 1100].

@Q type=MCQ | tax=lr_logic | topic=Logical Reasoning | sub=Games | diff=hard | m=3,1 | ans=D
? Which two people tapped an equal number of times in total?
A. Badal and Dilshan
B. Clive and Ehsaan
C. Dilshan and Clive
D. Alia and Badal
> [cite_start]Alia and Badal tapped the same number of times[cite: 1106].

@Q type=MCQ | tax=lr_logic | topic=Logical Reasoning | sub=Games | diff=hard | m=3,1 | ans=A
? What was Clive's response to Ehsaan's question?
A. No
B. Maybe
C. Cannot be determined
D. Yes
> [cite_start]Clive responded "No"[cite: 1112].

@Q type=TITA | tax=lr_logic | topic=Logical Reasoning | sub=Games | diff=hard | m=3,0 | ans=6
? How many "Yes" responses were received across all the questions?
> [cite_start]There were 6 "Yes" responses total[cite: 1114].
@END_SET

@END_S

@S QA

@SET QA_ATOMIC_47 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_algebra | topic=Quant | sub=Functions | diff=medium | m=3,1 | ans=B
? A value of $c$ for which the minimum value of $f(x)=x^{2}-4cx+8c$ is greater than the maximum value of $g(x)=-x^{2}+3cx-2c,$ is
A. $2$
B. $\frac{1}{2}$
C. $-\frac{1}{2}$
D. $-2$
> Find the vertex of the parabolas. Min of $f(x)$ occurs at $x=2c$, value is $8c - 4c^2$. Max of $g(x)$ occurs at $x=1.5c$, value is $2.25c^2 - 2c$. [cite_start]Set inequality $8c - 4c^2 > 2.25c^2 - 2c$ and solve for $c$[cite: 1117].
@END_Q
@END_SET

@SET QA_ATOMIC_48 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_arithmetic | topic=Quant | sub=Time Speed Distance | diff=medium | m=3,1 | ans=D
? Shruti travels a distance of $224$ km in four parts for a total travel time of $3$ hours. Her speeds in these four parts follow an arithmetic progression, and the corresponding time taken to cover these four parts follow another arithmetic progression. If she travels at a speed of $960$ meters per minute for $30$ minutes to cover the first part, then the distance, in meters, she travels in the fourth part is
A. $76800$
B. $112000$
C. $96000$
D. $86400$
> Convert units to km/h or consistent metric. $S_1 = 960$ m/min. $T_1 = 30$ min. Total distance 224 km. [cite_start]Use sum of AP properties for speed and time to find variables [cite: 1125-1127].
@END_Q
@END_SET

@SET QA_ATOMIC_49 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=qa_number_theory | topic=Quant | sub=Numbers | diff=medium | m=3,0 | ans=6
? In a 3-digit number $N$, the digits are non-zero and distinct such that none of the digits is a perfect square, and only one of the digits is a prime number. Then, the number of factors of the minimum possible value of $N$ is
> Identify valid digits (non-zero, non-square: 2, 3, 5, 6, 7, 8). Primes: 2, 3, 5, 7. Non-primes: 6, 8. Construct min $N$ with one prime and distinct digits (e.g., using small digits). [cite_start]Calculate factors of that $N$[cite: 1135].
@END_Q
@END_SET

@SET QA_ATOMIC_50 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_algebra | topic=Quant | sub=Inequalities | diff=hard | m=3,1 | ans=A
? Let $3\le x\le6$ and $[x^{2}]=[x]^{2}$, where $[z]$ is the greatest integer not exceeding $z$. If set $S$ represents all feasible values of $x$, then a possible subset of $S$ is
A. $[3,\sqrt{10})\cup[5,\sqrt{26})\cup\{6\}$
B. $[3,\sqrt{10}]\cup[5,\sqrt{26}]$
C. $[3,\sqrt{10}]\cup[4,\sqrt{17}]\cup\{6\}$
D. $(4,\sqrt{18})\cup[5,\sqrt{27})\cup\{6\}$
> Analyze intervals where $[x]$ is constant (3, 4, 5, 6). For $[x]=3$, require $[x^2]=9$. For $[x]=4$, require $[x^2]=16$. [cite_start]Check validity in range [cite: 1140-1141].
@END_Q
@END_SET

@SET QA_ATOMIC_51 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=qa_arithmetic | topic=Quant | sub=Profit and Loss | diff=easy | m=3,0 | ans=15
? Stocks A, B and C are priced at rupees $120$, $90$ and $150$ per share, respectively. A trader holds a portfolio consisting of $10$ shares of stock A, and $20$ shares of stocks B and C put together. If the total value of her portfolio is rupees $3300$, then the number of shares of stock B that she holds, is
> Let $b$ be shares of B, then $c = 20-b$. Equation: $10(120) + 90b + 150(20-b) = 3300$. [cite_start]Solve for $b$ [cite: 1149-1151].
@END_Q
@END_SET

@SET QA_ATOMIC_52 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_algebra | topic=Quant | sub=Sequences | diff=medium | m=3,1 | ans=A
? For any natural number $k$, let $a_{k}=3^{k}$. The smallest natural number $m$ for which $\{(a_{1})^{1}\times(a_{2})^{2}\times...\times(a_{20})^{20}\}<\{a_{21}\times a_{22}\times...\times a_{20+m}\},$ is
A. $58$
B. $59$
C. $56$
D. $57$
> Exponents of 3 form a sequence. LHS exponent is $\sum k^2$. RHS exponent is arithmetic series sum. [cite_start]Set inequality and solve for min $m$[cite: 1155].
@END_Q
@END_SET

@SET QA_ATOMIC_53 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_algebra | topic=Quant | sub=Logarithms | diff=medium | m=3,1 | ans=D
? The number of distinct integers $n$ for which $\log_{\frac{1}{4}}(n^{2}-7n+11)>0$ is
A. $2$
B. infinite
C. $1$
D. $0$
> Inequality $\log_{1/4}(A) > 0 \implies 0 < A < 1$ (base < 1 reverses sign). [cite_start]Solve $0 < n^2-7n+11 < 1$ for integers $n$[cite: 1163].
@END_Q
@END_SET

@SET QA_ATOMIC_54 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=qa_algebra | topic=Quant | sub=Inequalities | diff=medium | m=3,0 | ans=16
? The number of distinct pairs of integers $(x, y)$ satisfying the inequalities $x>y\ge3$ and $x+y<14$ is
> [cite_start]Iterate through possible integer values of $y$ starting from 3 ($y=3, 4, 5...$) and find corresponding valid $x$ values ($y < x < 14-y$)[cite: 1171].
@END_Q
@END_SET

@SET QA_ATOMIC_55 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_arithmetic | topic=Quant | sub=Interest | diff=medium | m=3,1 | ans=A
? At a certain simple rate of interest, a given sum amounts to Rs $13920$ in $3$ years, and to Rs $18960$ in $6$ years and $6$ months. If the same given sum had been invested for $2$ years at the same rate as before but with interest compounded every $6$ months, then the total interest earned, in rupees, would have been nearest to
A. $3221$
B. $3180$
C. $3150$
D. $3096$
> Find Principal $P$ and Rate $R$ from SI data (Difference in amount / difference in time = yearly interest). [cite_start]Then calculate CI for 2 years compounded semi-annually [cite: 1175-1176].
@END_Q
@END_SET

@SET QA_ATOMIC_56 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_arithmetic | topic=Quant | sub=Mixtures | diff=medium | m=3,1 | ans=D
? A container holds $200$ litres of a solution of acid and water, having $30\%$ acid by volume. Atul replaces $20\%$ of this solution with water, then replaces $10\%$ of the resulting solution with acid, and finally replaces $15\%$ of the solution thus obtained, with water. The percentage of acid by volume in the final solution obtained after these three replacements, is nearest to
A. $23$
B. $25$
C. $29$
D. $27$
> Track the volume of acid remaining after each step. Step 1 (Water replace): Acid decreases. Step 2 (Acid replace): Acid increases. [cite_start]Step 3 (Water replace): Acid decreases [cite: 1184-1186].
@END_Q
@END_SET

@SET QA_ATOMIC_57 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=qa_algebra | topic=Quant | sub=Word Problems | diff=medium | m=3,0 | ans=55
? In a class, there were more than $10$ boys and a certain number of girls. After $40\%$ of the girls and $60\%$ of the boys left the class, the remaining number of girls was $8$ more than the remaining number of boys. Then, the minimum possible number of students initially in the class was
> Let $B, G$ be initial numbers. Remaining: $0.6G = 0.4B + 8$. Simplify equation ($3G = 2B + 40$). [cite_start]Find integer solutions for $B > 10$ that minimize $B+G$ [cite: 1194-1196].
@END_Q
@END_SET

@SET QA_ATOMIC_58 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_arithmetic | topic=Quant | sub=Permutations Combinations | diff=medium | m=3,1 | ans=A
? A cafeteria offers $5$ types of sandwiches. Moreover, for each type of sandwich, a customer can choose one of $4$ breads and opt for either small or large sized sandwich. Optionally, the customer may also add up to $2$ out of $6$ available sauces. The number of different ways in which an order can be placed for a sandwich, is
A. $880$
B. $840$
C. $800$
D. $600$
> Main choices: $5 \times 4 \times 2 = 40$. Sauces: 0, 1, or 2 sauces from 6. Ways = $\binom{6}{0} + \binom{6}{1} + \binom{6}{2}$. [cite_start]Total = Main $\times$ Sauces [cite: 1200-1202].
@END_Q
@END_SET

@SET QA_ATOMIC_59 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_number_theory | topic=Quant | sub=Progressions | diff=medium | m=3,1 | ans=A
? In the set of consecutive odd numbers $\{1,3,5,...,57\}$, there is a number $k$ such that the sum of all the elements less than $k$ is equal to the sum of all the elements greater than $k$. Then, $k$ equals
A. $41$
B. $39$
C. $43$
D. $37$
> Series is arithmetic. Let $k$ be the $m$-th term. Sum of first $(m-1)$ terms equals sum of terms from $(m+1)$ to end. [cite_start]Solve for $k$ [cite: 1210-1211].
@END_Q
@END_SET

@SET QA_ATOMIC_60 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_arithmetic | topic=Quant | sub=Time and Work | diff=medium | m=3,1 | ans=A
? Arun, Varun and Tarun, if working alone, can complete a task in $24$, $21$, and $15$ days, respectively. They charge Rs $2160$, Rs $2400$, and Rs $2160$ per day, respectively, even if they are employed for a partial day. On any given day, any of the workers may or may not be employed to work. If the task needs to be completed in $10$ days or less, then the minimum possible amount, in rupees, required to be paid for the entire task is
A. $38400$
B. $38880$
C. $34400$
D. $47040$
> Calculate efficiency and cost per unit work for each. [cite_start]Optimize the mix of workers to finish $\ge 1$ unit of work within 10 days at min cost [cite: 1219-1222].
@END_Q
@END_SET

@SET QA_ATOMIC_61 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=qa_arithmetic | topic=Quant | sub=Interest | diff=medium | m=3,0 | ans=900
? Kamala divided her investment of Rs $100000$ between stocks, bonds, and gold. Her investment in bonds was $25\%$ of her investment in gold. With annual returns of $10\%$, $6\%$, $8\%$ on stocks, bonds, and gold, respectively, she gained a total amount of Rs $8200$ in one year. The amount, in rupees, that she gained from the bonds, was
> Let Gold $= G$, Bonds $= 0.25G$, Stocks $= 100000 - 1.25G$. Total return equation: $0.10(Stocks) + 0.06(Bonds) + 0.08(Gold) = 8200$. [cite_start]Solve for $G$ then Bond interest [cite: 1230-1232].
@END_Q
@END_SET

@SET QA_ATOMIC_62 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_algebra | topic=Quant | sub=Linear Equations | diff=medium | m=3,1 | ans=C
? If $a-6b+6c=4$ and $6a+3b-3c=50$ where $a, b$ and $c$ are real numbers, the value of $2a+3b-3c$ is
A. $20$
B. $14$
C. $18$
D. $15$
> Let $X = 3b-3c$. Rewrite equations: $a - 2X = 4$ and $6a + X = 50$. Solve system for $a$ and $X$. [cite_start]Evaluate $2a + X$[cite: 1237].
@END_Q
@END_SET

@SET QA_ATOMIC_63 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_geometry | topic=Quant | sub=Coordinate Geometry | diff=medium | m=3,1 | ans=D
? The $(x, y)$ coordinates of vertices P, Q and R of a parallelogram PQRS are $(-3,-2)$, $(1, -5)$ and $(9, 1)$, respectively. If the diagonal SQ intersects the x-axis at $(a, 0)$, then the value of $a$ is
A. $\frac{27}{7}$
B. $\frac{10}{3}$
C. $\frac{13}{4}$
D. $\frac{29}{9}$
> Find vertex S using midpoint formula (midpoint of PR = midpoint of QS). Find equation of line SQ. [cite_start]Find x-intercept ($y=0$) [cite: 1245-1246].
@END_Q
@END_SET

@SET QA_ATOMIC_64 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_geometry | topic=Quant | sub=Geometry | diff=hard | m=3,1 | ans=C
? In a circle with center C and radius $6\sqrt{2}$ cm, PQ and SR are two parallel chords separated by one of the diameters. If $\angle PQC=45^{\circ}$ and the ratio of the perpendicular distance of PQ and SR from C is $3: 2$, then the area, in sq. cm, of the quadrilateral PQRS is
A. $4(3+\sqrt{14})$
B. $4(3\sqrt{2}+\sqrt{7})$
C. $20(3+\sqrt{14})$
D. $20(3\sqrt{2}+\sqrt{7})$
> Use trigonometry to find chord lengths and perpendicular distances. [cite_start]Calculate area of trapezoid PQRS [cite: 1254-1255].
@END_Q
@END_SET

@SET QA_ATOMIC_65 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | tax=qa_arithmetic | topic=Quant | sub=Ratios | diff=medium | m=3,1 | ans=D
? The ratio of the number of students in the morning shift and afternoon shift of a school was $13: 9$. After $21$ students moved from the morning shift to the afternoon shift, this ratio became $19: 14$. Next, some new students joined the morning and afternoon shifts in the ratio $3: 8$ and then the ratio of the number of students in the morning shift and the afternoon shift became $5: 4$. The number of new students who joined is
A. $110$
B. $88$
C. $121$
D. $99$
> Use variables for initial students (13x, 9x). Apply transfer logic to find x. [cite_start]Then apply new joining ratio (3y, 8y) to find y and total new students (11y) [cite: 1263-1265].
@END_Q
@END_SET

@SET QA_ATOMIC_66 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=qa_geometry | topic=Quant | sub=Geometry | diff=medium | m=3,0 | ans=60
? If the length of a side of a rhombus is $36$ cm and the area of the rhombus is $396$ sq. cm, then the absolute value of the difference between the lengths, in cm, of the diagonals of the rhombus is
> Area $A = \frac{1}{2} d_1 d_2 = 396$. Side $s = \sqrt{(d_1/2)^2 + (d_2/2)^2} = 36$. [cite_start]Use identities to find $(d_1 - d_2)$[cite: 1274].
@END_Q
@END_SET

@SET QA_ATOMIC_67 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=qa_algebra | topic=Quant | sub=Quadratic Equations | diff=medium | m=3,0 | ans=3
? The number of non-negative integer values of $k$ for which the quadratic equation $x^{2}-5x+k=0$ has only integer roots, is
> Discriminant $D = 25 - 4k$ must be a perfect square. [cite_start]Check non-negative integers $k$ satisfying this[cite: 1278].
@END_Q
@END_SET

@SET QA_ATOMIC_68 | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=TITA | tax=qa_arithmetic | topic=Quant | sub=Profit and Loss | diff=medium | m=3,0 | ans=175
? A shopkeeper offers a discount of $22\%$ on the marked price of each chair, and gives $13$ chairs to a customer for the discounted price of $12$ chairs to earn a profit of $26\%$ on the transaction. If the cost price of each chair is Rs $100$, then the marked price, in rupees, of each chair is
> Let MP be $M$. SP per chair (effectively) involves discount and free item logic. Total Revenue = $12 \times 0.78M$. Total Cost = $13 \times 100$. Profit = 26%. [cite_start]Equate and solve for $M$ [cite: 1282-1283].
@END_Q
@END_SET

@END_S
````

## File: data_sanitized/Cat_2023_slot_1.json
````json
{
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "cat-2023-slot-1",
    "title": "CAT 2023 Slot 1",
    "slug": "cat-2023-slot-1",
    "description": "Official CAT 2023 Slot 1 Question Paper",
    "year": 2023,
    "total_questions": 66,
    "total_marks": 198,
    "duration_minutes": 120,
    "sections": [
      "VARC",
      "DILR",
      "QA"
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "hard",
    "is_free": false,
    "published": false,
    "allow_pause": true,
    "attempt_limit": 0
  },
  "question_sets": [
    {
      "client_set_id": "VARC_RC_1",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 1,
      "context_type": "rc_passage",
      "context_title": "Postcolonial Literature and the Indian Ocean",
      "content_layout": "single_focus",
      "context_image_url": null,
      "context_body": "For early postcolonial literature, the world of the novel was often the nation. Postcolonial novels were usually concerned with national questions. Sometimes the whole story of the novel was taken as an allegory of the nation, whether India or Tanzania. This was important for supporting anti-colonial nationalism, but could also be limiting \\- land-focused and inward-looking.\nMy new book \"Writing Ocean Worlds\" explores another kind of world of the novel: not the village or nation, but the Indian Ocean world. The book describes a set of novels in which the Indian Ocean is at the centre of the story. It focuses on the novelists Amitav Ghosh, Abdulrazak Gurnah, Lindsey Collen and Joseph Conrad who have centred the Indian Ocean world in the majority of their novels.... Their work reveals a world that is outward-looking \\- full of movement, border-crossing and south-south interconnection. They are all very different \\- from colonially inclined (Conrad) to radically anti-capitalist (Collen), but together draw on and shape a wider sense of Indian Ocean space through themes, images, metaphors and language. This has the effect of remapping the world in the reader's mind, as centred in the interconnected global south.\nThe Indian Ocean world is a term used to describe the very long-lasting connections among the coasts of East Africa, the Arab coasts, and South and East Asia. These connections were made possible by the geography of the Indian Ocean. For much of history, travel by sea was much easier than by land, which meant that port cities very far apart were often more easily connected to each other than to much closer inland cities. Historical and archaeological evidence suggests that what we now call globalisation first appeared in the Indian Ocean. This is the interconnected oceanic world referenced and produced by the novels in my book.... For their part Ghosh, Gurnah, Collen and even Conrad reference a different set of histories and geographies than the ones most commonly found in fiction in English. Those are mostly centred in Europe or the US, assume a background of Christianity and whiteness, and mention places like Paris and New York.\nThe novels in my book highlight instead a largely Islamic space, feature characters of colour and centralise the ports of Malindi, Mombasa, Aden, Java and Bombay.... It is a densely imagined, richly sensory image of a southern cosmopolitan culture which provides for an enlarged sense of place in the world. This remapping is particularly powerful for the representation of Africa. In the fiction, sailors and travellers are not all European.... African, as well as Indian and Arab characters, are traders, nakhodas (dhow ship captains), runaways, villains, missionaries and activists. This does not mean that Indian Ocean Africa is romanticised. Migration is often a matter of force; travel is portrayed as abandonment rather than adventure, freedoms are kept from women and slavery is rife. What it does mean is that the African part of the Indian Ocean world plays an active role in its long, rich history and therefore in that of the wider world."
    },
    {
      "client_set_id": "VARC_RC_2",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 2,
      "context_type": "rc_passage",
      "context_title": "Geographic Determinism",
      "content_layout": "single_focus",
      "context_image_url": null,
      "context_body": "Many human phenomena and characteristics \\- such as behaviors, beliefs, economies, genes, incomes, life expectancies, and other things \\- are influenced both by geographic factors and by non-geographic factors. Geographic factors mean physical and biological factors tied to geographic location, including climate, the distributions of wild plant and animal species, soils, and topography. Non-geographic factors include those factors subsumed under the term culture, other factors subsumed under the term history, and decisions by individual people....\n\\[T\\]he differences between the current economies of North and South Korea... cannot be attributed to the modest environmental differences between \\[them\\]... They are instead due entirely to the different \\[government\\] policies... At the opposite extreme, the Inuit and other traditional peoples living north of the Arctic Circle developed warm fur clothes but no agriculture, while equatorial lowland peoples around the world never developed warm fur clothes but often did develop agriculture. The explanation is straightforwardly geographic, rather than a cultural or historical quirk unrelated to geography... Aboriginal Australia remained the sole continent occupied only by hunter/gatherers and with no indigenous farming or herding... \\[Here the\\] explanation is biogeographic: the Australian continent has no domesticable native animal species and few domesticable native plant species. Instead, the crops and domestic animals that now make Australia a food and wool exporter are all non-native (mainly Eurasian) species such as sheep, wheat, and grapes, brought to Australia by overseas colonists.\nToday, no scholar would be silly enough to deny that culture, history, and individual choices play a big role in many human phenomena. Scholars don't react to cultural, historical, and individual-agent explanations by denouncing \"cultural determinism,\" \"historical determinism,\" or \"individual determinism,\" and then thinking no further. But many scholars do react to any explanation invoking some geographic role, by denouncing \"geographic determinism\".\nSeveral reasons may underlie this widespread but nonsensical view. One reason is that some geographic explanations advanced a century ago were racist, thereby causing all geographic explanations to become tainted by racist associations in the minds of many scholars other than geographers. But many genetic, historical, psychological, and anthropological explanations advanced a century ago were also racist, yet the validity of newer non-racist genetic etc. explanations is widely accepted today.\nAnother reason for reflex rejection of geographic explanations is that historians have a tradition, in their discipline, of stressing the role of contingency (a favorite word among historians) based on individual decisions and chance. Often that view is warranted... But often, too, that view is unwarranted. The development of warm fur clothes among the Inuit living north of the Arctic Circle was not because one influential Inuit leader persuaded other Inuit in 1783 to adopt warm fur clothes, for no good environmental reason. A third reason is that geographic explanations usually depend on detailed technical facts of geography and other fields of scholarship... Most historians and economists don't acquire that detailed knowledge as part of the professional training."
    },
    {
      "client_set_id": "VARC_RC_3",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 3,
      "context_type": "rc_passage",
      "context_title": "Wolves in Lozère",
      "content_layout": "single_focus",
      "context_image_url": null,
      "context_body": "RESIDENTS of Lozère, a hilly department in southern France, recite complaints familiar to many rural corners of Europe. In remote hamlets and villages, with names such as Le Bacon and Le Bacon Vieux, mayors grumble about a lack of local schools, jobs, or phone and internet connections. Farmers of grazing animals add another concern: the return of wolves. Eradicated from France last century, the predators are gradually creeping back to more forests and hillsides. \"The wolf must be taken in hand,\" said an aspiring parliamentarian, Francis Palombi, when pressed by voters in an election campaign early this summer. Tourists enjoy visiting a wolf park in Lozère, but farmers fret over their livestock and their livelihoods.\nAs early as the ninth century, the royal office of the Luparii—wolf-catchers—was created in France to tackle the predators. Those official hunters (and others) completed their job in the 1930s, when the last wolf disappeared from the mainland. Active hunting and improved technology such as rifles in the 19th century, plus the use of poison such as strychnine later on, caused the population collapse. But in the early 1990s the animals reappeared. They crossed the Alps from Italy, upsetting sheep farmers on the French side of the border. Wolves have since spread to areas such as Lozère, delighting environmentalists, who see the predators' presence as a sign of wider ecological health. Farmers, who say the wolves cause the deaths of thousands of sheep and other grazing animals, are less cheerful. They grumble that green activists and politically correct urban types have allowed the return of an old enemy.\nVarious factors explain the changes of the past few decades. Rural depopulation is part of the story. In Lozère, for example, farming and a once-flourishing mining industry supported a population of over 140,000 residents in the mid-19th century. Today the department has fewer than 80,000 people, many in its towns. As humans withdraw, forests are expanding. In France, between 1990 and 2015, forest cover increased by an average of 102,000 hectares each year, as more fields were given over to trees. Now, nearly one-third of mainland France is covered by woodland of some sort. The decline of hunting as a sport also means more forests fall quiet. In the mid-to-late 20th century over 2m hunters regularly spent winter weekends tramping in woodland, seeking boars, birds and other prey. Today the Fédération Nationale des Chasseurs, the national body, claims 1.1m people hold hunting licences, though the number of active hunters is probably lower.\nThe mostly protected status of the wolf in Europe—hunting them is now forbidden, other than when occasional culls are sanctioned by the state—plus the efforts of NGOs to track and count the animals, also contribute to the recovery of wolf populations. As the lupine population of Europe spreads westwards, with occasional reports of wolves seen closer to urban areas, expect to hear of more clashes between farmers and those who celebrate the predators' return. Farmers' losses are real, but are not the only economic story. Tourist venues, such as parks where wolves are kept and the animals' spread is discussed, also generate income and jobs in rural areas."
    },
    {
      "client_set_id": "VARC_RC_4",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 4,
      "context_type": "rc_passage",
      "context_title": "\"Original Affluent Society\"",
      "content_layout": "single_focus",
      "context_image_url": null,
      "context_body": "\\[Fifty\\] years after its publication in English \\[in 1972\\], and just a year since \\[Marshall\\] Sahlins himself died—we may ask: why did \\[his essay\\] \"Original Affluent Society\" have such an impact, and how has it fared since? Sahlins's principal argument was simple but counterintuitive: before being driven into marginal environments by colonial powers, hunter-gatherers, or foragers, were not engaged in a desperate struggle for meager survival. Quite the contrary, they satisfied their needs with far less work than people in agricultural and industrial societies, leaving them more time to use as they wished. Hunters, he quipped, keep bankers' hours. Refusing to maximize, many were \"more concerned with games of chance than with chances of game.\"\nThe so-called Neolithic Revolution, rather than improving life, imposed a harsher work regime and set in motion the long history of growing inequality... Moreover, foragers had other options. The contemporary Hadza of Tanzania, who had long been surrounded by farmers, knew they had alternatives and rejected them. To Sahlins, this showed that foragers are not simply examples of human diversity or victimhood but something more profound: they demonstrated that societies make real choices. Culture, a way of living oriented around a distinctive set of values, manifests a fundamental principle of collective self-determination.\nBut the point \\[of the essay\\] is not so much the empirical validity of the data—the real interest for most readers, after all, is not in foragers either today or in the Paleolithic—but rather its conceptual challenge to contemporary economic life and bourgeois individualism. The empirical served a philosophical and political project, a thought experiment and stimulus to the imagination of possibilities. With its title's nod toward The Affluent Society (1958), economist John Kenneth Galbraith's famously skeptical portrait of America's postwar prosperity and inequality, and dripping with New Left contempt for consumerism, \"The Original Affluent Society\" brought this critical perspective to bear on the contemporary world.\nIt did so through the classic anthropological move of showing that radical alternatives to the readers' lives really exist. If the capitalist world seeks wealth through ever greater material production to meet infinitely expansive desires, foraging societies follow \"the Zen road to affluence\": not by getting more, but by wanting less. If it seems that foragers have been left behind by \"progress,\" this is due only to the ethnocentric self-congratulation of the West. Rather than accumulate material goods, these societies are guided by other values: leisure, mobility, and above all, freedom.\nViewed in today's context, of course, not every aspect of the essay has aged well. While acknowledging the violence of colonialism, racism, and dispossession, it does not thematize them as heavily as we might today. Rebuking evolutionary anthropologists for treating present-day foragers as \"left behind\" by progress, it too can succumb to the temptation to use them as proxies for the Paleolithic. Yet these characteristics should not distract us from appreciating Sahlins's effort to show that if we want to conjure new possibilities, we need to learn about actually inhabitable worlds."
    },
    {
      "client_set_id": "VARC_VA_17",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 5,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_VA_18",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 6,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_VA_19",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 7,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_VA_20",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 8,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_VA_21",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 9,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_VA_22",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 10,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_VA_23",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 11,
      "context_image_url": null
    },
    {
      "client_set_id": "VARC_VA_24",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 12,
      "context_image_url": null
    },
    {
      "client_set_id": "DILR_SET_1",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 1,
      "context_type": "dilr_set",
      "context_title": "Visa Processing",
      "content_layout": "split_table",
      "context_image_url": null,
      "context_body": "A visa processing office (VPO) accepts visa applications in four categories \\- US, UK, Schengen, and Others. The applications are scheduled for processing in twenty 15-minute slots starting at 9:00 am and ending at 2:00 pm. Ten applications are scheduled in each slot. There are ten counters in the office, four dedicated to US applications, and two each for UK applications, Schengen applications and Others applications. Applicants are called in for processing sequentially on a first-come-first-served basis whenever a counter gets freed for their category. The processing time for an application is the same within each category. But it may vary across the categories. Each US and UK application requires 10 minutes of processing time. Depending on the number of applications in a category and time required to process an application for that category, it is possible that an applicant for a slot may be processed later.\nOn a particular day, Ira, Vijay and Nandini were scheduled for Schengen visa processing in that order. They had a 9:15 am slot but entered the VPO at 9:20 am. When they entered the office, exactly six out of the ten counters were either processing applications, or had finished processing one and ready to start processing the next. Mahira and Osman were scheduled in the 9:30 am slot on that day for visa processing in the Others category.\nThe following additional information is known about that day:\n1\\. All slots were full.\n2\\. The number of US applications was the same in all the slots. The same was true for the other three categories.\n3\\. 50% of the applications were US applications.\n4\\. All applicants except Ira, Vijay and Nandini arrived on time.\n5\\. Vijay was called to a counter at 9:25 am."
    },
    {
      "client_set_id": "DILR_SET_2",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 2,
      "context_type": "dilr_set",
      "context_title": "Housing Complex",
      "content_layout": "split_table",
      "context_image_url": null,
      "context_body": "The schematic diagram (not shown) describes 12 rectangular houses in a housing complex. House numbers are mentioned in the rectangles representing the houses. The houses are located in six columns \\- Column-A through Column-F, and two rows \\- Row-1 and Row-2. The houses are divided into two blocks \\- Block XX and Block YY.\nBlock XX: Row-1 (A1, B1, C1), Row-2 (A2, B2, C2)\nBlock YY: Row-1 (D1, E1, F1), Row-2 (D2, E2, F2)\nSome of the houses are occupied. The remaining ones are vacant and are the only ones available for sale.\nDefinitions:\n\\- Road Adjacency Value: The number of its sides adjacent to a road. (e.g., C2=2, F2=1, B1=0).\n\\- Neighbour Count: The number of sides of that house adjacent to occupied houses in the same block.\n\\- Pricing: Base price of a vacant house is Rs. 10 lakhs (no parking) or Rs. 12 lakhs (with parking).\n\\- Quoted Price: (base price) \\+ 5 \\* (road adjacency value) \\+ 3 \\* (neighbour count).\nAdditional Info:\n1\\. The maximum quoted price of a house in Block XX is Rs. 24 lakhs.\n2\\. The minimum quoted price of a house in block YY is Rs. 15 lakhs, and one such house is in Column-E.\n3\\. Row-1 has two occupied houses, one in each block.\n4\\. Both houses in Column-E are vacant. Each of Column-D and Column-F has at least one occupied house.\n5\\. There is only one house with parking space in Block YY."
    },
    {
      "client_set_id": "DILR_SET_3",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 3,
      "context_type": "dilr_set",
      "context_title": "Restaurant Ratings",
      "content_layout": "split_table",
      "context_image_url": null,
      "context_body": "Five restaurants, coded R1, R2, R3, R4 and R5 gave integer ratings to five gig workers \\- Ullas, Vasu, Waman, Xavier and Yusuf, on a scale of 1 to 5\\. The means of the ratings given by R1, R2, R3, R4 and R5 were 3.4, 2.2, 3.8, 2.8 and 3.4 respectively.\nAdditional Info:\n(a) R1 awarded a rating of 5 to Waman, as did R2 to Xavier, R3 to Waman and Xavier, and R5 to Vasu.\n(b) R1 awarded a rating of 1 to Ullas, as did R2 to Waman and Yusuf, and R3 to Yusuf."
    },
    {
      "client_set_id": "DILR_SET_4",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 4,
      "context_type": "dilr_set",
      "context_title": "Faculty Election",
      "content_layout": "split_table",
      "context_image_url": null,
      "context_body": "Faculty members belong to four departments: Finance and Accounting (F\\&A \\- 9 members), Marketing and Strategy (M\\&S \\- 7 members), Operations and Quants (O\\&Q \\- 5 members), and Behaviour and Human Resources (B\\&H \\- 3 members).\nCandidates for Dean: Prof. Pakrasi, Prof. Qureshi, Prof. Ramaswamy, and Prof. Samuel.\nRules & Results:\n\\- Only one candidate was from O\\&Q.\n\\- Every faculty member voted.\n\\- In each department, all non-candidates voted for the same candidate.\n\\- Max 2 candidates per department.\n\\- Candidates cannot vote for themselves.\n\\- Faculty cannot vote for a candidate from their own department.\nResults:\n\\- Pakrasi: 3 votes\n\\- Qureshi: 14 votes\n\\- Ramaswamy: 6 votes\n\\- Samuel: 1 vote\nCandidate Votes:\n\\- Pakrasi \\-\\> Ramaswamy\n\\- Qureshi \\-\\> Samuel\n\\- Ramaswamy \\-\\> Qureshi\n\\- Samuel \\-\\> Pakrasi"
    },
    {
      "client_set_id": "QA_ATOMIC_45",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 1,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_46",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 2,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_47",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 3,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_48",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 4,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_49",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 5,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_50",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 6,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_51",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 7,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_52",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 8,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_53",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 9,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_54",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 10,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_55",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 11,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_56",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 12,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_57",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 13,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_58",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 14,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_59",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 15,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_60",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 16,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_61",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 17,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_62",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 18,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_63",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 19,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_64",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 20,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_65",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 21,
      "context_image_url": null
    },
    {
      "client_set_id": "QA_ATOMIC_66",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 22,
      "context_image_url": null
    }
  ],
  "questions": [
    {
      "client_question_id": "cat-2023-slot-1_Q1",
      "set_ref": "VARC_RC_1",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 1,
      "question_type": "MCQ",
      "taxonomy_type": "rc_factual",
      "topic": "Reading Comprehension",
      "subtopic": "Literature & Culture",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following statements is not true about migration in the Indian Ocean world?",
      "options": [
        {
          "id": "A",
          "text": "The Indian Ocean world's migration networks connected the global north with the global south."
        },
        {
          "id": "B",
          "text": "Geographical location rather than geographical proximity determined the choice of destination for migrants."
        },
        {
          "id": "C",
          "text": "The Indian Ocean world's migration networks were shaped by religious and commercial histories of the region."
        },
        {
          "id": "D",
          "text": "Migration in the Indian Ocean world was an ambivalent experience."
        }
      ],
      "solution_text": "The passage discusses south-south interconnection and contrasts it with the global north (Europe/US). Option A claims connection between global north and south which contradicts the \"south-south\" focus mentioned."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q2",
      "set_ref": "VARC_RC_1",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 2,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Literature & Culture",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "On the basis of the nature of the relationship between the items in each pair below, choose the odd pair out:",
      "options": [
        {
          "id": "A",
          "text": "Indian Ocean novels: Outward-looking"
        },
        {
          "id": "B",
          "text": "Postcolonial novels: Border-crossing"
        },
        {
          "id": "C",
          "text": "Indian Ocean world: Slavery"
        },
        {
          "id": "D",
          "text": "Postcolonial novels: Anti-colonial nationalism"
        }
      ],
      "solution_text": "Postcolonial novels are described as \"inward-looking\" and concerned with the nation, whereas Indian Ocean novels are \"border-crossing\". Thus, pairing Postcolonial novels with Border-crossing is the odd one out (contradictory to passage description)."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q3",
      "set_ref": "VARC_RC_1",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 3,
      "question_type": "MCQ",
      "taxonomy_type": "rc_weakening",
      "topic": "Reading Comprehension",
      "subtopic": "Literature & Culture",
      "difficulty": "hard",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "All of the following statements, if true, would weaken the passage's claim about the relationship between mainstream English-language fiction and Indian Ocean novels EXCEPT:",
      "options": [
        {
          "id": "A",
          "text": "the depiction of Africa in most Indian Ocean novels is driven by a postcolonial nostalgia for an idyllic past."
        },
        {
          "id": "B",
          "text": "the depiction of Africa in most Indian Ocean novels is driven by an Orientalist imagination of its cultural crudeness."
        },
        {
          "id": "C",
          "text": "very few mainstream English-language novels have historically been set in American and European metropolitan centres."
        },
        {
          "id": "D",
          "text": "most mainstream English-language novels have historically privileged the Christian, white, male experience of travel and adventure."
        }
      ],
      "solution_text": "Option D supports the passage's claim about mainstream fiction, so it does not weaken it. The others would contradict the distinctions drawn in the passage."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q4",
      "set_ref": "VARC_RC_1",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 4,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Literature & Culture",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "All of the following claims contribute to the \"remapping\" discussed by the passage, EXCEPT:",
      "options": [
        {
          "id": "A",
          "text": "Indian Ocean novels have gone beyond the specifics of national concerns to explore rich regional pasts."
        },
        {
          "id": "B",
          "text": "the world of early international trade and commerce was not the sole domain of white Europeans."
        },
        {
          "id": "C",
          "text": "cosmopolitanism originated in the West and travelled to the East through globalisation."
        },
        {
          "id": "D",
          "text": "the global south, as opposed to the global north, was the first centre of globalisation."
        }
      ],
      "solution_text": "The passage suggests globalization and cosmopolitanism existed in the Indian Ocean (global south) first or independently (\"southern cosmopolitan culture\"). Option C claims it originated in the West, which contradicts the \"remapping\" discussed."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q5",
      "set_ref": "VARC_RC_2",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 5,
      "question_type": "MCQ",
      "taxonomy_type": "rc_factual",
      "topic": "Reading Comprehension",
      "subtopic": "Sociology",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "All of the following are advanced by the author as reasons why non-geographers disregard geographic influences on human phenomena EXCEPT their:",
      "options": [
        {
          "id": "A",
          "text": "lingering impressions of past geographic analyses that were politically offensive."
        },
        {
          "id": "B",
          "text": "belief in the central role of humans, unrelated to physical surroundings, in influencing phenomena."
        },
        {
          "id": "C",
          "text": "disciplinary training which typically does not include technical knowledge of geography."
        },
        {
          "id": "D",
          "text": "dismissal of explanations that involve geographical causes for human behaviour."
        }
      ],
      "solution_text": "Options A, B, and C are reasons given (racist associations, focus on human contingency/agency, lack of technical training). Option D is a circular statement describing the disregard itself, not a reason for it."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q6",
      "set_ref": "VARC_RC_2",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 6,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Sociology",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The author criticises scholars who are not geographers for all of the following reasons EXCEPT:",
      "options": [
        {
          "id": "A",
          "text": "their rejection of the role of biogeographic factors in social and cultural phenomena."
        },
        {
          "id": "B",
          "text": "their outdated interpretations of past cultural and historical phenomena."
        },
        {
          "id": "C",
          "text": "the importance they place on the role of individual decisions when studying human phenomena."
        },
        {
          "id": "D",
          "text": "their labelling of geographic explanations as deterministic."
        }
      ],
      "solution_text": "The author criticizes them for rejecting geography (A), over-stressing individual decisions (C), and using the label \"deterministic\" (D). There is no mention of them having \"outdated interpretations\" of culture/history itself (B)."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q7",
      "set_ref": "VARC_RC_2",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 7,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Sociology",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "All of the following can be inferred from the passage EXCEPT:",
      "options": [
        {
          "id": "A",
          "text": "individual dictate and contingency were not the causal factors for the use of fur clothing in some very cold climates."
        },
        {
          "id": "B",
          "text": "agricultural practices changed drastically in the Australian continent after it was colonised."
        },
        {
          "id": "C",
          "text": "while most human phenomena result from culture and individual choice, some have bio-geographic origins."
        },
        {
          "id": "D",
          "text": "several academic studies of human phenomena in the past involved racist interpretations."
        }
      ],
      "solution_text": "The passage states \"Many human phenomena... are influenced both by geographic factors and by non-geographic factors.\" It does not assert that \"most\" result from culture/choice while only \"some\" have bio-geographic origins; it argues against ignoring the geographic ones."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q8",
      "set_ref": "VARC_RC_2",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 8,
      "question_type": "MCQ",
      "taxonomy_type": "rc_purpose",
      "topic": "Reading Comprehension",
      "subtopic": "Sociology",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The examples of the Inuit and Aboriginal Australians are offered in the passage to show:",
      "options": [
        {
          "id": "A",
          "text": "human resourcefulness across cultures in adapting to their surroundings."
        },
        {
          "id": "B",
          "text": "how physical circumstances can dictate human behaviour and cultures."
        },
        {
          "id": "C",
          "text": "that despite geographical isolation, traditional societies were self-sufficient and adaptive."
        },
        {
          "id": "D",
          "text": "how environmental factors lead to comparatively divergent paths in livelihoods and development."
        }
      ],
      "solution_text": "The examples illustrate cases where geography (cold, lack of domesticable species) determined the outcome (fur, hunter-gatherer status), supporting the role of physical circumstances."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q9",
      "set_ref": "VARC_RC_3",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 9,
      "question_type": "MCQ",
      "taxonomy_type": "rc_factual",
      "topic": "Reading Comprehension",
      "subtopic": "Ecology",
      "difficulty": "easy",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following has NOT contributed to the growing wolf population in Lozère?",
      "options": [
        {
          "id": "A",
          "text": "A decline in the rural population of Lozère."
        },
        {
          "id": "B",
          "text": "An increase in woodlands and forest cover in Lozère."
        },
        {
          "id": "C",
          "text": "The shutting down of the royal office of the Luparii."
        },
        {
          "id": "D",
          "text": "The granting of a protected status to wolves in Europe."
        }
      ],
      "solution_text": "The Luparii shut down in the 1930s when wolves were eradicated. Their shutdown didn't cause the \\*recent\\* growth; factors like depopulation, forest increase, and protected status did."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q10",
      "set_ref": "VARC_RC_3",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 10,
      "question_type": "MCQ",
      "taxonomy_type": "rc_factual",
      "topic": "Reading Comprehension",
      "subtopic": "Ecology",
      "difficulty": "easy",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The inhabitants of Lozère have to grapple with all of the following problems, EXCEPT:",
      "options": [
        {
          "id": "A",
          "text": "lack of educational facilities."
        },
        {
          "id": "B",
          "text": "poor rural communication infrastructure."
        },
        {
          "id": "C",
          "text": "livestock losses."
        },
        {
          "id": "D",
          "text": "decline in the number of hunting licences."
        }
      ],
      "solution_text": "The decline in hunting licenses is mentioned as a factor helping wolves, but not explicitly as a \"problem\" inhabitants grapple with (unlike schools, phone/internet, and livestock)."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q11",
      "set_ref": "VARC_RC_3",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 11,
      "question_type": "MCQ",
      "taxonomy_type": "rc_weakening",
      "topic": "Reading Comprehension",
      "subtopic": "Ecology",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following statements, if true, would weaken the author's claims?",
      "options": [
        {
          "id": "A",
          "text": "Having migrated out in the last century, wolves are now returning to Lozère."
        },
        {
          "id": "B",
          "text": "Unemployment concerns the residents of Lozère."
        },
        {
          "id": "C",
          "text": "Wolf attacks on tourists in Lozère are on the rise."
        },
        {
          "id": "D",
          "text": "The old mining sites of Lozère are now being used as grazing pastures for sheep."
        }
      ],
      "solution_text": "The author claims tourists enjoy wolf parks and they generate income/jobs (a positive economic story). If wolf attacks on tourists were rising (C), this positive aspect would be weakened."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q12",
      "set_ref": "VARC_RC_3",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 12,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Ecology",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The author presents a possible economic solution to an existing issue facing Lozère that takes into account the divergent and competing interests of:",
      "options": [
        {
          "id": "A",
          "text": "politicians and farmers."
        },
        {
          "id": "B",
          "text": "environmentalists and politicians."
        },
        {
          "id": "C",
          "text": "farmers and environmentalists."
        },
        {
          "id": "D",
          "text": "tourists and environmentalists."
        }
      ],
      "solution_text": "The issue is the clash between farmers (livestock loss) and environmentalists (celebrating wolves). The economic solution mentioned is tourism (wolf parks), attempting to balance or address the conflict by providing alternative income."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q13",
      "set_ref": "VARC_RC_4",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 13,
      "question_type": "MCQ",
      "taxonomy_type": "rc_main_idea",
      "topic": "Reading Comprehension",
      "subtopic": "Anthropology",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "We can infer that Sahlins's main goal in writing his essay was to:",
      "options": [
        {
          "id": "A",
          "text": "put forth the view that, despite egalitarian origins, economic progress brings greater inequality and social hierarchies."
        },
        {
          "id": "B",
          "text": "highlight the fact that while we started off as a fairly contented egalitarian people, we have progressively degenerated into materialism."
        },
        {
          "id": "C",
          "text": "hold a mirror to an acquisitive society, with examples of other communities that have chosen successfully to be non-materialistic."
        },
        {
          "id": "D",
          "text": "counter Galbraith's pessimistic view of the inevitability of a capitalist trajectory for economic growth."
        }
      ],
      "solution_text": "The passage states the essay's point was a \"conceptual challenge to contemporary economic life\" and to show that \"radical alternatives... really exist.\""
    },
    {
      "client_question_id": "cat-2023-slot-1_Q14",
      "set_ref": "VARC_RC_4",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 14,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Anthropology",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The author mentions Tanzania's Hadza community to illustrate:",
      "options": [
        {
          "id": "A",
          "text": "that hunter-gatherer communities' subsistence-level techniques equipped them to survive well into contemporary times."
        },
        {
          "id": "B",
          "text": "how pre-agrarian societies did not hamper the emergence of more advanced agrarian practices in contiguous communities."
        },
        {
          "id": "C",
          "text": "that forager communities' lifestyles derived not from ignorance about alternatives, but from their own choice."
        },
        {
          "id": "D",
          "text": "how two vastly different ways of living and working were able to coexist in proximity for centuries."
        }
      ],
      "solution_text": "The passage says the Hadza \"knew they had alternatives and rejected them... they demonstrated that societies make real choices.\""
    },
    {
      "client_question_id": "cat-2023-slot-1_Q15",
      "set_ref": "VARC_RC_4",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 15,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Anthropology",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The author of the passage mentions Galbraith's \"The Affluent Society\" to:",
      "options": [
        {
          "id": "A",
          "text": "show how Galbraith's theories refute Sahlins's thesis on the contentment of pre-hunter-gatherer communities."
        },
        {
          "id": "B",
          "text": "contrast the materialist nature of contemporary growth paths with the pacifist content ways of living among the foragers."
        },
        {
          "id": "C",
          "text": "document the influence of Galbraith's cynical views on modern consumerism on Sahlins's analysis of pre-historic societies."
        },
        {
          "id": "D",
          "text": "show how Sahlins's views complemented Galbraith's criticism of the consumerism and inequality of contemporary society."
        }
      ],
      "solution_text": "The title was a \"nod toward\" Galbraith's work, bringing its critical perspective on prosperity/inequality to bear, effectively complementing the criticism of consumerism."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q16",
      "set_ref": "VARC_RC_4",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 16,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Anthropology",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The author of the passage criticises Sahlins's essay for its:",
      "options": [
        {
          "id": "A",
          "text": "cursory treatment of the effects of racism and colonialism on societies."
        },
        {
          "id": "B",
          "text": "outdated values regarding present-day foragers versus ancient foraging communities."
        },
        {
          "id": "C",
          "text": "critique of anthropologists who disparage the choices of foragers in today's society."
        },
        {
          "id": "D",
          "text": "failure to supplement its thesis with robust empirical data."
        }
      ],
      "solution_text": "The passage states: \"While acknowledging the violence of colonialism, racism, and dispossession, it does not thematize them as heavily as we might today.\""
    },
    {
      "client_question_id": "cat-2023-slot-1_Q17",
      "set_ref": "VARC_VA_17",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 17,
      "question_type": "MCQ",
      "taxonomy_type": "va_placement",
      "topic": "Verbal Ability",
      "subtopic": "Paragraph Completion",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Look at the paragraph and decide where (option 1, 2, 3, or 4\\) the following sentence would best fit.\nSentence: The discovery helps to explain archeological similarities between the Paleolithic peoples of China, Japan, and the Americas.\nParagraph: The researchers also uncovered an unexpected genetic link between Native Americans and Japanese people.\n_ (1) _ During the deglaciation period, another group branched out from northern coastal China and travelled to Japan.\n_ (2) _ . \"We were surprised to find that this ancestral source also contributed to the Japanese gene pool, especially the indigenous Ainus,\" says Li.\n_ (3) _ . They shared similarities in how they crafted stemmed projectile points for arrowheads and spears.\n_ (4) _ . \"This suggests that the Pleistocene connection among the Americas, China, and Japan was not confined to culture but also to genetics,\" says senior author Qing-Peng Kong, an evolutionary geneticist at the Chinese Academy of Sciences.",
      "options": [
        {
          "id": "A",
          "text": "Option 2"
        },
        {
          "id": "B",
          "text": "Option 3"
        },
        {
          "id": "C",
          "text": "Option 1"
        },
        {
          "id": "D",
          "text": "Option 4"
        }
      ],
      "solution_text": "The sentence mentions \"archeological similarities\". The sentence following (3) describes specific similarities (\"crafted stemmed projectile points\"). Thus, the sentence fits best at (3), introducing the similarities detailed next."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q18",
      "set_ref": "VARC_VA_18",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 18,
      "question_type": "MCQ",
      "taxonomy_type": "va_placement",
      "topic": "Verbal Ability",
      "subtopic": "Paragraph Completion",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Look at the paragraph and decide where (option 1, 2, 3, or 4\\) the following sentence would best fit.\nSentence: This philosophical cut at one's core beliefs, values, and way of life is difficult enough.\nParagraph: The experience of reading philosophy is often disquieting.\nWhen reading philosophy, the values around which one has heretofore organised one's life may come to look provincial, flatly wrong, or even evil.\n_ (1) _ When beliefs previously held as truths are rendered implausible, new beliefs, values, and ways of living may be required.\n_ (2) _ What's worse, philosophers admonish each other to remain unsutured until such time as a defensible new answer is revealed or constructed.\nSometimes, philosophical writing is even strictly critical in that it does not even attempt to provide an alternative after tearing down a cultural or conceptual citadel.\n_ (3) _ The reader of philosophy must be prepared for the possibility of this experience.\nWhile reading philosophy can help one clarify one's values, and even make one self-conscious for the first time of the fact that there are good reasons for believing what one believes, it can also generate unremediated doubt that is difficult to live with.\n_ (4) _",
      "options": [
        {
          "id": "A",
          "text": "Option 1"
        },
        {
          "id": "B",
          "text": "Option 4"
        },
        {
          "id": "C",
          "text": "Option 3"
        },
        {
          "id": "D",
          "text": "Option 2"
        }
      ],
      "solution_text": "The sentence mentions \"This philosophical cut... is difficult enough.\" The sentence following (2) starts with \"What's worse...\", suggesting an escalation from the \"difficult enough\" situation mentioned in the inserted sentence."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q19",
      "set_ref": "VARC_VA_19",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 19,
      "question_type": "TITA",
      "taxonomy_type": "va_odd_one",
      "topic": "Verbal Ability",
      "subtopic": "Para Jumbles",
      "difficulty": "medium",
      "correct_answer": "2",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Five jumbled up sentences (labelled 1, 2, 3, 4 and 5), related to a topic, are given below. Four of them can be put together to form a coherent paragraph. Identify the odd sentence and key in the number of that sentence as your answer.\n1\\. Having an appreciation for the workings of another person's mind is considered a prerequisite for natural language acquisition, strategic social interaction, reflexive thought, and moral judgment.\n2\\. It is a 'theory of mind' though some scholars prefer to call it 'mentalizing' or 'mindreading', which is important for the development of one's cognitive abilities.\n3\\. Though we must speculate about its evolutionary origin, we do have indications that the capacity evolved sometime in the last few million years.\n4\\. This capacity develops from early beginnings in the first year of life to the adult's fast and often effortless understanding of others' thoughts, feelings, and intentions.\n5\\. One of the most fascinating human capacities is the ability to perceive and interpret other people's behaviour in terms of their mental states.",
      "solution_text": "Sentences 1, 3, 4, and 5 discuss the capacity to understand other minds (Theory of Mind), its importance, origin, and development. Sentence 2 defines the term but its structure (\"It is a 'theory of mind'...\") feels disconnected or repetitive in a specific way that doesn't fit the flow of 5-1-4-3 (Introduction of capacity \\-> Importance \\-> Development \\-> Evolution). Sentence 2 is often the odd one in such sets if it redundantly defines what is already being discussed descriptively. (Official answer is 2)."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q20",
      "set_ref": "VARC_VA_20",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 20,
      "question_type": "TITA",
      "taxonomy_type": "va_odd_one",
      "topic": "Verbal Ability",
      "subtopic": "Para Jumbles",
      "difficulty": "medium",
      "correct_answer": "3",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Five jumbled up sentences (labelled 1, 2, 3, 4 and 5), related to a topic, are given below. Four of them can be put together to form a coherent paragraph. Identify the odd sentence and key in the number of that sentence as your answer.\n1\\. In English, there is no systematic rule for the naming of numbers;\n2\\. after ten, we have \"eleven\" and \"twelve\" and then the teens: \"thirteen\", \"fourteen\", \"fifteen\" and so on.\n3\\. Even more confusingly, some English words invert the numbers they refer to: the word \"fourteen\" puts the four first, even though it appears last.\n4\\. It can take children a while to learn all these words, and understand that \"fourteen\" is different from \"forty\".\n5\\. For multiples of 10, English speakers switch to a different pattern: \"twenty\", \"thirty\", \"forty\" and so on.\n6\\. If you didn't know the word for \"eleven\", you would be unable to just guess it \\- you might come up with something like \"one-teen\".",
      "solution_text": "Note: Source contained 5 sentences. The logic connects 1, 2, 5, 6 regarding the lack of rules/patterns. Sentence 3 is about inversion (\"fourteen\") which is a specific detail about one number type, while the others discuss the broader system inconsistencies (10s, 11/12, multiples). The official key is 3\\."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q21",
      "set_ref": "VARC_VA_21",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 21,
      "question_type": "TITA",
      "taxonomy_type": "va_jumble",
      "topic": "Verbal Ability",
      "subtopic": "Para Jumbles",
      "difficulty": "medium",
      "correct_answer": "4123",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The four sentences (labelled 1, 2, 3 and 4\\) given below, when properly sequenced, would yield a coherent paragraph. Decide on the proper sequencing of the order of the sentences and key in the sequence of the four numbers as your answer.\n1\\. What precisely are the \"unusual elements\" that make a particular case so attractive to a certain kind of audience?\n2\\. It might be a particularly savage or unfathomable level of depravity, very often it has something to do with the precise amount of mystery involved.\n3\\. Unsolved, and perhaps unsolvable cases offer something that \"ordinary\" murder doesn't.\n4\\. Why are some crimes destined for perpetual re-examination and others locked into permanent obscurity?",
      "solution_text": "4 poses the main question (Why some crimes?). 1 follows up asking what makes them attractive. 2 answers \"It might be...\". 3 concludes or expands on the mystery aspect. Sequence: 4-1-2-3."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q22",
      "set_ref": "VARC_VA_22",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 22,
      "question_type": "TITA",
      "taxonomy_type": "va_jumble",
      "topic": "Verbal Ability",
      "subtopic": "Para Jumbles",
      "difficulty": "medium",
      "correct_answer": "4123",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The four sentences (labelled 1, 2, 3 and 4\\) given below, when properly sequenced, would yield a coherent paragraph. Decide on the proper sequencing of the order of the sentences and key in the sequence of the four numbers as your answer.\n1\\. Algorithms hosted on the internet are accessed by many, so biases in AI models have resulted in much larger impact, adversely affecting far larger groups of people.\n2\\. Though \"algorithmic bias\" is the popular term, the foundation of such bias is not in algorithms, but in the data;\n3\\. algorithms are not biased, data is, as algorithms merely reflect persistent patterns that are present in the training data.\n4\\. The impact of biased decisions made by humans is localised and geographically confined, but with the advent of AI, the impact of such decisions is spread over a much wider scale.",
      "solution_text": "4 introduces the scale of impact (human vs AI). 1 expands on this \"larger impact\" due to internet hosting. 2 and 3 discuss the nature of the bias itself (data vs algo), usually coming after the context of impact is set, or 2-3 is a pair explaining the \"bias\" mentioned in 1\\. However, 4-1-2-3 is the official key."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q23",
      "set_ref": "VARC_VA_23",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 23,
      "question_type": "MCQ",
      "taxonomy_type": "va_summary",
      "topic": "Verbal Ability",
      "subtopic": "Paragraph Summary",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The passage given below is followed by four alternate summaries. Choose the option that best captures the essence of the passage.\nManipulating information was a feature of history long before modern journalism established rules of integrity. A record dates back to ancient Rome, when Antony met Cleopatra and his political enemy Octavian launched a smear campaign against him with \"short, sharp slogans written upon coins.\" The perpetrator became the first Roman Emperor and \"fake news had allowed Octavian to hack the republican system once and for all\". But the 21st century has seen the weaponization of information on an unprecedented scale. Powerful new technology makes the fabrication of content simple, and social networks amplify falsehoods peddled by States, populist politicians, and dishonest corporate entities. The platforms have become fertile ground for computational propaganda, 'trolling' and 'troll armies'.",
      "options": [
        {
          "id": "A",
          "text": "Disinformation, which is mediated by technology today, is not new and has existed since ancient times."
        },
        {
          "id": "B",
          "text": "People need to become critical of what they read, since historically, weaponization of information has led to corruption."
        },
        {
          "id": "C",
          "text": "Use of misinformation for attaining power, a practice that is as old as the Octavian era, is currently fueled by technology."
        },
        {
          "id": "D",
          "text": "Octavian used fake news to manipulate people and attain power and influence, just as people do today."
        }
      ],
      "solution_text": "The passage connects ancient manipulation (Octavian) with modern weaponization fueled by technology. Option C captures both the historical precedent and the modern fueling by technology."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q24",
      "set_ref": "VARC_VA_24",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 24,
      "question_type": "MCQ",
      "taxonomy_type": "va_summary",
      "topic": "Verbal Ability",
      "subtopic": "Paragraph Summary",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The passage given below is followed by four alternate summaries. Choose the option that best captures the essence of the passage.\nColonialism is not a modern phenomenon. World history is full of examples of one society gradually expanding by incorporating adjacent territory and settling its people on newly conquered territory. In the sixteenth century, colonialism changed decisively because of technological developments in navigation that began to connect more remote parts of the world. The modern European colonial project emerged when it became possible to move large numbers of people across the ocean and to maintain political control in spite of geographical dispersion. The term colonialism is used to describe the process of European settlement, violent dispossession and political domination over the rest of the world, including the Americas, Australia, and parts of Africa and Asia.",
      "options": [
        {
          "id": "A",
          "text": "As a result of developments in navigation technology, European colonialism led to the displacement of indigenous populations and global political changes in the 16th century."
        },
        {
          "id": "B",
          "text": "Colonialism, conceptualized in the 16th century, allowed colonizers to expand their territories, establish settlements, and exercise political power."
        },
        {
          "id": "C",
          "text": "Technological advancements in navigation in the 16th century, transformed colonialism, enabling Europeans to establish settlements and exert political dominance over distant regions."
        },
        {
          "id": "D",
          "text": "Colonialism surged in the 16th century due to advancements in navigation, enabling British settlements abroad and global dominance."
        }
      ],
      "solution_text": "The passage highlights how navigation technology \\*transformed\\* colonialism (which wasn't new) into the modern European project of distant settlement/dominance. Option C captures this transformation and the specific role of technology and European dominance."
    },
    {
      "client_question_id": "cat-2023-slot-1_Q25",
      "set_ref": "DILR_SET_1",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 25,
      "question_type": "TITA",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Scheduling",
      "difficulty": "medium",
      "correct_answer": "0",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many UK applications were scheduled on that day?",
      "solution_text": "\\[cite_start\\]The calculations based on the slot distribution and counter constraints reveal that 0 UK applications were scheduled. \\[cite: 323\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q26",
      "set_ref": "DILR_SET_1",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 26,
      "question_type": "TITA",
      "taxonomy_type": "di_calculation",
      "topic": "Data Interpretation",
      "subtopic": "Scheduling",
      "difficulty": "hard",
      "correct_answer": "200",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "What is the maximum possible value of the total time (in minutes, nearest to its integer value) required to process all applications in the Others category on that day?",
      "solution_text": "\\[cite_start\\]Based on the optimization of processing times within the given slots, the maximum total time is 200 minutes. \\[cite: 325\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q27",
      "set_ref": "DILR_SET_1",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 27,
      "question_type": "MCQ",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Scheduling",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following is the closest to the time when Nandini's application process got over?",
      "options": [
        {
          "id": "A",
          "text": "9:50 am"
        },
        {
          "id": "B",
          "text": "9:37 am"
        },
        {
          "id": "C",
          "text": "9:35 am"
        },
        {
          "id": "D",
          "text": "9:45 am"
        }
      ],
      "solution_text": "\\[cite_start\\]Nandini's application process finished closest to 9:45 am. \\[cite: 331\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q28",
      "set_ref": "DILR_SET_1",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 28,
      "question_type": "MCQ",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Scheduling",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following statements is false?",
      "options": [
        {
          "id": "A",
          "text": "The application process of Osman was completed before 9:45 am."
        },
        {
          "id": "B",
          "text": "The application process of Mahira started after Nandini's."
        },
        {
          "id": "C",
          "text": "The application process of Osman was completed before Vijay's."
        },
        {
          "id": "D",
          "text": "The application process of Mahira was completed before Nandini's."
        }
      ],
      "solution_text": "\\[cite_start\\]Statement B is false. \\[cite: 337\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q29",
      "set_ref": "DILR_SET_1",
      "sequence_order": 5,
      "section": "DILR",
      "question_number": 29,
      "question_type": "MCQ",
      "taxonomy_type": "di_calculation",
      "topic": "Data Interpretation",
      "subtopic": "Scheduling",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "When did the application processing for all US applicants get over on that day?",
      "options": [
        {
          "id": "A",
          "text": "2:05 pm"
        },
        {
          "id": "B",
          "text": "2:25 pm"
        },
        {
          "id": "C",
          "text": "2:00 pm"
        },
        {
          "id": "D",
          "text": "3:40 pm"
        }
      ],
      "solution_text": "\\[cite_start\\]The processing for all US applicants ended at 2:05 pm. \\[cite: 343\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q30",
      "set_ref": "DILR_SET_2",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 30,
      "question_type": "TITA",
      "taxonomy_type": "lr_constraint",
      "topic": "Logical Reasoning",
      "subtopic": "Spatial Reasoning",
      "difficulty": "medium",
      "correct_answer": "3",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many houses are vacant in Block XX?",
      "solution_text": "\\[cite_start\\]Logic deduction determines 3 houses are vacant in Block XX. \\[cite: 371\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q31",
      "set_ref": "DILR_SET_2",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 31,
      "question_type": "MCQ",
      "taxonomy_type": "lr_constraint",
      "topic": "Logical Reasoning",
      "subtopic": "Spatial Reasoning",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following houses is definitely occupied?",
      "options": [
        {
          "id": "A",
          "text": "A1"
        },
        {
          "id": "B",
          "text": "D2"
        },
        {
          "id": "C",
          "text": "B1"
        },
        {
          "id": "D",
          "text": "F2"
        }
      ],
      "solution_text": "\\[cite_start\\]House B1 is definitely occupied. \\[cite: 377\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q32",
      "set_ref": "DILR_SET_2",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 32,
      "question_type": "MCQ",
      "taxonomy_type": "lr_constraint",
      "topic": "Logical Reasoning",
      "subtopic": "Spatial Reasoning",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following options best describes the number of vacant houses in Row-2?",
      "options": [
        {
          "id": "A",
          "text": "Exactly 3"
        },
        {
          "id": "B",
          "text": "Either 3 or 4"
        },
        {
          "id": "C",
          "text": "Exactly 2"
        },
        {
          "id": "D",
          "text": "Either 2 or 3"
        }
      ],
      "solution_text": "\\[cite_start\\]The number of vacant houses in Row-2 is either 2 or 3\\. \\[cite: 383\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q33",
      "set_ref": "DILR_SET_2",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 33,
      "question_type": "TITA",
      "taxonomy_type": "lr_calculation",
      "topic": "Logical Reasoning",
      "subtopic": "Spatial Reasoning",
      "difficulty": "hard",
      "correct_answer": "21",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "What is the maximum possible quoted price (in lakhs of Rs.) for a vacant house in Column-E?",
      "solution_text": "\\[cite_start\\]The maximum quoted price is 21 lakhs. \\[cite: 385\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q34",
      "set_ref": "DILR_SET_2",
      "sequence_order": 5,
      "section": "DILR",
      "question_number": 34,
      "question_type": "MCQ",
      "taxonomy_type": "lr_constraint",
      "topic": "Logical Reasoning",
      "subtopic": "Spatial Reasoning",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which house in Block YY has parking space?",
      "options": [
        {
          "id": "A",
          "text": "E1"
        },
        {
          "id": "B",
          "text": "F2"
        },
        {
          "id": "C",
          "text": "E2"
        },
        {
          "id": "D",
          "text": "F1"
        }
      ],
      "solution_text": "\\[cite_start\\]House E1 has the parking space. \\[cite: 391\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q35",
      "set_ref": "DILR_SET_3",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 35,
      "question_type": "TITA",
      "taxonomy_type": "lr_puzzle",
      "topic": "Logical Reasoning",
      "subtopic": "Statistics",
      "difficulty": "medium",
      "correct_answer": "0",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many individual ratings cannot be determined from the above information?",
      "solution_text": "\\[cite_start\\]All ratings can be determined, so 0\\. \\[cite: 403\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q36",
      "set_ref": "DILR_SET_3",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 36,
      "question_type": "TITA",
      "taxonomy_type": "lr_puzzle",
      "topic": "Logical Reasoning",
      "subtopic": "Statistics",
      "difficulty": "medium",
      "correct_answer": "0",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "To how many workers did R2 give a rating of 4?",
      "solution_text": "\\[cite_start\\]R2 gave a rating of 4 to 0 workers. \\[cite: 405\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q37",
      "set_ref": "DILR_SET_3",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 37,
      "question_type": "TITA",
      "taxonomy_type": "lr_puzzle",
      "topic": "Logical Reasoning",
      "subtopic": "Statistics",
      "difficulty": "medium",
      "correct_answer": "3",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "What rating did R1 give to Xavier?",
      "solution_text": "\\[cite_start\\]R1 gave Xavier a rating of 3\\. \\[cite: 407\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q38",
      "set_ref": "DILR_SET_3",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 38,
      "question_type": "TITA",
      "taxonomy_type": "lr_puzzle",
      "topic": "Logical Reasoning",
      "subtopic": "Statistics",
      "difficulty": "medium",
      "correct_answer": "4",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "What is the median of the ratings given by R3 to the five workers?",
      "solution_text": "\\[cite_start\\]The median rating given by R3 is 4\\. \\[cite: 409\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q39",
      "set_ref": "DILR_SET_3",
      "sequence_order": 5,
      "section": "DILR",
      "question_number": 39,
      "question_type": "MCQ",
      "taxonomy_type": "lr_puzzle",
      "topic": "Logical Reasoning",
      "subtopic": "Statistics",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which among the following restaurants gave its median rating to exactly one of the workers?",
      "options": [
        {
          "id": "A",
          "text": "R2"
        },
        {
          "id": "B",
          "text": "R5"
        },
        {
          "id": "C",
          "text": "R4"
        },
        {
          "id": "D",
          "text": "R3"
        }
      ],
      "solution_text": "\\[cite_start\\]Restaurant R4 gave its median rating to exactly one worker. \\[cite: 415\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q40",
      "set_ref": "DILR_SET_4",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 40,
      "question_type": "MCQ",
      "taxonomy_type": "lr_logic",
      "topic": "Logical Reasoning",
      "subtopic": "Set Theory",
      "difficulty": "hard",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which two candidates can belong to the same department?",
      "options": [
        {
          "id": "A",
          "text": "Prof. Pakrasi and Prof. Qureshi"
        },
        {
          "id": "B",
          "text": "Prof. Pakrasi and Prof. Samuel"
        },
        {
          "id": "C",
          "text": "Prof. Qureshi and Prof. Ramaswamy"
        },
        {
          "id": "D",
          "text": "Prof. Ramaswamy and Prof. Samuel"
        }
      ],
      "solution_text": "\\[cite_start\\]Pakrasi and Qureshi can belong to the same department. \\[cite: 442\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q41",
      "set_ref": "DILR_SET_4",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 41,
      "question_type": "MCQ",
      "taxonomy_type": "lr_logic",
      "topic": "Logical Reasoning",
      "subtopic": "Set Theory",
      "difficulty": "hard",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following can be the number of votes that Prof. Qureshi received from a single department?",
      "options": [
        {
          "id": "A",
          "text": "7"
        },
        {
          "id": "B",
          "text": "6"
        },
        {
          "id": "C",
          "text": "8"
        },
        {
          "id": "D",
          "text": "9"
        }
      ],
      "solution_text": "\\[cite_start\\]Qureshi could have received 9 votes from a single department. \\[cite: 448\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q42",
      "set_ref": "DILR_SET_4",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 42,
      "question_type": "MCQ",
      "taxonomy_type": "lr_logic",
      "topic": "Logical Reasoning",
      "subtopic": "Set Theory",
      "difficulty": "hard",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "If Prof. Samuel belongs to B\\&H, which of the following statements is/are true?\nStatement A: Prof. Pakrasi belongs to M\\&S.\nStatement B: Prof. Ramaswamy belongs to O\\&Q.",
      "options": [
        {
          "id": "A",
          "text": "Neither statement A nor statement B"
        },
        {
          "id": "B",
          "text": "Only statement B"
        },
        {
          "id": "C",
          "text": "Only statement A"
        },
        {
          "id": "D",
          "text": "Both statements A and B"
        }
      ],
      "solution_text": "\\[cite_start\\]Both statements A and B are true. \\[cite: 456\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q43",
      "set_ref": "DILR_SET_4",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 43,
      "question_type": "MCQ",
      "taxonomy_type": "lr_logic",
      "topic": "Logical Reasoning",
      "subtopic": "Set Theory",
      "difficulty": "hard",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "What best can be concluded about the candidate from O\\&Q?",
      "options": [
        {
          "id": "A",
          "text": "It was Prof. Samuel."
        },
        {
          "id": "B",
          "text": "It was either Prof. Ramaswamy or Prof. Samuel."
        },
        {
          "id": "C",
          "text": "It was Prof. Ramaswamy."
        },
        {
          "id": "D",
          "text": "It was either Prof. Pakrasi or Prof. Qureshi."
        }
      ],
      "solution_text": "\\[cite_start\\]The candidate from O\\&Q was either Prof. Ramaswamy or Prof. Samuel. \\[cite: 462\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q44",
      "set_ref": "DILR_SET_4",
      "sequence_order": 5,
      "section": "DILR",
      "question_number": 44,
      "question_type": "MCQ",
      "taxonomy_type": "lr_logic",
      "topic": "Logical Reasoning",
      "subtopic": "Set Theory",
      "difficulty": "hard",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following statements is/are true?\nStatement A: Non-candidates from M\\&S voted for Prof. Qureshi.\nStatement B: Non-candidates from F\\&A voted for Prof. Qureshi.",
      "options": [
        {
          "id": "A",
          "text": "Both statements A and B"
        },
        {
          "id": "B",
          "text": "Only statement B"
        },
        {
          "id": "C",
          "text": "Only statement A"
        },
        {
          "id": "D",
          "text": "Neither statement A nor statement B"
        }
      ],
      "solution_text": "\\[cite_start\\]Only statement B is true. \\[cite: 470\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q45",
      "set_ref": "QA_ATOMIC_45",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 45,
      "question_type": "MCQ",
      "taxonomy_type": "qa_number_theory",
      "topic": "Quant",
      "subtopic": "Number Systems",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Let $n$ be the least positive integer such that 168 is a factor of $1134^n$. If $m$ is the least positive integer such that $1134^n$ is a factor of $168^m$, then $m+n$ equals:",
      "options": [
        {
          "id": "A",
          "text": "9"
        },
        {
          "id": "B",
          "text": "15"
        },
        {
          "id": "C",
          "text": "12"
        },
        {
          "id": "D",
          "text": "24"
        }
      ],
      "solution_text": "Prime factorization: $168 \\= 2^3 \\\\times 3 \\\\times 7$ and $1134 \\= 2 \\\\times 3^4 \\\\times 7$. Solving for minimal $n$ and $m$ yields $n=3$ and $m=12$. \\[cite_start\\]Thus $m+n \\= 15$. \\[cite: 473, 474\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q46",
      "set_ref": "QA_ATOMIC_46",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 46,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Logarithms",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "If $x$ and $y$ are positive real numbers such that $\\\\log_x(x^2 + 12\\) \\= 4$ and $3 \\\\log_y x \\= 1$, then $x + y$ equals:",
      "options": [
        {
          "id": "A",
          "text": "20"
        },
        {
          "id": "B",
          "text": "68"
        },
        {
          "id": "C",
          "text": "10"
        },
        {
          "id": "D",
          "text": "11"
        }
      ],
      "solution_text": "From $\\\\log_x(x^2 + 12\\) \\= 4$, we get $x^4 \\- x^2 \\- 12 \\= 0$, giving $x^2 \\= 4 \\\\implies x=2$ (since positive). From $3 \\\\log_y x \\= 1$, we substitute $x=2$ to find $y \\= 8$. \\[cite_start\\]Thus $x+y=10$. \\[cite: 481\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q47",
      "set_ref": "QA_ATOMIC_47",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 47,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Surds",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "If $\\\\sqrt{5x+9} + \\\\sqrt{5x-9} \\= 3(2+\\\\sqrt{2})$, then $\\\\sqrt{10x+9}$ is equal to:",
      "options": [
        {
          "id": "A",
          "text": "$3\\\\sqrt{31}$"
        },
        {
          "id": "B",
          "text": "$4\\\\sqrt{5}$"
        },
        {
          "id": "C",
          "text": "$3\\\\sqrt{7}$"
        },
        {
          "id": "D",
          "text": "$2\\\\sqrt{7}$"
        }
      ],
      "solution_text": "By squaring or observing the structure, solving for $x$ allows substitution into $\\\\sqrt{10x+9}$. \\[cite_start\\]The value simplifies to $3\\\\sqrt{7}$. \\[cite: 488\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q48",
      "set_ref": "QA_ATOMIC_48",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 48,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Algebraic Identities",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "If $x$ and $y$ are real numbers such that $x^2 + (x \\- 2y \\- 1)^2 \\= \\-4y(x + y)$, then the value $x \\- 2y$ is:",
      "options": [
        {
          "id": "A",
          "text": "0"
        },
        {
          "id": "B",
          "text": "1"
        },
        {
          "id": "C",
          "text": "\\-1"
        },
        {
          "id": "D",
          "text": "2"
        }
      ],
      "solution_text": "Rearranging the equation reveals perfect squares sum to zero or a specific value. \\[cite_start\\]Solving for $x$ and $y$ yields $x-2y \\= 1$. \\[cite: 495\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q49",
      "set_ref": "QA_ATOMIC_49",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 49,
      "question_type": "TITA",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Modulus",
      "difficulty": "medium",
      "correct_answer": "3",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The number of integer solutions of equation $2|x|(x^{2}+1)=5x^{2}$ is:",
      "solution_text": "Case 1 ($x>0$): $2x(x^2+1)=5x^2 \\\\implies 2x^2 \\- 5x + 2 \\= 0 \\\\implies x=2$ (integer). Case 2 ($x\\<0$): $-2x(x^2+1)=5x^2 \\\\implies 2x^2 + 5x + 2 \\= 0 \\\\implies x=-2$ (integer). Case 3 ($x=0$): solution exists. \\[cite_start\\]Total 3 integer solutions. \\[cite: 502\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q50",
      "set_ref": "QA_ATOMIC_50",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 50,
      "question_type": "TITA",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Polynomials",
      "difficulty": "hard",
      "correct_answer": "2",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The equation $x^{3}+(2r+1)x^{2}+(4r-1)x+2=0$ has \\-2 as one of the roots. If the other two roots are real, then the minimum possible non-negative integer value of $r$ is:",
      "solution_text": "Substitute $x=-2$ to find the relationship, then use the discriminant condition $D \\\\ge 0$ for the remaining quadratic factor to find the range of $r$. \\[cite_start\\]Minimum non-negative integer is 2\\. \\[cite: 505, 506\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q51",
      "set_ref": "QA_ATOMIC_51",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 51,
      "question_type": "TITA",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Quadratic Equations",
      "difficulty": "medium",
      "correct_answer": "6",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Let $\\\\alpha$ and $\\\\beta$ be the two distinct roots of the equation $2x^{2}-6x+k=0$ such that $(\\\\alpha+\\\\beta)$ and $\\\\alpha\\\\beta$ are the distinct roots of the equation $x^{2}+px+p=0$. Then, the value of $8(k-p)$ is:",
      "solution_text": "From the first eq, $\\\\alpha+\\\\beta=3$ and $\\\\alpha\\\\beta=k/2$. These are roots of the second eq. Sum of roots $3 + k/2 \\= \\-p$ and product $3(k/2) \\= p$. \\[cite_start\\]Solving this system gives $k$ and $p$. \\[cite: 509\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q52",
      "set_ref": "QA_ATOMIC_52",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 52,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Mixtures",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "A mixture P is formed by removing a certain amount of coffee from a coffee jar and replacing the same amount with cocoa powder. The same amount is again removed from mixture P and replaced with same amount of cocoa powder to form a new mixture Q. If the ratio of coffee and cocoa in the mixture Q is 16:9, then the ratio of cocoa in mixture P to that in mixture Q is:",
      "options": [
        {
          "id": "A",
          "text": "1:3"
        },
        {
          "id": "B",
          "text": "1:2"
        },
        {
          "id": "C",
          "text": "5:9"
        },
        {
          "id": "D",
          "text": "4:9"
        }
      ],
      "solution_text": "Using the removal/replacement formula: Coffee fraction in Q is $16/25 \\= (1 \\- x/V)^2$. Thus removal fraction is $1/5$. \\[cite_start\\]Calculate coffee/cocoa in P and Q to find the ratio of cocoa components. \\[cite: 513, 514\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q53",
      "set_ref": "QA_ATOMIC_53",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 53,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Clocks",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The minor angle between the hours hand and minutes hand of a clock was observed at 8:48 am. The minimum duration, in minutes, after 8:48 am when this angle increases by 50% is:",
      "options": [
        {
          "id": "A",
          "text": "$36/11$"
        },
        {
          "id": "B",
          "text": "2"
        },
        {
          "id": "C",
          "text": "4"
        },
        {
          "id": "D",
          "text": "$24/11$"
        }
      ],
      "solution_text": "Calculate initial angle at 8:48. Increase it by 50%. \\[cite_start\\]Use relative speed of hands ($11/2$ degrees per min) to find time required to reach the new separation. \\[cite: 521, 522\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q54",
      "set_ref": "QA_ATOMIC_54",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 54,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Profit and Loss",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Gita sells two objects A and B at the same price such that she makes a profit of 20% on object A and a loss of 10% on object B. If she increases the selling price such that objects A and B are still sold at an equal price and a profit of 10% is made on object B, then the profit made on object A will be nearest to:",
      "options": [
        {
          "id": "A",
          "text": "42%"
        },
        {
          "id": "B",
          "text": "45%"
        },
        {
          "id": "C",
          "text": "47%"
        },
        {
          "id": "D",
          "text": "49%"
        }
      ],
      "solution_text": "Use ratios of CP and SP. Initial SP is same. \\[cite_start\\]New SP is defined by 10% profit on B. Calculate new profit on A given its fixed CP. \\[cite: 529\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q55",
      "set_ref": "QA_ATOMIC_55",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 55,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Time Speed Distance",
      "difficulty": "hard",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Brishti went on an 8-hour trip in a car. Before the trip, the car had travelled a total of $x$ km till then, where $x$ is a whole number and is palindromic. At the end of the trip, the car had travelled a total of 26862 km till then, this number again being palindromic. If Brishti never drove at more than $110\\~km/h$, then the greatest possible average speed at which she drove during the trip, in $km/h$, was:",
      "options": [
        {
          "id": "A",
          "text": "110"
        },
        {
          "id": "B",
          "text": "90"
        },
        {
          "id": "C",
          "text": "100"
        },
        {
          "id": "D",
          "text": "80"
        }
      ],
      "solution_text": "Max distance possible \\= $8 \\\\times 110 \\= 880$ km. Initial reading $x$ must be a palindrome in range $\\[26862-880, 26862\\]$. \\[cite_start\\]Identify valid palindromes (e.g., 26062\\) and calculate average speed. \\[cite: 536, 537\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q56",
      "set_ref": "QA_ATOMIC_56",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 56,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Averages",
      "difficulty": "hard",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "In an examination, the average marks of 4 girls and 6 boys is 24\\. Each of the girls has the same marks while each of the boys has the same marks. If the marks of any girl is at most double the marks of any boy, but not less than the marks of any boy, then the number of possible distinct integer values of the total marks of 2 girls and 6 boys is:",
      "options": [
        {
          "id": "A",
          "text": "21"
        },
        {
          "id": "B",
          "text": "20"
        },
        {
          "id": "C",
          "text": "22"
        },
        {
          "id": "D",
          "text": "19"
        }
      ],
      "solution_text": "Total marks \\= 240\\. Let $g$ and $b$ be marks. $4g + 6b \\= 240$. Constraints: $b \\\\le g \\\\le 2b$. \\[cite_start\\]Find integer solutions for $(g, b)$ and calculate distinct values of $2g + 6b$. \\[cite: 545, 546\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q57",
      "set_ref": "QA_ATOMIC_57",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 57,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Ratios and Percentages",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The salaries of three friends Sita, Gita and Mita are initially in the ratio 5: 6: 7, respectively. In the first year, they get salary hikes of 20%, 25% and 20%, respectively. In the second year, Sita and Mita get salary hikes of 40% and 25%, respectively, and the salary of Gita becomes equal to the mean salary of the three friends. The salary hike of Gita in the second year is:",
      "options": [
        {
          "id": "A",
          "text": "25%"
        },
        {
          "id": "B",
          "text": "28%"
        },
        {
          "id": "C",
          "text": "26%"
        },
        {
          "id": "D",
          "text": "30%"
        }
      ],
      "solution_text": "Compute salaries after year 1 (6, 7.5, 8.4). Apply year 2 hikes to Sita and Mita. \\[cite_start\\]Calculate the mean, set equal to Gita's new salary, and find her hike percentage. \\[cite: 553, 555\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q58",
      "set_ref": "QA_ATOMIC_58",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 58,
      "question_type": "TITA",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Time Speed Distance",
      "difficulty": "medium",
      "correct_answer": "972",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Arvind travels from town A to town B, and Surbhi from town B to town A, both starting at the same time along the same route. After meeting each other, Arvind takes 6 hours to reach town B while Surbhi takes 24 hours to reach town A. If Arvind travelled at a speed of $54\\~km/h$, then the distance, in km, between town A and town B is:",
      "solution_text": "Use the formula for meeting time $t \\= \\\\sqrt{t_1 t_2} \\= \\\\sqrt{6 \\\\times 24} \\= 12$ hours. Total time for Arvind \\= $12+6 \\= 18$ hours. \\[cite_start\\]Distance \\= $Speed \\\\times Time \\= 54 \\\\times 18$. \\[cite: 563, 564\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q59",
      "set_ref": "QA_ATOMIC_59",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 59,
      "question_type": "TITA",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Interest",
      "difficulty": "medium",
      "correct_answer": "20808",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Anil invests Rs. 22000 for 6 years in a certain scheme with 4% interest per annum, compounded half-yearly. Sunil invests in the same scheme for 5 years, and then reinvests the entire amount received at the end of 5 years for one year at 10% simple interest. If the amounts received by both at the end of 6 years are same, then the initial investment made by Sunil, in rupees, is:",
      "solution_text": "Equate the final amounts. Anil: $22000(1.02)^{12}$. Sunil: $P(1.02)^{10}(1.10)$. \\[cite_start\\]Solve for $P$. \\[cite: 567, 568\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q60",
      "set_ref": "QA_ATOMIC_60",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 60,
      "question_type": "TITA",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Time and Work",
      "difficulty": "hard",
      "correct_answer": "27",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The amount of job that Amal, Sunil and Kamal can individually do in a day, are in harmonic progression. Kamal takes twice as much time as Amal to do the same amount of job. If Amal and Sunil work for 4 days and 9 days, respectively, Kamal needs to work for 16 days to finish the remaining job. Then the number of days Sunil will take to finish the job working alone, is:",
      "solution_text": "Let rates be $a, s, k$. $a, s, k$ in HP means $1/a, 1/s, 1/k$ in AP. Time relationship implies $k \\= a/2$. \\[cite_start\\]Use work equation $4a + 9s + 16k \\= Total Work$ to solve for $s$. \\[cite: 572, 574\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q61",
      "set_ref": "QA_ATOMIC_61",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 61,
      "question_type": "MCQ",
      "taxonomy_type": "qa_geometry",
      "topic": "Quant",
      "subtopic": "Coordinate Geometry",
      "difficulty": "hard",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Let C be the circle $x^{2}+y^{2}+4x-6y-3=0$ and L be the locus of the point of intersection of a pair of tangents to C with the angle between the two tangents equal to $60^{\\\\circ}$. Then, the point at which L touches the line $x=6$ is:",
      "options": [
        {
          "id": "A",
          "text": "(6,6)"
        },
        {
          "id": "B",
          "text": "(6,3)"
        },
        {
          "id": "C",
          "text": "(6,8)"
        },
        {
          "id": "D",
          "text": "(6,4)"
        }
      ],
      "solution_text": "Center of C is $(-2, 3)$, radius $r=4$. Locus of point with $60^\\\\circ$ tangent angle is a concentric circle (director circle variation) with radius $R \\= r / \\\\sin(30^\\\\circ) \\= 8$. Locus equation: $(x+2)^2 + (y-3)^2 \\= 8^2$. \\[cite_start\\]Substitute $x=6$ to find $y$. \\[cite: 578\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q62",
      "set_ref": "QA_ATOMIC_62",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 62,
      "question_type": "MCQ",
      "taxonomy_type": "qa_geometry",
      "topic": "Quant",
      "subtopic": "Geometry",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "A quadrilateral ABCD is inscribed in a circle such that $AB:CD=2:1$ and $BC:AD=5:4$. If AC and BD intersect at the point E, then AE: CE equals:",
      "options": [
        {
          "id": "A",
          "text": "2:1"
        },
        {
          "id": "B",
          "text": "1:2"
        },
        {
          "id": "C",
          "text": "8:5"
        },
        {
          "id": "D",
          "text": "5:8"
        }
      ],
      "solution_text": "For cyclic quadrilateral, ratio of diagonals' segments is related to product of adjacent sides. $AE/CE \\= (AB \\\\cdot AD) / (CB \\\\cdot CD)$. \\[cite_start\\]Substitute given ratios. \\[cite: 586, 587\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q63",
      "set_ref": "QA_ATOMIC_63",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 63,
      "question_type": "TITA",
      "taxonomy_type": "qa_geometry",
      "topic": "Quant",
      "subtopic": "Geometry",
      "difficulty": "hard",
      "correct_answer": "2",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "In a right-angled triangle $\\\\triangle ABC$, the altitude AB is 5 cm, and the base BC is 12 cm. P and Q are two points on BC such that the areas of $\\\\triangle ABP$, $\\\\triangle ABQ$ and $\\\\triangle ABC$ are in arithmetic progression. If the area of $\\\\triangle ABC$ is 1.5 times the area of $\\\\triangle ABP$, the length of PQ, in cm, is:",
      "solution_text": "Area $\\\\triangle ABC \\= 0.5 \\\\times 5 \\\\times 12 \\= 30$. Area $\\\\triangle ABP \\= 30 / 1.5 \\= 20$. Since areas are in AP, find Area $\\\\triangle ABQ$ and deduce bases BP and BQ. \\[cite_start\\]$PQ \\= |BP \\- BQ|$. \\[cite: 594, 595\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q64",
      "set_ref": "QA_ATOMIC_64",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 64,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Sequences",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "For some positive and distinct real numbers x , y and z, if $\\\\frac{1}{\\\\sqrt{x}+\\\\sqrt{y}}, \\\\frac{1}{\\\\sqrt{y}+\\\\sqrt{z}}, \\\\frac{1}{\\\\sqrt{z}+\\\\sqrt{x}}$ are in arithmetic progression, then the relationship which will always hold true, is:",
      "options": [
        {
          "id": "A",
          "text": "$\\\\sqrt{x}, \\\\sqrt{z}$ and $\\\\sqrt{y}$ are in arithmetic progression"
        },
        {
          "id": "B",
          "text": "y, x and z are in arithmetic progression"
        },
        {
          "id": "C",
          "text": "x, y and z are in arithmetic progression"
        },
        {
          "id": "D",
          "text": "$\\\\sqrt{x}, \\\\sqrt{y}$ and $\\\\sqrt{z}$ are in arithmetic progression"
        }
      ],
      "solution_text": "Rationalize the denominators and apply condition $2b \\= a+c$. \\[cite_start\\]Simplifying the terms leads to $x, y, z$ relationship. \\[cite: 599\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q65",
      "set_ref": "QA_ATOMIC_65",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 65,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Quant",
      "subtopic": "Permutations Combinations",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The number of all natural numbers up to 1000 with non-repeating digits is:",
      "options": [
        {
          "id": "A",
          "text": "504"
        },
        {
          "id": "B",
          "text": "648"
        },
        {
          "id": "C",
          "text": "738"
        },
        {
          "id": "D",
          "text": "585"
        }
      ],
      "solution_text": "Calculate 1-digit (9), 2-digit ($9 \\\\times 9$), and 3-digit ($9 \\\\times 9 \\\\times 8$) numbers with distinct digits. \\[cite_start\\]Sum them up. \\[cite: 606\\]"
    },
    {
      "client_question_id": "cat-2023-slot-1_Q66",
      "set_ref": "QA_ATOMIC_66",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 66,
      "question_type": "TITA",
      "taxonomy_type": "qa_algebra",
      "topic": "Quant",
      "subtopic": "Sequences",
      "difficulty": "medium",
      "correct_answer": "19",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "A lab experiment measures the number of organisms at 8 am every day. Starting with 2 organisms on the first day, the number of organisms on any day is equal to 3 more than twice the number on the previous day. If the number of organisms on the nth day exceeds one million, then the lowest possible value of $n$ is:",
      "solution_text": "Recurrence: $a_n \\= 2a_{n-1} + 3$. General term is $a_n \\= 5(2^{n-1}) \\- 3$. \\[cite_start\\]Solve $5(2^{n-1}) \\- 3 > 1,000,000$. \\[cite: 614, 615\\]"
    }
  ]
}
````

## File: data_sanitized/CAT-2023-Slot-2-v3.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ schema_version: string, paper: object, question_sets: object, questions: object }",
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "CAT_2023_SLOT2",
    "title": "CAT 2023 Slot 2",
    "slug": "cat-2023-slot-2",
    "description": "Converted from PDF to structured markdown",
    "year": 2023,
    "total_questions": 66,
    "total_marks": 198,
    "duration_minutes": 120,
    "sections": [
      "VARC",
      "DILR",
      "QA"
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "cat-level",
    "is_free": true,
    "published": false,
    "allow_pause": true,
    "attempt_limit": 0
  },
  "question_sets": [
    {
      "section": "VARC",
      "client_set_id": "VARC_RC_01",
      "set_type": "VARC",
      "display_order": 1,
      "content_layout": "split_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_RC_02",
      "set_type": "VARC",
      "display_order": 2,
      "content_layout": "split_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_RC_03",
      "set_type": "VARC",
      "display_order": 3,
      "content_layout": "split_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_RC_04",
      "set_type": "VARC",
      "display_order": 4,
      "content_layout": "split_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_SA_01",
      "set_type": "ATOMIC",
      "display_order": 5,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_SA_02",
      "set_type": "ATOMIC",
      "display_order": 6,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_SA_03",
      "set_type": "ATOMIC",
      "display_order": 7,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_SA_04",
      "set_type": "ATOMIC",
      "display_order": 8,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_SA_05",
      "set_type": "ATOMIC",
      "display_order": 9,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_SA_06",
      "set_type": "ATOMIC",
      "display_order": 10,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_SA_07",
      "set_type": "ATOMIC",
      "display_order": 11,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "DILR",
      "client_set_id": "DILR_SET_01",
      "set_type": "DILR",
      "display_order": 1,
      "content_layout": "single_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "DILR",
      "client_set_id": "DILR_SET_02",
      "set_type": "DILR",
      "display_order": 2,
      "content_layout": "single_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "DILR",
      "client_set_id": "DILR_SET_03",
      "set_type": "DILR",
      "display_order": 3,
      "content_layout": "single_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "DILR",
      "client_set_id": "DILR_SET_04",
      "set_type": "DILR",
      "display_order": 4,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_01",
      "set_type": "ATOMIC",
      "display_order": 1,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_02",
      "set_type": "ATOMIC",
      "display_order": 2,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_03",
      "set_type": "ATOMIC",
      "display_order": 3,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_04",
      "set_type": "ATOMIC",
      "display_order": 4,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_05",
      "set_type": "ATOMIC",
      "display_order": 5,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_06",
      "set_type": "ATOMIC",
      "display_order": 6,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_07",
      "set_type": "ATOMIC",
      "display_order": 7,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_08",
      "set_type": "ATOMIC",
      "display_order": 8,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_09",
      "set_type": "ATOMIC",
      "display_order": 9,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_10",
      "set_type": "ATOMIC",
      "display_order": 10,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_11",
      "set_type": "ATOMIC",
      "display_order": 11,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_12",
      "set_type": "ATOMIC",
      "display_order": 12,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_13",
      "set_type": "ATOMIC",
      "display_order": 13,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_14",
      "set_type": "ATOMIC",
      "display_order": 14,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_15",
      "set_type": "ATOMIC",
      "display_order": 15,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_16",
      "set_type": "ATOMIC",
      "display_order": 16,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_17",
      "set_type": "ATOMIC",
      "display_order": 17,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_18",
      "set_type": "ATOMIC",
      "display_order": 18,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_19",
      "set_type": "ATOMIC",
      "display_order": 19,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_20",
      "set_type": "ATOMIC",
      "display_order": 20,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_21",
      "set_type": "ATOMIC",
      "display_order": 21,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_22",
      "set_type": "ATOMIC",
      "display_order": 22,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    }
  ],
  "questions": [
    {
      "set_ref": "VARC_RC_01",
      "section": "VARC",
      "client_question_id": "VARC_RC_01_Q1",
      "question_number": 1,
      "sequence_order": 1,
      "question_type": "MCQ",
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "options": [
        "Archaeology helps historians to locate the oldest civilisations in history.",
        "Archaeology helps historians to ascertain factual accuracy.",
        "Archaeology helps historians to carry out their primary duty.",
        "Archaeology helps historians to interpret historical facts."
      ],
      "correct_answer": "<ANSWER_OMITTED>",
      "topic": "Reading Comprehension",
      "subtopic": "Inference",
      "difficulty": "medium",
      "difficulty_rationale": "Requires identifying the role of auxiliary sciences as described in the passage.",
      "solution_text": "<SOLUTION_TEXT_OMITTED>",
      "positive_marks": 3,
      "negative_marks": 1
    },
    {
      "_NOTE": "... 65 more items omitted (total: 66) ..."
    }
  ]
}
````

## File: data_sanitized/cat-2024-mock-1-full.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ paper: object, contexts: object, questions: object }",
  "paper": {
    "slug": "cat-2024-slot-1",
    "title": "CAT 2024 Slot 1",
    "description": "CAT 2024 Slot 1 actual exam with 66 questions across VARC, DILR, and QA sections.",
    "year": 2024,
    "total_questions": 66,
    "total_marks": 198,
    "duration_minutes": 120,
    "sections": [
      {
        "name": "VARC",
        "questions": 24,
        "time": 40,
        "marks": 72
      },
      {
        "name": "DILR",
        "questions": 20,
        "time": 40,
        "marks": 60
      },
      {
        "name": "QA",
        "questions": 22,
        "time": 40,
        "marks": 66
      }
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "cat-level",
    "is_free": true,
    "published": true,
    "available_from": null,
    "available_until": null
  },
  "contexts": [
    {
      "id": "varc-passage-1",
      "title": "Bandicoots",
      "section": "VARC",
      "text": "<TEXT_OMITTED>"
    },
    {
      "_NOTE": "... 13 more items omitted (total: 14) ..."
    }
  ],
  "questions": [
    {
      "section": "DILR",
      "question_number": 1,
      "context_id": "<CONTEXT_ID_OMITTED>",
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "question_type": "TITA",
      "options": null,
      "correct_answer": "<ANSWER_OMITTED>",
      "positive_marks": 3,
      "negative_marks": 0,
      "difficulty": "medium",
      "is_active": true
    },
    {
      "_NOTE": "... 65 more items omitted (total: 66) ..."
    }
  ]
}
````

## File: data_sanitized/CAT-2024-Slot-1-parsed.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ schema_version: string, paper: object, question_sets: object, questions: object }",
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "CAT_2024_SLOT1",
    "slug": "cat-2024-slot-1",
    "title": "CAT 2024 Slot 1",
    "year": 2024,
    "duration_minutes": 120,
    "total_questions": 67,
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "total_marks": 198,
    "sections": [
      "VARC",
      "DILR",
      "QA"
    ]
  },
  "question_sets": [
    {
      "client_set_id": "VARC_RC_01",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 1,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_SUM_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 2,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_02",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 3,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_PJ_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 4,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_PJ_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 5,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_OO_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 6,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_03",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 7,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_SUM_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 8,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_PJ_03",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 9,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_OO_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 10,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_04",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 11,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_01",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 12,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "notes": "Includes a candlestick chart converted to table data",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_02",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 13,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_03",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 14,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_04",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 15,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_05",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 16,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "QA_47",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 17,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_48",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 18,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_49",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 19,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_50",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 20,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_51",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 21,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_52",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 22,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_53",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 23,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_54",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 24,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_55",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 25,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_56",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 26,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_57",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 27,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_58",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 28,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_59",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 29,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_60",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 30,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_61",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 31,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_62",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 32,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_63",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 33,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_64",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 34,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_65",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 35,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_66",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 36,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_67",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 37,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_68",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 38,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    }
  ],
  "questions": [
    {
      "client_question_id": "VARC_RC_01_Q1",
      "question_number": 1,
      "sequence_order": 1,
      "question_type": "MCQ",
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "correct_answer": "<ANSWER_OMITTED>",
      "topic": "Reading Comprehension",
      "subtopic": "Inference",
      "difficulty": "medium",
      "options": [
        {
          "id": "A",
          "text": "<TEXT_OMITTED>"
        },
        {
          "_NOTE": "... 3 more items omitted (total: 4) ..."
        }
      ],
      "set_ref": "VARC_RC_01",
      "section": "VARC"
    },
    {
      "_NOTE": "... 66 more items omitted (total: 67) ..."
    }
  ]
}
````

## File: data_sanitized/cat-2024-slot-1-varc.jsonc
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ paper: object, contexts: object, questions: object }",
  "paper": {
    "slug": "cat-2024-slot-1",
    "title": "CAT 2024 Slot 1",
    "description": "CAT 2024 Slot 1 actual exam with 66 questions across VARC, DILR, and QA sections.",
    "year": 2024,
    "total_questions": 66,
    "total_marks": 198,
    "duration_minutes": 120,
    "sections": [
      {
        "name": "VARC",
        "questions": 24,
        "time": 40,
        "marks": 72
      },
      {
        "name": "DILR",
        "questions": 20,
        "time": 40,
        "marks": 60
      },
      {
        "name": "QA",
        "questions": 22,
        "time": 40,
        "marks": 66
      }
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "cat-level",
    "is_free": true,
    "published": true,
    "available_from": null,
    "available_until": null
  },
  "contexts": [
    {
      "id": "dilr-set-1",
      "title": "Web Surfers and Bloggers",
      "section": "DILR",
      "text": "<TEXT_OMITTED>"
    },
    {
      "_NOTE": "... 10 more items omitted (total: 11) ..."
    }
  ],
  "questions": [
    {
      "section": "DILR",
      "question_number": 1,
      "context_id": "<CONTEXT_ID_OMITTED>",
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "question_type": "TITA",
      "options": null,
      "correct_answer": "<ANSWER_OMITTED>",
      "positive_marks": 3,
      "negative_marks": 0,
      "difficulty": "medium",
      "is_active": true
    },
    {
      "_NOTE": "... 65 more items omitted (total: 66) ..."
    }
  ]
}
````

## File: data_sanitized/cat-2024-slot-1.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ paper: object, contexts: object, questions: object }",
  "paper": {
    "slug": "cat-2024-slot-1",
    "title": "CAT 2024 Slot 1",
    "description": "CAT 2024 Slot 1 actual exam with 66 questions across VARC, DILR, and QA sections.",
    "year": 2024,
    "total_questions": 66,
    "total_marks": 198,
    "duration_minutes": 120,
    "sections": [
      {
        "name": "VARC",
        "questions": 24,
        "time": 40,
        "marks": 72
      },
      {
        "name": "DILR",
        "questions": 20,
        "time": 40,
        "marks": 60
      },
      {
        "name": "QA",
        "questions": 22,
        "time": 40,
        "marks": 66
      }
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "cat-level",
    "is_free": true,
    "published": true,
    "available_from": null,
    "available_until": null
  },
  "contexts": [
    {
      "id": "varc-passage-1",
      "title": "Bandicoots",
      "section": "VARC",
      "text": "<TEXT_OMITTED>"
    },
    {
      "_NOTE": "... 8 more items omitted (total: 9) ..."
    }
  ],
  "questions": [
    {
      "section": "VARC",
      "question_number": 1,
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "question_type": "MCQ",
      "options": [
        "Option 2",
        "Option 4",
        "Option 1",
        "Option 3"
      ],
      "correct_answer": "<ANSWER_OMITTED>",
      "positive_marks": 3,
      "negative_marks": 1,
      "difficulty": "medium",
      "is_active": true
    },
    {
      "_NOTE": "... 65 more items omitted (total: 66) ..."
    }
  ]
}
````

## File: data_sanitized/CAT-2024-Slot-2-parsed.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ schema_version: string, paper: object, question_sets: object, questions: object }",
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "CAT_2024_SLOT2",
    "slug": "cat-2024-slot-2",
    "title": "CAT 2024 Slot 2",
    "year": 2024,
    "duration_minutes": 120,
    "total_questions": 68,
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "total_marks": 198,
    "sections": [
      "VARC",
      "DILR",
      "QA"
    ]
  },
  "question_sets": [
    {
      "client_set_id": "VARC_PJ_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 1,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_OO_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 2,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_PJ_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 3,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_SUM_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 4,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_SUM_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 5,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_PJ_03",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 6,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_01",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 7,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_SUM_03",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 8,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_OO_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 9,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_02",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 10,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_03",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 11,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_04",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 12,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_01",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 13,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_02",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 14,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_03",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 15,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_04",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 16,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "notes": "Scatter Plot Interpretation",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_05",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 17,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "QA_47",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 18,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_48",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 19,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_49",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 20,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_50",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 21,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_51",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 22,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_52",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 23,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_53",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 24,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_54",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 25,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_55",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 26,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_56",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 27,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_57",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 28,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_58",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 29,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_59",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 30,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_60",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 31,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_61",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 32,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_62",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 33,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_63",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 34,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_64",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 35,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_65",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 36,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_66",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 37,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_67",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 38,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_68",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 39,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    }
  ],
  "questions": [
    {
      "client_question_id": "VARC_PJ_01_Q1",
      "question_number": 1,
      "sequence_order": 1,
      "question_type": "MCQ",
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "correct_answer": "<ANSWER_OMITTED>",
      "topic": "Verbal Ability",
      "subtopic": "Paragraph Completion",
      "difficulty": "medium",
      "options": [
        {
          "id": "A",
          "text": "<TEXT_OMITTED>"
        },
        {
          "_NOTE": "... 3 more items omitted (total: 4) ..."
        }
      ],
      "set_ref": "VARC_PJ_01",
      "section": "VARC"
    },
    {
      "_NOTE": "... 67 more items omitted (total: 68) ..."
    }
  ]
}
````

## File: data_sanitized/CAT-2024-Slot-3-parsed.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ schema_version: string, paper: object, question_sets: object, questions: object }",
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "CAT_2024_SLOT3",
    "slug": "cat-2024-slot-3",
    "title": "CAT 2024 Slot 3",
    "year": 2024,
    "duration_minutes": 120,
    "total_questions": 68,
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "total_marks": 198,
    "sections": [
      "VARC",
      "DILR",
      "QA"
    ]
  },
  "question_sets": [
    {
      "client_set_id": "VARC_PJ_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 1,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_01",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 2,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_PJ_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 3,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_OO_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 4,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_02",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 5,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_PJ_03",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 6,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_03",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 7,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_SUM_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 8,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_SUM_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 9,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_OO_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 10,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_SUM_03",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 11,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_04",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 12,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_01",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 13,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_02",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 14,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_03",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 15,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_04",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 16,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "notes": "Calculation intensive data interpretation involving growth rates and ratios.",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "DILR_05",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 17,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "QA_47",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 18,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_48",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 19,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_49",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 20,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_50",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 21,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_51",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 22,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_52",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 23,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_53",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 24,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_54",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 25,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_55",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 26,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_56",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 27,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_57",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 28,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_58",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 29,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_59",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 30,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_60",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 31,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_61",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 32,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_62",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 33,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_63",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 34,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_64",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 35,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_65",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 36,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_66",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 37,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_67",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 38,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    },
    {
      "client_set_id": "QA_68",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 39,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>"
    }
  ],
  "questions": [
    {
      "client_question_id": "VARC_PJ_01_Q1",
      "question_number": 1,
      "sequence_order": 1,
      "question_type": "MCQ",
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "correct_answer": "<ANSWER_OMITTED>",
      "topic": "Verbal Ability",
      "subtopic": "Paragraph Completion",
      "difficulty": "medium",
      "options": [
        {
          "id": "A",
          "text": "<TEXT_OMITTED>"
        },
        {
          "_NOTE": "... 3 more items omitted (total: 4) ..."
        }
      ],
      "set_ref": "VARC_PJ_01",
      "section": "VARC"
    },
    {
      "_NOTE": "... 67 more items omitted (total: 68) ..."
    }
  ]
}
````

## File: data_sanitized/cat-2024-slot1.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ paper: object, questions: object }",
  "paper": {
    "slug": "cat-2024-slot-1",
    "title": "CAT 2024 Slot 1 (Actual)",
    "description": "Official CAT 2024 Slot 1 Question Paper covering VARC, DILR, and QA.",
    "year": 2024,
    "total_questions": 66,
    "total_marks": 198,
    "duration_minutes": 120,
    "sections": [
      {
        "name": "VARC",
        "questions": 24,
        "time": 40,
        "marks": 72
      },
      {
        "name": "DILR",
        "questions": 20,
        "time": 40,
        "marks": 60
      },
      {
        "name": "QA",
        "questions": 22,
        "time": 40,
        "marks": 66
      }
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "cat-level",
    "is_free": true,
    "published": false,
    "available_from": null,
    "available_until": null
  },
  "questions": [
    {
      "section": "VARC",
      "question_number": 1,
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "question_type": "MCQ",
      "options": [
        "A",
        "B",
        "C",
        "D"
      ],
      "correct_answer": "<ANSWER_OMITTED>",
      "positive_marks": 3,
      "negative_marks": 1,
      "difficulty": "medium",
      "topic": "Reading Comprehension",
      "subtopic": null,
      "solution_text": "<SOLUTION_TEXT_OMITTED>"
    },
    {
      "_NOTE": "... 67 more items omitted (total: 68) ..."
    }
  ]
}
````

## File: data_sanitized/CAT-2025-Slot-1-parsed.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ schema_version: string, paper: object, question_sets: object, questions: object }",
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "CAT_2025_SLOT1",
    "slug": "cat-2025-slot-1",
    "title": "CAT 2025 Slot 1 Question Paper",
    "year": 2025,
    "duration_minutes": 120,
    "total_questions": 68,
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "total_marks": 204,
    "sections": [
      "VARC",
      "DILR",
      "QA"
    ],
    "available_from": "2025-11-24T00:00:00Z",
    "difficulty_level": "Hard",
    "is_free": false
  },
  "question_sets": [
    {
      "client_set_id": "VARC_PJ_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 1,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "VARC_RC_01",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 2,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_PJ_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 3,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "VARC_PC_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 4,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "VARC_PC_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 5,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "VARC_RC_02",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 6,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_PJ_03",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 7,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "VARC_SUM_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 8,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "VARC_RC_03",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 9,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_PJ_04",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 10,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "VARC_RC_04",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 11,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_SUM_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 12,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "LRDI_SET_01",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 1,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "LRDI_SET_02",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 2,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "LRDI_SET_03",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 3,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "LRDI_SET_04",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 4,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "LRDI_SET_05",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 5,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "QA_SET_01",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 1,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_02",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 2,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_03",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 3,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_04",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 4,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_05",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 5,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_06",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 6,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_07",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 7,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_08",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 8,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_09",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 9,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_10",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 10,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_11",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 11,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_12",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 12,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_13",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 13,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_14",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 14,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_15",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 15,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_16",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 16,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_17",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 17,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_18",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 18,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_19",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 19,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_20",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 20,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_21",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 21,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "QA_SET_22",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 22,
      "content_layout": "single_focus"
    }
  ],
  "questions": [
    {
      "client_question_id": "VARC_Q01",
      "question_number": 1,
      "sequence_order": 1,
      "question_type": "TITA",
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "correct_answer": "<ANSWER_OMITTED>",
      "negative_marks": 0,
      "topic": "Verbal Ability",
      "subtopic": "Para Jumbles (Odd One Out)",
      "difficulty": "medium",
      "difficulty_rationale": "Sentences 5, 1, 2, and 3 form a philosophical argument about the concept of freedom over death. Sentence 4 is descriptive about public opinion and breaks the philosophical flow.",
      "solution_text": "<SOLUTION_TEXT_OMITTED>",
      "set_ref": "VARC_PJ_01",
      "section": "VARC"
    },
    {
      "_NOTE": "... 67 more items omitted (total: 68) ..."
    }
  ]
}
````

## File: data_sanitized/CAT-2025-Slot-1.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ paper: object, contexts: object, questions: object }",
  "paper": {
    "slug": "cat-2025-slot-1",
    "title": "CAT 2025 Slot 1",
    "description": "CAT 2025 Slot 1 Actual Paper. Features 68 questions across VARC, DILR, and QA.",
    "year": 2025,
    "total_questions": 68,
    "total_marks": 204,
    "duration_minutes": 120,
    "sections": [
      {
        "name": "VARC",
        "questions": 24,
        "time": 40,
        "marks": 72
      },
      {
        "name": "DILR",
        "questions": 22,
        "time": 40,
        "marks": 66
      },
      {
        "name": "QA",
        "questions": 22,
        "time": 40,
        "marks": 66
      }
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "cat-level",
    "is_free": true,
    "published": true
  },
  "contexts": [
    {
      "id": "varc-rc-1",
      "section": "VARC",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "title": "Electronic Music & Aesthetics",
      "content": "Often the well intentioned music lover or the traditionally-minded professional composer asks two basic questions when faced with the electronic music phenomena: (1) is this type of artistic creation music at all? and, (2) given that the product is accepted as music of a new type or order, is not such music \"inhuman\"?...\n\nAs Lejaren Hiller points out in his book Experimental Music (coauthor Leonard M. Isaacson), two questions which often arise when music is discussed are: (a) the substance of musical communication and its symbolic and semantic significance, if any, and (b) the particular processes, both mental and technical, which are involved in creating and responding to musical composition.\n\nThe ever-present popular concept of music as a direct, open, emotional expression and as a subjective form of communication from the composer, is, of course still that of the nineteenth century, when composers themselves spoke of music in those terms.... But since the third decade of our century many composers have preferred more objective definitions of music, epitomized in Stravinsky's description of it as \"a form of speculation in terms of sound and time\". An acceptance of this more characteristic twentieth-century view of the art of musical composition will of course immediately bring the layman closer to an understanding of, and sympathetic response to, electronic music, even if the forms, sounds and approaches it uses will still be of a foreign nature to him.\n\nA communication problem however will still remain. The principal barrier that electronic music presents at large, in relation to the communication process, is that composers in this medium are employing a new language of forms where terms like 'densities', 'indefinite pitch relations', 'dynamic serialization', 'permutation', etc., are substitutes (or remote equivalents) for the traditional concepts of harmony, melody, rhythm, etc.... When the new structural procedures of electronic music are at last fully understood by the listener the barriers between him and the work he faces will be removed...\n\nThe medium of electronic music has of course tempted many kinds of composers to try their hand at it.... But the serious-minded composer approaches the world of electronic music with a more sophisticated and profound concept of creation. Although he knows that he can reproduce and employ melodic, rhythmic patterns and timbres of a traditional nature, he feels that it is in the exploration of sui generis languages and forms that the aesthetic magic of the new medium lies. And, conscientiously, he plunges into this search.\n\nThe second objection usually levelled against electronic music is much more innocent in nature. When people speak—sometimes very vehemently—of the 'inhuman' quality of this music they seem to forget that the composer is the one who fires the machines, collects the sounds, manipulates them, pushes the buttons, programs the computer, filters the sounds, establishes pitches and scales, splices tape, thinks of forms, and rounds up the over-all structure of the piece, as well as every detail of it."
    },
    {
      "_NOTE": "... 8 more items omitted (total: 9) ..."
    }
  ],
  "questions": [
    {
      "section": "VARC",
      "question_number": 1,
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "question_type": "TITA",
      "options": null,
      "correct_answer": "<ANSWER_OMITTED>",
      "positive_marks": 3,
      "negative_marks": 0,
      "difficulty": "medium",
      "topic": "Parajumbles",
      "subtopic": "Odd One Out",
      "context_id": null
    },
    {
      "_NOTE": "... 67 more items omitted (total: 68) ..."
    }
  ]
}
````

## File: data_sanitized/CAT-2025-Slot-2-parsed.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ schema_version: string, paper: object, question_sets: object, questions: object }",
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "CAT_2025_SLOT2_CRACKU",
    "slug": "cat-2025-slot-2",
    "title": "CAT 2025 Slot 2 Question Paper",
    "year": 2025,
    "duration_minutes": 120,
    "total_questions": 68,
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "total_marks": 204,
    "sections": [
      "VARC",
      "DILR",
      "QA"
    ]
  },
  "question_sets": [
    {
      "client_set_id": "VARC_ATOMIC_01",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 1,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "VARC_RC_01",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 2,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_ATOMIC_02",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 3,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "VARC_RC_02",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 4,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_ATOMIC_03",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 5,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "VARC_RC_03",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 6,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_RC_04",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 7,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "VARC_ATOMIC_04",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 8,
      "content_layout": "single_focus"
    },
    {
      "client_set_id": "LRDI_SET_01",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 1,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "LRDI_SET_02",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 2,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "LRDI_SET_03",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 3,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "LRDI_SET_04",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 4,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "LRDI_SET_05",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 5,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "client_set_id": "QA_ATOMIC_01",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 1,
      "content_layout": "single_focus"
    }
  ],
  "questions": [
    {
      "client_question_id": "VARC_Q01",
      "question_number": 1,
      "sequence_order": 1,
      "question_type": "MCQ",
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "correct_answer": "<ANSWER_OMITTED>",
      "topic": "Verbal Ability",
      "subtopic": "Paragraph Completion",
      "difficulty": "hard",
      "solution_text": "<SOLUTION_TEXT_OMITTED>",
      "options": [
        {
          "id": "A",
          "text": "<TEXT_OMITTED>"
        },
        {
          "_NOTE": "... 3 more items omitted (total: 4) ..."
        }
      ],
      "set_ref": "VARC_ATOMIC_01",
      "section": "VARC"
    },
    {
      "_NOTE": "... 67 more items omitted (total: 68) ..."
    }
  ]
}
````

## File: data_sanitized/CAT-2025-Slot-3-v3.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ schema_version: string, paper: object, question_sets: object, questions: object }",
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "CAT_2025_SLOT3",
    "title": "CAT 2025 Slot 3",
    "slug": "cat-2025-slot-3",
    "description": "Converted from PDF. Advertisements removed. Tables converted to Markdown. Answers mapped from key.",
    "year": 2025,
    "total_questions": 68,
    "total_marks": 198,
    "duration_minutes": 120,
    "sections": [
      "VARC",
      "DILR",
      "QA"
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "cat-level",
    "is_free": true,
    "published": false,
    "allow_pause": true,
    "attempt_limit": 0
  },
  "question_sets": [
    {
      "section": "VARC",
      "client_set_id": "VARC_PJ_01",
      "set_type": "ATOMIC",
      "display_order": 1,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          2
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_SUM_02",
      "set_type": "ATOMIC",
      "display_order": 2,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          2
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_RC_01",
      "set_type": "VARC",
      "display_order": 3,
      "content_layout": "split_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          2,
          3
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_MS_03",
      "set_type": "ATOMIC",
      "display_order": 4,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          4
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_PJ_04",
      "set_type": "ATOMIC",
      "display_order": 5,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          4
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_RC_02",
      "set_type": "VARC",
      "display_order": 6,
      "content_layout": "split_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          5,
          6
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_PJ_05",
      "set_type": "ATOMIC",
      "display_order": 7,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          6
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_PJ_06",
      "set_type": "ATOMIC",
      "display_order": 8,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          6,
          7
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_MS_07",
      "set_type": "ATOMIC",
      "display_order": 9,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          7
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_RC_03",
      "set_type": "VARC",
      "display_order": 10,
      "content_layout": "split_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          7,
          8
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_SUM_08",
      "set_type": "ATOMIC",
      "display_order": 11,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          9
        ]
      }
    },
    {
      "section": "VARC",
      "client_set_id": "VARC_RC_04",
      "set_type": "VARC",
      "display_order": 12,
      "content_layout": "split_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          9,
          10
        ]
      }
    },
    {
      "section": "DILR",
      "client_set_id": "DILR_CIRCULAR_01",
      "set_type": "DILR",
      "display_order": 1,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>"
    },
    {
      "section": "DILR",
      "client_set_id": "DILR_TRAVEL_02",
      "set_type": "DILR",
      "display_order": 2,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          13
        ]
      }
    },
    {
      "section": "DILR",
      "client_set_id": "DILR_PUZZLE_03",
      "set_type": "DILR",
      "display_order": 3,
      "content_layout": "split_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          14
        ]
      }
    },
    {
      "section": "DILR",
      "client_set_id": "DILR_TRADE_04",
      "set_type": "DILR",
      "display_order": 4,
      "content_layout": "split_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          15
        ]
      }
    },
    {
      "section": "DILR",
      "client_set_id": "DILR_MOBILE_05",
      "set_type": "DILR",
      "display_order": 5,
      "content_layout": "split_focus",
      "context_type": "<CONTEXT_TYPE_OMITTED>",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          16
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_47",
      "set_type": "ATOMIC",
      "display_order": 1,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          16,
          17
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_48",
      "set_type": "ATOMIC",
      "display_order": 2,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          17
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_49",
      "set_type": "ATOMIC",
      "display_order": 3,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          18
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_50",
      "set_type": "ATOMIC",
      "display_order": 4,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          18
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_51",
      "set_type": "ATOMIC",
      "display_order": 5,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          18
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_52",
      "set_type": "ATOMIC",
      "display_order": 6,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          19
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_53",
      "set_type": "ATOMIC",
      "display_order": 7,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          19
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_54",
      "set_type": "ATOMIC",
      "display_order": 8,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          19
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_55",
      "set_type": "ATOMIC",
      "display_order": 9,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          20
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_56",
      "set_type": "ATOMIC",
      "display_order": 10,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          20
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_57",
      "set_type": "ATOMIC",
      "display_order": 11,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          21
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_58",
      "set_type": "ATOMIC",
      "display_order": 12,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          21
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_59",
      "set_type": "ATOMIC",
      "display_order": 13,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          21
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_60",
      "set_type": "ATOMIC",
      "display_order": 14,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          22
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_61",
      "set_type": "ATOMIC",
      "display_order": 15,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          22
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_62",
      "set_type": "ATOMIC",
      "display_order": 16,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          22
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_63",
      "set_type": "ATOMIC",
      "display_order": 17,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          23
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_64",
      "set_type": "ATOMIC",
      "display_order": 18,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          23
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_65",
      "set_type": "ATOMIC",
      "display_order": 19,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          23
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_66",
      "set_type": "ATOMIC",
      "display_order": 20,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          23
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_67",
      "set_type": "ATOMIC",
      "display_order": 21,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          24
        ]
      }
    },
    {
      "section": "QA",
      "client_set_id": "QA_ATOMIC_68",
      "set_type": "ATOMIC",
      "display_order": 22,
      "content_layout": "single_focus",
      "context_title": "<CONTEXT_TITLE_OMITTED>",
      "context_body": "<CONTEXT_BODY_OMITTED>",
      "metadata": {
        "source_pages": [
          24
        ]
      }
    }
  ],
  "questions": [
    {
      "set_ref": "VARC_PJ_01",
      "section": "VARC",
      "client_question_id": "VARC_PJ_01_Q01",
      "question_number": 1,
      "sequence_order": 1,
      "question_type": "TITA",
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "options": null,
      "correct_answer": "<ANSWER_OMITTED>",
      "solution_text": "<SOLUTION_TEXT_OMITTED>",
      "topic": "Verbal Ability",
      "subtopic": "Odd One Out",
      "difficulty": "medium",
      "positive_marks": 3,
      "negative_marks": 0
    },
    {
      "_NOTE": "... 67 more items omitted (total: 68) ..."
    }
  ]
}
````

## File: data_sanitized/paper_schema_v3.template.json
````json
{
    "schema_version": "v3.0",
    "paper": {
        "paper_key": "cat-2024-slot-1",
        "title": "CAT 2024 Slot 1",
        "slug": "cat-2024-slot-1",
        "description": "Official CAT 2024 Slot 1 Question Paper",
        "year": 2024,
        "total_questions": 66,
        "total_marks": 198,
        "duration_minutes": 120,
        "sections": [
            "VARC",
            "DILR",
            "QA"
        ],
        "default_positive_marks": 3,
        "default_negative_marks": 1,
        "difficulty_level": "hard",
        "is_free": false,
        "published": false,
        "allow_pause": true,
        "attempt_limit": 0
    },
    "question_sets": [
        {
            "client_set_id": "VARC_RC_1",
            "section": "VARC",
            "set_type": "VARC",
            "display_order": 1,
            "context_type": "rc_passage",
            "context_title": "Reading Comprehension Passage 1",
            "context_body": "The passage text goes here. This is a reading comprehension passage that multiple questions will reference. It can contain **Markdown** formatting and $KaTeX$ math expressions.\n\nParagraph 2 of the passage continues here with more content for students to analyze.",
            "content_layout": "text_only"
        },
        {
            "client_set_id": "VARC_RC_2",
            "section": "VARC",
            "set_type": "VARC",
            "display_order": 2,
            "context_type": "rc_passage",
            "context_title": "Reading Comprehension Passage 2",
            "context_body": "Another passage for reading comprehension. This demonstrates that each RC passage is a separate question_set with its own client_set_id."
        },
        {
            "client_set_id": "VARC_ATOMIC_1",
            "section": "VARC",
            "set_type": "ATOMIC",
            "display_order": 3
        },
        {
            "client_set_id": "DILR_SET_1",
            "section": "DILR",
            "set_type": "DILR",
            "display_order": 1,
            "context_type": "dilr_set",
            "context_title": "Data Interpretation Set 1",
            "context_body": "Table showing sales data for Company XYZ:\n\n| Year | Revenue | Profit |\n|------|---------|--------|\n| 2020 | 100     | 10     |\n| 2021 | 120     | 15     |\n| 2022 | 150     | 20     |",
            "context_image_url": "https://example.com/chart.png"
        },
        {
            "client_set_id": "QA_ATOMIC_1",
            "section": "QA",
            "set_type": "ATOMIC",
            "display_order": 1
        },
        {
            "client_set_id": "QA_ATOMIC_2",
            "section": "QA",
            "set_type": "ATOMIC",
            "display_order": 2
        }
    ],
    "questions": [
        {
            "client_question_id": "Q1",
            "set_ref": "VARC_RC_1",
            "sequence_order": 1,
            "section": "VARC",
            "question_number": 1,
            "question_text": "What is the main argument presented in the passage?",
            "question_type": "MCQ",
            "taxonomy_type": "rc_main_idea",
            "options": [
                {
                    "id": "A",
                    "text": "Option A text"
                },
                {
                    "id": "B",
                    "text": "Option B text"
                },
                {
                    "id": "C",
                    "text": "Option C text"
                },
                {
                    "id": "D",
                    "text": "Option D text"
                }
            ],
            "correct_answer": "B",
            "positive_marks": 3,
            "negative_marks": 1,
            "difficulty": "medium",
            "topic": "Reading Comprehension",
            "solution_text": "The correct answer is B because the passage explicitly states..."
        },
        {
            "client_question_id": "Q2",
            "set_ref": "VARC_RC_1",
            "sequence_order": 2,
            "section": "VARC",
            "question_number": 2,
            "question_text": "Which of the following can be inferred from paragraph 2?",
            "question_type": "MCQ",
            "taxonomy_type": "rc_inference",
            "options": [
                {
                    "id": "A",
                    "text": "Inference option A"
                },
                {
                    "id": "B",
                    "text": "Inference option B"
                },
                {
                    "id": "C",
                    "text": "Inference option C"
                },
                {
                    "id": "D",
                    "text": "Inference option D"
                }
            ],
            "correct_answer": "C",
            "positive_marks": 3,
            "negative_marks": 1,
            "difficulty": "hard"
        },
        {
            "client_question_id": "Q3",
            "set_ref": "VARC_RC_2",
            "sequence_order": 1,
            "section": "VARC",
            "question_number": 3,
            "question_text": "The author's tone in the passage can best be described as:",
            "question_type": "MCQ",
            "taxonomy_type": "rc_tone",
            "options": [
                {
                    "id": "A",
                    "text": "Optimistic"
                },
                {
                    "id": "B",
                    "text": "Critical"
                },
                {
                    "id": "C",
                    "text": "Neutral"
                },
                {
                    "id": "D",
                    "text": "Pessimistic"
                }
            ],
            "correct_answer": "B",
            "positive_marks": 3,
            "negative_marks": 1,
            "difficulty": "medium"
        },
        {
            "client_question_id": "Q4",
            "set_ref": "VARC_ATOMIC_1",
            "sequence_order": 1,
            "section": "VARC",
            "question_number": 4,
            "question_text": "The four sentences (labelled 1, 2, 3, 4) given below...\n\n1. First sentence here.\n2. Second sentence here.\n3. Third sentence here.\n4. Fourth sentence here.\n\nArrange in proper sequence:",
            "question_type": "TITA",
            "taxonomy_type": "para_jumble",
            "correct_answer": "3142",
            "positive_marks": 3,
            "negative_marks": 0,
            "difficulty": "medium",
            "topic": "Para Jumbles"
        },
        {
            "client_question_id": "Q5",
            "set_ref": "DILR_SET_1",
            "sequence_order": 1,
            "section": "DILR",
            "question_number": 5,
            "question_text": "What was the percentage increase in revenue from 2020 to 2022?",
            "question_type": "TITA",
            "taxonomy_type": "di_percentage",
            "correct_answer": "50",
            "positive_marks": 3,
            "negative_marks": 0,
            "difficulty": "easy",
            "topic": "Data Interpretation",
            "solution_text": "Increase = (150-100)/100 × 100 = 50%"
        },
        {
            "client_question_id": "Q6",
            "set_ref": "DILR_SET_1",
            "sequence_order": 2,
            "section": "DILR",
            "question_number": 6,
            "question_text": "In which year was the profit margin highest?",
            "question_type": "MCQ",
            "taxonomy_type": "di_comparison",
            "options": [
                {
                    "id": "A",
                    "text": "2020"
                },
                {
                    "id": "B",
                    "text": "2021"
                },
                {
                    "id": "C",
                    "text": "2022"
                },
                {
                    "id": "D",
                    "text": "Cannot be determined"
                }
            ],
            "correct_answer": "C",
            "positive_marks": 3,
            "negative_marks": 1,
            "difficulty": "medium"
        },
        {
            "client_question_id": "Q7",
            "set_ref": "QA_ATOMIC_1",
            "sequence_order": 1,
            "section": "QA",
            "question_number": 7,
            "question_text": "If $x^2 + y^2 = 25$ and $xy = 12$, find the value of $(x + y)^2$.",
            "question_type": "TITA",
            "taxonomy_type": "algebra_equations",
            "correct_answer": "49",
            "positive_marks": 3,
            "negative_marks": 0,
            "difficulty": "medium",
            "topic": "Algebra",
            "subtopic": "Quadratic Equations",
            "solution_text": "$(x+y)^2 = x^2 + 2xy + y^2 = 25 + 2(12) = 49$"
        },
        {
            "client_question_id": "Q8",
            "set_ref": "QA_ATOMIC_2",
            "sequence_order": 1,
            "section": "QA",
            "question_number": 8,
            "question_text": "A train traveling at 60 km/h crosses a platform in 30 seconds...",
            "question_type": "MCQ",
            "taxonomy_type": "arithmetic_speed",
            "options": [
                {
                    "id": "A",
                    "text": "200 meters"
                },
                {
                    "id": "B",
                    "text": "250 meters"
                },
                {
                    "id": "C",
                    "text": "300 meters"
                },
                {
                    "id": "D",
                    "text": "350 meters"
                }
            ],
            "correct_answer": "C",
            "positive_marks": 3,
            "negative_marks": 1,
            "difficulty": "easy",
            "topic": "Arithmetic",
            "subtopic": "Time, Speed, Distance"
        }
    ]
}
````

## File: data_sanitized/sample-paper-template.json
````json
{
  "_SCHEMA_NOTE": "This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.",
  "_ORIGINAL_STRUCTURE": "{ paper: object, questions: object }",
  "paper": {
    "slug": "cat-2024-mock-2",
    "title": "CAT 2024 Mock Test 2",
    "description": "Full-length CAT mock test following the 2024 pattern with 66 questions across VARC, DILR, and QA sections.",
    "year": 2024,
    "total_questions": 66,
    "total_marks": 198,
    "duration_minutes": 120,
    "sections": [
      {
        "name": "VARC",
        "questions": 24,
        "time": 40,
        "marks": 72
      },
      {
        "name": "DILR",
        "questions": 20,
        "time": 40,
        "marks": 60
      },
      {
        "name": "QA",
        "questions": 22,
        "time": 40,
        "marks": 66
      }
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "cat-level",
    "is_free": true,
    "published": false,
    "available_from": null,
    "available_until": null
  },
  "questions": [
    {
      "section": "VARC",
      "question_number": 1,
      "question_text": "<QUESTION_TEXT_OMITTED>",
      "question_type": "MCQ",
      "options": [
        "Option A text",
        "Option B text",
        "Option C text",
        "Option D text"
      ],
      "correct_answer": "<ANSWER_OMITTED>",
      "positive_marks": 3,
      "negative_marks": 1,
      "difficulty": "medium",
      "topic": "Reading Comprehension",
      "subtopic": "Main Idea",
      "solution_text": "<SOLUTION_TEXT_OMITTED>"
    },
    {
      "_NOTE": "... 5 more items omitted (total: 6) ..."
    }
  ]
}
````

## File: docs/migrations/025_is_admin_safe.sql
````sql
-- ============================================================================
-- Migration 025: Harden is_admin() to fail closed without throwing
-- ============================================================================
-- Purpose:
--   Prevent RLS policy evaluation from erroring if user_roles table (or RBAC)
--   has not been applied in a given environment. This returns FALSE on any
--   exception, avoiding 500s and failing closed.
-- ============================================================================

CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN
LANGUAGE plpgsql
STABLE
SECURITY DEFINER
SET search_path = public, pg_catalog
AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1
        FROM public.user_roles
        WHERE user_id = auth.uid()
          AND role IN ('admin', 'dev')
    );
EXCEPTION
    WHEN undefined_table THEN
        RETURN FALSE;
    WHEN others THEN
        RETURN FALSE;
END;
$$;

GRANT EXECUTE ON FUNCTION public.is_admin() TO authenticated;
````

## File: knip.json
````json
{
    "$schema": "https://unpkg.com/knip@5/schema.json",
    "project": [
        "tsconfig.json"
    ],
    "entry": [
        "middleware.ts",
        "src/app/**/*.{ts,tsx}",
        "src/features/**/*.{ts,tsx}",
        "src/lib/**/*.ts",
        "src/types/**/*.ts"
    ],
    "ignore": [
        "**/*.test.*",
        "**/*.spec.*",
        "**/node_modules/**",
        ".next/**",
        "dist/**",
        "build/**"
    ],
    "ignoreDependencies": [
        "@types/*"
    ]
}
````

## File: paper_v3.json
````json
{
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "cat-2022-slot-1",
    "title": "CAT 2022 Slot 1",
    "slug": "cat-2022-slot-1",
    "description": "Official CAT 2022 Slot 1 Question Paper inferred from content",
    "year": 2022,
    "total_questions": 66,
    "total_marks": 198,
    "duration_minutes": 120,
    "sections": [
      "VARC",
      "DILR",
      "QA"
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "medium",
    "is_free": false,
    "published": false,
    "allow_pause": true,
    "attempt_limit": 0
  },
  "question_sets": [
    {
      "client_set_id": "VARC_RC_1",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 1,
      "context_type": "rc_passage",
      "context_title": "Stoicism & Emotions",
      "content_layout": "split_passage",
      "context_body": "Stoicism was founded in 300 BC by the Greek philosopher Zeno and survived into the Roman era until about AD 300\\. According to the Stoics, emotions consist of two movements. The first movement is the immediate feeling and other reactions (e.g., physiological response) that occur when a stimulus or event occurs. For instance, consider what could have happened if an army general accused Marcus Aurelius of treason in front of other officers. The first movement for Marcus may have been (internal) surprise and anger in response to this insult, accompanied perhaps by some involuntary physiological and expressive responses such as face flushing and a movement of the eyebrows. The second movement is what one does next about the emotion. Second movement behaviors occur after thinking and are under one’s control. Examples of second movements for Marcus might have included a plot to seek revenge, actions signifying deference and appeasement, or perhaps proceeding as he would have proceeded whether or not this event occurred: continuing to lead the Romans in a way that Marcus Aurelius believed best benefited them. In the Stoic view, choosing a reasoned, unemotional response as the second movement is the only appropriate response.\nThe Stoics believed that to live the good life and be a good person, we need to free ourselves of nearly all desires such as too much desire for money, power, or sexual gratification. Prior to second movements, we can consider what is important in life. Money, power, and excessive sexual gratification are not important. Character, rationality, and kindness are important. The Epicureans, first associated with the Greek philosopher Epicurus . . . held a similar view, believing that people should enjoy simple pleasures, such as good conversation, friendship, food, and wine, but not be indulgent in these pursuits and not follow passion for those things that hold no real value like power and money. As Oatley (2004) states, “the Epicureans articulated a view —enjoyment of relationship with friends, of things that are real rather than illusory, simple rather than artificially inflated, possible rather than vanishingly unlikely—that is certainly relevant today” . . .\nIn sum, these ancient Greek and Roman philosophers saw emotions, especially strong ones, as potentially dangerous. They viewed emotions as experiences that needed to be \\[reined\\] in and controlled. As Oatley (2004) points out, the Stoic idea bears some similarity to Buddhism. Buddha, living in India in the 6th century BC, argued for cultivating a certain attitude that decreases the probability of (in Stoic terms) destructive second movements. Through meditation and the right attitude, one allows emotions to happen to oneself (it is impossible to prevent this), but one is advised to observe the emotions without necessarily acting on them; one achieves some distance and decides what has value and what does not have value. Additionally, the Stoic idea of developing virtue in oneself, of becoming a good person, which the Stoics believed we could do because we have a touch of the divine, laid the foundation for the three monotheistic religions: Judaism, Christianity, and Islam . . . As with Stoicism, tenets of these religions include controlling our emotions lest we engage in sinful behavior."
    },
    {
      "client_set_id": "VARC_RC_2",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 2,
      "context_type": "rc_passage",
      "context_title": "Copies (East vs West)",
      "content_layout": "split_passage",
      "context_body": "The Chinese have two different concepts of a copy. Fangzhipin . . . are imitations where the difference from the original is obvious. These are small models or copies that can be purchased in a museum shop, for example. The second concept for a copy is fuzhipin . . . They are exact reproductions of the original, which, for the Chinese, are of equal value to the original. It has absolutely no negative connotations. The discrepancy with regard to the understanding of what a copy is has often led to misunderstandings and arguments between China and Western museums. The Chinese often send copies abroad instead of originals, in the firm belief that they are not essentially different from the originals. The rejection that then comes from the Western museums is perceived by the Chinese as an insult. . . .\nThe Far Eastern notion of identity is also very confusing to the Western observer. The Ise Grand Shrine \\[in Japan\\] is 1,300 years old for the millions of Japanese people who go there on pilgrimage every year. But in reality this temple complex is completely rebuilt from scratch every 20 years. . . . The cathedral of Freiburg Minster in southwest Germany is covered in scaffolding almost all year round. The sandstone from which it is built is a very soft, porous material that does not withstand natural erosion by rain and wind. After a while, it crumbles. As a result, the cathedral is continually being examined for damage, and eroded stones are replaced. And in the cathedral’s dedicated workshop, copies of the damaged sandstone figures are constantly being produced. Of course, attempts are made to preserve the stones from the Middle Ages for as long as possible. But at some point they, too, are removed and replaced with new stones. Fundamentally, this is the same operation as with the Japanese shrine, except in this case the production of a replica takes place very slowly and over long periods of time. . . .\nIn the field of art as well, the idea of an unassailable original developed historically in the Western world. Back in the 17th century \\[in the West\\], excavated artworks from antiquity were treated quite differently from today. They were not restored in a way that was faithful to the original. Instead, there was massive intervention in these works, changing their appearance. . . . It is probably this intellectual position that explains why Asians have far fewer scruples about cloning than Europeans. The South Korean cloning researcher Hwang Woo-suk, who attracted worldwide attention with his cloning experiments in 2004, is a Buddhist. He found a great deal of support and followers among Buddhists, while Christians called for a ban on human cloning. . . . Hwang legitimised his cloning experiments with his religious affiliation: ‘I am Buddhist, and I have no philosophical problem with cloning. And as you know, the basis of Buddhism is that life is recycled through reincarnation. In some ways, I think, therapeutic cloning restarts the circle of life.’"
    },
    {
      "client_set_id": "VARC_RC_3",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 3,
      "context_type": "rc_passage",
      "context_title": "The Undead",
      "content_layout": "split_passage",
      "context_body": "Stories concerning the Undead have always been with us. From out of the primal darkness of Mankind’s earliest years, come whispers of eerie creatures, not quite alive (or alive in a way which we can understand), yet not quite dead either. These may have been ancient and primitive deities who dwelt deep in the surrounding forests and in remote places, or simply those deceased who refused to remain in their tombs and who wandered about the countryside, physically tormenting and frightening those who were still alive. Mostly they were ill-defined—strange sounds in the night beyond the comforting glow of the fire, or a shape, half-glimpsed in the twilight along the edge of an encampment. They were vague and indistinct, but they were always there with the power to terrify and disturb. They had the power to touch the minds of our early ancestors and to fill them with dread. Such fear formed the basis of the earliest tales although the source and exact nature of such terrors still remained very vague.\nAnd as Mankind became more sophisticated, leaving the gloom of their caves and forming themselves into recognizable communities—towns, cities, whole cultures—so the Undead travelled with them, inhabiting their folklore just as they had in former times. Now they began to take on more definite shapes. They became walking cadavers; the physical embodiment of former deities and things which had existed alongside Man since the Creation. Some still remained vague and ill-defined but, as Mankind strove to explain the horror which it felt towards them, such creatures emerged more readily into the light. In order to confirm their abnormal status, many of the Undead were often accorded attributes, which defied the natural order of things—the power to transform themselves into other shapes, the ability to sustain themselves by drinking human blood, and the ability to influence human minds across a distance. Such powers—described as supernatural—only \\[lent\\] an added dimension to the terror that humans felt regarding them.\nAnd it was only natural, too, that the Undead should become connected with the practice of magic. From very early times, Shamans and witchdoctors had claimed at least some power and control over the spirits of departed ancestors, and this has continued down into more “civilized” times. Formerly, the invisible spirits and forces that thronged around men’s earliest encampments, had spoken “through” the tribal Shamans but now, as entities in their own right, they were subject to magical control and could be physically summoned by a competent sorcerer. However, the relationship between the magician and an Undead creature was often a very tenuous and uncertain one. Some sorcerers might have even become Undead entities once they died, but they might also have been susceptible to the powers of other magicians when they did. From the Middle Ages and into the Age of Enlightenment, theories of the Undead continued to grow and develop. Their names became more familiar—werewolf, vampire, ghoul—each one certain to strike fear into the hearts of ordinary humans."
    },
    {
      "client_set_id": "VARC_RC_4",
      "section": "VARC",
      "set_type": "VARC",
      "display_order": 4,
      "context_type": "rc_passage",
      "context_title": "Critical Theory of Technology",
      "content_layout": "split_passage",
      "context_body": "Critical theory of technology is a political theory of modernity with a normative dimension. It belongs to a tradition extending from Marx to Foucault and Habermas according to which advances in the formal claims of human rights take center stage while in the background centralization of ever more powerful public institutions and private organizations imposes an authoritarian social order. Marx attributed this trajectory to the capitalist rationalization of production. Today it marks many institutions besides the factory and every modern political system, including so-called socialist systems. This trajectory arose from the problems of command over a disempowered and deskilled labor force; but everywhere \\[that\\] masses are organized \\- whether it be Foucault’s prisons or Habermas’s public sphere \\- the same pattern prevails. Technological design and development is shaped by this pattern as the material base of a distinctive social order. Marcuse would later point to a “project” as the basis of what he called rather confusingly “technological rationality.” Releasing technology from this project is a democratic political task.\nIn accordance with this general line of thought, critical theory of technology regards technologies as an environment rather than as a collection of tools. We live today with and even within technologies that determine our way of life. Along with the constant pressures to build centers of power, many other social values and meanings are inscribed in technological design. A hermeneutics of technology must make explicit the meanings implicit in the devices we use and the rituals they script. Social histories of technologies such as the bicycle, artificial lighting or firearms have made important contributions to this type of analysis. Critical theory of technology attempts to build a methodological approach on the lessons of these histories.\nAs an environment, technologies shape their inhabitants. In this respect, they are comparable to laws and customs. Each of these institutions can be said to represent those who live under their sway through privileging certain dimensions of their human nature. Laws of property represent the interest in ownership and control. Customs such as parental authority represent the interest of childhood in safety and growth. Similarly, the automobile represents its users in so far as they are interested in mobility. Interests such as these constitute the version of human nature sanctioned by society.\nThis notion of representation does not imply an eternal human nature. The concept of nature as non-identity in the Frankfurt School suggests an alternative. On these terms, nature is what lies at the limit of history, at the point at which society loses the capacity to imprint its meanings on things and control them effectively. The reference here is, of course, not to the nature of natural science, but to the lived nature in which we find ourselves and which we are. This nature reveals itself as that which cannot be totally encompassed by the machinery of society. For the Frankfurt School, human nature, in all its transcending force, emerges out of a historical context as that context is \\[depicted\\] in illicit joys, struggles and pathologies. We can perhaps admit a less romantic . . . conception in which those dimensions of human nature recognized by society are also granted theoretical legitimacy."
    },
    {
      "client_set_id": "VARC_ATOMIC_1",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 5
    },
    {
      "client_set_id": "DILR_SET_1",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 1,
      "context_type": "dilr_set",
      "context_title": "Hockey Players",
      "content_layout": "split_table",
      "context_body": "The management of a university hockey team was evaluating performance of four women players \\- Amla, Bimla, Harita and Sarita for their possible selection in the university team for next year. For this purpose, the management was looking at the number of goals scored by them in the past 8 matches, numbered 1 through 8\\. The four players together had scored a total of 12 goals in these matches. In the 8 matches, each of them had scored at least one goal. No two players had scored the same total number of goals. The following facts are known about the goals scored by these four players only:\n1\\. Only one goal was scored in every even numbered match.\n2\\. Harita scored more goals than Bimla.\n3\\. The highest goal scorer scored goals in exactly 3 matches including Match 4 and Match 8\\.\n4\\. Bimla scored a goal in Match 1 and one each in three other consecutive matches.\n5\\. An equal number of goals were scored in Match 3 and Match 7, which was different from the number of goals scored in either Match 1 or Match 5\\.\n6\\. The match in which the highest number of goals was scored was unique and it was not Match 5\\."
    },
    {
      "client_set_id": "DILR_SET_2",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 2,
      "context_type": "dilr_set",
      "context_title": "Class Get-Together",
      "content_layout": "split_table",
      "context_body": "There are 15 girls and some boys among the graduating students in a class. They are planning a get-together, which can be either a 1-day event, or a 2-day event, or a 3-day event. There are 6 singers in the class, 4 of them are boys. There are 10 dancers in the class, 4 of them are girls. No dancer in the class is a singer. Some students are not interested in attending the get-together. Those students who are interested in attending a 3-day event are also interested in attending a 2-day event; those who are interested in attending a 2-day event are also interested in attending a 1-day event. The following facts are also known:\n1\\. All the girls and 80% of the boys are interested in attending a 1-day event. 60% of the boys are interested in attending a 2-day event.\n2\\. Some of the girls are interested in attending a 1-day event, but not a 2-day event; some of the other girls are interested in attending both.\n3\\. 70% of the boys who are interested in attending a 2-day event are neither singers nor dancers. 60% of the girls who are interested in attending a 2-day event are neither singers nor dancers.\n4\\. No girl is interested in attending a 3-day event. All male singers and 2 of the dancers are interested in attending a 3-day event.\n5\\. The number of singers interested in attending a 2-day event is one more than the number of dancers interested in attending a 2-day event."
    },
    {
      "client_set_id": "DILR_SET_3",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 3,
      "context_type": "dilr_set",
      "context_title": "Funding Tokens",
      "content_layout": "split_table",
      "context_body": "Adhara, Bithi, Chhaya, Dhanavi, Esther, and Fathima are the interviewers in a process that awards funding for new initiatives. Every interviewer individually interviews each of the candidates individually and awards a token only if she recommends funding. A token has a face value of 2, 3, 5, 7, 11, or 13\\. Each interviewer awards tokens of a single face value only. Once all six interviews are over for a candidate, the candidate receives a funding that is Rs.1000 times the product of the face values of all the tokens. For example, if a candidate has tokens with face values 2, 5, and 7, then they get a funding of Rs.1000 × (2 × 5 × 7\\) \\= Rs.70,000. Pragnyaa, Qahira, Rasheeda, Smera, and Tantra were five candidates who received funding. The funds they received, in descending order, were Rs.390,000, Rs.210,000, Rs.165,000, Rs.77,000, and Rs.66,000. The following additional facts are known:\n1\\. Fathima awarded tokens to everyone except Qahira, while Adhara awarded tokens to no one except Pragnyaa.\n2\\. Rasheeda received the highest number of tokens that anyone received, but she did not receive one from Esther.\n3\\. Bithi awarded a token to Smera but not to Qahira, while Dhanavi awarded a token to Qahira but not to Smera."
    },
    {
      "client_set_id": "DILR_SET_4",
      "section": "DILR",
      "set_type": "DILR",
      "display_order": 4,
      "context_type": "dilr_set",
      "context_title": "Metro Services",
      "content_layout": "split_table",
      "context_body": "Given above is the schematic map of the metro lines in a city with rectangles denoting terminal stations (e.g. A), diamonds denoting junction stations (e.g. R) and small filled-up circles denoting other stations. Each train runs either in east-west or north-south direction, but not both. All trains stop for 2 minutes at each of the junction stations on the way and for 1 minute at each of the other stations. It takes 2 minutes to reach the next station for trains going in east-west direction and 3 minutes to reach the next station for trains going in north-south direction. From each terminal station, the first train starts at 6 am; the last trains leave the terminal stations at midnight. Otherwise, during the service hours, there are metro service every 15 minutes in the north-south lines and every 10 minutes in the east-west lines. A train must rest for at least 15 minutes after completing a trip at the terminal station, before it can undertake the next trip in the reverse direction. (All questions are related to this metro service only. Assume that if someone reaches a station exactly at the time a train is supposed to leave, (s)he can catch that train.)"
    },
    {
      "client_set_id": "QA_ATOMIC_1",
      "section": "QA",
      "set_type": "ATOMIC",
      "display_order": 1
    }
  ],
  "questions": [
    {
      "client_question_id": "cat_2022_slot_1_Q1",
      "set_ref": "VARC_RC_1",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 1,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Inference & Conclusion",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "“Through meditation and the right attitude, one allows emotions to happen to oneself (it is impossible to prevent this), but one is advised to observe the emotions without necessarily acting on them; one achieves some distance and decides what has value and what does not have value.”\nIn the context of the passage, which one of the following is not a possible implication of the quoted statement?",
      "options": [
        {
          "id": "A",
          "text": "“Meditation and the right attitude”, in this instance, implies an initially passive reception of all experiences."
        },
        {
          "id": "B",
          "text": "Meditation allows certain out-of-body experiences that permit us to gain the distance necessary to control our emotions."
        },
        {
          "id": "C",
          "text": "The observation of emotions in a distant manner corresponds to the second movement referred to earlier in the passage."
        },
        {
          "id": "D",
          "text": "Emotional responses can make it difficult to distinguish valuable experiences from valueless experiences."
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q2",
      "set_ref": "VARC_RC_1",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 2,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Inference & Conclusion",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following statements would be an accurate inference from the example of Marcus Aurelius?",
      "options": [
        {
          "id": "A",
          "text": "Marcus Aurelius was humiliated by the accusation of treason in front of the other officers."
        },
        {
          "id": "B",
          "text": "Marcus Aurelius was a Stoic whose philosophy survived into the Roman era."
        },
        {
          "id": "C",
          "text": "Marcus Aurelius plotted revenge in his quest for justice."
        },
        {
          "id": "D",
          "text": "Marcus Aurelius was one of the leaders of the Roman army."
        }
      ],
      "solution_text": "The correct answer is D."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q3",
      "set_ref": "VARC_RC_1",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 3,
      "question_type": "MCQ",
      "taxonomy_type": "rc_detail",
      "topic": "Reading Comprehension",
      "subtopic": "Fact-Based / Specific Detail",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following statements, if false, could be seen as contradicting the facts/arguments in the passage?",
      "options": [
        {
          "id": "A",
          "text": "Despite practising meditation and cultivating the right attitude, emotions cannot ever be controlled."
        },
        {
          "id": "B",
          "text": "The Greek philosopher Zeno survived into the Roman era until about AD 300\\."
        },
        {
          "id": "C",
          "text": "In the Epicurean view, indulging in simple pleasures is not desirable."
        },
        {
          "id": "D",
          "text": "In the Stoic view, choosing a reasoned, unemotional response as the first movement is an appropriate response to emotional situations."
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q4",
      "set_ref": "VARC_RC_1",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 4,
      "question_type": "MCQ",
      "taxonomy_type": "rc_detail",
      "topic": "Reading Comprehension",
      "subtopic": "Fact-Based / Specific Detail",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "On the basis of the passage, which one of the following statements can be regarded as true?",
      "options": [
        {
          "id": "A",
          "text": "The Stoics valorised the pursuit of money, power, and sexual gratification."
        },
        {
          "id": "B",
          "text": "The Stoic influences can be seen in multiple religions."
        },
        {
          "id": "C",
          "text": "The Epicureans believed in controlling all emotions."
        },
        {
          "id": "D",
          "text": "There were no Stoics in India at the time of the Roman civilisation."
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q5",
      "set_ref": "VARC_RC_2",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 5,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Inference & Conclusion",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Based on the passage, which one of the following copies would a Chinese museum be unlikely to consider as having less value than the original?",
      "options": [
        {
          "id": "A",
          "text": "Pablo Picasso’s painting of Vincent van Gogh’s original painting, bearing Picasso’s signature."
        },
        {
          "id": "B",
          "text": "Pablo Picasso’s painting of Vincent van Gogh’s original painting, identical in every respect."
        },
        {
          "id": "C",
          "text": "Pablo Picasso’s photograph of Vincent van Gogh’s original painting, printed to exactly the same scale."
        },
        {
          "id": "D",
          "text": "Pablo Picasso’s miniaturised, but otherwise faithful and accurate painting of Vincent van Gogh’s original painting."
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q6",
      "set_ref": "VARC_RC_2",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 6,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Inference & Conclusion",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following scenarios is unlikely to follow from the arguments in the passage?",
      "options": [
        {
          "id": "A",
          "text": "A 17th-century British painter would have no problem adding personal touches when restoring an ancient Roman painting."
        },
        {
          "id": "B",
          "text": "A 20th-century Japanese Buddhist monk would value a reconstructed shrine as the original."
        },
        {
          "id": "C",
          "text": "A 17th-century French artist who adhered to a Christian worldview would need to be completely true to the original intent of a painting when restoring it."
        },
        {
          "id": "D",
          "text": "A 21st-century Christian scientist is likely to oppose cloning because of his philosophical orientation."
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q7",
      "set_ref": "VARC_RC_2",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 7,
      "question_type": "MCQ",
      "taxonomy_type": "rc_detail",
      "topic": "Reading Comprehension",
      "subtopic": "Fact-Based / Specific Detail",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following statements does not correctly express the similarity between the Ise Grand Shrine and the cathedral of Freiburg Minster?",
      "options": [
        {
          "id": "A",
          "text": "Both were built as places of worship."
        },
        {
          "id": "B",
          "text": "Both can be regarded as very old structures."
        },
        {
          "id": "C",
          "text": "Both are continually undergoing restoration."
        },
        {
          "id": "D",
          "text": "Both will one day be completely rebuilt."
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q8",
      "set_ref": "VARC_RC_2",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 8,
      "question_type": "MCQ",
      "taxonomy_type": "rc_detail",
      "topic": "Reading Comprehension",
      "subtopic": "Fact-Based / Specific Detail",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The value that the modern West assigns to “an unassailable original” has resulted in all of the following EXCEPT:",
      "options": [
        {
          "id": "A",
          "text": "it discourages them from simultaneous displays of multiple copies of a painting."
        },
        {
          "id": "B",
          "text": "it allows regular employment for certain craftsmen."
        },
        {
          "id": "C",
          "text": "it discourages them from making interventions in ancient art."
        },
        {
          "id": "D",
          "text": "it discourages them from carrying out human cloning."
        }
      ],
      "solution_text": "The correct answer is D."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q9",
      "set_ref": "VARC_RC_3",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 9,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Inference & Conclusion",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "“In order to confirm their abnormal status, many of the Undead were often accorded attributes, which defied the natural order of things . . .”\nWhich one of the following best expresses the claim made in this statement?",
      "options": [
        {
          "id": "A",
          "text": "Human beings conceptualise the Undead as possessing abnormal features."
        },
        {
          "id": "B",
          "text": "The Undead are deified in nature’s order by giving them divine attributes."
        },
        {
          "id": "C",
          "text": "The natural attributes of the Undead are rendered abnormal by changing their status."
        },
        {
          "id": "D",
          "text": "According the Undead an abnormal status is to reject the natural order of things."
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q10",
      "set_ref": "VARC_RC_3",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 10,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Inference & Conclusion",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following observations is a valid conclusion to draw from the statement, “From out of the primal darkness of Mankind’s earliest years, come whispers of eerie creatures, not quite alive (or alive in a way which we can understand), yet not quite dead either.”?",
      "options": [
        {
          "id": "A",
          "text": "Mankind’s early years were marked by a belief in the existence of eerie creatures that were neither quite alive nor dead."
        },
        {
          "id": "B",
          "text": "Long ago, eerie creatures used to whisper in the primal darkness that they were not quite dead."
        },
        {
          "id": "C",
          "text": "Mankind’s primal years were marked by creatures alive with eerie whispers, but seen only in the darkness."
        },
        {
          "id": "D",
          "text": "We can understand the lives of the eerie creatures in Mankind’s early years through their whispers in the darkness."
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q11",
      "set_ref": "VARC_RC_3",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 11,
      "question_type": "MCQ",
      "taxonomy_type": "rc_main_idea",
      "topic": "Reading Comprehension",
      "subtopic": "Main Idea / Central Theme",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following statements best describes what the passage is about?",
      "options": [
        {
          "id": "A",
          "text": "The writer discusses the transition from primitive thinking to the Age of Enlightenment."
        },
        {
          "id": "B",
          "text": "The passage discusses the evolution of theories of the Undead from primitive thinking to the Age of Enlightenment."
        },
        {
          "id": "C",
          "text": "The passage describes the failure of human beings to fully comprehend their environment."
        },
        {
          "id": "D",
          "text": "The writer describes the ways in which the Undead come to be associated with Shamans and the practice of magic."
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q12",
      "set_ref": "VARC_RC_3",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 12,
      "question_type": "MCQ",
      "taxonomy_type": "rc_detail",
      "topic": "Reading Comprehension",
      "subtopic": "Fact-Based / Specific Detail",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "All of the following statements, if false, could be seen as being in accordance with the passage, EXCEPT:",
      "options": [
        {
          "id": "A",
          "text": "the Undead remained vague and ill-defined, even as Mankind strove to understand the horror they inspired."
        },
        {
          "id": "B",
          "text": "the transition from the Middle Ages to the Age of Enlightenment saw new theories of the Undead."
        },
        {
          "id": "C",
          "text": "the growing sophistication of Mankind meant that humans stopped believing in the Undead."
        },
        {
          "id": "D",
          "text": "the relationship between Shamans and the Undead was believed to be a strong and stable one."
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q13",
      "set_ref": "VARC_RC_4",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 13,
      "question_type": "MCQ",
      "taxonomy_type": "rc_main_idea",
      "topic": "Reading Comprehension",
      "subtopic": "Main Idea / Central Theme",
      "difficulty": "hard",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following statements best reflects the main argument of the fourth paragraph of the passage?",
      "options": [
        {
          "id": "A",
          "text": "Technology, laws, and customs are comparable, but dissimilar phenomena."
        },
        {
          "id": "B",
          "text": "Technological environments privilege certain dimensions of human nature as effectively as laws and customs."
        },
        {
          "id": "C",
          "text": "Automobiles represent the interest in mobility present in human nature."
        },
        {
          "id": "D",
          "text": "Technology, laws, and customs are not unlike each other if considered as institutions."
        }
      ],
      "solution_text": "The correct answer is D."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q14",
      "set_ref": "VARC_RC_4",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 14,
      "question_type": "MCQ",
      "taxonomy_type": "rc_argument",
      "topic": "Reading Comprehension",
      "subtopic": "Author's Argument (Strengthen/Weaken)",
      "difficulty": "hard",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following statements could be inferred as supporting the arguments of the passage?",
      "options": [
        {
          "id": "A",
          "text": "It is not human nature, but human culture that is represented by institutions such as law and custom."
        },
        {
          "id": "B",
          "text": "Technologies form the environmental context and shape the contours of human society."
        },
        {
          "id": "C",
          "text": "Nature decides the point at which society loses its capacity to control history."
        },
        {
          "id": "D",
          "text": "The romantic conception of nature referred to by the passage is the one that requires theoretical legitimacy."
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q15",
      "set_ref": "VARC_RC_4",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 15,
      "question_type": "MCQ",
      "taxonomy_type": "rc_argument",
      "topic": "Reading Comprehension",
      "subtopic": "Author's Argument (Strengthen/Weaken)",
      "difficulty": "hard",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which one of the following statements contradicts the arguments of the passage?",
      "options": [
        {
          "id": "A",
          "text": "The problems of command over a disempowered and deskilled labour force gave rise to similar patterns of the capitalist rationalisation of production wherever masses were organised."
        },
        {
          "id": "B",
          "text": "Marx’s understanding of the capitalist rationalisation of production and Marcuse’s understanding of a “project” of “technological rationality” share theoretical inclinations."
        },
        {
          "id": "C",
          "text": "Masses are organised in patterns set by Foucault’s prisons and Habermas’ public sphere."
        },
        {
          "id": "D",
          "text": "Paradoxically, the capitalist rationalisation of production is a mark of so-called socialist systems as well."
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q16",
      "set_ref": "VARC_RC_4",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 16,
      "question_type": "MCQ",
      "taxonomy_type": "rc_inference",
      "topic": "Reading Comprehension",
      "subtopic": "Inference & Conclusion",
      "difficulty": "hard",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "All of the following claims can be inferred from the passage, EXCEPT:",
      "options": [
        {
          "id": "A",
          "text": "the significance of parental authority to children’s safety does not therefore imply that parental authority is a permanent aspect of human nature."
        },
        {
          "id": "B",
          "text": "the critical theory of technology argues that, as issues of human rights become more prominent, we lose sight of the ways in which the social order becomes more authoritarian."
        },
        {
          "id": "C",
          "text": "analyses of technologies must engage with their social histories to be able to reveal their implicit and explicit meanings for us."
        },
        {
          "id": "D",
          "text": "technologies seek to privilege certain dimensions of human nature at a high cost to lived nature."
        }
      ],
      "solution_text": "The correct answer is D."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q17",
      "set_ref": "VARC_ATOMIC_1",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 17,
      "question_type": "MCQ",
      "taxonomy_type": "para_jumble",
      "topic": "Verbal Ability (VA)",
      "subtopic": "Sentence Completion",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "There is a sentence that is missing in the paragraph below. Look at the paragraph and decide in which blank (option 1, 2, 3, or 4\\) the following sentence would best fit.\nSentence: Having made citizens more and less knowledgeable than their predecessors, the Internet has proved to be both a blessing and a curse.\nParagraph: Never before has a population, nearly all of whom has enjoyed at a least a secondary school education, been exposed to so much information, whether in newspapers and magazines or through YouTube, Google, and Facebook. (1). Yet it is not clear that people today are more knowledgeable than their barely literate predecessors. Contemporary advances in technology offered more serious and inquisitive students access to realms of knowledge previously unimaginable and unavailable. (2). But such readily available knowledge leads many more students away from serious study, the reading of actual texts, and toward an inability to write effectively and grammatically. (3). It has let people choose sources that reinforce their opinions rather than encouraging them to question inherited beliefs. (4).",
      "options": [
        {
          "id": "A",
          "text": "Option 1"
        },
        {
          "id": "B",
          "text": "Option 2"
        },
        {
          "id": "C",
          "text": "Option 3"
        },
        {
          "id": "D",
          "text": "Option 4"
        }
      ],
      "solution_text": "The correct answer is D."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q18",
      "set_ref": "VARC_ATOMIC_1",
      "sequence_order": 2,
      "section": "VARC",
      "question_number": 18,
      "question_type": "MCQ",
      "taxonomy_type": "para_summary",
      "topic": "Verbal Ability (VA)",
      "subtopic": "Para Summary",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The passage given below is followed by four alternate summaries. Choose the option that best captures the essence of the passage.\nPetitioning is an expeditious democratic tradition, used frequently in prior centuries, by which citizens can bring issues directly to governments. As expressions of collective voice, they support procedural democracy by shaping agendas. They can also recruit citizens to causes, give voice to the voteless, and apply the discipline of rhetorical argument that clarifies a point of view. By contrast, elections are limited in several respects: they involve only a few candidates, and thus fall far short of a representative democracy. Further, voters’ choices are not specific to particular policies or laws, and elections are episodic, whereas the voice of the people needs to be heard and integrated constantly into democratic government.",
      "options": [
        {
          "id": "A",
          "text": "By giving citizens greater control over shaping political and democratic agendas, political petitions are invaluable as they represent an ideal form of a representative democracy."
        },
        {
          "id": "B",
          "text": "Citizens become less inclined to petitioning as it enables vocal citizens to shape political agendas, but this needs to change to strengthen democracies today."
        },
        {
          "id": "C",
          "text": "Petitioning has been important to democratic functioning, as it supplements the electoral process by enabling ongoing engagement with the government."
        },
        {
          "id": "D",
          "text": "Petitioning is definitely more representative of the collective voice, and the functioning of democratic government could improve if we relied more on petitioning rather than holding periodic elections."
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q19",
      "set_ref": "VARC_ATOMIC_1",
      "sequence_order": 3,
      "section": "VARC",
      "question_number": 19,
      "question_type": "MCQ",
      "taxonomy_type": "para_jumble",
      "topic": "Verbal Ability (VA)",
      "subtopic": "Sentence Completion",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "There is a sentence that is missing in the paragraph below. Look at the paragraph and decide in which blank (option 1, 2, 3, or 4\\) the following sentence would best fit.\nSentence: Easing the anxiety and pressure of having a “big day” is part of the appeal for many couples who marry in secret.\nParagraph: Wedding season is upon us and \\- after two years of Covid chaos that saw nuptials scaled back you may think the temptation would be to go all out. (1). But instead of expanding the guest list, many couples are opting to have entirely secret ceremonies. With Covid case numbers remaining high and the cost of living crisis meaning that many couples are feeling the pinch, it’s no wonder that some are less than eager to send out invites. (2). Plus, it can’t hurt that in celebrity circles getting married in secret is all the rage. (3). “I would definitely say that secret weddings are becoming more common,” says Landis Bejar, the founder of a therapy practice, which specialises in helping brides and grooms manage wedding stress. “People are looking for ways to get out of the spotlight and avoid the pomp and circumstance of weddings. (4). They just want to get to the part where they are married.”",
      "options": [
        {
          "id": "A",
          "text": "Option 1"
        },
        {
          "id": "B",
          "text": "Option 2"
        },
        {
          "id": "C",
          "text": "Option 3"
        },
        {
          "id": "D",
          "text": "Option 4"
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q20",
      "set_ref": "VARC_ATOMIC_1",
      "sequence_order": 4,
      "section": "VARC",
      "question_number": 20,
      "question_type": "MCQ",
      "taxonomy_type": "para_summary",
      "topic": "Verbal Ability (VA)",
      "subtopic": "Para Summary",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The passage given below is followed by four alternate summaries. Choose the option that best captures the essence of the passage.\nIt’s not that modern historians of medieval Africa have been ignorant about contacts between Ethiopia and Europe; they just had the power dynamic reversed. The traditional narrative stressed Ethiopia as weak and in trouble in the face of aggression from external forces, so Ethiopia sought military assistance from their fellow Christians to the north. But the real story, buried in plain sight in medieval diplomatic texts, simply had not yet been put together by modern scholars. Recent research pushes scholars of medieval Europe to imagine a much more richly connected medieval world: at the beginning of the so-called Age of Exploration, there is evidence that the kings of Ethiopia were sponsoring their own missions of diplomacy, faith and commerce.",
      "options": [
        {
          "id": "A",
          "text": "Medieval texts have documented how strong connections between the Christian communities of Ethiopia and Europe were invaluable in establishing military and trade links between the two civilisations."
        },
        {
          "id": "B",
          "text": "Historians were under the illusion that Ethiopia needed military protection from their neighbours, but in fact the country had close commercial and religious connections with them."
        },
        {
          "id": "C",
          "text": "Medieval texts have been ‘cherry-picked’ to promote a view of Ethiopia as weak and in need of Europe’s military help with aggressive neighbours, but recent studies reveal it was a well-connected and outward looking culture."
        },
        {
          "id": "D",
          "text": "Medieval historical sources selectively promoted the narrative that powerful European forces were called on to protect weak African civilisations such as Ethiopia, but this is far from reality."
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q21",
      "set_ref": "VARC_ATOMIC_1",
      "sequence_order": 5,
      "section": "VARC",
      "question_number": 21,
      "question_type": "TITA",
      "taxonomy_type": "para_jumble",
      "topic": "Verbal Ability (VA)",
      "subtopic": "Parajumbles",
      "difficulty": "medium",
      "correct_answer": "2143",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The four sentences (labelled 1, 2, 3 and 4\\) below, when properly sequenced, would yield a coherent paragraph. Decide on the proper sequencing of the order of the sentences and key in the sequence of the four numbers as your answer:\nSome company leaders are basing their decisions on locating offices to foster innovation and growth, as their best-performing inventors suffered the greatest productivity losses when their commutes grew longer.\nShorter commutes support innovation by giving employees more time in the office and greater opportunities for in-person collaboration, while removing the physical strain of a long commute.\nThis is not always the case: remote work does not automatically lead to greater creativity and productivity as office water-cooler conversations are also very important for innovation.\nSome see the link between long commutes and productivity as support for work-from-home scenarios, as many workers have grown accustomed to their commute-free arrangements during the pandemic.",
      "solution_text": "The correct answer is 2143\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q22",
      "set_ref": "VARC_ATOMIC_1",
      "sequence_order": 6,
      "section": "VARC",
      "question_number": 22,
      "question_type": "TITA",
      "taxonomy_type": "para_jumble",
      "topic": "Verbal Ability (VA)",
      "subtopic": "Parajumbles",
      "difficulty": "medium",
      "correct_answer": "3214",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The four sentences (labelled 1, 2, 3 and 4\\) below, when properly sequenced, would yield a coherent paragraph. Decide on the proper sequencing of the order of the sentences and key in the sequence of the four numbers as your answer:\nThe creative element in product design has become of paramount importance as it is one of the few ways a firm or industry can sustain a competitive advantage over its rivals.\nIn fact, the creative element in the value of world industry would be larger still, if we added the contribution of the creative element in other industries, such as the design of tech accessories.\nThe creative industry is receiving a lot of attention today as its growth rate is faster than that of the world economy as a whole.\nIt is for this reason that today’s trade issues are increasingly involving intellectual property, as Western countries have an interest in protecting their revenues along with freeing trade in non-tangibles.",
      "solution_text": "The correct answer is 3214\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q23",
      "set_ref": "VARC_ATOMIC_1",
      "sequence_order": 7,
      "section": "VARC",
      "question_number": 23,
      "question_type": "MCQ",
      "taxonomy_type": "para_summary",
      "topic": "Verbal Ability (VA)",
      "subtopic": "Para Summary",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The passage given below is followed by four alternate summaries. Choose the option that best captures the essence of the passage.\nAll that we think we know about how life hangs together is really some kind of illusion that we have perpetrated on ourselves because of our limited vision. What appear to be inanimate objects such as stones turn out not only to be alive in the same way that we are, but also in many infinitesimal ways to be affected by stimuli just as humans are. The distinction between animate and inanimate simply cannot be made when you enter the world of quantum mechanics and try to determine how those apparent subatomic particles, of which you and everything else in our universe is composed, are all tied together. The point is that physics and metaphysics show there is a pattern to the universe that goes beyond our capacity to grasp it with our brains.",
      "options": [
        {
          "id": "A",
          "text": "The effect of stimuli is similar in inanimate objects when compared to animate objects or living beings."
        },
        {
          "id": "B",
          "text": "Quantum physics indicates that an astigmatic view of reality results in erroneous assumptions about the universe."
        },
        {
          "id": "C",
          "text": "The inanimate world is both sentient and cognizant like its animate counterpart."
        },
        {
          "id": "D",
          "text": "Arbitrary distinctions between inanimate and animate objects disappear at the scale at which quantum mechanics works."
        }
      ],
      "solution_text": "The correct answer is D."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q24",
      "set_ref": "VARC_ATOMIC_1",
      "sequence_order": 8,
      "section": "VARC",
      "question_number": 24,
      "question_type": "TITA",
      "taxonomy_type": "para_jumble",
      "topic": "Verbal Ability (VA)",
      "subtopic": "Parajumbles",
      "difficulty": "medium",
      "correct_answer": "2431",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The four sentences (labelled 1, 2, 3 and 4\\) below, when properly sequenced, would yield a coherent paragraph. Decide on the proper sequencing of the order of the sentences and key in the sequence of the four numbers as your answer:\nFish skin collagen has excellent thermo-stability and tensile strength making it ideal for use as bandage that adheres to the skin and adjusts to body movements.\nCollagen, one of the main structural proteins in connective tissues in the human body, is well known for promoting skin regeneration.\nFish skin swims in here as diseases and bacteria that affect fish are different from most human pathogens.\nThe risk of introducing disease agents into other species through the use of pig and cow collagen proteins for wound healing has inhibited its broader applications in the medical field.",
      "solution_text": "The correct answer is 2431\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q25",
      "set_ref": "DILR_SET_1",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 25,
      "question_type": "MCQ",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Caselets",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "How many goals were scored in Match 7?",
      "options": [
        {
          "id": "A",
          "text": "3"
        },
        {
          "id": "B",
          "text": "2"
        },
        {
          "id": "C",
          "text": "1"
        },
        {
          "id": "D",
          "text": "Cannot be determined"
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q26",
      "set_ref": "DILR_SET_1",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 26,
      "question_type": "MCQ",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Caselets",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following is the correct sequence of goals scored in matches 1, 3, 5 and 7?",
      "options": [
        {
          "id": "A",
          "text": "5, 1, 0, 1"
        },
        {
          "id": "B",
          "text": "3, 1, 2, 1"
        },
        {
          "id": "C",
          "text": "3, 2, 1, 2"
        },
        {
          "id": "D",
          "text": "4, 1, 2, 1"
        }
      ],
      "solution_text": "The correct answer is D."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q27",
      "set_ref": "DILR_SET_1",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 27,
      "question_type": "MCQ",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Caselets",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following statement(s) is/are true?\nStatement-1: Amla and Sarita never scored goals in the same match.\nStatement-2: Harita and Sarita never scored goals in the same match.",
      "options": [
        {
          "id": "A",
          "text": "Statement-1 only"
        },
        {
          "id": "B",
          "text": "Statement-2 only"
        },
        {
          "id": "C",
          "text": "Both the statements"
        },
        {
          "id": "D",
          "text": "None of the statements"
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q28",
      "set_ref": "DILR_SET_1",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 28,
      "question_type": "MCQ",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Caselets",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following statement(s) is/are false?\nStatement-1: In every match at least one player scored a goal.\nStatement-2: No two players scored goals in the same number of matches.",
      "options": [
        {
          "id": "A",
          "text": "None of the statements"
        },
        {
          "id": "B",
          "text": "Statement-1 only"
        },
        {
          "id": "C",
          "text": "Both the statements"
        },
        {
          "id": "D",
          "text": "Statement-2 only"
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q29",
      "set_ref": "DILR_SET_1",
      "sequence_order": 5,
      "section": "DILR",
      "question_number": 29,
      "question_type": "MCQ",
      "taxonomy_type": "di_reasoning",
      "topic": "Data Interpretation",
      "subtopic": "Caselets",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "If Harita scored goals in one more match as compared to Sarita, which of the following statement(s) is/are necessarily true?\nStatement-1: Amla scored goals in consecutive matches.\nStatement-2: Sarita scored goals in consecutive matches.",
      "options": [
        {
          "id": "A",
          "text": "Statement-2 only"
        },
        {
          "id": "B",
          "text": "None of the statements"
        },
        {
          "id": "C",
          "text": "Statement-1 only"
        },
        {
          "id": "D",
          "text": "Both the statements"
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q30",
      "set_ref": "DILR_SET_2",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 30,
      "question_type": "TITA",
      "taxonomy_type": "di_venn",
      "topic": "Data Interpretation",
      "subtopic": "Set Theory",
      "difficulty": "medium",
      "correct_answer": "50",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many boys are there in the class?",
      "solution_text": "The correct answer is 50\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q31",
      "set_ref": "DILR_SET_2",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 31,
      "question_type": "MCQ",
      "taxonomy_type": "di_venn",
      "topic": "Data Interpretation",
      "subtopic": "Set Theory",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following can be determined from the given information?\nII. The number of female dancers who are interested in attending a 1-day event.",
      "options": [
        {
          "id": "I",
          "text": "The number of boys who are interested in attending a 1-day event and are neither dancers nor singers."
        },
        {
          "id": "A",
          "text": "Only I"
        },
        {
          "id": "B",
          "text": "Neither I nor II"
        },
        {
          "id": "C",
          "text": "Only II"
        },
        {
          "id": "D",
          "text": "Both I and II"
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q32",
      "set_ref": "DILR_SET_2",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 32,
      "question_type": "MCQ",
      "taxonomy_type": "di_venn",
      "topic": "Data Interpretation",
      "subtopic": "Set Theory",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "What fraction of the class are interested in attending a 2-day event?",
      "options": [
        {
          "id": "A",
          "text": "7/10"
        },
        {
          "id": "B",
          "text": "7/13"
        },
        {
          "id": "C",
          "text": "9/1"
        },
        {
          "id": "D",
          "text": "2/3"
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q33",
      "set_ref": "DILR_SET_2",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 33,
      "question_type": "MCQ",
      "taxonomy_type": "di_venn",
      "topic": "Data Interpretation",
      "subtopic": "Set Theory",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "What BEST can be concluded about the number of male dancers who are interested in attending a 1-day event?",
      "options": [
        {
          "id": "A",
          "text": "5 or 6"
        },
        {
          "id": "B",
          "text": "6"
        },
        {
          "id": "C",
          "text": "5"
        },
        {
          "id": "D",
          "text": "4 or 6"
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q34",
      "set_ref": "DILR_SET_2",
      "sequence_order": 5,
      "section": "DILR",
      "question_number": 34,
      "question_type": "MCQ",
      "taxonomy_type": "di_venn",
      "topic": "Data Interpretation",
      "subtopic": "Set Theory",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "How many female dancers are interested in attending a 2-day event?",
      "options": [
        {
          "id": "A",
          "text": "2"
        },
        {
          "id": "B",
          "text": "1"
        },
        {
          "id": "C",
          "text": "0"
        },
        {
          "id": "D",
          "text": "Cannot be determined"
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q35",
      "set_ref": "DILR_SET_3",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 35,
      "question_type": "TITA",
      "taxonomy_type": "di_reasoning",
      "topic": "Logical Reasoning",
      "subtopic": "Number Puzzles",
      "difficulty": "medium",
      "correct_answer": "2",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many tokens did Qahira receive?",
      "solution_text": "The correct answer is 2\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q36",
      "set_ref": "DILR_SET_3",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 36,
      "question_type": "MCQ",
      "taxonomy_type": "di_reasoning",
      "topic": "Logical Reasoning",
      "subtopic": "Number Puzzles",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Who among the following definitely received a token from Bithi but not from Dhanavi?",
      "options": [
        {
          "id": "A",
          "text": "Pragnyaa"
        },
        {
          "id": "B",
          "text": "Rasheeda"
        },
        {
          "id": "C",
          "text": "Qahira"
        },
        {
          "id": "D",
          "text": "Tantra"
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q37",
      "set_ref": "DILR_SET_3",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 37,
      "question_type": "TITA",
      "taxonomy_type": "di_reasoning",
      "topic": "Logical Reasoning",
      "subtopic": "Number Puzzles",
      "difficulty": "medium",
      "correct_answer": "3",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many tokens did Chhaya award?",
      "solution_text": "The correct answer is 3\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q38",
      "set_ref": "DILR_SET_3",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 38,
      "question_type": "TITA",
      "taxonomy_type": "di_reasoning",
      "topic": "Logical Reasoning",
      "subtopic": "Number Puzzles",
      "difficulty": "medium",
      "correct_answer": "3",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "How many tokens did Smera receive?",
      "solution_text": "The correct answer is 3\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q39",
      "set_ref": "DILR_SET_3",
      "sequence_order": 5,
      "section": "DILR",
      "question_number": 39,
      "question_type": "MCQ",
      "taxonomy_type": "di_reasoning",
      "topic": "Logical Reasoning",
      "subtopic": "Number Puzzles",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Which of the following could be the amount of funding that Tantra received?\n(a) Rs. 66,000 (b) Rs. 165,000",
      "options": [
        {
          "id": "A",
          "text": "Neither (a) nor (b)"
        },
        {
          "id": "B",
          "text": "Only (b)"
        },
        {
          "id": "C",
          "text": "Only (a)"
        },
        {
          "id": "D",
          "text": "Both (a) and (b)"
        }
      ],
      "solution_text": "The correct answer is D."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q40",
      "set_ref": "DILR_SET_4",
      "sequence_order": 1,
      "section": "DILR",
      "question_number": 40,
      "question_type": "MCQ",
      "taxonomy_type": "di_network",
      "topic": "Logical Reasoning",
      "subtopic": "Routes & Networks",
      "difficulty": "hard",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "If Hari is ready to board a train at 8:05 am from station M, then when is the earliest that he can reach station N?",
      "options": [
        {
          "id": "A",
          "text": "9:11 am"
        },
        {
          "id": "B",
          "text": "9:06 am"
        },
        {
          "id": "C",
          "text": "9:01 am"
        },
        {
          "id": "D",
          "text": "9:13 am"
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q41",
      "set_ref": "DILR_SET_4",
      "sequence_order": 2,
      "section": "DILR",
      "question_number": 41,
      "question_type": "MCQ",
      "taxonomy_type": "di_network",
      "topic": "Logical Reasoning",
      "subtopic": "Routes & Networks",
      "difficulty": "hard",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "If Priya is ready to board a train at 10:25 am from station T, then when is the earliest that she can reach station S?",
      "options": [
        {
          "id": "A",
          "text": "11:12 am"
        },
        {
          "id": "B",
          "text": "11:22 am"
        },
        {
          "id": "C",
          "text": "11:07 am"
        },
        {
          "id": "D",
          "text": "11:28 am"
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q42",
      "set_ref": "DILR_SET_4",
      "sequence_order": 3,
      "section": "DILR",
      "question_number": 42,
      "question_type": "MCQ",
      "taxonomy_type": "di_network",
      "topic": "Logical Reasoning",
      "subtopic": "Routes & Networks",
      "difficulty": "hard",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Haripriya is expected to reach station S late. What is the latest time by which she must be ready to board at station S if she must reach station B before 1 am via station R?",
      "options": [
        {
          "id": "A",
          "text": "11:39 pm"
        },
        {
          "id": "B",
          "text": "11:49 am"
        },
        {
          "id": "C",
          "text": "11:35 pm"
        },
        {
          "id": "D",
          "text": "11:43 pm"
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q43",
      "set_ref": "DILR_SET_4",
      "sequence_order": 4,
      "section": "DILR",
      "question_number": 43,
      "question_type": "TITA",
      "taxonomy_type": "di_network",
      "topic": "Logical Reasoning",
      "subtopic": "Routes & Networks",
      "difficulty": "hard",
      "correct_answer": "8",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "What is the minimum number of trains that are required to provide the service on the AB line (considering both north and south directions)?",
      "solution_text": "The correct answer is 8\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q44",
      "set_ref": "DILR_SET_4",
      "sequence_order": 5,
      "section": "DILR",
      "question_number": 44,
      "question_type": "TITA",
      "taxonomy_type": "di_network",
      "topic": "Logical Reasoning",
      "subtopic": "Routes & Networks",
      "difficulty": "hard",
      "correct_answer": "48",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "What is the minimum number of trains that are required to provide the service in this city?",
      "solution_text": "The correct answer is 48\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q45",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 1,
      "section": "QA",
      "question_number": 45,
      "question_type": "TITA",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Arithmetic",
      "subtopic": "Ratio, Proportion & Variation",
      "difficulty": "medium",
      "correct_answer": "43200",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "In a village, the ratio of the number of males to females is 5 : 4\\. The ratio of the number of literate males to literate females is 2 : 3\\. The ratio of the number of illiterate males to illiterate females is 4 : 3\\. If 3600 males in the village are literate, then the total number of females in the village is ______.",
      "solution_text": "The correct answer is 43200\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q46",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 2,
      "section": "QA",
      "question_number": 46,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Arithmetic",
      "subtopic": "Averages, Mixtures & Alligations",
      "difficulty": "medium",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The average weight of students in a class increases by 600 gm when some new students join the class. If the average weight of the new students is 3 kg more than the average weight of the original students, then the ratio of the number of original students to the number of new students is:",
      "options": [
        {
          "id": "A",
          "text": "1 : 4"
        },
        {
          "id": "B",
          "text": "1 : 2"
        },
        {
          "id": "C",
          "text": "4 : 1"
        },
        {
          "id": "D",
          "text": "3 : 1"
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q47",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 3,
      "section": "QA",
      "question_number": 47,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Algebra",
      "subtopic": "Sequence & Series (AP, GP, HP)",
      "difficulty": "hard",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "For any natural number $n$, suppose the sum of the first $n$ terms of an arithmetic progression is $(n + 2n^2)$. If the $n^{th}$ term of the progression is divisible by 9, then the smallest possible value of $n$ is:",
      "options": [
        {
          "id": "A",
          "text": "9"
        },
        {
          "id": "B",
          "text": "4"
        },
        {
          "id": "C",
          "text": "7"
        },
        {
          "id": "D",
          "text": "8"
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q48",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 4,
      "section": "QA",
      "question_number": 48,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Algebra",
      "subtopic": "Functions & Graphs",
      "difficulty": "hard",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Let $0 \\\\le a \\\\le x \\\\le 100$ and $f(x) \\= |x \\- a| + |x \\- 100| + |x \\- a \\- 50|$. Then the maximum value of $f(x)$ becomes 100 when $a$ is equal to:",
      "options": [
        {
          "id": "A",
          "text": "25"
        },
        {
          "id": "B",
          "text": "100"
        },
        {
          "id": "C",
          "text": "50"
        },
        {
          "id": "D",
          "text": "0"
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q49",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 5,
      "section": "QA",
      "question_number": 49,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Arithmetic",
      "subtopic": "Time, Speed & Distance",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Trains A and B start traveling at the same time towards each other with constant speeds from stations X and Y, respectively. Train A reaches station Y in 10 minutes while train B takes 9 minutes to reach station X after meeting train A. Then the total time taken, in minutes, by train B to travel from station Y to station X is:",
      "options": [
        {
          "id": "A",
          "text": "6"
        },
        {
          "id": "B",
          "text": "15"
        },
        {
          "id": "C",
          "text": "10"
        },
        {
          "id": "D",
          "text": "12"
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q50",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 6,
      "section": "QA",
      "question_number": 50,
      "question_type": "TITA",
      "taxonomy_type": "qa_geometry",
      "topic": "Geometry & Mensuration",
      "subtopic": "Quadrilaterals & Polygons",
      "difficulty": "medium",
      "correct_answer": "66",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "A trapezium ABCD has side AD parallel to BC, $\\\\angle BAD \\= 90^\\\\circ$, $BC \\= 3$ cm and $AD \\= 8$ cm. If the perimeter of this trapezium is 36 cm, then its area, in sq. cm, is ______.",
      "solution_text": "The correct answer is 66\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q51",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 7,
      "section": "QA",
      "question_number": 51,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Arithmetic",
      "subtopic": "Profit, Loss & Discount",
      "difficulty": "hard",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Ankita buys 4 kg cashews, 14 kg peanuts and 6 kg almonds when the cost of 7 kg cashews is the same as that of 30 kg peanuts or 9 kg almonds. She mixes all the three nuts and marks a price for the mixture in order to make a profit of ₹1752. She sells 4 kg of the mixture at this marked price and the remaining at a 20% discount on the marked price, thus making a total profit of ₹744. Then the amount, in rupees, that she had spent in buying almonds is:",
      "options": [
        {
          "id": "A",
          "text": "1680"
        },
        {
          "id": "B",
          "text": "1176"
        },
        {
          "id": "C",
          "text": "2520"
        },
        {
          "id": "D",
          "text": "1440"
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q52",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 8,
      "section": "QA",
      "question_number": 52,
      "question_type": "TITA",
      "taxonomy_type": "qa_number_system",
      "topic": "Number Systems",
      "subtopic": "Factors & Multiples (HCF/LCM)",
      "difficulty": "hard",
      "correct_answer": "82",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Let $A$ be the largest positive integer that divides all the numbers of the form $3^k + 4^k + 5^k$, and let $B$ be the largest positive integer that divides all the numbers of the form $4^k + 3(4^k) + 4^{k+2}$, where $k$ is any positive integer. Then $(A + B)$ equals ______.",
      "solution_text": "The correct answer is 82\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q53",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 9,
      "section": "QA",
      "question_number": 53,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Algebra",
      "subtopic": "Quadratic Equations",
      "difficulty": "hard",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Let $a, b, c$ be non-zero real numbers such that $b^2 \\< 4ac$ and $f(x) \\= ax^2 + bx + c$. If the set $S$ consists of all integers $m$ such that $f(m) \\< 0$, then the set $S$ must necessarily be:",
      "options": [
        {
          "id": "A",
          "text": "the set of all positive integers"
        },
        {
          "id": "B",
          "text": "the set of all integers"
        },
        {
          "id": "C",
          "text": "either the empty set or the set of all integers"
        },
        {
          "id": "D",
          "text": "the empty set"
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q54",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 10,
      "section": "QA",
      "question_number": 54,
      "question_type": "TITA",
      "taxonomy_type": "qa_modern_math",
      "topic": "Modern Math",
      "subtopic": "Permutations & Combinations",
      "difficulty": "medium",
      "correct_answer": "84",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "The number of ways of distributing 20 identical balloons among 4 children such that each child gets some balloons but no child gets an odd number of balloons, is ______.",
      "solution_text": "The correct answer is 84\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q55",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 11,
      "section": "QA",
      "question_number": 55,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Algebra",
      "subtopic": "Linear Equations",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Let $a$ and $b$ be natural numbers. If $a^2 + ab + a \\= 14$ and $b^2 + ab + b \\= 28$, then $(2a + b)$ equals:",
      "options": [
        {
          "id": "A",
          "text": "8"
        },
        {
          "id": "B",
          "text": "7"
        },
        {
          "id": "C",
          "text": "10"
        },
        {
          "id": "D",
          "text": "9"
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q56",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 12,
      "section": "QA",
      "question_number": 56,
      "question_type": "TITA",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Arithmetic",
      "subtopic": "Profit, Loss & Discount",
      "difficulty": "medium",
      "correct_answer": "160",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Amal buys 110 kg of syrup and 120 kg of juice, syrup being 20% less costly than juice, per kg. He sells 10 kg of syrup at 10% profit and 20 kg of juice at 20% profit. Mixing the remaining juice and syrup, Amal sells the mixture at ₹ 308.32 per kg and makes an overall profit of 64%. Then, Amal’s cost price for syrup, in rupees per kg, is ______.",
      "solution_text": "The correct answer is 160\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q57",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 13,
      "section": "QA",
      "question_number": 57,
      "question_type": "MCQ",
      "taxonomy_type": "qa_geometry",
      "topic": "Geometry & Mensuration",
      "subtopic": "Quadrilaterals & Polygons",
      "difficulty": "medium",
      "correct_answer": "B",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "All the vertices of a rectangle lie on a circle of radius $R$. If the perimeter of the rectangle is $P$, then the area of the rectangle is:",
      "options": [
        {
          "id": "A",
          "text": "$\\\\frac{P^2}{16} \\- R^2$"
        },
        {
          "id": "B",
          "text": "$\\\\frac{P^2}{8} \\- 2R^2$"
        },
        {
          "id": "C",
          "text": "$\\\\frac{P^2}{2} \\- 2PR$"
        },
        {
          "id": "D",
          "text": "$\\\\frac{P^2}{8} \\- \\\\frac{R^2}{2}$"
        }
      ],
      "solution_text": "The correct answer is B."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q58",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 14,
      "section": "QA",
      "question_number": 58,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Arithmetic",
      "subtopic": "Averages, Mixtures & Alligations",
      "difficulty": "easy",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The average of three integers is 13\\. When a natural number $n$ is included, the average of these four integers remains an odd integer. The minimum possible value of $n$ is:",
      "options": [
        {
          "id": "A",
          "text": "3"
        },
        {
          "id": "B",
          "text": "4"
        },
        {
          "id": "C",
          "text": "5"
        },
        {
          "id": "D",
          "text": "1"
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q59",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 15,
      "section": "QA",
      "question_number": 59,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Arithmetic",
      "subtopic": "Averages, Mixtures & Alligations",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "A mixture contains lemon juice and sugar syrup in equal proportion. If a new mixture is created by adding this mixture and sugar syrup in the ratio 1 : 3, then the ratio of lemon juice and sugar syrup in the new mixture is:",
      "options": [
        {
          "id": "A",
          "text": "1 : 4"
        },
        {
          "id": "B",
          "text": "1 : 5"
        },
        {
          "id": "C",
          "text": "1 : 6"
        },
        {
          "id": "D",
          "text": "1 : 7"
        }
      ],
      "solution_text": "The correct answer is D."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q60",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 16,
      "section": "QA",
      "question_number": 60,
      "question_type": "MCQ",
      "taxonomy_type": "qa_algebra",
      "topic": "Algebra",
      "subtopic": "Inequalities & Modulus",
      "difficulty": "hard",
      "correct_answer": "C",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "The largest real value of $a$ for which the equation $|x + a| + |x \\- 1| \\= 2$ has an infinite number of solutions for $x$ is:",
      "options": [
        {
          "id": "A",
          "text": "\\-1"
        },
        {
          "id": "B",
          "text": "0"
        },
        {
          "id": "C",
          "text": "1"
        },
        {
          "id": "D",
          "text": "2"
        }
      ],
      "solution_text": "The correct answer is C."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q61",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 17,
      "section": "QA",
      "question_number": 61,
      "question_type": "MCQ",
      "taxonomy_type": "qa_modern_math",
      "topic": "Modern Math",
      "subtopic": "Set Theory",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "In a class of 100 students, 73 like coffee, 80 like tea and 52 like lemonade. It may be possible that some students do not like any of these three drinks. Then the difference between the maximum and minimum possible number of students who like all the three drinks is:",
      "options": [
        {
          "id": "A",
          "text": "47"
        },
        {
          "id": "B",
          "text": "53"
        },
        {
          "id": "C",
          "text": "52"
        },
        {
          "id": "D",
          "text": "48"
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q62",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 18,
      "section": "QA",
      "question_number": 62,
      "question_type": "MCQ",
      "taxonomy_type": "qa_geometry",
      "topic": "Geometry & Mensuration",
      "subtopic": "Coordinate Geometry",
      "difficulty": "medium",
      "correct_answer": "D",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Let ABCD be a parallelogram such that the coordinates of its three vertices A, B, C are (1, 1), (3, 4\\) and (−2, 8), respectively. Then, the coordinates of the vertex D are:",
      "options": [
        {
          "id": "A",
          "text": "(0, 11\\)"
        },
        {
          "id": "B",
          "text": "(4, 5\\)"
        },
        {
          "id": "C",
          "text": "(−3, 4\\)"
        },
        {
          "id": "D",
          "text": "(-4, 5\\)"
        }
      ],
      "solution_text": "The correct answer is D."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q63",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 19,
      "section": "QA",
      "question_number": 63,
      "question_type": "TITA",
      "taxonomy_type": "qa_algebra",
      "topic": "Algebra",
      "subtopic": "Linear Equations",
      "difficulty": "hard",
      "correct_answer": "34",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "For natural numbers $x, y$, and $z$, if $xy + yz \\= 19$ and $yz + xz \\= 51$, then the minimum possible value of $xyz$ is ______.",
      "solution_text": "The correct answer is 34\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q64",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 20,
      "section": "QA",
      "question_number": 64,
      "question_type": "MCQ",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Arithmetic",
      "subtopic": "Simple & Compound Interest",
      "difficulty": "medium",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "Alex invested his savings in two parts. The simple interest earned on the first part at 15% per annum for 4 years is the same as the simple interest earned on the second part at 12% per annum for 3 years. Then, the percentage of his savings invested in the first part is:",
      "options": [
        {
          "id": "A",
          "text": "37.5%"
        },
        {
          "id": "B",
          "text": "62.5%"
        },
        {
          "id": "C",
          "text": "60%"
        },
        {
          "id": "D",
          "text": "40%"
        }
      ],
      "solution_text": "The correct answer is A."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q65",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 21,
      "section": "QA",
      "question_number": 65,
      "question_type": "TITA",
      "taxonomy_type": "qa_arithmetic",
      "topic": "Arithmetic",
      "subtopic": "Ratio, Proportion & Variation",
      "difficulty": "medium",
      "correct_answer": "111",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "Pinky is standing in a queue at a ticket counter. Suppose the ratio of the number of persons standing ahead of Pinky to the number of persons standing behind her in the queue is 3 : 5\\. If the total number of persons in the queue is less than 300, then the maximum possible number of persons standing ahead of Pinky is ______.",
      "solution_text": "The correct answer is 111\\."
    },
    {
      "client_question_id": "cat_2022_slot_1_Q66",
      "set_ref": "QA_ATOMIC_1",
      "sequence_order": 22,
      "section": "QA",
      "question_number": 66,
      "question_type": "TITA",
      "taxonomy_type": "qa_algebra",
      "topic": "Algebra",
      "subtopic": "Functions & Graphs",
      "difficulty": "hard",
      "correct_answer": "44",
      "positive_marks": 3,
      "negative_marks": 0,
      "question_text": "For any real number $x$, let $\\[x\\]$ be the largest integer less than or equal to $x$. If $\\\\sum_{n=1}^{N} \\[\\\\frac{1}{5} + \\\\frac{n}{25}\\] \\= 25$, then $N$ is ______.",
      "solution_text": "The correct answer is 44\\."
    }
  ]
}
````

## File: postcss.config.js
````javascript
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
````

## File: public/file.svg
````xml
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
````

## File: public/globe.svg
````xml
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
````

## File: public/next.svg
````xml
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
````

## File: public/vercel.svg
````xml
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
````

## File: public/window.svg
````xml
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
````

## File: schemas/paper_schema_v3.json
````json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://nexams.com/schemas/paper_schema_v3.json",
    "title": "CAT Paper Schema v3.0 (Sets-First)",
    "description": "Canonical ingestion format: paper → question_sets → questions. Questions reference sets via set_ref (client_set_id).",
    "type": "object",
    "required": [
        "schema_version",
        "paper",
        "question_sets",
        "questions"
    ],
    "properties": {
        "schema_version": {
            "type": "string",
            "const": "v3.0",
            "description": "Must be 'v3.0' for sets-first format"
        },
        "paper": {
            "type": "object",
            "required": [
                "title",
                "slug"
            ],
            "properties": {
                "paper_key": {
                    "type": "string",
                    "description": "Stable semantic key for idempotent imports (e.g., 'cat-2024-slot-1')"
                },
                "title": {
                    "type": "string",
                    "minLength": 1
                },
                "slug": {
                    "type": "string",
                    "pattern": "^[a-z0-9-]+$"
                },
                "description": {
                    "type": "string"
                },
                "year": {
                    "type": "integer"
                },
                "total_questions": {
                    "type": "integer",
                    "minimum": 1
                },
                "total_marks": {
                    "type": "number"
                },
                "duration_minutes": {
                    "type": "integer",
                    "minimum": 1
                },
                "sections": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "enum": [
                            "VARC",
                            "DILR",
                            "QA"
                        ]
                    }
                },
                "default_positive_marks": {
                    "type": "number",
                    "default": 3
                },
                "default_negative_marks": {
                    "type": "number",
                    "default": 1
                },
                "difficulty_level": {
                    "type": "string",
                    "enum": [
                        "easy",
                        "medium",
                        "hard"
                    ]
                },
                "is_free": {
                    "type": "boolean",
                    "default": false
                },
                "published": {
                    "type": "boolean",
                    "default": false
                },
                "allow_pause": {
                    "type": "boolean",
                    "default": true
                },
                "attempt_limit": {
                    "type": "integer",
                    "minimum": 0,
                    "default": 0
                }
            }
        },
        "question_sets": {
            "type": "array",
            "description": "Parent containers for questions. Inserted FIRST, then questions reference them.",
            "items": {
                "type": "object",
                "required": [
                    "client_set_id",
                    "section",
                    "set_type",
                    "display_order"
                ],
                "properties": {
                    "client_set_id": {
                        "type": "string",
                        "description": "Stable human-readable ID (e.g., 'VARC_RC_1', 'DILR_SET_3'). Used by questions.set_ref to link.",
                        "pattern": "^[A-Z0-9_]+$"
                    },
                    "section": {
                        "type": "string",
                        "enum": [
                            "VARC",
                            "DILR",
                            "QA"
                        ]
                    },
                    "set_type": {
                        "type": "string",
                        "enum": [
                            "VARC",
                            "DILR",
                            "CASELET",
                            "ATOMIC"
                        ],
                        "description": "VARC/DILR/CASELET require context_body. ATOMIC is for standalone questions."
                    },
                    "display_order": {
                        "type": "integer",
                        "minimum": 0,
                        "description": "Order within section for deterministic export"
                    },
                    "context_title": {
                        "type": "string",
                        "description": "Optional title for the passage/set"
                    },
                    "context_body": {
                        "type": "string",
                        "description": "Required for VARC/DILR/CASELET sets. The passage or data content."
                    },
                    "context_image_url": {
                        "type": "string",
                        "format": "uri",
                        "description": "Optional image URL for DI sets"
                    },
                    "context_additional_images": {
                        "type": "array",
                        "items": {
                            "type": "string",
                            "format": "uri"
                        }
                    },
                    "context_type": {
                        "type": "string",
                        "enum": [
                            "rc_passage",
                            "dilr_set",
                            "caselet",
                            "data_table",
                            "graph",
                            "other_shared_stimulus"
                        ],
                        "description": "Explicit categorization for analytics"
                    },
                    "content_layout": {
                        "type": "string",
                        "enum": [
                            "split_passage",
                            "split_chart",
                            "split_table",
                            "single_focus",
                            "image_top"
                        ],
                        "default": "single_focus"
                    },
                    "metadata": {
                        "type": "object",
                        "description": "Arbitrary metadata for the set"
                    }
                },
                "if": {
                    "properties": {
                        "set_type": {
                            "enum": [
                                "VARC",
                                "DILR",
                                "CASELET"
                            ]
                        }
                    }
                },
                "then": {
                    "required": [
                        "context_body"
                    ],
                    "properties": {
                        "context_body": {
                            "minLength": 1
                        }
                    }
                }
            }
        },
        "questions": {
            "type": "array",
            "description": "Questions reference sets via set_ref (matches client_set_id)",
            "items": {
                "type": "object",
                "required": [
                    "client_question_id",
                    "set_ref",
                    "sequence_order",
                    "question_number",
                    "question_text",
                    "question_type"
                ],
                "properties": {
                    "client_question_id": {
                        "type": "string",
                        "description": "Stable human-readable ID (e.g., 'Q1', 'VARC_RC1_Q3'). Unique within paper.",
                        "pattern": "^[A-Za-z0-9_]+$"
                    },
                    "set_ref": {
                        "type": "string",
                        "description": "References a question_set by client_set_id. Must exist in question_sets[].",
                        "pattern": "^[A-Z0-9_]+$"
                    },
                    "sequence_order": {
                        "type": "integer",
                        "minimum": 1,
                        "description": "Order within the set (1-based)"
                    },
                    "section": {
                        "type": "string",
                        "enum": [
                            "VARC",
                            "DILR",
                            "QA"
                        ]
                    },
                    "question_number": {
                        "type": "integer",
                        "minimum": 1,
                        "description": "Global question number in the paper"
                    },
                    "question_text": {
                        "type": "string",
                        "minLength": 1
                    },
                    "question_type": {
                        "type": "string",
                        "enum": [
                            "MCQ",
                            "TITA"
                        ],
                        "description": "Answer format"
                    },
                    "question_format": {
                        "type": "string",
                        "enum": [
                            "MCQ",
                            "TITA"
                        ],
                        "description": "Alias for question_type (DB uses this)"
                    },
                    "taxonomy_type": {
                        "type": "string",
                        "description": "Semantic category (e.g., rc_inference, para_summary, di_table_analysis)"
                    },
                    "topic_tag": {
                        "type": "string",
                        "description": "Fine-grained topic for analytics"
                    },
                    "difficulty_rationale": {
                        "type": "string",
                        "description": "Explanation for difficulty rating"
                    },
                    "options": {
                        "type": "array",
                        "description": "Required for MCQ questions",
                        "items": {
                            "type": "object",
                            "required": [
                                "id",
                                "text"
                            ],
                            "properties": {
                                "id": {
                                    "type": "string"
                                },
                                "text": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "correct_answer": {
                        "type": [
                            "string",
                            "number",
                            "array"
                        ],
                        "description": "MCQ: option id(s). TITA: numeric or string answer."
                    },
                    "positive_marks": {
                        "type": "number",
                        "default": 3
                    },
                    "negative_marks": {
                        "type": "number",
                        "default": 1
                    },
                    "difficulty": {
                        "type": "string",
                        "enum": [
                            "easy",
                            "medium",
                            "hard"
                        ]
                    },
                    "topic": {
                        "type": "string"
                    },
                    "subtopic": {
                        "type": "string"
                    },
                    "solution_text": {
                        "type": "string"
                    },
                    "solution_image_url": {
                        "type": "string",
                        "format": "uri"
                    },
                    "video_solution_url": {
                        "type": "string",
                        "format": "uri"
                    }
                },
                "if": {
                    "properties": {
                        "question_type": {
                            "const": "MCQ"
                        }
                    }
                },
                "then": {
                    "required": [
                        "options"
                    ]
                }
            }
        }
    }
}
````

## File: scripts/ajv-validator.mjs
````javascript
import Ajv from 'ajv';
import addFormats from 'ajv-formats';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __dirname = dirname(fileURLToPath(import.meta.url));
const schemaPath = join(__dirname, '..', 'schemas', 'paper_schema_v3.json');
const paperSchema = JSON.parse(readFileSync(schemaPath, 'utf8'));

function buildAjv() {
    const ajv = new Ajv({
        allErrors: true,
        strict: false,
        verbose: true
    });

    addFormats(ajv);
    return ajv;
}

const ajv = buildAjv();
const validate = ajv.compile(paperSchema);

export function validatePaperSchema(data) {
    const valid = validate(data);
    return {
        valid: Boolean(valid),
        errors: valid ? undefined : validate.errors || []
    };
}
````

## File: scripts/backfill-paper-versions.mjs
````javascript
#!/usr/bin/env node
/**
 * @fileoverview Backfill Paper Versions Script
 * @description Creates initial ingest run records for existing papers
 * @usage node scripts/backfill-paper-versions.mjs [options]
 * 
 * This script:
 * 1. Finds all papers without a latest_ingest_run_id
 * 2. Calls export_paper_json() to assemble current state
 * 3. Creates a paper_ingest_runs record as version 1
 * 4. Updates papers.latest_ingest_run_id
 * 
 * Options:
 *   --dry-run    Show what would be done without making changes
 *   --paper-id   Backfill only a specific paper
 *   --help, -h   Show help message
 */

import { createClient } from '@supabase/supabase-js';
import { createHash } from 'crypto';

// =============================================================================
// CONFIGURATION
// =============================================================================

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {
    console.error('❌ Missing environment variables:');
    console.error('   - NEXT_PUBLIC_SUPABASE_URL');
    console.error('   - SUPABASE_SERVICE_ROLE_KEY');
    process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
    auth: { persistSession: false }
});

// =============================================================================
// HASH FUNCTION
// =============================================================================

function computeJsonHash(data) {
    const jsonStr = JSON.stringify(data, Object.keys(data).sort());
    return createHash('sha256').update(jsonStr).digest('hex');
}

// =============================================================================
// BACKFILL FUNCTIONS
// =============================================================================

async function getPapersNeedingBackfill(specificPaperId = null) {
    let query = supabase
        .from('papers')
        .select('id, slug, title, latest_ingest_run_id');

    if (specificPaperId) {
        query = query.eq('id', specificPaperId);
    } else {
        query = query.is('latest_ingest_run_id', null);
    }

    const { data, error } = await query;

    if (error) {
        throw new Error(`Failed to fetch papers: ${error.message}`);
    }

    return data || [];
}

async function backfillPaper(paper, dryRun = false) {
    console.log(`\n📄 Processing: ${paper.title} (${paper.slug})`);
    console.log(`   Paper ID: ${paper.id}`);

    // Export current state using SQL function
    const { data: exportedJson, error: exportError } = await supabase.rpc('export_paper_json', {
        p_paper_id: paper.id
    });

    if (exportError) {
        console.error(`   ❌ Export failed: ${exportError.message}`);
        return { success: false, error: exportError.message };
    }

    if (exportedJson?.error) {
        console.error(`   ❌ Export returned error: ${exportedJson.error}`);
        return { success: false, error: exportedJson.error };
    }

    // Calculate hash
    const canonicalHash = computeJsonHash(exportedJson);
    console.log(`   Hash: ${canonicalHash.substring(0, 16)}...`);

    // Check if already has ingest runs
    const { data: existingRuns } = await supabase
        .from('paper_ingest_runs')
        .select('id, version_number')
        .eq('paper_id', paper.id)
        .order('version_number', { ascending: false })
        .limit(1);

    if (existingRuns && existingRuns.length > 0) {
        console.log(`   ⚠️  Paper already has ${existingRuns.length} ingest run(s)`);

        if (!paper.latest_ingest_run_id) {
            // Just need to update the pointer
            if (!dryRun) {
                await supabase
                    .from('papers')
                    .update({ latest_ingest_run_id: existingRuns[0].id })
                    .eq('id', paper.id);
                console.log(`   ✅ Updated latest_ingest_run_id pointer`);
            } else {
                console.log(`   [DRY RUN] Would update latest_ingest_run_id to ${existingRuns[0].id}`);
            }
        }
        return { success: true, skipped: true };
    }

    // Count contexts and questions
    const contextCount = Array.isArray(exportedJson?.contexts) ? exportedJson.contexts.length : 0;
    const questionCount = Array.isArray(exportedJson?.questions) ? exportedJson.questions.length : 0;
    console.log(`   Contexts: ${contextCount}, Questions: ${questionCount}`);

    if (dryRun) {
        console.log(`   [DRY RUN] Would create ingest run v1`);
        return { success: true, dryRun: true };
    }

    // Create ingest run
    const { data: ingestRun, error: insertError } = await supabase
        .from('paper_ingest_runs')
        .insert({
            paper_id: paper.id,
            schema_version: 'v1.0',
            version_number: 1,
            canonical_paper_json: exportedJson,
            canonical_json_hash: canonicalHash,
            import_notes: 'Backfill from existing database state'
        })
        .select()
        .single();

    if (insertError) {
        console.error(`   ❌ Insert failed: ${insertError.message}`);
        return { success: false, error: insertError.message };
    }

    // Update paper's latest_ingest_run_id
    const { error: updateError } = await supabase
        .from('papers')
        .update({ latest_ingest_run_id: ingestRun.id })
        .eq('id', paper.id);

    if (updateError) {
        console.error(`   ❌ Update failed: ${updateError.message}`);
        return { success: false, error: updateError.message };
    }

    console.log(`   ✅ Created ingest run v1 (${ingestRun.id})`);
    return { success: true, ingestRunId: ingestRun.id };
}

// =============================================================================
// MAIN
// =============================================================================

async function main() {
    const args = process.argv.slice(2);

    if (args.includes('--help') || args.includes('-h')) {
        console.log(`
╔══════════════════════════════════════════════════════════════════════╗
║              Paper Versions Backfill Tool                            ║
╚══════════════════════════════════════════════════════════════════════╝

Usage:
  node scripts/backfill-paper-versions.mjs [options]

Options:
  --dry-run          Show what would be done without making changes
  --paper-id <id>    Backfill only a specific paper
  --all              Include papers that already have ingest runs
  --help, -h         Show this help message

Examples:
  # Preview what would be backfilled
  node scripts/backfill-paper-versions.mjs --dry-run

  # Backfill all papers without ingest runs
  node scripts/backfill-paper-versions.mjs

  # Backfill a specific paper
  node scripts/backfill-paper-versions.mjs --paper-id abc-123-def

What this does:
  1. Finds papers without latest_ingest_run_id
  2. Exports current state using export_paper_json()
  3. Creates paper_ingest_runs record as version 1
  4. Updates papers.latest_ingest_run_id
`);
        process.exit(0);
    }

    const dryRun = args.includes('--dry-run');
    const paperIdIdx = args.indexOf('--paper-id');
    const specificPaperId = paperIdIdx !== -1 ? args[paperIdIdx + 1] : null;

    console.log(`
╔══════════════════════════════════════════════════════════════════════╗
║              Paper Versions Backfill Tool                            ║
╚══════════════════════════════════════════════════════════════════════╝
`);

    if (dryRun) {
        console.log('🔍 DRY RUN MODE - No changes will be made\n');
    }

    try {
        // Get papers needing backfill
        const papers = await getPapersNeedingBackfill(specificPaperId);

        if (papers.length === 0) {
            console.log('✅ No papers need backfilling');
            console.log('   All papers already have ingest run records.');
            return;
        }

        console.log(`📋 Found ${papers.length} paper(s) to backfill:\n`);

        for (const paper of papers) {
            console.log(`   - ${paper.slug} (${paper.id.substring(0, 8)}...)`);
        }

        // Process each paper
        const results = {
            success: 0,
            skipped: 0,
            failed: 0,
            errors: []
        };

        for (const paper of papers) {
            const result = await backfillPaper(paper, dryRun);

            if (result.success) {
                if (result.skipped || result.dryRun) {
                    results.skipped++;
                } else {
                    results.success++;
                }
            } else {
                results.failed++;
                results.errors.push({ paper: paper.slug, error: result.error });
            }
        }

        // Summary
        console.log(`
╔══════════════════════════════════════════════════════════════════════╗
║                         Backfill Summary                             ║
╠══════════════════════════════════════════════════════════════════════╣
║  Total Papers:     ${papers.length.toString().padStart(4)}
║  Successfully:     ${results.success.toString().padStart(4)}
║  Skipped:          ${results.skipped.toString().padStart(4)}
║  Failed:           ${results.failed.toString().padStart(4)}
╚══════════════════════════════════════════════════════════════════════╝
`);

        if (results.errors.length > 0) {
            console.log('Errors:');
            for (const err of results.errors) {
                console.log(`  - ${err.paper}: ${err.error}`);
            }
        }

        if (dryRun) {
            console.log('\n💡 Run without --dry-run to apply changes.');
        }

    } catch (err) {
        console.error(`\n❌ Fatal error: ${err.message}`);
        process.exit(1);
    }
}

main();
````

## File: scripts/export-paper.mjs
````javascript
#!/usr/bin/env node
/**
 * @fileoverview Paper Export Script
 * @description CLI tool to export papers from Supabase to JSON files
 * @usage node scripts/export-paper.mjs <paper_id> [options]
 * 
 * Options:
 *   --out <path>        Output file path (default: ./exports/paper_<id>.json)
 *   --version <n>       Export specific version number
 *   --run <uuid>        Export specific ingest run ID
 *   --assembled         Force assembly from current DB state (ignore snapshots)
 *   --list-versions     List all versions for this paper
 *   --help, -h          Show help message
 * 
 * Environment Variables Required:
 *   NEXT_PUBLIC_SUPABASE_URL
 *   SUPABASE_SERVICE_ROLE_KEY
 */

import { writeFileSync, mkdirSync, existsSync } from 'fs';
import { dirname, resolve } from 'path';
import { createClient } from '@supabase/supabase-js';

// =============================================================================
// CONFIGURATION
// =============================================================================

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {
    console.error('❌ Missing environment variables:');
    console.error('   - NEXT_PUBLIC_SUPABASE_URL');
    console.error('   - SUPABASE_SERVICE_ROLE_KEY');
    console.error('');
    console.error('Set them in .env.local or pass via environment.');
    process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
    auth: { persistSession: false }
});

// =============================================================================
// HELP
// =============================================================================

function showHelp() {
    console.log(`
╔══════════════════════════════════════════════════════════════════════╗
║                    CAT Paper Export Tool                             ║
╚══════════════════════════════════════════════════════════════════════╝

Usage:
  node scripts/export-paper.mjs <paper_id> [options]

Options:
  --out <path>        Output file path (default: ./exports/<slug>.json)
  --version <n>       Export specific version number
  --run <uuid>        Export specific ingest run ID
  --assembled         Force assembly from current DB state (ignore snapshots)
  --list-versions     List all available versions for this paper
  --list             List all papers
  --help, -h          Show this help message

Examples:
  # Export latest version of a paper
  node scripts/export-paper.mjs abc-123-def

  # Export to specific file
  node scripts/export-paper.mjs abc-123-def --out ./my-paper.json

  # Export specific version
  node scripts/export-paper.mjs abc-123-def --version 2

  # List all versions
  node scripts/export-paper.mjs abc-123-def --list-versions

  # List all papers
  node scripts/export-paper.mjs --list

Environment Variables:
  Load from .env.local:
  Get-Content .env.local | ForEach-Object { if ($_ -match '^(\\w+)=(.*)$') { $name=$matches[1]; $value=$matches[2]; Set-Item -Path Env:$name -Value $value } }
`);
}

// =============================================================================
// LIST PAPERS
// =============================================================================

async function listPapers() {
    console.log('\n📋 Listing all papers...\n');

    const { data: papers, error } = await supabase
        .from('papers')
        .select('id, slug, title, published, created_at')
        .order('created_at', { ascending: false });

    if (error) {
        console.error(`❌ Error: ${error.message}`);
        process.exit(1);
    }

    if (!papers || papers.length === 0) {
        console.log('No papers found.');
        return;
    }

    console.log('ID                                    | Slug                      | Title                           | Published');
    console.log('─'.repeat(120));

    for (const paper of papers) {
        const slug = (paper.slug || '-').padEnd(25);
        const title = (paper.title || '-').substring(0, 30).padEnd(30);
        const published = paper.published ? '✓' : '✗';
        console.log(`${paper.id} | ${slug} | ${title} | ${published}`);
    }

    console.log(`\nTotal: ${papers.length} papers`);
}

// =============================================================================
// LIST VERSIONS
// =============================================================================

async function listVersions(paperId) {
    console.log(`\n📋 Listing versions for paper: ${paperId}\n`);

    // First get paper info
    const { data: paper, error: paperError } = await supabase
        .from('papers')
        .select('id, slug, title, latest_ingest_run_id')
        .eq('id', paperId)
        .single();

    if (paperError || !paper) {
        console.error(`❌ Paper not found: ${paperId}`);
        process.exit(1);
    }

    console.log(`Paper: ${paper.title} (${paper.slug})`);
    console.log(`Latest Ingest Run: ${paper.latest_ingest_run_id || 'None'}\n`);

    // Get all versions
    const { data: versions, error } = await supabase
        .from('paper_ingest_runs')
        .select('id, version_number, schema_version, created_at, import_notes')
        .eq('paper_id', paperId)
        .order('version_number', { ascending: false });

    if (error) {
        console.error(`❌ Error: ${error.message}`);
        process.exit(1);
    }

    if (!versions || versions.length === 0) {
        console.log('No versioned imports found. Use --assembled to export current DB state.');
        return;
    }

    console.log('Version | Ingest Run ID                        | Schema  | Created At           | Notes');
    console.log('─'.repeat(110));

    for (const v of versions) {
        const isLatest = v.id === paper.latest_ingest_run_id ? ' *' : '  ';
        const notes = (v.import_notes || '').substring(0, 30);
        const created = new Date(v.created_at).toISOString().substring(0, 19);
        console.log(`${String(v.version_number).padStart(4)}${isLatest} | ${v.id} | ${v.schema_version.padEnd(7)} | ${created} | ${notes}`);
    }

    console.log(`\n* = Latest version`);
    console.log(`Total: ${versions.length} versions`);
}

// =============================================================================
// EXPORT PAPER
// =============================================================================

async function exportPaper(paperId, options) {
    const { outPath, version, runId, assembled } = options;

    console.log(`\n📦 Exporting paper: ${paperId}`);

    let exportData;
    let filename;

    if (assembled) {
        console.log('   Mode: Assembled from current database state');
        const { data, error } = await supabase.rpc('export_paper_json', {
            p_paper_id: paperId
        });

        if (error) {
            console.error(`❌ Export error: ${error.message}`);
            process.exit(1);
        }

        exportData = data;
        filename = `paper_${paperId}_assembled.json`;
    } else if (runId) {
        console.log(`   Mode: Specific ingest run (${runId})`);
        const { data, error } = await supabase.rpc('export_paper_json_versioned', {
            p_paper_id: paperId,
            p_ingest_run_id: runId
        });

        if (error) {
            console.error(`❌ Export error: ${error.message}`);
            process.exit(1);
        }

        exportData = data;
        filename = `paper_${paperId}_run_${runId}.json`;
    } else if (version) {
        console.log(`   Mode: Specific version (v${version})`);

        // Get run ID for this version
        const { data: runData, error: runError } = await supabase
            .from('paper_ingest_runs')
            .select('id')
            .eq('paper_id', paperId)
            .eq('version_number', parseInt(version, 10))
            .single();

        if (runError || !runData) {
            console.error(`❌ Version ${version} not found for paper ${paperId}`);
            process.exit(1);
        }

        const { data, error } = await supabase.rpc('export_paper_json_versioned', {
            p_paper_id: paperId,
            p_ingest_run_id: runData.id
        });

        if (error) {
            console.error(`❌ Export error: ${error.message}`);
            process.exit(1);
        }

        exportData = data;
        filename = `paper_${paperId}_v${version}.json`;
    } else {
        console.log('   Mode: Latest version (canonical snapshot preferred)');
        const { data, error } = await supabase.rpc('export_paper_json_versioned', {
            p_paper_id: paperId,
            p_ingest_run_id: null
        });

        if (error) {
            console.error(`❌ Export error: ${error.message}`);
            process.exit(1);
        }

        exportData = data;

        // Get paper slug for filename
        const { data: paperData } = await supabase
            .from('papers')
            .select('slug')
            .eq('id', paperId)
            .single();

        const slug = paperData?.slug || paperId;
        filename = `${slug}.json`;
    }

    // Check for errors in response
    if (exportData && typeof exportData === 'object' && 'error' in exportData) {
        console.error(`❌ Export error: ${exportData.error}`);
        process.exit(1);
    }

    // Determine output path
    const finalPath = outPath || resolve(process.cwd(), 'exports', filename);

    // Ensure directory exists
    const dir = dirname(finalPath);
    if (!existsSync(dir)) {
        mkdirSync(dir, { recursive: true });
    }

    // Write file
    const jsonString = JSON.stringify(exportData, null, 2);
    writeFileSync(finalPath, jsonString, 'utf-8');

    // Summary
    const stats = {
        contexts: Array.isArray(exportData?.contexts) ? exportData.contexts.length : 0,
        questions: Array.isArray(exportData?.questions) ? exportData.questions.length : 0,
        fileSize: (Buffer.byteLength(jsonString) / 1024).toFixed(2)
    };

    console.log(`
╔══════════════════════════════════════════════════════════════════════╗
║                         Export Complete!                             ║
╠══════════════════════════════════════════════════════════════════════╣
║  Paper:       ${exportData?.paper?.title || paperId}
║  Slug:        ${exportData?.paper?.slug || '-'}
║  Contexts:    ${stats.contexts}
║  Questions:   ${stats.questions}
║  File Size:   ${stats.fileSize} KB
║  Output:      ${finalPath}
╚══════════════════════════════════════════════════════════════════════╝
`);
}

// =============================================================================
// MAIN
// =============================================================================

async function main() {
    const args = process.argv.slice(2);

    // Parse arguments
    const flags = {
        help: args.includes('--help') || args.includes('-h'),
        list: args.includes('--list'),
        listVersions: args.includes('--list-versions'),
        assembled: args.includes('--assembled'),
        outPath: null,
        version: null,
        runId: null,
        paperId: null
    };

    // Parse --out
    const outIdx = args.indexOf('--out');
    if (outIdx !== -1 && args[outIdx + 1]) {
        flags.outPath = args[outIdx + 1];
    }

    // Parse --version
    const versionIdx = args.indexOf('--version');
    if (versionIdx !== -1 && args[versionIdx + 1]) {
        flags.version = args[versionIdx + 1];
    }

    // Parse --run
    const runIdx = args.indexOf('--run');
    if (runIdx !== -1 && args[runIdx + 1]) {
        flags.runId = args[runIdx + 1];
    }

    // Get paper ID (first non-flag argument)
    for (const arg of args) {
        if (!arg.startsWith('--') && !arg.startsWith('-')) {
            // Check if it's not the value for a flag
            const prevIdx = args.indexOf(arg) - 1;
            if (prevIdx >= 0 && ['--out', '--version', '--run'].includes(args[prevIdx])) {
                continue;
            }
            flags.paperId = arg;
            break;
        }
    }

    // Handle commands
    if (flags.help || (args.length === 0)) {
        showHelp();
        process.exit(0);
    }

    if (flags.list) {
        await listPapers();
        process.exit(0);
    }

    if (!flags.paperId) {
        console.error('❌ Paper ID required. Use --help for usage.');
        process.exit(1);
    }

    if (flags.listVersions) {
        await listVersions(flags.paperId);
        process.exit(0);
    }

    // Export paper
    await exportPaper(flags.paperId, {
        outPath: flags.outPath,
        version: flags.version,
        runId: flags.runId,
        assembled: flags.assembled
    });
}

main().catch(err => {
    console.error(`\n❌ Fatal error: ${err.message}`);
    process.exit(1);
});
````

## File: scripts/sanitize-question-data.mjs
````javascript
#!/usr/bin/env node
/**
 * sanitize-question-data.mjs
 * 
 * Sanitizes question paper JSON/JSONC files by replacing actual content
 * with placeholders while preserving the schema structure.
 * 
 * Usage: node scripts/sanitize-question-data.mjs
 * 
 * This script:
 * 1. Reads all JSON/JSONC files from /data
 * 2. Detects question paper files (by keys like paper, questions, contexts)
 * 3. Replaces sensitive text fields with placeholders
 * 4. Truncates arrays to 1 example + note
 * 5. Writes sanitized copies to .export_sanitized/data/
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const ROOT_DIR = path.resolve(__dirname, '..');
const DATA_DIR = path.join(ROOT_DIR, 'data');
const OUTPUT_DIR = path.join(ROOT_DIR, 'data_sanitized');

// Fields that should be redacted (contain actual question/passage content)
const SENSITIVE_TEXT_FIELDS = [
    'question_text',
    'text',
    'passage',
    'passage_text',
    'solution_text',
    'explanation',
    'hint',
    'context_text',
];

// Fields that are options arrays
const OPTIONS_FIELDS = ['options'];

// Fields that are answers
const ANSWER_FIELDS = ['correct_answer', 'answer', 'correct_option'];

/**
 * Strip JSONC comments and parse as JSON
 */
function parseJsonc(content) {
    // Remove single-line comments (// ...)
    let cleaned = content.replace(/\/\/.*$/gm, '');
    // Remove multi-line comments (/* ... */)
    cleaned = cleaned.replace(/\/\*[\s\S]*?\*\//g, '');
    return JSON.parse(cleaned);
}

/**
 * Check if a file looks like a question paper JSON
 */
function isQuestionPaperFile(data) {
    if (typeof data !== 'object' || data === null) return false;

    // Check for common question paper keys
    const hasQuestions = 'questions' in data ||
        (Array.isArray(data) && data.some(item => 'question_text' in item));
    const hasPaper = 'paper' in data;
    const hasContexts = 'contexts' in data;

    return hasQuestions || hasPaper || hasContexts;
}

/**
 * Sanitize a single value based on its key
 */
function sanitizeValue(key, value) {
    const lowerKey = key.toLowerCase();

    // Check if it's a sensitive text field - redact regardless of length
    if (SENSITIVE_TEXT_FIELDS.some(field => lowerKey.includes(field.toLowerCase()))) {
        if (typeof value === 'string') {
            return `<${key.toUpperCase()}_OMITTED>`;
        }
    }

    // Check if it's an options field
    if (OPTIONS_FIELDS.some(field => lowerKey === field.toLowerCase())) {
        if (Array.isArray(value) && value.length > 0) {
            return ['<OPTION_A>', '<OPTION_B>', '<OPTION_C>', '<OPTION_D>'].slice(0, Math.min(value.length, 4));
        }
    }

    // Check if it's an answer field
    if (ANSWER_FIELDS.some(field => lowerKey === field.toLowerCase())) {
        return '<ANSWER_OMITTED>';
    }

    return value;
}

/**
 * Recursively sanitize an object
 */
function sanitizeObject(obj, depth = 0) {
    if (obj === null || obj === undefined) return obj;

    if (Array.isArray(obj)) {
        if (obj.length === 0) return obj;

        // For question/context arrays, keep only first item with a note
        const firstItemKeys = typeof obj[0] === 'object' && obj[0] !== null ? Object.keys(obj[0]) : [];
        const isQuestionOrContextArray = firstItemKeys.some(k =>
            ['question_text', 'text', 'question_number', 'id', 'title'].includes(k)
        );

        if (isQuestionOrContextArray && obj.length > 1) {
            const sanitizedFirst = sanitizeObject(obj[0], depth + 1);
            return [
                sanitizedFirst,
                { '_NOTE': `... ${obj.length - 1} more items omitted (total: ${obj.length}) ...` }
            ];
        }

        return obj.map(item => sanitizeObject(item, depth + 1));
    }

    if (typeof obj === 'object') {
        const result = {};
        for (const [key, value] of Object.entries(obj)) {
            if (typeof value === 'object' && value !== null) {
                result[key] = sanitizeObject(value, depth + 1);
            } else {
                result[key] = sanitizeValue(key, value);
            }
        }
        return result;
    }

    return obj;
}

/**
 * Generate a schema description for the file
 */
function generateSchemaDescription(data) {
    const schema = {
        _SCHEMA_NOTE: 'This file has been sanitized. Question text, options, answers, and passages have been replaced with placeholders.',
        _ORIGINAL_STRUCTURE: describeStructure(data)
    };
    return schema;
}

/**
 * Describe the structure of data for schema documentation
 */
function describeStructure(data, depth = 0) {
    if (depth > 3) return '...';

    if (data === null) return 'null';
    if (Array.isArray(data)) {
        if (data.length === 0) return '[]';
        return `Array<${describeStructure(data[0], depth + 1)}> (${data.length} items)`;
    }
    if (typeof data === 'object') {
        const keys = Object.keys(data).slice(0, 10);
        const desc = keys.map(k => `${k}: ${typeof data[k]}`).join(', ');
        return `{ ${desc}${Object.keys(data).length > 10 ? ', ...' : ''} }`;
    }
    return typeof data;
}

/**
 * Process a single file
 */
function processFile(filePath, fileName) {
    console.log(`  Processing: ${fileName}`);

    const content = fs.readFileSync(filePath, 'utf-8');
    let data;

    try {
        // Try JSONC first (handles comments)
        data = parseJsonc(content);
    } catch (e) {
        console.log(`    Warning: Failed to parse ${fileName}: ${e.message}`);
        return null;
    }

    if (!isQuestionPaperFile(data)) {
        console.log(`    Skipping: Not a question paper file`);
        return null;
    }

    // Generate sanitized version
    const sanitized = {
        ...generateSchemaDescription(data),
        ...sanitizeObject(data)
    };

    return sanitized;
}

/**
 * Main function
 */
function main() {
    console.log('🧹 Sanitizing question paper data...\n');

    // Ensure output directory exists
    fs.mkdirSync(OUTPUT_DIR, { recursive: true });

    // Get all JSON/JSONC files from data directory
    const files = fs.readdirSync(DATA_DIR).filter(f =>
        f.endsWith('.json') || f.endsWith('.jsonc')
    );

    if (files.length === 0) {
        console.log('  No JSON/JSONC files found in /data');
        return { processed: [], skipped: [] };
    }

    const processed = [];
    const skipped = [];

    for (const fileName of files) {
        const filePath = path.join(DATA_DIR, fileName);
        const sanitized = processFile(filePath, fileName);

        if (sanitized) {
            // Write sanitized file
            const outputPath = path.join(OUTPUT_DIR, fileName);
            fs.writeFileSync(outputPath, JSON.stringify(sanitized, null, 2));
            processed.push(fileName);
            console.log(`    ✅ Sanitized: ${fileName}`);
        } else {
            skipped.push(fileName);
        }
    }

    console.log(`\n📊 Summary:`);
    console.log(`  Processed: ${processed.length} files`);
    console.log(`  Skipped: ${skipped.length} files`);
    console.log(`  Output: ${OUTPUT_DIR}`);

    return { processed, skipped };
}

// Run if called directly
main();

export { main, sanitizeObject, parseJsonc, isQuestionPaperFile };
````

## File: scripts/transform-cat-2025-slot-3-md.mjs
````javascript
#!/usr/bin/env node
/**
 * Parse CAT 2025 Slot 3 structured markdown and emit schema v3 JSON.
 * Handles both plain text format and markdown format with escaped characters.
 * Usage: node scripts/transform-cat-2025-slot-3-md.mjs <input.md> <output.json>
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { resolve } from 'path';

const VALID_CONTEXT_TYPES = new Set([
    'rc_passage',
    'dilr_set',
    'caselet',
    'data_table',
    'graph',
    'other_shared_stimulus',
]);

/**
 * Unescape markdown-escaped characters (e.g., \_ -> _, \[ -> [)
 */
function unescapeMarkdown(text) {
    if (!text) return text;
    return text
        .replace(/\\_/g, '_')
        .replace(/\\\[/g, '[')
        .replace(/\\\]/g, ']')
        .replace(/\\-/g, '-')
        .replace(/\\>/g, '>')
        .replace(/\\\*/g, '*')
        .replace(/\\\(/g, '(')
        .replace(/\\\)/g, ')')
        .replace(/\\=/g, '=')
        .replace(/\\#/g, '#')
        .replace(/\\!/g, '!')
        .replace(/\\~/g, '~');
}

function stripQuotes(value) {
    const trimmed = value.trim();
    if ((trimmed.startsWith('"') && trimmed.endsWith('"')) || (trimmed.startsWith("'") && trimmed.endsWith("'"))) {
        return unescapeMarkdown(trimmed.slice(1, -1));
    }
    return unescapeMarkdown(trimmed);
}

function parseNumber(value) {
    const num = Number(value);
    return Number.isFinite(num) ? num : value;
}

function normalizeBlockLine(line) {
    return unescapeMarkdown(line)
        .replace(/\*/g, '')
        .replace(/#/g, '')
        .trim();
}

function isBlockStart(line) {
    const normalized = normalizeBlockLine(line);
    return normalized.startsWith('Section:') || normalized === 'SET' || normalized === 'QUESTION';
}

function isKeyLine(line) {
    // Handle escaped keys like client\_set\_id: as well as client_set_id:
    return /^[A-Za-z_\\]+:\s*/.test(line);
}

function parseMultilineValue(lines, startIndex) {
    const collected = [];
    let i = startIndex;

    while (i < lines.length) {
        const raw = lines[i];
        const line = raw.trimEnd();

        if (isBlockStart(line)) break;
        if (isKeyLine(line)) break;

        // Preserve raw line (including tables) but unescape markdown
        collected.push(unescapeMarkdown(raw.replace(/\r$/, '')));
        i += 1;
    }

    return { value: collected.join('\n').trimEnd(), nextIndex: i };
}

function parseHeader(lines) {
    const header = {};
    let i = 0;

    for (; i < lines.length; i += 1) {
        const raw = lines[i];
        const line = raw.trim();

        if (!line) continue;
        if (normalizeBlockLine(line).startsWith('Section:')) break;
        if (line === '________________________________________') continue;
        if (line.startsWith('Here is the structured')) continue;
        if (line.startsWith('•')) continue;
        // Skip markdown header lines like "# CAT 2025..."
        if (line.startsWith('#')) continue;
        // Skip markdown separators (including escaped front-matter markers)
        if (line === '---' || line === '\\---' || line === '***') continue;

        // Handle escaped keys like paper\_key: value
        const match = line.match(/^([A-Za-z0-9_\\]+):\s*(.*)$/);
        if (match) {
            const key = unescapeMarkdown(match[1]);
            const value = stripQuotes(match[2]);
            header[key] = parseNumber(value);
        }
    }

    return { header, nextIndex: i };
}

function normalizeContextType(value) {
    if (!value) return undefined;
    const normalized = value.trim();
    if (!VALID_CONTEXT_TYPES.has(normalized)) {
        return undefined;
    }
    return normalized;
}

function parseSetsAndQuestions(lines, startIndex, defaults) {
    const questionSets = [];
    const questions = [];

    let currentSection = null;
    let currentSet = null;
    let i = startIndex;

    while (i < lines.length) {
        const raw = lines[i];
        const line = raw.trim();

        if (!line) {
            i += 1;
            continue;
        }

        // Handle both "Section: VARC" and "**Section: VARC**"
        if (normalizeBlockLine(line).startsWith('Section:')) {
            const sectionText = normalizeBlockLine(line).replace('Section:', '').trim();
            currentSection = sectionText;
            i += 1;
            continue;
        }

        if (normalizeBlockLine(line) === 'SET') {
            currentSet = { section: currentSection };
            i += 1;

            while (i < lines.length) {
                const row = lines[i].trim();
                if (!row) {
                    i += 1;
                    continue;
                }
                if (isBlockStart(row)) break;

                if (row.startsWith('metadata:') || row.startsWith('metadata\\_:')) {
                    i += 1;
                    while (i < lines.length) {
                        const metaLine = lines[i].trim();
                        if (!metaLine) {
                            i += 1;
                            continue;
                        }
                        if (isBlockStart(metaLine)) break;
                        const metaMatch = metaLine.match(/^([A-Za-z0-9_\\]+):\s*(.*)$/);
                        if (!metaMatch) break;
                        i += 1;
                    }
                    continue;
                }

                // Handle escaped keys like client\_set\_id:
                const match = row.match(/^([A-Za-z0-9_\\]+):\s*(.*)$/);
                if (!match) {
                    i += 1;
                    continue;
                }

                const key = unescapeMarkdown(match[1]);
                const value = match[2];

                if (value === '|') {
                    const { value: blockValue, nextIndex } = parseMultilineValue(lines, i + 1);
                    currentSet[key] = blockValue;
                    i = nextIndex;
                    continue;
                }

                currentSet[key] = stripQuotes(value);
                i += 1;
            }

            if (currentSet) {
                if (!currentSet.section && currentSection) currentSet.section = currentSection;
                if (currentSet.display_order !== undefined) {
                    currentSet.display_order = Number(currentSet.display_order);
                }
                if (currentSet.context_type) {
                    const normalized = normalizeContextType(String(currentSet.context_type));
                    if (!normalized) {
                        delete currentSet.context_type;
                    } else {
                        currentSet.context_type = normalized;
                    }
                }

                questionSets.push(currentSet);
            }
            continue;
        }

        if (normalizeBlockLine(line) === 'QUESTION') {
            const question = { set_ref: currentSet?.client_set_id, section: currentSection };
            i += 1;

            while (i < lines.length) {
                const row = lines[i].trim();
                if (!row) {
                    i += 1;
                    continue;
                }
                if (isBlockStart(row)) break;

                // Handle escaped keys like client\_question\_id:
                const match = row.match(/^([A-Za-z0-9_\\]+):\s*(.*)$/);
                if (!match) {
                    i += 1;
                    continue;
                }

                const key = unescapeMarkdown(match[1]);
                const value = match[2];

                if (key === 'options') {
                    if (value.trim() === 'null') {
                        question.options = null;
                        i += 1;
                        continue;
                    }

                    const opts = [];
                    i += 1;
                    while (i < lines.length) {
                        const optLine = lines[i].trim();
                        if (!optLine) {
                            i += 1;
                            continue;
                        }

                        const optMatch = optLine.match(/^([A-D]):\s*(.*)$/);
                        if (optMatch) {
                            // Store as plain text string (DB expects string array, not {id, text} objects)
                            opts.push(stripQuotes(optMatch[2]));
                            i += 1;
                            continue;
                        }

                        if (isBlockStart(optLine) || isKeyLine(optLine)) break;
                        i += 1;
                    }
                    question.options = opts.length ? opts : null;
                    continue;
                }

                if (value === '|') {
                    const { value: blockValue, nextIndex } = parseMultilineValue(lines, i + 1);
                    question[key] = blockValue;
                    i = nextIndex;
                    continue;
                }

                question[key] = stripQuotes(value);
                i += 1;
            }

            if (!question.section && currentSection) question.section = currentSection;
            if (question.question_number !== undefined) question.question_number = Number(question.question_number);
            if (question.sequence_order !== undefined) question.sequence_order = Number(question.sequence_order);

            const defaultPositive = Number(defaults.default_positive_marks ?? 3);
            const defaultNegative = Number(defaults.default_negative_marks ?? 1);

            question.positive_marks = Number.isFinite(defaultPositive) ? defaultPositive : 3;
            question.negative_marks = question.question_type === 'TITA' ? 0 : (Number.isFinite(defaultNegative) ? defaultNegative : 1);

            if (question.difficulty) {
                const normalized = String(question.difficulty).trim().toLowerCase();
                if (normalized === 'difficult') {
                    question.difficulty = 'hard';
                } else if (['easy', 'medium', 'hard'].includes(normalized)) {
                    question.difficulty = normalized;
                } else {
                    delete question.difficulty;
                }
            }

            questions.push(question);
            continue;
        }

        i += 1;
    }

    const setMap = new Map(questionSets.map(set => [set.client_set_id, set]));
    for (const question of questions) {
        if (question.section === 'VARC' && typeof question.subtopic === 'string') {
            const subtopic = question.subtopic.toLowerCase();
            if (subtopic.includes('para jumble')) {
                const set = setMap.get(question.set_ref);
                if (set) {
                    set.context_body = '';
                    set.context_title = '';
                    delete set.context_type;
                }
            }
        }
    }

    return { questionSets, questions };
}

function buildPaper(header, defaults) {
    return {
        paper_key: header.paper_key ?? 'CAT_2025_SLOT3',
        title: header.title ?? 'CAT 2025 Slot 3',
        slug: header.slug ?? 'cat-2025-slot-3',
        description: header.import_notes ?? header.source_pdf ?? 'CAT 2025 Slot 3 Question Paper',
        year: Number(header.year ?? 2025),
        total_questions: Number(header.total_questions ?? 68),
        total_marks: Number(header.total_marks ?? 198),
        duration_minutes: Number(header.duration_minutes ?? 120),
        sections: ['VARC', 'DILR', 'QA'],
        default_positive_marks: Number(defaults.default_positive_marks ?? 3),
        default_negative_marks: Number(defaults.default_negative_marks ?? 1),
        difficulty_level: 'cat-level',
        is_free: true,
        published: false,
        allow_pause: true,
        attempt_limit: 0,
    };
}

function main() {
    const inputPath = process.argv[2];
    const outputPath = process.argv[3] ?? 'data/CAT-2025-Slot-3-v3.json';

    if (!inputPath) {
        console.error('Usage: node scripts/transform-cat-2025-slot-3-md.mjs <input.txt> <output.json>');
        process.exit(1);
    }

    const resolvedInput = resolve(process.cwd(), inputPath);
    if (!existsSync(resolvedInput)) {
        console.error(`❌ File not found: ${resolvedInput}`);
        process.exit(1);
    }

    const resolvedOutput = resolve(process.cwd(), outputPath);

    const raw = readFileSync(resolvedInput, 'utf-8').replace(/\r\n/g, '\n');
    const lines = raw.split('\n');

    const { header, nextIndex } = parseHeader(lines);
    const defaults = {
        default_positive_marks: header.default_positive_marks ?? 3,
        default_negative_marks: header.default_negative_marks ?? 1,
    };

    const { questionSets, questions } = parseSetsAndQuestions(lines, nextIndex, defaults);

    const output = {
        schema_version: 'v3.0',
        paper: buildPaper(header, defaults),
        question_sets: questionSets,
        questions,
    };

    writeFileSync(resolvedOutput, JSON.stringify(output, null, 2));
    console.log(`✅ Parsed ${questionSets.length} sets and ${questions.length} questions.`);
    console.log(`📄 Output: ${resolvedOutput}`);
}

main();
````

## File: src/app/admin/access-control/page.tsx
````typescript
/**
 * @fileoverview Admin Access Control
 * @description Manage signup mode and waitlist access requests
 */

import { sbSSR } from '@/lib/supabase/server';
import { approveAccessRequest, rejectAccessRequest, updateSignupMode } from './actions';

type AccessRequest = {
    id: string;
    user_id: string | null;
    email: string;
    status: 'pending' | 'approved' | 'rejected';
    source?: string | null;
    created_at: string;
    decided_at?: string | null;
};

export default async function AccessControlPage() {
    const supabase = await sbSSR();

    const { data: settingRow, error: settingError } = await supabase
        .from('app_settings')
        .select('setting_value, updated_at, updated_by')
        .eq('setting_key', 'signup_mode')
        .maybeSingle();

    const signupMode = settingRow?.setting_value ?? 'GATED';
    const signupUpdatedAt = settingRow?.updated_at ?? null;

    if (settingError) {
        // Keep page working even if the table hasn't been migrated yet.
        console.warn('Failed to load signup_mode setting', settingError.message);
    }

    const { data: requestRows } = await supabase
        .from('access_requests')
        .select('id, user_id, email, status, source, created_at, decided_at')
        .not('user_id', 'is', null)
        .order('created_at', { ascending: false })
        .limit(200);

    const requests = (requestRows ?? []) as AccessRequest[];
    const pendingCount = requests.filter((r) => r.status === 'pending').length;

    return (
        <div className="space-y-8">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">Access Control</h1>
                    <p className="text-sm text-gray-500 mt-1">
                        Control signup mode and review waitlist requests.
                    </p>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="bg-white rounded-lg shadow p-6 lg:col-span-1">
                    <h2 className="text-lg font-semibold text-gray-900 mb-4">Signup Mode</h2>
                    <form action={updateSignupMode} className="space-y-4">
                        <div>
                            <label className="text-sm font-medium text-gray-700">Current mode</label>
                            <div className="mt-2 flex items-center gap-2">
                                <span className={`px-2 py-1 rounded text-xs font-semibold ${signupMode === 'OPEN' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                    {signupMode}
                                </span>
                                {signupUpdatedAt && (
                                    <span className="text-xs text-gray-400">
                                        Updated {new Date(signupUpdatedAt).toLocaleString()}
                                    </span>
                                )}
                            </div>
                        </div>
                        <div>
                            <label htmlFor="signup_mode" className="text-sm font-medium text-gray-700">
                                Set mode
                            </label>
                            <select
                                id="signup_mode"
                                name="signup_mode"
                                defaultValue={signupMode}
                                className="mt-2 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                            >
                                <option value="OPEN">OPEN (auto-approve)</option>
                                <option value="GATED">GATED (waitlist)</option>
                            </select>
                        </div>
                        <button
                            type="submit"
                            className="w-full bg-indigo-600 text-white rounded-lg py-2 text-sm font-semibold hover:bg-indigo-700 transition-colors"
                        >
                            Update mode
                        </button>
                    </form>
                    <p className="text-xs text-gray-500 mt-4">
                        OPEN makes new signups active. GATED sends new users to the waitlist.
                    </p>
                </div>

                <div className="bg-white rounded-lg shadow p-6 lg:col-span-2">
                    <div className="flex items-center justify-between mb-4">
                        <div>
                            <h2 className="text-lg font-semibold text-gray-900">Access Requests</h2>
                            <p className="text-sm text-gray-500">{pendingCount} pending</p>
                        </div>
                    </div>

                    {requests.length === 0 ? (
                        <div className="text-sm text-gray-500">No access requests yet.</div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full text-sm">
                                <thead>
                                    <tr className="text-left text-gray-500">
                                        <th className="py-2 pr-4">Email</th>
                                        <th className="py-2 pr-4">Status</th>
                                        <th className="py-2 pr-4">Requested</th>
                                        <th className="py-2 pr-4">Source</th>
                                        <th className="py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {requests.map((request) => (
                                        <tr key={request.id} className="text-gray-700">
                                            <td className="py-3 pr-4">{request.email}</td>
                                            <td className="py-3 pr-4">
                                                <span className={`px-2 py-1 rounded text-xs font-semibold ${request.status === 'approved' ? 'bg-green-100 text-green-700' : request.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                                    {request.status}
                                                </span>
                                            </td>
                                            <td className="py-3 pr-4">
                                                {new Date(request.created_at).toLocaleDateString()}
                                            </td>
                                            <td className="py-3 pr-4">{request.source ?? '—'}</td>
                                            <td className="py-3">
                                                {request.status === 'pending' ? (
                                                    <div className="flex items-center gap-2">
                                                        <form action={approveAccessRequest}>
                                                            <input type="hidden" name="request_id" value={request.id} />
                                                            <input type="hidden" name="user_id" value={request.user_id ?? ''} />
                                                            <button
                                                                type="submit"
                                                                className="px-3 py-1 rounded bg-green-600 text-white text-xs font-semibold hover:bg-green-700"
                                                            >
                                                                Approve
                                                            </button>
                                                        </form>
                                                        <form action={rejectAccessRequest}>
                                                            <input type="hidden" name="request_id" value={request.id} />
                                                            <input type="hidden" name="user_id" value={request.user_id ?? ''} />
                                                            <button
                                                                type="submit"
                                                                className="px-3 py-1 rounded bg-red-600 text-white text-xs font-semibold hover:bg-red-700"
                                                            >
                                                                Reject
                                                            </button>
                                                        </form>
                                                    </div>
                                                ) : (
                                                    <span className="text-xs text-gray-400">
                                                        {request.decided_at ? new Date(request.decided_at).toLocaleDateString() : '—'}
                                                    </span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}
````

## File: src/app/admin/bug-reports/BugReportStatusSelect.tsx
````typescript
'use client';

import { useState, useTransition } from 'react';
import { updateBugReportStatus } from './actions';

const STATUS_OPTIONS = [
    { value: 'unchecked', label: 'Unchecked' },
    { value: 'in_progress', label: 'In Progress' },
    { value: 'resolved', label: 'Resolved' },
] as const;

type BugReportStatusSelectProps = {
    reportId: string;
    status?: string | null;
};

export default function BugReportStatusSelect({ reportId, status }: BugReportStatusSelectProps) {
    const [value, setValue] = useState(status ?? 'unchecked');
    const [isPending, startTransition] = useTransition();
    const [error, setError] = useState<string | null>(null);

    const handleChange = (next: string) => {
        setValue(next);
        setError(null);
        startTransition(async () => {
            const result = await updateBugReportStatus(reportId, next as 'unchecked' | 'in_progress' | 'resolved');
            if (!result.success) {
                setError(result.error || 'Update failed');
            }
        });
    };

    return (
        <div className="space-y-1">
            <select
                value={value}
                onChange={(event) => handleChange(event.target.value)}
                className="rounded-md border border-gray-200 px-2 py-1 text-xs text-gray-700 bg-white"
                disabled={isPending}
            >
                {STATUS_OPTIONS.map((option) => (
                    <option key={option.value} value={option.value}>
                        {option.label}
                    </option>
                ))}
            </select>
            {error && <div className="text-[11px] text-red-600">{error}</div>}
        </div>
    );
}
````

## File: src/app/admin/landing-page/page.tsx
````typescript
import LandingAssetsClient from './LandingAssetsClient';

export default function LandingAssetsPage() {
    return (
        <div className="space-y-6">
            <div>
                <h1 className="text-3xl font-bold text-gray-900">Landing Page Assets</h1>
                <p className="mt-2 text-sm text-gray-600">
                    Replace landing images without redeploys. Uploading updates the public URL immediately.
                </p>
            </div>
            <LandingAssetsClient />
        </div>
    );
}
````

## File: src/app/admin/papers/ImportPaperButton.tsx
````typescript
'use client';

/**
 * @fileoverview Import Paper Button Component  
 * @description Client-side component for importing papers via Schema v3.0 JSON
 */

import { useState, useRef } from 'react';
import { useRouter } from 'next/navigation';

interface ImportResult {
    success: boolean;
    paperId?: string;
    slug?: string;
    version?: number;
    setsCount?: number;
    questionsCount?: number;
    published?: boolean;
    skipped?: boolean;
    message?: string;
    error?: string;
    details?: string[];
}

export default function ImportPaperButton() {
    const [isImporting, setIsImporting] = useState(false);
    const [showModal, setShowModal] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [errorDetails, setErrorDetails] = useState<string[]>([]);
    const [result, setResult] = useState<ImportResult | null>(null);
    const [publishOnImport, setPublishOnImport] = useState(false);
    const [skipIfDuplicate, setSkipIfDuplicate] = useState(true);
    const [importNotes, setImportNotes] = useState('');
    const fileInputRef = useRef<HTMLInputElement>(null);
    const router = useRouter();

    const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (!file) return;

        setIsImporting(true);
        setError(null);
        setErrorDetails([]);
        setResult(null);

        try {
            // Read file content
            const content = await file.text();
            let data;

            try {
                data = JSON.parse(content);
            } catch {
                throw new Error('Invalid JSON file. Please check the file format.');
            }

            // Quick schema check before sending
            if (data.schema_version !== 'v3.0') {
                throw new Error(
                    `Schema version must be 'v3.0'. Got: ${data.schema_version || 'undefined'}. ` +
                    `Use the CLI importer for legacy formats.`
                );
            }

            // Send to API
            const response = await fetch('/api/admin/papers/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data,
                    publish: publishOnImport,
                    skipIfDuplicate,
                    notes: importNotes || `Imported from ${file.name}`,
                }),
            });

            const responseData = await response.json() as ImportResult;

            if (!response.ok) {
                if (responseData.details && responseData.details.length > 0) {
                    setErrorDetails(responseData.details);
                }
                throw new Error(responseData.error || responseData.message || 'Import failed');
            }

            setResult(responseData);

            // Refresh the page to show the new paper
            if (!responseData.skipped) {
                setTimeout(() => {
                    router.refresh();
                }, 1500);
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Import failed');
        } finally {
            setIsImporting(false);
            // Reset file input
            if (fileInputRef.current) {
                fileInputRef.current.value = '';
            }
        }
    };

    const openModal = () => {
        setShowModal(true);
        setError(null);
        setErrorDetails([]);
        setResult(null);
    };

    const closeModal = () => {
        setShowModal(false);
        setError(null);
        setErrorDetails([]);
        setResult(null);
        setImportNotes('');
    };

    return (
        <>
            <button
                onClick={openModal}
                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2"
            >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Import JSON
            </button>

            {/* Import Modal */}
            {showModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 overflow-hidden">
                        {/* Header */}
                        <div className="bg-green-600 px-6 py-4">
                            <h2 className="text-xl font-semibold text-white">Import Paper (Schema v3.0)</h2>
                        </div>

                        {/* Content */}
                        <div className="p-6 space-y-4">
                            {/* Result Display */}
                            {result && (
                                <div className={`p-4 rounded-lg ${result.skipped ? 'bg-yellow-50 border border-yellow-200' : 'bg-green-50 border border-green-200'}`}>
                                    <div className="flex items-start gap-3">
                                        <div className={`flex-shrink-0 ${result.skipped ? 'text-yellow-500' : 'text-green-500'}`}>
                                            {result.skipped ? (
                                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                                </svg>
                                            ) : (
                                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                                </svg>
                                            )}
                                        </div>
                                        <div>
                                            <h3 className={`font-medium ${result.skipped ? 'text-yellow-800' : 'text-green-800'}`}>
                                                {result.skipped ? 'Import Skipped' : 'Import Successful!'}
                                            </h3>
                                            <ul className="mt-2 text-sm text-gray-600 space-y-1">
                                                {result.slug && <li><strong>Slug:</strong> {result.slug}</li>}
                                                {result.version && <li><strong>Version:</strong> {result.version}</li>}
                                                {result.setsCount !== undefined && <li><strong>Sets:</strong> {result.setsCount}</li>}
                                                {result.questionsCount !== undefined && <li><strong>Questions:</strong> {result.questionsCount}</li>}
                                                {result.published !== undefined && (
                                                    <li><strong>Status:</strong> {result.published ? 'Published' : 'Draft'}</li>
                                                )}
                                                {result.message && <li className="text-yellow-700">{result.message}</li>}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Error Display */}
                            {error && (
                                <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
                                    <div className="flex items-start gap-3">
                                        <div className="flex-shrink-0 text-red-500">
                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 className="font-medium text-red-800">Import Failed</h3>
                                            <p className="mt-1 text-sm text-red-700">{error}</p>
                                            {errorDetails.length > 0 && (
                                                <ul className="mt-2 text-xs text-red-600 list-disc list-inside max-h-32 overflow-y-auto">
                                                    {errorDetails.map((detail, idx) => (
                                                        <li key={idx}>{detail}</li>
                                                    ))}
                                                </ul>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Import Options */}
                            {!result && (
                                <>
                                    <div className="space-y-3">
                                        <label className="flex items-center gap-2">
                                            <input
                                                type="checkbox"
                                                checked={publishOnImport}
                                                onChange={(e) => setPublishOnImport(e.target.checked)}
                                                className="rounded border-gray-300 text-green-600 focus:ring-green-500"
                                            />
                                            <span className="text-sm text-gray-700">Publish immediately after import</span>
                                        </label>

                                        <label className="flex items-center gap-2">
                                            <input
                                                type="checkbox"
                                                checked={skipIfDuplicate}
                                                onChange={(e) => setSkipIfDuplicate(e.target.checked)}
                                                className="rounded border-gray-300 text-green-600 focus:ring-green-500"
                                            />
                                            <span className="text-sm text-gray-700">Skip if duplicate (same JSON hash)</span>
                                        </label>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Import Notes (optional)
                                            </label>
                                            <input
                                                type="text"
                                                value={importNotes}
                                                onChange={(e) => setImportNotes(e.target.value)}
                                                placeholder="e.g., Initial import, Bug fix, etc."
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-green-500 focus:border-green-500"
                                            />
                                        </div>
                                    </div>

                                    {/* File Upload */}
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-500 transition-colors">
                                        <input
                                            ref={fileInputRef}
                                            type="file"
                                            accept=".json"
                                            onChange={handleFileSelect}
                                            disabled={isImporting}
                                            className="hidden"
                                            id="import-file"
                                        />
                                        <label
                                            htmlFor="import-file"
                                            className={`cursor-pointer ${isImporting ? 'opacity-50' : ''}`}
                                        >
                                            <svg className="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                            </svg>
                                            <p className="mt-2 text-sm text-gray-600">
                                                {isImporting ? (
                                                    <span className="flex items-center justify-center gap-2">
                                                        <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24">
                                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                                                        </svg>
                                                        Importing...
                                                    </span>
                                                ) : (
                                                    <>
                                                        <span className="text-green-600 font-medium">Click to upload</span> or drag and drop
                                                    </>
                                                )}
                                            </p>
                                            <p className="mt-1 text-xs text-gray-500">
                                                JSON file (Schema v3.0 format)
                                            </p>
                                        </label>
                                    </div>

                                    {/* Help Text */}
                                    <div className="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                                        <p className="font-medium mb-1">Schema v3.0 (Sets-First) Format:</p>
                                        <pre className="text-xs overflow-x-auto">
                                            {`{
  "schema_version": "v3.0",
  "paper": { "slug": "...", "title": "..." },
  "question_sets": [{ "client_set_id": "...", ... }],
  "questions": [{ "set_ref": "...", ... }]
}`}
                                        </pre>
                                        <p className="mt-2">
                                            See <code className="bg-gray-200 px-1 rounded">schemas/paper_schema_v3.json</code> for the full schema.
                                        </p>
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="bg-gray-50 px-6 py-4 flex justify-end">
                            <button
                                onClick={closeModal}
                                className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                {result ? 'Close' : 'Cancel'}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </>
    );
}
````

## File: src/app/admin/papers/PaperActions.tsx
````typescript
'use client';

/**
 * @fileoverview Paper Actions Component
 * @description Client-side actions for paper management including edit, settings, questions, export, and delete
 */

import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { useState } from 'react';
import { deletePaper } from './actions';

interface PaperActionsProps {
    paperId: string;
}

export default function PaperActions({ paperId }: PaperActionsProps) {
    const [isExporting, setIsExporting] = useState(false);
    const [exportError, setExportError] = useState<string | null>(null);
    const [showExportMenu, setShowExportMenu] = useState(false);
    const [isDeleting, setIsDeleting] = useState(false);
    const [deleteError, setDeleteError] = useState<string | null>(null);
    const router = useRouter();

    const handleExport = async (format: 'v1' | 'v3' = 'v1') => {
        setIsExporting(true);
        setExportError(null);
        setShowExportMenu(false);

        try {
            const url = format === 'v3'
                ? `/api/admin/papers/${paperId}/export?format=v3`
                : `/api/admin/papers/${paperId}/export?assembled=true`;

            const response = await fetch(url);

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Export failed');
            }

            // Get filename from Content-Disposition header or use default
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `paper_${paperId}.json`;
            if (contentDisposition) {
                const match = contentDisposition.match(/filename="?([^";\n]+)"?/);
                if (match) {
                    filename = match[1];
                }
            }

            // Download the file
            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(blobUrl);
            document.body.removeChild(a);
        } catch (error) {
            console.error('Export error:', error);
            setExportError(error instanceof Error ? error.message : 'Export failed');
        } finally {
            setIsExporting(false);
        }
    };

    return (
        <div className="flex items-center gap-2">
            {exportError && (
                <span className="text-xs text-red-600" title={exportError}>
                    Export failed
                </span>
            )}

            {/* Edit Button */}
            <Link
                href={`/admin/papers/${paperId}/edit`}
                className="text-blue-600 hover:text-blue-900 hover:underline"
                title="Edit paper content"
            >
                Edit
            </Link>

            {/* Preview Button */}
            <Link
                href={`/admin/papers/${paperId}/preview`}
                className="text-purple-600 hover:text-purple-900 hover:underline"
                title="Preview as student"
            >
                Preview
            </Link>

            {/* Settings Button */}
            <Link
                href={`/admin/papers/${paperId}/settings`}
                className="text-gray-600 hover:text-gray-900 hover:underline"
                title="Paper settings"
            >
                Settings
            </Link>

            {/* Questions Button */}
            <Link
                href={`/admin/papers/${paperId}/questions`}
                className="text-gray-600 hover:text-gray-900 hover:underline"
                title="View questions"
            >
                Questions
            </Link>

            {/* Export Button with Dropdown */}
            <div className="relative">
                <button
                    onClick={() => setShowExportMenu(!showExportMenu)}
                    disabled={isExporting}
                    className="text-green-600 hover:text-green-900 hover:underline disabled:opacity-50 disabled:cursor-not-allowed"
                    title="Download paper JSON"
                >
                    {isExporting ? 'Exporting...' : 'Export ▾'}
                </button>
                {showExportMenu && (
                    <div className="absolute right-0 mt-1 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
                        <button
                            onClick={() => handleExport('v1')}
                            className="w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg"
                        >
                            Export v1 (Legacy)
                        </button>
                        <button
                            onClick={() => handleExport('v3')}
                            className="w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 rounded-b-lg border-t"
                        >
                            Export v3 (Sets-First)
                        </button>
                    </div>
                )}
            </div>

            {deleteError && (
                <span className="text-xs text-red-600" title={deleteError}>
                    Delete failed
                </span>
            )}

            {/* Delete Button - styled as dangerous action */}
            <button
                onClick={async () => {
                    if (isDeleting) return;
                    setDeleteError(null);
                    if (!confirm('Are you sure you want to delete this paper? This action cannot be undone.')) {
                        return;
                    }
                    setIsDeleting(true);
                    const result = await deletePaper(paperId);
                    if (!result.success) {
                        setDeleteError(result.error || 'Delete failed');
                    } else {
                        router.refresh();
                    }
                    setIsDeleting(false);
                }}
                className="text-red-600 hover:text-red-900 hover:underline disabled:opacity-50 disabled:cursor-not-allowed"
                title="Delete paper"
                disabled={isDeleting}
            >
                {isDeleting ? 'Deleting...' : 'Delete'}
            </button>
        </div>
    );
}
````

## File: src/app/admin/question-sets/new/NewQuestionSetClient.tsx
````typescript
/**
 * @fileoverview New Question Set Client Component
 * @description Client-side form for creating question sets
 * @blueprint Question Container Architecture
 */

'use client';

import { useState, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import type { SectionName, ContentLayoutType } from '@/types/exam';

// Local type that includes ATOMIC (matches database schema)
type QuestionSetType = 'VARC' | 'DILR' | 'CASELET' | 'ATOMIC';

interface Paper {
    id: string;
    title: string;
    slug: string;
}

interface NewQuestionSetClientProps {
    papers: Paper[];
}

interface QuestionDraft {
    tempId: string;
    question_text: string;
    question_type: 'MCQ' | 'TITA';
    options: string[];
    correct_answer: string;
    positive_marks: number;
    negative_marks: number;
    difficulty?: string;
    topic?: string;
}

const SET_TYPES: { value: QuestionSetType; label: string; description: string }[] = [
    { value: 'VARC', label: 'VARC (Reading Comprehension)', description: 'Passage with 4-6 comprehension questions' },
    { value: 'DILR', label: 'DILR (Data Interpretation / Logical Reasoning)', description: 'Chart/table/data set with analytical questions' },
    { value: 'CASELET', label: 'Caselet', description: 'Case study with multiple questions' },
    { value: 'ATOMIC', label: 'Atomic (Single Question)', description: 'Standalone question without shared context' },
];

const CONTENT_LAYOUTS: { value: ContentLayoutType; label: string }[] = [
    { value: 'split_passage', label: 'Split: Passage Left, Question Right' },
    { value: 'split_chart', label: 'Split: Chart Left, Question Right' },
    { value: 'split_table', label: 'Split: Table Left, Question Right' },
    { value: 'single_focus', label: 'Single Focus (Full Width)' },
    { value: 'image_top', label: 'Image Top, Question Below' },
];

const SECTIONS: SectionName[] = ['VARC', 'DILR', 'QA'];

export function NewQuestionSetClient({ papers }: NewQuestionSetClientProps) {
    const router = useRouter();
    const [saving, setSaving] = useState(false);
    const [error, setError] = useState<string | null>(null);

    // Form state
    const [selectedPaperId, setSelectedPaperId] = useState(papers[0]?.id ?? '');
    const [section, setSection] = useState<SectionName>('VARC');
    const [setType, setSetType] = useState<QuestionSetType>('VARC');
    const [contentLayout, setContentLayout] = useState<ContentLayoutType>('split_passage');
    const [contextTitle, setContextTitle] = useState('');
    const [contextBody, setContextBody] = useState('');
    const [contextImageUrl, setContextImageUrl] = useState('');

    // Questions
    const [questions, setQuestions] = useState<QuestionDraft[]>([]);

    // Auto-suggest layout based on set type
    const handleSetTypeChange = (newType: QuestionSetType) => {
        setSetType(newType);
        if (newType === 'VARC') {
            setContentLayout('split_passage');
            setSection('VARC');
        } else if (newType === 'DILR') {
            setContentLayout('split_chart');
            setSection('DILR');
        } else if (newType === 'CASELET') {
            setContentLayout('split_passage');
        } else if (newType === 'ATOMIC') {
            setContentLayout('single_focus');
            // Add one empty question for atomic
            if (questions.length === 0) {
                addQuestion();
            }
        }
    };

    // Add a new question
    const addQuestion = useCallback(() => {
        setQuestions(prev => [...prev, {
            tempId: `temp-${Date.now()}`,
            question_text: '',
            question_type: 'MCQ',
            options: ['', '', '', ''],
            correct_answer: 'A',
            positive_marks: 3,
            negative_marks: 1,
        }]);
    }, []);

    // Update a question
    const updateQuestion = useCallback((tempId: string, updates: Partial<QuestionDraft>) => {
        setQuestions(prev => prev.map(q =>
            q.tempId === tempId ? { ...q, ...updates } : q
        ));
    }, []);

    // Remove a question
    const removeQuestion = useCallback((tempId: string) => {
        setQuestions(prev => prev.filter(q => q.tempId !== tempId));
    }, []);

    // Submit form
    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError(null);

        // Validation
        if (!selectedPaperId) {
            setError('Please select a paper');
            return;
        }
        if (setType !== 'ATOMIC' && !contextBody.trim()) {
            setError('Context/passage is required for this set type');
            return;
        }
        if (questions.length === 0) {
            setError('At least one question is required');
            return;
        }
        for (const q of questions) {
            if (!q.question_text.trim()) {
                setError('All questions must have text');
                return;
            }
        }

        setSaving(true);

        try {
            // Create the question set via API
            const response = await fetch('/api/admin/question-sets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paper_id: selectedPaperId,
                    section,
                    set_type: setType,
                    content_layout: contentLayout,
                    context_title: contextTitle || null,
                    context_body: contextBody || null,
                    context_image_url: contextImageUrl || null,
                    questions: questions.map((q, index) => ({
                        ...q,
                        sequence_order: index + 1,
                    })),
                }),
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Failed to create question set');
            }

            // Redirect to question sets list
            router.push('/admin/question-sets');
            router.refresh();
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An error occurred');
        } finally {
            setSaving(false);
        }
    };

    return (
        <div className="max-w-4xl mx-auto">
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold text-gray-900">Create Question Set</h1>
                    <p className="text-gray-600">Add a new RC passage, DI/LR set, or atomic question</p>
                </div>
                <Link
                    href="/admin/question-sets"
                    className="text-gray-600 hover:text-gray-900"
                >
                    ← Back to Question Sets
                </Link>
            </div>

            {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
                    {error}
                </div>
            )}

            <form onSubmit={handleSubmit} className="space-y-8">
                {/* Paper Selection */}
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-lg font-semibold mb-4">1. Select Paper</h2>
                    <select
                        value={selectedPaperId}
                        onChange={(e) => setSelectedPaperId(e.target.value)}
                        className="w-full border rounded-lg px-4 py-2"
                        required
                    >
                        <option value="">Select a paper...</option>
                        {papers.map(paper => (
                            <option key={paper.id} value={paper.id}>
                                {paper.title}
                            </option>
                        ))}
                    </select>
                </div>

                {/* Set Type & Configuration */}
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-lg font-semibold mb-4">2. Set Type & Configuration</h2>

                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Set Type
                            </label>
                            <select
                                value={setType}
                                onChange={(e) => handleSetTypeChange(e.target.value as QuestionSetType)}
                                className="w-full border rounded-lg px-4 py-2"
                            >
                                {SET_TYPES.map(type => (
                                    <option key={type.value} value={type.value}>
                                        {type.label}
                                    </option>
                                ))}
                            </select>
                            <p className="text-xs text-gray-500 mt-1">
                                {SET_TYPES.find(t => t.value === setType)?.description}
                            </p>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Section
                            </label>
                            <select
                                value={section}
                                onChange={(e) => setSection(e.target.value as SectionName)}
                                className="w-full border rounded-lg px-4 py-2"
                            >
                                {SECTIONS.map(s => (
                                    <option key={s} value={s}>{s}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Content Layout
                        </label>
                        <select
                            value={contentLayout}
                            onChange={(e) => setContentLayout(e.target.value as ContentLayoutType)}
                            className="w-full border rounded-lg px-4 py-2"
                        >
                            {CONTENT_LAYOUTS.map(layout => (
                                <option key={layout.value} value={layout.value}>
                                    {layout.label}
                                </option>
                            ))}
                        </select>
                    </div>
                </div>

                {/* Context/Passage */}
                {setType !== 'ATOMIC' && (
                    <div className="bg-white rounded-lg shadow p-6">
                        <h2 className="text-lg font-semibold mb-4">3. Context / Passage</h2>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Title (optional)
                                </label>
                                <input
                                    type="text"
                                    value={contextTitle}
                                    onChange={(e) => setContextTitle(e.target.value)}
                                    placeholder="e.g., Passage 1, Data Set A"
                                    className="w-full border rounded-lg px-4 py-2"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Content *
                                </label>
                                <textarea
                                    value={contextBody}
                                    onChange={(e) => setContextBody(e.target.value)}
                                    placeholder="Enter the passage, data description, or context here..."
                                    rows={10}
                                    className="w-full border rounded-lg px-4 py-2 font-mono text-sm"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Image URL (optional)
                                </label>
                                <input
                                    type="url"
                                    value={contextImageUrl}
                                    onChange={(e) => setContextImageUrl(e.target.value)}
                                    placeholder="https://..."
                                    className="w-full border rounded-lg px-4 py-2"
                                />
                            </div>
                        </div>
                    </div>
                )}

                {/* Questions */}
                <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-semibold">
                            {setType === 'ATOMIC' ? '3. Question' : '4. Questions'}
                        </h2>
                        {setType !== 'ATOMIC' && (
                            <button
                                type="button"
                                onClick={addQuestion}
                                className="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm"
                            >
                                + Add Question
                            </button>
                        )}
                    </div>

                    {questions.length === 0 ? (
                        <div className="text-center py-8 text-gray-500">
                            <p>No questions yet.</p>
                            <button
                                type="button"
                                onClick={addQuestion}
                                className="mt-2 text-blue-600 hover:underline"
                            >
                                Add your first question
                            </button>
                        </div>
                    ) : (
                        <div className="space-y-6">
                            {questions.map((q, index) => (
                                <div key={q.tempId} className="border rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-3">
                                        <span className="font-medium">Question {index + 1}</span>
                                        {(setType !== 'ATOMIC' || questions.length > 1) && (
                                            <button
                                                type="button"
                                                onClick={() => removeQuestion(q.tempId)}
                                                className="text-red-600 hover:text-red-800 text-sm"
                                            >
                                                Remove
                                            </button>
                                        )}
                                    </div>

                                    <div className="space-y-3">
                                        <textarea
                                            value={q.question_text}
                                            onChange={(e) => updateQuestion(q.tempId, { question_text: e.target.value })}
                                            placeholder="Enter question text..."
                                            rows={3}
                                            className="w-full border rounded px-3 py-2"
                                            required
                                        />

                                        <div className="grid grid-cols-3 gap-3">
                                            <select
                                                value={q.question_type}
                                                onChange={(e) => updateQuestion(q.tempId, {
                                                    question_type: e.target.value as 'MCQ' | 'TITA',
                                                    negative_marks: e.target.value === 'TITA' ? 0 : 1,
                                                })}
                                                className="border rounded px-3 py-2"
                                            >
                                                <option value="MCQ">MCQ</option>
                                                <option value="TITA">TITA (Numeric)</option>
                                            </select>

                                            <input
                                                type="number"
                                                value={q.positive_marks}
                                                onChange={(e) => updateQuestion(q.tempId, { positive_marks: Number(e.target.value) })}
                                                className="border rounded px-3 py-2"
                                                placeholder="+Marks"
                                                step="0.5"
                                            />

                                            <input
                                                type="number"
                                                value={q.negative_marks}
                                                onChange={(e) => updateQuestion(q.tempId, { negative_marks: Number(e.target.value) })}
                                                className="border rounded px-3 py-2"
                                                placeholder="-Marks"
                                                step="0.5"
                                                disabled={q.question_type === 'TITA'}
                                            />
                                        </div>

                                        {q.question_type === 'MCQ' && (
                                            <div className="grid grid-cols-2 gap-2">
                                                {['A', 'B', 'C', 'D'].map((label, i) => (
                                                    <div key={label} className="flex items-center gap-2">
                                                        <input
                                                            type="radio"
                                                            name={`correct-${q.tempId}`}
                                                            checked={q.correct_answer === label}
                                                            onChange={() => updateQuestion(q.tempId, { correct_answer: label })}
                                                        />
                                                        <span className="font-medium">{label}.</span>
                                                        <input
                                                            type="text"
                                                            value={q.options[i]}
                                                            onChange={(e) => {
                                                                const newOptions = [...q.options];
                                                                newOptions[i] = e.target.value;
                                                                updateQuestion(q.tempId, { options: newOptions });
                                                            }}
                                                            placeholder={`Option ${label}`}
                                                            className="flex-1 border rounded px-2 py-1 text-sm"
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {q.question_type === 'TITA' && (
                                            <input
                                                type="text"
                                                value={q.correct_answer}
                                                onChange={(e) => updateQuestion(q.tempId, { correct_answer: e.target.value })}
                                                placeholder="Correct answer (e.g., 42, 3.14)"
                                                className="w-full border rounded px-3 py-2"
                                            />
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* Submit */}
                <div className="flex justify-end gap-4">
                    <Link
                        href="/admin/question-sets"
                        className="px-6 py-2 border rounded-lg hover:bg-gray-50"
                    >
                        Cancel
                    </Link>
                    <button
                        type="submit"
                        disabled={saving}
                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                    >
                        {saving ? 'Creating...' : 'Create Question Set'}
                    </button>
                </div>
            </form>
        </div>
    );
}
````

## File: src/app/admin/questions/QuestionRowActions.tsx
````typescript
'use client';

import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { deleteQuestion } from './actions';

type QuestionRowActionsProps = {
    questionId: string;
    isActive: boolean;
    editHref?: string;
};

export default function QuestionRowActions({ questionId, isActive, editHref }: QuestionRowActionsProps) {
    const router = useRouter();
    const [isPending, startTransition] = useTransition();
    const [error, setError] = useState<string | null>(null);

    const handleDelete = () => {
        if (isPending) return;
        setError(null);
        if (!confirm('Are you sure you want to delete this question? It will be marked inactive.')) {
            return;
        }
        startTransition(async () => {
            const result = await deleteQuestion(questionId);
            if (!result.success) {
                setError(result.error || 'Delete failed');
                return;
            }
            router.refresh();
        });
    };

    return (
        <div className="flex items-center justify-end gap-3">
            {editHref && (
                <Link href={editHref} className="text-blue-600 hover:text-blue-900">
                    Edit
                </Link>
            )}
            {isActive ? (
                <button
                    type="button"
                    onClick={handleDelete}
                    className="text-red-600 hover:text-red-900 disabled:opacity-50"
                    disabled={isPending}
                >
                    {isPending ? 'Deleting...' : 'Delete'}
                </button>
            ) : (
                <span className="text-xs text-gray-400">Inactive</span>
            )}
            {error && <span className="text-xs text-red-600">{error}</span>}
        </div>
    );
}
````

## File: src/app/api/_utils/validation.ts
````typescript
/**
 * @fileoverview Shared API Validation Utilities
 * @description Common validation helpers for exam API routes
 * @blueprint Phase 2 - Deterministic API validation
 */

import { NextResponse } from 'next/server';

// =============================================================================
// TYPE GUARDS
// =============================================================================

/**
 * Checks if a value is a non-empty string (after trimming).
 */
export function isNonEmptyString(v: unknown): v is string {
    return typeof v === 'string' && v.trim().length > 0;
}

/**
 * Checks if a value is a finite number (not NaN, not Infinity).
 * IMPORTANT: This correctly handles 0 as a valid value.
 */
export function isFiniteNumber(v: unknown): v is number {
    return typeof v === 'number' && Number.isFinite(v);
}

/**
 * Validates the timeRemaining object has all required section keys with finite numbers.
 */
export function isValidTimeRemaining(
    timeRemaining: unknown
): timeRemaining is { VARC: number; DILR: number; QA: number } {
    if (typeof timeRemaining !== 'object' || timeRemaining === null) {
        return false;
    }

    const tr = timeRemaining as Record<string, unknown>;

    return (
        isFiniteNumber(tr.VARC) &&
        isFiniteNumber(tr.DILR) &&
        isFiniteNumber(tr.QA)
    );
}

// =============================================================================
// ENVIRONMENT VALIDATION
// =============================================================================

/**
 * Gets Supabase configuration from environment variables.
 * Returns null if configuration is invalid/missing (fail fast).
 */
export function getSupabaseConfig(): { url: string; anonKey: string } | null {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const anonKey =
        process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY ||
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

    if (!url || !anonKey) {
        console.error('SUPABASE_CONFIG_MISSING', {
            hasUrl: Boolean(url),
            hasAnonKey: Boolean(anonKey),
        });
        return null;
    }

    // Sanity check: reject localhost fallbacks in production
    if (url === 'http://localhost:54321' && process.env.NODE_ENV === 'production') {
        console.error('SUPABASE_CONFIG_INVALID', {
            error: 'localhost URL in production',
        });
        return null;
    }

    return { url, anonKey };
}

/**
 * Returns a 500 response for server misconfiguration.
 */
export function serverMisconfiguredResponse(): NextResponse {
    return NextResponse.json(
        { error: 'Server misconfigured. Please contact support.' },
        { status: 500 }
    );
}

// =============================================================================
// COMMON VALIDATION RESPONSES
// =============================================================================

export function missingFieldResponse(field: string): NextResponse {
    return NextResponse.json({ error: `${field} is required` }, { status: 400 });
}

export function invalidFieldResponse(field: string): NextResponse {
    return NextResponse.json({ error: `${field} is invalid` }, { status: 400 });
}

// =============================================================================
// VERSION HEADER (for debugging which code is deployed)
// =============================================================================

export const API_VERSION = '2026-02-01-v2';

export function addVersionHeader(response: NextResponse): NextResponse {
    response.headers.set('X-Route-Version', API_VERSION);
    return response;
}
````

## File: src/app/auth/logout/route.ts
````typescript
import { NextRequest, NextResponse } from 'next/server';
import { sbSSR } from '@/lib/supabase/server';

export async function POST(request: NextRequest) {
    const supabase = await sbSSR();

    // Sign out the user
    await supabase.auth.signOut();

    // Redirect to sign-in page
    return NextResponse.redirect(new URL('/auth/sign-in', request.url));
}

export async function GET(request: NextRequest) {
    const supabase = await sbSSR();

    // Sign out the user
    await supabase.auth.signOut();

    // Redirect to sign-in page
    return NextResponse.redirect(new URL('/auth/sign-in', request.url));
}
````

## File: src/app/coming-soon/page.tsx
````typescript
import Link from 'next/link';
import { redirect } from 'next/navigation';
import { createClient } from '@supabase/supabase-js';
import { sbSSR } from '@/lib/supabase/server';
import { ensureActiveAccess } from '@/lib/access-control';
import { checkRateLimit, RATE_LIMITS, userRateLimitKey } from '@/lib/rate-limit';
import { incrementMetric } from '@/lib/telemetry';

/**
 * Service-role client for access request cleanup.
 * Only used when RLS blocks the user from updating orphaned rows.
 */
function getServiceClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const key = process.env.SUPABASE_SERVICE_ROLE_KEY;
    if (!url || !key) return null;
    return createClient(url, key, {
        auth: { autoRefreshToken: false, persistSession: false },
    });
}

type PageProps = {
    searchParams?: {
        redirect_to?: string;
        requested?: string;
        error?: string;
    };
};

async function requestAccess(formData: FormData) {
    'use server';

    const supabase = await sbSSR();
    const {
        data: { user },
    } = await supabase.auth.getUser();
    const sessionUser = user ?? (await supabase.auth.getSession()).data.session?.user ?? null;

    const redirectTo = typeof formData.get('redirect_to') === 'string'
        ? String(formData.get('redirect_to'))
        : '/dashboard';

    if (!sessionUser) {
        redirect(`/auth/sign-in?redirect_to=${encodeURIComponent('/coming-soon')}`);
    }

    const rateKey = userRateLimitKey('access_request', sessionUser.id);
    const rateResult = checkRateLimit(rateKey, RATE_LIMITS.ACCESS_REQUEST);
    if (!rateResult.allowed) {
        redirect('/coming-soon?error=rate_limited');
    }

    const email = (sessionUser.email ?? '').trim().toLowerCase();
    if (!email) {
        redirect('/coming-soon?error=missing_email');
    }

    // ── Step 1: Check if this exact user already has a request ──────────
    const { data: existingByUser } = await supabase
        .from('access_requests')
        .select('id, status, user_id, email')
        .eq('user_id', sessionUser.id)
        .maybeSingle();

    if (existingByUser) {
        // User already has a row – reset to pending if needed
        if (existingByUser.status !== 'pending') {
            const { error: updateError } = await supabase
                .from('access_requests')
                .update({
                    status: 'pending',
                    decided_by: null,
                    decided_at: null,
                    source: 'coming_soon',
                })
                .eq('id', existingByUser.id);

            if (updateError) {
                console.error('[RequestAccess] update own row failed', updateError.message);
                redirect('/coming-soon?error=request_failed');
            }
            incrementMetric('access_request_submitted');
        }
        // Already pending – no-op, just redirect to success
        const returnParam = redirectTo ? `&redirect_to=${encodeURIComponent(redirectTo)}` : '';
        redirect(`/coming-soon?requested=1${returnParam}`);
    }

    // ── Step 2: Check for zombie row by email (orphaned from deleted user) ──
    // Use service-role client because RLS blocks users from reading/updating
    // rows where user_id IS NULL or belongs to a different auth user.
    const serviceClient = getServiceClient();

    if (serviceClient) {
        const { data: zombieRow } = await serviceClient
            .from('access_requests')
            .select('id, user_id')
            .ilike('email', email)
            .maybeSingle();

        if (zombieRow) {
            // Zombie found – reclaim it: update user_id + reset to pending
            const { error: reclaimError } = await serviceClient
                .from('access_requests')
                .update({
                    user_id: sessionUser.id,
                    email,
                    status: 'pending',
                    decided_by: null,
                    decided_at: null,
                    source: 'coming_soon',
                })
                .eq('id', zombieRow.id);

            if (reclaimError) {
                console.error('[RequestAccess] reclaim zombie row failed', reclaimError.message);
                redirect('/coming-soon?error=request_failed');
            }

            // Also reset user_access to pending for this user
            await serviceClient
                .from('user_access')
                .upsert(
                    { user_id: sessionUser.id, status: 'pending', source: 'reclaimed' },
                    { onConflict: 'user_id' }
                );

            incrementMetric('access_request_submitted');
            const returnParam = redirectTo ? `&redirect_to=${encodeURIComponent(redirectTo)}` : '';
            redirect(`/coming-soon?requested=1${returnParam}`);
        }
    }

    // ── Step 3: No existing row – fresh insert ─────────────────────────
    const { error: insertError } = await supabase.from('access_requests').insert({
        user_id: sessionUser.id,
        email,
        status: 'pending',
        source: 'coming_soon',
    });

    if (insertError) {
        console.error('[RequestAccess] insert failed', insertError.message);

        // Last resort: email unique collision without service client
        // Try upsert via service client if available
        if (serviceClient && insertError.message?.includes('unique')) {
            const { error: upsertErr } = await serviceClient
                .from('access_requests')
                .upsert(
                    {
                        user_id: sessionUser.id,
                        email,
                        status: 'pending',
                        decided_by: null,
                        decided_at: null,
                        source: 'coming_soon',
                    },
                    { onConflict: 'user_id' }
                );
            if (upsertErr) {
                console.error('[RequestAccess] upsert fallback failed', upsertErr.message);
                redirect('/coming-soon?error=request_failed');
            }
        } else {
            redirect('/coming-soon?error=request_failed');
        }
    }

    incrementMetric('access_request_submitted');

    const returnParam = redirectTo ? `&redirect_to=${encodeURIComponent(redirectTo)}` : '';
    redirect(`/coming-soon?requested=1${returnParam}`);
}

export default async function ComingSoonPage({ searchParams }: PageProps) {
    const supabase = await sbSSR();
    const {
        data: { user },
    } = await supabase.auth.getUser();

    if (!user) {
        redirect(`/auth/sign-in?redirect_to=${encodeURIComponent('/coming-soon')}`);
    }

    const access = await ensureActiveAccess(supabase, user.id, user);
    const redirectTo = searchParams?.redirect_to ?? '/dashboard';

    if (access.isAdmin) {
        redirect('/dashboard');
    }

    if (access.allowed) {
        redirect(redirectTo);
    }

    const { data: request } = await supabase
        .from('access_requests')
        .select('id, status, created_at, decided_at')
        .eq('user_id', user.id)
        .maybeSingle();

    const statusLabel = access.status ?? 'pending';
    const requested = searchParams?.requested === '1';
    const error = searchParams?.error ?? null;

    return (
        <main style={{ padding: 24, maxWidth: 760, margin: '0 auto' }}>
            <div style={{
                padding: 24,
                border: '1px solid #e5e7eb',
                borderRadius: 16,
                background: '#fff',
                boxShadow: '0 6px 18px rgba(15, 23, 42, 0.08)'
            }}>
                <h1 style={{ margin: 0, marginBottom: 8 }}>You are on the waitlist</h1>
                <p style={{ margin: 0, color: '#475569' }}>
                    We are rolling out access in phases. Your account is not active yet.
                </p>

                <div style={{ marginTop: 20, padding: 16, background: '#f8fafc', borderRadius: 12 }}>
                    <p style={{ margin: 0, fontWeight: 600 }}>Access status</p>
                    <p style={{ margin: '6px 0 0', color: '#334155' }}>
                        {statusLabel === 'rejected'
                            ? 'Rejected'
                            : statusLabel === 'pending'
                                ? 'Pending review'
                                : 'Inactive'}
                    </p>
                    {request?.status && (
                        <p style={{ margin: '6px 0 0', color: '#64748b', fontSize: 13 }}>
                            Request status: {request.status}
                        </p>
                    )}
                </div>

                {error === 'missing_email' && (
                    <p style={{ color: 'crimson', marginTop: 16 }}>
                        We could not find an email for your account. Please re-authenticate and try again.
                    </p>
                )}
                {error === 'rate_limited' && (
                    <p style={{ color: 'crimson', marginTop: 16 }}>
                        Too many access requests. Please wait a minute and try again.
                    </p>
                )}

                {error === 'request_failed' && (
                    <p style={{ color: 'crimson', marginTop: 16 }}>
                        We could not submit your request. Please try again.
                    </p>
                )}

                {requested && (
                    <p style={{ marginTop: 16, color: '#0f766e' }}>
                        Access request received. We will notify you once it is approved.
                    </p>
                )}

                {request?.status === 'rejected' && (
                    <p style={{ marginTop: 16, color: '#b45309' }}>
                        Your previous request was declined. You can request access again.
                    </p>
                )}

                {(!request || request.status === 'rejected') && (
                    <form action={requestAccess} style={{ marginTop: 20 }}>
                        <input type="hidden" name="redirect_to" value={redirectTo} />
                        <button
                            type="submit"
                            style={{
                                padding: '10px 16px',
                                background: '#0f172a',
                                color: '#fff',
                                border: 'none',
                                borderRadius: 8,
                                fontWeight: 600,
                                cursor: 'pointer'
                            }}
                        >
                            Request access
                        </button>
                    </form>
                )}

                {request && request.status !== 'rejected' && (
                    <p style={{ marginTop: 16, color: '#64748b' }}>
                        You have already submitted a request. We will reach out as soon as we can.
                    </p>
                )}

                <div style={{ marginTop: 20 }}>
                    <Link href="/auth/logout" style={{ color: '#475569' }}>
                        Sign out
                    </Link>
                </div>
            </div>
        </main>
    );
}
````

## File: src/app/page.module.css
````css
.page {
  --gray-rgb: 0, 0, 0;
  --gray-alpha-200: rgba(var(--gray-rgb), 0.08);
  --gray-alpha-100: rgba(var(--gray-rgb), 0.05);

  --button-primary-hover: #383838;
  --button-secondary-hover: #f2f2f2;

  display: grid;
  grid-template-rows: 20px 1fr 20px;
  align-items: center;
  justify-items: center;
  min-height: 100svh;
  padding: 80px;
  gap: 64px;
  font-family: var(--font-geist-sans);
}

@media (prefers-color-scheme: dark) {
  .page {
    --gray-rgb: 255, 255, 255;
    --gray-alpha-200: rgba(var(--gray-rgb), 0.145);
    --gray-alpha-100: rgba(var(--gray-rgb), 0.06);

    --button-primary-hover: #ccc;
    --button-secondary-hover: #1a1a1a;
  }
}

.main {
  display: flex;
  flex-direction: column;
  gap: 32px;
  grid-row-start: 2;
}

.main ol {
  font-family: var(--font-geist-mono);
  padding-left: 0;
  margin: 0;
  font-size: 14px;
  line-height: 24px;
  letter-spacing: -0.01em;
  list-style-position: inside;
}

.main li:not(:last-of-type) {
  margin-bottom: 8px;
}

.main code {
  font-family: inherit;
  background: var(--gray-alpha-100);
  padding: 2px 4px;
  border-radius: 4px;
  font-weight: 600;
}

.ctas {
  display: flex;
  gap: 16px;
}

.ctas a {
  appearance: none;
  border-radius: 128px;
  height: 48px;
  padding: 0 20px;
  border: 1px solid transparent;
  transition:
    background 0.2s,
    color 0.2s,
    border-color 0.2s;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  line-height: 20px;
  font-weight: 500;
}

a.primary {
  background: var(--foreground);
  color: var(--background);
  gap: 8px;
}

a.secondary {
  border-color: var(--gray-alpha-200);
  min-width: 158px;
}

.footer {
  grid-row-start: 3;
  display: flex;
  gap: 24px;
}

.footer a {
  display: flex;
  align-items: center;
  gap: 8px;
}

.footer img {
  flex-shrink: 0;
}

/* Enable hover only on non-touch devices */
@media (hover: hover) and (pointer: fine) {
  a.primary:hover {
    background: var(--button-primary-hover);
    border-color: transparent;
  }

  a.secondary:hover {
    background: var(--button-secondary-hover);
    border-color: transparent;
  }

  .footer a:hover {
    text-decoration: underline;
    text-underline-offset: 4px;
  }
}

@media (max-width: 600px) {
  .page {
    padding: 32px;
    padding-bottom: 80px;
  }

  .main {
    align-items: center;
  }

  .main ol {
    text-align: center;
  }

  .ctas {
    flex-direction: column;
  }

  .ctas a {
    font-size: 14px;
    height: 40px;
    padding: 0 16px;
  }

  a.secondary {
    min-width: auto;
  }

  .footer {
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
  }
}

@media (prefers-color-scheme: dark) {
  .logo {
    filter: invert();
  }
}
````

## File: src/app/result/[attemptId]/ResultTabsClient.tsx
````typescript
/**
 * @fileoverview Result tabs for review vs analytics
 * @description Client-only tab switcher that preserves scroll positions
 */

'use client';

import { useCallback, useEffect, useMemo, useRef, useState, type ReactNode } from 'react';

type TabId = 'review' | 'analytics';

interface ResultTabsClientProps {
    analytics: ReactNode;
    review?: ReactNode;
}

const TAB_CONFIG: Record<TabId, { label: string; hash: string }> = {
    review: { label: 'Mirror View / Solutions', hash: '#exam-review' },
    analytics: { label: 'Analytics View', hash: '#analytics-view' },
};

export function ResultTabsClient({ analytics, review }: ResultTabsClientProps) {
    const hasReview = Boolean(review);
    const initialTab: TabId = hasReview ? 'review' : 'analytics';
    const [activeTab, setActiveTab] = useState<TabId>(initialTab);
    const scrollPositions = useRef<Record<TabId, number>>({ review: 0, analytics: 0 });

    const orderedTabs = useMemo<TabId[]>(() => (hasReview ? ['review', 'analytics'] : ['analytics']), [hasReview]);

    const syncFromHash = useCallback(() => {
        if (typeof window === 'undefined') return;
        const hash = window.location.hash;
        if (hash === TAB_CONFIG.analytics.hash) {
            setActiveTab('analytics');
            return;
        }
        if (hash === TAB_CONFIG.review.hash && hasReview) {
            setActiveTab('review');
        }
    }, [hasReview]);

    useEffect(() => {
        syncFromHash();
        window.addEventListener('hashchange', syncFromHash);
        return () => window.removeEventListener('hashchange', syncFromHash);
    }, [syncFromHash]);

    useEffect(() => {
        if (typeof window === 'undefined') return;
        const targetHash = TAB_CONFIG[activeTab].hash;
        if (window.location.hash !== targetHash) {
            window.history.replaceState(null, '', targetHash);
        }
        requestAnimationFrame(() => {
            const stored = scrollPositions.current[activeTab] ?? 0;
            window.scrollTo({ top: stored });
        });
    }, [activeTab]);

    const handleTabChange = (tab: TabId) => {
        if (tab === activeTab) return;
        if (typeof window !== 'undefined') {
            scrollPositions.current[activeTab] = window.scrollY;
        }
        setActiveTab(tab);
    };

    return (
        <div className="space-y-6">
            <div className="flex flex-wrap items-center gap-2 rounded-full bg-white p-2 shadow-sm border">
                {orderedTabs.map((tab) => {
                    const isActive = tab === activeTab;
                    return (
                        <button
                            key={tab}
                            type="button"
                            onClick={() => handleTabChange(tab)}
                            className={`px-4 py-2 text-sm font-semibold rounded-full transition-colors ${isActive
                                ? 'bg-blue-600 text-white shadow'
                                : 'text-gray-600 hover:bg-gray-100'
                                }`}
                        >
                            {TAB_CONFIG[tab].label}
                        </button>
                    );
                })}
            </div>

            <section
                id="exam-review"
                aria-hidden={activeTab !== 'review'}
                className={activeTab === 'review' ? 'block' : 'hidden'}
            >
                {review ?? (
                    <div className="rounded-xl border border-dashed border-gray-200 p-6 text-center text-gray-500">
                        Review mode is not available for this attempt.
                    </div>
                )}
            </section>

            <section
                id="analytics-view"
                aria-hidden={activeTab !== 'analytics'}
                className={activeTab === 'analytics' ? 'block' : 'hidden'}
            >
                {analytics}
            </section>
        </div>
    );
}
````

## File: src/components/AuthenticatedOverlays.tsx
````typescript
'use client';

import { useCallback, useEffect, useState } from 'react';
import { usePathname } from 'next/navigation';
import { sb } from '@/lib/supabase/client';
import BugReportFab from '@/components/BugReportFab';

const ELIGIBLE_KEY = 'first_login_banner_eligible';
const DISMISSED_KEY = 'early_access_banner_dismissed';
const SESSION_COUNT_KEY = 'early_access_session_count';
const SESSION_SEEN_KEY = 'early_access_session_seen';

export default function AuthenticatedOverlays() {
    const pathname = usePathname();
    const [userId, setUserId] = useState<string | null>(null);
    const [bannerVisible, setBannerVisible] = useState(false);
    const [bugOpen, setBugOpen] = useState(false);

    useEffect(() => {
        let isMounted = true;
        sb()
            .auth.getUser()
            .then(({ data }) => {
                if (!isMounted) return;
                setUserId(data.user?.id ?? null);
            })
            .catch((error) => {
                if (!isMounted) return;
                console.warn('Failed to fetch user for overlays', error);
                setUserId(null);
            });
        return () => {
            isMounted = false;
        };
    }, []);

    useEffect(() => {
        if (!userId || typeof window === 'undefined') return;
        const eligible = window.localStorage.getItem(ELIGIBLE_KEY) === 'true';
        const dismissed = window.localStorage.getItem(DISMISSED_KEY) === 'true';

        if (!eligible || dismissed) {
            setBannerVisible(false);
            return;
        }

        const alreadyCounted = window.sessionStorage.getItem(SESSION_SEEN_KEY) === 'true';
        let sessionCount = Number(window.localStorage.getItem(SESSION_COUNT_KEY) || '0');

        if (!alreadyCounted) {
            sessionCount += 1;
            window.localStorage.setItem(SESSION_COUNT_KEY, sessionCount.toString());
            window.sessionStorage.setItem(SESSION_SEEN_KEY, 'true');
        }

        if (sessionCount <= 3) {
            setBannerVisible(true);
        } else {
            setBannerVisible(false);
            window.localStorage.setItem(ELIGIBLE_KEY, 'false');
        }
    }, [pathname, userId]);

    const dismissBanner = useCallback(() => {
        setBannerVisible(false);
        if (typeof window !== 'undefined') {
            window.localStorage.setItem(DISMISSED_KEY, 'true');
            window.localStorage.setItem(ELIGIBLE_KEY, 'false');
        }
    }, []);

    if (!userId) {
        return null;
    }

    return (
        <>
            {bannerVisible && (
                <div className="fixed left-1/2 top-4 z-40 w-[min(92vw,720px)] -translate-x-1/2 rounded-2xl border border-emerald-200 bg-white px-4 py-3 shadow-md">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                        <div className="text-sm text-slate-700">
                            <span className="font-semibold text-emerald-700">Early Access</span>{' '}
                            Thanks for joining early access. Your feedback shapes every drop.
                        </div>
                        <div className="flex items-center gap-3 text-xs font-semibold">
                            <button
                                type="button"
                                onClick={() => setBugOpen(true)}
                                className="rounded-full border border-slate-200 px-3 py-1 text-slate-600 transition hover:bg-slate-50"
                            >
                                Report an issue
                            </button>
                            <button
                                type="button"
                                onClick={dismissBanner}
                                className="rounded-full border border-slate-200 px-3 py-1 text-slate-500 transition hover:bg-slate-50"
                            >
                                Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <BugReportFab
                userId={userId}
                route={pathname}
                open={bugOpen}
                onOpen={() => setBugOpen(true)}
                onClose={() => setBugOpen(false)}
            />
        </>
    );
}
````

## File: src/components/BackToDashboard.tsx
````typescript
import Link from 'next/link';

type BackToDashboardProps = {
    href?: string;
    label?: string;
    variant?: 'inline' | 'fixed';
    className?: string;
};

export function BackToDashboard({
    href = '/dashboard',
    label = 'Back to Dashboard',
    variant = 'inline',
    className = '',
}: BackToDashboardProps) {
    if (variant === 'fixed') {
        return (
            <div className="fixed left-4 top-4 z-50">
                <Link
                    href={href}
                    className={`inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white backdrop-blur-sm transition hover:bg-white/20 ${className}`}
                >
                    <span aria-hidden="true">{'<-'}</span>
                    {label}
                </Link>
            </div>
        );
    }

    return (
        <Link
            href={href}
            className={`inline-flex items-center gap-2 rounded-full border border-blue-100 bg-blue-50 px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-blue-700 transition hover:bg-blue-100 ${className}`}
        >
            <span aria-hidden="true">{'<-'}</span>
            {label}
        </Link>
    );
}
````

## File: src/components/useFocusTrap.ts
````typescript
'use client';

import { useEffect, type RefObject } from 'react';

export function useFocusTrap(
    isOpen: boolean,
    containerRef: RefObject<HTMLElement | null>,
    onClose: () => void
) {
    useEffect(() => {
        if (!isOpen) return;
        const container = containerRef.current;
        if (!container) return;

        const focusableSelectors = [
            'a[href]',
            'button:not([disabled])',
            'textarea:not([disabled])',
            'input:not([disabled])',
            'select:not([disabled])',
            '[tabindex]:not([tabindex="-1"])',
        ];
        const focusable = Array.from(
            container.querySelectorAll<HTMLElement>(focusableSelectors.join(','))
        );
        const previousActive = document.activeElement as HTMLElement | null;

        const focusFirst = () => {
            if (focusable.length > 0) {
                focusable[0].focus();
            } else {
                container.focus();
            }
        };

        focusFirst();

        const handleKeydown = (event: KeyboardEvent) => {
            if (event.key === 'Escape') {
                onClose();
                return;
            }
            if (event.key !== 'Tab') return;

            if (focusable.length === 0) {
                event.preventDefault();
                return;
            }

            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            const active = document.activeElement as HTMLElement | null;

            if (event.shiftKey && active === first) {
                event.preventDefault();
                last.focus();
            } else if (!event.shiftKey && active === last) {
                event.preventDefault();
                first.focus();
            }
        };

        document.addEventListener('keydown', handleKeydown);
        return () => {
            document.removeEventListener('keydown', handleKeydown);
            if (previousActive) {
                previousActive.focus();
            }
        };
    }, [containerRef, isOpen, onClose]);
}
````

## File: src/features/admin/config/topicOptions.ts
````typescript
import type { SectionName } from '@/types/exam';

export const SECTION_TOPIC_OPTIONS: Record<SectionName, string[]> = {
    VARC: [
        'Reading Comprehension',
        'Para Jumbles',
        'Para Summary',
        'Sentence Completion',
        'Critical Reasoning',
        'Vocabulary',
        'Other',
    ],
    DILR: [
        'Tables',
        'Bar Graphs',
        'Line Graphs',
        'Venn Diagrams',
        'Games & Tournaments',
        'Arrangements',
        'Caselets',
        'Routes/Networks',
        'Other',
    ],
    QA: [
        'Arithmetic',
        'Algebra',
        'Geometry',
        'Number System',
        'Modern Math',
        'Other',
    ],
};

export const SECTION_SUBTOPIC_OPTIONS: Record<SectionName, Record<string, string[]>> = {
    VARC: {
        'Reading Comprehension': ['Inference', 'Main Idea', 'Tone', 'Fact-Based', 'Application', 'Other'],
        'Para Jumbles': ['Ordering', 'Odd Sentence Out', 'Other'],
        'Para Summary': ['Central Idea', 'Inference', 'Other'],
        'Sentence Completion': ['Fill in the Blanks', 'Other'],
        'Critical Reasoning': ['Assumption', 'Strengthen/Weaken', 'Conclusion', 'Other'],
        Vocabulary: ['Word Usage', 'Analogies', 'Other'],
        Other: ['Other'],
    },
    DILR: {
        Tables: ['Data Tables', 'Other'],
        'Bar Graphs': ['Single Bar', 'Multiple Bar', 'Other'],
        'Line Graphs': ['Single Line', 'Multiple Line', 'Other'],
        'Venn Diagrams': ['2-Set', '3-Set', 'Other'],
        'Games & Tournaments': ['Round Robin', 'Knockout', 'Other'],
        Arrangements: ['Seating', 'Ordering', 'Scheduling', 'Other'],
        Caselets: ['Logic Puzzles', 'Other'],
        'Routes/Networks': ['Paths', 'Graphs', 'Other'],
        Other: ['Other'],
    },
    QA: {
        Arithmetic: ['Percentages', 'Ratios', 'Profit & Loss', 'Time & Work', 'Time & Distance', 'Mixtures', 'Other'],
        Algebra: ['Linear Equations', 'Quadratic', 'Functions', 'Inequalities', 'Other'],
        Geometry: ['Triangles', 'Circles', 'Polygons', 'Coordinate Geometry', 'Other'],
        'Number System': ['Factors', 'Remainders', 'LCM/HCF', 'Base Systems', 'Other'],
        'Modern Math': ['Permutation & Combination', 'Probability', 'Set Theory', 'Logarithms', 'Other'],
        Other: ['Other'],
    },
};

function ensureOption(options: string[], value?: string | null): string[] {
    if (!value || value.trim() === '') return options;
    return options.includes(value) ? options : [value, ...options];
}

export function getTopicOptions(section: SectionName, current?: string | null): string[] {
    const options = SECTION_TOPIC_OPTIONS[section] ?? [];
    return ensureOption(options, current);
}

export function getSubtopicOptions(section: SectionName, topic?: string | null, current?: string | null): string[] {
    const byTopic = SECTION_SUBTOPIC_OPTIONS[section] ?? {};
    const base = (topic && byTopic[topic]) ? byTopic[topic] : ['Other'];
    return ensureOption(base, current);
}
````

## File: src/features/admin/ui/MarkdownToolbar.tsx
````typescript
/**
 * @fileoverview Lightweight Markdown toolbar for admin editors
 * @description Inserts simple Markdown snippets into a target textarea
 */

'use client';

import { useCallback, type RefObject } from 'react';

interface MarkdownToolbarProps {
    textareaRef: RefObject<HTMLTextAreaElement | null>;
    value: string;
    onChange: (nextValue: string) => void;
    className?: string;
}

function applyWrap(
    textarea: HTMLTextAreaElement,
    value: string,
    onChange: (nextValue: string) => void,
    startToken: string,
    endToken: string = startToken
) {
    const start = textarea.selectionStart ?? 0;
    const end = textarea.selectionEnd ?? 0;
    const selected = value.slice(start, end);
    const next = `${value.slice(0, start)}${startToken}${selected}${endToken}${value.slice(end)}`;
    onChange(next);

    const cursorStart = start + startToken.length;
    const cursorEnd = end + startToken.length;
    requestAnimationFrame(() => {
        textarea.focus();
        textarea.setSelectionRange(cursorStart, cursorEnd);
    });
}

function applyLinePrefix(
    textarea: HTMLTextAreaElement,
    value: string,
    onChange: (nextValue: string) => void,
    prefix: string
) {
    const start = textarea.selectionStart ?? 0;
    const end = textarea.selectionEnd ?? 0;
    const lineStart = value.lastIndexOf('\n', start - 1) + 1;
    const lineEnd = value.indexOf('\n', end);
    const blockEnd = lineEnd === -1 ? value.length : lineEnd;
    const block = value.slice(lineStart, blockEnd);
    const lines = block.split('\n');
    const updatedLines = lines.map((line) => (line.trim().length ? `${prefix}${line}` : line));
    const nextBlock = updatedLines.join('\n');
    const next = `${value.slice(0, lineStart)}${nextBlock}${value.slice(blockEnd)}`;
    onChange(next);

    const delta = nextBlock.length - block.length;
    requestAnimationFrame(() => {
        textarea.focus();
        textarea.setSelectionRange(start + prefix.length, end + delta);
    });
}

export function MarkdownToolbar({ textareaRef, value, onChange, className }: MarkdownToolbarProps) {
    const handleBold = useCallback(() => {
        if (!textareaRef.current) return;
        applyWrap(textareaRef.current, value, onChange, '**', '**');
    }, [textareaRef, value, onChange]);

    const handleItalic = useCallback(() => {
        if (!textareaRef.current) return;
        applyWrap(textareaRef.current, value, onChange, '*', '*');
    }, [textareaRef, value, onChange]);

    const handleUnderline = useCallback(() => {
        if (!textareaRef.current) return;
        applyWrap(textareaRef.current, value, onChange, '<u>', '</u>');
    }, [textareaRef, value, onChange]);

    const handleBullets = useCallback(() => {
        if (!textareaRef.current) return;
        applyLinePrefix(textareaRef.current, value, onChange, '- ');
    }, [textareaRef, value, onChange]);

    const handleNumbered = useCallback(() => {
        if (!textareaRef.current) return;
        applyLinePrefix(textareaRef.current, value, onChange, '1. ');
    }, [textareaRef, value, onChange]);

    return (
        <div className={`flex flex-wrap items-center gap-2 ${className ?? ''}`}>
            <button
                type="button"
                onClick={handleBold}
                className="px-2 py-1 text-xs font-semibold border border-gray-200 rounded hover:bg-gray-50"
            >
                Bold
            </button>
            <button
                type="button"
                onClick={handleItalic}
                className="px-2 py-1 text-xs font-semibold border border-gray-200 rounded hover:bg-gray-50"
            >
                Italic
            </button>
            <button
                type="button"
                onClick={handleUnderline}
                className="px-2 py-1 text-xs font-semibold border border-gray-200 rounded hover:bg-gray-50"
            >
                Underline
            </button>
            <button
                type="button"
                onClick={handleBullets}
                className="px-2 py-1 text-xs font-semibold border border-gray-200 rounded hover:bg-gray-50"
            >
                Bullets
            </button>
            <button
                type="button"
                onClick={handleNumbered}
                className="px-2 py-1 text-xs font-semibold border border-gray-200 rounded hover:bg-gray-50"
            >
                Numbered
            </button>
        </div>
    );
}
````

## File: src/features/exam-engine/lib/assemblePaper.ts
````typescript
import type { Question, QuestionInSet, QuestionSetComplete, SectionName } from '@/types/exam';
import { flattenQuestionSetsToQuestions } from '@/utils/question-sets';

const SECTION_ORDER: SectionName[] = ['VARC', 'DILR', 'QA'];

const sortSets = (a: QuestionSetComplete, b: QuestionSetComplete) => {
    if (a.section !== b.section) {
        return SECTION_ORDER.indexOf(a.section) - SECTION_ORDER.indexOf(b.section);
    }
    const order = (a.display_order ?? 0) - (b.display_order ?? 0);
    if (order !== 0) return order;
    return a.id.localeCompare(b.id);
};

const sortQuestions = (a: QuestionInSet, b: QuestionInSet) => {
    const aSeq = a.sequence_order ?? 0;
    const bSeq = b.sequence_order ?? 0;
    if (aSeq !== bSeq) return aSeq - bSeq;
    const aNum = a.question_number ?? 0;
    const bNum = b.question_number ?? 0;
    if (aNum !== bNum) return aNum - bNum;
    return a.id.localeCompare(b.id);
};

export function assemblePaper(questionSets: QuestionSetComplete[]): {
    questionSets: QuestionSetComplete[];
    questions: Question[];
} {
    const seen = new Set<string>();
    const duplicates = new Set<string>();

    const orderedSets = [...questionSets].sort(sortSets);

    const dedupedSets = orderedSets.map((set) => {
        const orderedQuestions = [...(set.questions ?? [])].sort(sortQuestions);
        const uniqueQuestions = orderedQuestions.filter((q) => {
            if (seen.has(q.id)) {
                duplicates.add(q.id);
                return false;
            }
            seen.add(q.id);
            return true;
        });

        return {
            ...set,
            questions: uniqueQuestions,
            question_count: uniqueQuestions.length,
        };
    });

    if (process.env.NODE_ENV !== 'production' && duplicates.size > 0) {
        console.warn('[AssemblePaper] Duplicate question ids detected', {
            duplicateIds: Array.from(duplicates),
            totalDuplicates: duplicates.size,
        });
    }

    return {
        questionSets: dedupedSets,
        questions: flattenQuestionSetsToQuestions(dedupedSets),
    };
}
````

## File: src/features/exam-engine/ui/Calculator.tsx
````typescript
/**
 * @fileoverview TCS iON CAT Digital Calculator (BODMAS)
 * @description UI + logic aligned to CAT exam calculator specification
 */

'use client';

import { useCallback, useEffect, useMemo, useRef, useState, type KeyboardEvent } from 'react';

type CalcToken = string;

interface CalculatorProps {
    isVisible: boolean;
    onClose: () => void;
    initialPosition?: { x: number; y: number };
}

type CalculatorState = {
    expressionTokens: CalcToken[];
    currentInput: string;
    currentDisplay: string | null;
    lastExpression: string;
    isResultDisplayed: boolean;
    memoryValue: number | null;
    error: string | null;
};

const initialState: CalculatorState = {
    expressionTokens: [],
    currentInput: '',
    currentDisplay: null,
    lastExpression: '',
    isResultDisplayed: false,
    memoryValue: null,
    error: null,
};

const operatorPrecedence: Record<string, number> = {
    '+': 1,
    '-': 1,
    '*': 2,
    '/': 2,
};

const isOperator = (token: string) => token in operatorPrecedence;

const formatNumber = (value: number) => {
    if (!Number.isFinite(value)) return 'Error';
    const text = Number.isInteger(value) ? String(value) : String(Number(value.toFixed(12)));
    return text;
};

const toRPN = (tokens: string[]) => {
    const output: string[] = [];
    const ops: string[] = [];

    tokens.forEach((token) => {
        if (isOperator(token)) {
            while (ops.length > 0) {
                const top = ops[ops.length - 1];
                if (isOperator(top) && operatorPrecedence[top] >= operatorPrecedence[token]) {
                    output.push(ops.pop()!);
                } else {
                    break;
                }
            }
            ops.push(token);
        } else {
            output.push(token);
        }
    });

    while (ops.length > 0) {
        output.push(ops.pop()!);
    }

    return output;
};

const evalRPN = (tokens: string[]) => {
    const stack: number[] = [];

    for (const token of tokens) {
        if (isOperator(token)) {
            const b = stack.pop();
            const a = stack.pop();
            if (a === undefined || b === undefined) return { error: 'Invalid Input' as const };
            if (token === '/' && b === 0) return { error: 'Cannot divide by zero' as const };
            switch (token) {
                case '+':
                    stack.push(a + b);
                    break;
                case '-':
                    stack.push(a - b);
                    break;
                case '*':
                    stack.push(a * b);
                    break;
                case '/':
                    stack.push(a / b);
                    break;
                default:
                    return { error: 'Invalid Input' as const };
            }
        } else {
            const value = Number(token);
            if (Number.isNaN(value)) return { error: 'Invalid Input' as const };
            stack.push(value);
        }
    }

    if (stack.length !== 1) return { error: 'Invalid Input' as const };
    return { value: stack[0] } as const;
};

export function Calculator({ isVisible, onClose, initialPosition }: CalculatorProps) {
    const [state, setState] = useState<CalculatorState>(initialState);
    const [position, setPosition] = useState<{ x: number; y: number }>(
        initialPosition ?? { x: 24, y: 120 }
    );
    const [isDragging, setIsDragging] = useState(false);
    const dragOffset = useRef<{ x: number; y: number }>({ x: 0, y: 0 });

    useEffect(() => {
        if (initialPosition) return;
        const width = 245;
        const height = 330;
        const margin = 16;
        const nextX = Math.max(margin, window.innerWidth - width - margin);
        const nextY = Math.max(margin, window.innerHeight - height - margin);
        setPosition({ x: nextX, y: nextY });
    }, [initialPosition]);

    useEffect(() => {
        if (!isDragging) return;

        const width = 245;
        const height = 330;
        const margin = 8;

        const handleMouseMove = (event: MouseEvent) => {
            const nextX = event.clientX - dragOffset.current.x;
            const nextY = event.clientY - dragOffset.current.y;
            const maxX = Math.max(margin, window.innerWidth - width - margin);
            const maxY = Math.max(margin, window.innerHeight - height - margin);

            setPosition({
                x: Math.min(Math.max(nextX, margin), maxX),
                y: Math.min(Math.max(nextY, margin), maxY),
            });
        };

        const handleMouseUp = () => {
            setIsDragging(false);
        };

        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', handleMouseUp);

        return () => {
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
        };
    }, [isDragging]);

    useEffect(() => {
        const handleResize = () => {
            const width = 245;
            const height = 330;
            const margin = 8;
            const maxX = Math.max(margin, window.innerWidth - width - margin);
            const maxY = Math.max(margin, window.innerHeight - height - margin);
            setPosition((prev) => ({
                x: Math.min(Math.max(prev.x, margin), maxX),
                y: Math.min(Math.max(prev.y, margin), maxY),
            }));
        };

        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);

    const expressionLine = useMemo(() => {
        if (state.isResultDisplayed && state.lastExpression) return state.lastExpression;
        const parts = [...state.expressionTokens];
        const current = state.currentDisplay ?? state.currentInput;
        if (current) parts.push(current);
        return parts.join(' ');
    }, [state.expressionTokens, state.currentDisplay, state.currentInput, state.isResultDisplayed, state.lastExpression]);

    const displayLine = useMemo(() => {
        if (state.error) return state.error;
        if (state.currentInput !== '') return state.currentInput;
        return '0';
    }, [state.currentInput, state.error]);

    const resetAll = useCallback(() => {
        setState({ ...initialState });
    }, []);

    const clearEntry = useCallback(() => {
        setState((prev) => ({
            ...prev,
            currentInput: '',
            currentDisplay: null,
            error: null,
            isResultDisplayed: false,
        }));
    }, []);

    const appendDigit = useCallback((digit: string) => {
        setState((prev) => {
            if (prev.error) return { ...initialState, currentInput: digit };
            const shouldReset = prev.isResultDisplayed && prev.expressionTokens.length === 0;
            const baseInput = shouldReset ? '' : prev.currentInput;
            const nextInput = baseInput === '0' ? digit : `${baseInput}${digit}`;
            return {
                ...prev,
                currentInput: nextInput,
                currentDisplay: null,
                isResultDisplayed: false,
                lastExpression: shouldReset ? '' : prev.lastExpression,
            };
        });
    }, []);

    const appendDot = useCallback(() => {
        setState((prev) => {
            if (prev.error) return { ...initialState, currentInput: '0.' };
            if (prev.currentInput.includes('.')) return prev;
            const shouldReset = prev.isResultDisplayed && prev.expressionTokens.length === 0;
            const baseInput = shouldReset ? '' : prev.currentInput;
            const nextInput = baseInput === '' ? '0.' : `${baseInput}.`;
            return {
                ...prev,
                currentInput: nextInput,
                currentDisplay: null,
                isResultDisplayed: false,
                lastExpression: shouldReset ? '' : prev.lastExpression,
            };
        });
    }, []);

    const handleOperator = useCallback((operator: string) => {
        setState((prev) => {
            if (prev.error) return prev;
            const tokens = [...prev.expressionTokens];
            const current = prev.currentDisplay ?? prev.currentInput;

            if (!current && tokens.length > 0 && isOperator(tokens[tokens.length - 1])) {
                tokens[tokens.length - 1] = operator;
                return { ...prev, expressionTokens: tokens };
            }

            const nextTokens = current ? [...tokens, current, operator] : [...tokens];
            return {
                ...prev,
                expressionTokens: nextTokens,
                currentInput: '',
                currentDisplay: null,
                isResultDisplayed: false,
            };
        });
    }, []);

    const evaluateExpression = useCallback(() => {
        setState((prev) => {
            if (prev.error) return prev;
            const tokens = [...prev.expressionTokens];
            const current = prev.currentDisplay ?? prev.currentInput;
            if (current) tokens.push(current);
            if (tokens.length === 0 || isOperator(tokens[tokens.length - 1])) return prev;

            const rpn = toRPN(tokens);
            const result = evalRPN(rpn);

            if ('error' in result) {
                return {
                    ...prev,
                    error: result.error ?? 'Invalid Input',
                    currentInput: '',
                    currentDisplay: null,
                };
            }

            return {
                ...prev,
                expressionTokens: [],
                lastExpression: tokens.join(' '),
                currentInput: formatNumber(result.value),
                currentDisplay: null,
                isResultDisplayed: true,
                error: null,
            };
        });
    }, []);

    const applyUnary = useCallback((type: 'sqrt' | 'inv' | 'neg' | 'percent') => {
        setState((prev) => {
            if (prev.error) return prev;
            const raw = prev.currentInput || '0';
            const value = Number(raw);
            if (Number.isNaN(value)) return { ...prev, error: 'Invalid Input' };

            let computed = value;
            let display = raw;
            if (type === 'sqrt') {
                if (value < 0) return { ...prev, error: 'Invalid Input' };
                computed = Math.sqrt(value);
                display = `√(${raw})`;
            } else if (type === 'inv') {
                if (value === 0) return { ...prev, error: 'Cannot divide by zero' };
                computed = 1 / value;
                display = `1/(${raw})`;
            } else if (type === 'neg') {
                computed = value * -1;
                display = `±(${raw})`;
            } else if (type === 'percent') {
                computed = value / 100;
                display = `${raw}%`;
            }

            return {
                ...prev,
                currentInput: formatNumber(computed),
                currentDisplay: display,
                isResultDisplayed: false,
                error: null,
            };
        });
    }, []);

    const backspace = useCallback(() => {
        setState((prev) => {
            if (prev.error) return { ...prev, error: null, currentInput: '' };
            if (prev.currentInput.length === 0) return prev;
            const next = prev.currentInput.slice(0, -1);
            return { ...prev, currentInput: next, currentDisplay: null, isResultDisplayed: false };
        });
    }, []);

    const handleMemory = useCallback((type: 'MC' | 'MR' | 'MS' | 'M+' | 'M-') => {
        setState((prev) => {
            const value = Number(prev.currentInput || '0');
            if (Number.isNaN(value)) return prev;

            switch (type) {
                case 'MC':
                    return { ...prev, memoryValue: null };
                case 'MR':
                    return {
                        ...prev,
                        currentInput: formatNumber(prev.memoryValue ?? 0),
                        currentDisplay: null,
                        isResultDisplayed: false,
                    };
                case 'MS':
                    return { ...prev, memoryValue: value };
                case 'M+':
                    return { ...prev, memoryValue: (prev.memoryValue ?? 0) + value };
                case 'M-':
                    return { ...prev, memoryValue: (prev.memoryValue ?? 0) - value };
                default:
                    return prev;
            }
        });
    }, []);

    const handleKeyBlock = useCallback((event: KeyboardEvent<HTMLDivElement>) => {
        const blockedKeys = /[0-9+\-*/.=]/;
        if (blockedKeys.test(event.key)) {
            event.preventDefault();
        }
    }, []);

    if (!isVisible) return null;

    return (
        <div
            className="absolute z-50 select-none"
            style={{ left: position.x, top: position.y }}
            onKeyDown={handleKeyBlock}
            role="application"
            aria-label="Calculator"
        >
            <div className="w-[245px] h-[330px] bg-[#EBEBEB] border border-[#D6D6D6] shadow-[0_4px_10px_rgba(0,0,0,0.25)]">
                {/* Header */}
                <div
                    className="h-8 bg-[#3A77B8] text-white flex items-center justify-between pl-2 pr-0 cursor-move"
                    onMouseDown={(event) => {
                        if (event.button !== 0) return;
                        dragOffset.current = {
                            x: event.clientX - position.x,
                            y: event.clientY - position.y,
                        };
                        setIsDragging(true);
                    }}
                >
                    <span className="text-[13px] font-bold">Calculator</span>
                    <button
                        type="button"
                        onClick={onClose}
                        className="w-8 h-8 flex items-center justify-center hover:bg-[#E81123]"
                        aria-label="Close calculator"
                    >
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path
                                d="M6 6l12 12M18 6L6 18"
                                stroke="#FFFFFF"
                                strokeWidth="2"
                                strokeLinecap="round"
                            />
                        </svg>
                    </button>
                </div>

                {/* Display */}
                <div className="mx-2.5 mt-2 bg-white border border-[#7F9DB9] px-2 py-1 h-[55px]">
                    <div className="text-[12px] text-[#666666] text-right truncate h-4">
                        {expressionLine}
                    </div>
                    <div className="text-[20px] font-bold text-black text-right truncate leading-6">
                        {displayLine}
                    </div>
                </div>

                {/* Buttons */}
                <div className="grid grid-cols-5 grid-rows-6 gap-[5px] p-2.5">
                    {[
                        { label: 'MC', type: 'memory', onClick: () => handleMemory('MC') },
                        { label: 'MR', type: 'memory', onClick: () => handleMemory('MR') },
                        { label: 'MS', type: 'memory', onClick: () => handleMemory('MS') },
                        { label: 'M+', type: 'memory', onClick: () => handleMemory('M+') },
                        { label: 'M-', type: 'memory', onClick: () => handleMemory('M-') },

                        { label: '←', type: 'function', onClick: backspace },
                        { label: 'CE', type: 'function', onClick: clearEntry },
                        { label: 'C', type: 'function', onClick: resetAll },
                        { label: '±', type: 'function', onClick: () => applyUnary('neg') },
                        { label: '√', type: 'function', onClick: () => applyUnary('sqrt') },

                        { label: '7', type: 'number', onClick: () => appendDigit('7') },
                        { label: '8', type: 'number', onClick: () => appendDigit('8') },
                        { label: '9', type: 'number', onClick: () => appendDigit('9') },
                        { label: '/', type: 'operator', onClick: () => handleOperator('/') },
                        { label: '%', type: 'operator', onClick: () => applyUnary('percent') },

                        { label: '4', type: 'number', onClick: () => appendDigit('4') },
                        { label: '5', type: 'number', onClick: () => appendDigit('5') },
                        { label: '6', type: 'number', onClick: () => appendDigit('6') },
                        { label: '*', type: 'operator', onClick: () => handleOperator('*') },
                        { label: '1/x', type: 'operator', onClick: () => applyUnary('inv') },

                        { label: '1', type: 'number', onClick: () => appendDigit('1') },
                        { label: '2', type: 'number', onClick: () => appendDigit('2') },
                        { label: '3', type: 'number', onClick: () => appendDigit('3') },
                        { label: '-', type: 'operator', onClick: () => handleOperator('-') },
                        { label: '=', type: 'equals', onClick: evaluateExpression, rowSpan: 2 },

                        { label: '0', type: 'number', onClick: () => appendDigit('0'), colSpan: 2 },
                        { label: '.', type: 'number', onClick: appendDot },
                        { label: '+', type: 'operator', onClick: () => handleOperator('+') },
                    ].map((btn, index) => {
                        const baseClasses = 'h-8 text-sm font-semibold border border-[#C0C0C0]';
                        const typeClasses =
                            btn.type === 'memory' || btn.type === 'function'
                                ? 'bg-gradient-to-b from-[#F0F0F0] to-[#DCDCDC] text-[#B00000]'
                                : btn.type === 'operator'
                                    ? 'bg-gradient-to-b from-[#F0F0F0] to-[#DCDCDC] text-[#FF0000]'
                                    : btn.type === 'equals'
                                        ? 'bg-gradient-to-b from-[#F0F0F0] to-[#DCDCDC] text-black'
                                        : 'bg-white text-black';

                        const spanClasses = `${btn.colSpan ? 'col-span-2' : ''} ${btn.rowSpan ? 'row-span-2 h-full' : ''}`;

                        return (
                            <button
                                key={`${btn.label}-${index}`}
                                type="button"
                                onClick={btn.onClick}
                                className={`${baseClasses} ${typeClasses} ${spanClasses} rounded`}
                            >
                                {btn.label}
                            </button>
                        );
                    })}
                </div>
            </div>
        </div>
    );
}
````

## File: src/features/exam-engine/ui/ExamFooter.tsx
````typescript
/**
 * @fileoverview Exam Footer Action Bar
 * @description TCS iON-style action bar for save/clear/mark review
 */

'use client';

interface ExamFooterProps {
    onSaveNext: () => void;
    onClear: () => void;
    onMarkReview: () => void;
    onSubmit?: () => void;
    isLastSection: boolean;
    isSaving: boolean;
    isSubmitting: boolean;
    isAutoSubmitting: boolean;
    isSidebarVisible: boolean;
}

export function ExamFooter({
    onSaveNext,
    onClear,
    onMarkReview,
    onSubmit,
    isLastSection,
    isSaving,
    isSubmitting,
    isAutoSubmitting,
    isSidebarVisible,
}: ExamFooterProps) {
    const isActionDisabled = isSaving || isSubmitting || isAutoSubmitting;

    return (
        <div
            className={`h-16 border-t bg-white grid ${isSidebarVisible ? 'grid-cols-[48%_33%_19%]' : 'grid-cols-[48%_52%]'
                }`}
        >
            {/* Left footer (Col 1) */}
            <div className="flex items-center gap-3 px-4">
                <button
                    type="button"
                    onClick={onMarkReview}
                    disabled={isActionDisabled}
                    className="px-4 py-2 rounded text-white bg-purple-600 hover:bg-purple-700 transition-colors text-sm font-semibold disabled:opacity-60"
                >
                    Mark for Review &amp; Next
                </button>
                <button
                    type="button"
                    onClick={onClear}
                    disabled={isActionDisabled}
                    className="px-4 py-2 rounded border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 transition-colors text-sm font-semibold disabled:opacity-60"
                >
                    Clear Response
                </button>
            </div>

            {/* Middle footer (Col 2) */}
            <div className="flex items-center justify-end px-4 gap-3">
                <button
                    type="button"
                    onClick={onSaveNext}
                    disabled={isActionDisabled}
                    className="px-5 py-2 rounded text-white bg-emerald-600 hover:bg-emerald-700 transition-colors text-sm font-semibold disabled:opacity-60"
                >
                    {isSaving ? 'Saving...' : 'Save & Next'}
                </button>

                {/* FIX: Show Submit button in last section even when sidebar is hidden */}
                {isLastSection && !isSidebarVisible && (
                    <button
                        type="button"
                        onClick={onSubmit}
                        disabled={isActionDisabled}
                        className="px-5 py-2 rounded text-white bg-blue-600 hover:bg-blue-700 transition-colors text-sm font-semibold disabled:opacity-50"
                    >
                        {isSubmitting ? 'Submitting...' : 'Submit Exam'}
                    </button>
                )}
            </div>

            {/* Sidebar footer (Col 3) */}
            {isSidebarVisible && (
                <div className="flex items-center justify-center bg-blue-50 border-l border-exam-bg-border-light">
                    {isLastSection ? (
                        <button
                            type="button"
                            onClick={onSubmit}
                            disabled={isActionDisabled}
                            className="px-5 py-2 rounded text-white bg-blue-600 hover:bg-blue-700 transition-colors text-sm font-semibold disabled:opacity-50"
                        >
                            {isSubmitting ? 'Submitting...' : 'Submit Exam'}
                        </button>
                    ) : (
                        <span className="text-sm text-gray-500">Complete all sections to submit</span>
                    )}
                </div>
            )}
        </div>
    );
}
````

## File: src/features/shared/ui/PaletteShell.tsx
````typescript
/**
 * @fileoverview Shared palette shell
 * @description Shared container for palette UIs (runtime/admin)
 */

import type { ReactNode } from 'react';

interface PaletteShellProps {
    className?: string;
    children: ReactNode;
}

export function PaletteShell({ className = '', children }: PaletteShellProps) {
    return (
        <div className={`bg-white rounded-lg shadow-sm border border-gray-200 p-4 ${className}`}>
            {children}
        </div>
    );
}
````

## File: src/lib/ajv-validator.ts
````typescript
import Ajv from 'ajv';
import addFormats from 'ajv-formats';
import paperSchema from '../../schemas/paper_schema_v3.json';

const ajv = new Ajv({
    allErrors: true,
    strict: false,
    verbose: true
});

addFormats(ajv);

const validate = ajv.compile(paperSchema);

export function validatePaperSchema(data: unknown) {
    const valid = validate(data);
    return {
        valid: Boolean(valid),
        errors: valid ? undefined : validate.errors || []
    };
}
````

## File: src/lib/cloudinary.ts
````typescript
export async function uploadToCloudinary(file: File): Promise<string> {
    const cloudName = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;
    const uploadPreset = process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET;

    if (!cloudName || !uploadPreset) {
        throw new Error('Cloudinary env vars missing. Set NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME and NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET.');
    }

    if (!file.type.startsWith('image/')) {
        throw new Error('Only image files are allowed.');
    }

    const maxSizeBytes = 5_000_000;
    if (file.size > maxSizeBytes) {
        throw new Error('Image exceeds 5MB limit.');
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', uploadPreset);

    const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: 'POST',
        body: formData,
    });

    if (!response.ok) {
        let message = 'Cloudinary upload failed.';
        try {
            const errorBody = await response.json();
            message = errorBody?.error?.message || message;
        } catch {
            // ignore JSON parse errors
        }
        throw new Error(message);
    }

    const data = await response.json();
    if (!data?.secure_url) {
        throw new Error('Cloudinary upload failed: missing secure_url.');
    }

    return data.secure_url as string;
}
````

## File: src/lib/supabase/service-role.ts
````typescript
import 'server-only';

import { createClient } from '@supabase/supabase-js';

export function getServiceRoleClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY for privileged server reads.');
    }

    console.log("BACKEND DB URL:", process.env.DATABASE_URL);
    console.log("DB URL USED BY BACKEND:", url);

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}
````

## File: src/lib/telemetry.ts
````typescript
type CounterRecord = { count: number; updatedAt: number };

type TelemetryStore = Record<string, CounterRecord>;

function getStore(): TelemetryStore {
    const globalScope = globalThis as typeof globalThis & { __telemetryStore?: TelemetryStore };
    if (!globalScope.__telemetryStore) {
        globalScope.__telemetryStore = {};
    }
    return globalScope.__telemetryStore;
}

function getHourBucket(timestamp: number): number {
    return Math.floor(timestamp / 3_600_000);
}

export function incrementMetric(name: string, amount = 1): number {
    const now = Date.now();
    const bucket = getHourBucket(now);
    const key = `${name}:${bucket}`;
    const store = getStore();
    const existing = store[key];
    const next = (existing?.count ?? 0) + amount;
    store[key] = { count: next, updatedAt: now };
    return next;
}

export function getTelemetrySnapshot(): Record<string, number> {
    const store = getStore();
    const snapshot: Record<string, number> = {};
    Object.entries(store).forEach(([key, record]) => {
        snapshot[key] = record.count;
    });
    return snapshot;
}
````

## File: src/lib/useLandingAssets.ts
````typescript
'use client';

import { useCallback, useEffect, useState } from 'react';
import { getLandingAssets, type LandingAsset } from '@/lib/landing-assets';

type LandingAssetsState = {
    assets: Record<string, LandingAsset>;
    isLoading: boolean;
    error: string | null;
};

export function useLandingAssets(): LandingAssetsState {
    const [assets, setAssets] = useState<Record<string, LandingAsset>>({});
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    const loadAssets = useCallback(async () => {
        setIsLoading(true);
        setError(null);
        try {
            const data = await getLandingAssets();
            setAssets(data);
        } catch (err) {
            const message = err instanceof Error ? err.message : 'Failed to load landing assets';
            console.warn('[landing-assets] load failed', message);
            setError(message);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        loadAssets();
    }, [loadAssets]);

    return { assets, isLoading, error };
}
````

## File: src/types/react-katex.d.ts
````typescript
declare module 'react-katex' {
    import type { ComponentType } from 'react';

    export const BlockMath: ComponentType<{ math?: string | null; children?: string }>;
    export const InlineMath: ComponentType<{ math?: string | null; children?: string }>;
}
````

## File: src/utils/question-sets.ts
````typescript
import type {
    ContentLayoutType,
    ContextType,
    Question,
    QuestionContext,
    QuestionInSet,
    QuestionInSetWithAnswer,
    QuestionSetComplete,
    QuestionSetType,
    QuestionSetWithAnswers,
    QuestionWithAnswer,
    SectionName,
} from '@/types/exam';

const DEFAULT_METADATA = {} as const;

const sectionToSetType: Record<SectionName, QuestionSetType> = {
    VARC: 'VARC',
    DILR: 'DILR',
    QA: 'ATOMIC',
};

const sectionToLayout: Record<SectionName, ContentLayoutType> = {
    VARC: 'split_passage',
    DILR: 'split_chart',
    QA: 'single_focus',
};

const sectionToSetContextType: Record<SectionName, ContextType> = {
    VARC: 'rc_passage',
    DILR: 'dilr_set',
    QA: 'other_shared_stimulus',
};

const sectionToLegacyContextType: Record<SectionName, QuestionContext['context_type']> = {
    VARC: 'passage',
    DILR: 'data_set',
    QA: 'passage',
};

export function buildLegacyQuestionSets(
    questions: Question[],
    contexts: QuestionContext[],
    paperId: string
): QuestionSetComplete[] {
    const byContext = new Map<string, Question[]>();
    questions.forEach((q) => {
        if (!q.context_id) return;
        const list = byContext.get(q.context_id) ?? [];
        list.push(q);
        byContext.set(q.context_id, list);
    });

    const sets: QuestionSetComplete[] = [];

    contexts
        .slice()
        .sort((a, b) => a.display_order - b.display_order)
        .forEach((context) => {
            const contextQuestions = byContext.get(context.id) ?? [];
            if (contextQuestions.length === 0) return;

            const section = context.section;
            const setId = `legacy-context-${context.id}`;
            const sortedQuestions = contextQuestions
                .slice()
                .sort((a, b) => a.question_number - b.question_number);

            const questionsInSet: QuestionInSet[] = sortedQuestions.map((q, index) => ({
                id: q.id,
                set_id: setId,
                paper_id: q.paper_id,
                section: q.section,
                sequence_order: q.sequence_order ?? index + 1,
                question_number: q.question_number,
                question_text: q.question_text,
                question_type: q.question_type,
                options: q.options,
                positive_marks: q.positive_marks,
                negative_marks: q.negative_marks,
                difficulty: q.difficulty,
                topic: q.topic,
                subtopic: q.subtopic,
                question_image_url: q.question_image_url,
                is_active: q.is_active,
            }));

            sets.push({
                id: setId,
                paper_id: paperId,
                section,
                set_type: sectionToSetType[section],
                content_layout: sectionToLayout[section],
                context_type: sectionToSetContextType[section],
                context_title: context.title,
                context_body: context.content,
                context_image_url: context.image_url,
                context_additional_images: [],
                display_order: context.display_order,
                question_count: questionsInSet.length,
                metadata: DEFAULT_METADATA,
                is_active: true,
                is_published: true,
                questions: questionsInSet,
                created_at: context.created_at ?? '',
                updated_at: context.updated_at ?? '',
            });
        });

    questions
        .filter((q) => !q.context_id)
        .forEach((q) => {
            const setId = `legacy-atomic-${q.id}`;
            const questionsInSet: QuestionInSet[] = [{
                id: q.id,
                set_id: setId,
                paper_id: q.paper_id,
                section: q.section,
                sequence_order: q.sequence_order ?? 1,
                question_number: q.question_number,
                question_text: q.question_text,
                question_type: q.question_type,
                options: q.options,
                positive_marks: q.positive_marks,
                negative_marks: q.negative_marks,
                difficulty: q.difficulty,
                topic: q.topic,
                subtopic: q.subtopic,
                question_image_url: q.question_image_url,
                is_active: q.is_active,
            }];

            sets.push({
                id: setId,
                paper_id: paperId,
                section: q.section,
                set_type: 'ATOMIC',
                content_layout: 'single_focus',
                context_type: undefined,
                context_title: undefined,
                context_body: undefined,
                context_image_url: undefined,
                context_additional_images: [],
                display_order: q.question_number,
                question_count: 1,
                metadata: DEFAULT_METADATA,
                is_active: true,
                is_published: true,
                questions: questionsInSet,
                created_at: q.created_at,
                updated_at: q.updated_at,
            });
        });

    return sets;
}

export function buildLegacyQuestionSetsWithAnswers(
    questions: QuestionWithAnswer[],
    contexts: QuestionContext[],
    paperId: string
): QuestionSetWithAnswers[] {
    const byContext = new Map<string, QuestionWithAnswer[]>();
    questions.forEach((q) => {
        if (!q.context_id) return;
        const list = byContext.get(q.context_id) ?? [];
        list.push(q);
        byContext.set(q.context_id, list);
    });

    const sets: QuestionSetWithAnswers[] = [];

    contexts
        .slice()
        .sort((a, b) => a.display_order - b.display_order)
        .forEach((context) => {
            const contextQuestions = byContext.get(context.id) ?? [];
            if (contextQuestions.length === 0) return;

            const section = context.section;
            const setId = `legacy-context-${context.id}`;
            const sortedQuestions = contextQuestions
                .slice()
                .sort((a, b) => a.question_number - b.question_number);

            const questionsInSet: QuestionInSetWithAnswer[] = sortedQuestions.map((q, index) => ({
                id: q.id,
                set_id: setId,
                paper_id: q.paper_id,
                section: q.section,
                sequence_order: q.sequence_order ?? index + 1,
                question_number: q.question_number,
                question_text: q.question_text,
                question_type: q.question_type,
                options: q.options,
                positive_marks: q.positive_marks,
                negative_marks: q.negative_marks,
                difficulty: q.difficulty,
                topic: q.topic,
                subtopic: q.subtopic,
                question_image_url: q.question_image_url,
                is_active: q.is_active,
                correct_answer: q.correct_answer,
                solution_text: q.solution_text,
                solution_image_url: q.solution_image_url,
                video_solution_url: q.video_solution_url,
            }));

            sets.push({
                id: setId,
                paper_id: paperId,
                section,
                set_type: sectionToSetType[section],
                content_layout: sectionToLayout[section],
                context_type: sectionToSetContextType[section],
                context_title: context.title,
                context_body: context.content,
                context_image_url: context.image_url,
                context_additional_images: [],
                display_order: context.display_order,
                question_count: questionsInSet.length,
                metadata: DEFAULT_METADATA,
                is_active: true,
                is_published: true,
                questions: questionsInSet,
                created_at: context.created_at ?? '',
                updated_at: context.updated_at ?? '',
            });
        });

    questions
        .filter((q) => !q.context_id)
        .forEach((q) => {
            const setId = `legacy-atomic-${q.id}`;
            const questionsInSet: QuestionInSetWithAnswer[] = [{
                id: q.id,
                set_id: setId,
                paper_id: q.paper_id,
                section: q.section,
                sequence_order: q.sequence_order ?? 1,
                question_number: q.question_number,
                question_text: q.question_text,
                question_type: q.question_type,
                options: q.options,
                positive_marks: q.positive_marks,
                negative_marks: q.negative_marks,
                difficulty: q.difficulty,
                topic: q.topic,
                subtopic: q.subtopic,
                question_image_url: q.question_image_url,
                is_active: q.is_active,
                correct_answer: q.correct_answer,
                solution_text: q.solution_text,
                solution_image_url: q.solution_image_url,
                video_solution_url: q.video_solution_url,
            }];

            sets.push({
                id: setId,
                paper_id: paperId,
                section: q.section,
                set_type: 'ATOMIC',
                content_layout: 'single_focus',
                context_type: undefined,
                context_title: undefined,
                context_body: undefined,
                context_image_url: undefined,
                context_additional_images: [],
                display_order: q.question_number,
                question_count: 1,
                metadata: DEFAULT_METADATA,
                is_active: true,
                is_published: true,
                questions: questionsInSet,
                created_at: q.created_at,
                updated_at: q.updated_at,
            });
        });

    return sets;
}

export function flattenQuestionSetsToQuestions(questionSets: QuestionSetComplete[]): Question[] {
    const flattened = questionSets.flatMap((set) =>
        (set.questions ?? []).map((q) => ({
            id: q.id,
            paper_id: set.paper_id,
            section: set.section,
            question_number: q.question_number,
            set_id: set.id,
            sequence_order: q.sequence_order,
            question_text: q.question_text,
            question_type: q.question_type,
            options: q.options,
            positive_marks: q.positive_marks,
            negative_marks: q.negative_marks,
            question_image_url: q.question_image_url,
            context: set.set_type === 'ATOMIC'
                ? undefined
                : {
                    id: set.id,
                    paper_id: set.paper_id,
                    section: set.section,
                    title: set.context_title,
                    content: set.context_body ?? '',
                    context_type: sectionToLegacyContextType[set.section],
                    image_url: set.context_image_url,
                    display_order: set.display_order,
                    is_active: set.is_active,
                    created_at: set.created_at,
                    updated_at: set.updated_at,
                },
            difficulty: q.difficulty,
            topic: q.topic,
            subtopic: q.subtopic,
            is_active: q.is_active,
            created_at: set.created_at,
            updated_at: set.updated_at,
        }))
    );

    if (process.env.NODE_ENV !== 'production') {
        const seen = new Set<string>();
        const duplicates = new Set<string>();

        flattened.forEach((question) => {
            if (seen.has(question.id)) {
                duplicates.add(question.id);
            } else {
                seen.add(question.id);
            }
        });

        if (duplicates.size > 0) {
            console.warn('[ExamEngine] Detected duplicate question ids in assembled question list', {
                duplicateIds: Array.from(duplicates),
                totalQuestions: flattened.length,
            });
        }
    }

    return flattened;
}
````

## File: test.json
````json
{
  "schema_version": "v3.0",
  "paper": {
    "paper_key": "test",
    "title": "Test Paper",
    "slug": "test",
    "year": 2025,
    "total_questions": 1,
    "total_marks": 3,
    "duration_minutes": 120,
    "sections": [
      "VARC"
    ],
    "default_positive_marks": 3,
    "default_negative_marks": 1,
    "difficulty_level": "medium",
    "attempt_limit": 2
  },
  "question_sets": [
    {
      "client_set_id": "TEST_SET",
      "section": "VARC",
      "set_type": "ATOMIC",
      "display_order": 1,
      "context_image_url": null
    }
  ],
  "questions": [
    {
      "client_question_id": "test_Q1",
      "set_ref": "TEST_SET",
      "sequence_order": 1,
      "section": "VARC",
      "question_number": 1,
      "question_type": "MCQ",
      "topic": "Test",
      "subtopic": "Test",
      "difficulty": "easy",
      "correct_answer": "A",
      "positive_marks": 3,
      "negative_marks": 1,
      "question_text": "What is 1+1?",
      "options": [
        {
          "id": "A",
          "text": "2"
        },
        {
          "id": "B",
          "text": "3"
        },
        {
          "id": "C",
          "text": "4"
        },
        {
          "id": "D",
          "text": "5"
        }
      ]
    }
  ]
}
````

## File: test.md
````markdown
@P v=3.0 | key=test | title=Test Paper | slug=test | year=2025 | tq=1 | tm=3 | dur=120 | diff=medium | secs=VARC | dm=3,1 | flags=attempt_limit=2

@S VARC

@SET TEST_SET | type=ATOMIC | ctx=atomic | layout=text_only
@Q type=MCQ | topic=Test | sub=Test | diff=easy | m=3,1 | ans=A
? What is 1+1?
A. 2
B. 3
C. 4
D. 5
@END_Q
@END_SET

@END_S
````

## File: vitest.config.ts
````typescript
import { defineConfig } from 'vitest/config';
import path from 'path';

export default defineConfig({
    resolve: {
        alias: {
            '@': path.resolve(__dirname, './src'),
        },
    },
    test: {
        environment: 'node',
        include: ['src/**/*.test.ts', 'src/**/*.test.tsx'],
    },
});
````

## File: vs-codebase-export.bat
````batch
@echo off
REM God Mode: Complete codebase export for Gemini
REM Creates clean, lossless, ready-to-paste context chunks

echo 🚀 Starting God Mode export...

REM Clean up any existing files
echo 🧹 Cleaning up old files...
del /Q repomix-output* 2>nul
del /Q gemini_*.md 2>nul

REM Generate complete codebase export in Markdown format
echo 📦 Running repomix...
npx repomix --style markdown --split-output 900kb --ignore ".env.local,.env.*.local"

REM Rename the split files to gemini_XX.md format
echo 📋 Renaming chunks...
move repomix-output.1.md gemini_01.md >nul 2>&1
move repomix-output.2.md gemini_02.md >nul 2>&1
move repomix-output.3.md gemini_03.md >nul 2>&1
move repomix-output.4.md gemini_04.md >nul 2>&1
move repomix-output.5.md gemini_05.md >nul 2>&1

echo ✅ God Mode complete! Files ready:
for %%f in (gemini_*.md) do echo   %%~nf%%~xf

echo.
echo 🎯 Usage: Paste gemini_01.md, gemini_02.md, etc. into Gemini
echo 💡 Each chunk is ~900KB - perfect for Gemini's context window
echo 🔄 Run again anytime: .\export_for_gemini.bat

pause
````

## File: vs-codebase-export.ps1
````powershell
# God Mode: Complete codebase export for Gemini
# Creates clean, lossless, ready-to-paste context chunks

Write-Host "🚀 Starting God Mode export..." -ForegroundColor Green

# Clean up any existing files
Write-Host "🧹 Cleaning up old files..." -ForegroundColor Yellow
Remove-Item repomix-output* -ErrorAction SilentlyContinue
Remove-Item gemini_*.md -ErrorAction SilentlyContinue

# Generate complete codebase export in Markdown format
Write-Host "📦 Running repomix..." -ForegroundColor Yellow
& "npx.cmd" repomix --style markdown --split-output 900kb --ignore ".env.local,.env.*.local"

# Rename the split files to gemini_XX.md format
Write-Host "📋 Renaming chunks..." -ForegroundColor Yellow
$i = 1
Get-ChildItem repomix-output* -ErrorAction SilentlyContinue | Sort-Object Name | ForEach-Object {
    $newName = "gemini_{0:D2}.md" -f $i
    Rename-Item $_.FullName $newName -Force
    $i++
}

Write-Host "✅ God Mode complete! Files ready:" -ForegroundColor Green
$geminiFiles = Get-ChildItem gemini_*.md -ErrorAction SilentlyContinue | Sort-Object Name
if ($geminiFiles) {
    $geminiFiles | ForEach-Object {
        $sizeKB = [math]::Round($_.Length / 1KB, 1)
        Write-Host ("  " + $_.Name + " (" + $sizeKB + " KB)") -ForegroundColor White
    }

    $totalSize = ($geminiFiles | Measure-Object -Property Length -Sum).Sum
    $totalSizeMB = [math]::Round($totalSize / 1MB, 2)
    Write-Host ("  Total: " + $totalSizeMB + " MB across " + $geminiFiles.Count + " files") -ForegroundColor Gray
}
else {
    Write-Host "  No gemini_*.md files found! Repomix may have failed." -ForegroundColor Red
    Write-Host "  Try running manually: npx repomix --style markdown --split-output 900kb --ignore "".env.local,.env.*.local""" -ForegroundColor Yellow
}

Write-Host ""
Write-Host "🎯 Usage: Paste gemini_01.md, gemini_02.md, etc. into Gemini" -ForegroundColor Cyan
Write-Host "💡 Each chunk is ~900KB - perfect for Gemini's context window" -ForegroundColor Cyan
Write-Host "🔄 Run again anytime: .\export_for_gemini.ps1" -ForegroundColor Magenta
Get-ChildItem gemini_*.md | ForEach-Object {
    Write-Host ("  " + $_.Name + " (" + [math]::Round($_.Length / 1KB, 1) + " KB)")
}

Write-Host ""
Write-Host "🎯 Usage: Paste gemini_01.md, gemini_02.md, etc. into Gemini" -ForegroundColor Cyan
Write-Host "💡 Each chunk is ~900KB - perfect for Gemini's context window" -ForegroundColor Cyan
````

## File: docs/BLUEPRINT.md
````markdown
# BLUEPRINT.md - Architecture, Data Model & Routes (v0.1)

## 0) Scope (Milestone 1)
Freeze stack, pages/routes, data model, performance budgets, and CI/CD on **Netlify + Supabase**. No UI build yet.

---

## 1) Architecture (high-level)
**Client (Next.js 16, App Router, TS, Tailwind)**  
-> fetches from **Supabase** (DB/Auth/Storage).  
**Server** = Netlify's Next.js runtime (SSR/ISR) + Netlify Functions for server actions/webhooks.  
Secrets/keys stored in **Netlify Env** (never in repo).

---

## 2) Pages & Routes (Next.js App Router)
- `/` - Landing (project overview, CTA to start mock)
- `/mocks` - List of papers (year/slot/filter)
- `/mock/[paperId]` - Paper details + "Start test"
- `/exam/[attemptId]` *(protected)* - Test runner (timer, nav)
- `/result/[attemptId]` *(protected)* - Post-submit analytics
- `/dashboard` *(protected)* - My attempts & progress
- `/coming-soon` - Waitlist / access request (gated users)
- `/admin/access-control` *(admin)* - Signup mode + access approvals
- `/auth/sign-in`, `/auth/callback` - Supabase OAuth/email
- `/api/submit` - server action/function to submit + score via TypeScript (no SQL finalize_attempt)
- `/api/webhooks/supabase` - optional (events), future
- 404/500 error routes as defaults

Routing rules:
- Gate `/exam/*`, `/result/*`, `/mocks`, `/mock/*`, and `/dashboard` via middleware (auth + access status).
- Redirect non-active users to `/coming-soon` (fail-closed if access status lookup fails).
- Server actions that start/submit exams also verify access status (belt + suspenders).
- Code-split per route; no heavy libs on first load.

---

## 3) Data Model (Supabase)
All tables `uuid` PK; `created_at timestamptz default now()`. **RLS ON** by default.

### `profiles`
- `user_id uuid` (FK -> auth.users, PK)
- `display_name text`
- `avatar_url text`
- `role text` (enum: user, admin)

### `papers`
- `id uuid`
- `title text` (e.g., "CAT 2022 Slot 1")
- `year int2`, `slot text` (S1/S2/S3)
- `duration_min int2` (default 120)
- `sections jsonb` ([{name:"VARC", questions:24, marks:+3/-1}, ...])
- `is_published bool default true`

### `questions`
- `id uuid`
- `paper_id uuid` (FK -> papers.id)
- `section text` (VARC/DILR/QA)
- `type text` (MCQ/NAT)
- `stem text` (markdown allowed)
- `options jsonb` (for MCQ: ["A","B","C","D"])
- `answer jsonb` (MCQ: "B"; NAT: "123")
- `marks int2 default 3`, `negative int2 default 1`
- `assets jsonb` (e.g., signed URLs for images)

### `attempts`
- `id uuid`
- `user_id uuid` (FK -> profiles.user_id)
- `paper_id uuid` (FK)
- `status text` (in_progress/paused/submitted/completed/abandoned/expired)
- `started_at timestamptz`, `submitted_at timestamptz`, `completed_at timestamptz`
- `session_token uuid`, `last_activity_at timestamptz` (server-managed)
- `current_section text`, `current_question int4`, `time_remaining jsonb`
- `score numeric`, `accuracy numeric`, `time_spent_sec int4`

### `responses`
- `id uuid`
- `attempt_id uuid` (FK -> attempts.id)
- `question_id uuid` (FK -> questions.id)
- `answer text`
- `is_correct bool`
- `time_spent_sec int4`
- `status text` (not_visited/visited/answered/marked/answered_marked)
- `is_marked_for_review bool`, `is_visited bool`

### `event_log` (future)
- `id uuid`, `user_id uuid`, `event text`, `meta jsonb`

### `user_roles` (M6+ RBAC)
- `id uuid`
- `user_id uuid` (FK -> auth.users, UNIQUE)
- `role app_role` (enum: user, admin, editor)
- `granted_by uuid` (FK -> auth.users, nullable)
- `granted_at timestamptz`

### `question_contexts` (M6+ Content)
- `id uuid`
- `paper_id uuid` (FK -> papers.id)
- `section text` (VARC/DILR/QA)
- `context_type text` (passage, data_set, image, table)
- `title text` (optional)
- `content text` (Markdown supported)
- `image_url text` (optional)

### `admin_audit_log` (M6+ Security)
- `id uuid`
- `admin_id uuid` (FK -> auth.users)
- `action text` (create, update, delete, publish)
- `entity_type text` (paper, question, context, user_role)
- `entity_id uuid`
- `changes jsonb` (before/after snapshot)

### Access Control (Soft Launch)

### `app_settings`
- `setting_key text` (e.g., signup_mode)
- `setting_value text` (OPEN | GATED)
- `updated_by uuid` (FK -> auth.users)

### `user_access`
- `user_id uuid` (FK -> auth.users, UNIQUE)
- `status access_status` (active | pending | rejected)
- `reason text`, `decided_by uuid`, `decided_at timestamptz`
- `source text` (auto_signup, backfill, manual)

### `access_requests`
- `user_id uuid` (FK -> auth.users, nullable)
- `email text` (unique, lowercased)
- `status access_request_status` (pending | approved | rejected)
- `source text`, `notes text`, `decided_by uuid`, `decided_at timestamptz`

**RLS sketch**
- `profiles`: user can read/update own.
- `attempts/responses`: `user_id = auth.uid()` AND `user_access.status = active` (admin bypass).
- `papers/questions`: read all `is_published = true`; admins full.
- `user_roles`: users can read own; admins can manage all.
- `admin_audit_log`: admins only.
- `app_settings`: admins only.
- `user_access` / `access_requests`: users can read own; admins manage all.

---

## 4a) RBAC Architecture (Milestone 6+)

### Hybrid Claims Model
1. **Source of Truth**: `public.user_roles` table
2. **Performance**: Auth Hook (`custom_access_token_hook`) injects `user_role` into JWT
3. **Enforcement**:
   - Middleware: Gate `/admin/*` routes by checking JWT claims
   - RLS: Database policies check `auth.jwt() ->> 'user_role'`

### Admin Access Flow
1. User signs up -> `on_auth_user_created_role` trigger assigns `role = 'user'`
2. Existing admin promotes user -> INSERT/UPDATE in `user_roles`
3. User's next session -> Auth Hook injects `user_role: 'admin'` into JWT
4. Middleware allows access to `/admin/*` routes
5. RLS policies allow INSERT/UPDATE/DELETE on content tables

### Migration SQL
See `docs/MIGRATION_M6_RBAC.sql` for complete implementation.

---

## 4b) RBAC Hook Verification

**Enable JWT Hook (Supabase Dashboard)**
1. Go to **Authentication -> Hooks**.
2. Enable **Customize Access Token (JWT)**.
3. Select the function **public.custom_access_token_hook**.

**Sanity Check (after sign-in)**
- In the app, call `supabase.auth.getSession()` and confirm `session.user.app_metadata.user_role` is set.
- Optionally decode the JWT and confirm `user_role` exists at the root claim.

---

## 4) Netlify Setup
`netlify.toml` (root of repo):
```toml
[build]
  command = "pnpm build"
  publish = ".next"

[build.environment]
  NEXT_TELEMETRY_DISABLE = "1"

[[plugins]]
  package = "@netlify/plugin-nextjs"
````

## File: next.config.ts
````typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  images: {
    formats: ['image/avif', 'image/webp'],
  },
};

export default nextConfig;
````

## File: scripts/import-paper-v3.mjs
````javascript
#!/usr/bin/env node
/**
 * @fileoverview Paper Import Script v3 (Sets-First)
 * @description CLI tool to import papers using Schema v3.0 (question_sets → questions)
 * @usage node scripts/import-paper-v3.mjs <path-to-json-file> [options]
 * 
 * Schema v3.0 Structure:
 *   - paper: Paper metadata
 *   - question_sets[]: Parent containers (inserted FIRST)
 *   - questions[]: Children that reference sets via set_ref
 * 
 * Options:
 *   --publish             Publish the paper immediately after import
 *   --dry-run             Validate and show what would be done, but don't write
 *   --upsert              Use upsert mode (requires semantic keys in DB)
 *   --notes <text>        Import notes (optional)
 *   --skip-if-duplicate   Skip import if JSON hash already exists
 *   --help, -h            Show help message
 */

import { readFileSync } from 'fs';
import { createHash, randomUUID } from 'crypto';
import { createClient } from '@supabase/supabase-js';

// =============================================================================
// CONFIGURATION
// =============================================================================

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {
    console.error('❌ Missing environment variables:');
    console.error('   - NEXT_PUBLIC_SUPABASE_URL');
    console.error('   - SUPABASE_SERVICE_ROLE_KEY (use service role, not anon key!)');
    console.error('');
    console.error('Set them in .env.local or pass via environment.');
    process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
    auth: { persistSession: false }
});

// =============================================================================
// SCHEMA V3 VALIDATION (Phase 3)
// =============================================================================

const VALID_SECTIONS = ['VARC', 'DILR', 'QA'];
const VALID_SET_TYPES = ['VARC', 'DILR', 'CASELET', 'ATOMIC'];
const VALID_QUESTION_TYPES = ['MCQ', 'TITA'];
const VALID_CONTEXT_TYPES = [
    'rc_passage', 'dilr_set', 'caselet', 'data_table', 'graph', 'other_shared_stimulus'
];
const VALID_CONTENT_LAYOUTS = [
    'split_passage', 'split_chart', 'split_table', 'single_focus', 'image_top'
];
const COMPOSITE_SET_TYPES = ['VARC', 'DILR', 'CASELET'];

class ValidationError extends Error {
    constructor(message, errors = []) {
        super(message);
        this.name = 'ValidationError';
        this.errors = errors;
    }
}

function validateSchemaVersion(data) {
    if (data.schema_version !== 'v3.0') {
        throw new ValidationError(
            `Schema version must be 'v3.0' for sets-first import. Got: ${data.schema_version || 'undefined'}`,
            ['Use schema_version: "v3.0" for the sets-first importer']
        );
    }
}

function validatePaper(paper) {
    const errors = [];
    const required = ['slug', 'title'];

    for (const field of required) {
        if (!paper[field]) {
            errors.push(`paper.${field} is required`);
        }
    }

    if (paper.slug && !/^[a-z0-9-]+$/.test(paper.slug)) {
        errors.push(`paper.slug must be lowercase alphanumeric with hyphens: ${paper.slug}`);
    }

    if (paper.sections && !Array.isArray(paper.sections)) {
        errors.push('paper.sections must be an array');
    }

    if (errors.length > 0) {
        throw new ValidationError('Paper validation failed', errors);
    }

    return true;
}

function validateQuestionSets(sets) {
    const errors = [];
    const clientSetIds = new Set();

    if (!Array.isArray(sets)) {
        throw new ValidationError('question_sets must be an array');
    }

    sets.forEach((set, index) => {
        const prefix = `question_sets[${index}]`;

        // Required fields
        if (!set.client_set_id) {
            errors.push(`${prefix}.client_set_id is required`);
        } else if (!/^[A-Z0-9_]+$/.test(set.client_set_id)) {
            errors.push(`${prefix}.client_set_id must be uppercase alphanumeric with underscores: ${set.client_set_id}`);
        } else if (clientSetIds.has(set.client_set_id)) {
            errors.push(`${prefix}.client_set_id is duplicate: ${set.client_set_id}`);
        } else {
            clientSetIds.add(set.client_set_id);
        }

        if (!set.section) {
            errors.push(`${prefix}.section is required`);
        } else if (!VALID_SECTIONS.includes(set.section)) {
            errors.push(`${prefix}.section must be one of ${VALID_SECTIONS.join(', ')}: ${set.section}`);
        }

        if (!set.set_type) {
            errors.push(`${prefix}.set_type is required`);
        } else if (!VALID_SET_TYPES.includes(set.set_type)) {
            errors.push(`${prefix}.set_type must be one of ${VALID_SET_TYPES.join(', ')}: ${set.set_type}`);
        }

        if (set.display_order === undefined || set.display_order === null) {
            errors.push(`${prefix}.display_order is required`);
        }

        // Composite sets require context_body
        if (COMPOSITE_SET_TYPES.includes(set.set_type)) {
            if (!set.context_body || set.context_body.trim() === '') {
                errors.push(`${prefix}.context_body is required for ${set.set_type} sets`);
            }
        }

        // Validate context_type if provided
        if (set.context_type && !VALID_CONTEXT_TYPES.includes(set.context_type)) {
            errors.push(`${prefix}.context_type must be one of ${VALID_CONTEXT_TYPES.join(', ')}: ${set.context_type}`);
        }

        // Validate content_layout if provided
        if (set.content_layout && !VALID_CONTENT_LAYOUTS.includes(set.content_layout)) {
            errors.push(`${prefix}.content_layout must be one of ${VALID_CONTENT_LAYOUTS.join(', ')}: ${set.content_layout}`);
        }
    });

    if (errors.length > 0) {
        throw new ValidationError('Question sets validation failed', errors);
    }

    return clientSetIds;
}

function validateQuestions(questions, validSetRefs) {
    const errors = [];
    const clientQuestionIds = new Set();

    if (!Array.isArray(questions)) {
        throw new ValidationError('questions must be an array');
    }

    questions.forEach((q, index) => {
        const prefix = `questions[${index}]`;

        // Required fields
        if (!q.client_question_id) {
            errors.push(`${prefix}.client_question_id is required`);
        } else if (clientQuestionIds.has(q.client_question_id)) {
            errors.push(`${prefix}.client_question_id is duplicate: ${q.client_question_id}`);
        } else {
            clientQuestionIds.add(q.client_question_id);
        }

        if (!q.set_ref) {
            errors.push(`${prefix}.set_ref is required`);
        } else if (!validSetRefs.has(q.set_ref)) {
            errors.push(`${prefix}.set_ref references non-existent set: ${q.set_ref}`);
        }

        if (!q.sequence_order && q.sequence_order !== 0) {
            errors.push(`${prefix}.sequence_order is required`);
        }

        if (!q.question_number && q.question_number !== 0) {
            errors.push(`${prefix}.question_number is required`);
        }

        if (!q.question_text) {
            errors.push(`${prefix}.question_text is required`);
        }

        if (!q.question_type) {

            if (q.question_format && !VALID_QUESTION_TYPES.includes(q.question_format)) {
                errors.push(`${prefix}.question_format must be one of ${VALID_QUESTION_TYPES.join(', ')}: ${q.question_format}`);
            }

            if (q.correct_answer !== undefined && q.correct_answer !== null) {
                if (q.question_type === 'MCQ') {
                    const isString = typeof q.correct_answer === 'string';
                    const isStringArray = Array.isArray(q.correct_answer) && q.correct_answer.every(a => typeof a === 'string');
                    if (!isString && !isStringArray) {
                        errors.push(`${prefix}.correct_answer must be a string or string[] for MCQ questions`);
                    }
                }
                if (q.question_type === 'TITA') {
                    const isString = typeof q.correct_answer === 'string';
                    const isNumber = typeof q.correct_answer === 'number';
                    if (!isString && !isNumber) {
                        errors.push(`${prefix}.correct_answer must be a string or number for TITA questions`);
                    }
                }
            }
            errors.push(`${prefix}.question_type is required`);
        } else if (!VALID_QUESTION_TYPES.includes(q.question_type)) {
            errors.push(`${prefix}.question_type must be one of ${VALID_QUESTION_TYPES.join(', ')}: ${q.question_type}`);
        }

        // MCQ requires options
        if (q.question_type === 'MCQ') {
            if (!q.options || !Array.isArray(q.options) || q.options.length === 0) {
                errors.push(`${prefix}.options is required for MCQ questions`);
            } else {
                // Accept either string array ["A text", "B text"] or object array [{id, text}]
                const firstOpt = q.options[0];
                const isObjectFormat = typeof firstOpt === 'object' && firstOpt !== null;

                if (isObjectFormat) {
                    q.options.forEach((opt, optIdx) => {
                        if (!opt.id) {
                            errors.push(`${prefix}.options[${optIdx}].id is required`);
                        }
                        if (!opt.text && opt.text !== '') {
                            errors.push(`${prefix}.options[${optIdx}].text is required`);
                        }
                    });
                }
                // String format is valid as-is
            }
        }

        // Section validation
        if (q.section && !VALID_SECTIONS.includes(q.section)) {
            errors.push(`${prefix}.section must be one of ${VALID_SECTIONS.join(', ')}: ${q.section}`);
        }
    });

    if (errors.length > 0) {
        throw new ValidationError('Questions validation failed', errors);
    }

    return true;
}

function validateV3Data(data) {
    console.log('🔍 Validating Schema v3.0 payload...\n');

    // Check schema version
    validateSchemaVersion(data);

    // Check required root keys
    if (!data.paper) {
        throw new ValidationError('Missing required root key: paper');
    }
    if (!data.question_sets) {
        throw new ValidationError('Missing required root key: question_sets');
    }
    if (!data.questions) {
        throw new ValidationError('Missing required root key: questions');
    }

    // Validate paper
    validatePaper(data.paper);
    console.log('   ✅ paper validated');

    // Validate question_sets and collect valid client_set_ids
    const validSetRefs = validateQuestionSets(data.question_sets);
    console.log(`   ✅ question_sets validated (${data.question_sets.length} sets)`);

    // Validate questions against valid set refs
    validateQuestions(data.questions, validSetRefs);
    console.log(`   ✅ questions validated (${data.questions.length} questions)`);

    console.log('\n✅ All validation passed\n');
    return true;
}

// =============================================================================
// HASH FUNCTIONS
// =============================================================================

function computeJsonHash(data) {
    const jsonStr = JSON.stringify(data, Object.keys(data).sort());
    return createHash('sha256').update(jsonStr).digest('hex');
}

// =============================================================================
// IMPORT FUNCTIONS (Phase 2 - Sets-First)
// =============================================================================

async function importPaperV3(paperData, options = {}) {
    const { upsert = false, dryRun = false } = options;

    console.log(`📄 ${dryRun ? '[DRY RUN] ' : ''}Importing paper: ${paperData.title}`);

    if (dryRun) {
        console.log(`   Would create/update paper with slug: ${paperData.slug}`);
        return { id: 'dry-run-id', slug: paperData.slug };
    }

    // Check if paper exists
    const { data: existing } = await supabase
        .from('papers')
        .select('id')
        .eq('slug', paperData.slug)
        .single();

    const paperPayload = {
        slug: paperData.slug,
        title: paperData.title,
        description: paperData.description || null,
        year: paperData.year || new Date().getFullYear(),
        total_questions: paperData.total_questions || 0,
        total_marks: paperData.total_marks || 198,
        duration_minutes: paperData.duration_minutes || 120,
        sections: paperData.sections || ['VARC', 'DILR', 'QA'],
        default_positive_marks: paperData.default_positive_marks || 3.0,
        default_negative_marks: paperData.default_negative_marks || 1.0,
        difficulty_level: paperData.difficulty_level || 'medium',
        is_free: paperData.is_free ?? false,
        published: paperData.published ?? false,
        allow_pause: paperData.allow_pause ?? true,
        attempt_limit: paperData.attempt_limit ?? 0,
    };

    // Add paper_key if using upsert mode
    if (upsert && paperData.paper_key) {
        paperPayload.paper_key = paperData.paper_key;
    }

    if (existing) {
        console.log(`   ⚠️  Paper exists (id: ${existing.id}), updating...`);

        const { data, error } = await supabase
            .from('papers')
            .update(paperPayload)
            .eq('id', existing.id)
            .select()
            .single();

        if (error) throw error;
        return data;
    }

    const { data, error } = await supabase
        .from('papers')
        .insert(paperPayload)
        .select()
        .single();

    if (error) throw error;
    console.log(`   ✅ Paper created with id: ${data.id}`);
    return data;
}

async function importQuestionSetsV3(paperId, sets, options = {}) {
    const { upsert = false, dryRun = false } = options;

    console.log(`\n📋 ${dryRun ? '[DRY RUN] ' : ''}Importing ${sets.length} question_sets (SETS-FIRST)...`);

    // Build client_set_id → UUID map
    const setIdMap = {};

    if (dryRun) {
        sets.forEach(set => {
            setIdMap[set.client_set_id] = `dry-run-uuid-${set.client_set_id}`;
            console.log(`   Would create set: ${set.client_set_id} (${set.set_type})`);
        });
        return { count: sets.length, setIdMap };
    }

    // Delete existing sets (unless upsert mode)
    if (!upsert) {
        const { error: deleteError } = await supabase
            .from('question_sets')
            .delete()
            .eq('paper_id', paperId);

        if (deleteError) {
            console.warn(`   ⚠️  Could not delete existing question_sets: ${deleteError.message}`);
        }
    }

    // Prepare sets for insertion
    const setsToInsert = sets.map(set => {
        const newId = randomUUID();
        setIdMap[set.client_set_id] = newId;

        // Infer context_type from set_type if not provided
        let contextType = set.context_type;
        if (!contextType && set.set_type !== 'ATOMIC') {
            contextType = {
                'VARC': 'rc_passage',
                'DILR': 'dilr_set',
                'CASELET': 'caselet'
            }[set.set_type] || 'other_shared_stimulus';
        }

        // Infer content_layout
        let contentLayout = set.content_layout || 'single_focus';
        if (!set.content_layout) {
            if (set.context_image_url) {
                contentLayout = 'image_top';
            } else if (set.set_type === 'VARC') {
                contentLayout = 'split_passage';
            } else if (set.set_type === 'DILR') {
                contentLayout = 'split_chart';
            } else if (set.set_type === 'CASELET') {
                contentLayout = 'split_table';
            } else {
                contentLayout = 'single_focus';
            }
        }

        return {
            id: newId,
            paper_id: paperId,
            section: set.section,
            set_type: set.set_type,
            context_type: contextType,
            content_layout: contentLayout,
            context_title: set.context_title || null,
            context_body: set.context_body || null,
            context_image_url: set.context_image_url || null,
            context_additional_images: set.context_additional_images || null,
            display_order: set.display_order,
            is_active: set.is_active ?? true,
            is_published: true, // Sets must be published to be visible through question_sets_with_questions view
            metadata: set.metadata || {},
            client_set_id: set.client_set_id, // Store for upsert support
        };
    });

    // Insert in batches
    const batchSize = 50;
    let inserted = 0;

    for (let i = 0; i < setsToInsert.length; i += batchSize) {
        const batch = setsToInsert.slice(i, i + batchSize);
        const { error } = await supabase
            .from('question_sets')
            .insert(batch);

        if (error) throw error;
        inserted += batch.length;
    }

    console.log(`   ✅ Created ${inserted} question_sets`);
    console.log(`   📍 Set ID map built: ${Object.keys(setIdMap).length} entries`);

    return { count: inserted, setIdMap };
}

async function importQuestionsV3(paperId, questions, setIdMap, options = {}) {
    const { upsert = false, dryRun = false } = options;

    console.log(`\n📝 ${dryRun ? '[DRY RUN] ' : ''}Importing ${questions.length} questions (using set_ref → set_id mapping)...`);

    if (dryRun) {
        questions.forEach(q => {
            const setId = setIdMap[q.set_ref];
            console.log(`   Q${q.question_number}: ${q.client_question_id} → set ${q.set_ref} (${setId ? '✅' : '❌'})`);
        });
        return questions.length;
    }

    // Delete existing questions (unless upsert mode)
    if (!upsert) {
        const { error: deleteError } = await supabase
            .from('questions')
            .delete()
            .eq('paper_id', paperId);

        if (deleteError) {
            console.warn(`   ⚠️  Could not delete existing questions: ${deleteError.message}`);
        }
    }

    // Prepare questions for insertion
    const questionsToInsert = questions.map(q => {
        const setId = setIdMap[q.set_ref];
        if (!setId) {
            throw new Error(`Question ${q.client_question_id} references unknown set: ${q.set_ref}`);
        }

        // Convert options from {id, text} format to string[] format
        // The MCQRenderer expects options as string array: ["Option A text", "Option B text", ...]
        let normalizedOptions = null;
        if (q.options && Array.isArray(q.options) && q.options.length > 0) {
            const firstOpt = q.options[0];
            if (typeof firstOpt === 'object' && firstOpt !== null && 'text' in firstOpt) {
                // Convert {id, text}[] to string[]
                // Sort by id (A, B, C, D) to ensure correct order
                const sorted = [...q.options].sort((a, b) => a.id.localeCompare(b.id));
                normalizedOptions = sorted.map(opt => opt.text);
            } else {
                // Already string[] format
                normalizedOptions = q.options;
            }
        }

        return {
            id: randomUUID(),
            paper_id: paperId,
            section: q.section,
            question_number: q.question_number,
            question_text: q.question_text,
            question_type: q.question_type,
            question_format: q.question_format || q.question_type,
            taxonomy_type: q.taxonomy_type || null,
            topic_tag: q.topic_tag || null,
            difficulty_rationale: q.difficulty_rationale || null,
            options: normalizedOptions,
            correct_answer: q.correct_answer,
            positive_marks: q.positive_marks ?? 3.0,
            negative_marks: q.negative_marks ?? (q.question_type === 'TITA' ? 0 : 1.0),
            difficulty: q.difficulty || null,
            topic: q.topic || null,
            subtopic: q.subtopic || null,
            solution_text: q.solution_text || null,
            solution_image_url: q.solution_image_url || null,
            video_solution_url: q.video_solution_url || null,
            set_id: setId,
            sequence_order: q.sequence_order,
            is_active: true,
            client_question_id: q.client_question_id, // Store for upsert support
        };
    });

    // Insert in batches
    const batchSize = 50;
    let inserted = 0;

    for (let i = 0; i < questionsToInsert.length; i += batchSize) {
        const batch = questionsToInsert.slice(i, i + batchSize);
        const { error } = await supabase
            .from('questions')
            .insert(batch);

        if (error) throw error;
        inserted += batch.length;
        console.log(`   ✅ Inserted ${inserted}/${questions.length} questions`);
    }

    return inserted;
}

async function createIngestRun(paperId, canonicalJson, options = {}) {
    const { notes = null, skipIfDuplicate = false, dryRun = false } = options;

    if (dryRun) {
        console.log(`\n📦 [DRY RUN] Would create ingest run record`);
        return { dryRun: true };
    }

    console.log(`\n📦 Creating ingest run record...`);

    const canonicalHash = computeJsonHash(canonicalJson);

    if (skipIfDuplicate) {
        const { data: existing } = await supabase
            .from('paper_ingest_runs')
            .select('id, version_number')
            .eq('paper_id', paperId)
            .eq('canonical_json_hash', canonicalHash)
            .single();

        if (existing) {
            console.log(`   ⚠️  Duplicate detected - same JSON already imported as version ${existing.version_number}`);
            return { skipped: true, existing };
        }
    }

    // Get next version number
    const { data: maxVersion } = await supabase
        .from('paper_ingest_runs')
        .select('version_number')
        .eq('paper_id', paperId)
        .order('version_number', { ascending: false })
        .limit(1)
        .single();

    const nextVersion = (maxVersion?.version_number || 0) + 1;

    const { data: ingestRun, error } = await supabase
        .from('paper_ingest_runs')
        .insert({
            paper_id: paperId,
            schema_version: 'v3.0',
            version_number: nextVersion,
            canonical_paper_json: canonicalJson,
            canonical_json_hash: canonicalHash,
            import_notes: notes || 'Imported via v3 sets-first importer',
        })
        .select()
        .single();

    if (error) throw error;

    // Update paper's latest_ingest_run_id
    await supabase
        .from('papers')
        .update({ latest_ingest_run_id: ingestRun.id })
        .eq('id', paperId);

    console.log(`   ✅ Created ingest run v${nextVersion} (${ingestRun.id})`);
    return { ingestRun, version: nextVersion };
}

async function publishPaper(paperId, shouldPublish, dryRun = false) {
    if (!shouldPublish) {
        console.log(`\n📋 Paper saved as draft (use --publish to publish)`);
        return;
    }

    if (dryRun) {
        console.log(`\n🚀 [DRY RUN] Would publish paper`);
        return;
    }

    const { error: paperError } = await supabase
        .from('papers')
        .update({ published: true })
        .eq('id', paperId);

    if (paperError) throw paperError;

    const { error: setsError } = await supabase
        .from('question_sets')
        .update({ is_published: true })
        .eq('paper_id', paperId);

    if (setsError) {
        console.warn(`   ⚠️  Could not publish question_sets: ${setsError.message}`);
    }

    console.log(`\n🚀 Paper published!`);
}

// =============================================================================
// MAIN
// =============================================================================

async function main() {
    const args = process.argv.slice(2);

    if (args.length === 0 || args.includes('--help') || args.includes('-h')) {
        console.log(`
╔══════════════════════════════════════════════════════════════════════╗
║            CAT Paper Import Tool v3 (Sets-First)                     ║
╚══════════════════════════════════════════════════════════════════════╝

Usage:
  node scripts/import-paper-v3.mjs <path-to-json-file> [options]

Options:
  --publish             Publish the paper immediately after import
  --dry-run             Validate and show what would be done, but don't write
  --upsert              Use upsert mode (requires semantic keys in DB)
  --notes <text>        Import notes (optional)
  --skip-if-duplicate   Skip import if JSON hash already exists
  --help, -h            Show this help message

Schema v3.0 (Sets-First) Structure:
  {
    "schema_version": "v3.0",
    "paper": { ... },
    "question_sets": [
      { "client_set_id": "VARC_RC_1", "section": "VARC", "set_type": "VARC", ... }
    ],
    "questions": [
      { "client_question_id": "Q1", "set_ref": "VARC_RC_1", ... }
    ]
  }

Import Flow:
  1. Validate schema version = v3.0
  2. Validate paper metadata
  3. Validate question_sets (all client_set_id unique)
  4. Validate questions (all set_ref exist in question_sets)
  5. Insert paper
  6. Insert question_sets FIRST (build client_set_id → UUID map)
  7. Insert questions using set_ref → set_id mapping
  8. Create ingest run for versioning

Examples:
  # Dry run to validate
  node scripts/import-paper-v3.mjs data/paper-v3.json --dry-run

  # Import and publish
  node scripts/import-paper-v3.mjs data/paper-v3.json --publish

  # Import with notes
  node scripts/import-paper-v3.mjs data/paper-v3.json --notes "Initial v3 import"

Reference:
  - Schema: schemas/paper_schema_v3.json
  - Template: data_sanitized/paper_schema_v3.template.json
  - Docs: docs/CONTENT-SCHEMA.md
`);
        process.exit(0);
    }

    // Parse arguments
    const jsonPath = args.find(a => !a.startsWith('--'));
    const shouldPublish = args.includes('--publish');
    const dryRun = args.includes('--dry-run');
    const upsert = args.includes('--upsert');
    const skipIfDuplicate = args.includes('--skip-if-duplicate');

    let notes = null;
    const notesIdx = args.indexOf('--notes');
    if (notesIdx !== -1 && args[notesIdx + 1]) {
        notes = args[notesIdx + 1];
    }

    if (!jsonPath) {
        console.error('❌ Please provide a path to the JSON file');
        process.exit(1);
    }

    try {
        console.log(`
╔══════════════════════════════════════════════════════════════════════╗
║            CAT Paper Import Tool v3 (Sets-First)                     ║
╚══════════════════════════════════════════════════════════════════════╝
`);

        if (dryRun) {
            console.log('🔍 DRY RUN MODE - No changes will be made\n');
        }

        // Read and parse JSON
        console.log(`📂 Reading ${jsonPath}...`);
        const content = readFileSync(jsonPath, 'utf-8');
        const data = JSON.parse(content);

        // Validate v3 schema
        validateV3Data(data);

        // Import paper
        const paper = await importPaperV3(data.paper, { upsert, dryRun });

        // Import question_sets FIRST
        const { count: setCount, setIdMap } = await importQuestionSetsV3(
            paper.id,
            data.question_sets,
            { upsert, dryRun }
        );

        // Import questions using set_ref → set_id mapping
        const questionCount = await importQuestionsV3(
            paper.id,
            data.questions,
            setIdMap,
            { upsert, dryRun }
        );

        // Create ingest run
        const ingestResult = await createIngestRun(paper.id, data, {
            notes,
            skipIfDuplicate,
            dryRun
        });

        if (ingestResult.skipped) {
            console.log(`
╔══════════════════════════════════════════════════════════════════════╗
║                     Import Skipped (Duplicate)                       ║
╠══════════════════════════════════════════════════════════════════════╣
║  Paper ID:    ${paper.id}
║  Slug:        ${paper.slug}
║  Existing:    Version ${ingestResult.existing.version_number}
╚══════════════════════════════════════════════════════════════════════╝
`);
            return;
        }

        // Publish if requested
        await publishPaper(paper.id, shouldPublish, dryRun);

        // Summary
        console.log(`
╔══════════════════════════════════════════════════════════════════════╗
║                    Import Complete! ${dryRun ? '(DRY RUN)' : ''}                          
╠══════════════════════════════════════════════════════════════════════╣
║  Paper ID:    ${paper.id}
║  Slug:        ${data.paper.slug}
║  Version:     ${ingestResult.version || 'N/A (dry run)'}
║  Sets:        ${setCount}
║  Questions:   ${questionCount}
║  Published:   ${shouldPublish ? 'Yes' : 'No (draft)'}
╚══════════════════════════════════════════════════════════════════════╝
`);

    } catch (err) {
        if (err instanceof ValidationError) {
            console.error(`\n❌ Validation failed: ${err.message}`);
            if (err.errors && err.errors.length > 0) {
                console.error('\nErrors:');
                err.errors.forEach(e => console.error(`   • ${e}`));
            }
        } else {
            console.error(`\n❌ Import failed: ${err.message}`);
        }
        process.exit(1);
    }
}

main();
````

## File: scripts/markdown_to_json_parser_v3.mjs
````javascript
#!/usr/bin/env node
/*
 * markdown_to_json_parser_v3.mjs
 *
 * Parses CPM-AUTO (Compact Paper Markup — Auto Numbering) into JSON schema v3.0.
 * Usage:
 *   node scripts/markdown_to_json_parser_v3.mjs <input.md> [output.json]
 */

import fs from 'fs';
import path from 'path';
import { validatePaperSchema } from './ajv-validator.mjs';

function toBool(value) {
    if (value === undefined || value === null) return undefined;
    const v = String(value).trim().toLowerCase();
    if (v === 'true') return true;
    if (v === 'false') return false;
    return undefined;
}

function toInt(value) {
    if (value === undefined || value === null || value === '') return undefined;
    const num = Number(value);
    return Number.isNaN(num) ? undefined : num;
}

function normalizeLine(line) {
    return line
        .replace(/\\_/g, '_')
        .replace(/\\>/g, '>')
        .replace(/\\\+/g, '+')
        .replace(/\\#/g, '#')
        .trim();
}

function parsePipeKeyValues(input) {
    const result = {};
    const parts = input.split('|').map((p) => p.trim()).filter(Boolean);
    for (const part of parts) {
        const eqIndex = part.indexOf('=');
        if (eqIndex === -1) continue;
        const key = part.slice(0, eqIndex).trim();
        const value = part.slice(eqIndex + 1).trim();
        result[key] = value;
    }
    return result;
}

function parsePaperLine(line) {
    const payload = line.replace(/^@P\s*/, '').trim();
    const data = parsePipeKeyValues(payload);
    const dm = (data.dm || '').split(',').map((s) => s.trim());
    const flags = {};
    if (data.flags) {
        for (const entry of data.flags.split(';')) {
            const [k, v] = entry.split('=').map((s) => s.trim());
            if (!k) continue;
            const boolVal = toBool(v);
            flags[k] = boolVal !== undefined ? boolVal : v;
        }
    }

    const schemaVersionRaw = data.v || '3.0';
    const schema_version = schemaVersionRaw.startsWith('v') ? schemaVersionRaw : `v${schemaVersionRaw}`;

    return {
        schema_version,
        paper: {
            paper_key: data.key,
            title: data.title,
            slug: data.slug,
            description: data.desc,
            year: toInt(data.year),
            total_questions: toInt(data.tq),
            total_marks: toInt(data.tm),
            duration_minutes: toInt(data.dur),
            sections: data.secs ? data.secs.split(',').map((s) => s.trim()).filter(Boolean) : [],
            default_positive_marks: toInt(dm[0]),
            default_negative_marks: toInt(dm[1]),
            difficulty_level: data.diff,
            is_free: toBool(flags.is_free) ?? undefined,
            published: toBool(flags.published) ?? undefined,
            allow_pause: toBool(flags.allow_pause) ?? undefined,
            attempt_limit: toInt(flags.attempt_limit)
        }
    };
}

function parseSetLine(line) {
    const payload = line.replace(/^@SET\s*/, '').trim();
    const firstSplit = payload.split('|');
    const setId = firstSplit[0].trim();
    const rest = firstSplit.slice(1).join('|');
    const data = parsePipeKeyValues(rest);
    return {
        setId,
        data
    };
}

function normalizeToken(value) {
    if (value === undefined || value === null) return value;
    return String(value).replace(/\\/g, '').trim();
}

function normalizeContextType(raw) {
    const value = normalizeToken(raw);
    if (!value) return undefined;
    return value;
}

function normalizeContentLayout(raw) {
    const value = normalizeToken(raw);
    if (!value) return undefined;
    if (value === 'text_only') return 'split_passage';
    if (value === 'split_view') return 'split_table';
    return value;
}

function parseQuestionLine(line) {
    const payload = line.replace(/^@Q\s*/, '').trim();
    const data = parsePipeKeyValues(payload);
    return data;
}

function parseMarkdownToV3(markdownText) {
    const lines = markdownText.split(/\r?\n/);

    let schema_version = 'v3.0';
    let paper = null;
    const question_sets = [];
    const questions = [];

    let currentSection = null;
    let currentSet = null;
    let sectionSetOrder = {};
    let setQuestionOrder = 0;
    let globalQuestionNumber = 0;

    let inContext = false;
    let contextBuffer = [];

    let inQuestion = false;
    let questionData = null;
    let questionTextLines = [];
    let solutionLines = [];
    let options = [];
    let inSolution = false;

    function finalizeContext() {
        if (currentSet && contextBuffer.length) {
            currentSet.context_body = contextBuffer.join('\n').trim();
        }
        contextBuffer = [];
        inContext = false;
    }

    function finalizeQuestion() {
        if (!questionData) return;
        const question_text = questionTextLines.join('\n').trim();
        const solution_text = solutionLines.join('\n').trim();
        const question = {
            ...questionData,
            question_text
        };
        if (options.length) {
            question.options = options;
        }
        if (solution_text) {
            question.solution_text = solution_text;
        }
        questions.push(question);

        inQuestion = false;
        inSolution = false;
        questionData = null;
        questionTextLines = [];
        solutionLines = [];
        options = [];
    }

    for (const rawLine of lines) {
        const line = normalizeLine(rawLine);
        if (!line || line.startsWith('#')) {
            continue;
        }

        if (line === '@END_CTX') {
            finalizeContext();
            continue;
        }

        if (line === '@END_Q') {
            finalizeQuestion();
            continue;
        }

        if (line === '@END_SET') {
            currentSet = null;
            setQuestionOrder = 0;
            continue;
        }

        if (line === '@END_S') {
            currentSection = null;
            continue;
        }

        if (line === '@CTX') {
            inContext = true;
            continue;
        }

        if (line.startsWith('@P ')) {
            const paperPayload = parsePaperLine(line);
            schema_version = paperPayload.schema_version;
            paper = paperPayload.paper;
            continue;
        }

        if (line.startsWith('@S ')) {
            currentSection = line.replace(/^@S\s*/, '').trim();
            if (!sectionSetOrder[currentSection]) {
                sectionSetOrder[currentSection] = 0;
            }
            continue;
        }

        if (line.startsWith('@SET ')) {
            finalizeContext();
            const { setId, data } = parseSetLine(line);
            const order = (sectionSetOrder[currentSection] || 0) + 1;
            sectionSetOrder[currentSection] = order;
            const normalizedSetId = normalizeToken(setId);
            const normalizedContextType = normalizeContextType(data.ctx);
            const normalizedContentLayout = normalizeContentLayout(data.layout);
            const normalizedSetType = normalizeToken(data.type);
            currentSet = {
                client_set_id: normalizedSetId,
                section: currentSection,
                set_type: normalizedSetType,
                display_order: order,
                context_type: normalizedContextType,
                context_title: data.title,
                content_layout: normalizedContentLayout
            };

            // Only include context_image_url if it has a valid value (schema requires URI format)
            if (data.image_url) {
                currentSet.context_image_url = data.image_url;
            }

            if (normalizedSetType === 'ATOMIC') {
                delete currentSet.context_type;
                delete currentSet.content_layout;
            }

            question_sets.push(currentSet);
            setQuestionOrder = 0;
            continue;
        }

        if (line.startsWith('@Q ')) {
            finalizeQuestion();
            const data = parseQuestionLine(line);
            setQuestionOrder += 1;
            globalQuestionNumber += 1;
            const dm = (data.m || '').split(',').map((s) => s.trim());
            const sanitizedKey = paper?.paper_key ? paper.paper_key.replace(/[^A-Za-z0-9_]/g, '_') : null;
            const client_question_id = data.id || (sanitizedKey ? `${sanitizedKey}_Q${globalQuestionNumber}` : `Q${globalQuestionNumber}`);
            questionData = {
                client_question_id,
                set_ref: currentSet?.client_set_id,
                sequence_order: setQuestionOrder,
                section: currentSection,
                question_number: globalQuestionNumber,
                question_type: data.type,
                taxonomy_type: data.tax,
                topic: data.topic,
                subtopic: data.sub,
                difficulty: data.diff,
                correct_answer: data.ans,
                positive_marks: toInt(dm[0]) ?? paper?.default_positive_marks,
                negative_marks: toInt(dm[1]) ?? paper?.default_negative_marks
            };
            inQuestion = true;
            inSolution = false;
            continue;
        }

        if (inContext) {
            contextBuffer.push(rawLine.replace(/\r?\n?$/, ''));
            continue;
        }

        if (inQuestion) {
            if (line.startsWith('?')) {
                questionTextLines.push(line.replace(/^\?\s?/, ''));
                continue;
            }
            if (/^[A-Z]\./.test(line)) {
                const optionId = line[0];
                const optionText = line.slice(2).trim();
                options.push({ id: optionId, text: optionText });
                continue;
            }
            if (line.startsWith('>')) {
                inSolution = true;
                solutionLines.push(line.replace(/^>\s?/, ''));
                continue;
            }
            if (inSolution) {
                solutionLines.push(line);
                continue;
            }
            if (questionTextLines.length) {
                questionTextLines.push(line);
            }
        }
    }

    finalizeContext();
    finalizeQuestion();

    return {
        schema_version,
        paper,
        question_sets,
        questions
    };
}

function formatAjvErrors(errors = []) {
    return errors.map((err) => {
        const path = err.instancePath || '(root)';
        const message = err.message || err.keyword || 'schema validation error';
        return `${path} ${message}`.trim();
    });
}

function main() {
    const inputPath = process.argv[2];
    const outputPath = process.argv[3];

    if (!inputPath) {
        console.error('Usage: node scripts/markdown_to_json_parser_v3.mjs <input.md> [output.json]');
        process.exit(1);
    }

    const markdownText = fs.readFileSync(inputPath, 'utf8');
    const result = parseMarkdownToV3(markdownText);
    const ajvResult = validatePaperSchema(result);
    const ajvErrors = ajvResult.valid ? [] : formatAjvErrors(ajvResult.errors);

    if (ajvErrors.length > 0) {
        console.error('❌ AJV schema validation errors:');
        ajvErrors.forEach((e) => console.error(`   - ${e}`));
        console.error('');
        console.log('⚠️  Writing output anyway for debugging...');
    }

    const output = JSON.stringify(result, null, 2);

    if (outputPath) {
        fs.writeFileSync(outputPath, output, 'utf8');
    } else {
        const derivedPath = path.join(process.cwd(), 'paper_v3.json');
        fs.writeFileSync(derivedPath, output, 'utf8');
        console.log(`Wrote ${derivedPath}`);
    }

    if (ajvErrors.length > 0) {
        process.exit(1);
    }
}

if (process.argv[1] && process.argv[1].includes('markdown_to_json_parser_v3.mjs')) {
    main();
}

export { parseMarkdownToV3 };
````

## File: src/app/admin/access-control/actions.ts
````typescript
'use server';

import 'server-only';

import { createClient } from '@supabase/supabase-js';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';
import { revalidatePath } from 'next/cache';

function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin operations require service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

async function createActionClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string;
    const cookieStore = await cookies();

    return createServerClient(url, anon, {
        cookies: {
            getAll() {
                return cookieStore.getAll();
            },
            setAll(cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options }) =>
                        cookieStore.set(name, value, options)
                    );
                } catch {
                    // Ignore - cookies can't be set in server actions during render
                }
            },
        },
    });
}

async function verifyAdmin(): Promise<{ userId: string }> {
    const supabase = await createActionClient();
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error || !user) {
        throw new Error('Not authenticated');
    }

    const skipAdminCheck = process.env.SKIP_ADMIN_CHECK === 'true' && process.env.NODE_ENV !== 'production';
    if (!skipAdminCheck) {
        const { data: { session } } = await supabase.auth.getSession();
        let role: string | null = session?.user?.app_metadata?.user_role ?? null;

        if (!role && session?.access_token) {
            try {
                const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                    user_role?: string;
                    app_metadata?: { user_role?: string };
                };
                role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
            } catch {
                role = null;
            }
        }

        if (role !== 'admin' && role !== 'dev') {
            const { data: isAdmin, error: rpcError } = await supabase.rpc('is_admin');
            if (rpcError || !isAdmin) {
                throw new Error('Unauthorized: Admin access required');
            }
        }
    }

    return { userId: user.id };
}

export async function updateSignupMode(formData: FormData): Promise<void> {
    try {
        const mode = String(formData.get('signup_mode') || '').toUpperCase();
        if (mode !== 'OPEN' && mode !== 'GATED') {
            console.warn('Invalid signup mode', mode);
            return;
        }

        const { userId } = await verifyAdmin();
        const adminClient = getAdminClient();

        const { error } = await adminClient
            .from('app_settings')
            .upsert(
                {
                    setting_key: 'signup_mode',
                    setting_value: mode,
                    updated_by: userId,
                },
                { onConflict: 'setting_key' }
            );

        if (error) {
            console.error('Failed to update signup mode', error.message);
            return;
        }

        revalidatePath('/admin/access-control');
        revalidatePath('/admin');
    } catch (err) {
        console.error('Failed to update signup mode', err);
    }
}

async function updateAccessRequest(
    requestId: string,
    userId: string | null,
    status: 'approved' | 'rejected'
): Promise<void> {
    try {
        const { userId: adminId } = await verifyAdmin();
        const adminClient = getAdminClient();

        const { data: requestRow, error: requestFetchError } = await adminClient
            .from('access_requests')
            .select('user_id, email')
            .eq('id', requestId)
            .maybeSingle();

        if (requestFetchError) {
            console.error('Failed to load access request details', requestFetchError.message);
        }

        const { error: requestError } = await adminClient
            .from('access_requests')
            .update({
                status,
                decided_by: adminId,
                decided_at: new Date().toISOString(),
            })
            .eq('id', requestId);

        if (requestError) {
            console.error('Failed to update access request', requestError.message);
            return;
        }

        let resolvedUserId = userId ?? requestRow?.user_id ?? null;
        const requestEmail = requestRow?.email ?? null;

        if (!resolvedUserId && requestEmail) {
            const { data: userData, error: userError } =
                await adminClient.auth.admin.getUserByEmail(requestEmail);

            if (userError) {
                console.error('Failed to resolve user by email', userError.message);
            } else if (userData?.user?.id) {
                resolvedUserId = userData.user.id;
            }
        }

        if (resolvedUserId && requestRow?.user_id !== resolvedUserId) {
            const { error: attachError } = await adminClient
                .from('access_requests')
                .update({ user_id: resolvedUserId })
                .eq('id', requestId);

            if (attachError) {
                console.error('Failed to attach user to access request', attachError.message);
            }
        }

        if (resolvedUserId) {
            const nextStatus = status === 'approved' ? 'active' : 'rejected';
            const { error: accessError } = await adminClient
                .from('user_access')
                .upsert(
                    {
                        user_id: resolvedUserId,
                        status: nextStatus,
                        decided_by: adminId,
                        decided_at: new Date().toISOString(),
                    },
                    { onConflict: 'user_id' }
                );

            if (accessError) {
                console.error('Failed to update user access', accessError.message);
                return;
            }
        } else {
            console.warn('Access request has no linked user_id; user_access not updated.');
        }

        revalidatePath('/admin/access-control');
        revalidatePath('/admin');
    } catch (err) {
        console.error('Failed to update access request', err);
    }
}

export async function approveAccessRequest(formData: FormData): Promise<void> {
    const requestId = String(formData.get('request_id') || '');
    const userId = formData.get('user_id') ? String(formData.get('user_id')) : null;
    if (!requestId) {
        console.warn('Missing request id for approval');
        return;
    }
    await updateAccessRequest(requestId, userId, 'approved');
}

export async function rejectAccessRequest(formData: FormData): Promise<void> {
    const requestId = String(formData.get('request_id') || '');
    const userId = formData.get('user_id') ? String(formData.get('user_id')) : null;
    if (!requestId) {
        console.warn('Missing request id for rejection');
        return;
    }
    await updateAccessRequest(requestId, userId, 'rejected');
}
````

## File: src/app/admin/bug-reports/actions.ts
````typescript
'use server';

import 'server-only';

/**
 * @fileoverview Admin Server Actions for Bug Reports
 * @description Uses service role key to bypass RLS for admin operations
 */

import { createClient } from '@supabase/supabase-js';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin operations require service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

async function createActionClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string;
    const cookieStore = await cookies();

    return createServerClient(url, anon, {
        cookies: {
            getAll() {
                return cookieStore.getAll();
            },
            setAll(cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options }) =>
                        cookieStore.set(name, value, options)
                    );
                } catch {
                    // Ignore - cookies can't be set in server actions during render
                }
            },
        },
    });
}

async function verifyAdmin(): Promise<void> {
    const supabase = await createActionClient();
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error || !user) {
        throw new Error('Not authenticated');
    }

    const skipAdminCheck = process.env.SKIP_ADMIN_CHECK === 'true' && process.env.NODE_ENV !== 'production';
    if (!skipAdminCheck) {
        const { data: { session } } = await supabase.auth.getSession();
        let role: string | null = session?.user?.app_metadata?.user_role ?? null;

        if (!role && session?.access_token) {
            try {
                const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                    user_role?: string;
                    app_metadata?: { user_role?: string };
                };
                role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
            } catch {
                role = null;
            }
        }

        if (role !== 'admin' && role !== 'dev') {
            const { data: isAdmin, error: rpcError } = await supabase.rpc('is_admin');
            if (rpcError || !isAdmin) {
                throw new Error('Unauthorized: Admin access required');
            }
        }
    }
}

export async function updateBugReportStatus(
    reportId: string,
    status: 'unchecked' | 'in_progress' | 'resolved'
): Promise<{ success: boolean; error?: string }> {
    try {
        if (!reportId) {
            return { success: false, error: 'Report id is required.' };
        }

        await verifyAdmin();
        const adminClient = getAdminClient();

        const { error } = await adminClient
            .from('bug_reports')
            .update({ status })
            .eq('id', reportId);

        if (error) {
            return { success: false, error: error.message || 'Failed to update status' };
        }

        return { success: true };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        return { success: false, error: message };
    }
}
````

## File: src/app/admin/bug-reports/page.tsx
````typescript
/**
 * @fileoverview Bug Reports Admin Page
 * @description Admin-only view of user-submitted bug reports
 */

import { sbSSR } from '@/lib/supabase/server';
import { createClient, type PostgrestSingleResponse } from '@supabase/supabase-js';
import { redirect } from 'next/navigation';
import BugReportStatusSelect from './BugReportStatusSelect';

type BugReportRow = {
    id: string;
    user_id: string | null;
    route: string | null;
    description: string;
    screenshot_path: string | null;
    meta: Record<string, unknown> | null;
    status?: string | null;
    created_at: string;
};

function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin pages require service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

export default async function BugReportsPage({ searchParams }: { searchParams?: Record<string, string | string[]> }) {
    const supabase = await sbSSR();

    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/auth/sign-in');
    }

    const { data: { session } } = await supabase.auth.getSession();
    let role: string | null = session?.user?.app_metadata?.user_role ?? null;

    if (!role && session?.access_token) {
        try {
            const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                user_role?: string;
                app_metadata?: { user_role?: string };
            };
            role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
        } catch {
            role = null;
        }
    }

    let isAdmin = role === 'admin' || role === 'dev';
    if (!isAdmin) {
        const { data: isAdminRpc, error: rpcError } = await supabase.rpc('is_admin');
        isAdmin = !rpcError && Boolean(isAdminRpc);
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    const adminClient = getAdminClient();

    let hasStatusColumn = true;
    const statusFilterRaw = typeof searchParams?.status === 'string' ? searchParams?.status : Array.isArray(searchParams?.status) ? searchParams?.status[0] : undefined;
    const statusFilter = statusFilterRaw && ['unchecked', 'in_progress', 'resolved'].includes(statusFilterRaw) ? statusFilterRaw : 'all';
    const sortModeRaw = typeof searchParams?.sort === 'string' ? searchParams?.sort : Array.isArray(searchParams?.sort) ? searchParams?.sort[0] : undefined;
    const sortMode = sortModeRaw === 'status' ? 'status' : 'created';
    let reportsResponse: PostgrestSingleResponse<BugReportRow[]> = await adminClient
        .from('bug_reports')
        .select('id, user_id, route, description, screenshot_path, meta, status, created_at')
        .order('created_at', { ascending: false })
        .limit(100);

    if (
        reportsResponse.error?.code === '42703' ||
        reportsResponse.error?.message?.toLowerCase().includes('status') ||
        reportsResponse.error?.details?.toLowerCase().includes('status')
    ) {
        hasStatusColumn = false;
        reportsResponse = (await adminClient
            .from('bug_reports')
            .select('id, user_id, route, description, screenshot_path, meta, created_at')
            .order('created_at', { ascending: false })
            .limit(100)) as PostgrestSingleResponse<BugReportRow[]>;
    }

    if (reportsResponse.error) {
        return (
            <div className="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
                Failed to load bug reports: {reportsResponse.error.message}
            </div>
        );
    }

    let safeReports = (reportsResponse.data ?? []) as BugReportRow[];
    if (hasStatusColumn && statusFilter !== 'all') {
        safeReports = safeReports.filter((report) => report.status === statusFilter);
    }
    if (hasStatusColumn && sortMode === 'status') {
        const statusOrder: Record<string, number> = { unchecked: 0, in_progress: 1, resolved: 2 };
        safeReports = [...safeReports].sort((a, b) => {
            const aRank = statusOrder[a.status ?? ''] ?? 99;
            const bRank = statusOrder[b.status ?? ''] ?? 99;
            if (aRank !== bRank) return aRank - bRank;
            return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
        });
    }
    const uniqueUserIds = Array.from(new Set(safeReports.map((report) => report.user_id).filter(Boolean))) as string[];
    const userEmailMap: Record<string, string> = {};

    await Promise.all(
        uniqueUserIds.map(async (userId) => {
            try {
                const { data } = await adminClient.auth.admin.getUserById(userId);
                userEmailMap[userId] = data?.user?.email ?? userId;
            } catch {
                userEmailMap[userId] = userId;
            }
        })
    );

    const signedUrlMap: Record<string, string> = {};
    safeReports.forEach((report) => {
        if (report.screenshot_path && report.screenshot_path.startsWith('http')) {
            signedUrlMap[report.id] = report.screenshot_path;
        }
    });

    return (
        <div className="space-y-6">
            <div>
                <h1 className="text-2xl font-bold text-gray-900">Bug Reports</h1>
                <p className="text-sm text-gray-500">Most recent user-reported issues (latest 100).</p>
            </div>
            {hasStatusColumn && (
                <form className="flex flex-wrap items-center gap-3 text-sm" method="GET">
                    <label className="text-gray-600">
                        Status
                        <select
                            name="status"
                            defaultValue={statusFilter}
                            className="ml-2 rounded-md border border-gray-300 bg-white px-2 py-1 text-sm"
                        >
                            <option value="all">All</option>
                            <option value="unchecked">Unchecked</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </label>
                    <label className="text-gray-600">
                        Sort
                        <select
                            name="sort"
                            defaultValue={sortMode}
                            className="ml-2 rounded-md border border-gray-300 bg-white px-2 py-1 text-sm"
                        >
                            <option value="created">Newest first</option>
                            <option value="status">By status</option>
                        </select>
                    </label>
                    <button
                        type="submit"
                        className="rounded-md border border-blue-200 bg-blue-50 px-3 py-1 text-sm font-semibold text-blue-700 hover:bg-blue-100"
                    >
                        Apply
                    </button>
                </form>
            )}
            {!hasStatusColumn && (
                <div className="rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800">
                    Bug report statuses are disabled because the <code>status</code> column is missing.
                    Run <code>docs/migrations/017_bug_report_status.sql</code> to enable it.
                </div>
            )}

            <div className="bg-white rounded-lg shadow overflow-hidden">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Reported By
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Route
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Description
                            </th>
                            {hasStatusColumn && (
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                            )}
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Screenshot
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Created
                            </th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {safeReports.length > 0 ? (
                            safeReports.map((report) => (
                                <tr key={report.id} className="hover:bg-gray-50">
                                    <td className="px-6 py-4 text-sm text-gray-700">
                                        <div className="font-medium text-gray-900">
                                            {report.user_id ? (userEmailMap[report.user_id] ?? report.user_id) : 'Unknown'}
                                        </div>
                                        {report.user_id && userEmailMap[report.user_id] !== report.user_id && (
                                            <div className="text-xs text-gray-500">{report.user_id}</div>
                                        )}
                                    </td>
                                    <td className="px-6 py-4 text-sm text-gray-600">
                                        {report.route || '—'}
                                    </td>
                                    <td className="px-6 py-4 text-sm text-gray-700">
                                        <details className="max-w-xl">
                                            <summary className="cursor-pointer text-xs text-blue-600">View full description</summary>
                                            <p className="mt-2 whitespace-pre-wrap text-sm text-gray-700">
                                                {report.description}
                                            </p>
                                        </details>
                                        {report.meta && (
                                            <details className="mt-2 text-xs text-gray-500">
                                                <summary className="cursor-pointer">View metadata</summary>
                                                <pre className="mt-2 whitespace-pre-wrap">{JSON.stringify(report.meta, null, 2)}</pre>
                                            </details>
                                        )}
                                    </td>
                                    {hasStatusColumn && (
                                        <td className="px-6 py-4 text-sm text-gray-700">
                                            <BugReportStatusSelect reportId={report.id} status={report.status} />
                                        </td>
                                    )}
                                    <td className="px-6 py-4 text-sm">
                                        {signedUrlMap[report.id] ? (
                                            <a
                                                className="text-blue-600 hover:text-blue-900 hover:underline"
                                                href={signedUrlMap[report.id]}
                                                target="_blank"
                                                rel="noreferrer"
                                            >
                                                View
                                            </a>
                                        ) : (
                                            <span className="text-gray-400">—</span>
                                        )}
                                    </td>
                                    <td className="px-6 py-4 text-sm text-gray-500">
                                        {new Date(report.created_at).toLocaleString()}
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan={hasStatusColumn ? 6 : 5} className="px-6 py-8 text-center text-gray-500">
                                    No bug reports yet.
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
}
````

## File: src/app/admin/papers/[paperId]/preview/page.tsx
````typescript
/**
 * @fileoverview Admin Paper Preview Page
 * @description Preview the exam as a student would see it (read-only mode)
 * @blueprint Admin can test paper view without creating an attempt
 */

import 'server-only';

import { notFound, redirect } from 'next/navigation';
import { sbSSR } from '@/lib/supabase/server';
import { createClient } from '@supabase/supabase-js';
import { PreviewClient } from './PreviewClient';
import type { Paper, QuestionSetComplete, SectionName, QuestionSetType, ContentLayoutType, Question, QuestionType } from '@/types/exam';
import { assemblePaper } from '@/features/exam-engine/lib/assemblePaper';

interface PageProps {
    params: Promise<{ paperId: string }>;
}

function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin preview requires service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

export default async function AdminPaperPreviewPage({ params }: PageProps) {
    const { paperId } = await params;
    const supabase = await sbSSR();

    // Server-side admin verification
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/auth/sign-in');
    }

    const { data: { session } } = await supabase.auth.getSession();
    let role: string | null = session?.user?.app_metadata?.user_role ?? null;

    if (!role && session?.access_token) {
        try {
            const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                user_role?: string;
                app_metadata?: { user_role?: string };
            };
            role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
        } catch {
            role = null;
        }
    }

    let isAdmin = role === 'admin' || role === 'dev';

    if (!isAdmin) {
        const { data: isAdminRpc, error: rpcError } = await supabase.rpc('is_admin');
        isAdmin = !rpcError && Boolean(isAdminRpc);
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    // Fetch paper
    const adminClient = getAdminClient();
    const { data: paperData, error: paperError } = await adminClient
        .from('papers')
        .select('*')
        .eq('id', paperId)
        .single();

    if (paperError || !paperData) {
        notFound();
    }

    // Fetch question sets with questions
    const { data: questionSetsView } = await adminClient
        .from('question_sets_with_questions')
        .select('*')
        .eq('paper_id', paperId)
        .order('section', { ascending: true })
        .order('display_order', { ascending: true });

    // Transform to QuestionSetComplete
    const rawQuestionSets: QuestionSetComplete[] = (questionSetsView ?? []).map((row) => ({
        id: row.id,
        paper_id: row.paper_id,
        section: row.section as SectionName,
        set_type: row.set_type as QuestionSetType,
        content_layout: row.content_layout as ContentLayoutType,
        context_title: row.context_title ?? undefined,
        context_body: row.context_body ?? undefined,
        context_image_url: row.context_image_url ?? undefined,
        context_additional_images: Array.isArray(row.context_additional_images)
            ? (row.context_additional_images as QuestionSetComplete['context_additional_images'])
            : [],
        display_order: row.display_order,
        question_count: row.question_count,
        metadata: row.metadata ?? {},
        is_active: row.is_active,
        is_published: row.is_published,
        created_at: row.created_at,
        updated_at: row.updated_at,
        questions: (row.questions ?? []).map((q: {
            id: string;
            question_text: string;
            question_type: string;
            options: unknown;
            positive_marks: number;
            negative_marks: number;
            question_number: number;
            sequence_order: number | null;
            question_image_url?: string | null;
            difficulty?: string | null;
            topic?: string | null;
            subtopic?: string | null;
            is_active: boolean;
        }, index: number) => ({
            id: q.id,
            set_id: row.id,
            paper_id: row.paper_id,
            section: row.section as SectionName,
            sequence_order: q.sequence_order ?? index + 1,
            question_number: q.question_number,
            question_text: q.question_text,
            question_type: q.question_type as QuestionType,
            options: q.options as Question['options'],
            positive_marks: q.positive_marks,
            negative_marks: q.negative_marks,
            question_image_url: q.question_image_url ?? undefined,
            difficulty: q.difficulty as Question['difficulty'],
            topic: q.topic ?? undefined,
            subtopic: q.subtopic ?? undefined,
            is_active: q.is_active,
        })),
    }));

    const { questionSets } = assemblePaper(rawQuestionSets);

    if (process.env.NODE_ENV !== 'production') {
        const seen = new Set<string>();
        const duplicates = new Set<string>();
        const mismatches: Array<{ setId: string; questionId: string }> = [];

        questionSets.forEach((set) => {
            set.questions.forEach((q) => {
                if (seen.has(q.id)) {
                    duplicates.add(q.id);
                } else {
                    seen.add(q.id);
                }

                if (q.section !== set.section || q.set_id !== set.id) {
                    mismatches.push({ setId: set.id, questionId: q.id });
                }
            });
        });

        if (duplicates.size > 0) {
            console.warn('[PreviewPage] Detected duplicate question ids in assembled question list', {
                duplicateIds: Array.from(duplicates),
            });
        }

        if (mismatches.length > 0) {
            console.warn('[PreviewPage] Navigation state invalid (section/q/set mismatch)', {
                mismatchCount: mismatches.length,
                sample: mismatches.slice(0, 5),
            });
        }
    }

    // Transform paper data
    const paper: Paper = {
        id: paperData.id,
        slug: paperData.slug,
        title: paperData.title,
        description: paperData.description ?? undefined,
        year: paperData.year,
        total_questions: paperData.total_questions,
        total_marks: paperData.total_marks,
        duration_minutes: paperData.duration_minutes,
        sections: paperData.sections,
        default_positive_marks: paperData.default_positive_marks,
        default_negative_marks: paperData.default_negative_marks,
        published: paperData.published,
        available_from: paperData.available_from ?? undefined,
        available_until: paperData.available_until ?? undefined,
        difficulty_level: paperData.difficulty_level as Paper['difficulty_level'],
        is_free: paperData.is_free,
        attempt_limit: paperData.attempt_limit ?? undefined,
        created_at: paperData.created_at,
        updated_at: paperData.updated_at,
    };

    return (
        <PreviewClient
            paper={paper}
            questionSets={questionSets}
        />
    );
}
````

## File: src/app/admin/papers/[paperId]/preview/PreviewClient.tsx
````typescript
/**
 * @fileoverview Admin Paper Preview Client
 * @description Client component for previewing exam as a student would see it
 */

'use client';

import { useState, useMemo, useCallback, useEffect, useRef } from 'react';
import Link from 'next/link';
import type { Paper, QuestionSetComplete, SectionName, Question } from '@/types/exam';
import { QuestionRenderer } from '@/features/exam-engine/ui/QuestionRenderer';
import { assemblePaper } from '@/features/exam-engine/lib/assemblePaper';

interface PreviewClientProps {
    paper: Paper;
    questionSets: QuestionSetComplete[];
}

// Get questions for a section
function getQuestionsForSection(sets: QuestionSetComplete[], section: SectionName): QuestionSetComplete[] {
    return sets.filter(s => s.section === section).sort((a, b) => a.display_order - b.display_order);
}

// Section order
const SECTIONS: SectionName[] = ['VARC', 'DILR', 'QA'];

const parseSection = (value: string | null): SectionName | undefined => {
    if (!value) return undefined;
    return SECTIONS.includes(value as SectionName) ? (value as SectionName) : undefined;
};

interface PreviewNavState {
    section: SectionName;
    setIndex: number;
    questionIndex: number;
}

const DEFAULT_NAV_STATE: PreviewNavState = {
    section: 'VARC',
    setIndex: 0,
    questionIndex: 0,
};

export function PreviewClient({ paper, questionSets }: PreviewClientProps) {
    const STORAGE_KEY = `paper:${paper.id}:previewNav`;

    const [navState, setNavState] = useState<PreviewNavState>(DEFAULT_NAV_STATE);
    const hasInitializedRef = useRef(false);
    const containerRef = useRef<HTMLDivElement>(null);
    const [isFullscreen, setIsFullscreen] = useState(false);

    const { section: currentSection, setIndex: currentSetIndex, questionIndex: currentQuestionIndex } = navState;

    const updateNavState = useCallback((updates: Partial<PreviewNavState>) => {
        setNavState(prev => ({ ...prev, ...updates }));
    }, []);

    useEffect(() => {
        if (typeof window === 'undefined') return;

        const resolveNavigation = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const urlSection = parseSection(urlParams.get('section'));
            const urlSetIndex = urlParams.get('set') ? Number(urlParams.get('set')) : undefined;
            const urlQIndex = urlParams.get('q') ? Number(urlParams.get('q')) : undefined;

            if (urlSection !== undefined) {
                setNavState({
                    section: urlSection,
                    setIndex: Number.isFinite(urlSetIndex) && urlSetIndex! >= 0 ? urlSetIndex! : 0,
                    questionIndex: Number.isFinite(urlQIndex) && urlQIndex! >= 0 ? urlQIndex! : 0,
                });
                hasInitializedRef.current = true;
                return;
            }

            const storedRaw = window.localStorage.getItem(STORAGE_KEY);
            if (storedRaw) {
                try {
                    const stored = JSON.parse(storedRaw) as PreviewNavState;
                    if (stored.section && SECTIONS.includes(stored.section)) {
                        setNavState({
                            section: stored.section,
                            setIndex: Number.isFinite(stored.setIndex) && stored.setIndex >= 0 ? stored.setIndex : 0,
                            questionIndex: Number.isFinite(stored.questionIndex) && stored.questionIndex >= 0 ? stored.questionIndex : 0,
                        });
                        hasInitializedRef.current = true;
                        return;
                    }
                } catch {
                    window.localStorage.removeItem(STORAGE_KEY);
                }
            }

            setNavState(DEFAULT_NAV_STATE);
            hasInitializedRef.current = true;
        };

        resolveNavigation();

        const handlePopState = () => resolveNavigation();
        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
    }, [STORAGE_KEY]);

    useEffect(() => {
        if (typeof window === 'undefined') return;
        if (!hasInitializedRef.current) return;

        // Save to localStorage
        window.localStorage.setItem(STORAGE_KEY, JSON.stringify(navState));

        // Update URL only if needed to avoid router churn
        const url = new URL(window.location.href);
        const desiredSection = navState.section;
        const desiredSet = String(navState.setIndex);
        const desiredQ = String(navState.questionIndex);

        if (
            url.searchParams.get('section') !== desiredSection ||
            url.searchParams.get('set') !== desiredSet ||
            url.searchParams.get('q') !== desiredQ
        ) {
            url.searchParams.set('section', desiredSection);
            url.searchParams.set('set', desiredSet);
            url.searchParams.set('q', desiredQ);
            window.history.replaceState({}, '', url.toString());
        }
    }, [STORAGE_KEY, navState]);

    const assembled = useMemo(() => assemblePaper(questionSets), [questionSets]);
    const assembledSets = assembled.questionSets;

    // Get sets for current section
    const sectionSets = useMemo(
        () => getQuestionsForSection(assembledSets, currentSection),
        [assembledSets, currentSection]
    );

    // Current set
    const currentSet = sectionSets[currentSetIndex];

    // All questions for counting
    const allQuestions = assembled.questions;

    // Section counts
    const sectionCounts = useMemo(() => {
        const counts: Record<SectionName, number> = { VARC: 0, DILR: 0, QA: 0 };
        assembledSets.forEach(set => {
            counts[set.section] += set.questions.length;
        });
        return counts;
    }, [assembledSets]);

    // Handle section change
    const handleSectionChange = useCallback((section: SectionName) => {
        updateNavState({ section, setIndex: 0, questionIndex: 0 });
    }, [updateNavState]);

    // Handle navigation within section
    const handleNextQuestion = useCallback(() => {
        if (!currentSet) return;

        if (currentQuestionIndex < currentSet.questions.length - 1) {
            // Next question in same set
            updateNavState({ questionIndex: currentQuestionIndex + 1 });
        } else if (currentSetIndex < sectionSets.length - 1) {
            // Next set
            updateNavState({ setIndex: currentSetIndex + 1, questionIndex: 0 });
        }
    }, [currentSet, currentQuestionIndex, currentSetIndex, sectionSets.length, updateNavState]);

    const handlePrevQuestion = useCallback(() => {
        if (currentQuestionIndex > 0) {
            // Previous question in same set
            updateNavState({ questionIndex: currentQuestionIndex - 1 });
        } else if (currentSetIndex > 0) {
            // Previous set
            const prevSet = sectionSets[currentSetIndex - 1];
            updateNavState({ setIndex: currentSetIndex - 1, questionIndex: prevSet.questions.length - 1 });
        }
    }, [currentQuestionIndex, currentSetIndex, sectionSets, updateNavState]);

    // Calculate global question number
    const globalQuestionNumber = useMemo(() => {
        let count = 0;
        for (let i = 0; i < currentSetIndex; i++) {
            count += sectionSets[i].questions.length;
        }
        return count + currentQuestionIndex + 1;
    }, [currentSetIndex, currentQuestionIndex, sectionSets]);

    const totalSectionQuestions = sectionCounts[currentSection];

    // Fullscreen toggle handler
    const toggleFullscreen = useCallback(() => {
        if (!containerRef.current) return;
        if (!document.fullscreenElement) {
            containerRef.current.requestFullscreen().catch(err => {
                console.error('Failed to enter fullscreen:', err);
            });
        } else {
            document.exitFullscreen().catch(err => {
                console.error('Failed to exit fullscreen:', err);
            });
        }
    }, []);

    // Listen for fullscreen changes
    useEffect(() => {
        const handleFullscreenChange = () => {
            setIsFullscreen(!!document.fullscreenElement);
        };
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        return () => document.removeEventListener('fullscreenchange', handleFullscreenChange);
    }, []);

    useEffect(() => {
        if (process.env.NODE_ENV === 'production') {
            return;
        }

        const seen = new Set<string>();
        const duplicates = new Set<string>();
        allQuestions.forEach((q: Question) => {
            if (seen.has(q.id)) {
                duplicates.add(q.id);
            } else {
                seen.add(q.id);
            }
        });

        if (duplicates.size > 0) {
            console.warn('[Preview] Detected duplicate question ids in assembled question list', {
                duplicateIds: Array.from(duplicates),
                totalQuestions: allQuestions.length,
            });
        }
    }, [allQuestions]);

    useEffect(() => {
        if (process.env.NODE_ENV === 'production') {
            return;
        }

        if (!currentSet && (currentSetIndex !== 0 || currentQuestionIndex !== 0)) {
            console.warn('[Preview] Navigation state invalid (section/q/set mismatch)', {
                section: currentSection,
                setIndex: currentSetIndex,
                questionIndex: currentQuestionIndex,
                sectionSetCount: sectionSets.length,
            });
            return;
        }

        if (currentSet && currentQuestionIndex >= currentSet.questions.length) {
            console.warn('[Preview] Navigation state invalid (section/q/set mismatch)', {
                section: currentSection,
                setIndex: currentSetIndex,
                questionIndex: currentQuestionIndex,
                questionsInSet: currentSet.questions.length,
            });
        }
    }, [currentSection, currentSet, currentSetIndex, currentQuestionIndex, sectionSets.length]);

    return (
        <div ref={containerRef} className="min-h-screen bg-exam-bg-page flex flex-col">
            {/* Preview Header Banner */}
            <div className={`bg-yellow-400 text-yellow-900 px-4 py-2 text-center font-semibold flex items-center justify-center gap-4 ${isFullscreen ? 'hidden' : ''}`}>
                <span>🔍 ADMIN PREVIEW MODE - This is how students will see the exam</span>
                <Link
                    href={`/admin/papers/${paper.id}/edit`}
                    className="px-3 py-1 bg-yellow-600 text-white rounded text-sm hover:bg-yellow-700 transition-colors"
                >
                    Back to Editor
                </Link>
                <Link
                    href="/admin/papers"
                    className="px-3 py-1 bg-gray-700 text-white rounded text-sm hover:bg-gray-800 transition-colors"
                >
                    All Papers
                </Link>
                <button
                    onClick={toggleFullscreen}
                    className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors"
                    title="Toggle fullscreen to see exact mock layout"
                >
                    ⛶ Fullscreen
                </button>
            </div>

            {/* Exam Header */}
            <header className="h-12 bg-gradient-to-r from-exam-header-from to-exam-header-to flex items-center justify-between px-4 text-white shadow-sm">
                <div className="flex items-center gap-4">
                    <h1 className="text-sm font-semibold">{paper.title}</h1>
                    <span className="text-xs opacity-80">
                        (Preview - {allQuestions.length} questions)
                    </span>
                </div>
                <div className="flex items-center gap-4 text-sm">
                    <button
                        onClick={toggleFullscreen}
                        className="px-2 py-1 bg-white/10 hover:bg-white/20 rounded transition-colors"
                        title={isFullscreen ? 'Exit fullscreen' : 'Enter fullscreen'}
                    >
                        {isFullscreen ? '✕ Exit Fullscreen' : '⛶ Fullscreen'}
                    </button>
                    <span className="opacity-80">|</span>
                    <span className="opacity-80">Duration: {paper.duration_minutes} mins</span>
                    <span className="opacity-80">|</span>
                    <span className="opacity-80">Total Marks: {paper.total_marks}</span>
                </div>
            </header>

            {/* Section Tabs */}
            <div className="bg-white border-b border-exam-bg-border flex">
                {SECTIONS.map((section) => (
                    <button
                        key={section}
                        onClick={() => handleSectionChange(section)}
                        className={`
                            px-6 py-3 text-sm font-medium transition-colors border-b-2
                            ${currentSection === section
                                ? 'border-blue-600 text-blue-600 bg-blue-50'
                                : 'border-transparent text-gray-600 hover:text-gray-800 hover:bg-gray-50'
                            }
                        `}
                    >
                        {section} ({sectionCounts[section]})
                    </button>
                ))}
            </div>

            {/* Main Content */}
            <div className="flex-1 flex overflow-hidden">
                {/* Question Area */}
                <div className="flex-1 grid grid-cols-2 overflow-hidden">
                    {currentSet ? (
                        <QuestionRenderer
                            questionSet={currentSet}
                            activeQuestionIndex={currentQuestionIndex}
                            onQuestionChange={(qIdx) => updateNavState({ questionIndex: qIdx })}
                            responses={{}}
                            onAnswerChange={() => { }}
                            isReviewMode={true}
                        />
                    ) : (
                        <div className="col-span-2 flex items-center justify-center text-gray-500">
                            No questions in this section
                        </div>
                    )}
                </div>

                {/* Question Navigator Sidebar */}
                <aside className="w-72 border-l border-exam-bg-border bg-slate-50 overflow-y-auto">
                    <div className="p-4">
                        <h3 className="font-semibold text-gray-700 mb-3">Question Navigator</h3>
                        <div className="grid grid-cols-5 gap-2">
                            {sectionSets.flatMap((set, setIdx) =>
                                set.questions.map((q, qIdx) => {
                                    const isActive = setIdx === currentSetIndex && qIdx === currentQuestionIndex;
                                    return (
                                        <button
                                            key={q.id}
                                            onClick={() => {
                                                updateNavState({ setIndex: setIdx, questionIndex: qIdx });
                                            }}
                                            className={`
                                                w-10 h-10 rounded text-sm font-medium transition-colors
                                                ${isActive
                                                    ? 'bg-blue-600 text-white ring-2 ring-offset-1 ring-blue-400'
                                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }
                                            `}
                                        >
                                            {q.question_number}
                                        </button>
                                    );
                                })
                            )}
                        </div>

                        {/* Set Info */}
                        {currentSet && (
                            <div className="mt-6 p-3 bg-white rounded border border-gray-200">
                                <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">Current Set</h4>
                                <p className="text-sm text-gray-700">
                                    Type: <span className="font-medium">{currentSet.set_type}</span>
                                </p>
                                <p className="text-sm text-gray-700">
                                    Questions: <span className="font-medium">{currentSet.questions.length}</span>
                                </p>
                                {currentSet.context_title && (
                                    <p className="text-sm text-gray-700 truncate">
                                        Title: <span className="font-medium">{currentSet.context_title}</span>
                                    </p>
                                )}
                            </div>
                        )}
                    </div>
                </aside>
            </div>

            {/* Footer Navigation */}
            <footer className="h-16 bg-white border-t border-exam-bg-border flex items-center justify-between px-6">
                <button
                    onClick={handlePrevQuestion}
                    disabled={currentSetIndex === 0 && currentQuestionIndex === 0}
                    className="px-4 py-2 rounded border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                    ← Previous
                </button>

                <div className="text-sm text-gray-600">
                    Question {globalQuestionNumber} of {totalSectionQuestions} in {currentSection}
                </div>

                <button
                    onClick={handleNextQuestion}
                    disabled={
                        currentSetIndex === sectionSets.length - 1 &&
                        currentSet && currentQuestionIndex === currentSet.questions.length - 1
                    }
                    className="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                    Next →
                </button>
            </footer>
        </div>
    );
}
````

## File: src/app/admin/papers/[paperId]/settings/page.tsx
````typescript
/**
 * @fileoverview Paper Settings Page
 * @description Admin page for paper-specific settings
 */

import 'server-only';

import Link from 'next/link';
import { notFound, redirect } from 'next/navigation';
import { revalidatePath } from 'next/cache';
import { sbSSR } from '@/lib/supabase/server';
import { updatePaper } from '../edit/actions';

interface PageProps {
    params: Promise<{ paperId: string }>;
}

function toDateTimeLocal(value?: string | null): string {
    if (!value) return '';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return '';
    return date.toISOString().slice(0, 16);
}

export default async function PaperSettingsPage({ params }: PageProps) {
    const { paperId } = await params;
    const supabase = await sbSSR();

    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/auth/sign-in');
    }

    const { data: { session } } = await supabase.auth.getSession();
    let role: string | null = session?.user?.app_metadata?.user_role ?? null;

    if (!role && session?.access_token) {
        try {
            const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                user_role?: string;
                app_metadata?: { user_role?: string };
            };
            role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
        } catch {
            role = null;
        }
    }

    let isAdmin = role === 'admin' || role === 'dev';
    if (!isAdmin) {
        const { data: isAdminRpc, error: rpcError } = await supabase.rpc('is_admin');
        isAdmin = !rpcError && Boolean(isAdminRpc);
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    const { data: paper, error: paperError } = await supabase
        .from('papers')
        .select('*')
        .eq('id', paperId)
        .single();

    if (paperError || !paper) {
        notFound();
    }

    async function updatePaperSettings(formData: FormData) {
        'use server';

        const published = formData.get('published') === 'on';
        const isFree = formData.get('is_free') === 'on';
        const attemptLimitRaw = formData.get('attempt_limit');
        const attemptLimit = attemptLimitRaw ? Number(attemptLimitRaw) : undefined;
        const normalizedAttemptLimit = Number.isFinite(attemptLimit as number) ? attemptLimit : undefined;
        const availableFrom = formData.get('available_from') as string | null;
        const availableUntil = formData.get('available_until') as string | null;

        const result = await updatePaper(paperId, {
            published,
            is_free: isFree,
            attempt_limit: normalizedAttemptLimit,
            available_from: availableFrom || undefined,
            available_until: availableUntil || undefined,
        });

        if (!result.success) {
            throw new Error(result.error || 'Failed to update paper');
        }

        revalidatePath(`/admin/papers/${paperId}/settings`);
    }

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-bold text-gray-900">Paper Settings</h1>
                    <p className="text-sm text-gray-500">{paper.title}</p>
                </div>
                <div className="flex items-center gap-2">
                    <Link
                        href={`/admin/papers/${paperId}/edit`}
                        className="px-3 py-2 text-sm rounded-md bg-indigo-600 text-white hover:bg-indigo-700"
                    >
                        Live Edit
                    </Link>
                    <Link
                        href={`/admin/papers/${paperId}/questions`}
                        className="px-3 py-2 text-sm rounded-md bg-emerald-600 text-white hover:bg-emerald-700"
                    >
                        Questions
                    </Link>
                </div>
            </div>

            <form action={updatePaperSettings} className="bg-white rounded-lg border border-gray-200 p-6 space-y-4">
                <div className="flex items-center gap-3">
                    <input id="published" name="published" type="checkbox" defaultChecked={paper.published} />
                    <label htmlFor="published" className="text-sm text-gray-700">Published</label>
                </div>

                <div className="flex items-center gap-3">
                    <input id="is_free" name="is_free" type="checkbox" defaultChecked={paper.is_free} />
                    <label htmlFor="is_free" className="text-sm text-gray-700">Free access</label>
                </div>

                <div>
                    <label htmlFor="attempt_limit" className="block text-sm text-gray-700 mb-1">Attempt limit (optional)</label>
                    <input
                        id="attempt_limit"
                        name="attempt_limit"
                        type="number"
                        min={0}
                        defaultValue={paper.attempt_limit ?? ''}
                        className="w-full max-w-xs border border-gray-300 rounded px-3 py-2 text-sm"
                    />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label htmlFor="available_from" className="block text-sm text-gray-700 mb-1">Available from</label>
                        <input
                            id="available_from"
                            name="available_from"
                            type="datetime-local"
                            defaultValue={toDateTimeLocal(paper.available_from)}
                            className="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                        />
                    </div>
                    <div>
                        <label htmlFor="available_until" className="block text-sm text-gray-700 mb-1">Available until</label>
                        <input
                            id="available_until"
                            name="available_until"
                            type="datetime-local"
                            defaultValue={toDateTimeLocal(paper.available_until)}
                            className="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                        />
                    </div>
                </div>

                <div className="flex justify-end">
                    <button
                        type="submit"
                        className="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700"
                    >
                        Save Settings
                    </button>
                </div>
            </form>
        </div>
    );
}
````

## File: src/app/admin/papers/new/page.tsx
````typescript
/**
 * @fileoverview New Paper Form
 * @description Admin page to create a new paper
 */

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { sb } from '@/lib/supabase/client';
import { adminLogger } from '@/lib/logger';

export default function NewPaperPage() {
    const router = useRouter();
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const [formData, setFormData] = useState({
        title: '',
        slug: '',
        description: '',
        year: new Date().getFullYear(),
        duration_minutes: 120,
        total_questions: 66,
        total_marks: 198,
        default_positive_marks: 3,
        default_negative_marks: 1,
        difficulty_level: 'cat-level',
        published: false,
    });

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        const { name, value, type } = e.target;
        setFormData((prev) => ({
            ...prev,
            [name]: type === 'checkbox'
                ? (e.target as HTMLInputElement).checked
                : type === 'number'
                    ? Number(value)
                    : value,
        }));
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            const supabase = sb();

            // Generate slug from title if not provided
            const rawSlug = formData.slug || formData.title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            const slug = rawSlug.trim();
            const slugRegex = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;

            if (!slugRegex.test(slug)) {
                setError('Invalid slug. Use lowercase letters, numbers, and hyphens only (no spaces).');
                setLoading(false);
                return;
            }

            if (slug.length > 64) {
                setError('Slug is too long. Maximum length is 64 characters.');
                setLoading(false);
                return;
            }

            const { data: existingSlug } = await supabase
                .from('papers')
                .select('id')
                .eq('slug', slug)
                .maybeSingle();

            if (existingSlug) {
                setError('Slug already exists. Please choose a unique slug.');
                setLoading(false);
                return;
            }

            // Default CAT sections configuration
            const sections = [
                { name: 'VARC', questions: 24, time: 40, marks: 72 },
                { name: 'DILR', questions: 20, time: 40, marks: 60 },
                { name: 'QA', questions: 22, time: 40, marks: 66 },
            ];

            const { data, error: insertError } = await supabase
                .from('papers')
                .insert({
                    ...formData,
                    slug,
                    sections,
                })
                .select()
                .single();

            if (insertError) throw insertError;

            router.push(`/admin/papers/${data.id}/edit`);
        } catch (err: unknown) {
            adminLogger.dataModified('papers', 'create_error', { error: err });
            setError(err instanceof Error ? err.message : 'Failed to create paper');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="max-w-3xl mx-auto">
            <h1 className="text-2xl font-bold text-gray-900 mb-6">Create New Paper</h1>

            <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow p-6 space-y-6">
                {error && (
                    <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                        {error}
                    </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="md:col-span-2">
                        <label htmlFor="title" className="block text-sm font-medium text-gray-700 mb-1">
                            Title *
                        </label>
                        <input
                            type="text"
                            id="title"
                            name="title"
                            value={formData.title}
                            onChange={handleChange}
                            required
                            placeholder="e.g., CAT 2024 Slot 1"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <div>
                        <label htmlFor="slug" className="block text-sm font-medium text-gray-700 mb-1">
                            Slug (URL-friendly ID)
                        </label>
                        <input
                            type="text"
                            id="slug"
                            name="slug"
                            value={formData.slug}
                            onChange={handleChange}
                            placeholder="e.g., cat-2024-slot-1"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <p className="mt-1 text-xs text-gray-500">Leave empty to auto-generate from title</p>
                    </div>

                    <div>
                        <label htmlFor="year" className="block text-sm font-medium text-gray-700 mb-1">
                            Year *
                        </label>
                        <input
                            type="number"
                            id="year"
                            name="year"
                            value={formData.year}
                            onChange={handleChange}
                            required
                            min={2000}
                            max={2100}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <div className="md:col-span-2">
                        <label htmlFor="description" className="block text-sm font-medium text-gray-700 mb-1">
                            Description
                        </label>
                        <textarea
                            id="description"
                            name="description"
                            value={formData.description}
                            onChange={handleChange}
                            rows={3}
                            placeholder="Brief description of the paper..."
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <div>
                        <label htmlFor="duration_minutes" className="block text-sm font-medium text-gray-700 mb-1">
                            Duration (minutes)
                        </label>
                        <input
                            type="number"
                            id="duration_minutes"
                            name="duration_minutes"
                            value={formData.duration_minutes}
                            onChange={handleChange}
                            min={1}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <div>
                        <label htmlFor="total_questions" className="block text-sm font-medium text-gray-700 mb-1">
                            Total Questions
                        </label>
                        <input
                            type="number"
                            id="total_questions"
                            name="total_questions"
                            value={formData.total_questions}
                            onChange={handleChange}
                            min={1}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <div>
                        <label htmlFor="total_marks" className="block text-sm font-medium text-gray-700 mb-1">
                            Total Marks
                        </label>
                        <input
                            type="number"
                            id="total_marks"
                            name="total_marks"
                            value={formData.total_marks}
                            onChange={handleChange}
                            min={1}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <div>
                        <label htmlFor="difficulty_level" className="block text-sm font-medium text-gray-700 mb-1">
                            Difficulty Level
                        </label>
                        <select
                            id="difficulty_level"
                            name="difficulty_level"
                            value={formData.difficulty_level}
                            onChange={handleChange}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                            <option value="cat-level">CAT Level</option>
                        </select>
                    </div>

                    <div>
                        <label htmlFor="default_positive_marks" className="block text-sm font-medium text-gray-700 mb-1">
                            Default Positive Marks
                        </label>
                        <input
                            type="number"
                            id="default_positive_marks"
                            name="default_positive_marks"
                            value={formData.default_positive_marks}
                            onChange={handleChange}
                            min={0}
                            step={0.5}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <div>
                        <label htmlFor="default_negative_marks" className="block text-sm font-medium text-gray-700 mb-1">
                            Default Negative Marks
                        </label>
                        <input
                            type="number"
                            id="default_negative_marks"
                            name="default_negative_marks"
                            value={formData.default_negative_marks}
                            onChange={handleChange}
                            min={0}
                            step={0.5}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <div className="md:col-span-2">
                        <label className="flex items-center gap-2">
                            <input
                                type="checkbox"
                                name="published"
                                checked={formData.published}
                                onChange={handleChange}
                                className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                            />
                            <span className="text-sm font-medium text-gray-700">Publish immediately</span>
                        </label>
                        <p className="mt-1 text-xs text-gray-500">Only published papers are visible to students</p>
                    </div>
                </div>

                <div className="flex justify-end gap-4 pt-4 border-t">
                    <button
                        type="button"
                        onClick={() => router.back()}
                        className="px-4 py-2 text-gray-700 hover:text-gray-900"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        disabled={loading}
                        className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
                    >
                        {loading ? 'Creating...' : 'Create Paper'}
                    </button>
                </div>
            </form>
        </div>
    );
}
````

## File: src/app/admin/questions/actions.ts
````typescript
'use server';

import 'server-only';

/**
 * @fileoverview Admin Server Actions for Question Management
 * @description Uses service role key to bypass RLS for admin operations
 */

import { createClient } from '@supabase/supabase-js';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin operations require service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

async function createActionClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string;
    const cookieStore = await cookies();

    return createServerClient(url, anon, {
        cookies: {
            getAll() {
                return cookieStore.getAll();
            },
            setAll(cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options }) =>
                        cookieStore.set(name, value, options)
                    );
                } catch {
                    // Ignore - cookies can't be set in server actions during render
                }
            },
        },
    });
}

async function verifyAdmin(): Promise<void> {
    const supabase = await createActionClient();
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error || !user) {
        throw new Error('Not authenticated');
    }

    const skipAdminCheck = process.env.SKIP_ADMIN_CHECK === 'true' && process.env.NODE_ENV !== 'production';
    if (!skipAdminCheck) {
        const { data: { session } } = await supabase.auth.getSession();
        let role: string | null = session?.user?.app_metadata?.user_role ?? null;

        if (!role && session?.access_token) {
            try {
                const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                    user_role?: string;
                    app_metadata?: { user_role?: string };
                };
                role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
            } catch {
                role = null;
            }
        }

        if (role !== 'admin' && role !== 'dev') {
            const { data: isAdmin, error: rpcError } = await supabase.rpc('is_admin');
            if (rpcError || !isAdmin) {
                throw new Error('Unauthorized: Admin access required');
            }
        }
    }
}

export async function deleteQuestion(questionId: string): Promise<{ success: boolean; error?: string }> {
    try {
        if (!questionId) {
            return { success: false, error: 'Question id is required.' };
        }

        await verifyAdmin();
        const adminClient = getAdminClient();

        const { error } = await adminClient
            .from('questions')
            .update({
                is_active: false,
                updated_at: new Date().toISOString(),
            })
            .eq('id', questionId);

        if (error) {
            return { success: false, error: error.message || 'Failed to delete question' };
        }

        return { success: true };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        return { success: false, error: message };
    }
}
````

## File: src/app/api/admin/papers/[paperId]/export/route.ts
````typescript
/**
 * @fileoverview Paper Export API Endpoint
 * @description Admin-only endpoint to export paper JSON from Supabase
 * @route GET /api/admin/papers/[paperId]/export
 * 
 * Query Parameters:
 *   - run: (optional) specific ingest_run_id to export
 *   - version: (optional) specific version number to export
 *   - assembled: (optional) force assembly from current DB state
 *   - format: (optional) 'v3' for Schema v3.0 sets-first format (default: v1)
 * 
 * Response: JSON file download with paper data matching CONTENT-SCHEMA.md
 */

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

// Create admin client with service role key (bypasses RLS)
function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin operations require service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

// Create SSR client for auth verification
async function createActionClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string;
    const cookieStore = await cookies();

    return createServerClient(url, anon, {
        cookies: {
            getAll() {
                return cookieStore.getAll();
            },
            setAll(cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options }) =>
                        cookieStore.set(name, value, options)
                    );
                } catch {
                    // Ignore - cookies can't be set in server actions during render
                }
            },
        },
    });
}

// Verify the user is authenticated and is an admin
async function verifyAdmin(): Promise<{ userId: string; email: string }> {
    const supabase = await createActionClient();
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error || !user) {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
            return verifyAdminRole(supabase, session);
        }
        throw new Error('Not authenticated');
    }

    const { data: { session } } = await supabase.auth.getSession();
    return verifyAdminRole(supabase, session);
}

async function verifyAdminRole(supabase: ReturnType<typeof createServerClient>, session: { user: { id: string; email?: string }; access_token?: string } | null): Promise<{ userId: string; email: string }> {
    if (!session?.user) {
        throw new Error('Not authenticated');
    }

    const skipAdminCheck = process.env.SKIP_ADMIN_CHECK === 'true' && process.env.NODE_ENV !== 'production';
    if (!skipAdminCheck) {
        let role: string | null = (session.user as { app_metadata?: { user_role?: string } }).app_metadata?.user_role ?? null;

        if (!role && session.access_token) {
            try {
                const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                    user_role?: string;
                    app_metadata?: { user_role?: string };
                };
                role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
            } catch {
                role = null;
            }
        }

        if (role !== 'admin' && role !== 'dev') {
            const { data: isAdmin, error: rpcError } = await supabase.rpc('is_admin');
            if (rpcError || !isAdmin) {
                throw new Error('Unauthorized: Admin access required');
            }
        }
    }

    return { userId: session.user.id, email: session.user.email || '' };
}

export async function GET(
    req: NextRequest,
    { params }: { params: Promise<{ paperId: string }> }
) {
    try {
        // Verify admin access
        await verifyAdmin();

        const { paperId } = await params;
        if (!paperId) {
            return NextResponse.json({ error: 'Paper ID required' }, { status: 400 });
        }

        const adminClient = getAdminClient();
        const { searchParams } = new URL(req.url);

        // Get export options
        const runId = searchParams.get('run');
        const version = searchParams.get('version');
        const forceAssemble = searchParams.get('assembled') === 'true';
        const formatV3 = searchParams.get('format') === 'v3';

        let exportData: unknown;
        let filename: string;

        // V3 format export (sets-first) - for content creation context
        if (formatV3) {
            const { data, error } = await adminClient.rpc('export_paper_json_v3', {
                p_paper_id: paperId
            });

            if (error) {
                console.error('Export V3 RPC error:', error);
                // Fallback message if function doesn't exist yet
                if (error.message.includes('does not exist')) {
                    return NextResponse.json({
                        error: 'V3 export function not available. Apply migration 008 first.'
                    }, { status: 500 });
                }
                return NextResponse.json({ error: error.message }, { status: 500 });
            }

            exportData = data;

            // Get paper slug for filename
            const { data: paperData } = await adminClient
                .from('papers')
                .select('slug')
                .eq('id', paperId)
                .single();

            const slug = paperData?.slug || paperId;
            filename = `${slug}_v3.json`;
        } else if (forceAssemble) {
            // Force assembly from current database state
            const { data, error } = await adminClient.rpc('export_paper_json', {
                p_paper_id: paperId
            });

            if (error) {
                console.error('Export RPC error:', error);
                return NextResponse.json({ error: error.message }, { status: 500 });
            }

            exportData = data;
            filename = `paper_${paperId}_assembled.json`;
        } else if (runId) {
            // Export specific ingest run
            const { data, error } = await adminClient.rpc('export_paper_json_versioned', {
                p_paper_id: paperId,
                p_ingest_run_id: runId
            });

            if (error) {
                console.error('Export RPC error:', error);
                return NextResponse.json({ error: error.message }, { status: 500 });
            }

            exportData = data;
            filename = `paper_${paperId}_run_${runId}.json`;
        } else if (version) {
            // Export specific version number
            const { data: runData, error: runError } = await adminClient
                .from('paper_ingest_runs')
                .select('id')
                .eq('paper_id', paperId)
                .eq('version_number', parseInt(version, 10))
                .single();

            if (runError || !runData) {
                return NextResponse.json({ error: `Version ${version} not found` }, { status: 404 });
            }

            const { data, error } = await adminClient.rpc('export_paper_json_versioned', {
                p_paper_id: paperId,
                p_ingest_run_id: runData.id
            });

            if (error) {
                console.error('Export RPC error:', error);
                return NextResponse.json({ error: error.message }, { status: 500 });
            }

            exportData = data;
            filename = `paper_${paperId}_v${version}.json`;
        } else {
            // Default: use versioned export (prefers canonical snapshot)
            const { data, error } = await adminClient.rpc('export_paper_json_versioned', {
                p_paper_id: paperId,
                p_ingest_run_id: null
            });

            if (error) {
                console.error('Export RPC error:', error);
                return NextResponse.json({ error: error.message }, { status: 500 });
            }

            exportData = data;

            // Get paper slug for filename
            const { data: paperData } = await adminClient
                .from('papers')
                .select('slug')
                .eq('id', paperId)
                .single();

            const slug = paperData?.slug || paperId;
            filename = `${slug}.json`;
        }

        // Check for errors in the response
        if (exportData && typeof exportData === 'object' && 'error' in exportData) {
            return NextResponse.json(exportData, { status: 404 });
        }

        // Return as downloadable JSON file
        const jsonString = JSON.stringify(exportData, null, 2);

        return new NextResponse(jsonString, {
            status: 200,
            headers: {
                'Content-Type': 'application/json',
                'Content-Disposition': `attachment; filename="${filename}"`,
                'Cache-Control': 'no-store',
            },
        });

    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        console.error('Export error:', message);

        if (message.includes('Not authenticated') || message.includes('Unauthorized')) {
            return NextResponse.json({ error: message }, { status: 401 });
        }

        return NextResponse.json({ error: message }, { status: 500 });
    }
}
````

## File: src/app/api/admin/papers/import/route.ts
````typescript
import { NextRequest, NextResponse } from 'next/server';
import { sbSSR } from '@/lib/supabase/server';
import { createClient } from '@supabase/supabase-js';
import { createHash, randomUUID } from 'crypto';
import { logger } from '@/lib/logger';

// =============================================================================
// TYPES
// =============================================================================

interface PaperData {
    slug: string;
    title: string;
    description?: string;
    year?: number;
    total_questions?: number;
    total_marks?: number;
    duration_minutes?: number;
    sections?: string[];
    default_positive_marks?: number;
    default_negative_marks?: number;
    difficulty_level?: string;
    is_free?: boolean;
    published?: boolean;
    allow_pause?: boolean;
    attempt_limit?: number;
    paper_key?: string;
}

interface QuestionSet {
    client_set_id: string;
    section: string;
    set_type: string;
    context_type?: string;
    content_layout?: string;
    context_title?: string;
    context_body?: string;
    context_image_url?: string;
    context_additional_images?: unknown[];
    display_order: number;
    is_active?: boolean;
    metadata?: Record<string, unknown>;
}

interface Question {
    client_question_id: string;
    set_ref: string;
    section?: string;
    question_number: number;
    sequence_order: number;
    question_text: string;
    question_type: string;
    question_format?: string;
    taxonomy_type?: string;
    topic_tag?: string;
    difficulty_rationale?: string;
    options?: { id: string; text: string }[];
    correct_answer?: string;
    positive_marks?: number;
    negative_marks?: number;
    difficulty?: string;
    topic?: string;
    subtopic?: string;
    solution_text?: string;
    solution_image_url?: string;
    video_solution_url?: string;
}

interface V3ImportPayload {
    schema_version: string;
    paper: PaperData;
    question_sets: QuestionSet[];
    questions: Question[];
}

// =============================================================================
// VALIDATION (Matches import-paper-v3.mjs)
// =============================================================================

const VALID_SECTIONS = ['VARC', 'DILR', 'QA'];
const VALID_SET_TYPES = ['VARC', 'DILR', 'CASELET', 'ATOMIC'];
const VALID_QUESTION_TYPES = ['MCQ', 'TITA'];
const COMPOSITE_SET_TYPES = ['VARC', 'DILR', 'CASELET'];

class ValidationError extends Error {
    errors: string[];
    constructor(message: string, errors: string[] = []) {
        super(message);
        this.name = 'ValidationError';
        this.errors = errors;
    }
}

function validateV3Payload(data: V3ImportPayload): Set<string> {
    // Schema version check
    if (data.schema_version !== 'v3.0') {
        throw new ValidationError(
            `Schema version must be 'v3.0'. Got: ${data.schema_version || 'undefined'}`
        );
    }

    // Required root keys
    if (!data.paper) throw new ValidationError('Missing required root key: paper');
    if (!data.question_sets) throw new ValidationError('Missing required root key: question_sets');
    if (!data.questions) throw new ValidationError('Missing required root key: questions');

    // Validate paper
    const paperErrors: string[] = [];
    if (!data.paper.slug) paperErrors.push('paper.slug is required');
    if (!data.paper.title) paperErrors.push('paper.title is required');
    if (data.paper.slug && !/^[a-z0-9-]+$/.test(data.paper.slug)) {
        paperErrors.push(`paper.slug must be lowercase alphanumeric with hyphens: ${data.paper.slug}`);
    }
    if (paperErrors.length > 0) {
        throw new ValidationError('Paper validation failed', paperErrors);
    }

    // Validate question_sets
    const setErrors: string[] = [];
    const clientSetIds = new Set<string>();

    data.question_sets.forEach((set, index) => {
        const prefix = `question_sets[${index}]`;

        if (!set.client_set_id) {
            setErrors.push(`${prefix}.client_set_id is required`);
        } else if (clientSetIds.has(set.client_set_id)) {
            setErrors.push(`${prefix}.client_set_id is duplicate: ${set.client_set_id}`);
        } else {
            clientSetIds.add(set.client_set_id);
        }

        if (!set.section || !VALID_SECTIONS.includes(set.section)) {
            setErrors.push(`${prefix}.section must be one of ${VALID_SECTIONS.join(', ')}`);
        }

        if (!set.set_type || !VALID_SET_TYPES.includes(set.set_type)) {
            setErrors.push(`${prefix}.set_type must be one of ${VALID_SET_TYPES.join(', ')}`);
        }

        if (set.display_order === undefined || set.display_order === null) {
            setErrors.push(`${prefix}.display_order is required`);
        }

        // Composite sets require context_body
        if (COMPOSITE_SET_TYPES.includes(set.set_type)) {
            if (!set.context_body || set.context_body.trim() === '') {
                setErrors.push(`${prefix}.context_body is required for ${set.set_type} sets`);
            }
        }
    });

    if (setErrors.length > 0) {
        throw new ValidationError('Question sets validation failed', setErrors);
    }

    // Validate questions
    const questionErrors: string[] = [];
    const clientQuestionIds = new Set<string>();

    data.questions.forEach((q, index) => {
        const prefix = `questions[${index}]`;

        if (!q.client_question_id) {
            questionErrors.push(`${prefix}.client_question_id is required`);
        } else if (clientQuestionIds.has(q.client_question_id)) {
            questionErrors.push(`${prefix}.client_question_id is duplicate: ${q.client_question_id}`);
        } else {
            clientQuestionIds.add(q.client_question_id);
        }

        if (!q.set_ref) {
            questionErrors.push(`${prefix}.set_ref is required`);
        } else if (!clientSetIds.has(q.set_ref)) {
            questionErrors.push(`${prefix}.set_ref references non-existent set: ${q.set_ref}`);
        }

        if (q.sequence_order === undefined) {
            questionErrors.push(`${prefix}.sequence_order is required`);
        }

        if (q.question_number === undefined) {
            questionErrors.push(`${prefix}.question_number is required`);
        }

        if (!q.question_text) {
            questionErrors.push(`${prefix}.question_text is required`);
        }

        if (!q.question_type || !VALID_QUESTION_TYPES.includes(q.question_type)) {
            questionErrors.push(`${prefix}.question_type must be one of ${VALID_QUESTION_TYPES.join(', ')}`);
        }

        // MCQ requires options
        if (q.question_type === 'MCQ') {
            if (!q.options || !Array.isArray(q.options) || q.options.length === 0) {
                questionErrors.push(`${prefix}.options is required for MCQ questions`);
            }
        }
    });

    if (questionErrors.length > 0) {
        throw new ValidationError('Questions validation failed', questionErrors);
    }

    return clientSetIds;
}

// =============================================================================
// IMPORT LOGIC
// =============================================================================

function computeJsonHash(data: unknown): string {
    const jsonStr = JSON.stringify(data, Object.keys(data as object).sort());
    return createHash('sha256').update(jsonStr).digest('hex');
}

// =============================================================================
// ROUTE HANDLER
// =============================================================================

export async function POST(request: NextRequest) {
    const supabase = await sbSSR();
    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
    if (!supabaseUrl || !serviceKey) {
        return NextResponse.json({ error: 'Server misconfigured' }, { status: 500 });
    }

    const adminClient = createClient(supabaseUrl, serviceKey, {
        auth: { persistSession: false, autoRefreshToken: false },
    });

    try {
        // 1. Verify admin user
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError || !user) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // Check if user is admin (JWT claim first, fallback to profiles via service role)
        const roleFromJwt = user.app_metadata?.user_role ?? user.user_metadata?.role ?? null;
        let isAdmin = roleFromJwt === 'admin' || roleFromJwt === 'dev';

        if (!isAdmin) {
            const { data: profile, error: profileError } = await adminClient
                .from('profiles')
                .select('role')
                .eq('id', user.id)
                .single();

            if (!profileError && (profile?.role === 'admin' || profile?.role === 'dev')) {
                isAdmin = true;
            }
        }

        logger.info('[Import API] Admin check', {
            userId: user.id,
            email: user.email,
            roleFromJwt,
            isAdmin,
        });

        if (!isAdmin) {
            return NextResponse.json({ error: 'Admin access required' }, { status: 403 });
        }

        // 2. Parse request body
        const body = await request.json();
        const data = body.data as V3ImportPayload;
        const publish = body.publish ?? false;
        const notes = body.notes ?? 'Imported via admin API';
        const skipIfDuplicate = body.skipIfDuplicate ?? false;

        // 3. Validate payload
        validateV3Payload(data);

        logger.info('[Import API] Validated v3 payload', {
            slug: data.paper.slug,
            sets: data.question_sets.length,
            questions: data.questions.length,
        });

        // 4. Import paper
        const { data: existingPaper } = await adminClient
            .from('papers')
            .select('id')
            .eq('slug', data.paper.slug)
            .single();

        const paperPayload = {
            slug: data.paper.slug,
            title: data.paper.title,
            description: data.paper.description || null,
            year: data.paper.year || new Date().getFullYear(),
            total_questions: data.paper.total_questions || data.questions.length,
            total_marks: data.paper.total_marks || 198,
            duration_minutes: data.paper.duration_minutes || 120,
            sections: data.paper.sections || ['VARC', 'DILR', 'QA'],
            default_positive_marks: data.paper.default_positive_marks ?? 3.0,
            default_negative_marks: data.paper.default_negative_marks ?? 1.0,
            difficulty_level: data.paper.difficulty_level || 'medium',
            is_free: data.paper.is_free ?? false,
            published: publish,
            allow_pause: data.paper.allow_pause ?? true,
            attempt_limit: data.paper.attempt_limit ?? 0,
        };

        let paper;
        if (existingPaper) {
            const { data: updated, error } = await adminClient
                .from('papers')
                .update(paperPayload)
                .eq('id', existingPaper.id)
                .select()
                .single();
            if (error) throw error;
            paper = updated;
        } else {
            const { data: inserted, error } = await adminClient
                .from('papers')
                .insert(paperPayload)
                .select()
                .single();
            if (error) throw error;
            paper = inserted;
        }

        // 5. Import question_sets FIRST (build client_set_id → UUID map)
        // Delete existing sets
        await adminClient.from('question_sets').delete().eq('paper_id', paper.id);

        const setIdMap: Record<string, string> = {};

        const setsToInsert = data.question_sets.map((set) => {
            const newId = randomUUID();
            setIdMap[set.client_set_id] = newId;

            // Infer context_type
            let contextType = set.context_type;
            if (!contextType && set.set_type !== 'ATOMIC') {
                contextType = {
                    'VARC': 'rc_passage',
                    'DILR': 'dilr_set',
                    'CASELET': 'caselet'
                }[set.set_type] || 'other_shared_stimulus';
            }

            let contentLayout = set.content_layout || 'single_focus';
            if (!set.content_layout) {
                if (set.context_image_url) {
                    contentLayout = 'image_top';
                } else if (set.set_type === 'VARC') {
                    contentLayout = 'split_passage';
                } else if (set.set_type === 'DILR') {
                    contentLayout = 'split_chart';
                } else if (set.set_type === 'CASELET') {
                    contentLayout = 'split_table';
                } else {
                    contentLayout = 'single_focus';
                }
            }

            return {
                id: newId,
                paper_id: paper.id,
                section: set.section,
                set_type: set.set_type,
                context_type: contextType ?? null,
                content_layout: contentLayout,
                context_title: set.context_title || null,
                context_body: set.context_body || null,
                context_image_url: set.context_image_url || null,
                context_additional_images: set.context_additional_images || null,
                display_order: set.display_order,
                is_active: set.is_active ?? true,
                is_published: publish,
                metadata: set.metadata || {},
                client_set_id: set.client_set_id,
            };
        });

        const { error: setsError } = await adminClient.from('question_sets').insert(setsToInsert);
        if (setsError) throw setsError;

        // 6. Import questions using set_ref → set_id mapping
        await adminClient.from('questions').delete().eq('paper_id', paper.id);

        const questionsToInsert = data.questions.map((q) => {
            const setId = setIdMap[q.set_ref];
            if (!setId) {
                throw new Error(`Question ${q.client_question_id} references unknown set: ${q.set_ref}`);
            }

            return {
                id: randomUUID(),
                paper_id: paper.id,
                section: q.section,
                question_number: q.question_number,
                question_text: q.question_text,
                question_type: q.question_type,
                question_format: q.question_format || q.question_type,
                taxonomy_type: q.taxonomy_type || null,
                topic_tag: q.topic_tag || null,
                difficulty_rationale: q.difficulty_rationale || null,
                options: q.options || null,
                correct_answer: q.correct_answer,
                positive_marks: q.positive_marks ?? 3.0,
                negative_marks: q.negative_marks ?? (q.question_type === 'TITA' ? 0 : 1.0),
                difficulty: q.difficulty || null,
                topic: q.topic || null,
                subtopic: q.subtopic || null,
                solution_text: q.solution_text || null,
                solution_image_url: q.solution_image_url || null,
                video_solution_url: q.video_solution_url || null,
                set_id: setId,
                sequence_order: q.sequence_order,
                is_active: true,
                client_question_id: q.client_question_id,
            };
        });

        const { error: questionsError } = await adminClient.from('questions').insert(questionsToInsert);
        if (questionsError) throw questionsError;

        // 7. Create ingest run
        const canonicalHash = computeJsonHash(data);

        if (skipIfDuplicate) {
            const { data: existing } = await adminClient
                .from('paper_ingest_runs')
                .select('id, version_number')
                .eq('paper_id', paper.id)
                .eq('canonical_json_hash', canonicalHash)
                .single();

            if (existing) {
                return NextResponse.json({
                    success: true,
                    skipped: true,
                    paperId: paper.id,
                    slug: paper.slug,
                    message: `Duplicate detected - already imported as version ${existing.version_number}`,
                });
            }
        }

        const { data: maxVersion } = await adminClient
            .from('paper_ingest_runs')
            .select('version_number')
            .eq('paper_id', paper.id)
            .order('version_number', { ascending: false })
            .limit(1)
            .single();

        const nextVersion = (maxVersion?.version_number || 0) + 1;

        const { data: ingestRun, error: ingestError } = await adminClient
            .from('paper_ingest_runs')
            .insert({
                paper_id: paper.id,
                schema_version: 'v3.0',
                version_number: nextVersion,
                canonical_paper_json: data,
                canonical_json_hash: canonicalHash,
                import_notes: notes,
            })
            .select()
            .single();

        if (ingestError) throw ingestError;

        // Update paper's latest_ingest_run_id
        await adminClient
            .from('papers')
            .update({ latest_ingest_run_id: ingestRun.id })
            .eq('id', paper.id);

        logger.info('[Import API] Import complete', {
            paperId: paper.id,
            slug: paper.slug,
            version: nextVersion,
            sets: data.question_sets.length,
            questions: data.questions.length,
            published: publish,
        });

        return NextResponse.json({
            success: true,
            paperId: paper.id,
            slug: paper.slug,
            version: nextVersion,
            setsCount: data.question_sets.length,
            questionsCount: data.questions.length,
            published: publish,
        });

    } catch (err) {
        if (err instanceof ValidationError) {
            return NextResponse.json({
                error: 'Validation failed',
                message: err.message,
                details: err.errors,
            }, { status: 400 });
        }

        logger.error('[Import API] Import failed', { error: err });
        return NextResponse.json({
            error: 'Import failed',
            message: err instanceof Error ? err.message : 'Unknown error',
        }, { status: 500 });
    }
}
````

## File: src/app/api/attempt-status/route.ts
````typescript
import { NextRequest, NextResponse } from 'next/server';
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import {
    isNonEmptyString,
    getSupabaseConfig,
    serverMisconfiguredResponse,
    addVersionHeader,
} from '../_utils/validation';

export async function POST(req: NextRequest) {
    const res = NextResponse.next();

    try {
        const { attemptId } = await req.json();

        if (!isNonEmptyString(attemptId)) {
            return addVersionHeader(NextResponse.json({ error: 'attemptId required' }, { status: 400 }));
        }

        const config = getSupabaseConfig();
        if (!config) {
            return addVersionHeader(serverMisconfiguredResponse());
        }

        const supabase = createServerClient(config.url, config.anonKey, {
            cookies: {
                getAll() {
                    return req.cookies.getAll();
                },
                setAll(cookiesToSet: Array<{ name: string; value: string; options: CookieOptions }>) {
                    cookiesToSet.forEach(({ name, value, options }) => {
                        res.cookies.set({ name, value, ...options });
                    });
                },
            },
        });

        const {
            data: { user },
            error: authError,
        } = await supabase.auth.getUser();
        if (authError || !user) {
            return addVersionHeader(NextResponse.json({ error: 'Unauthorized' }, { status: 401 }));
        }

        const { data: attempt, error: attemptError } = await supabase
            .from('attempts')
            .select('id, user_id, status, submitted_at, completed_at')
            .eq('id', attemptId)
            .maybeSingle();

        if (attemptError || !attempt) {
            return addVersionHeader(NextResponse.json({ error: 'Attempt not found' }, { status: 404 }));
        }

        if (attempt.user_id !== user.id) {
            return addVersionHeader(NextResponse.json({ error: 'Unauthorized' }, { status: 403 }));
        }

        const success = NextResponse.json({
            success: true,
            data: {
                status: attempt.status,
                submitted_at: attempt.submitted_at ?? null,
                completed_at: attempt.completed_at ?? null,
            },
        });
        res.cookies.getAll().forEach((cookie) => success.cookies.set(cookie));
        return addVersionHeader(success);
    } catch {
        return addVersionHeader(NextResponse.json({ error: 'Invalid JSON' }, { status: 400 }));
    }
}
````

## File: src/app/api/session/route.ts
````typescript
import { NextRequest, NextResponse } from 'next/server';
import { initializeExamSession } from '@/features/exam-engine/lib/actions';
import { sbSSR } from '@/lib/supabase/server';

export async function POST(req: NextRequest) {
    try {
        const { attemptId } = await req.json();
        if (!attemptId) {
            return NextResponse.json({ error: 'attemptId required' }, { status: 400 });
        }

        const supabase = await sbSSR();
        const {
            data: { user },
            error: authError,
        } = await supabase.auth.getUser();
        if (authError || !user) {
            return NextResponse.json({ error: 'Authentication required' }, { status: 401 });
        }

        const { data: attempt, error: attemptError } = await supabase
            .from('attempts')
            .select('id, user_id, status, session_token')
            .eq('id', attemptId)
            .maybeSingle();

        if (attemptError || !attempt) {
            return NextResponse.json({ error: 'Attempt not found' }, { status: 404 });
        }

        if (attempt.user_id !== user.id) {
            return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
        }

        if (attempt.status !== 'in_progress' && attempt.status !== 'paused') {
            return NextResponse.json({ error: 'Attempt is not active' }, { status: 400 });
        }

        if (typeof attempt.session_token === 'string' && attempt.session_token.length > 0) {
            return NextResponse.json({ success: true, data: { sessionToken: attempt.session_token } });
        }

        const result = await initializeExamSession(attemptId);
        if (!result.success) {
            return NextResponse.json({ error: result.error || 'Failed to initialize session' }, { status: 400 });
        }

        return NextResponse.json({ success: true, data: result.data });
    } catch {
        return NextResponse.json({ error: 'Invalid JSON' }, { status: 400 });
    }
}
````

## File: src/components/BugReportFab.tsx
````typescript
'use client';

import { useCallback, useEffect, useRef, useState } from 'react';
import { sb } from '@/lib/supabase/client';
import { uploadToCloudinary } from '@/lib/cloudinary';
import { useFocusTrap } from '@/components/useFocusTrap';

const MAX_FILE_SIZE_MB = 3;
const ACCEPTED_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/avif'];

type BugReportFabProps = {
    userId: string;
    route: string;
    open: boolean;
    onOpen: () => void;
    onClose: () => void;
};

function isValidFile(file: File): { ok: boolean; message?: string } {
    if (!ACCEPTED_TYPES.includes(file.type)) {
        return { ok: false, message: 'Only JPG, PNG, WEBP, or AVIF files are allowed.' };
    }
    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
        return { ok: false, message: `Max file size is ${MAX_FILE_SIZE_MB}MB.` };
    }
    return { ok: true };
}

export default function BugReportFab({ userId, route, open, onOpen, onClose }: BugReportFabProps) {
    const modalRef = useRef<HTMLDivElement>(null);
    const [description, setDescription] = useState('');
    const [file, setFile] = useState<File | null>(null);
    const [previewUrl, setPreviewUrl] = useState<string | null>(null);
    const [status, setStatus] = useState<string | null>(null);
    const [submitting, setSubmitting] = useState(false);

    useFocusTrap(open, modalRef, onClose);

    useEffect(() => {
        if (!open) {
            setStatus(null);
        }
    }, [open]);

    useEffect(() => {
        return () => {
            if (previewUrl) {
                URL.revokeObjectURL(previewUrl);
            }
        };
    }, [previewUrl]);

    const handleFileChange = useCallback((nextFile: File | null) => {
        if (!nextFile) {
            if (previewUrl) {
                URL.revokeObjectURL(previewUrl);
            }
            setFile(null);
            setPreviewUrl(null);
            return;
        }
        const validation = isValidFile(nextFile);
        if (!validation.ok) {
            setStatus(validation.message ?? 'Invalid file.');
            return;
        }
        if (previewUrl) {
            URL.revokeObjectURL(previewUrl);
        }
        setFile(nextFile);
        setPreviewUrl(URL.createObjectURL(nextFile));
    }, [previewUrl]);

    const handleSubmit = useCallback(async () => {
        if (!description.trim()) {
            setStatus('Please describe what went wrong.');
            return;
        }
        setSubmitting(true);
        setStatus(null);
        let screenshotPath: string | null = null;

        try {
            const supabase = sb();
            if (file) {
                screenshotPath = await uploadToCloudinary(file);
            }

            const meta = {
                user_agent: typeof navigator !== 'undefined' ? navigator.userAgent : null,
                client_time: new Date().toISOString(),
                route,
                image_provider: screenshotPath ? 'cloudinary' : null,
            };

            const { error: insertError } = await supabase.from('bug_reports').insert({
                user_id: userId,
                route,
                description: description.trim(),
                screenshot_path: screenshotPath,
                meta,
            });

            if (insertError) {
                throw insertError;
            }

            setStatus('Thanks. Your report was sent.');
            setDescription('');
            handleFileChange(null);
            onClose();
        } catch (error) {
            const message = error instanceof Error ? error.message : 'Failed to submit report.';
            setStatus(message);
        } finally {
            setSubmitting(false);
        }
    }, [description, file, handleFileChange, onClose, route, userId]);

    return (
        <>
            <button
                type="button"
                onClick={onOpen}
                className="fixed bottom-6 right-6 z-40 inline-flex h-12 w-12 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-700 shadow-md transition hover:-translate-y-0.5 hover:bg-slate-50"
                aria-label="Report an issue"
            >
                <svg className="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01M5 19h14l-1.5-13h-11z" />
                </svg>
            </button>

            <div
                className={`fixed inset-0 z-50 transition ${open ? 'pointer-events-auto' : 'pointer-events-none'}`}
                aria-hidden={!open}
            >
                <div
                    className={`absolute inset-0 bg-slate-900/50 transition-opacity ${open ? 'opacity-100' : 'opacity-0'}`}
                    onClick={onClose}
                />
                <div
                    ref={modalRef}
                    role="dialog"
                    aria-modal="true"
                    aria-label="Report an issue"
                    tabIndex={-1}
                    className={`absolute right-6 top-20 w-[min(92vw,420px)] rounded-2xl border border-slate-200 bg-white p-5 shadow-xl transition ${open ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'
                        }`}
                    onClick={(event) => event.stopPropagation()}
                >
                    <div className="flex items-start justify-between">
                        <div>
                            <p className="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Report an issue</p>
                            <h3 className="mt-2 text-lg font-semibold text-slate-900">What went wrong?</h3>
                        </div>
                        <button
                            type="button"
                            onClick={onClose}
                            className="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:bg-slate-100"
                        >
                            Close
                        </button>
                    </div>

                    <textarea
                        value={description}
                        onChange={(event) => setDescription(event.target.value)}
                        className="mt-4 h-28 w-full resize-none rounded-xl border border-slate-200 px-3 py-2 text-sm focus:border-slate-400 focus:outline-none"
                        placeholder="Describe the issue in a sentence or two..."
                    />

                    <div className="mt-4">
                        <label className="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">
                            Screenshot (optional)
                        </label>
                        <div className="mt-2 flex items-center gap-3">
                            <input
                                type="file"
                                accept={ACCEPTED_TYPES.join(',')}
                                onChange={(event) => handleFileChange(event.target.files?.[0] ?? null)}
                                className="text-xs text-slate-500"
                            />
                            <span className="text-xs text-slate-400">Max {MAX_FILE_SIZE_MB}MB</span>
                        </div>
                        {previewUrl && (
                            <img
                                src={previewUrl}
                                alt="Screenshot preview"
                                className="mt-3 h-24 w-full rounded-lg object-cover"
                            />
                        )}
                    </div>

                    {status && <p className="mt-3 text-xs text-slate-500">{status}</p>}

                    <button
                        type="button"
                        onClick={handleSubmit}
                        disabled={submitting}
                        className="mt-4 w-full rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-60"
                    >
                        {submitting ? 'Sending...' : 'Submit report'}
                    </button>
                </div>
            </div>
        </>
    );
}
````

## File: src/features/admin/index.ts
````typescript
/**
 * @fileoverview Admin Feature Exports
 * @description Barrel exports for admin UI components
 * @blueprint M6+ - Mirror Principle Components
 */

export { EditableQuestion } from './ui/EditableQuestion';
export { EditableExamLayout } from './ui/EditableExamLayout';
export { QuestionSetEditor } from './ui/QuestionSetEditor';  // Question Container Architecture
````

## File: src/features/exam-engine/index.ts
````typescript
/**
 * @fileoverview Exam Engine Feature - Barrel Export
 * @description Public API for the exam engine feature module
 * @blueprint Milestone 4 - Feature-Sliced Design (FSD)
 */

// Model (Zustand Store)
export {
    useExamStore,
    createExamStore,
    selectCurrentSection,
    selectCurrentTimer,
    selectResponse,
    selectIsSectionLocked,
    selectQuestionStatus,
    selectSectionCounts,
} from './model/useExamStore';

// Hooks
export {
    useExamTimer,
    useSectionTimer,
    useAllSectionTimers,
    calculateRemainingSeconds,
    formatTime,
    getTimerState,
} from './hooks/useExamTimer';

// UI Components
export {
    ExamLayout,
    ExamTimer,
    SectionTimerSummary,
    QuestionPalette,
    MCQRenderer,
    TITARenderer,
    NavigationButtons,
    ExamSubmitButton,
} from './ui';

// Types are re-exported from the central types module
export type {
    ExamStore,
    ExamEngineState,
    ExamEngineActions,
    ResponseState,
    SectionTimerState,
} from '@/types/exam';

// Timer hook types
export type {
    UseExamTimerOptions,
    TimerDisplayData,
} from './hooks/useExamTimer';
````

## File: src/features/exam-engine/lib/__tests__/scoring.test.ts
````typescript
import { describe, expect, it } from 'vitest';
import {
    calculateScore,
    calculateQuestionMarks,
    compareAnswers,
    normalizeString,
    parseAsNumber,
    calculateTimeTaken,
    type ResponseForScoring,
} from '../scoring';
import type { QuestionWithAnswer } from '@/types/exam';

const makeQuestion = (overrides: Partial<QuestionWithAnswer>): QuestionWithAnswer => ({
    id: overrides.id ?? 'q1',
    paper_id: overrides.paper_id ?? 'paper-1',
    section: overrides.section ?? 'VARC',
    question_number: overrides.question_number ?? 1,
    question_text: overrides.question_text ?? 'Question text',
    question_type: overrides.question_type ?? 'MCQ',
    options: overrides.options ?? ['A', 'B', 'C', 'D'],
    positive_marks: overrides.positive_marks ?? 3,
    negative_marks: overrides.negative_marks ?? 1,
    is_active: overrides.is_active ?? true,
    created_at: overrides.created_at ?? '2026-01-01T00:00:00.000Z',
    updated_at: overrides.updated_at ?? '2026-01-01T00:00:00.000Z',
    correct_answer: overrides.correct_answer ?? 'A',
    set_id: overrides.set_id ?? null,
    sequence_order: overrides.sequence_order ?? null,
    exam_order: overrides.exam_order ?? undefined,
    question_format: overrides.question_format ?? undefined,
    taxonomy_type: overrides.taxonomy_type ?? undefined,
    topic_tag: overrides.topic_tag ?? undefined,
    difficulty_rationale: overrides.difficulty_rationale ?? undefined,
    context_id: overrides.context_id ?? undefined,
    context: overrides.context ?? undefined,
    solution_text: overrides.solution_text ?? undefined,
    solution_image_url: overrides.solution_image_url ?? undefined,
    video_solution_url: overrides.video_solution_url ?? undefined,
    question_image_url: overrides.question_image_url ?? undefined,
    difficulty: overrides.difficulty ?? undefined,
    topic: overrides.topic ?? undefined,
    subtopic: overrides.subtopic ?? undefined,
});

// =============================================================================
// NORMALIZATION TESTS
// =============================================================================

describe('normalizeString', () => {
    it('handles null and undefined', () => {
        expect(normalizeString(null)).toBe('');
        expect(normalizeString(undefined)).toBe('');
    });

    it('trims whitespace', () => {
        expect(normalizeString('  hello  ')).toBe('hello');
        expect(normalizeString('\t\ntest\n\t')).toBe('test');
    });

    it('converts to lowercase', () => {
        expect(normalizeString('HELLO')).toBe('hello');
        expect(normalizeString('HeLLo WoRLd')).toBe('hello world');
    });

    it('collapses multiple spaces', () => {
        expect(normalizeString('hello   world')).toBe('hello world');
        expect(normalizeString('a  b  c')).toBe('a b c');
    });

    it('handles numbers', () => {
        expect(normalizeString(42)).toBe('42');
        expect(normalizeString(3.14)).toBe('3.14');
    });
});

describe('parseAsNumber', () => {
    it('parses valid integers', () => {
        expect(parseAsNumber('42')).toBe(42);
        expect(parseAsNumber('-17')).toBe(-17);
        expect(parseAsNumber('0')).toBe(0);
    });

    it('parses valid decimals', () => {
        expect(parseAsNumber('3.14')).toBe(3.14);
        expect(parseAsNumber('-2.5')).toBe(-2.5);
        expect(parseAsNumber('0.001')).toBe(0.001);
    });

    it('handles whitespace', () => {
        expect(parseAsNumber('  42  ')).toBe(42);
        expect(parseAsNumber('\t3.14\n')).toBe(3.14);
    });

    it('returns null for invalid input', () => {
        expect(parseAsNumber(null)).toBe(null);
        expect(parseAsNumber(undefined)).toBe(null);
        expect(parseAsNumber('')).toBe(null);
        expect(parseAsNumber('abc')).toBe(null);
        expect(parseAsNumber('12abc')).toBe(null);
    });

    it('returns null for Infinity and NaN', () => {
        expect(parseAsNumber('Infinity')).toBe(null);
        expect(parseAsNumber('-Infinity')).toBe(null);
        expect(parseAsNumber('NaN')).toBe(null);
    });
});

// =============================================================================
// ANSWER COMPARISON TESTS
// =============================================================================

describe('compareAnswers', () => {
    describe('MCQ questions', () => {
        it('matches case-insensitively', () => {
            expect(compareAnswers('a', 'A', 'MCQ')).toBe(true);
            expect(compareAnswers('A', 'a', 'MCQ')).toBe(true);
            expect(compareAnswers('B', 'B', 'MCQ')).toBe(true);
        });

        it('handles whitespace', () => {
            expect(compareAnswers('  A  ', 'A', 'MCQ')).toBe(true);
            expect(compareAnswers('B', '  b  ', 'MCQ')).toBe(true);
        });

        it('returns false for mismatches', () => {
            expect(compareAnswers('A', 'B', 'MCQ')).toBe(false);
            expect(compareAnswers('C', 'D', 'MCQ')).toBe(false);
        });

        it('returns false for null/empty', () => {
            expect(compareAnswers(null, 'A', 'MCQ')).toBe(false);
            expect(compareAnswers('', 'A', 'MCQ')).toBe(false);
            expect(compareAnswers('   ', 'A', 'MCQ')).toBe(false);
        });
    });

    describe('TITA questions', () => {
        it('compares numeric values correctly', () => {
            expect(compareAnswers('42', '42', 'TITA')).toBe(true);
            expect(compareAnswers('42.0', '42', 'TITA')).toBe(true);
            expect(compareAnswers('42.00', '42.0', 'TITA')).toBe(true);
        });

        it('handles decimal precision', () => {
            expect(compareAnswers('3.14', '3.14', 'TITA')).toBe(true);
            expect(compareAnswers('3.140', '3.14', 'TITA')).toBe(true);
            expect(compareAnswers('3.14', '3.15', 'TITA')).toBe(false);
        });

        it('handles negative numbers', () => {
            expect(compareAnswers('-5', '-5', 'TITA')).toBe(true);
            expect(compareAnswers('-5.0', '-5', 'TITA')).toBe(true);
        });

        it('falls back to string comparison for non-numeric', () => {
            expect(compareAnswers('hello', 'hello', 'TITA')).toBe(true);
            expect(compareAnswers('HELLO', 'hello', 'TITA')).toBe(true);
            expect(compareAnswers('hello', 'world', 'TITA')).toBe(false);
        });

        it('returns false for null/empty', () => {
            expect(compareAnswers(null, '42', 'TITA')).toBe(false);
            expect(compareAnswers('', '42', 'TITA')).toBe(false);
        });
    });
});

// =============================================================================
// QUESTION MARKS CALCULATION TESTS
// =============================================================================

describe('calculateQuestionMarks', () => {
    describe('MCQ questions', () => {
        const mcqQuestion = makeQuestion({
            question_type: 'MCQ',
            correct_answer: 'B',
            positive_marks: 3,
            negative_marks: 1
        });

        it('awards positive marks for correct answer', () => {
            expect(calculateQuestionMarks(mcqQuestion, 'B')).toEqual({
                isCorrect: true,
                marksObtained: 3
            });
        });

        it('deducts marks for wrong answer', () => {
            expect(calculateQuestionMarks(mcqQuestion, 'A')).toEqual({
                isCorrect: false,
                marksObtained: -1
            });
            expect(calculateQuestionMarks(mcqQuestion, 'C')).toEqual({
                isCorrect: false,
                marksObtained: -1
            });
        });

        it('gives zero for unanswered', () => {
            expect(calculateQuestionMarks(mcqQuestion, null)).toEqual({
                isCorrect: false,
                marksObtained: 0
            });
            expect(calculateQuestionMarks(mcqQuestion, '')).toEqual({
                isCorrect: false,
                marksObtained: 0
            });
        });

        it('uses custom marks when specified', () => {
            const customMarksQ = makeQuestion({
                question_type: 'MCQ',
                correct_answer: 'A',
                positive_marks: 5,
                negative_marks: 2
            });
            expect(calculateQuestionMarks(customMarksQ, 'A')).toEqual({
                isCorrect: true,
                marksObtained: 5
            });
            expect(calculateQuestionMarks(customMarksQ, 'B')).toEqual({
                isCorrect: false,
                marksObtained: -2
            });
        });
    });

    describe('TITA questions', () => {
        const titaQuestion = makeQuestion({
            question_type: 'TITA',
            correct_answer: '42',
            positive_marks: 3,
            negative_marks: 0,
            options: null
        });

        it('awards positive marks for correct answer', () => {
            expect(calculateQuestionMarks(titaQuestion, '42')).toEqual({
                isCorrect: true,
                marksObtained: 3
            });
            expect(calculateQuestionMarks(titaQuestion, '42.0')).toEqual({
                isCorrect: true,
                marksObtained: 3
            });
        });

        it('gives zero for wrong answer (no negative marking)', () => {
            expect(calculateQuestionMarks(titaQuestion, '41')).toEqual({
                isCorrect: false,
                marksObtained: 0
            });
            expect(calculateQuestionMarks(titaQuestion, '43')).toEqual({
                isCorrect: false,
                marksObtained: 0
            });
        });

        it('gives zero for unanswered', () => {
            expect(calculateQuestionMarks(titaQuestion, null)).toEqual({
                isCorrect: false,
                marksObtained: 0
            });
        });
    });
});

// =============================================================================
// FULL SCORING TESTS
// =============================================================================

describe('calculateScore', () => {
    it('calculates total score, accuracy, and attempt rate', () => {
        const questions: QuestionWithAnswer[] = [
            makeQuestion({ id: 'q1', section: 'VARC', question_number: 1, question_type: 'MCQ', correct_answer: 'A' }),
            makeQuestion({ id: 'q2', section: 'DILR', question_number: 2, question_type: 'MCQ', correct_answer: 'B' }),
            makeQuestion({ id: 'q3', section: 'QA', question_number: 3, question_type: 'TITA', correct_answer: '42', negative_marks: 0, options: null }),
        ];

        const responses: ResponseForScoring[] = [
            { question_id: 'q1', answer: 'A', time_spent_seconds: 30 },
            { question_id: 'q2', answer: 'C', time_spent_seconds: 45 },
            { question_id: 'q3', answer: null, time_spent_seconds: 0 },
        ];

        const result = calculateScore(questions, responses);

        expect(result.total_score).toBe(2); // 3 - 1 + 0
        expect(result.max_possible_score).toBe(9);
        expect(result.correct_count).toBe(1);
        expect(result.incorrect_count).toBe(1);
        expect(result.unanswered_count).toBe(1);
        expect(result.accuracy).toBe(50); // 1/2 = 50%
        expect(result.attempt_rate).toBe(66.67); // 2/3 ≈ 66.67%
        expect(result.section_scores.VARC.score).toBe(3);
        expect(result.section_scores.DILR.score).toBe(-1);
        expect(result.section_scores.QA.score).toBe(0);
    });

    it('handles all correct answers', () => {
        const questions: QuestionWithAnswer[] = [
            makeQuestion({ id: 'q1', section: 'VARC', correct_answer: 'A' }),
            makeQuestion({ id: 'q2', section: 'VARC', correct_answer: 'B' }),
            makeQuestion({ id: 'q3', section: 'VARC', correct_answer: 'C' }),
        ];

        const responses: ResponseForScoring[] = [
            { question_id: 'q1', answer: 'A', time_spent_seconds: 30 },
            { question_id: 'q2', answer: 'B', time_spent_seconds: 30 },
            { question_id: 'q3', answer: 'C', time_spent_seconds: 30 },
        ];

        const result = calculateScore(questions, responses);

        expect(result.total_score).toBe(9);
        expect(result.correct_count).toBe(3);
        expect(result.incorrect_count).toBe(0);
        expect(result.accuracy).toBe(100);
        expect(result.attempt_rate).toBe(100);
    });

    it('handles all wrong answers', () => {
        const questions: QuestionWithAnswer[] = [
            makeQuestion({ id: 'q1', section: 'VARC', correct_answer: 'A' }),
            makeQuestion({ id: 'q2', section: 'VARC', correct_answer: 'B' }),
        ];

        const responses: ResponseForScoring[] = [
            { question_id: 'q1', answer: 'D', time_spent_seconds: 30 },
            { question_id: 'q2', answer: 'D', time_spent_seconds: 30 },
        ];

        const result = calculateScore(questions, responses);

        expect(result.total_score).toBe(-2); // -1 - 1
        expect(result.correct_count).toBe(0);
        expect(result.incorrect_count).toBe(2);
        expect(result.accuracy).toBe(0);
        expect(result.attempt_rate).toBe(100);
    });

    it('handles all unanswered', () => {
        const questions: QuestionWithAnswer[] = [
            makeQuestion({ id: 'q1', section: 'QA', correct_answer: 'A' }),
            makeQuestion({ id: 'q2', section: 'QA', correct_answer: 'B' }),
        ];

        const responses: ResponseForScoring[] = [
            { question_id: 'q1', answer: null, time_spent_seconds: 0 },
            { question_id: 'q2', answer: null, time_spent_seconds: 0 },
        ];

        const result = calculateScore(questions, responses);

        expect(result.total_score).toBe(0);
        expect(result.unanswered_count).toBe(2);
        expect(result.accuracy).toBe(0);
        expect(result.attempt_rate).toBe(0);
    });

    it('handles missing responses gracefully', () => {
        const questions: QuestionWithAnswer[] = [
            makeQuestion({ id: 'q1', section: 'VARC', correct_answer: 'A' }),
            makeQuestion({ id: 'q2', section: 'VARC', correct_answer: 'B' }),
        ];

        // Only one response provided
        const responses: ResponseForScoring[] = [
            { question_id: 'q1', answer: 'A', time_spent_seconds: 30 },
        ];

        const result = calculateScore(questions, responses);

        expect(result.total_score).toBe(3);
        expect(result.correct_count).toBe(1);
        expect(result.unanswered_count).toBe(1);
    });

    it('calculates section-wise scores correctly', () => {
        const questions: QuestionWithAnswer[] = [
            makeQuestion({ id: 'q1', section: 'VARC', correct_answer: 'A' }),
            makeQuestion({ id: 'q2', section: 'VARC', correct_answer: 'B' }),
            makeQuestion({ id: 'q3', section: 'DILR', correct_answer: 'A' }),
            makeQuestion({ id: 'q4', section: 'DILR', correct_answer: 'B' }),
            makeQuestion({ id: 'q5', section: 'QA', correct_answer: 'A' }),
            makeQuestion({ id: 'q6', section: 'QA', correct_answer: 'B' }),
        ];

        const responses: ResponseForScoring[] = [
            { question_id: 'q1', answer: 'A', time_spent_seconds: 30 }, // VARC +3
            { question_id: 'q2', answer: 'C', time_spent_seconds: 30 }, // VARC -1
            { question_id: 'q3', answer: 'A', time_spent_seconds: 30 }, // DILR +3
            { question_id: 'q4', answer: 'B', time_spent_seconds: 30 }, // DILR +3
            { question_id: 'q5', answer: null, time_spent_seconds: 0 }, // QA 0
            { question_id: 'q6', answer: 'C', time_spent_seconds: 30 }, // QA -1
        ];

        const result = calculateScore(questions, responses);

        expect(result.section_scores.VARC.score).toBe(2);
        expect(result.section_scores.VARC.correct).toBe(1);
        expect(result.section_scores.VARC.incorrect).toBe(1);
        expect(result.section_scores.VARC.unanswered).toBe(0);

        expect(result.section_scores.DILR.score).toBe(6);
        expect(result.section_scores.DILR.correct).toBe(2);
        expect(result.section_scores.DILR.incorrect).toBe(0);

        expect(result.section_scores.QA.score).toBe(-1);
        expect(result.section_scores.QA.unanswered).toBe(1);
        expect(result.section_scores.QA.incorrect).toBe(1);

        expect(result.total_score).toBe(7); // 2 + 6 - 1
    });

    it('includes question-level results', () => {
        const questions: QuestionWithAnswer[] = [
            makeQuestion({ id: 'q1', section: 'VARC', correct_answer: 'A' }),
        ];

        const responses: ResponseForScoring[] = [
            { question_id: 'q1', answer: 'A', time_spent_seconds: 30 },
        ];

        const result = calculateScore(questions, responses);

        expect(result.question_results).toHaveLength(1);
        expect(result.question_results[0]).toEqual({
            question_id: 'q1',
            section: 'VARC',
            is_correct: true,
            marks_obtained: 3,
            user_answer: 'A',
            correct_answer: 'A',
        });
    });
});

// =============================================================================
// TIME CALCULATION TESTS
// =============================================================================

describe('calculateTimeTaken', () => {
    it('calculates time in seconds', () => {
        const start = '2026-01-01T10:00:00.000Z';
        const end = '2026-01-01T12:00:00.000Z'; // 2 hours later
        expect(calculateTimeTaken(start, end)).toBe(7200);
    });

    it('handles minutes and seconds', () => {
        const start = '2026-01-01T10:00:00.000Z';
        const end = '2026-01-01T10:30:45.000Z'; // 30 minutes 45 seconds
        expect(calculateTimeTaken(start, end)).toBe(1845);
    });

    it('subtracts paused time', () => {
        const start = '2026-01-01T10:00:00.000Z';
        const end = '2026-01-01T12:00:00.000Z'; // 2 hours later
        expect(calculateTimeTaken(start, end, 900)).toBe(6300); // minus 15 minutes
    });

    it('guards against negative results', () => {
        const start = '2026-01-01T10:00:00.000Z';
        const end = '2026-01-01T10:05:00.000Z'; // 5 minutes later
        expect(calculateTimeTaken(start, end, 600)).toBe(0);
    });
});
````

## File: src/features/exam-engine/ui/DevToolsPanel.tsx
````typescript
'use client';

/**
 * @fileoverview Dev-only floating control panel for exam testing
 * @description Provides UI buttons to accelerate exam states for rapid testing
 * 
 * CRITICAL: This component is completely removed from production builds
 * via conditional rendering in the parent component
 * 
 * Features:
 * - Skip to any section
 * - Set custom timers
 * - Expire current section
 * - Trigger final submission
 * - State inspection
 */

import { useState, useEffect, useCallback } from 'react';
import { useExamStore } from '@/features/exam-engine/model/useExamStore';
import {
    isDevModeEnabled,
    skipToSection,
    setCurrentSectionTimer,
    expireCurrentSection,
    logExamState,
    createDevKeyboardHandler,
    attachDevToolsToWindow,
    processDevActionFromUrl,
    isDevSyncPaused,
    setDevSyncPaused,
    type DevActionExecutor,
} from '@/lib/devTools';
import type { SectionName } from '@/types/exam';

interface DevToolsPanelProps {
    onTriggerSubmit?: () => void;
}

/**
 * DevToolsPanel - Floating panel for exam testing
 * 
 * Only rendered when:
 * 1. NODE_ENV === 'development'
 * 2. ?dev_mode=true URL param (optional, for explicit activation)
 */
export function DevToolsPanel({ onTriggerSubmit }: DevToolsPanelProps) {
    const [isVisible, setIsVisible] = useState(false);
    const [isMinimized, setIsMinimized] = useState(false);
    const [isSyncPaused, setIsSyncPaused] = useState(false);

    // Get store state and actions
    const currentSectionIndex = useExamStore((s) => s.currentSectionIndex);
    const sectionTimers = useExamStore((s) => s.sectionTimers);
    const responses = useExamStore((s) => s.responses);
    const attemptId = useExamStore((s) => s.attemptId);

    // Get store actions
    const expireSectionAction = useExamStore((s) => s.expireSection);
    const moveToNextSectionAction = useExamStore((s) => s.moveToNextSection);
    const updateSectionTimerAction = useExamStore((s) => s.updateSectionTimer);
    const setAutoSubmittingAction = useExamStore((s) => s.setAutoSubmitting);
    const setSectionTimerOverrideAction = useExamStore((s) => s.setSectionTimerOverride);

    // Create executor interface for dev tools
    const executor: DevActionExecutor = {
        expireSection: expireSectionAction,
        moveToNextSection: moveToNextSectionAction,
        updateSectionTimer: updateSectionTimerAction,
        setSectionTimerOverride: setSectionTimerOverrideAction,
        setAutoSubmitting: setAutoSubmittingAction,
        getCurrentSectionIndex: () => currentSectionIndex,
        getSectionTimers: () => sectionTimers,
        getResponses: () => responses,
        getAttemptId: () => attemptId,
    };

    // Don't render in production
    if (!isDevModeEnabled()) {
        return null;
    }

    const sections: SectionName[] = ['VARC', 'DILR', 'QA'];
    const currentSection = sections[currentSectionIndex];
    const currentTimer = sectionTimers[currentSection];

    // Process URL actions on mount
    useEffect(() => {
        processDevActionFromUrl(executor);
        attachDevToolsToWindow(executor);
        setIsSyncPaused(isDevSyncPaused());
    }, []);

    // Setup keyboard shortcuts
    useEffect(() => {
        const cleanup = createDevKeyboardHandler({
            togglePanel: () => setIsVisible((v) => !v),
            skipToNextSection: () => {
                if (currentSectionIndex < 2) {
                    skipToSection(currentSectionIndex + 1, executor);
                }
            },
            setQuickTimer: () => setCurrentSectionTimer(10, executor),
            logState: () => logExamState(executor),
        });

        return cleanup;
    }, [currentSectionIndex]);

    const handleSkipToSection = useCallback((targetIndex: number) => {
        skipToSection(targetIndex, executor);
    }, [executor]);

    const handleSetTimer = useCallback((seconds: number) => {
        setCurrentSectionTimer(seconds, executor);
    }, [executor]);

    const handleExpireSection = useCallback(() => {
        expireCurrentSection(executor);
    }, [executor]);

    const handleLogState = useCallback(() => {
        logExamState(executor);
    }, [executor]);

    const handleToggleSync = useCallback(() => {
        setIsSyncPaused((prev) => {
            const next = !prev;
            setDevSyncPaused(next);
            return next;
        });
    }, []);

    const answeredCount = Object.values(responses).filter(
        (r) => r.status === 'answered' || r.status === 'answered_marked'
    ).length;

    // Floating trigger button (always visible in dev) - positioned on LEFT to avoid overlap with BugReportFab on right
    if (!isVisible) {
        return (
            <button
                onClick={() => setIsVisible(true)}
                className="fixed bottom-4 left-4 z-[9999] bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-3 py-2 rounded-lg shadow-lg text-sm flex items-center gap-2"
                title="Open Dev Tools (Ctrl+Shift+D)"
            >
                🛠️ DEV
            </button>
        );
    }

    // Minimized state - positioned on LEFT to avoid overlap with BugReportFab
    if (isMinimized) {
        return (
            <div className="fixed bottom-4 left-4 z-[9999] bg-gray-900 border border-yellow-500 rounded-lg shadow-lg p-2">
                <div className="flex items-center gap-2">
                    <span className="text-yellow-500 text-sm font-bold">🛠️ DEV</span>
                    <span className="text-white text-xs">
                        {currentSection} | {Math.floor(currentTimer.remainingSeconds)}s
                    </span>
                    <button
                        onClick={() => setIsMinimized(false)}
                        className="text-white hover:text-yellow-500 text-xs"
                    >
                        ▲
                    </button>
                    <button
                        onClick={() => setIsVisible(false)}
                        className="text-white hover:text-red-500 text-xs"
                    >
                        ✕
                    </button>
                </div>
            </div>
        );
    }

    // Full panel - positioned on LEFT to avoid overlap with BugReportFab
    return (
        <div className="fixed bottom-4 left-4 z-[9999] bg-gray-900 border border-yellow-500 rounded-lg shadow-lg w-80 max-h-[80vh] overflow-y-auto">
            {/* Header */}
            <div className="bg-yellow-500 text-black px-3 py-2 font-bold flex justify-between items-center rounded-t-lg">
                <span>🛠️ Dev Tools</span>
                <div className="flex gap-2">
                    <button
                        onClick={() => setIsMinimized(true)}
                        className="hover:bg-yellow-600 px-2 rounded"
                        title="Minimize"
                    >
                        ▼
                    </button>
                    <button
                        onClick={() => setIsVisible(false)}
                        className="hover:bg-red-500 hover:text-white px-2 rounded"
                        title="Close"
                    >
                        ✕
                    </button>
                </div>
            </div>

            {/* Current State */}
            <div className="p-3 border-b border-gray-700">
                <div className="text-gray-400 text-xs uppercase mb-2">Current State</div>
                <div className="grid grid-cols-2 gap-2 text-sm">
                    <div className="text-gray-300">Section:</div>
                    <div className="text-white font-mono">{currentSection} ({currentSectionIndex + 1}/3)</div>
                    <div className="text-gray-300">Timer:</div>
                    <div className="text-white font-mono">{Math.floor(currentTimer.remainingSeconds)}s</div>
                    <div className="text-gray-300">Answered:</div>
                    <div className="text-white font-mono">{answeredCount}/{Object.keys(responses).length}</div>
                </div>
            </div>

            {/* Section Controls */}
            <div className="p-3 border-b border-gray-700">
                <div className="text-gray-400 text-xs uppercase mb-2">Skip to Section</div>
                <div className="flex gap-2">
                    {sections.map((section, idx) => (
                        <button
                            key={section}
                            onClick={() => handleSkipToSection(idx)}
                            disabled={idx <= currentSectionIndex}
                            className={`flex-1 px-2 py-1 rounded text-sm font-medium transition
                                ${idx === currentSectionIndex
                                    ? 'bg-blue-600 text-white'
                                    : idx < currentSectionIndex
                                        ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
                                        : 'bg-gray-700 text-white hover:bg-gray-600'
                                }`}
                        >
                            {section}
                        </button>
                    ))}
                </div>
            </div>

            {/* Timer Controls */}
            <div className="p-3 border-b border-gray-700">
                <div className="text-gray-400 text-xs uppercase mb-2">Set Timer</div>
                <div className="flex gap-2 flex-wrap">
                    {[10, 30, 60, 120, 300].map((seconds) => (
                        <button
                            key={seconds}
                            onClick={() => handleSetTimer(seconds)}
                            className="px-2 py-1 bg-gray-700 text-white rounded text-sm hover:bg-gray-600 transition"
                        >
                            {seconds < 60 ? `${seconds}s` : `${seconds / 60}m`}
                        </button>
                    ))}
                </div>
            </div>

            {/* Quick Actions */}
            <div className="p-3 border-b border-gray-700">
                <div className="text-gray-400 text-xs uppercase mb-2">Quick Actions</div>
                <div className="flex flex-col gap-2">
                    <button
                        onClick={handleExpireSection}
                        className="px-3 py-2 bg-orange-600 text-white rounded text-sm hover:bg-orange-700 transition w-full"
                    >
                        ⏱️ Expire Current Section
                    </button>
                    {onTriggerSubmit && (
                        <button
                            onClick={onTriggerSubmit}
                            className="px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition w-full"
                        >
                            📤 Trigger Final Submit
                        </button>
                    )}
                    <button
                        onClick={handleToggleSync}
                        className={`px-3 py-2 rounded text-sm transition w-full ${isSyncPaused
                            ? 'bg-emerald-700 text-white hover:bg-emerald-800'
                            : 'bg-slate-700 text-white hover:bg-slate-600'
                            }`}
                    >
                        {isSyncPaused ? '✅ Resume Server Sync' : '⏸️ Pause Server Sync'}
                    </button>
                    <button
                        onClick={handleLogState}
                        className="px-3 py-2 bg-gray-700 text-white rounded text-sm hover:bg-gray-600 transition w-full"
                    >
                        📋 Log State to Console
                    </button>
                </div>
            </div>

            {/* Keyboard Shortcuts */}
            <div className="p-3">
                <div className="text-gray-400 text-xs uppercase mb-2">Keyboard Shortcuts</div>
                <div className="text-xs text-gray-500 space-y-1">
                    <div><kbd className="bg-gray-700 px-1 rounded">Ctrl+Shift+D</kbd> Toggle panel</div>
                    <div><kbd className="bg-gray-700 px-1 rounded">Ctrl+Shift+N</kbd> Skip to next section</div>
                    <div><kbd className="bg-gray-700 px-1 rounded">Ctrl+Shift+T</kbd> Set timer to 10s</div>
                    <div><kbd className="bg-gray-700 px-1 rounded">Ctrl+Shift+L</kbd> Log state</div>
                </div>
            </div>

            {/* Footer */}
            <div className="px-3 py-2 bg-gray-800 text-xs text-gray-500 rounded-b-lg">
                💡 Tip: Use <code className="bg-gray-700 px-1 rounded">window.__devTools</code> in console
            </div>
        </div>
    );
}

export default DevToolsPanel;
````

## File: src/lib/access-control.ts
````typescript
export type AccessStatus = 'active' | 'pending' | 'rejected';

type UserLike = {
    app_metadata?: Record<string, unknown> | null;
} | null;

type RpcResult<T> = { data: T | null; error: { message?: string } | null };

type SupabaseRpcClient = {
    rpc: (fn: string, args?: Record<string, unknown>) => PromiseLike<unknown>;
};

type SupabaseQueryClient = {
    from: (table: string) => {
        select: (cols: string) => {
            eq: (col: string, value: unknown) => {
                maybeSingle: () => PromiseLike<unknown>;
            };
        };
    };
};

export async function resolveIsAdmin(
    supabase: unknown,
    user: UserLike
): Promise<boolean> {
    const role = user?.app_metadata
        ? (user.app_metadata as { user_role?: string | null }).user_role ?? null
        : null;
    if (role === 'admin' || role === 'dev') return true;

    const { data, error } = (await (supabase as SupabaseRpcClient).rpc('is_admin')) as RpcResult<boolean>;
    return !error && Boolean(data);
}

export async function fetchAccessStatus(
    supabase: unknown,
    userId: string
): Promise<AccessStatus | null> {
    const { data, error } = (await (supabase as SupabaseQueryClient)
        .from('user_access')
        .select('status')
        .eq('user_id', userId)
        .maybeSingle()) as RpcResult<{ status?: AccessStatus | null }>;

    if (error) return null;
    return (data?.status ?? null) as AccessStatus | null;
}

export async function ensureActiveAccess(
    supabase: unknown,
    userId: string,
    user: UserLike
): Promise<{ allowed: boolean; status: AccessStatus | null; isAdmin: boolean }> {
    const isAdmin = await resolveIsAdmin(supabase, user);
    if (isAdmin) {
        return { allowed: true, status: 'active', isAdmin: true };
    }

    const status = await fetchAccessStatus(supabase, userId);
    return { allowed: status === 'active', status, isAdmin: false };
}
````

## File: src/lib/devTools.ts
````typescript
/**
 * @fileoverview Dev-only testing utilities for exam engine
 * @description Provides fast-feedback mechanisms for testing exam flows
 * 
 * CRITICAL: All functions are gated behind process.env.NODE_ENV === 'development'
 * and will no-op in production. This file enables rapid iteration on:
 * - Section transitions
 * - Timer manipulation
 * - State inspection
 * - Final submission testing
 * 
 * @usage URL params: ?dev_mode=true&dev_action=skip_to_section_3
 * @usage Keyboard: Ctrl+Shift+D to toggle DevToolsPanel
 */

import type { SectionName } from '@/types/exam';

// =============================================================================
// DEV MODE DETECTION
// =============================================================================

/**
 * Check if dev mode is enabled via environment
 * CRITICAL: This is the primary gate for all dev features
 */
export const isDevModeEnabled = (): boolean => {
    if (typeof window === 'undefined') return false;
    return process.env.NODE_ENV === 'development';
};

/**
 * Check if dev tools are enabled via URL param
 * Requires both: (1) NODE_ENV=development AND (2) ?dev_mode=true
 */
export const isDevToolsEnabled = (): boolean => {
    if (!isDevModeEnabled()) return false;
    if (typeof window === 'undefined') return false;

    const params = new URLSearchParams(window.location.search);
    return params.get('dev_mode') === 'true';
};

/**
 * Get dev action from URL if specified
 * Example: ?dev_mode=true&dev_action=skip_to_qa
 */
export const getDevAction = (): string | null => {
    if (!isDevToolsEnabled()) return null;
    const params = new URLSearchParams(window.location.search);
    return params.get('dev_action');
};

// =============================================================================
// DEV SYNC CONTROL (CLIENT-SIDE ONLY)
// =============================================================================

const DEV_SYNC_PAUSE_KEY = 'exam-dev-sync-paused';

/**
 * Returns true if server sync is paused (dev-only).
 * Uses sessionStorage to avoid persistence across browser restarts.
 */
export const isDevSyncPaused = (): boolean => {
    if (!isDevModeEnabled()) return false;
    if (typeof window === 'undefined') return false;
    return window.sessionStorage.getItem(DEV_SYNC_PAUSE_KEY) === 'true';
};

/**
 * Pause/resume server sync in dev mode.
 */
export const setDevSyncPaused = (paused: boolean): void => {
    if (!isDevModeEnabled()) return;
    if (typeof window === 'undefined') return;
    window.sessionStorage.setItem(DEV_SYNC_PAUSE_KEY, paused ? 'true' : 'false');
};

// =============================================================================
// DEV ACTION TYPES
// =============================================================================

export type DevAction =
    | 'skip_to_dilr'
    | 'skip_to_qa'
    | 'expire_current_section'
    | 'set_timer_10s'
    | 'set_timer_30s'
    | 'set_timer_60s'
    | 'trigger_auto_submit'
    | 'log_state';

// =============================================================================
// DEV ACTIONS
// =============================================================================

/**
 * Execute a dev action using store actions
 * IMPORTANT: These use REAL store transitions, not direct state mutation
 */
export interface DevActionExecutor {
    expireSection: (sectionName: SectionName) => void;
    moveToNextSection: () => void;
    updateSectionTimer: (sectionName: SectionName, remainingSeconds: number) => void;
    setSectionTimerOverride?: (sectionName: SectionName, remainingSeconds: number) => void;
    setAutoSubmitting: (isAutoSubmitting: boolean) => void;
    getCurrentSectionIndex: () => number;
    getSectionTimers: () => Record<SectionName, { remainingSeconds: number }>;
    getResponses: () => Record<string, unknown>;
    getAttemptId: () => string | null;
}

/**
 * Skip to a specific section by expiring all previous sections
 * Uses REAL section transitions to maintain state consistency
 */
export const skipToSection = (
    targetSectionIndex: number,
    executor: DevActionExecutor
): void => {
    if (!isDevModeEnabled()) {
        console.warn('[DevTools] Blocked: Not in development mode');
        return;
    }

    const currentIndex = executor.getCurrentSectionIndex();
    const sections: SectionName[] = ['VARC', 'DILR', 'QA'];

    console.log(`[DevTools] Skipping from section ${currentIndex} to ${targetSectionIndex}`);

    // Expire and transition through each section until we reach target
    for (let i = currentIndex; i < targetSectionIndex; i++) {
        const sectionToExpire = sections[i];
        console.log(`[DevTools] Expiring section: ${sectionToExpire}`);
        executor.expireSection(sectionToExpire);
        executor.moveToNextSection();
    }

    console.log(`[DevTools] ✓ Now at section ${targetSectionIndex} (${sections[targetSectionIndex]})`);
};

/**
 * Set remaining time for current section
 * Uses updateSectionTimer store action
 */
export const setCurrentSectionTimer = (
    seconds: number,
    executor: DevActionExecutor
): void => {
    if (!isDevModeEnabled()) {
        console.warn('[DevTools] Blocked: Not in development mode');
        return;
    }

    const currentIndex = executor.getCurrentSectionIndex();
    const sections: SectionName[] = ['VARC', 'DILR', 'QA'];
    const currentSection = sections[currentIndex];

    console.log(`[DevTools] Setting ${currentSection} timer to ${seconds}s`);
    const setter = executor.setSectionTimerOverride ?? executor.updateSectionTimer;
    setter(currentSection, seconds);
};

/**
 * Expire the current section immediately
 */
export const expireCurrentSection = (executor: DevActionExecutor): void => {
    if (!isDevModeEnabled()) {
        console.warn('[DevTools] Blocked: Not in development mode');
        return;
    }

    const currentIndex = executor.getCurrentSectionIndex();
    const sections: SectionName[] = ['VARC', 'DILR', 'QA'];
    const currentSection = sections[currentIndex];

    console.log(`[DevTools] Expiring current section: ${currentSection}`);
    executor.expireSection(currentSection);
};

/**
 * Log current exam state to console for debugging
 */
export const logExamState = (executor: DevActionExecutor): void => {
    if (!isDevModeEnabled()) return;

    const state = {
        attemptId: executor.getAttemptId(),
        currentSectionIndex: executor.getCurrentSectionIndex(),
        sectionTimers: executor.getSectionTimers(),
        responsesCount: Object.keys(executor.getResponses()).length,
    };

    console.group('[DevTools] Current Exam State');
    console.log('Attempt ID:', state.attemptId);
    console.log('Current Section:', ['VARC', 'DILR', 'QA'][state.currentSectionIndex]);
    console.log('Section Timers:', state.sectionTimers);
    console.log('Total Responses:', state.responsesCount);
    console.groupEnd();
};

/**
 * Process dev action from URL parameter
 * Called on exam initialization if dev_action param is present
 */
export const processDevActionFromUrl = (executor: DevActionExecutor): void => {
    if (!isDevToolsEnabled()) return;

    const action = getDevAction();
    if (!action) return;

    console.log(`[DevTools] Processing URL action: ${action}`);

    switch (action) {
        case 'skip_to_dilr':
            skipToSection(1, executor);
            break;
        case 'skip_to_qa':
            skipToSection(2, executor);
            break;
        case 'expire_current_section':
            expireCurrentSection(executor);
            break;
        case 'set_timer_10s':
            setCurrentSectionTimer(10, executor);
            break;
        case 'set_timer_30s':
            setCurrentSectionTimer(30, executor);
            break;
        case 'set_timer_60s':
            setCurrentSectionTimer(60, executor);
            break;
        case 'log_state':
            logExamState(executor);
            break;
        default:
            console.warn(`[DevTools] Unknown action: ${action}`);
    }
};

// =============================================================================
// KEYBOARD SHORTCUTS
// =============================================================================

export interface DevKeyboardHandler {
    togglePanel: () => void;
    skipToNextSection: () => void;
    setQuickTimer: () => void;
    logState: () => void;
}

/**
 * Dev keyboard shortcut definitions
 */
export const DEV_SHORTCUTS = {
    TOGGLE_PANEL: { key: 'D', ctrl: true, shift: true }, // Ctrl+Shift+D
    SKIP_SECTION: { key: 'N', ctrl: true, shift: true }, // Ctrl+Shift+N
    QUICK_TIMER: { key: 'T', ctrl: true, shift: true },  // Ctrl+Shift+T (10s)
    LOG_STATE: { key: 'L', ctrl: true, shift: true },    // Ctrl+Shift+L
} as const;

/**
 * Check if a keyboard event matches a shortcut
 */
export const matchesShortcut = (
    event: KeyboardEvent,
    shortcut: { key: string; ctrl: boolean; shift: boolean }
): boolean => {
    return (
        event.key.toUpperCase() === shortcut.key &&
        event.ctrlKey === shortcut.ctrl &&
        event.shiftKey === shortcut.shift
    );
};

/**
 * Create keyboard handler for dev shortcuts
 * Returns cleanup function
 */
export const createDevKeyboardHandler = (handlers: DevKeyboardHandler): (() => void) => {
    if (!isDevModeEnabled()) return () => { };

    const handleKeyDown = (event: KeyboardEvent) => {
        if (matchesShortcut(event, DEV_SHORTCUTS.TOGGLE_PANEL)) {
            event.preventDefault();
            handlers.togglePanel();
        } else if (matchesShortcut(event, DEV_SHORTCUTS.SKIP_SECTION)) {
            event.preventDefault();
            handlers.skipToNextSection();
        } else if (matchesShortcut(event, DEV_SHORTCUTS.QUICK_TIMER)) {
            event.preventDefault();
            handlers.setQuickTimer();
        } else if (matchesShortcut(event, DEV_SHORTCUTS.LOG_STATE)) {
            event.preventDefault();
            handlers.logState();
        }
    };

    window.addEventListener('keydown', handleKeyDown);

    return () => {
        window.removeEventListener('keydown', handleKeyDown);
    };
};

// =============================================================================
// DEV CONSOLE HELPERS (for manual testing in browser console)
// =============================================================================

/**
 * Attach dev helpers to window for console access
 * Usage: window.__devTools.skipToQA()
 */
export const attachDevToolsToWindow = (executor: DevActionExecutor): void => {
    if (!isDevModeEnabled()) return;
    if (typeof window === 'undefined') return;

    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    (window as any).__devTools = {
        skipToDILR: () => skipToSection(1, executor),
        skipToQA: () => skipToSection(2, executor),
        expireSection: () => expireCurrentSection(executor),
        setTimer: (seconds: number) => setCurrentSectionTimer(seconds, executor),
        logState: () => logExamState(executor),
        help: () => {
            console.log(`
[DevTools] Available commands:
  __devTools.skipToDILR()      - Skip to DILR section
  __devTools.skipToQA()        - Skip to QA section  
  __devTools.expireSection()   - Expire current section
  __devTools.setTimer(30)      - Set current section timer to 30s
  __devTools.logState()        - Log current exam state
  __devTools.help()            - Show this help
            `);
        },
    };

    console.log('[DevTools] 🛠️ Dev tools attached to window.__devTools');
    console.log('[DevTools] Type __devTools.help() for available commands');
};
````

## File: src/lib/examDebug.ts
````typescript
/**
 * @fileoverview Exam Debug Utilities
 * @description Dev-only debug logging for exam engine, guarded by EXAM_DEBUG flag
 * @usage Enable by setting NEXT_PUBLIC_EXAM_DEBUG=true in .env.local
 */

// =============================================================================
// CONFIGURATION
// =============================================================================

const EXAM_DEBUG_ENABLED =
    typeof window !== 'undefined' &&
    process.env.NEXT_PUBLIC_EXAM_DEBUG === 'true';

const DEBUG_PREFIX = '[EXAM_DEBUG]';

// =============================================================================
// DEBUG LOGGER
// =============================================================================

/**
 * Exam-specific debug logger that only outputs when EXAM_DEBUG is enabled
 */
export const examDebug = {
    /**
     * Check if debug mode is enabled
     */
    isEnabled(): boolean {
        return EXAM_DEBUG_ENABLED;
    },

    /**
     * Log store initialization details
     */
    storeInit(data: {
        attemptId: string | null;
        storeName: string;
        sessionToken: string | null;
        currentSectionIndex: number;
        currentQuestionIndex: number;
    }): void {
        if (!EXAM_DEBUG_ENABLED) return;
        console.log(
            `${DEBUG_PREFIX} Store initialized`,
            '\n  attemptId:', data.attemptId,
            '\n  storeName:', data.storeName,
            '\n  sessionToken:', data.sessionToken ? `${data.sessionToken.slice(0, 8)}...` : null,
            '\n  section:', data.currentSectionIndex,
            '\n  question:', data.currentQuestionIndex
        );
    },

    /**
     * Log navigation changes
     */
    navigation(data: {
        sectionIndex: number;
        questionIndex: number;
        questionId: string;
    }): void {
        if (!EXAM_DEBUG_ENABLED) return;
        console.log(
            `${DEBUG_PREFIX} Navigation`,
            '\n  section:', data.sectionIndex,
            '\n  question:', data.questionIndex,
            '\n  questionId:', data.questionId
        );
    },

    /**
     * Log response status changes
     */
    responseStatus(data: {
        questionId: string;
        oldStatus: string;
        newStatus: string;
        answer: string | null;
        isMarkedForReview: boolean;
    }): void {
        if (!EXAM_DEBUG_ENABLED) return;
        console.log(
            `${DEBUG_PREFIX} Response status change`,
            '\n  questionId:', data.questionId,
            '\n  status:', data.oldStatus, '→', data.newStatus,
            '\n  hasAnswer:', data.answer !== null && data.answer !== '',
            '\n  isMarked:', data.isMarkedForReview
        );
    },

    /**
     * Log TITA keypad input
     */
    titaInput(data: {
        questionId: string;
        key: string;
        oldValue: string;
        newValue: string;
    }): void {
        if (!EXAM_DEBUG_ENABLED) return;
        console.log(
            `${DEBUG_PREFIX} TITA input`,
            '\n  questionId:', data.questionId,
            '\n  key:', data.key,
            '\n  value:', data.oldValue, '→', data.newValue
        );
    },

    /**
     * Log mark for review action
     */
    markForReview(data: {
        questionId: string;
        hadSavedAnswer: boolean;
        newStatus: string;
        isMarking: boolean;
    }): void {
        if (!EXAM_DEBUG_ENABLED) return;
        console.log(
            `${DEBUG_PREFIX} Mark for Review`,
            '\n  questionId:', data.questionId,
            '\n  hadSavedAnswer:', data.hadSavedAnswer,
            '\n  newStatus:', data.newStatus,
            '\n  isMarking:', data.isMarking
        );
    },

    /**
     * Log submission attempt
     */
    submitAttempt(data: {
        attemptId: string;
        sessionToken: string | null;
        submissionId: string;
        responsesCount: number;
    }): void {
        if (!EXAM_DEBUG_ENABLED) return;
        console.log(
            `${DEBUG_PREFIX} Submit attempt`,
            '\n  attemptId:', data.attemptId,
            '\n  sessionToken:', data.sessionToken ? `${data.sessionToken.slice(0, 8)}...` : null,
            '\n  submissionId:', data.submissionId,
            '\n  responses:', data.responsesCount
        );
    },

    /**
     * Log submission result
     */
    submitResult(data: {
        success: boolean;
        error?: string;
        attemptId: string;
    }): void {
        if (!EXAM_DEBUG_ENABLED) return;
        const level = data.success ? 'log' : 'error';
        console[level](
            `${DEBUG_PREFIX} Submit result`,
            '\n  success:', data.success,
            '\n  error:', data.error ?? 'none',
            '\n  attemptId:', data.attemptId
        );
    },

    /**
     * Log session token operations
     */
    sessionToken(data: {
        operation: 'set' | 'validate' | 'mismatch';
        token: string | null;
        attemptId: string | null;
    }): void {
        if (!EXAM_DEBUG_ENABLED) return;
        console.log(
            `${DEBUG_PREFIX} Session token ${data.operation}`,
            '\n  token:', data.token ? `${data.token.slice(0, 8)}...` : null,
            '\n  attemptId:', data.attemptId
        );
    },

    /**
     * Log localStorage key being used
     */
    localStorage(data: {
        operation: 'read' | 'write' | 'clear';
        key: string;
        attemptId: string | null;
    }): void {
        if (!EXAM_DEBUG_ENABLED) return;
        console.log(
            `${DEBUG_PREFIX} localStorage ${data.operation}`,
            '\n  key:', data.key,
            '\n  attemptId:', data.attemptId
        );
    },

    /**
     * Log resume detection
     */
    resume(data: {
        attemptId: string;
        fromSection: number;
        fromQuestion: number;
        preservedState: boolean;
    }): void {
        if (!EXAM_DEBUG_ENABLED) return;
        console.log(
            `${DEBUG_PREFIX} Resume detection`,
            '\n  attemptId:', data.attemptId,
            '\n  section:', data.fromSection,
            '\n  question:', data.fromQuestion,
            '\n  preservedState:', data.preservedState
        );
    },

    /**
     * Generic debug log
     */
    log(message: string, data?: Record<string, unknown>): void {
        if (!EXAM_DEBUG_ENABLED) return;
        if (data) {
            console.log(`${DEBUG_PREFIX} ${message}`, data);
        } else {
            console.log(`${DEBUG_PREFIX} ${message}`);
        }
    },

    /**
     * Warning log (always shows in debug mode)
     */
    warn(message: string, data?: Record<string, unknown>): void {
        if (!EXAM_DEBUG_ENABLED) return;
        if (data) {
            console.warn(`${DEBUG_PREFIX} ⚠️ ${message}`, data);
        } else {
            console.warn(`${DEBUG_PREFIX} ⚠️ ${message}`);
        }
    },
};

// =============================================================================
// CLEANUP UTILITIES
// =============================================================================

/**
 * Clean up orphaned temp state from localStorage
 * Call this on app startup to prevent ghost bugs
 */
export function cleanupOrphanedExamState(currentAttemptId?: string | null): void {
    if (typeof window === 'undefined') return;

    const tempKey = 'cat-exam-state-temp';
    const tempState = localStorage.getItem(tempKey);
    if (!tempState) return;

    let storedAttemptId: string | null = null;
    try {
        const parsed = JSON.parse(tempState) as { state?: { attemptId?: string | null }; attemptId?: string | null };
        storedAttemptId = parsed?.state?.attemptId ?? parsed?.attemptId ?? null;
    } catch {
        storedAttemptId = null;
    }

    let activeAttemptId: string | null = currentAttemptId ?? null;
    if (!activeAttemptId) {
        const parts = window.location.pathname.split('/');
        activeAttemptId = parts[1] === 'exam' ? (parts[2] ?? null) : null;
    }

    if (activeAttemptId) {
        // Keep temp state if it matches the active attempt or is missing (avoid data loss on refresh).
        if (!storedAttemptId || storedAttemptId === activeAttemptId) return;
        examDebug.warn('Found temp state for different attempt, removing', {
            key: tempKey,
            storedAttemptId,
            activeAttemptId,
        });
        localStorage.removeItem(tempKey);
        return;
    }

    examDebug.warn('Found orphaned temp state, removing', { key: tempKey });
    localStorage.removeItem(tempKey);
}

/**
 * Get all exam-related localStorage keys
 */
export function getExamStorageKeys(): string[] {
    if (typeof window === 'undefined') return [];

    return Object.keys(localStorage).filter(key =>
        key.startsWith('cat-exam-state')
    );
}

/**
 * Clear all exam state from localStorage (for debugging)
 */
export function clearAllExamState(): void {
    if (typeof window === 'undefined') return;

    const keys = getExamStorageKeys();
    keys.forEach(key => {
        examDebug.localStorage({ operation: 'clear', key, attemptId: null });
        localStorage.removeItem(key);
    });

    examDebug.log(`Cleared ${keys.length} exam state keys`);
}
````

## File: src/lib/landing-assets.ts
````typescript
import type { BrowserSupabaseClient } from '@/lib/supabase/client';
import { sb } from '@/lib/supabase/client';
import { uploadToCloudinary } from '@/lib/cloudinary';

type AppSupabaseClient = BrowserSupabaseClient;

export type LandingAsset = {
    key: string;
    storage_path: string | null;
    public_url: string | null;
    alt_text: string | null;
    updated_at: string | null;
    updated_by: string | null;
};

export async function getLandingAssets(client?: AppSupabaseClient): Promise<Record<string, LandingAsset>> {
    const supabase = client ?? sb();
    const { data, error } = await supabase
        .from('landing_assets')
        .select('key, storage_path, public_url, alt_text, updated_at, updated_by');

    if (error) {
        throw error;
    }

    const map: Record<string, LandingAsset> = {};
    const rows = (data ?? []) as LandingAsset[];
    rows.forEach((row) => {
        map[row.key] = row;
    });
    return map;
}

export async function replaceLandingAsset(
    key: string,
    file: File,
    altText: string,
    client?: AppSupabaseClient
): Promise<LandingAsset> {
    const supabase = client ?? sb();

    const publicUrl = await uploadToCloudinary(file);

    const { data: userData } = await supabase.auth.getUser();
    const updatedBy = userData?.user?.id ?? null;

    const { data: upserted, error: upsertError } = await supabase
        .from('landing_assets')
        .upsert(
            {
                key,
                storage_path: null,
                public_url: publicUrl,
                alt_text: altText,
                updated_at: new Date().toISOString(),
                updated_by: updatedBy,
            },
            { onConflict: 'key' }
        )
        .select('key, storage_path, public_url, alt_text, updated_at, updated_by')
        .single();

    if (upsertError) {
        throw upsertError;
    }

    return upserted as LandingAsset;
}
````

## File: src/lib/logger.ts
````typescript
/**
 * @fileoverview Application Logger Utility
 * @description Structured logging with environment-aware log levels
 * @blueprint M6+ Architecture - Logging Protocol
 * 
 * Usage:
 *   import { logger } from '@/lib/logger';
 *   logger.info('Operation completed', { userId, action });
 *   logger.error('Failed to save', { error, context });
 */

// =============================================================================
// CONFIGURATION
// =============================================================================

type LogLevel = 'debug' | 'info' | 'warn' | 'error';

interface LogContext {
    [key: string]: unknown;
}

const LOG_LEVELS: Record<LogLevel, number> = {
    debug: 0,
    info: 1,
    warn: 2,
    error: 3,
};

// Set minimum log level based on environment
const getMinLogLevel = (): LogLevel => {
    const env = process.env.NODE_ENV;
    if (env === 'production') return 'warn'; // Production: only warn and error
    if (env === 'test') return 'error'; // Tests: only errors
    return 'debug'; // Development: all logs
};

const MIN_LOG_LEVEL = getMinLogLevel();

// =============================================================================
// LOGGER IMPLEMENTATION
// =============================================================================

/**
 * Formats a log message with timestamp and context
 */
function formatLogMessage(
    level: LogLevel,
    message: string,
    context?: LogContext
): string {
    const timestamp = new Date().toISOString();
    const prefix = `[${timestamp}] [${level.toUpperCase()}]`;

    if (context && Object.keys(context).length > 0) {
        return `${prefix} ${message} ${JSON.stringify(context)}`;
    }
    return `${prefix} ${message}`;
}

/**
 * Checks if a log level should be output
 */
function shouldLog(level: LogLevel): boolean {
    return LOG_LEVELS[level] >= LOG_LEVELS[MIN_LOG_LEVEL];
}

/**
 * Sanitizes context to remove sensitive data
 */
function sanitizeContext(context?: LogContext): LogContext | undefined {
    if (!context) return undefined;

    const sanitized = { ...context };

    // Remove sensitive fields
    const sensitiveKeys = [
        'password', 'token', 'secret', 'key', 'authorization',
        'cookie', 'session', 'auth', 'credential', 'apiKey',
    ];

    for (const key of Object.keys(sanitized)) {
        if (sensitiveKeys.some(sk => key.toLowerCase().includes(sk))) {
            sanitized[key] = '[REDACTED]';
        }
    }

    return sanitized;
}

/**
 * Main logger object with level-specific methods
 */
export const logger = {
    /**
     * Debug level - Development only, detailed information
     */
    debug(message: string, context?: LogContext): void {
        if (shouldLog('debug')) {
            console.log(formatLogMessage('debug', message, sanitizeContext(context)));
        }
    },

    /**
     * Info level - General operational information
     */
    info(message: string, context?: LogContext): void {
        if (shouldLog('info')) {
            console.log(formatLogMessage('info', message, sanitizeContext(context)));
        }
    },

    /**
     * Warn level - Warning conditions that should be addressed
     */
    warn(message: string, error?: unknown, context?: LogContext): void {
        if (shouldLog('warn')) {
            // Handle case where second arg is context, not error
            if (error && typeof error === 'object' && !('message' in error) && !('stack' in error)) {
                console.warn(formatLogMessage('warn', message, sanitizeContext(error as LogContext)));
            } else {
                const errorDetails = error instanceof Error
                    ? { errorMessage: error.message }
                    : error ? { error } : {};

                console.warn(formatLogMessage('warn', message, {
                    ...sanitizeContext(context),
                    ...errorDetails,
                }));
            }
        }
    },

    /**
     * Error level - Error conditions that need immediate attention
     */
    error(message: string, error?: unknown, context?: LogContext): void {
        if (shouldLog('error')) {
            const errorDetails = error instanceof Error
                ? { errorMessage: error.message, stack: error.stack }
                : { error };

            console.error(formatLogMessage('error', message, {
                ...sanitizeContext(context),
                ...errorDetails,
            }));
        }
    },

    /**
     * Log with explicit level
     */
    log(level: LogLevel, message: string, context?: LogContext): void {
        switch (level) {
            case 'debug': this.debug(message, context); break;
            case 'info': this.info(message, context); break;
            case 'warn': this.warn(message, context); break;
            case 'error': this.error(message, undefined, context); break;
        }
    },
};

// =============================================================================
// SPECIALIZED LOGGERS
// =============================================================================

/**
 * Exam-specific logger with context
 */
export const examLogger = {
    attemptStart(attemptId: string, paperId: string, userId: string): void {
        logger.info('Exam attempt started', { attemptId, paperId, userId });
    },

    questionAnswered(attemptId: string, questionId: string): void {
        logger.debug('Question answered', { attemptId, questionId });
    },

    sectionExpired(attemptId: string, section: string): void {
        logger.info('Section timer expired', { attemptId, section });
    },

    examSubmitted(attemptId: string, score: number): void {
        logger.info('Exam submitted', { attemptId, score });
    },

    examPaused(attemptId: string, success?: boolean, error?: unknown): void {
        if (success === false && error) {
            logger.error('Failed to pause exam', error, { attemptId });
        } else {
            logger.info('Exam paused', { attemptId });
        }
    },

    validationError(operation: string, details: LogContext): void {
        logger.warn(`Validation error in ${operation}`, details);
    },

    securityEvent(event: string, details: LogContext): void {
        logger.warn(`Security event: ${event}`, details);
    },
};

/**
 * Admin-specific logger
 */
export const adminLogger = {
    paperCreated(paperId: string, title: string): void {
        logger.info('Paper created', { paperId, title });
    },

    questionCreated(questionId: string, paperId: string): void {
        logger.info('Question created', { questionId, paperId });
    },

    contextCreated(contextId: string, paperId: string): void {
        logger.info('Context created', { contextId, paperId });
    },

    dataModified(entity: string, action: 'create' | 'update' | 'delete' | 'fetch_error' | 'create_error', details?: LogContext): void {
        if (action.includes('error')) {
            logger.error(`${entity} operation failed`, undefined, { action, ...details });
        } else {
            logger.info(`${entity} ${action}d`, details);
        }
    },
};
````

## File: .nvmrc
````
20
````

## File: next-env.d.ts
````typescript
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
````

## File: scripts/blueprint-guard.mjs
````javascript
#!/usr/bin/env node

/**
 * Blueprint Guard Script
 * Ensures that blueprint anchors are present in code and docs are up to date
 */

import { readFileSync, readdirSync, statSync } from 'fs';
import { join, extname } from 'path';

const BLUEPRINT_FILE = 'docs/BLUEPRINT.md';
const SRC_DIR = 'src';

// Extract anchors from blueprint
function extractAnchors(blueprintContent) {
  const anchorRegex = /## (.+?) \((\w+-\d+)\)/g;
  const anchors = new Set();
  let match;

  while ((match = anchorRegex.exec(blueprintContent)) !== null) {
    anchors.add(match[2]); // Capture the anchor ID
  }

  return anchors;
}

// Find anchor references in code
function findAnchorReferences(dir, anchors) {
  const foundAnchors = new Set();

  function scanDirectory(currentDir) {
    const items = readdirSync(currentDir);

    for (const item of items) {
      const fullPath = join(currentDir, item);
      const stat = statSync(fullPath);

      if (stat.isDirectory() && !item.startsWith('.') && item !== 'node_modules') {
        scanDirectory(fullPath);
      } else if (stat.isFile() && ['.ts', '.tsx', '.js', '.jsx'].includes(extname(item))) {
        const content = readFileSync(fullPath, 'utf8');
        for (const anchor of anchors) {
          if (content.includes(anchor)) {
            foundAnchors.add(anchor);
          }
        }
      }
    }
  }

  scanDirectory(dir);
  return foundAnchors;
}

// Main check
try {
  const blueprintContent = readFileSync(BLUEPRINT_FILE, 'utf8');
  const blueprintAnchors = extractAnchors(blueprintContent);
  const foundAnchors = findAnchorReferences(SRC_DIR, blueprintAnchors);

  const missingAnchors = [...blueprintAnchors].filter(anchor => !foundAnchors.has(anchor));

  if (missingAnchors.length > 0) {
    console.error('❌ Blueprint Guard Failed: Missing anchor references in code:');
    missingAnchors.forEach(anchor => console.error(`  - ${anchor}`));
    process.exit(1);
  } else {
    console.log('✅ Blueprint Guard Passed: All anchors referenced in code');
  }
} catch (error) {
  console.error('❌ Blueprint Guard Error:', error.message);
  process.exit(1);
}
````

## File: scripts/export-vs-codebase.mjs
````javascript
#!/usr/bin/env node
/**
 * export-vs-codebase.mjs
 * 
 * Generates VS_Codebase.md with full repo context while:
 * 1. Excluding exam paper JSON/JSONC files
 * 2. Excluding secrets and sensitive files
 * 3. Adding a REDACTIONS section at the top
 * 
 * Usage: pnpm run export:vs_codebase
 * 
 * This script orchestrates:
 * 1. Secrets scanning (best-effort grep if gitleaks/trufflehog unavailable)
 * 2. Repomix execution with proper ignore patterns
 * 3. Post-processing to add REDACTIONS header
 */

import fs from 'fs';
import path from 'path';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const ROOT_DIR = path.resolve(__dirname, '..');

// Configuration
const CONFIG = {
    outputFile: 'VS_Codebase.md',
    dataDir: 'data',
    tempRepomixConfig: '.repomix-vs-codebase.json',
};

// Secret patterns to scan for (regex patterns)
const SECRET_PATTERNS = [
    { name: 'AWS Access Key', pattern: /AKIA[0-9A-Z]{16}/g },
    { name: 'AWS Secret Key', pattern: /[A-Za-z0-9/+=]{40}/g },
    { name: 'GitHub Token', pattern: /gh[ps]_[A-Za-z0-9]{36,}/g },
    { name: 'Generic API Key', pattern: /['"]?api[_-]?key['"]?\s*[:=]\s*['"][A-Za-z0-9_\-]{20,}['"]/gi },
    { name: 'Generic Secret', pattern: /['"]?secret['"]?\s*[:=]\s*['"][A-Za-z0-9_\-]{20,}['"]/gi },
    { name: 'Private Key', pattern: /-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----/g },
    { name: 'Supabase Key', pattern: /eyJ[A-Za-z0-9_-]{100,}\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+/g },
    { name: 'Bearer Token', pattern: /Bearer\s+[A-Za-z0-9_\-\.]{20,}/g },
];

// Files that should never be included (handled by .gitignore and repomix config)
// NOTE: Patterns moved to repomix config ignore list

/**
 * Run the sanitization script
 */
/**
 * Check if gitleaks or trufflehog is available
 */
function checkSecretsScannerAvailable() {
    try {
        execSync('gitleaks version', { stdio: 'ignore' });
        return 'gitleaks';
    } catch {
        try {
            execSync('trufflehog --version', { stdio: 'ignore' });
            return 'trufflehog';
        } catch {
            return null;
        }
    }
}

/**
 * Run secrets scan using available tool or best-effort grep
 */
function runSecretsCheck() {
    console.log('\n🔍 Step 1: Scanning for secrets...\n');

    const scanner = checkSecretsScannerAvailable();
    const secretsFound = [];

    if (scanner === 'gitleaks') {
        console.log('  Using gitleaks for secrets detection...');
        try {
            execSync('gitleaks detect --source . --no-git', { cwd: ROOT_DIR, stdio: 'pipe' });
        } catch (error) {
            // gitleaks returns non-zero if secrets found
            if (error.stdout) {
                secretsFound.push({ file: 'detected by gitleaks', pattern: error.stdout.toString() });
            }
        }
    } else if (scanner === 'trufflehog') {
        console.log('  Using trufflehog for secrets detection...');
        try {
            execSync('trufflehog filesystem .', { cwd: ROOT_DIR, stdio: 'pipe' });
        } catch (error) {
            if (error.stdout) {
                secretsFound.push({ file: 'detected by trufflehog', pattern: error.stdout.toString() });
            }
        }
    } else {
        console.log('  No dedicated secrets scanner found, using best-effort pattern matching...');
        secretsFound.push(...runPatternBasedSecretsScan());
    }

    if (secretsFound.length > 0) {
        console.log(`\n⚠️  Found ${secretsFound.length} potential secret(s):`);
        secretsFound.forEach(s => console.log(`    - ${s.file}: ${s.pattern}`));
    } else {
        console.log('  ✅ No secrets detected');
    }

    return secretsFound;
}

/**
 * Pattern-based secrets scanning for files that will be included
 */
function runPatternBasedSecretsScan() {
    const secretsFound = [];
    const extensionsToScan = ['.ts', '.tsx', '.js', '.mjs', '.json', '.md', '.sql', '.css'];

    function scanDirectory(dir, relativePath = '') {
        const entries = fs.readdirSync(dir, { withFileTypes: true });

        for (const entry of entries) {
            const fullPath = path.join(dir, entry.name);
            const relPath = path.join(relativePath, entry.name);

            // Skip excluded directories
            if (entry.isDirectory()) {
                if (['node_modules', '.git', '.next', '.export_sanitized', '.venv'].includes(entry.name)) {
                    continue;
                }
                scanDirectory(fullPath, relPath);
                continue;
            }

            // Skip non-scannable files
            const ext = path.extname(entry.name).toLowerCase();
            if (!extensionsToScan.includes(ext)) continue;

            // Skip env files
            if (entry.name.startsWith('.env')) continue;

            try {
                const content = fs.readFileSync(fullPath, 'utf-8');

                for (const { name, pattern } of SECRET_PATTERNS) {
                    const matches = content.match(pattern);
                    if (matches) {
                        // Filter out false positives (common patterns that aren't secrets)
                        const filtered = matches.filter(m => {
                            // Skip if it's a placeholder or example
                            if (m.includes('EXAMPLE') || m.includes('PLACEHOLDER') || m.includes('YOUR_')) return false;
                            // Skip if it's in a comment about secrets
                            if (m.includes('secret') && m.includes('//')) return false;
                            // Skip JWT-like patterns that are clearly not real (too short)
                            if (name === 'Supabase Key' && m.length < 150) return false;
                            return true;
                        });

                        if (filtered.length > 0) {
                            secretsFound.push({
                                file: relPath,
                                pattern: name,
                                count: filtered.length
                            });
                        }
                    }
                }
            } catch {
                // Skip files that can't be read
            }
        }
    }

    scanDirectory(ROOT_DIR);
    return secretsFound;
}

/**
 * Create temporary Repomix config
 */
function createRepomixConfig() {
    console.log('\n⚙️  Step 2: Creating Repomix configuration...\n');

    const config = {
        output: {
            filePath: CONFIG.outputFile,
            style: 'markdown',
            headerText: '', // Will be added in post-processing
            showLineNumbers: false,
        },
        ignore: {
            customPatterns: [
                // Exclude ALL exam paper JSON/JSONC files from data/
                'data/*.json',
                'data/*.jsonc',
                // Exclude sanitized data as well
                'data_sanitized/*.json',
                'data_sanitized/*.jsonc',
                // Secret files
                '.env',
                '.env.*',
                '.env.local',
                '.env.*.local',
                '*.pem',
                '*.key',
                '*.p12',
                '*.pfx',
                'id_rsa*',
                // Build artifacts
                '.next/**',
                'node_modules/**',
                '.venv/**',
                // Temp files
                '.export_sanitized/**',
                '.export_tmp/**',
                '.repomix-vs-codebase.json',
                // Output file
                'VS_Codebase.md',
            ],
        },
        include: [
            '**/*',
            // Only include the schema template from schemas/
            'schemas/paper_schema_v3.json',
        ],
    };

    const configPath = path.join(ROOT_DIR, CONFIG.tempRepomixConfig);
    fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
    console.log(`  Created: ${CONFIG.tempRepomixConfig}`);

    return configPath;
}

/**
 * Run Repomix to generate the codebase export
 */
function runRepomix(configPath) {
    console.log('\n📦 Step 3: Running Repomix...\n');

    try {
        execSync(`npx repomix --config "${configPath}"`, {
            cwd: ROOT_DIR,
            stdio: 'inherit',
            encoding: 'utf-8'
        });
        return true;
    } catch (error) {
        console.error('❌ Repomix failed:', error.message);
        return false;
    }
}

/**
 * Get list of redacted files and what was redacted
 */
function getRedactionsList() {
    const redactions = [];

    // List all question paper JSON files that are excluded
    const dataDir = path.join(ROOT_DIR, CONFIG.dataDir);
    if (fs.existsSync(dataDir)) {
        const files = fs.readdirSync(dataDir).filter(f => f.endsWith('.json') || f.endsWith('.jsonc'));
        for (const file of files) {
            redactions.push({
                file: `data/${file}`,
                redacted: 'Entire file excluded',
                reason: 'Question paper content - contains actual exam questions and answers',
            });
        }
    }

    // Note about schema inclusion
    redactions.push({
        file: 'schemas/paper_schema_v3.json',
        redacted: 'INCLUDED (not redacted)',
        reason: 'Schema template showing data structure without actual exam content',
    });

    // Add standard exclusions
    redactions.push({
        file: '.env, .env.local, .env.*.local',
        redacted: 'All content',
        reason: 'Environment files may contain secrets (API keys, database credentials)',
    });

    return redactions;
}

/**
 * Add header with REDACTIONS section to the output file
 */
function addRedactionsHeader() {
    console.log('\n✏️  Step 4: Adding REDACTIONS header...\n');

    const outputPath = path.join(ROOT_DIR, CONFIG.outputFile);

    if (!fs.existsSync(outputPath)) {
        console.error(`❌ Output file not found: ${CONFIG.outputFile}`);
        return false;
    }

    const content = fs.readFileSync(outputPath, 'utf-8');
    const redactions = getRedactionsList();
    const timestamp = new Date().toISOString();

    const header = `# VS_Codebase.md

## Generation Info

- **Repository**: cat_website_execution
- **Generated**: ${timestamp}
- **Command**: \`pnpm run export:vs_codebase\`

## REDACTIONS

The following content has been intentionally redacted from this export:

| File Path | What Was Redacted | Reason |
|-----------|-------------------|--------|
${redactions.map(r => `| ${r.file} | ${r.redacted} | ${r.reason} |`).join('\n')}

### Notes on Exam Paper JSON/JSONC

Exam paper JSON/JSONC files from \`/data\` are excluded entirely from this export.
Only the schema template is included for reference.

---

`;

    // Find where the actual repomix content starts and prepend our header
    // Repomix typically starts with "# " or similar
    const newContent = header + content;

    fs.writeFileSync(outputPath, newContent);
    console.log(`  ✅ Added REDACTIONS header to ${CONFIG.outputFile}`);

    return true;
}

/**
 * Run post-pass to redact any remaining secrets in output
 */
function runPostPassRedaction() {
    console.log('\n🔒 Step 5: Running post-pass redaction...\n');

    const outputPath = path.join(ROOT_DIR, CONFIG.outputFile);
    let content = fs.readFileSync(outputPath, 'utf-8');
    let redactedCount = 0;

    // Patterns that look like real secrets (not examples)
    const postPassPatterns = [
        { pattern: /eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+/g, name: 'JWT Token' },
        { pattern: /sk_live_[A-Za-z0-9]{24,}/g, name: 'Stripe Live Key' },
        { pattern: /sk_test_[A-Za-z0-9]{24,}/g, name: 'Stripe Test Key' },
        { pattern: /AKIA[0-9A-Z]{16}/g, name: 'AWS Access Key' },
    ];

    for (const { pattern, name } of postPassPatterns) {
        const matches = content.match(pattern);
        if (matches) {
            content = content.replace(pattern, '<REDACTED_SECRET>');
            redactedCount += matches.length;
            console.log(`  Redacted ${matches.length} ${name}(s)`);
        }
    }

    if (redactedCount > 0) {
        fs.writeFileSync(outputPath, content);
        console.log(`  ✅ Redacted ${redactedCount} potential secret(s)`);
    } else {
        console.log('  ✅ No additional secrets found in output');
    }

    return true;
}

/**
 * Cleanup temporary files
 */
function cleanup() {
    console.log('\n🧹 Step 6: Cleanup...\n');

    const configPath = path.join(ROOT_DIR, CONFIG.tempRepomixConfig);
    if (fs.existsSync(configPath)) {
        fs.unlinkSync(configPath);
        console.log(`  Removed: ${CONFIG.tempRepomixConfig}`);
    }

    // No temp directories to keep
}

/**
 * Verify the output
 */
function verifyOutput() {
    console.log('\n✅ Step 7: Verification...\n');

    const outputPath = path.join(ROOT_DIR, CONFIG.outputFile);

    if (!fs.existsSync(outputPath)) {
        console.error(`  ❌ Output file not found: ${CONFIG.outputFile}`);
        return false;
    }

    const stats = fs.statSync(outputPath);
    const sizeKB = (stats.size / 1024).toFixed(1);
    const sizeMB = (stats.size / (1024 * 1024)).toFixed(2);

    console.log(`  📄 Output: ${CONFIG.outputFile}`);
    console.log(`  📏 Size: ${sizeKB} KB (${sizeMB} MB)`);

    // Quick content verification
    const content = fs.readFileSync(outputPath, 'utf-8');

    // Check for REDACTIONS section
    if (!content.includes('## REDACTIONS')) {
        console.error('  ❌ REDACTIONS section missing');
        return false;
    }
    console.log('  ✅ REDACTIONS section present');

    // Check that no actual .env values leaked (look for actual key=value patterns with real values)
    // We check for patterns like KEY=eyJ... or KEY="actual-long-value"
    const envValuePatterns = [
        /SUPABASE_SERVICE_ROLE_KEY=eyJ[A-Za-z0-9_\-\.]+/,
        /NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ[A-Za-z0-9_\-\.]+/,
        /SUPABASE_URL=https:\/\/[a-z0-9]+\.supabase\.co/,
    ];

    let envLeakDetected = false;
    for (const pattern of envValuePatterns) {
        if (pattern.test(content)) {
            console.error(`  ❌ Environment variable value detected: ${pattern.source}`);
            envLeakDetected = true;
        }
    }

    if (!envLeakDetected) {
        console.log('  ✅ No environment variable values leaked');
    } else {
        return false;
    }

    // Check that sanitized data is used (look for placeholders)
    if (content.includes('paper_schema_v3.json')) {
        console.log('  ✅ Schema file included');
    } else {
        console.log('  ⚠️  Schema file not found in output');
    }

    // Check that question paper files are NOT included
    const questionPaperPatterns = [
        'CAT-2023-Slot',
        'CAT-2024-Slot',
        'CAT-2025-Slot',
        'cat-2024-mock',
        'sample-paper-template',
    ];
    for (const pattern of questionPaperPatterns) {
        if (content.includes(pattern) && !content.includes('REDACTIONS')) {
            // Check if it's just in the redactions table
            const afterRedactions = content.split('---')[1] || '';
            if (afterRedactions.includes(pattern)) {
                console.log(`  ⚠️  Found '${pattern}' in output - may be a reference only`);
            }
        }
    }

    return true;
}

/**
 * Main orchestration
 */
async function main() {
    console.log('═'.repeat(60));
    console.log('  VS_Codebase.md Export Tool');
    console.log('═'.repeat(60));
    console.log();

    const startTime = Date.now();

    // Step 1: Secrets check
    const secretsFound = runSecretsCheck();
    if (secretsFound.length > 0) {
        console.log('\n⚠️  Secrets were detected. Review the findings above.');
        console.log('   Continuing with export (secrets will be excluded via ignore patterns)...');
    }

    // Step 2: Create Repomix config
    const configPath = createRepomixConfig();

    // Step 3: Run Repomix
    if (!runRepomix(configPath)) {
        process.exit(1);
    }

    // Step 4: Add REDACTIONS header
    if (!addRedactionsHeader()) {
        process.exit(1);
    }

    // Step 5: Post-pass redaction
    runPostPassRedaction();

    // Step 6: Cleanup
    cleanup();

    // Step 7: Verify
    const verified = verifyOutput();

    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

    console.log();
    console.log('═'.repeat(60));
    if (verified) {
        console.log(`  ✅ Export complete! (${elapsed}s)`);
        console.log(`  📄 Output: ${CONFIG.outputFile}`);
        console.log();
        console.log('  Next steps:');
        console.log('  1. Review VS_Codebase.md for any remaining sensitive content');
        console.log('  2. Copy contents to your Word document');
        console.log('  3. Upload with your GOA plan to ChatGPT');
    } else {
        console.log(`  ❌ Export completed with warnings (${elapsed}s)`);
        console.log('  Please review the output manually.');
    }
    console.log('═'.repeat(60));

    process.exit(verified ? 0 : 1);
}

main().catch(error => {
    console.error('Fatal error:', error);
    process.exit(1);
});
````

## File: scripts/parse-md-to-v3.mjs
````javascript
#!/usr/bin/env node
/**
 * @fileoverview Markdown to Schema v3.0 JSON Parser
 * @description Parses custom markdown format CAT papers to v3.0 JSON schema
 * @usage node scripts/parse-md-to-v3.mjs <input.md> [output.json]
 */

import { readFileSync, writeFileSync } from 'fs';
import { validatePaperSchema } from './ajv-validator.mjs';

// =============================================================================
// YAML FRONTMATTER PARSER
// =============================================================================

function parseYamlFrontmatter(content) {
    // Handle escaped format (with backslashes) and regular format
    let yamlMatch = content.match(/^(?:YAML\s*\n)?\\?---\s*([\s\S]*?)\\?---/);
    if (!yamlMatch) {
        throw new Error('No YAML frontmatter found');
    }

    const yamlContent = yamlMatch[1];
    const paper = {};
    const lines = yamlContent.split('\n');

    let currentKey = null;
    let inArray = false;
    let arrayItems = [];

    for (let line of lines) {
        // Clean up escaped underscores and backslashes
        line = line.replace(/\\_/g, '_').replace(/\\\*/g, '*').trim();

        if (!line || line.startsWith('#')) continue;

        // Array item
        if (line.startsWith('- ') || line.startsWith('\\- ')) {
            const item = line.replace(/^\\?-\s*/, '').trim();
            if (item.includes(':')) {
                // Object in array like "section: VARC"
                const [k, v] = item.split(':').map(s => s.trim());
                if (inArray && currentKey === 'sections') {
                    // For sections array with objects, extract section name
                    if (k === 'section') {
                        arrayItems.push(v);
                    }
                }
            } else {
                arrayItems.push(item);
            }
            continue;
        }

        // Key-value pair
        const kvMatch = line.match(/^([a-z_]+):\s*(.*)$/i);
        if (kvMatch) {
            // Save previous array if any
            if (inArray && currentKey) {
                paper[currentKey] = arrayItems;
                arrayItems = [];
                inArray = false;
            }

            currentKey = kvMatch[1].toLowerCase();
            let value = kvMatch[2].trim();

            // Remove quotes
            value = value.replace(/^["']|["']$/g, '');

            if (!value) {
                // Check if next line starts array
                inArray = true;
                arrayItems = [];
            } else {
                // Parse value type
                if (value === 'true') paper[currentKey] = true;
                else if (value === 'false') paper[currentKey] = false;
                else if (/^\d+$/.test(value)) paper[currentKey] = parseInt(value, 10);
                else if (/^\d+\.\d+$/.test(value)) paper[currentKey] = parseFloat(value);
                else paper[currentKey] = value;
            }
        }
    }

    // Save last array if any
    if (inArray && currentKey) {
        paper[currentKey] = arrayItems;
    }

    return paper;
}

// =============================================================================
// MARKDOWN CONTENT PARSER
// =============================================================================

function cleanText(text) {
    if (!text) return '';
    return text
        .replace(/\\_/g, '_')
        .replace(/\\\*/g, '*')
        .replace(/\\#/g, '#')
        .replace(/\\\[/g, '[')
        .replace(/\\\]/g, ']')
        .replace(/\\-/g, '-')
        .replace(/\\\(/g, '(')
        .replace(/\\\)/g, ')')
        .trim();
}

function parseSetBlock(block) {
    const set = {};
    const lines = block.split('\n');

    let contextBodyLines = [];
    let inContextBody = false;

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // Check for key: value pattern
        const kvMatch = line.match(/^([a-z_]+):\s*(.*)$/i);

        if (kvMatch && !inContextBody) {
            const key = cleanText(kvMatch[1]).toLowerCase();
            let value = cleanText(kvMatch[2]).trim();

            // Remove quotes
            value = value.replace(/^["']|["']$/g, '');

            if (key === 'context_body') {
                if (value === '|' || value === '' || value === '""') {
                    inContextBody = true;
                    continue;
                } else {
                    set[key] = value;
                }
            } else if (key === 'display_order') {
                set[key] = parseInt(value, 10);
            } else if (key === 'metadata') {
                // Skip metadata for now, handle separately if needed
            } else if (key === 'source_pages') {
                // Skip
            } else {
                set[key] = value;
            }
        } else if (inContextBody) {
            // Check if this line starts a new field
            if (/^[a-z_]+:\s*/i.test(line) && !line.startsWith('  ')) {
                inContextBody = false;
                i--; // Re-process this line
            } else {
                contextBodyLines.push(cleanText(line));
            }
        }
    }

    if (contextBodyLines.length > 0) {
        set.context_body = contextBodyLines.join('\n').trim();
    }

    return set;
}

function parseQuestionBlock(block, currentSetId) {
    const question = {};
    const lines = block.split('\n');

    let questionTextLines = [];
    let solutionLines = [];
    let inQuestionText = false;
    let inOptions = false;
    let inSolution = false;
    let currentOptions = [];

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        const cleanLine = cleanText(line);

        // Check for option lines first (they may look like key: value)
        // Pattern: "  A: text" or "A: text" or "  A: "text""
        const optionMatch = cleanLine.match(/^\s*([A-D]):\s*(.+)$/i);
        if (optionMatch && inOptions) {
            let optText = optionMatch[2].replace(/^["']|["']$/g, '').trim();
            currentOptions.push({
                id: optionMatch[1].toUpperCase(),
                text: optText
            });
            continue;
        }

        // Check for key: value pattern
        const kvMatch = cleanLine.match(/^([a-z_]+):\s*(.*)$/i);

        if (kvMatch) {
            const key = kvMatch[1].toLowerCase();
            let value = kvMatch[2].trim();

            // End any multi-line sections
            if (inQuestionText && key !== 'question_text') {
                question.question_text = questionTextLines.join('\n').trim();
                questionTextLines = [];
                inQuestionText = false;
            }
            if (inOptions && key !== 'options' && !['a', 'b', 'c', 'd'].includes(key)) {
                inOptions = false;
            }
            if (inSolution && key !== 'solution_text') {
                question.solution_text = solutionLines.join('\n').trim();
                solutionLines = [];
                inSolution = false;
            }

            // Remove quotes
            value = value.replace(/^["']|["']$/g, '');

            switch (key) {
                case 'client_question_id':
                    question.client_question_id = value;
                    break;
                case 'question_number':
                    question.question_number = parseInt(value, 10);
                    break;
                case 'sequence_order':
                    question.sequence_order = parseInt(value, 10);
                    break;
                case 'question_type':
                    question.question_type = value.toUpperCase();
                    break;
                case 'question_text':
                    if (value === '|' || value === '') {
                        inQuestionText = true;
                    } else {
                        question.question_text = value;
                    }
                    break;
                case 'options':
                    inOptions = true;
                    break;
                case 'a':
                case 'b':
                case 'c':
                case 'd':
                    // Option in key: value format
                    currentOptions.push({
                        id: key.toUpperCase(),
                        text: value
                    });
                    break;
                case 'correct_answer':
                    question.correct_answer = value.replace(/^["']|["']$/g, '');
                    break;
                case 'topic':
                    question.topic = value;
                    break;
                case 'subtopic':
                    question.subtopic = value;
                    break;
                case 'difficulty':
                    // Normalize difficulty values
                    let diff = value.toLowerCase();
                    if (diff === 'difficult') diff = 'hard';
                    question.difficulty = diff;
                    break;
                case 'solution_text':
                    if (value === '|' || value === '') {
                        inSolution = true;
                    } else {
                        question.solution_text = value;
                    }
                    break;
                case 'scoring':
                case 'negative_marks':
                case 'positive_marks':
                    if (key === 'negative_marks' && value === '0') {
                        question.negative_marks = 0;
                    }
                    break;
                case 'difficulty_rationale':
                    question.difficulty_rationale = value;
                    break;
            }
        } else if (inQuestionText) {
            questionTextLines.push(cleanLine);
        } else if (inOptions) {
            // Parse option lines like "A: "text"" or "A: text" with leading whitespace
            const optMatch = cleanLine.match(/^\s*([A-D]):\s*(.+)$/i);
            if (optMatch) {
                let optText = optMatch[2].replace(/^["']|["']$/g, '').trim();
                currentOptions.push({
                    id: optMatch[1].toUpperCase(),
                    text: optText
                });
            }
        } else if (inSolution) {
            solutionLines.push(cleanLine);
        }
    }

    // Finalize multi-line fields
    if (inQuestionText && questionTextLines.length > 0) {
        question.question_text = questionTextLines.join('\n').trim();
    }
    if (inSolution && solutionLines.length > 0) {
        question.solution_text = solutionLines.join('\n').trim();
    }
    if (currentOptions.length > 0) {
        question.options = currentOptions;
    }

    // Set the set_ref
    question.set_ref = currentSetId;

    return question;
}

function parseMarkdownContent(content, _paperMeta) {
    const question_sets = [];
    const questions = [];

    // Remove YAML frontmatter
    content = content.replace(/^(?:YAML\s*\n)?\\?---[\s\S]*?\\?---/, '');

    // Clean the content
    content = cleanText(content);

    // Split by section headers
    let currentSection = null;
    let currentSetId = null;
    let setDisplayOrder = 0;

    // Split content into blocks
    const blocks = content.split(/(?=^#{1,3}\s)/m);

    for (const block of blocks) {
        const trimmedBlock = block.trim();
        if (!trimmedBlock) continue;

        // Check for section header
        const sectionMatch = trimmedBlock.match(/^#\s*\*{0,2}Section:\s*(\w+)/i);
        if (sectionMatch) {
            currentSection = sectionMatch[1].toUpperCase();
            // Normalize LRDI to DILR
            if (currentSection === 'LRDI') currentSection = 'DILR';
            continue;
        }

        // Check for SET block
        if (/^#{1,2}\s*\*{0,2}SET\*{0,2}/i.test(trimmedBlock)) {
            setDisplayOrder++;
            const setData = parseSetBlock(trimmedBlock);

            // Normalize section
            if (setData.section === 'LRDI') setData.section = 'DILR';

            // Use parsed section or current section
            if (!setData.section && currentSection) {
                setData.section = currentSection;
            }

            // Ensure display_order
            if (!setData.display_order) {
                setData.display_order = setDisplayOrder;
            }

            // Normalize client_set_id
            if (setData.client_set_id) {
                setData.client_set_id = setData.client_set_id.toUpperCase().replace(/-/g, '_');
            }

            // Set defaults
            if (!setData.set_type) setData.set_type = 'ATOMIC';
            if (!setData.content_layout) setData.content_layout = 'single_focus';
            if (setData.context_body === '' || setData.context_body === '""') {
                delete setData.context_body;
            }

            currentSetId = setData.client_set_id;
            question_sets.push(setData);
            continue;
        }

        // Check for QUESTION block
        if (/^#{2,3}\s*\*{0,2}QUESTION\*{0,2}/i.test(trimmedBlock)) {
            if (!currentSetId) {
                console.warn('Warning: Question without a SET, skipping');
                continue;
            }

            const questionData = parseQuestionBlock(trimmedBlock, currentSetId);

            // Add section from current set
            const currentSet = question_sets.find(s => s.client_set_id === currentSetId);
            if (currentSet) {
                questionData.section = currentSet.section;
            }

            // Normalize client_question_id
            if (questionData.client_question_id) {
                questionData.client_question_id = questionData.client_question_id.replace(/-/g, '_');
            }

            questions.push(questionData);
        }
    }

    return { question_sets, questions };
}

// =============================================================================
// POST-PROCESSING & VALIDATION
// =============================================================================

function postProcess(paper, question_sets, questions) {
    // Normalize paper fields
    // Ensure sections is a simple array of strings
    if (paper.sections && !Array.isArray(paper.sections)) {
        paper.sections = [paper.sections];
    }

    // If sections were parsed incorrectly, extract them from question_sets
    const sectionsFromSets = [...new Set(question_sets.map(s => s.section).filter(Boolean))];
    if (!paper.sections || paper.sections.length === 0 || paper.sections.length < sectionsFromSets.length) {
        // Normalize LRDI to DILR
        paper.sections = sectionsFromSets.map(s => s === 'LRDI' ? 'DILR' : s);
    } else {
        paper.sections = paper.sections.map(s => {
            if (typeof s === 'object') return s.section || s;
            return s;
        }).filter(Boolean);

        // Normalize LRDI to DILR
        paper.sections = paper.sections.map(s => s === 'LRDI' ? 'DILR' : s);
    }

    // Ensure standard CAT sections order
    const sectionOrder = ['VARC', 'DILR', 'QA'];
    paper.sections = sectionOrder.filter(s => paper.sections.includes(s));

    // Ensure required paper fields
    if (!paper.schema_version) paper.schema_version = 'v3.0';
    if (!paper.duration_minutes) paper.duration_minutes = 120;
    if (paper.default_positive_marks === undefined) paper.default_positive_marks = 3;
    if (paper.default_negative_marks === undefined) paper.default_negative_marks = 1;

    // Clean paper fields
    delete paper.schema_version; // Will be top-level
    delete paper.version_number;
    delete paper.source_pdf;
    delete paper.import_notes;
    delete paper.availability;
    delete paper.ingestion;
    delete paper.display_order; // Remove unwanted field from sections parsing
    delete paper.question_count; // Remove unwanted field from sections parsing

    // Fix question sets
    for (const set of question_sets) {
        // Ensure VARC/DILR/CASELET sets have context_body
        if (['VARC', 'DILR', 'CASELET'].includes(set.set_type)) {
            if (!set.context_body || set.context_body.trim() === '') {
                // Downgrade to ATOMIC if no context
                set.set_type = 'ATOMIC';
            }
        }

        // Clean up
        delete set.metadata;
        delete set.context_type;
        if (set.context_body === '' || set.context_body === 'none') {
            delete set.context_body;
        }
    }

    // Fix questions
    let questionNum = 0;
    for (const q of questions) {
        questionNum++;

        // Ensure question_number
        if (!q.question_number) {
            q.question_number = questionNum;
        }

        // Ensure sequence_order
        if (!q.sequence_order) {
            q.sequence_order = 1;
        }

        // Ensure client_question_id
        if (!q.client_question_id) {
            q.client_question_id = `Q${q.question_number}`;
        }

        // Clean question text
        if (q.question_text) {
            q.question_text = q.question_text.trim();
        }

        // Ensure MCQ has options
        if (q.question_type === 'MCQ' && (!q.options || q.options.length === 0)) {
            console.warn(`Warning: MCQ question ${q.client_question_id} has no options`);
        }

        // Clean empty solution text
        if (q.solution_text === '' || q.solution_text === '""') {
            delete q.solution_text;
        }

        // Ensure correct_answer format
        if (q.correct_answer) {
            q.correct_answer = String(q.correct_answer).replace(/^["']|["']$/g, '');
        }
    }

    // Update total_questions
    paper.total_questions = questions.length;

    return { paper, question_sets, questions };
}

function validateOutput(data) {
    const errors = [];

    // Check schema version
    if (data.schema_version !== 'v3.0') {
        errors.push(`schema_version must be 'v3.0'`);
    }

    // Check paper
    if (!data.paper.slug) errors.push('paper.slug is required');
    if (!data.paper.title) errors.push('paper.title is required');

    // Check sets
    const setIds = new Set();
    for (const set of data.question_sets) {
        if (!set.client_set_id) {
            errors.push('question_set missing client_set_id');
        } else if (setIds.has(set.client_set_id)) {
            errors.push(`Duplicate client_set_id: ${set.client_set_id}`);
        } else {
            setIds.add(set.client_set_id);
        }

        if (!set.section) errors.push(`Set ${set.client_set_id} missing section`);
        if (!set.set_type) errors.push(`Set ${set.client_set_id} missing set_type`);
        if (set.display_order === undefined) errors.push(`Set ${set.client_set_id} missing display_order`);
    }

    // Check questions
    const questionIds = new Set();
    for (const q of data.questions) {
        if (!q.client_question_id) {
            errors.push('question missing client_question_id');
        } else if (questionIds.has(q.client_question_id)) {
            errors.push(`Duplicate client_question_id: ${q.client_question_id}`);
        } else {
            questionIds.add(q.client_question_id);
        }

        if (!q.set_ref) {
            errors.push(`Question ${q.client_question_id} missing set_ref`);
        } else if (!setIds.has(q.set_ref)) {
            errors.push(`Question ${q.client_question_id} references non-existent set: ${q.set_ref}`);
        }

        if (!q.question_text) errors.push(`Question ${q.client_question_id} missing question_text`);
        if (!q.question_type) errors.push(`Question ${q.client_question_id} missing question_type`);

        if (q.question_type === 'MCQ' && (!q.options || q.options.length < 2)) {
            errors.push(`MCQ question ${q.client_question_id} needs at least 2 options`);
        }
    }

    return errors;
}

function formatAjvErrors(errors = []) {
    return errors.map((err) => {
        const path = err.instancePath || '(root)';
        const message = err.message || err.keyword || 'schema validation error';
        return `${path} ${message}`.trim();
    });
}

// =============================================================================
// MAIN
// =============================================================================

function main() {
    const args = process.argv.slice(2);

    if (args.length === 0 || args.includes('--help') || args.includes('-h')) {
        console.log(`
Usage: node scripts/parse-md-to-v3.mjs <input.md> [output.json]

Parses custom markdown format CAT papers to v3.0 JSON schema.

Arguments:
  input.md      Path to the markdown file to parse
  output.json   Optional output path (default: same name with .json extension)

Options:
  --help, -h    Show this help message
`);
        process.exit(0);
    }

    const inputPath = args[0];
    const outputPath = args[1] || inputPath.replace(/\.md$/i, '.json');

    console.log(`📖 Reading: ${inputPath}`);
    const content = readFileSync(inputPath, 'utf-8');

    console.log('📋 Parsing YAML frontmatter...');
    const paperMeta = parseYamlFrontmatter(content);

    console.log('📝 Parsing markdown content...');
    const { question_sets, questions } = parseMarkdownContent(content, paperMeta);

    console.log(`   Found ${question_sets.length} question sets`);
    console.log(`   Found ${questions.length} questions`);

    console.log('🔧 Post-processing...');
    const processed = postProcess(paperMeta, question_sets, questions);

    const output = {
        schema_version: 'v3.0',
        paper: processed.paper,
        question_sets: processed.question_sets,
        questions: processed.questions
    };

    console.log('✅ Validating output (custom + AJV)...');
    const errors = validateOutput(output);
    const ajvResult = validatePaperSchema(output);
    const ajvErrors = ajvResult.valid ? [] : formatAjvErrors(ajvResult.errors);
    const allErrors = [...errors, ...ajvErrors];

    if (errors.length > 0) {
        console.error('❌ Custom validation errors:');
        errors.forEach(e => console.error(`   - ${e}`));
        console.error('');
    }

    if (ajvErrors.length > 0) {
        console.error('❌ AJV schema validation errors:');
        ajvErrors.forEach(e => console.error(`   - ${e}`));
        console.error('');
    }

    if (allErrors.length > 0) {
        console.log('⚠️  Writing output anyway for debugging...');
    } else {
        console.log('✅ Validation passed!');
    }

    console.log(`💾 Writing: ${outputPath}`);
    writeFileSync(outputPath, JSON.stringify(output, null, 2), 'utf-8');

    // Summary
    console.log('');
    console.log('📊 Summary:');
    console.log(`   Paper: ${output.paper.title}`);
    console.log(`   Slug: ${output.paper.slug}`);
    console.log(`   Year: ${output.paper.year}`);
    console.log(`   Questions: ${output.questions.length}`);
    console.log(`   Question Sets: ${output.question_sets.length}`);
    console.log(`   Sections: ${output.paper.sections?.join(', ') || 'N/A'}`);

    // Question type breakdown
    const mcqCount = output.questions.filter(q => q.question_type === 'MCQ').length;
    const titaCount = output.questions.filter(q => q.question_type === 'TITA').length;
    console.log(`   MCQ: ${mcqCount}, TITA: ${titaCount}`);

    if (allErrors.length > 0) {
        process.exit(1);
    }
}

main();
````

## File: src/app/admin/contexts/new/page.tsx
````typescript
/**
 * @fileoverview New Context Page (Deprecated)
 * @description Deprecated after sets-first authoring. Redirects to question sets.
 */

import { redirect } from 'next/navigation';

export default function NewContextPage() {
    redirect('/admin/question-sets');
}
````

## File: src/app/admin/contexts/page.tsx
````typescript
/**
 * @fileoverview Contexts List Page (Deprecated)
 * @description Deprecated after sets-first authoring. Redirects to question sets.
 */

import { redirect } from 'next/navigation';

export default function ContextsPage() {
    redirect('/admin/question-sets');
}
````

## File: src/app/admin/landing-page/LandingAssetsClient.tsx
````typescript
'use client';

import { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import Image from 'next/image';
import { getLandingAssets, replaceLandingAsset, type LandingAsset } from '@/lib/landing-assets';
import { sb } from '@/lib/supabase/client';

type ToastKind = 'success' | 'error' | 'info';

const MAX_FILE_SIZE_MB = 2;
const ACCEPTED_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/avif'];

const ASSET_CATALOG: Array<{ key: string; label: string; hint?: string }> = [
    {
        key: 'hero_mock_ui',
        label: 'Hero carousel: Mock UI',
        hint: 'Crop/blur the CAT 2025 title area or upload a lower crop.',
    },
    {
        key: 'hero_mirror_view',
        label: 'Hero carousel: Mirror View',
        hint: 'Mirror analytics screenshot.',
    },
    { key: 'mentor_photo', label: 'Mentor spotlight photo' },
    { key: 'feature_exam_ui', label: 'Feature: Exam UI' },
    { key: 'feature_analytics', label: 'Feature: Analytics' },
    { key: 'rag_demo_1', label: 'RAG demo 1' },
    { key: 'rag_demo_2', label: 'RAG demo 2' },
    { key: 'rag_demo_3', label: 'RAG demo 3' },
    { key: 'rag_demo_4', label: 'RAG demo 4' },
    { key: 'rag_demo_5', label: 'RAG demo 5' },
];

function formatBytes(bytes: number): string {
    if (bytes < 1024) return `${bytes} B`;
    const kb = bytes / 1024;
    if (kb < 1024) return `${kb.toFixed(1)} KB`;
    return `${(kb / 1024).toFixed(1)} MB`;
}

function isValidFile(file: File): { ok: boolean; message?: string } {
    if (!ACCEPTED_TYPES.includes(file.type)) {
        return { ok: false, message: 'Only JPG, PNG, WEBP, or AVIF files are allowed.' };
    }
    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
        return { ok: false, message: `Max file size is ${MAX_FILE_SIZE_MB}MB.` };
    }
    return { ok: true };
}

function buildPreviewUrl(file: File): string {
    return URL.createObjectURL(file);
}

export default function LandingAssetsClient() {
    const [assets, setAssets] = useState<Record<string, LandingAsset>>({});
    const [loading, setLoading] = useState(true);
    const [toast, setToast] = useState<{ kind: ToastKind; message: string } | null>(null);
    const [selectedFiles, setSelectedFiles] = useState<Record<string, File | null>>({});
    const [previewUrls, setPreviewUrls] = useState<Record<string, string>>({});
    const [altText, setAltText] = useState<Record<string, string>>({});
    const [savingKeys, setSavingKeys] = useState<Record<string, boolean>>({});
    const previewUrlsRef = useRef<Record<string, string>>({});

    const showToast = useCallback((kind: ToastKind, message: string) => {
        setToast({ kind, message });
        window.setTimeout(() => setToast(null), 3000);
    }, []);

    const loadAssets = useCallback(async () => {
        setLoading(true);
        try {
            const data = await getLandingAssets();
            setAssets(data);
            setAltText((prev) => {
                const next = { ...prev };
                ASSET_CATALOG.forEach((asset) => {
                    next[asset.key] = data[asset.key]?.alt_text ?? next[asset.key] ?? '';
                });
                return next;
            });
        } catch (error) {
            console.error('Failed to load landing assets', error);
            showToast('error', 'Failed to load assets.');
        } finally {
            setLoading(false);
        }
    }, [showToast]);

    useEffect(() => {
        loadAssets();
    }, [loadAssets]);

    useEffect(() => {
        previewUrlsRef.current = previewUrls;
    }, [previewUrls]);

    useEffect(() => {
        return () => {
            Object.values(previewUrlsRef.current).forEach((url) => URL.revokeObjectURL(url));
        };
    }, []);

    const handleFileSelected = useCallback((key: string, file: File) => {
        const validation = isValidFile(file);
        if (!validation.ok) {
            showToast('error', validation.message ?? 'Invalid file.');
            return;
        }
        setSelectedFiles((prev) => ({ ...prev, [key]: file }));
        setPreviewUrls((prev) => {
            if (prev[key]) {
                URL.revokeObjectURL(prev[key]);
            }
            return { ...prev, [key]: buildPreviewUrl(file) };
        });
    }, [showToast]);

    const handleDrop = useCallback((key: string, event: React.DragEvent<HTMLDivElement>) => {
        event.preventDefault();
        const file = event.dataTransfer.files?.[0];
        if (file) {
            handleFileSelected(key, file);
        }
    }, [handleFileSelected]);

    const handleSave = useCallback(async (key: string) => {
        const file = selectedFiles[key];
        if (!file) return;
        setSavingKeys((prev) => ({ ...prev, [key]: true }));

        try {
            const updated = await replaceLandingAsset(key, file, altText[key] ?? '', sb());
            setAssets((prev) => ({ ...prev, [key]: updated }));
            setSelectedFiles((prev) => ({ ...prev, [key]: null }));
            setPreviewUrls((prev) => {
                const next = { ...prev };
                if (next[key]) {
                    URL.revokeObjectURL(next[key]);
                }
                delete next[key];
                return next;
            });

            const supabase = sb();
            const { data: userData } = await supabase.auth.getUser();
            const adminId = userData?.user?.id ?? null;
            if (adminId) {
                const entityId = typeof crypto !== 'undefined' && 'randomUUID' in crypto
                    ? crypto.randomUUID()
                    : adminId;
                const auditClient = supabase as unknown as {
                    from: (table: string) => {
                        insert: (values: Record<string, unknown>) => Promise<{ error: { message?: string } | null }>;
                    };
                };
                const { error: auditError } = await auditClient.from('admin_audit_log').insert({
                    admin_id: adminId,
                    action: 'update',
                    entity_type: 'landing_asset',
                    entity_id: entityId,
                    changes: {
                        key,
                        public_url: updated.public_url,
                        storage_path: updated.storage_path,
                        alt_text: updated.alt_text,
                    },
                });
                if (auditError) {
                    console.warn('Failed to insert admin audit log', auditError.message);
                }
            }

            showToast('success', `Updated ${key}.`);
        } catch (error) {
            console.error('Failed to replace landing asset', error);
            showToast('error', `Failed to update ${key}.`);
        } finally {
            setSavingKeys((prev) => ({ ...prev, [key]: false }));
        }
    }, [altText, selectedFiles, showToast]);

    const cards = useMemo(() => ASSET_CATALOG, []);

    return (
        <div className="space-y-6">
            {toast && (
                <div
                    className={`rounded-lg px-4 py-3 text-sm font-medium shadow-sm ${toast.kind === 'success'
                            ? 'bg-green-50 text-green-700 border border-green-200'
                            : toast.kind === 'error'
                                ? 'bg-red-50 text-red-700 border border-red-200'
                                : 'bg-blue-50 text-blue-700 border border-blue-200'
                        }`}
                >
                    {toast.message}
                </div>
            )}

            <div className="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
                {loading
                    ? cards.map((asset) => (
                        <div key={asset.key} className="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
                            <div className="h-40 w-full animate-pulse rounded-lg bg-gray-100" />
                            <div className="mt-4 h-4 w-2/3 animate-pulse rounded bg-gray-100" />
                            <div className="mt-3 h-10 w-full animate-pulse rounded bg-gray-100" />
                        </div>
                    ))
                    : cards.map((asset) => {
                        const current = assets[asset.key];
                        const preview = previewUrls[asset.key] || current?.public_url || '';
                        const file = selectedFiles[asset.key];
                        const isSaving = savingKeys[asset.key];
                        return (
                            <div key={asset.key} className="rounded-xl border border-gray-200 bg-white p-4 shadow-sm flex flex-col gap-4">
                                <div>
                                    <p className="text-xs font-semibold uppercase tracking-wide text-gray-400">{asset.key}</p>
                                    <h3 className="text-lg font-semibold text-gray-900">{asset.label}</h3>
                                    {asset.hint && (
                                        <p className="mt-1 text-xs text-gray-500">{asset.hint}</p>
                                    )}
                                </div>

                                <div className="rounded-lg border border-dashed border-gray-200 bg-gray-50 p-2">
                                    {preview ? (
                                        <div className="relative h-44 w-full">
                                            <Image
                                                src={preview}
                                                alt={current?.alt_text || asset.label}
                                                fill
                                                unoptimized
                                                sizes="(min-width: 1280px) 33vw, (min-width: 768px) 50vw, 100vw"
                                                className="rounded-md object-cover"
                                            />
                                        </div>
                                    ) : (
                                        <div className="flex h-44 items-center justify-center text-xs text-gray-400">
                                            No image uploaded yet
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-2">
                                    <label className="text-xs font-semibold uppercase tracking-wide text-gray-400">Alt text</label>
                                    <input
                                        type="text"
                                        value={altText[asset.key] ?? ''}
                                        onChange={(event) =>
                                            setAltText((prev) => ({ ...prev, [asset.key]: event.target.value }))
                                        }
                                        className="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100"
                                        placeholder="Describe the image"
                                    />
                                </div>

                                <div
                                    className="rounded-lg border-2 border-dashed border-gray-200 bg-white px-4 py-5 text-center text-sm text-gray-500 transition hover:border-blue-300"
                                    onDragOver={(event) => event.preventDefault()}
                                    onDrop={(event) => handleDrop(asset.key, event)}
                                >
                                    <input
                                        id={`asset-file-${asset.key}`}
                                        type="file"
                                        accept={ACCEPTED_TYPES.join(',')}
                                        className="hidden"
                                        onChange={(event) => {
                                            const nextFile = event.target.files?.[0];
                                            if (nextFile) {
                                                handleFileSelected(asset.key, nextFile);
                                            }
                                        }}
                                    />
                                    <label htmlFor={`asset-file-${asset.key}`} className="cursor-pointer">
                                        <span className="font-semibold text-blue-600">Drag & drop</span> or click to replace
                                    </label>
                                    <div className="mt-2 text-xs text-gray-400">
                                        JPG / PNG / WEBP • Max {MAX_FILE_SIZE_MB}MB
                                    </div>
                                    {file && (
                                        <div className="mt-3 text-xs text-gray-500">
                                            Selected: {file.name} ({formatBytes(file.size)})
                                        </div>
                                    )}
                                </div>

                                <button
                                    type="button"
                                    disabled={!file || isSaving}
                                    onClick={() => handleSave(asset.key)}
                                    className={`w-full rounded-lg px-4 py-2 text-sm font-semibold transition ${file && !isSaving
                                            ? 'bg-blue-600 text-white hover:bg-blue-700'
                                            : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                        }`}
                                >
                                    {isSaving ? 'Saving...' : 'Save'}
                                </button>
                            </div>
                        );
                    })}
            </div>
        </div>
    );
}
````

## File: src/app/admin/papers/[paperId]/edit/actions.ts
````typescript
'use server';

import 'server-only';

/**
 * @fileoverview Admin Server Actions for Paper/Question Management
 * @description Uses service role key to bypass RLS for admin operations
 */

import { createClient } from '@supabase/supabase-js';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';
import type { QuestionWithAnswer, QuestionContext, Paper, QuestionSet } from '@/types/exam';

// Create admin client with service role key (bypasses RLS)
function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin operations require service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

// Create SSR client for server actions (must be async to get cookies)
async function createActionClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string;
    const cookieStore = await cookies();

    return createServerClient(url, anon, {
        cookies: {
            getAll() {
                return cookieStore.getAll();
            },
            setAll(cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options }) =>
                        cookieStore.set(name, value, options)
                    );
                } catch {
                    // Ignore - cookies can't be set in server actions during render
                }
            },
        },
    });
}

// Verify the user is authenticated and is an admin
async function verifyAdmin(): Promise<{ userId: string; email: string }> {
    // Use action-specific SSR client
    const supabase = await createActionClient();
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error || !user) {
        // Try getSession as fallback
        const { data: { session } } = await supabase.auth.getSession();

        if (session?.user) {
            return { userId: session.user.id, email: session.user.email || '' };
        }
        throw new Error('Not authenticated');
    }

    // Check admin role - SKIP_ADMIN_CHECK only allowed in non-production (dev mode)
    const skipAdminCheck = process.env.SKIP_ADMIN_CHECK === 'true' && process.env.NODE_ENV !== 'production';
    if (!skipAdminCheck) {
        const { data: { session } } = await supabase.auth.getSession();
        let role: string | null = session?.user?.app_metadata?.user_role ?? null;

        if (!role && session?.access_token) {
            try {
                const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                    user_role?: string;
                    app_metadata?: { user_role?: string };
                };
                role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
            } catch {
                role = null;
            }
        }

        if (role !== 'admin' && role !== 'dev') {
            const { data: isAdmin, error: rpcError } = await supabase.rpc('is_admin');
            if (rpcError || !isAdmin) {
                throw new Error('Unauthorized: Admin access required');
            }
        }
    }

    return { userId: user.id, email: user.email || '' };
}

export async function updateQuestion(
    questionId: string,
    questionData: Partial<QuestionWithAnswer>
): Promise<{ success: boolean; data?: QuestionWithAnswer; error?: string }> {
    try {
        await verifyAdmin();
        const adminClient = getAdminClient();
        const resolvedQuestionFormat = questionData.question_format ?? questionData.question_type;

        const { data, error } = await adminClient
            .from('questions')
            .update({
                question_text: questionData.question_text,
                question_type: questionData.question_type ?? resolvedQuestionFormat,
                question_format: resolvedQuestionFormat,
                taxonomy_type: questionData.taxonomy_type ?? null,
                topic_tag: questionData.topic_tag ?? null,
                difficulty_rationale: questionData.difficulty_rationale ?? null,
                options: questionData.options,
                correct_answer: questionData.correct_answer,
                positive_marks: questionData.positive_marks,
                negative_marks: questionData.negative_marks,
                solution_text: questionData.solution_text,
                question_image_url: questionData.question_image_url,
                topic: questionData.topic,
                difficulty: questionData.difficulty,
                set_id: questionData.set_id ?? null,
                sequence_order: questionData.sequence_order ?? null,
                context_id: questionData.context_id,
                is_active: true,
                updated_at: new Date().toISOString(),
            })
            .eq('id', questionId)
            .select()
            .single();

        if (error) {
            console.error('Admin updateQuestion error:', error);
            return { success: false, error: error.message || 'Failed to update question' };
        }

        return { success: true, data: data as QuestionWithAnswer };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        console.error('Admin updateQuestion exception:', message);
        return { success: false, error: message };
    }
}

export async function createQuestion(
    questionData: Partial<QuestionWithAnswer>
): Promise<{ success: boolean; data?: QuestionWithAnswer; error?: string }> {
    try {
        await verifyAdmin();
        const adminClient = getAdminClient();
        const resolvedQuestionFormat = questionData.question_format ?? questionData.question_type;

        const { data, error } = await adminClient
            .from('questions')
            .insert({
                paper_id: questionData.paper_id,
                section: questionData.section,
                question_number: questionData.question_number,
                question_text: questionData.question_text,
                question_type: questionData.question_type ?? resolvedQuestionFormat,
                question_format: resolvedQuestionFormat,
                taxonomy_type: questionData.taxonomy_type ?? null,
                topic_tag: questionData.topic_tag ?? null,
                difficulty_rationale: questionData.difficulty_rationale ?? null,
                options: questionData.options,
                correct_answer: questionData.correct_answer,
                positive_marks: questionData.positive_marks ?? 3,
                negative_marks: questionData.negative_marks ?? 1,
                solution_text: questionData.solution_text,
                question_image_url: questionData.question_image_url,
                topic: questionData.topic,
                difficulty: questionData.difficulty,
                set_id: questionData.set_id ?? null,
                sequence_order: questionData.sequence_order ?? null,
                context_id: questionData.context_id,
                is_active: true,
            })
            .select()
            .single();

        if (error) {
            console.error('Admin createQuestion error:', error);
            return { success: false, error: error.message || 'Failed to create question' };
        }

        return { success: true, data: data as QuestionWithAnswer };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        console.error('Admin createQuestion exception:', message);
        return { success: false, error: message };
    }
}

export async function updateContext(
    contextId: string,
    contextData: Partial<QuestionContext>
): Promise<{ success: boolean; data?: QuestionContext; error?: string }> {
    try {
        await verifyAdmin();
        const adminClient = getAdminClient();

        const { data, error } = await adminClient
            .from('question_contexts')
            .update({
                title: contextData.title,
                content: contextData.content,
                context_type: contextData.context_type,
                image_url: contextData.image_url,
                is_active: true,
                updated_at: new Date().toISOString(),
            })
            .eq('id', contextId)
            .select()
            .single();

        if (error) {
            console.error('Admin updateContext error:', error);
            return { success: false, error: error.message || 'Failed to update context' };
        }

        return { success: true, data: data as QuestionContext };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        console.error('Admin updateContext exception:', message);
        return { success: false, error: message };
    }
}

export async function createContext(
    contextData: Partial<QuestionContext>,
    displayOrder: number
): Promise<{ success: boolean; data?: QuestionContext; error?: string }> {
    try {
        await verifyAdmin();
        const adminClient = getAdminClient();

        const { data, error } = await adminClient
            .from('question_contexts')
            .insert({
                paper_id: contextData.paper_id,
                section: contextData.section,
                title: contextData.title,
                content: contextData.content,
                context_type: contextData.context_type ?? 'passage',
                image_url: contextData.image_url,
                display_order: displayOrder,
                is_active: true,
            })
            .select()
            .single();

        if (error) {
            console.error('Admin createContext error:', error);
            return { success: false, error: error.message || 'Failed to create context' };
        }

        return { success: true, data: data as QuestionContext };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        console.error('Admin createContext exception:', message);
        return { success: false, error: message };
    }
}

export async function updateQuestionSet(
    questionSetId: string,
    setData: Partial<QuestionSet>
): Promise<{ success: boolean; data?: QuestionSet; error?: string }> {
    try {
        await verifyAdmin();
        const adminClient = getAdminClient();

        const { data, error } = await adminClient
            .from('question_sets')
            .update({
                context_title: setData.context_title,
                context_body: setData.context_body,
                context_image_url: setData.context_image_url,
                context_additional_images: setData.context_additional_images,
                content_layout: setData.content_layout,
                context_type: setData.context_type,
                updated_at: new Date().toISOString(),
            })
            .eq('id', questionSetId)
            .select()
            .single();

        if (error) {
            console.error('Admin updateQuestionSet error:', error);
            return { success: false, error: error.message || 'Failed to update question set' };
        }

        return { success: true, data: data as QuestionSet };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        console.error('Admin updateQuestionSet exception:', message);
        return { success: false, error: message };
    }
}

export async function createQuestionSet(
    setData: Partial<QuestionSet>
): Promise<{ success: boolean; data?: QuestionSet; error?: string }> {
    try {
        await verifyAdmin();
        const adminClient = getAdminClient();

        const { data, error } = await adminClient
            .from('question_sets')
            .insert({
                paper_id: setData.paper_id,
                section: setData.section,
                set_type: setData.set_type,
                content_layout: setData.content_layout,
                context_type: setData.context_type ?? null,
                context_title: setData.context_title ?? null,
                context_body: setData.context_body ?? null,
                context_image_url: setData.context_image_url ?? null,
                context_additional_images: setData.context_additional_images ?? null,
                display_order: setData.display_order ?? 0,
                question_count: setData.question_count ?? 0,
                metadata: setData.metadata ?? {},
                is_active: true,
                is_published: false,
            })
            .select()
            .single();

        if (error) {
            console.error('Admin createQuestionSet error:', error);
            return { success: false, error: error.message || 'Failed to create question set' };
        }

        return { success: true, data: data as QuestionSet };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        console.error('Admin createQuestionSet exception:', message);
        return { success: false, error: message };
    }
}

export async function deleteContext(
    contextId: string
): Promise<{ success: boolean; error?: string }> {
    try {
        await verifyAdmin();
        const adminClient = getAdminClient();

        const { error } = await adminClient
            .from('question_contexts')
            .update({
                is_active: false,
                updated_at: new Date().toISOString(),
            })
            .eq('id', contextId);

        if (error) {
            console.error('Admin deleteContext error:', error);
            return { success: false, error: error.message || 'Failed to delete context' };
        }

        return { success: true };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        console.error('Admin deleteContext exception:', message);
        return { success: false, error: message };
    }
}

export async function updatePaper(
    paperId: string,
    paperData: Partial<Paper>
): Promise<{ success: boolean; error?: string }> {
    try {
        await verifyAdmin();
        const adminClient = getAdminClient();

        const { error } = await adminClient
            .from('papers')
            .update(paperData)
            .eq('id', paperId);

        if (error) {
            console.error('Admin updatePaper error:', error);
            return { success: false, error: error.message || 'Failed to update paper' };
        }

        return { success: true };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        console.error('Admin updatePaper exception:', message);
        return { success: false, error: message };
    }
}
````

## File: src/app/admin/papers/[paperId]/edit/ExamEditorClient.tsx
````typescript
/**
 * @fileoverview Exam Editor Client Component
 * @description Client wrapper for the ExamEditor with server actions
 * @blueprint M6+ - Mirror Principle
 */

'use client';

import { useCallback, useEffect, useMemo, useState } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { EditableExamLayout } from '@/features/admin';
import type { EditorNavigationState } from '@/features/admin/ui/EditableExamLayout';
import type { Paper, QuestionWithAnswer, QuestionContext, QuestionSet, SectionName } from '@/types/exam';
import {
    updateQuestion,
    createQuestion,
    updateContext,
    createContext,
    deleteContext,
    updatePaper,
    updateQuestionSet,
    createQuestionSet,
} from './actions';

interface ExamEditorClientProps {
    paper: Paper;
    initialQuestions: QuestionWithAnswer[];
    initialQuestionSets: QuestionSet[];
    initialContexts: QuestionContext[];
}

type QuestionOrderBySection = Record<SectionName, string[]>;

const SECTIONS: SectionName[] = ['VARC', 'DILR', 'QA'];

const createEmptyQuestionOrder = (): QuestionOrderBySection => ({
    VARC: [],
    DILR: [],
    QA: [],
});

const parseSection = (value: string | null): SectionName | undefined => {
    if (!value) return undefined;
    return SECTIONS.includes(value as SectionName) ? (value as SectionName) : undefined;
};

const parseNavigation = (params: URLSearchParams): EditorNavigationState => {
    const section = parseSection(params.get('section'));
    const qid = params.get('qid') ?? undefined;
    const setId = params.get('setId') ?? undefined;
    const qParam = params.get('q');
    const q = qParam ? Number(qParam) : undefined;
    return {
        section,
        qid: qid || undefined,
        setId: setId || undefined,
        q: typeof q === 'number' && Number.isFinite(q) && q > 0 ? q : undefined,
    };
};

const normalizeQuestions = (items: QuestionWithAnswer[]) => {
    const questionsById: Record<string, QuestionWithAnswer> = {};
    const questionOrderBySection: QuestionOrderBySection = createEmptyQuestionOrder();

    items.forEach((q) => {
        questionsById[q.id] = q;
    });

    SECTIONS.forEach((section) => {
        questionOrderBySection[section] = items
            .filter((q) => q.section === section)
            .sort((a, b) => {
                const aNum = a.question_number ?? 0;
                const bNum = b.question_number ?? 0;
                if (aNum !== bNum) return aNum - bNum;
                const aSeq = a.sequence_order ?? 0;
                const bSeq = b.sequence_order ?? 0;
                if (aSeq !== bSeq) return aSeq - bSeq;
                return a.id.localeCompare(b.id);
            })
            .map((q) => q.id);
    });

    return { questionsById, questionOrderBySection };
};

const normalizeById = <T extends { id: string }>(items: T[]) => {
    return items.reduce<Record<string, T>>((acc, item) => {
        acc[item.id] = item;
        return acc;
    }, {});
};

const sortQuestionIdsForSection = (
    questionsById: Record<string, QuestionWithAnswer>,
    section: SectionName
) => {
    return Object.values(questionsById)
        .filter((q) => q.section === section)
        .sort((a, b) => {
            const aNum = a.question_number ?? 0;
            const bNum = b.question_number ?? 0;
            if (aNum !== bNum) return aNum - bNum;
            const aSeq = a.sequence_order ?? 0;
            const bSeq = b.sequence_order ?? 0;
            if (aSeq !== bSeq) return aSeq - bSeq;
            return a.id.localeCompare(b.id);
        })
        .map((q) => q.id);
};

export function ExamEditorClient({
    paper,
    initialQuestions,
    initialQuestionSets,
    initialContexts,
}: ExamEditorClientProps) {
    const router = useRouter();
    const pathname = usePathname();
    const [paperState, setPaperState] = useState<Paper>(paper);
    const [{ questionsById, questionOrderBySection }, setQuestionState] = useState(() => normalizeQuestions(initialQuestions));
    const [questionSetsById, setQuestionSetsById] = useState<Record<string, QuestionSet>>(() => normalizeById(initialQuestionSets));
    const [contextsById, setContextsById] = useState<Record<string, QuestionContext>>(() => normalizeById(initialContexts));
    const [saveError, setSaveError] = useState<string | null>(null);
    const [saveSuccess, setSaveSuccess] = useState<string | null>(null);
    const [retryAction, setRetryAction] = useState<(() => void) | null>(null);
    const [externalNavigation, setExternalNavigation] = useState<EditorNavigationState | null>(null);

    const STORAGE_KEY = `paper:${paper.id}:editorNav`;

    useEffect(() => {
        if (typeof window === 'undefined') {
            return;
        }

        const resolveNavigation = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const fromUrl = parseNavigation(urlParams);
            const hasUrl = Boolean(fromUrl.section || fromUrl.qid || fromUrl.setId || fromUrl.q);

            if (hasUrl) {
                setExternalNavigation(fromUrl);
                return;
            }

            const storedRaw = window.localStorage.getItem(STORAGE_KEY);
            if (storedRaw) {
                try {
                    const stored = JSON.parse(storedRaw) as EditorNavigationState;
                    setExternalNavigation({
                        section: parseSection(stored.section ?? null),
                        qid: stored.qid ?? undefined,
                        setId: stored.setId ?? undefined,
                        q: typeof stored.q === 'number' && Number.isFinite(stored.q) && stored.q > 0 ? stored.q : undefined,
                    });
                    return;
                } catch {
                    window.localStorage.removeItem(STORAGE_KEY);
                }
            }

            setExternalNavigation({ section: 'VARC', q: 1 });
        };

        resolveNavigation();

        const handlePopState = () => resolveNavigation();
        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
    }, [STORAGE_KEY]);

    const questions = useMemo(() => {
        return SECTIONS.flatMap((section) =>
            (questionOrderBySection[section] || [])
                .map((id) => questionsById[id])
                .filter(Boolean)
        );
    }, [questionOrderBySection, questionsById]);

    // Dev-only: Detect duplicate question IDs in assembled list
    useEffect(() => {
        if (process.env.NODE_ENV === 'production') return;

        const seen = new Set<string>();
        const duplicates = new Set<string>();
        questions.forEach((q) => {
            if (seen.has(q.id)) {
                duplicates.add(q.id);
            } else {
                seen.add(q.id);
            }
        });

        if (duplicates.size > 0) {
            console.warn('[ExamEditor] Detected duplicate question ids in assembled question list', {
                duplicateIds: Array.from(duplicates),
                totalQuestions: questions.length,
            });
        }
    }, [questions]);

    const questionSets = useMemo(() => {
        return Object.values(questionSetsById)
            .sort((a, b) => {
                if (a.section !== b.section) {
                    return SECTIONS.indexOf(a.section) - SECTIONS.indexOf(b.section);
                }
                const order = (a.display_order ?? 0) - (b.display_order ?? 0);
                if (order !== 0) return order;
                return a.id.localeCompare(b.id);
            });
    }, [questionSetsById]);

    const contexts = useMemo(() => {
        return Object.values(contextsById)
            .sort((a, b) => {
                if (a.section !== b.section) {
                    return SECTIONS.indexOf(a.section) - SECTIONS.indexOf(b.section);
                }
                const order = (a.display_order ?? 0) - (b.display_order ?? 0);
                if (order !== 0) return order;
                return a.id.localeCompare(b.id);
            });
    }, [contextsById]);

    // Clear notifications after delay
    const showNotification = useCallback((type: 'success' | 'error', message: string, retry?: () => void) => {
        if (type === 'success') {
            setSaveSuccess(message);
            setSaveError(null);
            setRetryAction(null);
            setTimeout(() => setSaveSuccess(null), 3000);
        } else {
            setSaveError(message);
            setSaveSuccess(null);
            setRetryAction(() => retry ?? null);
            setTimeout(() => setSaveError(null), 5000);
        }
    }, []);

    // Save question to database using server action
    const handleSaveQuestion = useCallback(async (questionData: Partial<QuestionWithAnswer>) => {
        if (!questionData.id) {
            const existingQuestion = Object.values(questionsById).find((q) => {
                if (!questionData.section || questionData.question_number === undefined) {
                    return false;
                }

                if (q.section !== questionData.section) {
                    return false;
                }

                if (q.question_number !== questionData.question_number) {
                    return false;
                }

                if (questionData.set_id && q.set_id !== questionData.set_id) {
                    return false;
                }

                return true;
            });

            if (existingQuestion && process.env.NODE_ENV !== 'production') {
                console.warn('[ExamEditor] Attempted to create when update expected (question id missing).', {
                    attemptedPayload: questionData,
                    existingQuestionId: existingQuestion.id,
                });
                showNotification('error', 'Refused to create: missing question id for an existing question.');
                return;
            }
        }

        const nowIso = new Date().toISOString();

        try {
            if (questionData.id) {
                const previousQuestion = questionsById[questionData.id] ?? null;
                if (previousQuestion) {
                    const optimisticQuestion = {
                        ...previousQuestion,
                        ...questionData,
                        updated_at: nowIso,
                    } as QuestionWithAnswer;

                    setQuestionState((prev) => {
                        const nextById = { ...prev.questionsById, [optimisticQuestion.id]: optimisticQuestion };
                        const nextOrder = { ...prev.questionOrderBySection };
                        nextOrder[optimisticQuestion.section] = sortQuestionIdsForSection(nextById, optimisticQuestion.section);
                        return { questionsById: nextById, questionOrderBySection: nextOrder };
                    });
                }

                // Update existing question via server action
                const result = await updateQuestion(questionData.id, questionData);

                if (!result.success || !result.data) {
                    console.error('Failed to update question:', result.error);
                    if (previousQuestion) {
                        setQuestionState((prev) => {
                            const nextById = { ...prev.questionsById, [previousQuestion.id]: previousQuestion };
                            const nextOrder = { ...prev.questionOrderBySection };
                            nextOrder[previousQuestion.section] = sortQuestionIdsForSection(nextById, previousQuestion.section);
                            return { questionsById: nextById, questionOrderBySection: nextOrder };
                        });
                    }
                    showNotification('error', result.error || 'Failed to save', () => handleSaveQuestion(questionData));
                    return;
                }

                // Update local state
                setQuestionState((prev) => {
                    const updated = result.data!;
                    const nextById = { ...prev.questionsById, [updated.id]: updated };
                    const nextOrder = { ...prev.questionOrderBySection };
                    nextOrder[updated.section] = sortQuestionIdsForSection(nextById, updated.section);
                    return { questionsById: nextById, questionOrderBySection: nextOrder };
                });
                showNotification('success', 'Question updated successfully!');
            } else {
                const tempId = `temp-${Date.now()}`;
                const optimisticQuestion: QuestionWithAnswer = {
                    id: tempId,
                    paper_id: questionData.paper_id ?? paperState.id,
                    section: questionData.section ?? 'VARC',
                    question_number: questionData.question_number ?? 1,
                    set_id: questionData.set_id ?? null,
                    sequence_order: questionData.sequence_order ?? null,
                    question_text: questionData.question_text ?? '',
                    question_type: questionData.question_type ?? 'MCQ',
                    options: questionData.options ?? null,
                    correct_answer: questionData.correct_answer ?? 'A',
                    positive_marks: questionData.positive_marks ?? 3,
                    negative_marks: questionData.negative_marks ?? 1,
                    solution_text: questionData.solution_text ?? undefined,
                    solution_image_url: questionData.solution_image_url ?? undefined,
                    question_image_url: questionData.question_image_url ?? undefined,
                    difficulty: questionData.difficulty ?? undefined,
                    topic: questionData.topic ?? undefined,
                    subtopic: questionData.subtopic ?? undefined,
                    is_active: true,
                    created_at: nowIso,
                    updated_at: nowIso,
                };

                setQuestionState((prev) => {
                    const nextById = { ...prev.questionsById, [tempId]: optimisticQuestion };
                    const nextOrder = { ...prev.questionOrderBySection };
                    nextOrder[optimisticQuestion.section] = sortQuestionIdsForSection(nextById, optimisticQuestion.section);
                    return { questionsById: nextById, questionOrderBySection: nextOrder };
                });

                // Create new question via server action
                const result = await createQuestion({
                    ...questionData,
                    paper_id: questionData.paper_id ?? paperState.id,
                });

                if (!result.success || !result.data) {
                    console.error('Failed to create question:', result.error);
                    setQuestionState((prev) => {
                        const remaining = { ...prev.questionsById };
                        delete remaining[tempId];
                        const nextOrder = { ...prev.questionOrderBySection };
                        Object.keys(nextOrder).forEach((sectionKey) => {
                            const section = sectionKey as SectionName;
                            nextOrder[section] = sortQuestionIdsForSection(remaining, section);
                        });
                        return { questionsById: remaining, questionOrderBySection: nextOrder };
                    });
                    showNotification('error', result.error || 'Failed to create', () => handleSaveQuestion(questionData));
                    return;
                }

                // Add to local state
                setQuestionState((prev) => {
                    const created = result.data!;
                    const remaining = { ...prev.questionsById };
                    delete remaining[tempId];
                    const nextById = { ...remaining, [created.id]: created };
                    const nextOrder = { ...prev.questionOrderBySection };
                    nextOrder[created.section] = sortQuestionIdsForSection(nextById, created.section);
                    return { questionsById: nextById, questionOrderBySection: nextOrder };
                });
                showNotification('success', 'Question created successfully!');
            }
        } catch (err) {
            console.error('Unexpected error saving question:', err);
            const message = err instanceof Error ? err.message : 'An unexpected error occurred.';
            showNotification('error', message, () => handleSaveQuestion(questionData));
        }
    }, [paperState.id, questionsById, showNotification]);

    // Save context to database using server action
    const handleSaveContext = useCallback(async (contextData: Partial<QuestionContext>) => {
        const nowIso = new Date().toISOString();

        try {
            if (contextData.id) {
                const previousContext = contextsById[contextData.id] ?? null;
                if (previousContext) {
                    const optimisticContext = {
                        ...previousContext,
                        ...contextData,
                        updated_at: nowIso,
                    } as QuestionContext;

                    setContextsById((prev) => ({ ...prev, [optimisticContext.id]: optimisticContext }));
                }

                // Update existing context via server action
                const result = await updateContext(contextData.id, contextData);

                if (!result.success || !result.data) {
                    console.error('Failed to update context:', result.error);
                    if (previousContext) {
                        setContextsById((prev) => ({ ...prev, [previousContext.id]: previousContext }));
                    }
                    showNotification('error', result.error || 'Failed to save context', () => handleSaveContext(contextData));
                    return;
                }

                setContextsById((prev) => ({ ...prev, [result.data!.id]: result.data! }));
                showNotification('success', 'Context updated successfully!');
            } else {
                const tempId = `temp-${Date.now()}`;
                const displayOrder = Object.values(contextsById).filter(c => c.section === contextData.section).length;
                const optimisticContext: QuestionContext = {
                    id: tempId,
                    paper_id: contextData.paper_id ?? paperState.id,
                    section: contextData.section ?? 'VARC',
                    title: contextData.title ?? undefined,
                    content: contextData.content ?? '',
                    context_type: contextData.context_type ?? 'passage',
                    image_url: contextData.image_url ?? undefined,
                    display_order: displayOrder,
                    is_active: true,
                    created_at: nowIso,
                    updated_at: nowIso,
                };

                setContextsById((prev) => ({ ...prev, [tempId]: optimisticContext }));

                // Create new context via server action
                const result = await createContext(
                    { ...contextData, paper_id: contextData.paper_id ?? paperState.id },
                    displayOrder
                );

                if (!result.success || !result.data) {
                    console.error('Failed to create context:', result.error);
                    setContextsById((prev) => {
                        const remaining = { ...prev };
                        delete remaining[tempId];
                        return remaining;
                    });
                    showNotification('error', result.error || 'Failed to create context', () => handleSaveContext(contextData));
                    return;
                }

                setContextsById((prev) => {
                    const remaining = { ...prev };
                    delete remaining[tempId];
                    return { ...remaining, [result.data!.id]: result.data! };
                });
                showNotification('success', 'Context created successfully!');
            }
        } catch (err) {
            console.error('Unexpected error saving context:', err);
            const message = err instanceof Error ? err.message : 'An unexpected error occurred.';
            showNotification('error', message, () => handleSaveContext(contextData));
        }
    }, [contextsById, paperState.id, showNotification]);

    const handleSaveQuestionSet = useCallback(async (setData: Partial<QuestionSet>) => {
        try {
            if (!setData.id) {
                showNotification('error', 'Missing question set id.');
                return;
            }

            const previousSet = questionSetsById[setData.id] ?? null;
            if (previousSet) {
                const optimisticSet = {
                    ...previousSet,
                    ...setData,
                    updated_at: new Date().toISOString(),
                } as QuestionSet;
                setQuestionSetsById((prev) => ({ ...prev, [optimisticSet.id]: optimisticSet }));
            }

            const result = await updateQuestionSet(setData.id, setData);

            if (!result.success || !result.data) {
                if (previousSet) {
                    setQuestionSetsById((prev) => ({ ...prev, [previousSet.id]: previousSet }));
                }
                showNotification('error', result.error || 'Failed to update question set');
                return;
            }

            setQuestionSetsById((prev) => ({ ...prev, [result.data!.id]: result.data! }));
            showNotification('success', 'Question set updated successfully!');
        } catch (err) {
            const message = err instanceof Error ? err.message : 'An unexpected error occurred.';
            showNotification('error', message);
        }
    }, [questionSetsById, showNotification]);

    const handleCreateQuestionSet = useCallback(async (setData: Partial<QuestionSet>) => {
        try {
            const result = await createQuestionSet(setData);
            if (!result.success || !result.data) {
                showNotification('error', result.error || 'Failed to create question set');
                return null;
            }
            setQuestionSetsById((prev) => ({ ...prev, [result.data!.id]: result.data! }));
            showNotification('success', 'Question set created successfully!');
            return result.data;
        } catch (err) {
            const message = err instanceof Error ? err.message : 'An unexpected error occurred.';
            showNotification('error', message);
            return null;
        }
    }, [showNotification]);

    const handleDeleteContext = useCallback(async (contextId: string) => {
        try {
            const result = await deleteContext(contextId);
            if (!result.success) {
                showNotification('error', result.error || 'Failed to delete context');
                return;
            }
            setContextsById((prev) => {
                const remaining = { ...prev };
                delete remaining[contextId];
                return remaining;
            });
            showNotification('success', 'Context deleted successfully!');
        } catch (err) {
            const message = err instanceof Error ? err.message : 'An unexpected error occurred.';
            showNotification('error', message);
        }
    }, [showNotification]);

    // Update paper metadata using server action
    const handleUpdatePaper = useCallback(async (paperData: Partial<Paper>) => {
        try {
            const result = await updatePaper(paperState.id, paperData);

            if (!result.success) {
                console.error('Failed to update paper:', result.error);
                showNotification('error', result.error || 'Failed to update paper', () => handleUpdatePaper(paperData));
                return;
            }

            showNotification('success', 'Paper updated successfully!');
        } catch (err) {
            console.error('Unexpected error updating paper:', err);
            const message = err instanceof Error ? err.message : 'An unexpected error occurred.';
            showNotification('error', message, () => handleUpdatePaper(paperData));
        }
    }, [paperState.id, showNotification]);

    const handleUpdatePaperTitle = useCallback(async (title: string) => {
        const trimmed = title.trim();
        try {
            const result = await updatePaper(paperState.id, { title: trimmed });

            if (!result.success) {
                console.error('Failed to update paper title:', result.error);
                showNotification('error', result.error || 'Failed to update title', () => handleUpdatePaperTitle(title));
                return { success: false, error: result.error || 'Failed to update title' };
            }

            setPaperState(prev => ({ ...prev, title: trimmed }));
            showNotification('success', 'Paper title updated successfully!');
            return { success: true };
        } catch (err) {
            console.error('Unexpected error updating paper title:', err);
            const message = err instanceof Error ? err.message : 'An unexpected error occurred.';
            showNotification('error', message, () => handleUpdatePaperTitle(title));
            return { success: false, error: message };
        }
    }, [paperState.id, showNotification]);

    const handleNavigate = useCallback((navigation: { section: SectionName; qid?: string | null; setId?: string | null; q: number }) => {
        if (typeof window === 'undefined') {
            return;
        }

        const params = new URLSearchParams(window.location.search);
        const nextQ = String(navigation.q);
        const nextQid = navigation.qid ?? '';
        const nextSetId = navigation.setId ?? '';

        const isSame =
            params.get('section') === navigation.section &&
            (params.get('qid') ?? '') === nextQid &&
            (params.get('setId') ?? '') === nextSetId &&
            (params.get('q') ?? '') === nextQ;

        params.set('section', navigation.section);
        if (navigation.qid) {
            params.set('qid', navigation.qid);
        } else {
            params.delete('qid');
        }
        if (navigation.setId) {
            params.set('setId', navigation.setId);
        } else {
            params.delete('setId');
        }
        params.set('q', nextQ);

        window.localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({
                section: navigation.section,
                qid: navigation.qid ?? undefined,
                setId: navigation.setId ?? undefined,
                q: navigation.q,
            })
        );

        if (!isSame) {
            router.replace(`${pathname}?${params.toString()}`, { scroll: false });
        }
    }, [pathname, router, STORAGE_KEY]);

    return (
        <>
            {/* Toast Notifications */}
            {(saveError || saveSuccess) && (
                <div className="fixed top-4 right-4 z-50">
                    {saveError && (
                        <div className="bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-in slide-in-from-right">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>{saveError}</span>
                            {retryAction && (
                                <button
                                    onClick={retryAction}
                                    className="ml-2 text-white/90 hover:text-white underline"
                                >
                                    Retry
                                </button>
                            )}
                            <button onClick={() => setSaveError(null)} className="ml-2 hover:opacity-70">×</button>
                        </div>
                    )}
                    {saveSuccess && (
                        <div className="bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-in slide-in-from-right">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                            <span>{saveSuccess}</span>
                        </div>
                    )}
                </div>
            )}
            <EditableExamLayout
                paper={paperState}
                questions={questions}
                questionSets={questionSets}
                contexts={contexts}
                onSaveQuestion={handleSaveQuestion}
                onSaveQuestionSet={handleSaveQuestionSet}
                onCreateQuestionSet={handleCreateQuestionSet}
                onSaveContext={handleSaveContext}
                onDeleteContext={handleDeleteContext}
                onUpdatePaperTitle={handleUpdatePaperTitle}
                initialNavigation={externalNavigation}
                onNavigate={handleNavigate}
            />
        </>
    );
}
````

## File: src/app/admin/papers/[paperId]/edit/page.tsx
````typescript
/**
 * @fileoverview Admin Paper Editor Page
 * @description In-context exam editor with Mirror Principle - edit questions in exam layout
 * @blueprint M6+ - Mirror Principle - Admin sees exactly what student sees
 */

import 'server-only';

import { notFound, redirect } from 'next/navigation';
import { sbSSR } from '@/lib/supabase/server';
import { createClient } from '@supabase/supabase-js';
import { ExamEditorClient } from './ExamEditorClient';

interface PageProps {
    params: Promise<{ paperId: string }>;
}

function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin editor requires service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

export default async function AdminPaperEditorPage({ params }: PageProps) {
    const { paperId } = await params;
    const supabase = await sbSSR();

    // Server-side admin verification (CRITICAL: page uses service-role client)
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/auth/sign-in');
    }

    const { data: { session } } = await supabase.auth.getSession();
    let role: string | null = session?.user?.app_metadata?.user_role ?? null;

    if (!role && session?.access_token) {
        try {
            const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                user_role?: string;
                app_metadata?: { user_role?: string };
            };
            role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
        } catch {
            role = null;
        }
    }

    let isAdmin = role === 'admin' || role === 'dev';

    if (!isAdmin) {
        const { data: isAdminRpc, error: rpcError } = await supabase.rpc('is_admin');
        isAdmin = !rpcError && Boolean(isAdminRpc);
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    // Fetch paper
    const { data: paper, error: paperError } = await supabase
        .from('papers')
        .select('*')
        .eq('id', paperId)
        .single();

    if (paperError || !paper) {
        notFound();
    }

    // Fetch all questions for this paper (service role for privileged columns)
    const adminClient = getAdminClient();
    const { data: questions } = await adminClient
        .from('questions')
        .select('*')
        .eq('paper_id', paperId)
        .order('section', { ascending: true })
        .order('question_number', { ascending: true });

    // Fetch question sets with questions (sets-first view)
    const { data: questionSetsView } = await adminClient
        .from('question_sets_with_questions')
        .select('*')
        .eq('paper_id', paperId)
        .order('section', { ascending: true })
        .order('display_order', { ascending: true });

    let questionSets = questionSetsView ?? [];

    if (!questionSets || questionSets.length === 0) {
        const { data: questionSetsTable } = await adminClient
            .from('question_sets')
            .select('*')
            .eq('paper_id', paperId)
            .order('section', { ascending: true })
            .order('display_order', { ascending: true });
        questionSets = questionSetsTable ?? [];
    }

    // Fetch all contexts for this paper
    const { data: contexts } = await supabase
        .from('question_contexts')
        .select('*')
        .eq('paper_id', paperId)
        .order('section', { ascending: true })
        .order('display_order', { ascending: true });

    return (
        <ExamEditorClient
            paper={paper}
            initialQuestions={questions ?? []}
            initialQuestionSets={questionSets ?? []}
            initialContexts={contexts ?? []}
        />
    );
}
````

## File: src/app/admin/papers/[paperId]/questions/page.tsx
````typescript
/**
 * @fileoverview Paper Questions Page
 * @description Admin page listing questions for a paper
 */

import 'server-only';

import Link from 'next/link';
import { notFound, redirect } from 'next/navigation';
import { createClient } from '@supabase/supabase-js';
import { sbSSR } from '@/lib/supabase/server';
import QuestionRowActions from '@/app/admin/questions/QuestionRowActions';

interface PageProps {
    params: Promise<{ paperId: string }>;
}

function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin operations require service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

export default async function PaperQuestionsPage({ params }: PageProps) {
    const { paperId } = await params;
    const supabase = await sbSSR();

    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/auth/sign-in');
    }

    const { data: { session } } = await supabase.auth.getSession();
    let role: string | null = session?.user?.app_metadata?.user_role ?? null;

    if (!role && session?.access_token) {
        try {
            const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                user_role?: string;
                app_metadata?: { user_role?: string };
            };
            role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
        } catch {
            role = null;
        }
    }

    let isAdmin = role === 'admin' || role === 'dev';
    if (!isAdmin) {
        const { data: isAdminRpc, error: rpcError } = await supabase.rpc('is_admin');
        isAdmin = !rpcError && Boolean(isAdminRpc);
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    const { data: paper, error: paperError } = await supabase
        .from('papers')
        .select('id, title')
        .eq('id', paperId)
        .single();

    if (paperError || !paper) {
        notFound();
    }

    const adminClient = getAdminClient();
    const { data: questions } = await adminClient
        .from('questions')
        .select('id, section, question_number, question_type, topic, is_active')
        .eq('paper_id', paperId)
        .order('section', { ascending: true })
        .order('question_number', { ascending: true });

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-bold text-gray-900">Questions</h1>
                    <p className="text-sm text-gray-500">{paper.title}</p>
                </div>
                <div className="flex items-center gap-2">
                    <Link
                        href={`/admin/papers/${paperId}/edit`}
                        className="px-3 py-2 text-sm rounded-md bg-indigo-600 text-white hover:bg-indigo-700"
                    >
                        Live Edit
                    </Link>
                    <Link
                        href={`/admin/papers/${paperId}/settings`}
                        className="px-3 py-2 text-sm rounded-md bg-slate-700 text-white hover:bg-slate-800"
                    >
                        Settings
                    </Link>
                </div>
            </div>

            <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Section</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Topic</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {questions && questions.length > 0 ? (
                            questions.map((q) => (
                                <tr key={q.id} className="hover:bg-gray-50">
                                    <td className="px-6 py-3 text-sm text-gray-700">{q.question_number}</td>
                                    <td className="px-6 py-3 text-sm text-gray-700">{q.section}</td>
                                    <td className="px-6 py-3 text-sm text-gray-700">{q.question_type}</td>
                                    <td className="px-6 py-3 text-sm text-gray-500">{q.topic || '—'}</td>
                                    <td className="px-6 py-3 text-sm">
                                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${q.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}>
                                            {q.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                    <td className="px-6 py-3 text-right text-sm font-medium">
                                        <QuestionRowActions
                                            questionId={q.id}
                                            isActive={q.is_active}
                                            editHref={`/admin/papers/${paperId}/edit?qid=${q.id}`}
                                        />
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan={6} className="px-6 py-8 text-center text-gray-500">
                                    No questions found for this paper.
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
}
````

## File: src/app/admin/papers/actions.ts
````typescript
'use server';

import 'server-only';

/**
 * @fileoverview Admin Server Actions for Paper Management
 * @description Uses service role key to bypass RLS for admin operations
 */

import { createClient } from '@supabase/supabase-js';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';
import { revalidatePath } from 'next/cache';

// Create admin client with service role key (bypasses RLS)
function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin operations require service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

// Create SSR client for server actions (must be async to get cookies)
async function createActionClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string;
    const cookieStore = await cookies();

    return createServerClient(url, anon, {
        cookies: {
            getAll() {
                return cookieStore.getAll();
            },
            setAll(cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options }) =>
                        cookieStore.set(name, value, options)
                    );
                } catch {
                    // Ignore - cookies can't be set in server actions during render
                }
            },
        },
    });
}

// Verify the user is authenticated and is an admin
async function verifyAdmin(): Promise<{ userId: string; email: string }> {
    const supabase = await createActionClient();
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error || !user) {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
            return { userId: session.user.id, email: session.user.email || '' };
        }
        throw new Error('Not authenticated');
    }

    const skipAdminCheck = process.env.SKIP_ADMIN_CHECK === 'true' && process.env.NODE_ENV !== 'production';
    if (!skipAdminCheck) {
        const { data: { session } } = await supabase.auth.getSession();
        let role: string | null = session?.user?.app_metadata?.user_role ?? null;

        if (!role && session?.access_token) {
            try {
                const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                    user_role?: string;
                    app_metadata?: { user_role?: string };
                };
                role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
            } catch {
                role = null;
            }
        }

        if (role !== 'admin' && role !== 'dev') {
            const { data: isAdmin, error: rpcError } = await supabase.rpc('is_admin');
            if (rpcError || !isAdmin) {
                throw new Error('Unauthorized: Admin access required');
            }
        }
    }

    return { userId: user.id, email: user.email || '' };
}

export async function deletePaper(paperId: string): Promise<{ success: boolean; error?: string }> {
    try {
        if (!paperId) {
            return { success: false, error: 'Paper id is required.' };
        }

        await verifyAdmin();
        const adminClient = getAdminClient();

        const { data: attempts, error: attemptsLookupError } = await adminClient
            .from('attempts')
            .select('id')
            .eq('paper_id', paperId);

        if (attemptsLookupError) {
            return { success: false, error: attemptsLookupError.message || 'Failed to lookup attempts' };
        }

        const attemptIds = (attempts ?? []).map((attempt) => attempt.id).filter(Boolean);

        if (attemptIds.length > 0) {
            const { error: responsesError } = await adminClient
                .from('responses')
                .delete()
                .in('attempt_id', attemptIds);

            if (responsesError) {
                return { success: false, error: responsesError.message || 'Failed to delete responses' };
            }
        }

        // Delete dependent rows first (safe even with ON DELETE CASCADE)
        const { error: setsError } = await adminClient
            .from('question_sets')
            .delete()
            .eq('paper_id', paperId);

        if (setsError) {
            return { success: false, error: setsError.message || 'Failed to delete question sets' };
        }

        const { error: questionsError } = await adminClient
            .from('questions')
            .delete()
            .eq('paper_id', paperId);

        if (questionsError) {
            return { success: false, error: questionsError.message || 'Failed to delete questions' };
        }

        const { error: contextsError } = await adminClient
            .from('question_contexts')
            .delete()
            .eq('paper_id', paperId);

        if (contextsError) {
            return { success: false, error: contextsError.message || 'Failed to delete question contexts' };
        }

        const { error: attemptsError } = await adminClient
            .from('attempts')
            .delete()
            .eq('paper_id', paperId);

        if (attemptsError) {
            return { success: false, error: attemptsError.message || 'Failed to delete attempts' };
        }

        const { error } = await adminClient
            .from('papers')
            .delete()
            .eq('id', paperId);

        if (error) {
            return { success: false, error: error.message || 'Failed to delete paper' };
        }

        revalidatePath('/admin/papers');
        return { success: true };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Unknown error';
        return { success: false, error: message };
    }
}
````

## File: src/app/admin/question-sets/new/page.tsx
````typescript
/**
 * @fileoverview New Question Set Page
 * @description Create a new question set with passage/context and questions
 * @blueprint Question Container Architecture
 */

import { sbSSR } from '@/lib/supabase/server';
import { NewQuestionSetClient } from './NewQuestionSetClient';
import { redirect } from 'next/navigation';

export default async function NewQuestionSetPage() {
    const supabase = await sbSSR();

    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/auth/sign-in');
    }

    const { data: { session } } = await supabase.auth.getSession();
    let role: string | null = session?.user?.app_metadata?.user_role ?? null;

    if (!role && session?.access_token) {
        try {
            const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                user_role?: string;
                app_metadata?: { user_role?: string };
            };
            role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
        } catch {
            role = null;
        }
    }

    let isAdmin = role === 'admin' || role === 'dev';

    if (!isAdmin) {
        const { data: isAdminRpc, error: rpcError } = await supabase.rpc('is_admin');
        isAdmin = !rpcError && Boolean(isAdminRpc);
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    // Fetch all papers for the dropdown
    const { data: papers } = await supabase
        .from('papers')
        .select('id, title, slug')
        .order('created_at', { ascending: false });

    return <NewQuestionSetClient papers={papers ?? []} />;
}
````

## File: src/app/admin/question-sets/page.tsx
````typescript
/**
 * @fileoverview Admin Question Sets Page
 * @description List and manage question sets (RC passages, DI sets, etc.)
 * @blueprint Question Container Architecture
 */

import { sbSSR } from '@/lib/supabase/server';
import Link from 'next/link';
import { redirect } from 'next/navigation';

export default async function QuestionSetsPage() {
    const supabase = await sbSSR();

    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/auth/sign-in');
    }

    const { data: { session } } = await supabase.auth.getSession();
    let role: string | null = session?.user?.app_metadata?.user_role ?? null;

    if (!role && session?.access_token) {
        try {
            const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                user_role?: string;
                app_metadata?: { user_role?: string };
            };
            role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
        } catch {
            role = null;
        }
    }

    let isAdmin = role === 'admin' || role === 'dev';

    if (!isAdmin) {
        const { data: isAdminRpc, error: rpcError } = await supabase.rpc('is_admin');
        isAdmin = !rpcError && Boolean(isAdminRpc);
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    // Fetch all question sets with question counts
    const { data: questionSets, error } = await supabase
        .from('question_sets')
        .select(`
            *,
            papers!inner(title, slug)
        `)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching question sets:', error);
    }

    // Define type for question set from database
    type QuestionSetRow = NonNullable<typeof questionSets>[number];

    interface GroupedSet {
        paper: { title: string; slug: string };
        sets: QuestionSetRow[];
    }

    // Group by paper for display
    const groupedSets = (questionSets ?? []).reduce<Record<string, GroupedSet>>((acc, set) => {
        const paperId = set.paper_id;
        if (!acc[paperId]) {
            acc[paperId] = {
                paper: set.papers,
                sets: [],
            };
        }
        acc[paperId].sets.push(set);
        return acc;
    }, {});

    const getSetTypeColor = (setType: string) => {
        switch (setType) {
            case 'VARC': return 'bg-purple-100 text-purple-800';
            case 'DILR': return 'bg-orange-100 text-orange-800';
            case 'CASELET': return 'bg-blue-100 text-blue-800';
            case 'ATOMIC': return 'bg-gray-100 text-gray-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    };

    const getSectionColor = (section: string) => {
        switch (section) {
            case 'VARC': return 'bg-section-varc/10 text-section-varc';
            case 'DILR': return 'bg-section-dilr/10 text-section-dilr';
            case 'QA': return 'bg-section-qa/10 text-section-qa';
            default: return 'bg-gray-100 text-gray-800';
        }
    };

    return (
        <div className="space-y-8">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">Question Sets</h1>
                    <p className="text-gray-600 mt-1">
                        Manage RC passages, DI/LR sets, and grouped questions
                    </p>
                </div>
                <Link
                    href="/admin/question-sets/new"
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                    </svg>
                    New Question Set
                </Link>
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="bg-white rounded-lg shadow p-4">
                    <p className="text-sm text-gray-500">Total Sets</p>
                    <p className="text-2xl font-bold">{questionSets?.length ?? 0}</p>
                </div>
                <div className="bg-purple-50 rounded-lg shadow p-4">
                    <p className="text-sm text-purple-600">VARC Passages</p>
                    <p className="text-2xl font-bold text-purple-700">
                        {questionSets?.filter(s => s.set_type === 'VARC').length ?? 0}
                    </p>
                </div>
                <div className="bg-orange-50 rounded-lg shadow p-4">
                    <p className="text-sm text-orange-600">DILR Sets</p>
                    <p className="text-2xl font-bold text-orange-700">
                        {questionSets?.filter(s => s.set_type === 'DILR').length ?? 0}
                    </p>
                </div>
                <div className="bg-gray-50 rounded-lg shadow p-4">
                    <p className="text-sm text-gray-600">Atomic Questions</p>
                    <p className="text-2xl font-bold text-gray-700">
                        {questionSets?.filter(s => s.set_type === 'ATOMIC').length ?? 0}
                    </p>
                </div>
            </div>

            {/* Question Sets List */}
            {Object.keys(groupedSets).length === 0 ? (
                <div className="bg-white rounded-lg shadow p-8 text-center">
                    <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    <h3 className="text-lg font-medium text-gray-900 mb-2">No Question Sets Yet</h3>
                    <p className="text-gray-500 mb-4">
                        Create your first question set to organize RC passages, DI/LR sets, and grouped questions.
                    </p>
                    <Link
                        href="/admin/question-sets/new"
                        className="inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                    >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                        Create Question Set
                    </Link>
                </div>
            ) : (
                <div className="space-y-6">
                    {Object.entries(groupedSets).map(([paperId, { paper, sets }]) => (
                        <div key={paperId} className="bg-white rounded-lg shadow overflow-hidden">
                            <div className="bg-gray-50 px-6 py-4 border-b">
                                <h2 className="font-semibold text-gray-900">{paper.title}</h2>
                                <p className="text-sm text-gray-500">{sets.length} question set(s)</p>
                            </div>
                            <div className="divide-y">
                                {sets.map((set) => (
                                    <div key={set.id} className="px-6 py-4 hover:bg-gray-50 transition-colors">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-4">
                                                <div className="flex gap-2">
                                                    <span className={`px-2 py-1 rounded text-xs font-medium ${getSectionColor(set.section)}`}>
                                                        {set.section}
                                                    </span>
                                                    <span className={`px-2 py-1 rounded text-xs font-medium ${getSetTypeColor(set.set_type)}`}>
                                                        {set.set_type}
                                                    </span>
                                                </div>
                                                <div>
                                                    <p className="font-medium text-gray-900">
                                                        {set.context_title || `Set #${set.display_order}`}
                                                    </p>
                                                    <p className="text-sm text-gray-500">
                                                        {set.question_count} question(s) •
                                                        Layout: {set.content_layout}
                                                        {set.is_published && (
                                                            <span className="ml-2 text-green-600">✓ Published</span>
                                                        )}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <Link
                                                    href={`/admin/question-sets/${set.id}/edit`}
                                                    className="text-blue-600 hover:text-blue-800 px-3 py-1 rounded hover:bg-blue-50"
                                                >
                                                    Edit
                                                </Link>
                                            </div>
                                        </div>
                                        {set.context_body && (
                                            <p className="text-sm text-gray-600 mt-2 line-clamp-2">
                                                {set.context_body.substring(0, 200)}...
                                            </p>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}
````

## File: src/app/admin/questions/new/page.tsx
````typescript
/**
 * @fileoverview New Question Form
 * @description Admin page to create a new question with full editing capabilities
 */

'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { sb } from '@/lib/supabase/client';
import { adminLogger } from '@/lib/logger';

interface Paper {
    id: string;
    title: string;
    slug: string;
}

interface Context {
    id: string;
    title: string;
    section: string;
    paper_id: string;
}

export default function NewQuestionPage() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const preselectedPaperId = searchParams.get('paper');

    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [papers, setPapers] = useState<Paper[]>([]);
    const [contexts, setContexts] = useState<Context[]>([]);

    const [formData, setFormData] = useState({
        paper_id: preselectedPaperId || '',
        section: 'VARC',
        question_number: 1,
        question_text: '',
        question_type: 'MCQ',
        options: ['', '', '', ''],
        correct_answer: '',
        positive_marks: 3,
        negative_marks: 1,
        solution_text: '',
        difficulty: 'medium',
        topic: '',
        subtopic: '',
        context_id: '',
    });

    // Fetch papers and contexts on mount
    useEffect(() => {
        const fetchData = async () => {
            const supabase = sb();

            const [papersResult, contextsResult] = await Promise.all([
                supabase.from('papers').select('id, title, slug').order('title'),
                supabase.from('question_contexts').select('id, title, section, paper_id').order('title'),
            ]);

            if (papersResult.data) setPapers(papersResult.data as Paper[]);
            if (contextsResult.data) setContexts(contextsResult.data as Context[]);
        };

        fetchData();
    }, []);

    // Filter contexts by selected paper
    const filteredContexts = contexts.filter(
        c => c.paper_id === formData.paper_id && c.section === formData.section
    );

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        const { name, value, type } = e.target;
        setFormData((prev) => ({
            ...prev,
            [name]: type === 'number' ? Number(value) : value,
        }));
    };

    const handleOptionChange = (index: number, value: string) => {
        setFormData((prev) => ({
            ...prev,
            options: prev.options.map((opt, i) => (i === index ? value : opt)),
        }));
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            const supabase = sb();

            // Prepare options as JSONB array
            const optionsJson = formData.question_type === 'MCQ'
                ? formData.options.filter(o => o.trim() !== '')
                : null;

            const { data, error: insertError } = await supabase
                .from('questions')
                .insert({
                    paper_id: formData.paper_id,
                    section: formData.section,
                    question_number: formData.question_number,
                    question_text: formData.question_text,
                    question_type: formData.question_type,
                    options: optionsJson,
                    correct_answer: formData.correct_answer,
                    positive_marks: formData.positive_marks,
                    negative_marks: formData.question_type === 'TITA' ? 0 : formData.negative_marks,
                    solution_text: formData.solution_text || null,
                    difficulty: formData.difficulty,
                    topic: formData.topic || null,
                    subtopic: formData.subtopic || null,
                    context_id: formData.context_id || null,
                })
                .select()
                .single();

            if (insertError) throw insertError;

            // Redirect to edit page or questions list
            router.push(`/admin/questions/${data.id}`);
        } catch (err: unknown) {
            adminLogger.dataModified('questions', 'create_error', { error: err });
            setError(err instanceof Error ? err.message : 'Failed to create question');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="max-w-4xl mx-auto">
            <h1 className="text-2xl font-bold text-gray-900 mb-6">Add New Question</h1>

            <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow p-6 space-y-6">
                {error && (
                    <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                        {error}
                    </div>
                )}

                {/* Paper & Section Selection */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label htmlFor="paper_id" className="block text-sm font-medium text-gray-700 mb-1">
                            Paper *
                        </label>
                        <select
                            id="paper_id"
                            name="paper_id"
                            value={formData.paper_id}
                            onChange={handleChange}
                            required
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="">Select a paper</option>
                            {papers.map((paper) => (
                                <option key={paper.id} value={paper.id}>
                                    {paper.title}
                                </option>
                            ))}
                        </select>
                    </div>

                    <div>
                        <label htmlFor="section" className="block text-sm font-medium text-gray-700 mb-1">
                            Section *
                        </label>
                        <select
                            id="section"
                            name="section"
                            value={formData.section}
                            onChange={handleChange}
                            required
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="VARC">VARC</option>
                            <option value="DILR">DILR</option>
                            <option value="QA">QA</option>
                        </select>
                    </div>

                    <div>
                        <label htmlFor="question_number" className="block text-sm font-medium text-gray-700 mb-1">
                            Question Number *
                        </label>
                        <input
                            type="number"
                            id="question_number"
                            name="question_number"
                            value={formData.question_number}
                            onChange={handleChange}
                            required
                            min={1}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                </div>

                {/* Context Selection */}
                <div>
                    <label htmlFor="context_id" className="block text-sm font-medium text-gray-700 mb-1">
                        Context/Passage (optional)
                    </label>
                    <select
                        id="context_id"
                        name="context_id"
                        value={formData.context_id}
                        onChange={handleChange}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="">No context (standalone question)</option>
                        {filteredContexts.map((context) => (
                            <option key={context.id} value={context.id}>
                                {context.title}
                            </option>
                        ))}
                    </select>
                    <p className="mt-1 text-xs text-gray-500">
                        Select a passage/context that this question is based on
                    </p>
                </div>

                {/* Question Content */}
                <div>
                    <label htmlFor="question_text" className="block text-sm font-medium text-gray-700 mb-1">
                        Question Text *
                    </label>
                    <textarea
                        id="question_text"
                        name="question_text"
                        value={formData.question_text}
                        onChange={handleChange}
                        required
                        rows={6}
                        placeholder="Enter the question text here..."
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                    />
                </div>

                {/* Question Type & Options */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label htmlFor="question_type" className="block text-sm font-medium text-gray-700 mb-1">
                            Question Type *
                        </label>
                        <select
                            id="question_type"
                            name="question_type"
                            value={formData.question_type}
                            onChange={handleChange}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="MCQ">MCQ (Multiple Choice)</option>
                            <option value="TITA">TITA (Type in the Answer)</option>
                        </select>
                    </div>

                    <div>
                        <label htmlFor="correct_answer" className="block text-sm font-medium text-gray-700 mb-1">
                            Correct Answer *
                        </label>
                        {formData.question_type === 'MCQ' ? (
                            <select
                                id="correct_answer"
                                name="correct_answer"
                                value={formData.correct_answer}
                                onChange={handleChange}
                                required
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="">Select correct option</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        ) : (
                            <input
                                type="text"
                                id="correct_answer"
                                name="correct_answer"
                                value={formData.correct_answer}
                                onChange={handleChange}
                                required
                                placeholder="Enter the exact answer"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                        )}
                    </div>
                </div>

                {/* MCQ Options */}
                {formData.question_type === 'MCQ' && (
                    <div className="space-y-4">
                        <label className="block text-sm font-medium text-gray-700">
                            Options
                        </label>
                        {['A', 'B', 'C', 'D'].map((label, index) => (
                            <div key={label} className="flex items-start gap-3">
                                <span className="mt-2 w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-sm font-medium">
                                    {label}
                                </span>
                                <textarea
                                    value={formData.options[index]}
                                    onChange={(e) => handleOptionChange(index, e.target.value)}
                                    rows={2}
                                    placeholder={`Option ${label}`}
                                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>
                        ))}
                    </div>
                )}

                {/* Marks & Difficulty */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label htmlFor="positive_marks" className="block text-sm font-medium text-gray-700 mb-1">
                            Positive Marks
                        </label>
                        <input
                            type="number"
                            id="positive_marks"
                            name="positive_marks"
                            value={formData.positive_marks}
                            onChange={handleChange}
                            min={0}
                            step={0.5}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <div>
                        <label htmlFor="negative_marks" className="block text-sm font-medium text-gray-700 mb-1">
                            Negative Marks
                        </label>
                        <input
                            type="number"
                            id="negative_marks"
                            name="negative_marks"
                            value={formData.question_type === 'TITA' ? 0 : formData.negative_marks}
                            onChange={handleChange}
                            min={0}
                            step={0.5}
                            disabled={formData.question_type === 'TITA'}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100"
                        />
                        {formData.question_type === 'TITA' && (
                            <p className="mt-1 text-xs text-gray-500">TITA questions have no negative marking</p>
                        )}
                    </div>

                    <div>
                        <label htmlFor="difficulty" className="block text-sm font-medium text-gray-700 mb-1">
                            Difficulty
                        </label>
                        <select
                            id="difficulty"
                            name="difficulty"
                            value={formData.difficulty}
                            onChange={handleChange}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>

                    <div>
                        <label htmlFor="topic" className="block text-sm font-medium text-gray-700 mb-1">
                            Topic
                        </label>
                        <input
                            type="text"
                            id="topic"
                            name="topic"
                            value={formData.topic}
                            onChange={handleChange}
                            placeholder="e.g., Reading Comprehension"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                </div>

                {/* Solution */}
                <div>
                    <label htmlFor="solution_text" className="block text-sm font-medium text-gray-700 mb-1">
                        Solution/Explanation
                    </label>
                    <textarea
                        id="solution_text"
                        name="solution_text"
                        value={formData.solution_text}
                        onChange={handleChange}
                        rows={4}
                        placeholder="Explain the solution..."
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>

                <div className="flex justify-end gap-4 pt-4 border-t">
                    <button
                        type="button"
                        onClick={() => router.back()}
                        className="px-4 py-2 text-gray-700 hover:text-gray-900"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        disabled={loading}
                        className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
                    >
                        {loading ? 'Creating...' : 'Create Question'}
                    </button>
                </div>
            </form>
        </div>
    );
}
````

## File: src/app/api/admin/question-sets/route.ts
````typescript
/**
 * @fileoverview Question Sets API Route
 * @description CRUD operations for question sets
 * @blueprint Question Container Architecture
 */

import { NextRequest, NextResponse } from 'next/server';
import { sbSSR } from '@/lib/supabase/server';
import { createClient } from '@supabase/supabase-js';

const CONTEXT_TYPE_VALUES = new Set([
    'rc_passage',
    'dilr_set',
    'caselet',
    'data_table',
    'graph',
    'other_shared_stimulus',
]);

function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin API requires service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

async function verifyAdmin() {
    const supabase = await sbSSR();
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error || !user) {
        throw new Error('Unauthorized');
    }

    // SKIP_ADMIN_CHECK only allowed in non-production environments
    const skipAdminCheck = process.env.SKIP_ADMIN_CHECK === 'true' && process.env.NODE_ENV !== 'production';
    if (!skipAdminCheck) {
        const { data: { session } } = await supabase.auth.getSession();
        let role: string | null = session?.user?.app_metadata?.user_role ?? null;

        if (!role && session?.access_token) {
            try {
                const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                    user_role?: string;
                    app_metadata?: { user_role?: string };
                };
                role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
            } catch {
                role = null;
            }
        }

        if (role !== 'admin' && role !== 'dev') {
            const { data: isAdmin, error: rpcError } = await supabase.rpc('is_admin');
            if (rpcError || !isAdmin) {
                throw new Error('Unauthorized');
            }
        }
    }

    return user;
}

export async function POST(request: NextRequest) {
    try {
        await verifyAdmin();
        const adminClient = getAdminClient();

        const body = await request.json();
        const {
            paper_id,
            section,
            set_type,
            content_layout,
            context_title,
            context_body,
            context_image_url,
            context_type,
            questions,
        } = body;

        // Validate required fields
        if (!paper_id || !section || !set_type) {
            return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });
        }

        // Get next display_order for this section
        const { data: existingSets } = await adminClient
            .from('question_sets')
            .select('display_order')
            .eq('paper_id', paper_id)
            .eq('section', section)
            .order('display_order', { ascending: false })
            .limit(1);

        const nextDisplayOrder = (existingSets?.[0]?.display_order ?? 0) + 1;

        if (context_type && !CONTEXT_TYPE_VALUES.has(context_type)) {
            return NextResponse.json({ error: 'Invalid context_type' }, { status: 400 });
        }

        // Create the question set
        const { data: questionSet, error: setError } = await adminClient
            .from('question_sets')
            .insert({
                paper_id,
                section,
                set_type,
                content_layout: content_layout || 'single_focus',
                context_title: context_title || null,
                context_body: context_body || null,
                context_image_url: context_image_url || null,
                context_type: context_type || null,
                display_order: nextDisplayOrder,
                is_active: true,
                is_published: false,
            })
            .select()
            .single();

        if (setError) {
            console.error('Error creating question set:', setError);
            return NextResponse.json({ error: setError.message }, { status: 500 });
        }

        // Create questions if provided
        if (questions && questions.length > 0) {
            // Get next question_number for this paper/section
            const { data: existingQuestions } = await adminClient
                .from('questions')
                .select('question_number')
                .eq('paper_id', paper_id)
                .eq('section', section)
                .order('question_number', { ascending: false })
                .limit(1);

            let nextQuestionNumber = (existingQuestions?.[0]?.question_number ?? 0) + 1;

            const questionsToInsert = questions.map((q: {
                question_text: string;
                question_type: string;
                options?: string[];
                correct_answer: string;
                positive_marks?: number;
                negative_marks?: number;
                sequence_order?: number;
                difficulty?: string;
                topic?: string;
            }, index: number) => ({
                paper_id,
                section,
                set_id: questionSet.id,
                question_number: nextQuestionNumber + index,
                sequence_order: q.sequence_order || index + 1,
                question_text: q.question_text,
                question_type: q.question_type,
                options: q.question_type === 'MCQ' ? q.options : null,
                correct_answer: q.correct_answer,
                positive_marks: q.positive_marks ?? 3,
                negative_marks: q.negative_marks ?? (q.question_type === 'TITA' ? 0 : 1),
                difficulty: q.difficulty || null,
                topic: q.topic || null,
                is_active: true,
            }));

            const { error: questionsError } = await adminClient
                .from('questions')
                .insert(questionsToInsert);

            if (questionsError) {
                console.error('Error creating questions:', questionsError);
                // Rollback: delete the question set
                await adminClient.from('question_sets').delete().eq('id', questionSet.id);
                return NextResponse.json({ error: questionsError.message }, { status: 500 });
            }
        }

        return NextResponse.json({ success: true, data: questionSet });
    } catch (error) {
        console.error('Question sets API error:', error);
        return NextResponse.json(
            { error: error instanceof Error ? error.message : 'Internal server error' },
            { status: 500 }
        );
    }
}

export async function GET(request: NextRequest) {
    try {
        await verifyAdmin();

        const adminClient = getAdminClient();

        const { searchParams } = new URL(request.url);
        const paperId = searchParams.get('paper_id');

        let query = adminClient
            .from('question_sets')
            .select('*, questions(*)')
            .order('display_order', { ascending: true });

        if (paperId) {
            query = query.eq('paper_id', paperId);
        }

        const { data, error } = await query;

        if (error) {
            console.error('Error fetching question sets:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({ success: true, data });
    } catch (error) {
        console.error('Question sets API error:', error);
        return NextResponse.json(
            { error: error instanceof Error ? error.message : 'Internal server error' },
            { status: 500 }
        );
    }
}
````

## File: src/app/api/pause/route.ts
````typescript
import { NextRequest, NextResponse } from 'next/server';
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { pauseExam } from '@/features/exam-engine/lib/actions';
import { examLogger } from '@/lib/logger';
import { getServiceRoleClient } from '@/lib/supabase/service-role';
import {
    isNonEmptyString,
    isFiniteNumber,
    isValidTimeRemaining,
    getSupabaseConfig,
    serverMisconfiguredResponse,
    addVersionHeader,
} from '../_utils/validation';

export async function POST(req: NextRequest) {
    const res = NextResponse.next();

    try {
        const { attemptId, timeRemaining, currentSection, currentQuestion, sessionToken } = await req.json();

        if (!isNonEmptyString(attemptId)) {
            return addVersionHeader(NextResponse.json({ error: 'attemptId is required' }, { status: 400 }));
        }
        if (!isValidTimeRemaining(timeRemaining)) {
            return addVersionHeader(NextResponse.json({ error: 'timeRemaining is invalid' }, { status: 400 }));
        }
        if (!isNonEmptyString(currentSection)) {
            return addVersionHeader(NextResponse.json({ error: 'currentSection is required' }, { status: 400 }));
        }
        // CRITICAL: Use isFiniteNumber to correctly handle currentQuestion = 0
        if (!isFiniteNumber(currentQuestion)) {
            return addVersionHeader(NextResponse.json({ error: 'currentQuestion is invalid' }, { status: 400 }));
        }

        // Phase 4: Validate session token if provided (keeps pause consistent with save/submit)
        if (sessionToken) {
            const config = getSupabaseConfig();
            if (!config) {
                return addVersionHeader(serverMisconfiguredResponse());
            }

            const supabase = createServerClient(config.url, config.anonKey, {
                cookies: {
                    getAll() {
                        return req.cookies.getAll();
                    },
                    setAll(cookiesToSet: Array<{ name: string; value: string; options: CookieOptions }>) {
                        cookiesToSet.forEach(({ name, value, options }) => {
                            res.cookies.set({ name, value, ...options });
                        });
                    },
                },
            });

                const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: isValidSession } = await supabase.rpc('validate_session_token', {
                    p_attempt_id: attemptId,
                    p_session_token: sessionToken,
                    p_user_id: user.id,
                });

                if (isValidSession === false) {
                    examLogger.securityEvent('Pause session mismatch', { attemptId });
                    return addVersionHeader(NextResponse.json({
                        error: 'Session conflict detected',
                        code: 'SESSION_CONFLICT',
                        canForceResume: true,
                    }, { status: 409 }));
                }
            }
        }

        let adminClient: ReturnType<typeof getServiceRoleClient>;
        try {
            adminClient = getServiceRoleClient();
        } catch {
            return addVersionHeader(serverMisconfiguredResponse());
        }
        const { data: attemptRow, error: attemptError } = await adminClient
            .from('attempts')
            .select('id, paper_id, papers(allow_pause)')
            .eq('id', attemptId)
            .maybeSingle();

        if (attemptError || !attemptRow) {
            return addVersionHeader(NextResponse.json({ error: 'Attempt not found' }, { status: 404 }));
        }

        const paperRel = attemptRow.papers as { allow_pause?: boolean } | { allow_pause?: boolean }[] | null;
        const allowPause = Array.isArray(paperRel) ? paperRel[0]?.allow_pause : paperRel?.allow_pause;

        if (allowPause === false) {
            return addVersionHeader(NextResponse.json({ error: 'Pausing not allowed for this exam' }, { status: 400 }));
        }

        const result = await pauseExam({
            attemptId,
            timeRemaining,
            currentSection: currentSection as import('@/types/exam').SectionName,
            currentQuestion,
        });

        if (!result.success) {
            return addVersionHeader(NextResponse.json({ error: result.error || 'Failed to pause exam' }, { status: 400 }));
        }

        const success = NextResponse.json({ success: true });
        res.cookies.getAll().forEach((cookie) => success.cookies.set(cookie));
        return addVersionHeader(success);
    } catch {
        return addVersionHeader(NextResponse.json({ error: 'Invalid JSON' }, { status: 400 }));
    }
}
````

## File: src/app/page.tsx
````typescript
import LandingPageClient from '@/components/landing/LandingPageClient';

export default function Home() {
    return <LandingPageClient />;
}
````

## File: src/app/result/[attemptId]/ResultReviewClient.tsx
````typescript
/**
 * @fileoverview Exam-style review client for results page
 * @description Uses QuestionRenderer to mirror the exam UI in read-only review mode
 */

'use client';

import { useMemo, useCallback, useState, useEffect, useRef } from 'react';
import type { QuestionSetComplete, SectionName, PerformanceReason } from '@/types/exam';
import { assemblePaper } from '@/features/exam-engine/lib/assemblePaper';
import { QuestionRenderer } from '@/features/exam-engine/ui/QuestionRenderer';
import { isCompositeSet } from '@/types/exam';
import { getAnalysisStore } from '@/features/exam-engine/model/useExamStore';
import { compareAnswers } from '@/features/exam-engine/lib/scoring';

const SECTION_ORDER: SectionName[] = ['VARC', 'DILR', 'QA'];

const parseSection = (value: string | null): SectionName | undefined => {
    if (!value) return undefined;
    return SECTION_ORDER.includes(value as SectionName) ? (value as SectionName) : undefined;
};

const REASON_OPTIONS: Array<{ value: PerformanceReason; label: string }> = [
    { value: 'concept_gap', label: 'Concept gap' },
    { value: 'careless_error', label: 'Silly mistake' },
    { value: 'time_pressure', label: 'Time pressure' },
    { value: 'guess', label: 'Guess/unsure' },
];

interface ReviewNavState {
    section: SectionName;
    setIndex: number;
    questionIndex: number;
}

interface ResultReviewClientProps {
    paperTitle: string;
    questionSets: QuestionSetComplete[];
    answerMap: Record<string, string | null>;
    correctAnswerMap: Record<string, string>;
    solutionMap?: Record<string, {
        solution_text?: string | null;
        solution_image_url?: string | null;
        video_solution_url?: string | null;
    }>;
    responseMetaMap?: Record<string, {
        time_spent_seconds?: number | null;
        visit_count?: number | null;
        updated_at?: string | null;
    }>;
    responseStatusMap?: Record<string, string | null | undefined>;
    attemptId?: string | null;
}

function getSectionSets(sets: QuestionSetComplete[], section: SectionName): QuestionSetComplete[] {
    return sets.filter((set) => set.section === section).sort((a, b) => {
        const orderA = a.display_order ?? 0;
        const orderB = b.display_order ?? 0;
        if (orderA !== orderB) return orderA - orderB;
        return a.id.localeCompare(b.id);
    });
}

export function ResultReviewClient({
    paperTitle,
    questionSets,
    answerMap,
    correctAnswerMap,
    solutionMap,
    responseMetaMap = {},
    responseStatusMap = {},
    attemptId,
}: ResultReviewClientProps) {
    const assembled = useMemo(() => assemblePaper(questionSets), [questionSets]);
    // Default to expanded/fullscreen for better editing experience
    const [isExpanded, setIsExpanded] = useState(true);
    const hasInitializedRef = useRef(false);
    const storageKey = `attempt:${attemptId ?? 'unknown'}:reviewNav`;

    const analysisStore = getAnalysisStore(attemptId ?? 'result-review');
    const analysisReasons = analysisStore((s) => s.reasons);
    const bookmarkedQuestions = analysisStore((s) => s.bookmarks);
    const setAnalysisReason = analysisStore((s) => s.setReason);
    const toggleBookmark = analysisStore((s) => s.toggleBookmark);

    const [navState, setNavState] = useState<ReviewNavState>({
        section: 'VARC',
        setIndex: 0,
        questionIndex: 0,
    });

    const updateNavState = useCallback((updates: Partial<ReviewNavState>) => {
        setNavState((prev) => ({ ...prev, ...updates }));
    }, []);

    const sectionSets = useMemo(
        () => getSectionSets(assembled.questionSets, navState.section),
        [assembled.questionSets, navState.section]
    );

    const questionPositionMapGlobal = useMemo(() => {
        const map = new Map<string, { section: SectionName; setIndex: number; questionIndex: number }>();
        SECTION_ORDER.forEach((section) => {
            const sets = getSectionSets(assembled.questionSets, section);
            sets.forEach((set, setIdx) => {
                set.questions.forEach((q, qIdx) => {
                    map.set(q.id, { section, setIndex: setIdx, questionIndex: qIdx });
                });
            });
        });
        return map;
    }, [assembled.questionSets]);

    const currentSet = sectionSets[navState.setIndex];

    const hasContextPane = useMemo(() => {
        if (!currentSet) return false;
        const isComposite = isCompositeSet(currentSet.set_type);
        if (!isComposite) return false;
        const hasMedia = Boolean(
            currentSet.context_image_url ||
            (currentSet.context_additional_images && currentSet.context_additional_images.length > 0)
        );
        const isSingleQuestionSet = currentSet.questions.length === 1;
        return !(isSingleQuestionSet && !hasMedia);
    }, [currentSet]);

    const sectionCounts = useMemo(() => {
        const counts: Record<SectionName, number> = { VARC: 0, DILR: 0, QA: 0 };
        assembled.questionSets.forEach((set) => {
            counts[set.section] += set.questions.length;
        });
        return counts;
    }, [assembled.questionSets]);

    const handleSectionChange = useCallback((section: SectionName) => {
        updateNavState({ section, setIndex: 0, questionIndex: 0 });
    }, [updateNavState]);

    const handleQuestionChange = useCallback((index: number) => {
        updateNavState({ questionIndex: index });
    }, [updateNavState]);

    const sectionDisplay = navState.section === 'DILR' ? 'LRDI' : navState.section === 'QA' ? 'Quant' : navState.section;

    const formatDuration = (seconds?: number | null) => {
        const totalSeconds = Math.max(0, Math.floor(seconds ?? 0));
        const minutes = Math.floor(totalSeconds / 60);
        const remainingSeconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    };

    const questionPositionMap = useMemo(() => {
        const map = new Map<string, { setIndex: number; questionIndex: number }>();
        sectionSets.forEach((set, setIdx) => {
            set.questions.forEach((q, qIdx) => {
                map.set(q.id, { setIndex: setIdx, questionIndex: qIdx });
            });
        });
        return map;
    }, [sectionSets]);

    const handlePaletteSelect = useCallback((questionId: string) => {
        const pos = questionPositionMap.get(questionId);
        if (!pos) return;
        updateNavState({ setIndex: pos.setIndex, questionIndex: pos.questionIndex });
    }, [questionPositionMap, updateNavState]);

    const questionById = useMemo(() => {
        const map = new Map<string, (typeof sectionSets)[number]['questions'][number]>();
        sectionSets.forEach((set) => {
            set.questions.forEach((q) => {
                map.set(q.id, q);
            });
        });
        return map;
    }, [sectionSets]);

    const attemptOrderIds = useMemo(() => {
        const questionsInSection = sectionSets.flatMap((set) => set.questions);
        const withTimestamp = questionsInSection
            .filter((q) => responseMetaMap[q.id]?.updated_at)
            .sort((a, b) => {
                const aTime = new Date(responseMetaMap[a.id]?.updated_at as string).getTime();
                const bTime = new Date(responseMetaMap[b.id]?.updated_at as string).getTime();
                if (aTime !== bTime) return aTime - bTime;
                return a.question_number - b.question_number;
            });
        const withoutTimestamp = questionsInSection
            .filter((q) => !responseMetaMap[q.id]?.updated_at)
            .sort((a, b) => a.question_number - b.question_number);
        return withTimestamp.length > 0 ? [...withTimestamp, ...withoutTimestamp].map((q) => q.id) : withoutTimestamp.map((q) => q.id);
    }, [sectionSets, responseMetaMap]);

    const currentQuestion = currentSet?.questions?.[navState.questionIndex];
    const currentResponseMeta = currentQuestion ? responseMetaMap[currentQuestion.id] : undefined;
    const currentAnswer = currentQuestion ? answerMap[currentQuestion.id] : null;
    const currentCorrect = currentQuestion ? correctAnswerMap[currentQuestion.id] : null;
    const currentStatusRaw = currentQuestion ? responseStatusMap[currentQuestion.id] ?? null : null;
    const currentAnsweredStatus = currentStatusRaw === 'answered' || currentStatusRaw === 'answered_marked';
    const hasCurrentAnswer = currentAnsweredStatus || (currentAnswer !== null && currentAnswer !== undefined && String(currentAnswer).trim() !== '');
    const hasCurrentKey = currentCorrect !== null && currentCorrect !== undefined && String(currentCorrect).trim() !== '';
    const currentHasComparableAnswer =
        currentAnswer !== null && currentAnswer !== undefined && String(currentAnswer).trim() !== '';
    const currentIsCorrect =
        currentQuestion && hasCurrentKey && currentHasComparableAnswer
            ? compareAnswers(currentAnswer, String(currentCorrect), currentQuestion.question_type)
            : null;
    const currentStatus = !hasCurrentAnswer
        ? 'Not Attempted'
        : currentIsCorrect === null
            ? 'Attempted'
            : currentIsCorrect
                ? 'Correct'
                : 'Incorrect';
    const currentIsIncorrect = currentIsCorrect === false;
    const currentIsSkipped = !hasCurrentAnswer;
    const selectedReason = currentQuestion ? analysisReasons[currentQuestion.id] ?? null : null;
    const isBookmarked = currentQuestion ? Boolean(bookmarkedQuestions[currentQuestion.id]) : false;

    useEffect(() => {
        if (typeof window === 'undefined') return;

        const resolveNavigation = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const urlSection = parseSection(urlParams.get('section'));
            const urlSetIndex = urlParams.get('set') ? Number(urlParams.get('set')) : undefined;
            const urlQIndex = urlParams.get('q') ? Number(urlParams.get('q')) : undefined;
            const urlQid = urlParams.get('qid');

            if (urlQid) {
                const pos = questionPositionMapGlobal.get(urlQid);
                if (pos) {
                    setNavState({
                        section: pos.section,
                        setIndex: pos.setIndex,
                        questionIndex: pos.questionIndex,
                    });
                    hasInitializedRef.current = true;
                    return;
                }
            }

            if (urlSection !== undefined) {
                setNavState({
                    section: urlSection,
                    setIndex: Number.isFinite(urlSetIndex) && urlSetIndex! >= 0 ? urlSetIndex! : 0,
                    questionIndex: Number.isFinite(urlQIndex) && urlQIndex! >= 0 ? urlQIndex! : 0,
                });
                hasInitializedRef.current = true;
                return;
            }

            const storedRaw = window.localStorage.getItem(storageKey);
            if (storedRaw) {
                try {
                    const stored = JSON.parse(storedRaw) as ReviewNavState & { qid?: string | null };
                    if (stored.qid) {
                        const pos = questionPositionMapGlobal.get(stored.qid);
                        if (pos) {
                            setNavState({
                                section: pos.section,
                                setIndex: pos.setIndex,
                                questionIndex: pos.questionIndex,
                            });
                            hasInitializedRef.current = true;
                            return;
                        }
                    }

                    if (stored.section && SECTION_ORDER.includes(stored.section)) {
                        setNavState({
                            section: stored.section,
                            setIndex: Number.isFinite(stored.setIndex) && stored.setIndex >= 0 ? stored.setIndex : 0,
                            questionIndex: Number.isFinite(stored.questionIndex) && stored.questionIndex >= 0 ? stored.questionIndex : 0,
                        });
                        hasInitializedRef.current = true;
                        return;
                    }
                } catch {
                    window.localStorage.removeItem(storageKey);
                }
            }

            setNavState({ section: 'VARC', setIndex: 0, questionIndex: 0 });
            hasInitializedRef.current = true;
        };

        resolveNavigation();

        const handlePopState = () => resolveNavigation();
        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
    }, [questionPositionMapGlobal, storageKey]);

    useEffect(() => {
        if (typeof window === 'undefined') return;
        if (!hasInitializedRef.current) return;

        const qid = currentSet?.questions?.[navState.questionIndex]?.id ?? null;

        window.localStorage.setItem(
            storageKey,
            JSON.stringify({ ...navState, qid })
        );

        const url = new URL(window.location.href);
        url.searchParams.set('section', navState.section);
        url.searchParams.set('set', String(navState.setIndex));
        url.searchParams.set('q', String(navState.questionIndex));
        if (qid) url.searchParams.set('qid', qid);
        else url.searchParams.delete('qid');

        window.history.replaceState({}, '', url.toString());
    }, [navState, storageKey, currentSet]);

    useEffect(() => {
        if (typeof document === 'undefined') return;
        if (isExpanded) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
        return () => {
            document.body.style.overflow = '';
        };
    }, [isExpanded]);

    return (
        <section
            id="exam-review"
            className={`bg-exam-bg-page border border-exam-bg-border-light overflow-hidden font-exam flex flex-col min-h-[620px] ${isExpanded ? 'fixed inset-0 z-[80] rounded-none h-screen shadow-2xl' : 'rounded-2xl h-[calc(100vh-220px)]'}`}
        >
            <header className="h-14 flex items-center justify-between px-6 bg-gradient-to-r from-exam-header-from to-exam-header-to text-white">
                <div className="flex items-center gap-3">
                    <span className="inline-flex items-center rounded-full bg-white/15 px-3 py-1 text-xs font-semibold uppercase tracking-wide">
                        Review Mode
                    </span>
                    <h2 className="text-base font-semibold">{paperTitle}</h2>
                </div>
                <div className="flex items-center gap-3 text-xs text-white/80">
                    <span>Exam-style Review</span>
                    <button
                        type="button"
                        onClick={() => setIsExpanded((prev) => !prev)}
                        className="rounded-full border border-white/30 px-3 py-1 text-[11px] font-semibold text-white hover:bg-white/10"
                    >
                        {isExpanded ? 'Exit Fullscreen' : 'Expand'}
                    </button>
                </div>
            </header>

            <div className="bg-white border-b border-exam-bg-border flex">
                {SECTION_ORDER.map((section) => {
                    const isActive = navState.section === section;
                    const label = section === 'DILR' ? 'LRDI' : section === 'QA' ? 'Quant' : section;
                    return (
                        <button
                            key={section}
                            type="button"
                            onClick={() => handleSectionChange(section)}
                            className={`px-6 py-3 text-sm font-semibold transition-colors border-b-2 ${isActive
                                ? 'border-blue-600 text-blue-600 bg-blue-50'
                                : 'border-transparent text-gray-600 hover:text-gray-800 hover:bg-gray-50'
                                }`}
                        >
                            {label} ({sectionCounts[section]})
                        </button>
                    );
                })}
            </div>

            <div className="flex-1 overflow-hidden">
                <div className={`h-full grid ${hasContextPane ? 'grid-cols-[48%_33%_19%]' : 'grid-cols-[81%_19%]'}`}>
                    <div className={`min-h-0 overflow-hidden ${hasContextPane ? 'col-span-2 grid grid-cols-2' : 'col-span-1'}`}>
                        {currentSet ? (
                            <QuestionRenderer
                                questionSet={currentSet}
                                activeQuestionIndex={navState.questionIndex}
                                onQuestionChange={handleQuestionChange}
                                responses={answerMap}
                                isReviewMode={true}
                                readOnly={true}
                                showCorrectAnswer={true}
                                correctAnswerMap={correctAnswerMap}
                                solutionMap={solutionMap}
                            />
                        ) : (
                            <div className="col-span-2 flex items-center justify-center text-gray-500">
                                No questions in this section.
                            </div>
                        )}
                    </div>

                    <aside className="border-l border-exam-bg-border bg-slate-50 overflow-y-auto min-h-0">
                        <div className="p-4">
                            <h3 className="font-semibold text-gray-700 mb-3">Attempt Order</h3>
                            <div className="grid grid-cols-5 gap-2">
                                {attemptOrderIds.map((questionId, index) => {
                                    const q = questionById.get(questionId);
                                    if (!q) return null;
                                    const isActive = currentQuestion?.id === q.id;
                                    const answer = answerMap[q.id];
                                    const rawStatus = responseStatusMap[q.id] ?? null;
                                    const isAnsweredStatus = rawStatus === 'answered' || rawStatus === 'answered_marked';
                                    const hasAnswer = isAnsweredStatus || (answer !== null && answer !== undefined && String(answer).trim() !== '');
                                    const hasComparableAnswer =
                                        answer !== null && answer !== undefined && String(answer).trim() !== '';
                                    const correctAnswer = correctAnswerMap[q.id] ?? '';
                                    const hasCorrect = typeof correctAnswer === 'string' && correctAnswer.trim() !== '';
                                    const isCorrect =
                                        hasAnswer && hasComparableAnswer && hasCorrect
                                            ? compareAnswers(answer, correctAnswer, q.question_type)
                                            : null;
                                    const statusClass = !hasAnswer
                                        ? 'bg-gray-200 text-gray-700'
                                        : isCorrect === null
                                            ? 'bg-blue-500 text-white'
                                            : isCorrect
                                                ? 'bg-emerald-500 text-white'
                                                : 'bg-rose-500 text-white';
                                    return (
                                        <button
                                            key={q.id}
                                            type="button"
                                            onClick={() => handlePaletteSelect(q.id)}
                                            className={`w-10 h-10 rounded text-sm font-medium transition-colors ${isActive
                                                ? `${statusClass} ring-2 ring-offset-1 ring-blue-400`
                                                : `${statusClass} hover:opacity-90`
                                                }`}
                                            title={`Attempt #${index + 1} - ${!hasAnswer
                                                ? 'Not attempted'
                                                : isCorrect === null
                                                    ? 'Attempted'
                                                    : isCorrect
                                                        ? 'Correct'
                                                        : 'Incorrect'
                                                }`}
                                        >
                                            {q.question_number}
                                        </button>
                                    );
                                })}
                            </div>

                            <div className="mt-6 p-3 bg-white rounded border border-gray-200 text-xs text-gray-600 space-y-2">
                                <div className="flex items-center justify-between">
                                    <div className="font-semibold text-gray-700">Question Metadata</div>
                                    {currentQuestion && (
                                        <button
                                            type="button"
                                            onClick={() => toggleBookmark(currentQuestion.id)}
                                            className={`inline-flex items-center gap-1 rounded-full border px-2 py-1 text-[11px] font-semibold transition-colors ${isBookmarked
                                                ? 'border-amber-300 bg-amber-50 text-amber-600'
                                                : 'border-gray-200 text-gray-500 hover:bg-gray-50'
                                                }`}
                                            aria-pressed={isBookmarked}
                                        >
                                            <svg
                                                className="h-3.5 w-3.5"
                                                viewBox="0 0 24 24"
                                                fill={isBookmarked ? 'currentColor' : 'none'}
                                                stroke="currentColor"
                                                strokeWidth={2}
                                            >
                                                <path
                                                    strokeLinecap="round"
                                                    strokeLinejoin="round"
                                                    d="M5 4a2 2 0 012-2h10a2 2 0 012 2v18l-7-4-7 4V4z"
                                                />
                                            </svg>
                                            {isBookmarked ? 'Bookmarked' : 'Bookmark'}
                                        </button>
                                    )}
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <span className="text-gray-400 block">Time Spent</span>
                                        <span className="font-semibold text-gray-800">{formatDuration(currentResponseMeta?.time_spent_seconds)}</span>
                                    </div>
                                    <div>
                                        <span className="text-gray-400 block">Status</span>
                                        <span className="font-semibold text-gray-800">{currentStatus}</span>
                                    </div>
                                    <div>
                                        <span className="text-gray-400 block">Topic</span>
                                        <span className="font-semibold text-gray-800">{currentQuestion?.topic ?? '—'}</span>
                                    </div>
                                    <div>
                                        <span className="text-gray-400 block">Subtopic</span>
                                        <span className="font-semibold text-gray-800">{currentQuestion?.subtopic ?? '—'}</span>
                                    </div>
                                    <div>
                                        <span className="text-gray-400 block">Difficulty</span>
                                        <span className="font-semibold text-gray-800">{currentQuestion?.difficulty ?? '—'}</span>
                                    </div>
                                    <div>
                                        <span className="text-gray-400 block">Section</span>
                                        <span className="font-semibold text-gray-800">{sectionDisplay}</span>
                                    </div>
                                </div>
                                {currentQuestion && (currentIsIncorrect || currentIsSkipped) && (
                                    <div className="mt-2 rounded-md border border-amber-100 bg-amber-50/70 p-2">
                                        <div className="flex items-center justify-between text-[11px] font-semibold text-amber-700">
                                            <span>Reason for Performance</span>
                                            <span className="uppercase text-[10px] text-amber-600">
                                                {currentIsSkipped ? 'Skipped' : 'Incorrect'}
                                            </span>
                                        </div>
                                        <div className="mt-2 flex flex-wrap gap-2">
                                            {REASON_OPTIONS.map((option) => {
                                                const isActive = selectedReason === option.value;
                                                return (
                                                    <button
                                                        key={option.value}
                                                        type="button"
                                                        onClick={() => {
                                                            if (!currentQuestion) return;
                                                            setAnalysisReason(currentQuestion.id, isActive ? null : option.value);
                                                        }}
                                                        className={`px-2.5 py-1 text-[11px] rounded-full border transition-colors ${isActive
                                                            ? 'bg-amber-500 text-white border-amber-500'
                                                            : 'bg-white text-amber-700 border-amber-200 hover:bg-amber-100'
                                                            }`}
                                                    >
                                                        {option.label}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                                <p className="text-[11px] text-gray-400">Order reflects your attempt sequence.</p>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </section>
    );
}
````

## File: src/features/exam-engine/lib/index.ts
````typescript
/**
 * @fileoverview Exam Engine Library - Barrel Export
 * @description Server actions and validation schemas
 * @blueprint Milestone 4 - Feature-Sliced Design (FSD)
 */

// Server Actions
export {
    fetchPaperForExam,
    saveResponse,
    updateAttemptProgress,
    submitExam,
    fetchExamResults,
    type ActionResult,
} from './actions';

// Validation Schemas
export {
    // Base schemas
    SectionNameSchema,
    QuestionTypeSchema,
    QuestionStatusSchema,
    AttemptStatusSchema,
    DifficultySchema,
    PaperDifficultySchema,

    // Entity schemas
    SectionConfigSchema,
    QuestionSchema,
    QuestionWithAnswerSchema,
    PaperSchema,
    AttemptSchema,
    ResponseSchema,
    TimeRemainingSchema,
    SectionScoreSchema,
    SectionScoresSchema,

    // Request schemas
    FetchPaperRequestSchema,
    SaveResponseRequestSchema,
    UpdateTimerRequestSchema,
    SubmitExamRequestSchema,

    // Response schemas
    ApiResponseSchema,
    FetchPaperResponseSchema,
    SubmitExamResponseSchema,

    // Types
    type SectionNameInput,
    type QuestionInput,
    type QuestionWithAnswerInput,
    type PaperInput,
    type AttemptInput,
    type ResponseInput,
    type TimeRemainingInput,
    type SaveResponseRequest,
    type UpdateTimerRequest,
    type SubmitExamRequest,
    type FetchPaperResponse,
    type SubmitExamResponse,
} from './validation';

// Scoring Engine (Milestone 5)
export {
    calculateScore,
    calculateQuestionMarks,
    calculateTimeTaken,
    compareAnswers,
    normalizeString,
    parseAsNumber,
    type ResponseForScoring,
    type QuestionScoringResult,
    type ScoringResult,
} from './scoring';
````

## File: src/features/exam-engine/ui/ExamTimer.tsx
````typescript
/**
 * @fileoverview Exam Timer Display Component
 * @description Visual timer display with progress bar and state-based styling
 * @blueprint Milestone 4 SOP-SSOT - Phase 3.1
 */

'use client';

import { useExamTimer, type TimerDisplayData } from '@/features/exam-engine';

// =============================================================================
// TIMER DISPLAY COMPONENT
// =============================================================================

interface ExamTimerProps {
    /** Optional CSS class name */
    className?: string;
    /** Show progress bar */
    showProgressBar?: boolean;
    /** Compact mode (for header) */
    compact?: boolean;
}

/**
 * Get color classes based on timer state
 */
function getTimerStyles(state: TimerDisplayData['state']) {
    // TCS iON-inspired colors
    switch (state) {
        case 'critical':
            return {
                text: 'text-[#d32f2f] animate-pulse',
                bg: 'bg-[#d32f2f]',
                border: 'border-[#c62828]',
                progressBg: 'bg-red-100',
            };
        case 'warning':
            return {
                text: 'text-[#f9a825]',
                bg: 'bg-[#f9a825]',
                border: 'border-[#f57f17]',
                progressBg: 'bg-yellow-100',
            };
        case 'expired':
            return {
                text: 'text-gray-500',
                bg: 'bg-gray-500',
                border: 'border-gray-500',
                progressBg: 'bg-gray-100',
            };
        default:
            return {
                text: 'text-[#2e7d32]',
                bg: 'bg-[#388e3c]',
                border: 'border-[#2e7d32]',
                progressBg: 'bg-green-100',
            };
    }
}

export function ExamTimer({
    className = '',
    showProgressBar = true,
    compact = false
}: ExamTimerProps) {
    const { timerData } = useExamTimer();
    const styles = getTimerStyles(timerData.state);

    if (compact) {
        // Compact mode for dark header - use white text with state-based background
        const compactBg = timerData.state === 'critical'
            ? 'bg-red-600/20'
            : timerData.state === 'warning'
                ? 'bg-yellow-500/20'
                : '';
        return (
            <div className={`flex items-center gap-2 ${className}`}>
                <span className="text-sm text-white/80">{timerData.sectionName}</span>
                <span className={`font-mono text-lg font-bold text-white ${compactBg} px-1 rounded ${timerData.state === 'critical' ? 'animate-pulse' : ''}`}>
                    {timerData.displayTime}
                </span>
            </div>
        );
    }

    return (
        <div className={`flex flex-col items-center ${className}`}>
            {/* Section Name */}
            <div className="text-sm font-semibold text-[#0b3d91] mb-1">
                {timerData.sectionName} Section
            </div>

            {/* Time Display */}
            <div className={`font-mono text-3xl font-bold ${styles.text}`}>
                {timerData.displayTime}
            </div>

            {/* Progress Bar */}
            {showProgressBar && (
                <div className={`w-full mt-2 h-2 rounded-full border ${styles.progressBg}`}>
                    <div
                        className={`h-full rounded-full transition-all duration-1000 ${styles.bg}`}
                        style={{ width: `${timerData.progressPercent}%` }}
                    />
                </div>
            )}

            {/* State Label */}
            {timerData.state === 'warning' && (
                <div className="mt-1 text-xs text-orange-500 font-medium">
                    Less than 5 minutes remaining
                </div>
            )}
            {timerData.state === 'critical' && (
                <div className="mt-1 text-xs text-red-600 font-medium animate-pulse">
                    Less than 1 minute remaining!
                </div>
            )}
            {timerData.state === 'expired' && (
                <div className="mt-1 text-xs text-gray-600 font-medium">
                    Time expired
                </div>
            )}
        </div>
    );
}

// =============================================================================
// SECTION TIMER SUMMARY
// =============================================================================

interface SectionTimerSummaryProps {
    className?: string;
}

/**
 * Shows all three section timers in a summary view
 */
export function SectionTimerSummary({ className = '' }: SectionTimerSummaryProps) {
    const { timerData } = useExamTimer();

    return (
        <div className={`flex items-center justify-between text-sm ${className}`}>
            <div className="flex items-center gap-4">
                <span className="font-medium text-gray-600">Time Left:</span>
                <span className={`font-mono font-bold ${getTimerStyles(timerData.state).text}`}>
                    {timerData.displayTime}
                </span>
            </div>
            <div className="text-gray-500">
                Section: <span className="font-medium text-gray-700">{timerData.sectionName}</span>
            </div>
        </div>
    );
}
````

## File: src/lib/rate-limit.ts
````typescript
/**
 * @fileoverview Rate Limiting Utility for Pilot Phase
 * @description In-memory rate limiter to protect against frontend loops and abuse
 * @blueprint Security Audit - P0 Fix - Rate Limiting
 */

// =============================================================================
// TYPES
// =============================================================================

interface RateLimitRecord {
    count: number;
    resetAt: number;
}

interface RateLimitResult {
    allowed: boolean;
    remaining: number;
    resetAt: number;
    retryAfterMs: number;
}

interface RateLimitConfig {
    limit: number;
    windowMs: number;
}

// =============================================================================
// IN-MEMORY STORE
// =============================================================================

/**
 * Simple in-memory rate limit store
 * Note: This resets on server restart and doesn't work across multiple instances
 * For production scale, upgrade to Redis/Upstash
 */
const requestCounts = new Map<string, RateLimitRecord>();

// Cleanup old entries every 5 minutes to prevent memory leaks
const CLEANUP_INTERVAL_MS = 5 * 60 * 1000;

let cleanupInterval: NodeJS.Timeout | null = null;

function startCleanup() {
    if (cleanupInterval) return;

    cleanupInterval = setInterval(() => {
        const now = Date.now();
        for (const [key, record] of requestCounts.entries()) {
            if (now > record.resetAt) {
                requestCounts.delete(key);
            }
        }
    }, CLEANUP_INTERVAL_MS);

    // Don't prevent process exit
    if (cleanupInterval.unref) {
        cleanupInterval.unref();
    }
}

// Start cleanup on module load
startCleanup();

// =============================================================================
// RATE LIMIT CONFIGURATIONS
// =============================================================================

/**
 * Rate limit configurations for different endpoints
 * Tuned for pilot phase with ~100 concurrent users
 */
export const RATE_LIMITS = {
    // Exam save operations - generous for pilot (serverless cold starts reset state)
    SAVE_RESPONSE: {
        limit: 200,          // 200 requests (up from 60)
        windowMs: 60_000,    // per minute
    },

    // Exam submissions - slightly more generous for edge cases
    SUBMIT_EXAM: {
        limit: 10,           // 10 submissions (up from 5)
        windowMs: 60_000,    // per minute
    },

    // Authentication operations - more generous for pilot
    AUTH: {
        limit: 30,           // 30 attempts (up from 10)
        windowMs: 60_000,    // per minute
    },

    // Waitlist request submissions
    ACCESS_REQUEST: {
        limit: 5,            // 5 requests
        windowMs: 60_000,    // per minute
    },

    // Start mock attempts (prevent rapid creation)
    START_MOCK: {
        limit: 15,           // 15 attempts
        windowMs: 60_000,    // per minute
    },

    // General API endpoints - generous for pilot
    GENERAL_API: {
        limit: 300,          // 300 requests (up from 100)
        windowMs: 60_000,    // per minute
    },

    // Exam page loads (prevent rapid refreshing)
    EXAM_LOAD: {
        limit: 20,           // 20 loads
        windowMs: 60_000,    // per minute
    },

    // Progress updates (timer sync)
    PROGRESS_UPDATE: {
        limit: 30,           // 30 updates
        windowMs: 60_000,    // per minute
    },
} as const;

// =============================================================================
// CORE RATE LIMITING FUNCTION
// =============================================================================

/**
 * Check if a request is allowed under rate limits
 * 
 * @param identifier - Unique identifier (userId, IP, or combination)
 * @param config - Rate limit configuration
 * @returns Rate limit result with allowed status and metadata
 * 
 * @example
 * ```typescript
 * const result = checkRateLimit(`save:${userId}`, RATE_LIMITS.SAVE_RESPONSE);
 * if (!result.allowed) {
 *     return NextResponse.json({ error: 'Rate limit exceeded' }, { status: 429 });
 * }
 * ```
 */
export function checkRateLimit(
    identifier: string,
    config: RateLimitConfig
): RateLimitResult {
    const now = Date.now();
    const record = requestCounts.get(identifier);

    // No existing record or window expired - create new
    if (!record || now > record.resetAt) {
        requestCounts.set(identifier, {
            count: 1,
            resetAt: now + config.windowMs,
        });

        return {
            allowed: true,
            remaining: config.limit - 1,
            resetAt: now + config.windowMs,
            retryAfterMs: 0,
        };
    }

    // Check if limit exceeded
    if (record.count >= config.limit) {
        return {
            allowed: false,
            remaining: 0,
            resetAt: record.resetAt,
            retryAfterMs: record.resetAt - now,
        };
    }

    // Increment count
    record.count++;

    return {
        allowed: true,
        remaining: config.limit - record.count,
        resetAt: record.resetAt,
        retryAfterMs: 0,
    };
}

// =============================================================================
// CONVENIENCE HELPERS
// =============================================================================

/**
 * Create rate limit key for user-specific limits
 */
export function userRateLimitKey(endpoint: string, userId: string): string {
    return `user:${userId}:${endpoint}`;
}

/**
 * Create rate limit key for IP-based limits
 */
export function ipRateLimitKey(endpoint: string, ip: string): string {
    return `ip:${ip}:${endpoint}`;
}

/**
 * Create rate limit key combining user and endpoint
 */
export function createRateLimitKey(
    type: 'user' | 'ip' | 'combined',
    endpoint: string,
    identifier: string,
    secondaryIdentifier?: string
): string {
    switch (type) {
        case 'user':
            return `user:${identifier}:${endpoint}`;
        case 'ip':
            return `ip:${identifier}:${endpoint}`;
        case 'combined':
            return `combined:${identifier}:${secondaryIdentifier || 'unknown'}:${endpoint}`;
        default:
            return `unknown:${identifier}:${endpoint}`;
    }
}

// =============================================================================
// RATE LIMIT RESPONSE HELPERS
// =============================================================================

/**
 * Create a rate limit exceeded response
 */
export function createRateLimitResponse(result: RateLimitResult): {
    error: string;
    retryAfterSeconds: number;
    limit: number;
    remaining: number;
} {
    return {
        error: 'Rate limit exceeded. Please slow down.',
        retryAfterSeconds: Math.ceil(result.retryAfterMs / 1000),
        limit: 0, // Will be set by caller
        remaining: result.remaining,
    };
}

/**
 * Get rate limit headers for response
 */
export function getRateLimitHeaders(
    result: RateLimitResult,
    limit: number
): Record<string, string> {
    return {
        'X-RateLimit-Limit': limit.toString(),
        'X-RateLimit-Remaining': result.remaining.toString(),
        'X-RateLimit-Reset': Math.ceil(result.resetAt / 1000).toString(),
        ...(result.retryAfterMs > 0 && {
            'Retry-After': Math.ceil(result.retryAfterMs / 1000).toString(),
        }),
    };
}

// =============================================================================
// MONITORING / DEBUGGING
// =============================================================================

/**
 * Get current rate limit stats (for monitoring/debugging)
 */
export function getRateLimitStats(): {
    totalKeys: number;
    activeKeys: number;
    keysByPrefix: Record<string, number>;
} {
    const now = Date.now();
    let activeKeys = 0;
    const keysByPrefix: Record<string, number> = {};

    for (const [key, record] of requestCounts.entries()) {
        if (now <= record.resetAt) {
            activeKeys++;
        }

        const prefix = key.split(':')[0];
        keysByPrefix[prefix] = (keysByPrefix[prefix] || 0) + 1;
    }

    return {
        totalKeys: requestCounts.size,
        activeKeys,
        keysByPrefix,
    };
}

/**
 * Clear all rate limit records (for testing)
 */
export function clearRateLimits(): void {
    requestCounts.clear();
}

// =============================================================================
// SUPABASE FREE TIER LIMITS (Reference)
// =============================================================================

/**
 * Supabase Free Tier Limits for reference
 * Use these to tune rate limits appropriately
 */
export const SUPABASE_FREE_TIER = {
    // Database
    MAX_CONNECTIONS: 60,           // Pooled connections
    MAX_ROWS_RETURNED: 1000,       // Per query
    MAX_QUERY_TIME_MS: 8000,       // 8 seconds

    // API
    REQUESTS_PER_SECOND: 100,      // Approximate sustained

    // Auth
    AUTH_REQUESTS_PER_HOUR: 1000,  // Per project

    // Realtime
    MAX_REALTIME_CONNECTIONS: 200, // Concurrent

    // Storage
    MAX_FILE_SIZE_MB: 50,          // Per file
} as const;
````

## File: src/lib/supabase/server.ts
````typescript
// Supabase server client helper using @supabase/ssr
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export function sbServer() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string | undefined;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string | undefined;
    // Generic server client without cookie persistence (use per-request client in routes for auth-sensitive flows)
    return createServerClient(url || 'http://localhost:54321', anon || 'anon', {
        cookies: {
            get() {
                return undefined;
            },
            set() {
                /* no-op */
            },
            remove() {
                /* no-op */
            },
        },
    });
}

export async function getServerSession() {
    const supabase = sbServer();
    const { data } = await supabase.auth.getSession();
    return data.session ?? null;
}

// Per-request SSR client that can read auth cookies in server components/route handlers
export async function sbSSR() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string | undefined;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string | undefined;
    const cookieStore = await cookies();
    return createServerClient(url || 'http://localhost:54321', anon || 'anon', {
        cookies: {
            getAll() {
                return cookieStore.getAll();
            },
            setAll(cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options }) => {
                        cookieStore.set(name, value, options);
                    });
                } catch {
                    // Read-only cookie store in server components; safe to ignore.
                }
            },
        },
    });
}
````

## File: tailwind.config.js
````javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
    content: [
        './src/app/**/*.{js,ts,jsx,tsx}',
        './src/components/**/*.{js,ts,jsx,tsx}',
        './src/features/**/*.{js,ts,jsx,tsx}',
    ],
    theme: {
        extend: {
            // TCS iON CAT Exam Color Palette
            colors: {
                // Header & Footer
                'exam-header': {
                    from: '#2c3e50',
                    to: '#34495e',
                    border: '#1a252f',
                },
                // Section Colors
                'section': {
                    varc: '#3498db',
                    dilr: '#2ecc71',
                    qa: '#e74c3c',
                    inactive: '#ecf0f1',
                },
                // Question Status Colors
                'status': {
                    answered: '#4caf50',
                    'answered-dark': '#388e3c',
                    marked: '#9c27b0',
                    'marked-dark': '#7b1fa2',
                    visited: '#e53935',
                    'visited-dark': '#c62828',
                    current: '#3498db',
                    'current-dark': '#2980b9',
                    'not-visited': '#ffffff',
                    border: '#bdc3c7',
                },
                // Timer & Accent
                'timer': '#f39c12',
                // Text Colors
                'exam-text': {
                    primary: '#212529',
                    secondary: '#495057',
                    muted: '#7f8c8d',
                    body: '#333333',
                },
                // Background Colors
                'exam-bg': {
                    page: '#f5f5f5',
                    pane: '#f8f9fa',
                    white: '#ffffff',
                    border: '#dee2e6',
                    'border-light': '#e9ecef',
                },
            },
            // Custom font family for exam
            fontFamily: {
                'exam': ["'Segoe UI'", 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
            },
            // Fixed heights matching TCS iON
            height: {
                'header': '60px',
                'section-bar': '48px',
                'metadata-bar': '40px',
                'footer': '50px',
                'btn': '42px',
                'q-btn': '48px',
            },
            // Custom spacing
            spacing: {
                '4.5': '18px',
                '7.5': '30px',
            },
            // Line heights
            lineHeight: {
                'exam': '1.6',
            },
        },
    },
    plugins: [],
};
````

## File: tsconfig.json
````json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
````

## File: .github/workflows/ci.yml
````yaml
name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable corepack
        run: corepack enable

      - name: Set up pnpm
        run: corepack prepare pnpm@latest --activate

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm exec tsc --noEmit

      - name: Build
        run: pnpm build

      - name: Blueprint guard
        run: node scripts/blueprint-guard.mjs

      - name: Check bundle size
        run: node scripts/check-bundle.mjs

      - name: Ensure no .env files are committed
        run: |
          if git ls-files | grep -E '(^|/).*\.env($|\.)' | grep -v -E '(^|/)\.env(\.[^/]+)?\.example$' ; then
            echo "Error: .env files should not be committed. Use .env.example and environment secrets instead." >&2
            exit 1
          fi
````

## File: eslint.config.mjs
````javascript
import nextPlugin from "@next/eslint-plugin-next";
import tsPlugin from "@typescript-eslint/eslint-plugin";
import tsParser from "@typescript-eslint/parser";
import unusedImports from "eslint-plugin-unused-imports";

const eslintConfig = [
  {
    ignores: [
      "node_modules/**",
      ".next/**",
      "out/**",
      "build/**",
      "next-env.d.ts",
    ],
  },
  {
    files: ["**/*.{js,mjs,cjs,ts,tsx}"],
    plugins: {
      "@next/next": nextPlugin,
      "@typescript-eslint": tsPlugin,
      "unused-imports": unusedImports,
    },
    languageOptions: {
      parser: tsParser,
      parserOptions: {
        ecmaVersion: "latest",
        sourceType: "module",
        ecmaFeatures: { jsx: true },
      },
    },
    rules: {
      ...nextPlugin.configs.recommended.rules,
      ...nextPlugin.configs["core-web-vitals"].rules,
      "@next/next/no-img-element": "off",
      "@typescript-eslint/no-unused-vars": ["warn", { argsIgnorePattern: "^_" }],
      "@typescript-eslint/no-explicit-any": "error",
      "unused-imports/no-unused-imports": "warn",
      "unused-imports/no-unused-vars": ["warn", { argsIgnorePattern: "^_", varsIgnorePattern: "^_" }],
    },
  },
];

export default eslintConfig;
````

## File: scripts/check-bundle.mjs
````javascript
#!/usr/bin/env node

/**
 * Bundle Budget Checker
 * Analyzes bundle size and enforces size limits
 */

import { execSync } from 'child_process';
const BUDGET_MB = 10; // 10 MB budget (total .next JS files; First Load JS per route is ~100-150 KB)


function getBundleSize() {
  try {
    // Run build if not already built
    console.log('Building application...');
    execSync('pnpm build', { stdio: 'inherit' });

    // Analyze bundle size (simplified - in real implementation you'd use source-map-explorer)
    const stats = execSync('find .next -name "*.js" -exec du -bc {} + | tail -1', { encoding: 'utf8' });
    const sizeBytes = parseInt(stats.split('\t')[0]);
    const sizeMB = sizeBytes / (1024 * 1024);

    return sizeMB;
  } catch (error) {
    console.error('Error analyzing bundle:', error.message);
    return null;
  }
}

function checkBundleBudget() {
  const bundleSize = getBundleSize();

  if (bundleSize === null) {
    console.error('❌ Bundle analysis failed');
    process.exit(1);
  }

  console.log(`📦 Bundle size: ${bundleSize.toFixed(2)} MB`);
  console.log(`🎯 Budget: ${BUDGET_MB} MB`);

  if (bundleSize > BUDGET_MB) {
    console.error(`❌ Bundle budget exceeded by ${(bundleSize - BUDGET_MB).toFixed(2)} MB`);
    process.exit(1);
  } else {
    console.log(`✅ Bundle budget passed (${(BUDGET_MB - bundleSize).toFixed(2)} MB remaining)`);
  }
}

// Run the check
checkBundleBudget();
````

## File: src/app/admin/papers/page.tsx
````typescript
/**
 * @fileoverview Papers List Page
 * @description Admin page to view and manage all papers
 */

import { sbSSR } from '@/lib/supabase/server';
import { adminLogger } from '@/lib/logger';
import Link from 'next/link';
import { redirect } from 'next/navigation';
import PaperActions from './PaperActions';
import ImportPaperButton from './ImportPaperButton';

export default async function PapersPage() {
    const supabase = await sbSSR();

    // Server-side admin verification
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/auth/sign-in');
    }

    const { data: { session } } = await supabase.auth.getSession();
    let role: string | null = session?.user?.app_metadata?.user_role ?? null;

    if (!role && session?.access_token) {
        try {
            const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                user_role?: string;
                app_metadata?: { user_role?: string };
            };
            role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
        } catch {
            role = null;
        }
    }

    let isAdmin = role === 'admin' || role === 'dev';

    if (!isAdmin) {
        const { data: isAdminRpc, error: rpcError } = await supabase.rpc('is_admin');
        isAdmin = !rpcError && Boolean(isAdminRpc);
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    const { data: papers, error } = await supabase
        .from('papers')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        adminLogger.dataModified('papers', 'fetch_error', { error });
    }

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                <h1 className="text-2xl font-bold text-gray-900">Papers</h1>
                <div className="flex items-center gap-3">
                    <ImportPaperButton />
                    <Link
                        href="/admin/papers/new"
                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                    >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                        New Paper
                    </Link>
                </div>
            </div>

            <div className="bg-white rounded-lg shadow overflow-hidden">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Title
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Year
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Questions
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Created
                            </th>
                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {papers && papers.length > 0 ? (
                            papers.map((paper) => (
                                <tr key={paper.id} className="hover:bg-gray-50">
                                    <td className="px-6 py-4 whitespace-nowrap">
                                        <div>
                                            <div className="text-sm font-medium text-gray-900">{paper.title}</div>
                                            <div className="text-sm text-gray-500">{paper.slug}</div>
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {paper.year}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {paper.total_questions}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap">
                                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${paper.published
                                            ? 'bg-green-100 text-green-800'
                                            : 'bg-yellow-100 text-yellow-800'
                                            }`}>
                                            {paper.published ? 'Published' : 'Draft'}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {new Date(paper.created_at).toLocaleDateString()}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                                        <PaperActions paperId={paper.id} />
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan={6} className="px-6 py-12 text-center text-gray-500">
                                    No papers found. <Link href="/admin/papers/new" className="text-blue-600 hover:underline">Create your first paper</Link>
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
}
````

## File: src/app/api/save-batch/route.ts
````typescript
/**
 * @fileoverview Save Responses Batch API Route
 * @description Saves a batch of answers during an exam to reduce request volume
 */

import { NextRequest, NextResponse } from 'next/server';
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { checkRateLimit, RATE_LIMITS, userRateLimitKey, getRateLimitHeaders } from '@/lib/rate-limit';
import { examLogger } from '@/lib/logger';
import { getServiceRoleClient } from '@/lib/supabase/service-role';
import {
    isNonEmptyString,
    getSupabaseConfig,
    serverMisconfiguredResponse,
    addVersionHeader,
} from '../_utils/validation';

type BatchItem = {
    questionId: string;
    answer: string | null;
    status?: string;
    isMarkedForReview?: boolean;
    isVisited?: boolean;
    timeSpentSeconds?: number;
    visitCount?: number;
};

type ValidateSessionResult = { data: boolean | null; error: { code?: string; message?: string } | null };

function isMissingValidateFn(error?: { code?: string; message?: string } | null): boolean {
    if (!error) return false;
    return error.code === '42883' || Boolean(error.message?.includes('validate_session_token'));
}

async function validateSessionTokenRpc(
    supabase: { rpc: (fn: string, args: Record<string, unknown>) => PromiseLike<ValidateSessionResult> },
    attemptId: string,
    sessionToken: string,
    userId: string
): Promise<ValidateSessionResult> {
    const primary = await supabase.rpc('validate_session_token', {
        p_attempt_id: attemptId,
        p_session_token: sessionToken,
        p_user_id: userId,
    });

    if (!primary.error || !isMissingValidateFn(primary.error)) return primary;

    return supabase.rpc('validate_session_token', {
        p_attempt_id: attemptId,
        p_session_token: sessionToken,
        p_user_id: userId,
        p_force_resume: false,
    });
}

export async function POST(req: NextRequest) {
    const res = NextResponse.next();

    try {
        const body = await req.json();
        const { attemptId, responses, sessionToken, force_resume } = body ?? {};

        if (!isNonEmptyString(attemptId)) {
            return addVersionHeader(NextResponse.json({ error: 'attemptId is required' }, { status: 400 }));
        }
        if (!Array.isArray(responses) || responses.length === 0) {
            return addVersionHeader(NextResponse.json({ error: 'responses array is required' }, { status: 400 }));
        }

        const config = getSupabaseConfig();
        if (!config) {
            return addVersionHeader(serverMisconfiguredResponse());
        }

        const supabase = createServerClient(config.url, config.anonKey, {
            cookies: {
                get(name: string) {
                    return req.cookies.get(name)?.value;
                },
                set(name: string, value: string, options: CookieOptions) {
                    res.cookies.set({ name, value, ...options });
                },
                remove(name: string, options: CookieOptions) {
                    res.cookies.set({ name, value: '', ...options });
                },
            },
        });

        const {
            data: { session },
        } = await supabase.auth.getSession();

        if (!session) {
            return addVersionHeader(NextResponse.json({ error: 'Unauthorized' }, { status: 401 }));
        }

        // Rate limit (batch counts as one save request)
        const rateLimitKey = userRateLimitKey('save', session.user.id);
        const rateLimitResult = checkRateLimit(rateLimitKey, RATE_LIMITS.SAVE_RESPONSE);

        if (!rateLimitResult.allowed) {
            const headers = getRateLimitHeaders(rateLimitResult, RATE_LIMITS.SAVE_RESPONSE.limit);
            return NextResponse.json(
                {
                    error: 'Rate limit exceeded. Please slow down.',
                    retryAfterSeconds: Math.ceil(rateLimitResult.retryAfterMs / 1000),
                },
                { status: 429, headers }
            );
        }

        const adminClient = getServiceRoleClient();
        const { data: attempt, error: attemptError } = await adminClient
            .from('attempts')
            .select('id, user_id, status, started_at, paper_id, submitted_at')
            .eq('id', attemptId)
            .maybeSingle();

        if (attemptError || !attempt) {
            return NextResponse.json({ error: 'Failed to fetch attempt' }, { status: 500 });
        }

        if (attempt.user_id !== session.user.id) {
            return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
        }

        // FIX: Allow saves during submit transition grace period (60 seconds after submit)
        // This prevents data loss when submit times out but actually succeeds on server
        const isInProgress = attempt.status === 'in_progress';
        const isPaused = attempt.status === 'paused';
        const isRecentlySubmitted = attempt.status === 'submitted' && attempt.submitted_at &&
            (Date.now() - new Date(attempt.submitted_at as string).getTime()) < 60000; // 60 second grace

        if (!isInProgress && !isPaused && !isRecentlySubmitted) {
            // Log for debugging - don't error if attempt is completed/submitted beyond grace
            console.log('Save-batch rejected - attempt not in progress', {
                attemptId,
                status: attempt.status,
                submitted_at: attempt.submitted_at,
            });
            return NextResponse.json({ error: 'Attempt is not in progress' }, { status: 400 });
        }

        if (!sessionToken) {
            return NextResponse.json({ error: 'Missing session token' }, { status: 400 });
        }

        const { data: isValidSession, error: validateError } = await validateSessionTokenRpc(
            supabase,
            attemptId,
            sessionToken,
            session.user.id
        );

        if (validateError) {
            examLogger.securityEvent('Save-batch session validation RPC error', {
                attemptId,
                errorMessage: validateError.message,
                errorCode: validateError.code,
            });
            if (force_resume === true) {
                const { error: forceResumeError } = await supabase.rpc('force_resume_exam_session', {
                    p_attempt_id: attemptId,
                    p_new_session_token: sessionToken,
                });
                if (forceResumeError) {
                    return NextResponse.json({ error: 'Failed to validate session', code: 'VALIDATION_RPC_ERROR' }, { status: 500 });
                }
            } else {
                return NextResponse.json({ error: 'Failed to validate session', code: 'VALIDATION_RPC_ERROR' }, { status: 500 });
            }
        }

        if (!isValidSession) {
            if (force_resume === true) {
                const { error: forceResumeError } = await supabase.rpc('force_resume_exam_session', {
                    p_attempt_id: attemptId,
                    p_new_session_token: sessionToken,
                });
                if (forceResumeError) {
                    return NextResponse.json({ error: 'Failed to force resume session' }, { status: 500 });
                }
            } else {
                examLogger.securityEvent('Save-batch session token mismatch', { attemptId });
                return NextResponse.json(
                    {
                        error: 'Session conflict detected. This exam may be open in another tab or device.',
                        code: 'SESSION_CONFLICT',
                        canForceResume: true,
                    },
                    { status: 409 }
                );
            }
        }

        // Build rows
        const rows = (responses as BatchItem[])
            .filter((r) => r && isNonEmptyString(r.questionId))
            .map((r) => {
                const row: Record<string, unknown> = {
                    attempt_id: attemptId,
                    question_id: r.questionId,
                    answer: r.answer ?? null,
                };

                if (typeof r.status === 'string') row.status = r.status;
                if (typeof r.isMarkedForReview === 'boolean') row.is_marked_for_review = r.isMarkedForReview;
                if (typeof r.isVisited === 'boolean') row.is_visited = r.isVisited;
                if (typeof r.timeSpentSeconds === 'number') row.time_spent_seconds = r.timeSpentSeconds;
                if (typeof r.visitCount === 'number') row.visit_count = r.visitCount;

                return row;
            });

        if (rows.length === 0) {
            return addVersionHeader(NextResponse.json({ success: true, saved: 0 }, { status: 200 }));
        }

        const { error } = await supabase
            .from('responses')
            .upsert(rows, { onConflict: 'attempt_id,question_id' });

        if (error) {
            return NextResponse.json({ error: error.message ?? 'Upsert failed' }, { status: 500 });
        }

        const successHeaders = getRateLimitHeaders(rateLimitResult, RATE_LIMITS.SAVE_RESPONSE.limit);
        const response = NextResponse.json({ success: true, saved: rows.length }, { status: 200 });
        Object.entries(successHeaders).forEach(([k, v]) => response.headers.set(k, String(v)));
        res.cookies.getAll().forEach((cookie) => response.cookies.set(cookie.name, cookie.value));
        return addVersionHeader(response);
    } catch {
        return addVersionHeader(NextResponse.json({ error: 'Invalid JSON' }, { status: 400 }));
    }
}
````

## File: src/app/auth/test-login/page.tsx
````typescript
'use client';

import { useEffect, useState, useCallback } from 'react';
import Link from 'next/link';
import { sb } from '@/lib/supabase/client';

export default function TestLoginPage() {
    const [loading, setLoading] = useState(false);
    const [sessionJson, setSessionJson] = useState<string>('');
    const [error, setError] = useState<string | null>(null);

    const refreshSession = useCallback(async () => {
        setLoading(true);
        setError(null);
        try {
            const { data, error: err } = await sb().auth.getSession();
            if (err) throw err;
            setSessionJson(JSON.stringify(data.session, null, 2));
        } catch (e) {
            const msg = e instanceof Error ? e.message : 'Failed to load session';
            setError(msg);
            setSessionJson('');
        } finally {
            setLoading(false);
        }
    }, []);

    useEffect(() => {
        refreshSession();
    }, [refreshSession]);

    const onSignIn = useCallback(async () => {
        setLoading(true);
        try {
            const configuredSiteUrl = process.env.NEXT_PUBLIC_SITE_URL || '';
            const origin = configuredSiteUrl || (typeof window !== 'undefined' ? window.location.origin : '');
            const callbackUrl = `${origin}/auth/callback?redirect_to=/auth/test-login`;
            await sb().auth.signInWithOAuth({ provider: 'google', options: { redirectTo: callbackUrl } });
        } finally {
            setLoading(false);
        }
    }, []);

    const onSignOut = useCallback(async () => {
        setLoading(true);
        try {
            await sb().auth.signOut();
        } finally {
            setLoading(false);
        }
    }, [refreshSession]);

    return (
        <main style={{ padding: 24, maxWidth: 720, margin: '0 auto' }}>
            <h1>Auth Test Utility</h1>
            <p style={{ marginBottom: 12 }}>Quickly verify Supabase auth/session locally or in deployments.</p>
            <div style={{ display: 'flex', gap: 8, marginBottom: 12 }}>
                <button onClick={onSignIn} disabled={loading} style={{ padding: 8 }}>
                    {loading ? 'Working…' : 'Sign in with Google'}
                </button>
                <button onClick={onSignOut} disabled={loading} style={{ padding: 8 }}>
                    Sign out
                </button>
                <button onClick={refreshSession} disabled={loading} style={{ padding: 8 }}>
                    Refresh session
                </button>
                <Link href="/dashboard" style={{ padding: 8, textDecoration: 'underline' }}>Go to dashboard</Link>
            </div>
            {error && <p style={{ color: 'crimson' }}>{error}</p>}
            <pre style={{ background: '#f5f5f5', padding: 12, borderRadius: 8, minHeight: 120, overflow: 'auto' }}>
                {sessionJson || 'No session'}
            </pre>
        </main>
    );
}
````

## File: src/app/globals.css
````css
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
    --color-accent-primary: #ff0000;
}

.top-progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--color-accent-primary);
    transform-origin: left;
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 150ms ease;
}

@media (max-width: 640px) {
    .top-progress-bar {
        height: 3px;
    }
}

@keyframes landing-fade-up {
    0% {
        opacity: 0;
        transform: translateY(12px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes landing-glow {
    0%,
    100% {
        opacity: 0.15;
        transform: scale(0.98);
    }
    50% {
        opacity: 0.45;
        transform: scale(1);
    }
}
````

## File: src/app/layout.tsx
````typescript
import type { Metadata } from "next";
import "./globals.css";
import "katex/dist/katex.min.css";
import AuthenticatedOverlays from "@/components/AuthenticatedOverlays";
import TopProgressBar from "@/components/TopProgressBar";

export const metadata: Metadata = {
  title: "CAT Mock Test Platform",
  description: "Practice CAT exams with adaptive testing and instant results",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className="font-sans antialiased">
        <TopProgressBar />
        {children}
        <AuthenticatedOverlays />
      </body>
    </html>
  );
}
````

## File: src/components/landing/LandingPageClient.tsx
````typescript
'use client';

import { useCallback, useEffect, useRef, useState } from 'react';
import { Space_Grotesk, Plus_Jakarta_Sans } from 'next/font/google';
import { sb } from '@/lib/supabase/client';
import { useLandingAssets } from '@/lib/useLandingAssets';
import type { LandingAsset } from '@/lib/landing-assets';
import { useFocusTrap } from '@/components/useFocusTrap';

const headingFont = Space_Grotesk({
    subsets: ['latin'],
    weight: ['400', '500', '600', '700'],
    display: 'swap',
});

const bodyFont = Plus_Jakarta_Sans({
    subsets: ['latin'],
    weight: ['400', '500', '600', '700'],
    display: 'swap',
});

const NAV_LINKS = [
    { id: 'mentor', label: 'Mentor' },
    { id: 'features', label: 'Features' },
    { id: 'roadmap', label: 'Roadmap' },
    { id: 'cat-hub', label: 'CAT Hub' },
];

const HERO_SLIDES = [
    {
        id: 'mock',
        label: 'Mock',
        title: 'Exam-like UI that trains composure.',
        subtitle: 'Section locks + timer + answer palette.',
        assetKey: 'hero_mock_ui',
        fallbackLabel: 'Mock UI preview',
        maskTop: true,
    },
    {
        id: 'mirror',
        label: 'Mirror',
        title: 'Mirror View: see time + accuracy patterns instantly.',
        subtitle: 'Attempts, revisits, speed traps, topic-wise breakdown.',
        assetKey: 'hero_mirror_view',
        fallbackLabel: 'Mirror analytics preview',
    },
    {
        id: 'coach',
        label: 'AI Coach',
        title: 'AI Coach: not just what you did - why you did it.',
        subtitle: 'Strategy flaws, strength zones, and next-step fixes.',
        insights: [
            'Your speed attempt caused 19% accuracy.',
            'Revisits = your edge (accuracy jumps when you revisit).',
            'DILR guessing is killing score - solve 1 set fully.',
        ],
    },
];

const HERO_CHIPS = [
    '4 official CAT papers live',
    'Section-locked 40-40-40 flow',
    'AI Coach (beta) + Mirror View',
];

const LIVE_STRIP_ITEMS = [
    {
        label: 'Live now',
        copy: '4 official CAT previous-year papers (full mocks)',
    },
    {
        label: 'Coming in March',
        copy: 'All official CAT papers from 2020 onwards - all slots (18 papers)',
    },
    {
        label: 'Coming in April',
        copy: 'NextCAT mock series launch',
    },
];

const FEATURE_CARDS = [
    {
        id: 'ai-coach',
        title: 'AI Coach (beta)',
        description: 'Hyper-personal strategy insights from your attempt behavior.',
        bullets: ['attempt order', 'time sinks', 'guessing patterns'],
        tag: 'Coming soon',
    },
    {
        id: 'nextcat',
        title: 'NextCAT (launch April)',
        description: 'Curated mock series built for CAT 2026 targets.',
        bullets: ['difficulty calibration', 'trap patterns', 'mentor-led review notes'],
        tag: 'Coming soon',
    },
    {
        id: 'mirror-view',
        title: 'Mirror View Analytics',
        description: 'Replay your attempt like a coach: speed, revisits, and topic breakdown.',
        bullets: ['time/question', 'revisit count', 'topic/subtopic', 'difficulty tags'],
    },
    {
        id: 'exam-ui',
        title: 'Exam-like Interface',
        description: 'Train the exact CAT flow: 40-40-40 with section locks.',
        bullets: ['answer palette', 'on-screen calculator', 'TITA practice'],
    },
];

const ROADMAP_ITEMS = [
    {
        period: 'Now (Beta)',
        copy: '4 PYQ mocks + mirror metrics',
    },
    {
        period: 'March',
        copy: '2020-2025 papers (all slots) + better review UX',
    },
    {
        period: 'April',
        copy: 'NextCAT series launch + AI Coach rollout for beta users',
    },
];

const CAT_HUB_ITEMS = [
    {
        title: '1. The "Syllabus Completion" Trap',
        body: 'Dropdown Content: Treating CAT as a knowledge test is fatal. Theory is 20%; application is 80%. CAT does not test if you know a formula, but if you can spot a hidden Algebra concept inside a Geometry problem.\nAI Insight: Use Mirror View to see if you are over-investing time in "easy" theory questions while failing tricky applications.',
    },
    {
        title: '2. Emotional "Sunk Cost" in DILR',
        body: 'Dropdown Content: The Ego Trap: Spending 8+ minutes on a set and refusing to leave because you have already "invested" time. Breakthroughs usually happen in the first 5 minutes; if not, walk away.\nPro Move: Detach emotionally. Skipping the wrong set is as valuable as solving the right one.',
    },
    {
        title: '3. Rote-Rule Dependency in VARC',
        body: 'Dropdown Content: Mechanical reading kills your rhythm. Relying solely on elimination techniques makes you slow. High percentilers build a reading ear through volume, allowing them to feel when an option is "off-tone".\nStrategy: Stop hunting for keywords; start following the author\'s argument.',
    },
    {
        title: '4. Ignoring the "Fatigue Tax"',
        body: 'Dropdown Content: Quant is the final section. Your brain\'s RAM is exhausted by then. Solving questions in chronological order (1, 2, 3...) is a recipe for failure.\nThe Fix: Use the Round Robin method. If the AI Coach detects you are missing easy Arithmetic late in the mock, your energy management is flawed.',
    },
    {
        title: '5. The "Fixed Attempt" Fallacy',
        body: 'Dropdown Content: Entering the hall with a target number (e.g., "I must do 15") leads to panic and blind guessing when a paper is tough. In difficult years, accuracy beats volume every time.\nThe Reality: 8-9 correct answers in a brutal section can still land a 99 percentile. Learn to read the paper\'s difficulty, not just chase a number.',
    },
];

function useCanHover(): boolean {
    const [canHover, setCanHover] = useState(false);

    useEffect(() => {
        if (typeof window === 'undefined' || !window.matchMedia) return;
        const media = window.matchMedia('(hover: hover) and (pointer: fine)');
        const update = () => setCanHover(media.matches);
        update();

        if (typeof media.addEventListener === 'function') {
            media.addEventListener('change', update);
            return () => media.removeEventListener('change', update);
        }

        if (typeof media.addListener === 'function') {
            media.addListener(update);
            return () => media.removeListener(update);
        }

        return undefined;
    }, []);

    return canHover;
}

type AssetImageProps = {
    assetKey: string;
    assets: Record<string, LandingAsset>;
    isLoading: boolean;
    fallbackLabel: string;
    containerClassName?: string;
    imageClassName?: string;
};

function AssetImage({
    assetKey,
    assets,
    isLoading,
    fallbackLabel,
    containerClassName,
    imageClassName,
}: AssetImageProps) {
    const [failed, setFailed] = useState(false);
    const warnedRef = useRef(false);
    const asset = assets[assetKey];
    const source = asset?.public_url ?? '';

    useEffect(() => {
        if (!isLoading && !source && !warnedRef.current) {
            console.warn(`[landing-assets] missing asset for ${assetKey}`);
            warnedRef.current = true;
        }
    }, [assetKey, isLoading, source]);

    if (isLoading) {
        return (
            <div
                className={`animate-pulse rounded-3xl bg-slate-200/70 ${containerClassName ?? ''}`}
                aria-hidden="true"
            />
        );
    }

    if (!source || failed) {
        return (
            <div
                className={`relative flex items-center justify-center rounded-3xl border border-dashed border-slate-300 bg-white/70 ${containerClassName ?? ''
                    }`}
                role="img"
                aria-label={`${fallbackLabel} placeholder`}
            >
                <div className="px-6 text-center text-sm font-semibold text-slate-500">
                    {fallbackLabel}
                </div>
            </div>
        );
    }

    return (
        <img
            src={source}
            alt={asset?.alt_text ?? fallbackLabel}
            className={imageClassName ?? containerClassName}
            onError={() => setFailed(true)}
        />
    );
}

type DrawerProps = {
    open: boolean;
    onClose: () => void;
    onAuth: () => void;
};

function MobileDrawer({ open, onClose, onAuth }: DrawerProps) {
    const panelRef = useRef<HTMLDivElement>(null);

    useFocusTrap(open, panelRef, onClose);

    return (
        <div
            className={`fixed inset-0 z-40 transition ${open ? 'pointer-events-auto' : 'pointer-events-none'}`}
            aria-hidden={!open}
        >
            <div
                className={`absolute inset-0 bg-slate-900/40 transition-opacity ${open ? 'opacity-100' : 'opacity-0'}`}
                onClick={onClose}
            />
            <div
                ref={panelRef}
                className={`absolute right-0 top-0 flex h-full w-[86%] max-w-sm flex-col gap-6 bg-white px-6 py-8 shadow-2xl transition-transform ${open ? 'translate-x-0' : 'translate-x-full'
                    }`}
                role="dialog"
                aria-modal="true"
                aria-label="Mobile navigation"
                tabIndex={-1}
            >
                <div className="flex items-center justify-between">
                    <div className="text-sm font-semibold text-slate-600">Menu</div>
                    <button
                        type="button"
                        onClick={onClose}
                        className="min-h-[44px] rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:bg-slate-100"
                    >
                        Close
                    </button>
                </div>
                <nav className="flex flex-col gap-4 text-base font-semibold text-slate-700">
                    {NAV_LINKS.map((link) => (
                        <a
                            key={link.id}
                            href={`#${link.id}`}
                            className="rounded-xl px-3 py-2 transition hover:bg-slate-100"
                            onClick={onClose}
                        >
                            {link.label}
                        </a>
                    ))}
                </nav>
                <button
                    type="button"
                    onClick={() => {
                        onClose();
                        onAuth();
                    }}
                    className="mt-auto inline-flex min-h-[44px] items-center justify-center rounded-full bg-slate-900 px-5 py-3 text-sm font-semibold text-white transition hover:bg-slate-800 active:scale-[0.98]"
                >
                    Start a free mock
                </button>
            </div>
        </div>
    );
}

type AuthModalProps = {
    open: boolean;
    onClose: () => void;
    onSignIn: () => void;
    loading: boolean;
};

function AuthModal({ open, onClose, onSignIn, loading }: AuthModalProps) {
    const panelRef = useRef<HTMLDivElement>(null);

    useFocusTrap(open, panelRef, onClose);

    return (
        <div
            className={`fixed inset-0 z-50 transition ${open ? 'pointer-events-auto' : 'pointer-events-none'}`}
            aria-hidden={!open}
        >
            <div
                className={`absolute inset-0 bg-slate-900/50 transition-opacity ${open ? 'opacity-100' : 'opacity-0'}`}
                onClick={onClose}
            />
            <div
                ref={panelRef}
                role="dialog"
                aria-modal="true"
                aria-label="Sign in"
                tabIndex={-1}
                className={`absolute left-1/2 top-1/2 w-[min(92vw,420px)] -translate-x-1/2 -translate-y-1/2 rounded-2xl border border-slate-200 bg-white p-6 shadow-xl transition ${open ? 'opacity-100 scale-100' : 'opacity-0 scale-95'
                    }`}
                onClick={(event) => event.stopPropagation()}
            >
                <div className="flex items-start justify-between">
                    <div>
                        <p className="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Free during beta</p>
                        <h3 className={`${headingFont.className} mt-2 text-xl font-semibold text-slate-900`}>
                            Start a free mock
                        </h3>
                        <p className="mt-2 text-sm text-slate-500">
                            Early access open for CAT 2026 (beta).
                        </p>
                    </div>
                    <button
                        type="button"
                        onClick={onClose}
                        className="min-h-[44px] rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:bg-slate-100"
                    >
                        Close
                    </button>
                </div>
                <button
                    type="button"
                    onClick={onSignIn}
                    disabled={loading}
                    className="mt-6 inline-flex min-h-[44px] w-full items-center justify-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 transition hover:bg-slate-50 active:scale-[0.99] disabled:cursor-not-allowed disabled:opacity-60"
                >
                    {loading ? (
                        <span className="h-4 w-4 animate-spin rounded-full border-2 border-slate-300 border-t-slate-700" />
                    ) : (
                        <svg className="h-5 w-5" viewBox="0 0 24 24" aria-hidden="true">
                            <path
                                fill="#4285F4"
                                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                            />
                            <path
                                fill="#34A853"
                                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                            />
                            <path
                                fill="#FBBC05"
                                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                            />
                            <path
                                fill="#EA4335"
                                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                            />
                        </svg>
                    )}
                    {loading ? 'Redirecting...' : 'Continue with Google'}
                </button>
                <p className="mt-4 text-xs text-slate-400">
                    Google-only sign-in. No password required.
                </p>
            </div>
        </div>
    );
}

export default function LandingPageClient() {
    const { assets, isLoading } = useLandingAssets();
    const [isMenuOpen, setIsMenuOpen] = useState(false);
    const [isAuthOpen, setIsAuthOpen] = useState(false);
    const [activeSlide, setActiveSlide] = useState(0);
    const [carouselPaused, setCarouselPaused] = useState(false);
    const [authLoading, setAuthLoading] = useState(false);
    const [showBackToTop, setShowBackToTop] = useState(false);
    const canHover = useCanHover();
    const heroRef = useRef<HTMLElement | null>(null);
    const carouselRef = useRef<HTMLDivElement | null>(null);

    useEffect(() => {
        if (isMenuOpen || isAuthOpen) {
            document.body.style.overflow = 'hidden';
            return;
        }
        document.body.style.overflow = '';
    }, [isMenuOpen, isAuthOpen]);

    useEffect(() => {
        if (typeof window === 'undefined') return;
        const handleScroll = () => {
            const threshold = heroRef.current?.offsetHeight ?? 320;
            setShowBackToTop(window.scrollY > threshold);
        };
        handleScroll();
        window.addEventListener('scroll', handleScroll, { passive: true });
        return () => window.removeEventListener('scroll', handleScroll);
    }, []);

    const scrollToSlide = useCallback(
        (index: number, behavior: ScrollBehavior = 'smooth') => {
            const node = carouselRef.current;
            if (!node) return;
            const width = node.clientWidth;
            if (!width) return;
            node.scrollTo({ left: width * index, behavior });
        },
        []
    );

    const handleSelectSlide = useCallback(
        (index: number) => {
            setActiveSlide(index);
            scrollToSlide(index);
        },
        [scrollToSlide]
    );

    const handleCarouselScroll = useCallback(() => {
        const node = carouselRef.current;
        if (!node) return;
        const width = node.clientWidth;
        if (!width) return;
        const nextIndex = Math.round(node.scrollLeft / width);
        if (nextIndex !== activeSlide) {
            setActiveSlide(nextIndex);
        }
    }, [activeSlide]);

    useEffect(() => {
        if (!canHover || carouselPaused) return;
        const timer = window.setInterval(() => {
            setActiveSlide((prev) => {
                const next = (prev + 1) % HERO_SLIDES.length;
                scrollToSlide(next);
                return next;
            });
        }, 4800);
        return () => window.clearInterval(timer);
    }, [canHover, carouselPaused, scrollToSlide]);

    useEffect(() => {
        if (typeof window === 'undefined') return;
        const handleResize = () => {
            scrollToSlide(activeSlide, 'auto');
        };
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, [activeSlide, scrollToSlide]);

    const scrollToTop = useCallback(() => {
        if (typeof window === 'undefined') return;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, []);

    const handleSignIn = useCallback(async () => {
        setAuthLoading(true);
        try {
            if (typeof window !== 'undefined') {
                window.localStorage.setItem('first_login_banner_eligible', 'true');
            }
            const configuredSiteUrl = process.env.NEXT_PUBLIC_SITE_URL || '';
            const origin = configuredSiteUrl || (typeof window !== 'undefined'
                ? window.location.origin
                : '');
            const callbackUrl = `${origin}/auth/callback?redirect_to=${encodeURIComponent('/dashboard')}`;
            await sb().auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: callbackUrl },
            });
        } finally {
            setAuthLoading(false);
        }
    }, []);

    return (
        <div className={`${bodyFont.className} min-h-screen overflow-x-hidden bg-slate-50 text-slate-900`}>
            <div className="relative overflow-hidden bg-gradient-to-br from-slate-50 via-white to-emerald-50">
                <div className="pointer-events-none absolute -top-32 -right-24 h-72 w-72 rounded-full bg-emerald-200/40 blur-3xl" />
                <div className="pointer-events-none absolute -bottom-40 left-16 h-96 w-96 rounded-full bg-amber-200/40 blur-3xl" />

                <header className="sticky top-0 z-40 border-b border-slate-200/70 bg-white/80 backdrop-blur">
                    <div className="mx-auto flex w-full max-w-6xl items-center justify-between px-4 py-4 sm:px-6 sm:py-5">
                        <div className="flex items-center gap-3">
                            <div className="flex h-10 w-10 items-center justify-center rounded-2xl bg-slate-900 text-sm font-semibold text-white">
                                CAT
                            </div>
                            <div>
                                <div className={`${headingFont.className} text-sm font-semibold text-slate-900`}>
                                    CAT Mock Arena
                                </div>
                                <div className="text-xs text-slate-500">Prep like it's exam day</div>
                            </div>
                        </div>

                        <nav className="hidden items-center gap-6 text-sm font-semibold text-slate-600 lg:flex">
                            {NAV_LINKS.map((link) => (
                                <a
                                    key={link.id}
                                    href={`#${link.id}`}
                                    className="transition hover:text-slate-900"
                                >
                                    {link.label}
                                </a>
                            ))}
                        </nav>

                        <div className="flex items-center gap-2">
                            <button
                                type="button"
                                onClick={() => setIsAuthOpen(true)}
                                className="group relative inline-flex min-h-[44px] items-center justify-center rounded-full bg-slate-900 px-4 py-2.5 text-xs font-semibold text-white transition hover:bg-slate-800 active:scale-[0.98] sm:px-5 sm:text-sm"
                            >
                                <span className="absolute inset-0 -z-10 rounded-full bg-emerald-300/30 opacity-0 blur-xl transition group-hover:opacity-100 motion-safe:group-hover:animate-[landing-glow_2.8s_ease-in-out_infinite]" />
                                Start a free mock
                            </button>
                            <button
                                type="button"
                                onClick={() => setIsMenuOpen(true)}
                                className="inline-flex min-h-[44px] items-center gap-2 rounded-full border border-slate-200 px-3 py-2.5 text-xs font-semibold text-slate-600 transition hover:bg-slate-100 lg:hidden"
                                aria-label="Open menu"
                            >
                                <span>Menu</span>
                                <svg className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <path strokeLinecap="round" d="M4 7h16M4 12h16M4 17h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </header>

                <main>
                    <section
                        id="hero"
                        ref={heroRef}
                        className="mx-auto w-full max-w-6xl px-4 pb-16 pt-10 sm:px-6 sm:pt-14 lg:pt-24"
                    >
                        <div className="grid items-center gap-12 lg:grid-cols-[1.05fr_0.95fr]">
                            <div className="space-y-6">
                                <div className="space-y-2">
                                    <span className="inline-flex items-center rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.12em] text-slate-500">
                                        Free during beta &bull; CAT 2026
                                    </span>
                                    <p className="text-xs text-slate-500">Early access open for CAT 2026 (beta).</p>
                                </div>
                                <h1
                                    className={`${headingFont.className} text-3xl font-semibold tracking-tight text-slate-900 sm:text-4xl lg:text-5xl motion-safe:animate-[landing-fade-up_0.7s_ease-out]`}
                                >
                                    Practice like it's your D-Day. Get hyper-customized analytics.
                                </h1>
                                <p
                                    className="text-sm text-slate-600 sm:text-base lg:text-lg motion-safe:animate-[landing-fade-up_0.7s_ease-out]"
                                    style={{ animationDelay: '80ms' }}
                                >
                                    AI coaching guided by top percentilers - built from your attempt behavior (time, order, revisits, accuracy).
                                </p>
                                <div className="flex flex-wrap gap-2 text-[11px] font-semibold text-slate-600">
                                    {HERO_CHIPS.map((chip) => (
                                        <span
                                            key={chip}
                                            className="rounded-full border border-slate-200 bg-white px-3 py-1"
                                        >
                                            {chip}
                                        </span>
                                    ))}
                                </div>
                                <div className="space-y-2">
                                    <button
                                        type="button"
                                        onClick={() => setIsAuthOpen(true)}
                                        className="group relative inline-flex min-h-[44px] w-full items-center justify-center rounded-full bg-slate-900 px-6 py-3 text-sm font-semibold text-white transition hover:bg-slate-800 active:scale-[0.98] sm:w-auto"
                                    >
                                        <span className="absolute inset-0 -z-10 rounded-full bg-emerald-300/30 opacity-0 blur-xl transition group-hover:opacity-100 motion-safe:group-hover:animate-[landing-glow_2.8s_ease-in-out_infinite]" />
                                        Start a free mock
                                    </button>
                                    <p className="text-xs font-semibold text-slate-500">Continue with Google</p>
                                    <p className="text-[11px] text-slate-400">
                                        Mocks are best experienced on desktop (like CAT).
                                    </p>
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div className="rounded-[32px] border border-slate-200 bg-white/70 p-4 shadow-lg">
                                    <div
                                        ref={carouselRef}
                                        className="flex snap-x snap-mandatory overflow-x-auto scroll-smooth lg:overflow-hidden [scrollbar-width:none] [&::-webkit-scrollbar]:hidden"
                                        onScroll={handleCarouselScroll}
                                        onMouseEnter={() => setCarouselPaused(true)}
                                        onMouseLeave={() => setCarouselPaused(false)}
                                    >
                                        {HERO_SLIDES.map((slide) => (
                                            <div key={slide.id} className="min-w-full snap-center px-1">
                                                <div className="space-y-4 rounded-[24px] border border-slate-200 bg-white p-4 shadow-sm">
                                                    <div className="relative h-[210px] w-full overflow-hidden rounded-2xl border border-slate-200 bg-slate-50 sm:h-[240px]">
                                                        {slide.assetKey ? (
                                                            <AssetImage
                                                                assetKey={slide.assetKey}
                                                                assets={assets}
                                                                isLoading={isLoading}
                                                                fallbackLabel={slide.fallbackLabel ?? 'Carousel preview'}
                                                                containerClassName="h-full w-full"
                                                                imageClassName="h-full w-full object-cover"
                                                            />
                                                        ) : (
                                                            <div className="flex h-full flex-col justify-between p-4">
                                                                <div className="flex items-center justify-between">
                                                                    <span className="text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400">
                                                                        Coach Report
                                                                    </span>
                                                                    <span className="rounded-full bg-slate-900 px-2 py-0.5 text-[10px] font-semibold text-white">
                                                                        Beta
                                                                    </span>
                                                                </div>
                                                                <div className="mt-4 grid gap-3">
                                                                    {slide.insights?.map((insight) => (
                                                                        <div
                                                                            key={insight}
                                                                            className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700"
                                                                        >
                                                                            {insight}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {slide.maskTop && (
                                                            <div className="pointer-events-none absolute inset-x-0 top-0 h-12 bg-white/80 backdrop-blur-sm" />
                                                        )}
                                                    </div>
                                                    <div>
                                                        <p className="text-sm font-semibold text-slate-900">{slide.title}</p>
                                                        <p className="mt-1 text-xs text-slate-500">{slide.subtitle}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex flex-col items-center gap-2">
                                    <div className="flex items-center gap-2">
                                        {HERO_SLIDES.map((slide, index) => (
                                            <button
                                                key={slide.id}
                                                type="button"
                                                onClick={() => handleSelectSlide(index)}
                                                className="rounded-full p-1"
                                                aria-label={`Go to ${slide.label} slide`}
                                            >
                                                <span
                                                    className={`block h-2.5 w-2.5 rounded-full transition ${index === activeSlide
                                                        ? 'bg-slate-900'
                                                        : 'bg-slate-300'
                                                        }`}
                                                />
                                            </button>
                                        ))}
                                    </div>
                                    <div className="grid w-full grid-cols-3 text-center text-[11px] font-semibold text-slate-500">
                                        {HERO_SLIDES.map((slide, index) => (
                                            <span
                                                key={slide.id}
                                                className={index === activeSlide ? 'text-slate-900' : ''}
                                            >
                                                {slide.label}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section className="border-y border-slate-200 bg-white">
                        <div className="mx-auto w-full max-w-6xl px-4 py-6 sm:px-6">
                            <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                {LIVE_STRIP_ITEMS.map((item) => (
                                    <div
                                        key={item.label}
                                        className="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3"
                                    >
                                        <p className="text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400">
                                            {item.label}
                                        </p>
                                        <p className="mt-2 text-sm font-semibold text-slate-900">{item.copy}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>

                    <section id="mentor" className="mx-auto w-full max-w-6xl px-4 py-16 sm:px-6">
                        <div className="grid items-center gap-8 lg:grid-cols-[1.05fr_0.95fr]">
                            <div className="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                                <p className="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">
                                    Curated & verified by
                                </p>
                                <h2 className={`${headingFont.className} mt-3 text-3xl font-semibold text-slate-900`}>
                                    Saurabh Khandelwal
                                </h2>
                                <div className="mt-4 flex flex-wrap gap-2">
                                    {['CAT 99.84', 'MBA, IIM Udaipur'].map((chip) => (
                                        <span
                                            key={chip}
                                            className="rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold text-slate-600"
                                        >
                                            {chip}
                                        </span>
                                    ))}
                                </div>
                                <p className="mt-4 text-sm text-slate-600">
                                    Mocks and review standards aligned to what top mentors look for: selection, pacing, and execution.
                                </p>
                            </div>
                            <div className="relative">
                                <AssetImage
                                    assetKey="mentor_photo"
                                    assets={assets}
                                    isLoading={isLoading}
                                    fallbackLabel="Mentor spotlight"
                                    containerClassName="h-[220px] w-full rounded-[28px] border border-slate-200 bg-slate-50 sm:h-[280px]"
                                    imageClassName="h-[220px] w-full rounded-[28px] border border-slate-200 object-cover sm:h-[280px]"
                                />
                            </div>
                        </div>
                    </section>

                    <section id="features" className="border-y border-slate-200 bg-white">
                        <div className="mx-auto w-full max-w-6xl px-4 py-16 sm:px-6">
                            <div className="space-y-3">
                                <p className="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Features</p>
                                <h2 className={`${headingFont.className} text-3xl font-semibold text-slate-900`}>
                                    Built for focused CAT 2026 practice
                                </h2>
                                <p className="text-slate-600">
                                    AI coaching, mentor-curated mocks, and mirror analytics designed for real test-day flow.
                                </p>
                            </div>

                            <div className="mt-10 grid gap-6 md:grid-cols-2">
                                {FEATURE_CARDS.map((feature) => (
                                    <div
                                        key={feature.id}
                                        className="relative rounded-3xl border border-slate-200 bg-slate-50 p-5 sm:p-6"
                                    >
                                        {feature.tag && (
                                            <span className="absolute right-4 top-4 rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-[11px] font-semibold text-amber-700">
                                                {feature.tag}
                                            </span>
                                        )}
                                        <h3 className={`${headingFont.className} text-xl font-semibold text-slate-900`}>
                                            {feature.title}
                                        </h3>
                                        <p className="mt-2 text-sm text-slate-600">{feature.description}</p>
                                        <ul className="mt-4 space-y-2 text-xs text-slate-600">
                                            {feature.bullets.map((bullet) => (
                                                <li key={bullet} className="flex items-center gap-2">
                                                    <span className="h-1.5 w-1.5 rounded-full bg-slate-400" />
                                                    <span>{bullet}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>

                    <section id="roadmap" className="mx-auto w-full max-w-6xl px-4 py-16 sm:px-6">
                        <div className="space-y-8">
                            <div className="space-y-3">
                                <p className="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Roadmap</p>
                                <h2 className={`${headingFont.className} text-3xl font-semibold text-slate-900`}>
                                    Month-by-month rollout for CAT 2026 prep
                                </h2>
                                <p className="text-slate-600">
                                    What is live now and what lands next for beta users.
                                </p>
                            </div>
                            <div className="relative">
                                <div className="absolute left-0 right-0 top-6 hidden h-px bg-slate-200 lg:block" />
                                <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                    {ROADMAP_ITEMS.map((item) => (
                                        <div
                                            key={item.period}
                                            className="relative rounded-3xl border border-slate-200 bg-white p-6 shadow-sm"
                                        >
                                            <span className="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold text-slate-600">
                                                {item.period}
                                            </span>
                                            <p className="mt-4 text-sm font-semibold text-slate-900">{item.copy}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="cat-hub" className="mx-auto w-full max-w-6xl px-4 py-16 sm:px-6">
                        <div className="grid gap-10 lg:grid-cols-[0.9fr_1.1fr]">
                            <div>
                                <p className="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">CAT Hub</p>
                                <h2 className={`${headingFont.className} mt-3 text-3xl font-semibold text-slate-900`}>
                                    CAT Hub: 5 Mistakes That Kill Percentiles
                                </h2>
                                <p className="mt-3 text-slate-600">
                                    Five patterns that quietly destroy accuracy and decision speed across VARC, DILR, and QA.
                                </p>
                            </div>
                            <div className="space-y-3">
                                {CAT_HUB_ITEMS.map((item) => (
                                    <details
                                        key={item.title}
                                        className="group rounded-2xl border border-slate-200 bg-white p-4 transition hover:border-slate-300"
                                    >
                                        <summary className="flex cursor-pointer items-center justify-between text-sm font-semibold text-slate-900">
                                            {item.title}
                                            <span className="text-slate-400 transition group-open:rotate-45">+</span>
                                        </summary>
                                        <p className="mt-3 text-sm text-slate-600 whitespace-pre-line">{item.body}</p>
                                    </details>
                                ))}
                            </div>
                        </div>
                    </section>
                </main>

                <footer className="border-t border-slate-200 bg-white">
                    <div className="mx-auto grid w-full max-w-6xl gap-8 px-4 py-12 sm:px-6 md:grid-cols-[1.2fr_0.8fr]">
                        <div>
                            <div className={`${headingFont.className} text-lg font-semibold text-slate-900`}>
                                CAT Mock Arena
                            </div>
                            <p className="mt-3 max-w-md text-sm text-slate-600">
                                A clean, focused CAT mock experience with real exam constraints and mentor-grade insights.
                            </p>
                            <button
                                type="button"
                                onClick={() => setIsAuthOpen(true)}
                                className="mt-6 inline-flex min-h-[44px] w-full items-center justify-center rounded-full bg-slate-900 px-5 py-3 text-sm font-semibold text-white transition hover:bg-slate-800 active:scale-[0.98] sm:w-auto"
                            >
                                Start a free mock
                            </button>
                        </div>
                        <div className="flex flex-col gap-3 text-sm text-slate-600">
                            <a className="hover:text-slate-900" href="#features">Features</a>
                            <a className="hover:text-slate-900" href="#mentor">Mentor</a>
                            <a className="hover:text-slate-900" href="#roadmap">Roadmap</a>
                            <button
                                type="button"
                                onClick={() => setIsAuthOpen(true)}
                                className="text-left hover:text-slate-900"
                            >
                                Sign in
                            </button>
                        </div>
                    </div>
                </footer>
            </div>

            {showBackToTop && (
                <button
                    type="button"
                    onClick={scrollToTop}
                    className="fixed bottom-6 left-6 z-40 inline-flex min-h-[44px] items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2.5 text-xs font-semibold text-slate-600 shadow-md transition hover:-translate-y-0.5 hover:bg-slate-50"
                >
                    <svg className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M6 15l6-6 6 6" />
                    </svg>
                    Back to top
                </button>
            )}

            <MobileDrawer open={isMenuOpen} onClose={() => setIsMenuOpen(false)} onAuth={() => setIsAuthOpen(true)} />
            <AuthModal open={isAuthOpen} onClose={() => setIsAuthOpen(false)} onSignIn={handleSignIn} loading={authLoading} />
        </div>
    );
}
````

## File: src/features/admin/ui/QuestionSetEditor.tsx
````typescript
/**
 * @fileoverview Question Set Editor Component
 * @description Admin editor for creating/editing question sets (RC passages, DI sets)
 * @architecture Question Container Architecture - Set Mode Editor
 * 
 * Editor Modes:
 * - Set Mode: Create passage ONCE, then add multiple questions below
 * - Single Mode: Create atomic questions (wrapped in single-question set)
 * 
 * Validation:
 * - A Set cannot be published if it has 0 questions
 * - Composite sets require context_body
 */

'use client';

import { useState, useCallback, useEffect, useMemo } from 'react';
import type {
    QuestionSet,
    QuestionSetType,
    ContentLayoutType,
    QuestionInSetWithAnswer,
    SectionName,
    QuestionType,
    QuestionSetMetadata,
    ContextType,
} from '@/types/exam';
import { isCompositeSet } from '@/types/exam';

// =============================================================================
// TYPES
// =============================================================================

interface QuestionSetEditorProps {
    /** Existing set to edit, or null for new set */
    questionSet?: QuestionSet | null;
    /** Paper ID for new sets */
    paperId: string;
    /** Current section */
    section: SectionName;
    /** Callback when set is saved */
    onSave: (set: Partial<QuestionSet>, questions: Partial<QuestionInSetWithAnswer>[]) => Promise<void>;
    /** Callback to cancel editing */
    onCancel: () => void;
}

type EditorMode = 'set' | 'single';

interface QuestionDraft {
    id?: string;
    sequence_order: number;
    question_text: string;
    question_type: QuestionType;
    options: string[];
    correct_answer: string;
    positive_marks: number;
    negative_marks: number;
    solution_text?: string;
    question_image_url?: string;
}

// =============================================================================
// CONSTANTS
// =============================================================================

const SET_TYPE_OPTIONS: { value: QuestionSetType; label: string; description: string }[] = [
    { value: 'VARC', label: 'Reading Comprehension', description: 'Passage with 4-6 linked questions' },
    { value: 'DILR', label: 'Data Interpretation', description: 'Chart/table with linked questions' },
    { value: 'CASELET', label: 'Caselet', description: 'Case study with linked questions' },
    { value: 'ATOMIC', label: 'Single Question', description: 'Standalone question (Quant/Logic)' },
];

const LAYOUT_OPTIONS: { value: ContentLayoutType; label: string }[] = [
    { value: 'split_passage', label: 'Split - Passage Left' },
    { value: 'split_chart', label: 'Split - Chart Left' },
    { value: 'split_table', label: 'Split - Table Left' },
    { value: 'single_focus', label: 'Single Focus (Centered)' },
    { value: 'image_top', label: 'Image on Top' },
];

const CONTEXT_TYPE_OPTIONS: { value: ContextType; label: string }[] = [
    { value: 'rc_passage', label: 'RC Passage' },
    { value: 'dilr_set', label: 'DILR Set' },
    { value: 'caselet', label: 'Caselet' },
    { value: 'data_table', label: 'Data Table' },
    { value: 'graph', label: 'Graph' },
    { value: 'other_shared_stimulus', label: 'Other Shared Stimulus' },
];

function inferContextType(setType: QuestionSetType): ContextType | '' {
    if (setType === 'VARC') return 'rc_passage';
    if (setType === 'DILR') return 'dilr_set';
    if (setType === 'CASELET') return 'caselet';
    return '';
}

const EMPTY_QUESTION: QuestionDraft = {
    sequence_order: 1,
    question_text: '',
    question_type: 'MCQ',
    options: ['', '', '', ''],
    correct_answer: 'A',
    positive_marks: 3,
    negative_marks: 1,
};

// =============================================================================
// MAIN COMPONENT
// =============================================================================

export function QuestionSetEditor({
    questionSet,
    paperId,
    section,
    onSave,
    onCancel,
}: QuestionSetEditorProps) {
    // Determine initial mode based on existing set or default
    const initialMode: EditorMode = questionSet?.set_type === 'ATOMIC' ? 'single' : 'set';

    // ==========================================================================
    // STATE
    // ==========================================================================

    const [mode, setMode] = useState<EditorMode>(initialMode);
    const [isSaving, setIsSaving] = useState(false);
    const [errors, setErrors] = useState<string[]>([]);

    // Set-level fields
    const [setType, setSetType] = useState<QuestionSetType>(questionSet?.set_type ?? 'VARC');
    const [contentLayout, setContentLayout] = useState<ContentLayoutType>(
        questionSet?.content_layout ?? 'split_passage'
    );
    const [contextType, setContextType] = useState<ContextType | ''>(
        questionSet?.context_type ?? inferContextType(questionSet?.set_type ?? 'VARC')
    );
    const [contextTitle, setContextTitle] = useState(questionSet?.context_title ?? '');
    const [contextBody, setContextBody] = useState(questionSet?.context_body ?? '');
    const [contextImageUrl, setContextImageUrl] = useState(questionSet?.context_image_url ?? '');
    const [metadata, setMetadata] = useState<QuestionSetMetadata>(questionSet?.metadata ?? {});

    // Count paragraphs in context body for image position options
    const paragraphCount = useMemo(() => {
        if (!contextBody) return 0;
        return contextBody.split(/\n\n+/).filter(p => p.trim()).length;
    }, [contextBody]);

    // Questions
    const [questions, setQuestions] = useState<QuestionDraft[]>(() => {
        if (questionSet?.questions && questionSet.questions.length > 0) {
            return questionSet.questions.map((q, idx) => ({
                id: q.id,
                sequence_order: q.sequence_order ?? idx + 1,
                question_text: q.question_text,
                question_type: q.question_type,
                options: Array.isArray(q.options) ? [...q.options] : ['', '', '', ''],
                correct_answer: (q as QuestionInSetWithAnswer).correct_answer ?? 'A',
                positive_marks: q.positive_marks,
                negative_marks: q.negative_marks,
                solution_text: (q as QuestionInSetWithAnswer).solution_text,
                question_image_url: q.question_image_url,
            }));
        }
        return [{ ...EMPTY_QUESTION }];
    });

    // Active question index for editing
    const [activeQuestionIndex, setActiveQuestionIndex] = useState(0);

    // ==========================================================================
    // MODE SWITCHING
    // ==========================================================================

    const handleModeChange = useCallback((newMode: EditorMode) => {
        setMode(newMode);
        if (newMode === 'single') {
            setSetType('ATOMIC');
            setContentLayout('single_focus');
            setContextType('');
            // Keep only first question for atomic
            setQuestions(prev => [prev[0] ?? { ...EMPTY_QUESTION }]);
        } else {
            // Default to VARC for set mode
            if (setType === 'ATOMIC') {
                setSetType('VARC');
                setContentLayout('split_passage');
                setContextType(inferContextType('VARC'));
            }
        }
    }, [setType]);

    useEffect(() => {
        if (setType === 'ATOMIC') {
            setContextType('');
            return;
        }

        if (!contextType) {
            setContextType(inferContextType(setType));
        }
    }, [setType, contextType]);

    // ==========================================================================
    // QUESTION MANAGEMENT
    // ==========================================================================

    const addQuestion = useCallback(() => {
        setQuestions(prev => [
            ...prev,
            {
                ...EMPTY_QUESTION,
                sequence_order: prev.length + 1,
            },
        ]);
        setActiveQuestionIndex(questions.length);
    }, [questions.length]);

    const removeQuestion = useCallback((index: number) => {
        if (questions.length <= 1) return; // Can't remove last question

        setQuestions(prev => {
            const updated = prev.filter((_, i) => i !== index);
            // Renumber sequence_order
            return updated.map((q, i) => ({ ...q, sequence_order: i + 1 }));
        });

        // Adjust active index
        if (activeQuestionIndex >= questions.length - 1) {
            setActiveQuestionIndex(Math.max(0, questions.length - 2));
        }
    }, [questions.length, activeQuestionIndex]);

    const updateQuestion = useCallback((index: number, updates: Partial<QuestionDraft>) => {
        setQuestions(prev => prev.map((q, i) =>
            i === index ? { ...q, ...updates } : q
        ));
    }, []);

    const updateQuestionOption = useCallback((questionIndex: number, optionIndex: number, value: string) => {
        setQuestions(prev => prev.map((q, i) => {
            if (i !== questionIndex) return q;
            const newOptions = [...q.options];
            newOptions[optionIndex] = value;
            return { ...q, options: newOptions };
        }));
    }, []);

    // ==========================================================================
    // VALIDATION
    // ==========================================================================

    const validate = useCallback((): string[] => {
        const validationErrors: string[] = [];

        // Check questions exist
        if (questions.length === 0) {
            validationErrors.push('At least one question is required');
        }

        // For composite sets, require context body
        if (isCompositeSet(setType) && !contextBody.trim()) {
            validationErrors.push('Context/passage content is required for this set type');
        }

        // Validate each question
        questions.forEach((q, idx) => {
            if (!q.question_text.trim()) {
                validationErrors.push(`Question ${idx + 1}: Question text is required`);
            }
            if (q.question_type === 'MCQ') {
                const filledOptions = q.options.filter(o => o.trim()).length;
                if (filledOptions < 2) {
                    validationErrors.push(`Question ${idx + 1}: At least 2 options are required`);
                }
            }
            if (!q.correct_answer.trim()) {
                validationErrors.push(`Question ${idx + 1}: Correct answer is required`);
            }
        });

        return validationErrors;
    }, [questions, setType, contextBody]);

    // ==========================================================================
    // SAVE HANDLER
    // ==========================================================================

    const handleSave = useCallback(async () => {
        // Validate
        const validationErrors = validate();
        if (validationErrors.length > 0) {
            setErrors(validationErrors);
            return;
        }

        setErrors([]);
        setIsSaving(true);

        try {
            const setData: Partial<QuestionSet> = {
                id: questionSet?.id,
                paper_id: paperId,
                section,
                set_type: setType,
                content_layout: contentLayout,
                context_type: contextType || undefined,
                context_title: contextTitle || undefined,
                context_body: contextBody || undefined,
                context_image_url: contextImageUrl || undefined,
                metadata,
                is_active: true,
            };

            const questionData: Partial<QuestionInSetWithAnswer>[] = questions.map((q, idx) => ({
                id: q.id,
                paper_id: paperId,
                section,
                sequence_order: idx + 1,
                question_text: q.question_text,
                question_type: q.question_type,
                options: q.question_type === 'MCQ' ? q.options.filter(o => o.trim()) : null,
                correct_answer: q.correct_answer,
                positive_marks: q.positive_marks,
                negative_marks: q.question_type === 'TITA' ? 0 : q.negative_marks,
                solution_text: q.solution_text,
                question_image_url: q.question_image_url,
                is_active: true,
            }));

            await onSave(setData, questionData);
        } catch (error) {
            console.error('Failed to save question set:', error);
            setErrors(['Failed to save. Please try again.']);
        } finally {
            setIsSaving(false);
        }
    }, [
        validate, questionSet?.id, paperId, section, setType, contentLayout,
        contextType, contextTitle, contextBody, contextImageUrl, metadata, questions, onSave
    ]);

    // ==========================================================================
    // RENDER
    // ==========================================================================

    const activeQuestion = questions[activeQuestionIndex];

    return (
        <div className="h-full flex flex-col bg-exam-bg-page">
            {/* Header with Mode Selector */}
            <div className="bg-exam-bg-white border-b border-exam-bg-border px-6 py-4">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <h2 className="text-lg font-semibold text-exam-text-primary">
                            {questionSet ? 'Edit Question Set' : 'Create Question Set'}
                        </h2>

                        {/* Mode Toggle */}
                        <div className="flex rounded-lg border border-gray-300 overflow-hidden">
                            <button
                                onClick={() => handleModeChange('set')}
                                className={`px-4 py-2 text-sm font-medium transition-colors ${mode === 'set'
                                    ? 'bg-section-varc text-white'
                                    : 'bg-white text-gray-600 hover:bg-gray-50'
                                    }`}
                            >
                                📚 Create Set (RC/DI)
                            </button>
                            <button
                                onClick={() => handleModeChange('single')}
                                className={`px-4 py-2 text-sm font-medium transition-colors ${mode === 'single'
                                    ? 'bg-section-qa text-white'
                                    : 'bg-white text-gray-600 hover:bg-gray-50'
                                    }`}
                            >
                                📝 Single Question
                            </button>
                        </div>
                    </div>

                    <div className="flex items-center gap-3">
                        <button
                            onClick={onCancel}
                            className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleSave}
                            disabled={isSaving}
                            className="px-4 py-2 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 transition-colors disabled:opacity-50"
                        >
                            {isSaving ? 'Saving...' : 'Save Set'}
                        </button>
                    </div>
                </div>

                {/* Errors */}
                {errors.length > 0 && (
                    <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                        <ul className="list-disc list-inside text-sm text-red-600">
                            {errors.map((error) => (
                                <li key={error}>{error}</li>
                            ))}
                        </ul>
                    </div>
                )}
            </div>

            {/* Main Editor Area */}
            <div className="flex-1 flex overflow-hidden">
                {/* Left Panel: Set Configuration */}
                <div className="w-1/3 border-r border-exam-bg-border overflow-y-auto bg-exam-bg-white">
                    <div className="p-6 space-y-6">
                        {/* Set Type Selector */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Set Type
                            </label>
                            <select
                                value={setType}
                                onChange={(e) => setSetType(e.target.value as QuestionSetType)}
                                disabled={mode === 'single'}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none disabled:bg-gray-100"
                            >
                                {SET_TYPE_OPTIONS.map(opt => (
                                    <option key={opt.value} value={opt.value}>
                                        {opt.label}
                                    </option>
                                ))}
                            </select>
                            <p className="text-xs text-gray-500 mt-1">
                                {SET_TYPE_OPTIONS.find(o => o.value === setType)?.description}
                            </p>
                        </div>

                        {/* Layout Selector */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Content Layout
                            </label>
                            <select
                                value={contentLayout}
                                onChange={(e) => setContentLayout(e.target.value as ContentLayoutType)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none"
                            >
                                {LAYOUT_OPTIONS.map(opt => (
                                    <option key={opt.value} value={opt.value}>
                                        {opt.label}
                                    </option>
                                ))}
                            </select>
                        </div>

                        {/* Context Content (for composite sets) */}
                        {isCompositeSet(setType) && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Context Type
                                    </label>
                                    <select
                                        value={contextType}
                                        onChange={(e) => setContextType(e.target.value as ContextType)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none"
                                    >
                                        {CONTEXT_TYPE_OPTIONS.map(opt => (
                                            <option key={opt.value} value={opt.value}>
                                                {opt.label}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Context Title (optional)
                                    </label>
                                    <input
                                        type="text"
                                        value={contextTitle}
                                        onChange={(e) => setContextTitle(e.target.value)}
                                        placeholder="e.g., Passage 1, Data Set A"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Context Body <span className="text-red-500">*</span>
                                    </label>
                                    <textarea
                                        value={contextBody}
                                        onChange={(e) => setContextBody(e.target.value)}
                                        placeholder={
                                            setType === 'VARC'
                                                ? 'Paste the reading passage here...'
                                                : 'Enter the data set description, table data, or scenario...'
                                        }
                                        rows={12}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none resize-y font-mono text-sm leading-relaxed"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Context Image URL (optional)
                                    </label>
                                    <input
                                        type="url"
                                        value={contextImageUrl}
                                        onChange={(e) => setContextImageUrl(e.target.value)}
                                        placeholder="https://..."
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none"
                                    />
                                    {contextImageUrl && (
                                        <img
                                            src={contextImageUrl}
                                            alt="Context preview"
                                            className="mt-2 max-w-full h-32 object-contain rounded border"
                                        />
                                    )}
                                </div>

                                {/* Image Position Selector - only show when image URL is provided */}
                                {contextImageUrl && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Image Placement Position
                                        </label>
                                        <select
                                            value={metadata.image_position ?? 'before'}
                                            onChange={(e) => setMetadata({
                                                ...metadata,
                                                image_position: e.target.value as 'before' | 'after' | `after_para_${number}`
                                            })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none"
                                        >
                                            <option value="before">Before text (top)</option>
                                            <option value="after">After text (bottom)</option>
                                            {paragraphCount > 0 && Array.from({ length: paragraphCount }, (_, i) => (
                                                <option key={`para-${i + 1}`} value={`after_para_${i + 1}`}>
                                                    After paragraph {i + 1}
                                                </option>
                                            ))}
                                        </select>
                                        <p className="text-xs text-gray-500 mt-1">
                                            Choose where the image appears relative to the passage text.
                                            Paragraphs are detected by double line breaks.
                                        </p>
                                    </div>
                                )}
                            </>
                        )}

                        {/* Metadata */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Metadata
                            </label>
                            <div className="grid grid-cols-2 gap-3">
                                <input
                                    type="text"
                                    value={metadata.topic ?? ''}
                                    onChange={(e) => setMetadata({ ...metadata, topic: e.target.value })}
                                    placeholder="Topic"
                                    className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                />
                                <select
                                    value={metadata.difficulty ?? ''}
                                    onChange={(e) => setMetadata({ ...metadata, difficulty: e.target.value as 'easy' | 'medium' | 'hard' })}
                                    className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                >
                                    <option value="">Difficulty</option>
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Right Panel: Questions */}
                <div className="flex-1 flex flex-col overflow-hidden bg-exam-bg-pane">
                    {/* Question Tabs */}
                    <div className="flex items-center gap-2 px-4 py-3 border-b border-exam-bg-border bg-exam-bg-white">
                        <span className="text-sm font-medium text-gray-600">Questions:</span>
                        <div className="flex gap-1 flex-wrap">
                            {questions.map((_, idx) => (
                                <button
                                    key={idx}
                                    onClick={() => setActiveQuestionIndex(idx)}
                                    className={`
                                        w-8 h-8 rounded text-sm font-medium transition-colors
                                        ${idx === activeQuestionIndex
                                            ? 'bg-status-current text-white'
                                            : 'bg-white border border-gray-300 hover:bg-gray-50'
                                        }
                                    `}
                                >
                                    {idx + 1}
                                </button>
                            ))}
                        </div>
                        {mode === 'set' && (
                            <button
                                onClick={addQuestion}
                                className="w-8 h-8 rounded border border-dashed border-gray-400 text-gray-400 hover:border-section-varc hover:text-section-varc transition-colors"
                                title="Add Question"
                            >
                                +
                            </button>
                        )}
                    </div>

                    {/* Active Question Editor */}
                    {activeQuestion && (
                        <div className="flex-1 overflow-y-auto p-6">
                            <QuestionEditor
                                question={activeQuestion}
                                questionNumber={activeQuestionIndex + 1}
                                canRemove={questions.length > 1}
                                onUpdate={(updates) => updateQuestion(activeQuestionIndex, updates)}
                                onUpdateOption={(optIdx, value) => updateQuestionOption(activeQuestionIndex, optIdx, value)}
                                onRemove={() => removeQuestion(activeQuestionIndex)}
                            />
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

// =============================================================================
// QUESTION EDITOR SUB-COMPONENT
// =============================================================================

interface QuestionEditorProps {
    question: QuestionDraft;
    questionNumber: number;
    canRemove: boolean;
    onUpdate: (updates: Partial<QuestionDraft>) => void;
    onUpdateOption: (optionIndex: number, value: string) => void;
    onRemove: () => void;
}

function QuestionEditor({
    question,
    questionNumber,
    canRemove,
    onUpdate,
    onUpdateOption,
    onRemove,
}: QuestionEditorProps) {
    const OPTION_LABELS = ['A', 'B', 'C', 'D'];

    return (
        <div className="bg-exam-bg-white rounded-lg border border-exam-bg-border p-6 space-y-6">
            {/* Question Header */}
            <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold text-exam-text-primary">
                    Question {questionNumber}
                </h3>
                <div className="flex items-center gap-3">
                    {/* Question Type */}
                    <select
                        value={question.question_type}
                        onChange={(e) => onUpdate({ question_type: e.target.value as QuestionType })}
                        className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm"
                    >
                        <option value="MCQ">MCQ</option>
                        <option value="TITA">TITA (Numeric)</option>
                    </select>

                    {/* Marks */}
                    <div className="flex items-center gap-2 text-sm">
                        <span className="text-green-600">+</span>
                        <input
                            type="number"
                            value={question.positive_marks}
                            onChange={(e) => onUpdate({ positive_marks: Number(e.target.value) })}
                            className="w-12 px-2 py-1 border border-green-300 rounded bg-green-50 text-center"
                            min={0}
                            step={0.5}
                        />
                        <span className="text-red-600">-</span>
                        <input
                            type="number"
                            value={question.negative_marks}
                            onChange={(e) => onUpdate({ negative_marks: Number(e.target.value) })}
                            className="w-12 px-2 py-1 border border-red-300 rounded bg-red-50 text-center"
                            min={0}
                            step={0.25}
                            disabled={question.question_type === 'TITA'}
                        />
                    </div>

                    {/* Remove Button */}
                    {canRemove && (
                        <button
                            onClick={onRemove}
                            className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                            title="Remove Question"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    )}
                </div>
            </div>

            {/* Question Text */}
            <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                    Question Text <span className="text-red-500">*</span>
                </label>
                <textarea
                    value={question.question_text}
                    onChange={(e) => onUpdate({ question_text: e.target.value })}
                    placeholder="Enter the question stem..."
                    rows={4}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none resize-y"
                />
            </div>

            {/* Question Image */}
            <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                    Question Image URL (optional)
                </label>
                <input
                    type="url"
                    value={question.question_image_url ?? ''}
                    onChange={(e) => onUpdate({ question_image_url: e.target.value })}
                    placeholder="https://..."
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none"
                />
            </div>

            {/* Options (for MCQ) */}
            {question.question_type === 'MCQ' && (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-3">
                        Options <span className="text-red-500">*</span>
                    </label>
                    <div className="space-y-3">
                        {OPTION_LABELS.map((label, idx) => (
                            <div key={label} className="flex items-center gap-3">
                                <button
                                    type="button"
                                    onClick={() => onUpdate({ correct_answer: label })}
                                    className={`
                                        w-10 h-10 rounded-full flex items-center justify-center font-bold transition-colors
                                        ${question.correct_answer === label
                                            ? 'bg-status-answered text-white'
                                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                        }
                                    `}
                                    title={question.correct_answer === label ? 'Correct answer' : 'Click to mark as correct'}
                                >
                                    {label}
                                </button>
                                <textarea
                                    value={question.options[idx] ?? ''}
                                    onChange={(e) => onUpdateOption(idx, e.target.value)}
                                    placeholder={`Enter option ${label}...`}
                                    rows={2}
                                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none resize-y min-h-[40px]"
                                />
                                {question.correct_answer === label && (
                                    <span className="text-status-answered text-sm font-medium">✓ Correct</span>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* Correct Answer (for TITA) */}
            {question.question_type === 'TITA' && (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        Correct Answer (Numeric) <span className="text-red-500">*</span>
                    </label>
                    <input
                        type="text"
                        value={question.correct_answer}
                        onChange={(e) => onUpdate({ correct_answer: e.target.value })}
                        placeholder="Enter the exact numeric answer..."
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none"
                    />
                    <p className="text-xs text-gray-500 mt-1">
                        Enter the exact answer. For ranges, use format: 45.5 to 46.5
                    </p>
                </div>
            )}

            {/* Solution */}
            <details className="group">
                <summary className="cursor-pointer text-sm font-medium text-gray-600 hover:text-gray-800">
                    Solution (Optional)
                </summary>
                <textarea
                    value={question.solution_text ?? ''}
                    onChange={(e) => onUpdate({ solution_text: e.target.value })}
                    placeholder="Enter the solution explanation..."
                    rows={4}
                    className="mt-3 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-section-varc outline-none resize-y"
                />
            </details>
        </div>
    );
}
````

## File: src/features/exam-engine/api/client.ts
````typescript
import type { SectionName, TimeRemaining } from '@/types/exam';

type ActionResult<T> = { success: boolean; data?: T; error?: string };

type SaveResponsePayload = {
    attemptId: string;
    questionId: string;
    answer: string | null;
    status: string;
    isMarkedForReview: boolean;
    isVisited?: boolean;
    timeSpentSeconds: number;
    visitCount?: number;
    sessionToken?: string | null;
    force_resume?: boolean;
};

type SaveBatchItem = Omit<SaveResponsePayload, 'attemptId' | 'sessionToken' | 'force_resume'>;

type SaveBatchPayload = {
    attemptId: string;
    sessionToken?: string | null;
    force_resume?: boolean;
    responses: SaveBatchItem[];
};

type ProgressPayload = {
    attemptId: string;
    timeRemaining: TimeRemaining;
    currentSection: SectionName;
    currentQuestion: number;
    sessionToken?: string | null;
    force_resume?: boolean;
};

type PausePayload = ProgressPayload & {
    sessionToken?: string | null;
};

type SubmitPayload = {
    attemptId: string;
    sessionToken?: string | null;
    force_resume?: boolean;
    submissionId?: string;
};

/**
 * Generic POST helper with proper response parsing.
 * Handles both { success, data: {...} } and { success, ...data } response formats.
 */
async function postJson<T>(url: string, body: unknown): Promise<ActionResult<T>> {
    try {
        const res = await fetch(url, {
            method: 'POST',
            credentials: 'include',
            cache: 'no-store',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });

        const payload = (await res.json().catch(() => ({}))) as Record<string, unknown>;

        if (!res.ok) {
            if (payload?.code === 'SESSION_CONFLICT') {
                return { success: false, error: 'SESSION_CONFLICT' };
            }
            return { success: false, error: (payload?.error as string) || 'Request failed' };
        }

        // Handle both response formats:
        // 1. { success: true, data: {...} } - standard format
        // 2. { success: true, total_score: ..., ... } - submit format (data at root)
        if (payload?.data !== undefined) {
            return { success: true, data: payload.data as T };
        }

        // For submit response, extract everything except 'success' and 'error' as data
        const data = { ...payload } as Record<string, unknown>;
        delete data.success;
        delete data.error;
        return { success: true, data: data as T };
    } catch {
        return { success: false, error: 'Network error' };
    }
}

export function initializeExamSession(attemptId: string): Promise<ActionResult<{ sessionToken: string }>> {
    return postJson<{ sessionToken: string }>('/api/session', { attemptId });
}

export function saveResponse(payload: SaveResponsePayload): Promise<ActionResult<void>> {
    return postJson<void>('/api/save', payload);
}

export function saveResponsesBatch(payload: SaveBatchPayload): Promise<ActionResult<{ saved: number }>> {
    return postJson<{ saved: number }>('/api/save-batch', payload);
}

export function updateAttemptProgress(payload: ProgressPayload): Promise<ActionResult<void>> {
    return postJson<void>('/api/progress', payload);
}

export function submitExam(payload: SubmitPayload): Promise<ActionResult<Record<string, unknown>>> {
    return postJson<Record<string, unknown>>('/api/submit', payload);
}

export function pauseExam(payload: PausePayload): Promise<ActionResult<void>> {
    return postJson<void>('/api/pause', payload);
}
````

## File: src/features/exam-engine/lib/scoring.ts
````typescript
/**
 * @fileoverview Exam Scoring Engine
 * @description Server-side scoring logic for CAT exam evaluation
 * @blueprint Milestone 5 - Milestone_Change_Log.md - Change 001, 003
 * @deviation Uses TypeScript scoring instead of SQL RPC for better testability
 */

import type { QuestionWithAnswer, SectionName, SectionScores } from '@/types/exam';
import { CAT_CONSTANTS } from '@/types/exam';

// =============================================================================
// TYPES
// =============================================================================

/** Response data for scoring */
export interface ResponseForScoring {
    question_id: string;
    answer: string | null;
    time_spent_seconds: number;
}

/** Individual question scoring result */
export interface QuestionScoringResult {
    question_id: string;
    section: SectionName;
    is_correct: boolean;
    marks_obtained: number;
    user_answer: string | null;
    correct_answer: string;
}

/** Complete scoring result */
export interface ScoringResult {
    total_score: number;
    max_possible_score: number;
    correct_count: number;
    incorrect_count: number;
    unanswered_count: number;
    accuracy: number;           // (correct / attempted) * 100
    attempt_rate: number;       // (attempted / total) * 100
    section_scores: SectionScores;
    question_results: QuestionScoringResult[];
}

type MutableSectionScore = {
    score: number;
    correct: number;
    incorrect: number;
    unanswered: number;
};

type MutableSectionScores = Record<SectionName, MutableSectionScore>;

// =============================================================================
// NORMALIZATION UTILITIES
// =============================================================================

/**
 * Normalize a string value for comparison
 * - Trims whitespace
 * - Converts to lowercase
 * - Collapses multiple spaces to single space
 */
export function normalizeString(val: string | number | null | undefined): string {
    if (val === null || val === undefined) return '';
    return String(val).trim().toLowerCase().replace(/\s+/g, ' ');
}

/**
 * Attempt to parse a value as a number
 * Returns null if not a valid number
 */
export function parseAsNumber(val: string | null | undefined): number | null {
    if (val === null || val === undefined || val.trim() === '') return null;

    const normalized = val.trim();
    const parsed = Number(normalized);

    // Check for valid number (not NaN, not Infinity)
    if (!Number.isFinite(parsed)) return null;

    return parsed;
}

/**
 * Compare two answers for equality
 * Handles both string and numeric comparisons
 * 
 * For TITA questions:
 * - Tries numeric comparison first (handles "42" vs "42.0")
 * - Falls back to normalized string comparison
 * 
 * For MCQ questions:
 * - Direct uppercase comparison (A, B, C, D)
 */
export function compareAnswers(
    userAnswer: string | null,
    correctAnswer: string,
    questionType: 'MCQ' | 'TITA'
): boolean {
    // Handle null/empty user answer
    if (userAnswer === null || userAnswer.trim() === '') {
        return false;
    }

    if (questionType === 'MCQ') {
        // MCQ: Direct comparison (case-insensitive)
        return normalizeString(userAnswer) === normalizeString(correctAnswer);
    }

    // TITA: Try numeric comparison first
    const userNum = parseAsNumber(userAnswer);
    const correctNum = parseAsNumber(correctAnswer);

    if (userNum !== null && correctNum !== null) {
        // Both are valid numbers - compare numerically
        // Use small epsilon for floating point comparison
        const epsilon = 1e-9;
        return Math.abs(userNum - correctNum) < epsilon;
    }

    // Fall back to normalized string comparison
    return normalizeString(userAnswer) === normalizeString(correctAnswer);
}

// =============================================================================
// SCORING FUNCTIONS
// =============================================================================

/**
 * Calculate marks for a single question based on CAT marking scheme
 * 
 * CAT Marking Scheme:
 * - Correct MCQ: +3
 * - Wrong MCQ: -1
 * - Correct TITA: +3
 * - Wrong TITA: 0 (no negative marking)
 * - Unanswered: 0
 */
export function calculateQuestionMarks(
    question: QuestionWithAnswer,
    userAnswer: string | null
): { isCorrect: boolean; marksObtained: number } {
    // Check if unanswered
    if (userAnswer === null || userAnswer.trim() === '') {
        return { isCorrect: false, marksObtained: 0 };
    }

    // Check if correct
    const isCorrect = compareAnswers(userAnswer, question.correct_answer, question.question_type);

    if (isCorrect) {
        // Use question-specific marks or CAT default
        const marks = question.positive_marks ?? CAT_CONSTANTS.POSITIVE_MARKS;
        return { isCorrect: true, marksObtained: marks };
    }

    // Wrong answer
    if (question.question_type === 'MCQ') {
        // MCQ has negative marking
        const negativeMark = question.negative_marks ?? CAT_CONSTANTS.NEGATIVE_MARKS_MCQ;
        return { isCorrect: false, marksObtained: -negativeMark };
    }

    // TITA has no negative marking
    return { isCorrect: false, marksObtained: 0 };
}

/**
 * Initialize empty section scores
 */
function initializeSectionScores(): MutableSectionScores {
    const sections: SectionName[] = ['VARC', 'DILR', 'QA'];
    const sectionScores: Partial<MutableSectionScores> = {};

    for (const section of sections) {
        sectionScores[section] = {
            score: 0,
            correct: 0,
            incorrect: 0,
            unanswered: 0,
        };
    }

    return sectionScores as MutableSectionScores;
}

/**
 * Calculate complete exam score
 * 
 * @param questions - All questions with correct answers
 * @param responses - User's responses
 * @returns Complete scoring result with section breakdowns
 */
export function calculateScore(
    questions: QuestionWithAnswer[],
    responses: ResponseForScoring[]
): ScoringResult {
    // Create response lookup map
    const responseMap = new Map<string, ResponseForScoring>();
    for (const response of responses) {
        responseMap.set(response.question_id, response);
    }

    // Initialize counters
    let totalScore = 0;
    let maxPossibleScore = 0;
    let correctCount = 0;
    let incorrectCount = 0;
    let unansweredCount = 0;

    const sectionScores = initializeSectionScores();
    const questionResults: QuestionScoringResult[] = [];

    // Process each question
    for (const question of questions) {
        const response = responseMap.get(question.id);
        const userAnswer = response?.answer ?? null;

        // Calculate marks for this question
        const { isCorrect, marksObtained } = calculateQuestionMarks(question, userAnswer);

        // Update totals
        totalScore += marksObtained;
        maxPossibleScore += question.positive_marks ?? CAT_CONSTANTS.POSITIVE_MARKS;

        // Update section scores
        const sectionScore = sectionScores[question.section];
        sectionScore.score += marksObtained;

        // Categorize response
        const isUnanswered = userAnswer === null || userAnswer.trim() === '';

        if (isUnanswered) {
            unansweredCount++;
            sectionScore.unanswered++;
        } else if (isCorrect) {
            correctCount++;
            sectionScore.correct++;
        } else {
            incorrectCount++;
            sectionScore.incorrect++;
        }

        // Store individual result
        questionResults.push({
            question_id: question.id,
            section: question.section,
            is_correct: isCorrect,
            marks_obtained: marksObtained,
            user_answer: userAnswer,
            correct_answer: question.correct_answer,
        });
    }

    // Calculate percentages
    const attemptedCount = correctCount + incorrectCount;
    const totalQuestions = questions.length;

    const accuracy = attemptedCount > 0
        ? Math.round((correctCount / attemptedCount) * 10000) / 100
        : 0;

    const attemptRate = totalQuestions > 0
        ? Math.round((attemptedCount / totalQuestions) * 10000) / 100
        : 0;

    return {
        total_score: totalScore,
        max_possible_score: maxPossibleScore,
        correct_count: correctCount,
        incorrect_count: incorrectCount,
        unanswered_count: unansweredCount,
        accuracy,
        attempt_rate: attemptRate,
        section_scores: sectionScores as SectionScores,
        question_results: questionResults,
    };
}

/**
 * Calculate time taken from start to submission
 */
export function calculateTimeTaken(
    startedAt: string,
    submittedAt: string,
    totalPausedSeconds: number = 0
): number {
    const start = new Date(startedAt).getTime();
    const end = new Date(submittedAt).getTime();
    const rawSeconds = Math.floor((end - start) / 1000);
    const pausedSeconds = Number.isFinite(totalPausedSeconds)
        ? Math.max(0, Math.floor(totalPausedSeconds))
        : 0;
    return Math.max(0, rawSeconds - pausedSeconds);
}

/**
 * Calculate a simple rank based on score position
 * Returns the count of attempts with higher scores + 1
 */
export async function calculateRank(
    supabase: { from: (table: string) => { select: (cols: string, opts?: { count: 'exact'; head: boolean }) => { eq: (col: string, val: unknown) => { gt: (col: string, val: number) => Promise<{ count: number | null }> } } } },
    paperId: string,
    totalScore: number
): Promise<number> {
    const { count } = await supabase
        .from('attempts')
        .select('*', { count: 'exact', head: true })
        .eq('paper_id', paperId)
        .gt('total_score', totalScore);

    return (count ?? 0) + 1;
}
````

## File: src/features/exam-engine/ui/MCQRenderer.tsx
````typescript
/**
 * @fileoverview MCQ Question Renderer Component
 * @description Radio button component for MCQ questions with 4 options
 * @blueprint Milestone 4 SOP-SSOT - Phase 3.3
 */

'use client';

import { useCallback } from 'react';
import { useExamStore, selectResponse } from '@/features/exam-engine';
import type { Question } from '@/types/exam';
import { MathText } from './MathText';

// =============================================================================
// TYPES
// =============================================================================

interface MCQRendererProps {
    /** The question to render */
    question: Question;
    /** Optional CSS class name */
    className?: string;
    /** Read-only mode (for review) */
    readOnly?: boolean;
    /** Show correct answer (for results) */
    showCorrectAnswer?: boolean;
    /** Correct answer (only available in results) */
    correctAnswer?: string;
    /** Optional answer override for review mode */
    answerOverride?: string | null;
}

interface OptionProps {
    value: string;
    text: string;
    isSelected: boolean;
    isCorrect?: boolean;
    isIncorrect?: boolean;
    readOnly: boolean;
    name: string;
    inputId: string;
    textId: string;
    onChange: (value: string) => void;
}

// =============================================================================
// OPTION LABELS
// =============================================================================

const OPTION_LABELS = ['A', 'B', 'C', 'D'] as const;

// =============================================================================
// SINGLE OPTION COMPONENT
// =============================================================================

function MCQOption({
    value,
    text,
    isSelected,
    isCorrect,
    isIncorrect,
    readOnly,
    name,
    inputId,
    textId,
    onChange,
}: OptionProps) {
    const textColor = isCorrect
        ? 'text-green-700'
        : isIncorrect && isSelected
            ? 'text-red-700'
            : 'text-gray-800';

    return (
        <label
            htmlFor={inputId}
            className={`flex items-start gap-3 py-2 ${readOnly ? 'cursor-default' : 'cursor-pointer hover:bg-gray-50'} rounded-md`}
        >
            <input
                id={inputId}
                type="radio"
                name={name}
                value={value}
                checked={isSelected}
                onChange={() => !readOnly && onChange(value)}
                disabled={readOnly}
                aria-describedby={textId}
                className="mt-1 h-4 w-4 accent-blue-600"
            />
            <span id={textId} className={`flex-1 text-left ${textColor}`}>
                <MathText text={text} />
            </span>
            {isCorrect && <span className="text-xs font-semibold text-green-600">Correct</span>}
            {isIncorrect && isSelected && <span className="text-xs font-semibold text-red-600">Incorrect</span>}
        </label>
    );
}

// =============================================================================
// MAIN COMPONENT
// =============================================================================

export function MCQRenderer({
    question,
    className = '',
    readOnly = false,
    showCorrectAnswer = false,
    correctAnswer,
    answerOverride = null,
}: MCQRendererProps) {
    const response = useExamStore(selectResponse(question.id));
    // FIX: Use setLocalAnswer to store answer locally without changing status
    // Status only changes when user clicks "Save and Next"
    const setLocalAnswer = useExamStore((s) => s.setLocalAnswer);

    const selectedAnswer = answerOverride ?? response?.answer ?? null;

    // Handle option selection - stores locally, does NOT turn palette green
    const handleChange = useCallback(
        (value: string) => {
            if (!readOnly) {
                setLocalAnswer(question.id, value);
            }
        },
        [question.id, readOnly, setLocalAnswer]
    );

    // Parse options from the question
    const options = question.options ?? [];

    return (
        <div className={`space-y-4 ${className}`}>
            <fieldset className="space-y-3">
                <legend className="sr-only">Multiple choice options</legend>
                {options.map((optionText, index) => {
                    const label = OPTION_LABELS[index] ?? String(index + 1);
                    const isSelected = selectedAnswer === label;
                    const isCorrect = showCorrectAnswer && correctAnswer === label;
                    const isIncorrect = showCorrectAnswer && isSelected && correctAnswer !== label;
                    const name = `mcq-${question.id}`;
                    const inputId = `mcq-${question.id}-${label}`;
                    const textId = `mcq-${question.id}-${label}-text`;

                    return (
                        <MCQOption
                            key={`${question.id}-${index}`}
                            value={label}
                            text={optionText}
                            isSelected={isSelected}
                            isCorrect={isCorrect}
                            isIncorrect={isIncorrect}
                            readOnly={readOnly}
                            name={name}
                            inputId={inputId}
                            textId={textId}
                            onChange={handleChange}
                        />
                    );
                })}
            </fieldset>

            {/* Marking Info */}
            <div className="flex items-center gap-4 text-sm text-gray-500 pt-2">
                <span>+{question.positive_marks} for correct</span>
                <span>-{question.negative_marks} for incorrect</span>
            </div>
        </div>
    );
}
````

## File: src/features/exam-engine/ui/QuestionPalette.tsx
````typescript
/**
 * @fileoverview Question Palette Component
 * @description Grid of question buttons with status-based colors for exam navigation
 * @blueprint Milestone 4 SOP-SSOT - Phase 3.2
 */

'use client';

import { useCallback, useMemo } from 'react';
import { useExamStore, selectCurrentSection } from '@/features/exam-engine';
import type { Question, QuestionStatus } from '@/types/exam';
import { getQuestionsForSection } from '@/types/exam';
import { PaletteShell } from '@/features/shared/ui/PaletteShell';

// =============================================================================
// TYPES
// =============================================================================

interface QuestionPaletteProps {
    /** All questions for the current paper */
    questions: Question[];
    /** Candidate display name */
    candidateName?: string;
    /** Candidate photo URL */
    candidatePhotoUrl?: string;
    /** Optional CSS class name */
    className?: string;
    /** Callback when a question is clicked */
    onQuestionClick?: (questionId: string, index: number) => void;
}

interface QuestionButtonProps {
    index: number;
    status: QuestionStatus;
    isCurrent: boolean;
    onClick: () => void;
    disabled?: boolean;
    isLocked?: boolean;
}

// =============================================================================
// STATUS COLORS (CAT exam standard)
// =============================================================================

// TCS iON Style "Irregular Hexagons" (Pentagons)
// Answered (Green): Pointed Top, Flat Bottom, Vertical Sides (Side parallel to X-axis at bottom)
const HEXAGON_UP = 'polygon(50% 0%, 100% 35%, 100% 100%, 0% 100%, 0% 35%)';

// Not Answered (Red): Flat Top, Vertical Sides, Pointed Bottom (Side parallel to X-axis at top)
const HEXAGON_DOWN = 'polygon(0% 0%, 100% 0%, 100% 65%, 50% 100%, 0% 65%)';

/**
 * Get button styles based on question status
 * Colors + shapes match required CAT palette spec
 * 
 * PHASE 2 FIX: 5 distinct status categories:
 * 1. Answered (green hexagon-up)
 * 2. Not Answered/Visited (red hexagon-down)
 * 3. Not Visited (gray square)
 * 4. Marked for Review (purple circle - no answer)
 * 5. Attempted & Marked (purple circle with green checkmark - answered_marked)
 */
function getStatusStyles(status: QuestionStatus, isCurrent: boolean) {
    const baseStyles =
        'w-10 h-10 flex items-center justify-center text-sm font-semibold transition-all border ' +
        'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#2D89EF]';
    const currentRing = isCurrent ? 'ring-4 ring-offset-1 ring-[#D35400]' : '';

    switch (status) {
        case 'answered':
            return {
                className: `${baseStyles} ${currentRing} bg-[#4caf50] text-white hover:bg-[#43a047] border-[#388e3c]`,
                label: 'Answered',
                shapeClass: 'rounded-none',
                clipPath: HEXAGON_UP,
            };
        case 'answered_marked':
            // PHASE 2 FIX: Distinct styling for "Attempted & Marked"
            // Purple circle with green checkmark badge to show both states
            return {
                className: `${baseStyles} ${currentRing} bg-[#7e57c2] text-white hover:bg-[#6a46ae] border-[#5e35b1]`,
                label: 'Attempted & Marked for Review',
                shapeClass: 'rounded-full',
                clipPath: undefined,
            };
        case 'marked':
            return {
                className: `${baseStyles} ${currentRing} bg-[#7e57c2] text-white hover:bg-[#6a46ae] border-[#5e35b1]`,
                label: 'Marked for Review (Not Answered)',
                shapeClass: 'rounded-full',
                clipPath: undefined,
            };
        case 'visited':
            return {
                className: `${baseStyles} ${currentRing} bg-[#e53935] text-white hover:bg-[#d32f2f] border-[#c62828]`,
                label: 'Not Answered',
                shapeClass: 'rounded-none',
                clipPath: HEXAGON_DOWN,
            };
        case 'not_visited':
        default:
            return {
                className: `${baseStyles} ${currentRing} bg-[#eceff1] text-[#37474f] hover:bg-[#e0e6e9] border-[#cfd8dc]`,
                label: 'Not Visited',
                shapeClass: 'rounded-none',
                clipPath: undefined,
            };
    }
}

// =============================================================================
// QUESTION BUTTON
// =============================================================================

function QuestionButton({ index, status, isCurrent, onClick, disabled = false, isLocked = false }: QuestionButtonProps) {
    const styles = getStatusStyles(status, isCurrent);
    const isMarkedForReview = status === 'answered_marked' || status === 'marked';
    const isAttemptedAndMarked = status === 'answered_marked';
    const statusLabel =
        status === 'answered' || status === 'answered_marked'
            ? 'Answered'
            : status === 'visited'
                ? 'Not Answered'
                : status === 'marked'
                    ? 'Not Answered'
                    : 'Not Visited';
    const markedLabel = isMarkedForReview ? ', Marked for review' : '';
    const lockedLabel = isLocked ? ', Locked' : '';
    const ariaLabel = `Question ${index + 1}, ${statusLabel}${markedLabel}${isCurrent ? ', current' : ''}${lockedLabel}`;

    return (
        <button
            type="button"
            onClick={onClick}
            className={`${styles.className} ${styles.shapeClass} relative ${disabled ? 'opacity-60 cursor-not-allowed' : ''}`}
            style={styles.clipPath ? { clipPath: styles.clipPath } : undefined}
            title={`Question ${index + 1}: ${styles.label}`}
            aria-label={ariaLabel}
            aria-current={isCurrent ? 'true' : undefined}
            aria-disabled={disabled ? 'true' : undefined}
            disabled={disabled}
        >
            {index + 1}
            {isAttemptedAndMarked && (
                <span className="absolute -bottom-1 -right-1 w-3 h-3 bg-[#2E7D32] rounded-full border border-white flex items-center justify-center">
                    <svg className="w-2 h-2 text-white" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path
                            fillRule="evenodd"
                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                            clipRule="evenodd"
                        />
                    </svg>
                </span>
            )}
            {isLocked && (
                <span className="absolute -top-1 -right-1 rounded bg-gray-800 text-white text-[9px] px-1 py-0.5">Locked</span>
            )}
        </button>
    );
}

// =============================================================================
// SECTION COUNTS
// =============================================================================

interface SectionCountsProps {
    questions: Question[];
}

function SectionCounts({ questions }: SectionCountsProps) {
    const responses = useExamStore((s) => s.responses);

    const counts = useMemo(() => {
        const result = {
            answered: 0,
            notAnswered: 0,
            notVisited: 0,
            marked: 0,           // Marked but NOT answered
            answeredMarked: 0,   // PHASE 2 FIX: Separate count for answered & marked
        };

        questions.forEach((q) => {
            const response = responses[q.id];
            if (!response || response.status === 'not_visited') {
                result.notVisited++;
            } else if (response.status === 'answered') {
                result.answered++;
            } else if (response.status === 'answered_marked') {
                // PHASE 2 FIX: Count answered_marked separately
                result.answeredMarked++;
            } else if (response.status === 'visited') {
                result.notAnswered++;
            } else if (response.status === 'marked') {
                result.marked++;
            }
        });

        return result;
    }, [questions, responses]);

    return (
        <div className="mb-4 grid grid-cols-2 gap-2 text-sm">
            <div className="flex items-center gap-2">
                <span className="w-3 h-3 rounded bg-[#4caf50]" />
                <span className="text-gray-600">{counts.answered} Answered</span>
            </div>
            <div className="flex items-center gap-2">
                <span className="w-3 h-3 rounded bg-[#e53935]" />
                <span className="text-gray-600">{counts.notAnswered} Not Answered</span>
            </div>
            <div className="flex items-center gap-2">
                <span className="w-3 h-3 rounded bg-[#eceff1] border border-[#cfd8dc]" />
                <span className="text-gray-600">{counts.notVisited} Not Visited</span>
            </div>
            <div className="flex items-center gap-2">
                <span className="w-3 h-3 rounded-full bg-[#7e57c2]" />
                <span className="text-gray-600">{counts.marked} Marked</span>
            </div>
            {/* PHASE 2 FIX: Show Attempted & Marked count */}
            <div className="flex items-center gap-2 col-span-2">
                <span className="w-3 h-3 rounded-full bg-[#7e57c2] relative">
                    <span className="absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-[#4caf50] rounded-full" />
                </span>
                <span className="text-gray-600">{counts.answeredMarked} Attempted & Marked</span>
            </div>
        </div>
    );
}

// =============================================================================
// CANDIDATE PROFILE
// =============================================================================

function CandidateProfile({ name, photoUrl }: { name: string; photoUrl?: string }) {
    return (
        <div className="flex items-center gap-3 p-4 border-b border-gray-200">
            <div className="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center">
                {photoUrl ? (
                    <img src={photoUrl} alt="Candidate" className="w-full h-full object-cover" />
                ) : (
                    <span className="text-xs text-gray-500">Photo</span>
                )}
            </div>
            <div>
                <div className="text-sm font-semibold text-gray-800">{name}</div>
                <div className="text-xs text-gray-500">Candidate</div>
            </div>
        </div>
    );
}

// =============================================================================
// MAIN COMPONENT
// =============================================================================

export function QuestionPalette({
    questions,
    candidateName = 'Candidate',
    candidatePhotoUrl,
    className = '',
    onQuestionClick
}: QuestionPaletteProps) {
    const currentSection = useExamStore(selectCurrentSection);
    const currentQuestionIndex = useExamStore((s) => s.currentQuestionIndex);
    const currentSectionIndex = useExamStore((s) => s.currentSectionIndex);
    const responses = useExamStore((s) => s.responses);
    const goToQuestion = useExamStore((s) => s.goToQuestion);

    // Get questions for current section
    const sectionQuestions = useMemo(() => {
        return getQuestionsForSection(questions, currentSection);
    }, [questions, currentSection]);

    // Handle question click
    const handleQuestionClick = useCallback((question: Question, index: number) => {
        if (question.section !== currentSection) {
            return;
        }
        goToQuestion(question.id, currentSectionIndex, index);
        onQuestionClick?.(question.id, index);
    }, [goToQuestion, currentSectionIndex, currentSection, onQuestionClick]);

    return (
        <PaletteShell className={className}>
            <CandidateProfile name={candidateName} photoUrl={candidatePhotoUrl} />

            {/* Section Header */}
            <div className="flex items-center justify-between mb-4 mt-4">
                <h3 className="text-lg font-semibold text-gray-800">
                    {currentSection}
                </h3>
                <span className="text-sm text-gray-500">
                    {sectionQuestions.length} Questions
                </span>
            </div>

            {/* Counts Summary */}
            <SectionCounts questions={sectionQuestions} />

            {/* Question Grid */}
            <div className="grid grid-cols-6 gap-2 mb-4">
                {sectionQuestions.map((question, index) => {
                    const response = responses[question.id];
                    const status: QuestionStatus = response?.status ?? 'not_visited';
                    const isCurrent = index === currentQuestionIndex;
                    const isLocked = question.section !== currentSection;

                    return (
                        <QuestionButton
                            key={question.id}
                            index={index}
                            status={status}
                            isCurrent={isCurrent}
                            disabled={isLocked}
                            isLocked={isLocked}
                            onClick={() => handleQuestionClick(question, index)}
                        />
                    );
                })}
            </div>

        </PaletteShell>
    );
}
````

## File: src/features/exam-engine/ui/SectionalPerformance.tsx
````typescript
/**
 * @fileoverview Sectional Performance Component
 * @description Section-wise breakdown of exam performance (VARC, DILR, QA)
 * @blueprint Milestone 5 - Milestone_Change_Log.md - Change 002
 */

import { type SectionName, getSectionDisplayLabel } from '@/types/exam';

interface SectionScore {
    score: number;
    correct: number;
    incorrect: number;
    unanswered: number;
}

interface SectionalPerformanceProps {
    sectionScores: Record<string, SectionScore>;
    sectionConfig?: {
        [key: string]: {
            maxMarks: number;
            totalQuestions: number;
        };
    };
}

/** Section display configuration */
const SECTION_DISPLAY: Record<SectionName, {
    fullName: string;
    color: string;
    bgColor: string;
}> = {
    VARC: {
        fullName: 'Verbal Ability & Reading Comprehension',
        color: 'text-blue-700',
        bgColor: 'bg-blue-50',
    },
    DILR: {
        fullName: 'Data Interpretation & Logical Reasoning',
        color: 'text-purple-700',
        bgColor: 'bg-purple-50',
    },
    QA: {
        fullName: 'Quantitative Aptitude',
        color: 'text-green-700',
        bgColor: 'bg-green-50',
    },
};

/** Default CAT 2024 section config */
const DEFAULT_SECTION_CONFIG: Record<SectionName, { maxMarks: number; totalQuestions: number }> = {
    VARC: { maxMarks: 72, totalQuestions: 24 },
    DILR: { maxMarks: 60, totalQuestions: 20 },
    QA: { maxMarks: 66, totalQuestions: 22 },
};

export function SectionalPerformance({ sectionScores, sectionConfig }: SectionalPerformanceProps) {
    const sections: SectionName[] = ['VARC', 'DILR', 'QA'];
    const config = sectionConfig || DEFAULT_SECTION_CONFIG;

    return (
        <div className="mb-8">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
                Section-wise Performance
            </h2>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {sections.map((sectionName) => {
                    const scores = sectionScores[sectionName];
                    const sectionDisplay = SECTION_DISPLAY[sectionName];
                    const sectionCfg = config[sectionName] || { maxMarks: 0, totalQuestions: 0 };

                    const sectionLabel = getSectionDisplayLabel(sectionName);

                    if (!scores) {
                        return (
                            <div
                                key={sectionName}
                                className={`${sectionDisplay.bgColor} rounded-xl p-5 border`}
                            >
                                <h3 className={`font-bold text-lg ${sectionDisplay.color} mb-1`}>
                                    {sectionLabel}
                                </h3>
                                <p className="text-gray-400 text-sm">No data available</p>
                            </div>
                        );
                    }

                    const totalAttempted = scores.correct + scores.incorrect;
                    const accuracy = totalAttempted > 0
                        ? ((scores.correct / totalAttempted) * 100).toFixed(1)
                        : '0.0';
                    const scorePercentage = sectionCfg.maxMarks > 0
                        ? (scores.score / sectionCfg.maxMarks) * 100
                        : 0;

                    return (
                        <div
                            key={sectionName}
                            className={`${sectionDisplay.bgColor} rounded-xl p-5 border shadow-sm transition-shadow hover:shadow-md`}
                        >
                            {/* Section Header */}
                            <div className="mb-4">
                                <h3 className={`font-bold text-lg ${sectionDisplay.color}`}>
                                    {sectionLabel}
                                </h3>
                                <p className="text-xs text-gray-500">
                                    {sectionDisplay.fullName}
                                </p>
                            </div>

                            {/* Score Display */}
                            <div className="mb-4">
                                <div className="flex items-baseline gap-1">
                                    <span className={`text-3xl font-bold ${sectionDisplay.color}`}>
                                        {scores.score}
                                    </span>
                                    <span className="text-gray-400 text-sm">
                                        / {sectionCfg.maxMarks}
                                    </span>
                                </div>
                                {/* Progress Bar */}
                                <div className="h-2 bg-gray-200 rounded-full mt-2 overflow-hidden">
                                    <div
                                        className={`h-full transition-all duration-500 ${scorePercentage >= 50 ? 'bg-green-500' :
                                            scorePercentage >= 25 ? 'bg-yellow-500' : 'bg-red-500'
                                            }`}
                                        style={{ width: `${Math.max(0, Math.min(100, scorePercentage))}%` }}
                                    />
                                </div>
                            </div>

                            {/* Stats Grid */}
                            <div className="grid grid-cols-2 gap-2 text-sm">
                                <div className="flex justify-between">
                                    <span className="text-gray-600">Correct</span>
                                    <span className="font-semibold text-green-600">
                                        {scores.correct}
                                    </span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-600">Incorrect</span>
                                    <span className="font-semibold text-red-600">
                                        {scores.incorrect}
                                    </span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-600">Skipped</span>
                                    <span className="font-semibold text-gray-500">
                                        {scores.unanswered}
                                    </span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-600">Accuracy</span>
                                    <span className="font-semibold text-orange-600">
                                        {accuracy}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
}
````

## File: src/utils/update-session.ts
````typescript
import { NextRequest, NextResponse } from 'next/server';
import { createServerClient, type CookieOptions } from '@supabase/ssr';

// Keeps Supabase auth cookies fresh during SSR/middleware and returns a response to continue.
export async function updateSession(req: NextRequest) {
    const res = NextResponse.next({ request: { headers: req.headers } });

    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string | undefined;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string | undefined;

    const supabase = createServerClient(url || 'http://localhost:54321', anon || 'anon', {
        cookies: {
            getAll() {
                return req.cookies.getAll();
            },
            setAll(cookiesToSet: Array<{ name: string; value: string; options: CookieOptions }>) {
                cookiesToSet.forEach(({ name, value, options }) => {
                    res.cookies.set({ name, value, ...options });
                });
            },
        },
    });

    // Touch the auth session to ensure cookies are refreshed when needed
    await supabase.auth.getSession();

    return res;
}
````

## File: tsconfig.tsbuildinfo
````
{"fileNames":["./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es5.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2015.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2016.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2017.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2018.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2019.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2020.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2021.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2022.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2023.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2024.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.dom.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.dom.iterable.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2015.core.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2015.collection.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2015.generator.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2015.iterable.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2015.promise.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2015.proxy.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2015.reflect.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2015.symbol.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2015.symbol.wellknown.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2016.array.include.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2016.intl.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2017.arraybuffer.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2017.date.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2017.object.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2017.sharedmemory.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2017.string.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2017.intl.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2017.typedarrays.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2018.asyncgenerator.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2018.asynciterable.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2018.intl.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2018.promise.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2018.regexp.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2019.array.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2019.object.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2019.string.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2019.symbol.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2019.intl.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2020.bigint.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2020.date.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2020.promise.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2020.sharedmemory.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2020.string.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2020.symbol.wellknown.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2020.intl.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2020.number.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2021.promise.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2021.string.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2021.weakref.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2021.intl.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2022.array.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2022.error.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2022.intl.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2022.object.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2022.string.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2022.regexp.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2023.array.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2023.collection.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2023.intl.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2024.arraybuffer.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2024.collection.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2024.object.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2024.promise.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2024.regexp.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2024.sharedmemory.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.es2024.string.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.array.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.collection.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.intl.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.disposable.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.promise.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.decorators.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.iterator.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.float16.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.error.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.esnext.sharedmemory.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.decorators.d.ts","./node_modules/.pnpm/typescript@5.9.3/node_modules/typescript/lib/lib.decorators.legacy.d.ts","./node_modules/.pnpm/@types+react@19.2.2/node_modules/@types/react/global.d.ts","./node_modules/.pnpm/csstype@3.1.3/node_modules/csstype/index.d.ts","./node_modules/.pnpm/@types+react@19.2.2/node_modules/@types/react/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/styled-jsx/types/css.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/styled-jsx/types/macro.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/styled-jsx/types/style.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/styled-jsx/types/global.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/styled-jsx/types/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/get-page-files.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/compatibility/disposable.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/compatibility/indexable.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/compatibility/iterators.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/compatibility/index.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/globals.typedarray.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/buffer.buffer.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/globals.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/web-globals/abortcontroller.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/web-globals/domexception.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/web-globals/events.d.ts","./node_modules/.pnpm/buffer@5.7.1/node_modules/buffer/index.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/header.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/readable.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/file.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/fetch.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/formdata.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/connector.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/client.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/errors.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/dispatcher.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/global-dispatcher.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/global-origin.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/pool-stats.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/pool.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/handlers.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/balanced-pool.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/agent.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/mock-interceptor.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/mock-agent.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/mock-client.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/mock-pool.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/mock-errors.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/proxy-agent.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/env-http-proxy-agent.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/retry-handler.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/retry-agent.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/api.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/interceptors.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/util.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/cookies.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/patch.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/websocket.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/eventsource.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/filereader.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/diagnostics-channel.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/content-type.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/cache.d.ts","./node_modules/.pnpm/undici-types@6.21.0/node_modules/undici-types/index.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/web-globals/fetch.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/assert.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/assert/strict.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/async_hooks.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/buffer.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/child_process.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/cluster.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/console.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/constants.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/crypto.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/dgram.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/diagnostics_channel.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/dns.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/dns/promises.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/domain.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/events.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/fs.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/fs/promises.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/http.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/http2.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/https.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/inspector.generated.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/module.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/net.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/os.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/path.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/perf_hooks.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/process.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/punycode.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/querystring.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/readline.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/readline/promises.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/repl.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/sea.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/stream.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/stream/promises.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/stream/consumers.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/stream/web.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/string_decoder.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/test.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/timers.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/timers/promises.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/tls.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/trace_events.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/tty.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/url.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/util.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/v8.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/vm.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/wasi.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/worker_threads.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/zlib.d.ts","./node_modules/.pnpm/@types+node@20.19.21/node_modules/@types/node/index.d.ts","./node_modules/.pnpm/@types+react@19.2.2/node_modules/@types/react/canary.d.ts","./node_modules/.pnpm/@types+react@19.2.2/node_modules/@types/react/experimental.d.ts","./node_modules/.pnpm/@types+react-dom@19.2.2_@types+react@19.2.2/node_modules/@types/react-dom/index.d.ts","./node_modules/.pnpm/@types+react-dom@19.2.2_@types+react@19.2.2/node_modules/@types/react-dom/canary.d.ts","./node_modules/.pnpm/@types+react-dom@19.2.2_@types+react@19.2.2/node_modules/@types/react-dom/experimental.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/fallback.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/webpack/webpack.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/modern-browserslist-target.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/entry-constants.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/constants.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/config.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/load-custom-routes.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/image-config.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack/plugins/subresource-integrity-plugin.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/body-streams.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/cache-control.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/setup-exception-listeners.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/worker.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/constants.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/bundler.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/experimental/ppr.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/page-types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/segment-config/app/app-segment-config.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/segment-config/pages/pages-segment-config.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/analysis/get-page-static-info.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack/loaders/get-module-build-info.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack/plugins/middleware-plugin.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/require-hook.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-polyfill-crypto.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-baseline.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-extensions/error-inspect.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-extensions/console-file.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-extensions/console-exit.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-extensions/console-dim.external.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-extensions/unhandled-rejection.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-extensions/random.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-extensions/date.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-extensions/web-crypto.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-extensions/node-crypto.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment-extensions/fast-set-immediate.external.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/node-environment.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/page-extensions-type.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-kind.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-definitions/route-definition.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-definitions/app-page-route-definition.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/cache-handlers/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/response-cache/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/resume-data-cache/cache-store.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/resume-data-cache/resume-data-cache.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/app-router-headers.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/render-result.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/instrumentation/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/coalesced-function.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/router/utils/middleware-route-matcher.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/router-utils/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/trace/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/trace/trace.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/trace/shared.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/trace/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/load-jsconfig.d.ts","./node_modules/.pnpm/@next+env@16.1.3/node_modules/@next/env/dist/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack/plugins/telemetry-plugin/use-cache-tracker-utils.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack/plugins/telemetry-plugin/telemetry-plugin.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/telemetry/storage.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/build-context.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/bloom-filter.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack-config.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/swc/generated-native.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/swc/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/dev/parse-version-info.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/next-devtools/shared/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/dev/dev-indicator-server-state.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/next-devtools/dev-overlay/cache-indicator.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/parse-stack.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/next-devtools/server/shared.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/next-devtools/shared/stack-frame.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/next-devtools/dev-overlay/utils/get-error-by-type.d.ts","./node_modules/.pnpm/@types+react@19.2.2/node_modules/@types/react/jsx-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/next-devtools/dev-overlay/container/runtime-error/render-error.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/next-devtools/dev-overlay/shared.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/dev/debug-channel.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/dev/hot-reloader-types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/i18n-provider.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/next-url.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/@edge-runtime/cookies/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/cookies.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/request.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/after/builtin-request-context.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/fetch-event.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/response.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/segment-config/middleware/middleware-config.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack/plugins/pages-manifest-plugin.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/router/utils/parse-url.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-definitions/locale-route-definition.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-definitions/pages-route-definition.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack/plugins/flight-manifest-plugin.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack/plugins/next-font-manifest-plugin.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/deep-readonly.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/next-devtools/userspace/pages/pages-dev-overlay-setup.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/render.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/mitt.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/with-router.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/router.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/route-loader.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/page-loader.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/router/router.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/router-context.shared-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/loadable-context.shared-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/loadable.shared-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/image-config-context.shared-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/readonly-url-search-params.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/hooks-client-context.shared-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/head-manager-context.shared-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/app-router-types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/flight-data-helpers.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/router-reducer/ppr-navigations.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/segment-cache/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/segment-cache/navigation.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/segment-cache/cache-key.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/router-reducer/fetch-server-response.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/router-reducer/router-reducer-types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/app-router-context.shared-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/server-inserted-html.shared-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/pages/vendored/contexts/entrypoints.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/pages/module.compiled.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/templates/pages.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/pages/module.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/pages/builtin/_error.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/load-default-error-components.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/base-http/node.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/response-cache/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-definitions/pages-api-route-definition.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-matches/pages-api-route-match.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-matchers/route-matcher.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-matcher-providers/route-matcher-provider.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-matcher-managers/route-matcher-manager.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/normalizers/normalizer.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/normalizers/locale-route-normalizer.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/normalizers/request/pathname-normalizer.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/normalizers/request/suffix.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/normalizers/request/rsc.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/normalizers/request/next-data.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/normalizers/request/segment-prefix-rsc.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/static-paths/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/base-server.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/async-callback-set.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/router/utils/route-regex.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/router/utils/route-matcher.d.ts","./node_modules/.pnpm/sharp@0.34.4/node_modules/sharp/lib/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/image-optimizer.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/next-server.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/lru-cache.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/dev-bundler-service.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/use-cache/cache-life.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/dev/static-paths-worker.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/dev/next-dev-server.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/next.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/render-server.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/router-server.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/router/utils/path-match.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/router-utils/filesystem.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/router-utils/setup-dev-bundler.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/router-utils/router-server-context.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/route-module.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/load-components.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/adapter.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack/loaders/metadata/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/webpack/loaders/next-app-loader/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/app-dir-module.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/adapters/request-cookies.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/async-storage/draft-mode-provider.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/adapters/headers.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/cache-signal.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/dynamic-rendering.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/request/fallback-params.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/work-unit-async-storage-instance.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/lazy-result.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/implicit-tags.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/staged-rendering.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/work-unit-async-storage.external.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/router/utils/parse-relative-url.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/app-render.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/app-page/vendored/contexts/entrypoints.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/error-boundary.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/layout-router.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/render-from-template-context.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/action-async-storage-instance.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/action-async-storage.external.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/client-page.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/client-segment.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/request/search-params.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/hooks-server-context.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/http-access-fallback/error-boundary.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/types/alternative-urls-types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/types/extra-types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/types/metadata-types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/types/manifest-types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/types/opengraph-types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/types/twitter-types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/types/metadata-interface.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/types/resolvers.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/types/icons.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/resolve-metadata.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/metadata/metadata.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/lib/framework/boundary-components.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/rsc/preloads.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/rsc/postpone.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/rsc/taint.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/segment-cache/segment-value-encoding.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/collect-segment-data.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/next-devtools/userspace/app/segment-explorer-node.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/entry-base.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/templates/app-page.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/rendering-mode.d.ts","./node_modules/.pnpm/@types+react@19.2.2/node_modules/@types/react/jsx-dev-runtime.d.ts","./node_modules/.pnpm/@types+react@19.2.2/node_modules/@types/react/compiler-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/entrypoints.d.ts","./node_modules/.pnpm/@types+react-dom@19.2.2_@types+react@19.2.2/node_modules/@types/react-dom/client.d.ts","./node_modules/.pnpm/@types+react-dom@19.2.2_@types+react@19.2.2/node_modules/@types/react-dom/static.d.ts","./node_modules/.pnpm/@types+react-dom@19.2.2_@types+react@19.2.2/node_modules/@types/react-dom/server.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/app-page/vendored/ssr/entrypoints.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/app-page/module.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/app-page/module.compiled.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-definitions/app-route-route-definition.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/async-storage/work-store.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/http.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/app-route/shared-modules.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/redirect-status-code.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/redirect-error.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/templates/app-route.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/app-route/module.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-modules/app-route/module.compiled.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/segment-config/app/app-segments.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/utils.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/router-utils/build-prefetch-segment-data-route.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/turborepo-access-trace/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/turborepo-access-trace/result.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/turborepo-access-trace/helpers.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/turborepo-access-trace/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/export/routes/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/export/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/export/worker.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/worker.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/lib/incremental-cache/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/after/after.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/after/after-context.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/work-async-storage-instance.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/create-error-handler.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/action-revalidation-kind.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/app-render/work-async-storage.external.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/request/params.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/route-matches/route-match.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/request-meta.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/cli/next-test.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/config-shared.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/base-http/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/api-utils/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/build/adapter/build-complete.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/html-context.shared-runtime.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/utils.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/pages/_app.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/app.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/unstable-cache.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/revalidate.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/unstable-no-store.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/use-cache/cache-tag.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/cache.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/pages/_document.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/document.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/dynamic.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dynamic.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/pages/_error.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/error.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/head.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/head.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/request/cookies.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/request/headers.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/request/draft-mode.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/headers.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/get-img-props.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/image-component.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/shared/lib/image-external.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/image.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/link.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/link.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/unrecognized-action-error.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/redirect.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/not-found.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/forbidden.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/unauthorized.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/unstable-rethrow.server.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/unstable-rethrow.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/navigation.react-server.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/components/navigation.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/navigation.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/router.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/client/script.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/script.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/user-agent.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/@edge-runtime/primitives/url.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/web/spec-extension/image-response.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/@vercel/og/satori/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/@vercel/og/emoji/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/@vercel/og/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/after/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/server/request/connection.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/server.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/types/global.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/types/compiled.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/image-types/global.d.ts","./.next/types/routes.d.ts","./next-env.d.ts","./node_modules/.pnpm/@supabase+functions-js@2.75.0/node_modules/@supabase/functions-js/dist/module/types.d.ts","./node_modules/.pnpm/@supabase+functions-js@2.75.0/node_modules/@supabase/functions-js/dist/module/functionsclient.d.ts","./node_modules/.pnpm/@supabase+functions-js@2.75.0/node_modules/@supabase/functions-js/dist/module/index.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/postgresterror.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/types/common/common.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/select-query-parser/types.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/select-query-parser/parser.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/select-query-parser/utils.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/types/types.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/postgrestbuilder.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/select-query-parser/result.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/postgresttransformbuilder.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/postgrestfilterbuilder.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/postgrestquerybuilder.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/types/common/rpc.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/postgrestclient.d.ts","./node_modules/.pnpm/@supabase+postgrest-js@2.75.0/node_modules/@supabase/postgrest-js/dist/cjs/index.d.ts","./node_modules/.pnpm/@supabase+realtime-js@2.75.0/node_modules/@supabase/realtime-js/dist/module/lib/websocket-factory.d.ts","./node_modules/.pnpm/@supabase+realtime-js@2.75.0/node_modules/@supabase/realtime-js/dist/module/lib/constants.d.ts","./node_modules/.pnpm/@supabase+realtime-js@2.75.0/node_modules/@supabase/realtime-js/dist/module/lib/serializer.d.ts","./node_modules/.pnpm/@supabase+realtime-js@2.75.0/node_modules/@supabase/realtime-js/dist/module/lib/timer.d.ts","./node_modules/.pnpm/@supabase+realtime-js@2.75.0/node_modules/@supabase/realtime-js/dist/module/lib/push.d.ts","./node_modules/.pnpm/@types+phoenix@1.6.6/node_modules/@types/phoenix/index.d.ts","./node_modules/.pnpm/@supabase+realtime-js@2.75.0/node_modules/@supabase/realtime-js/dist/module/realtimepresence.d.ts","./node_modules/.pnpm/@supabase+realtime-js@2.75.0/node_modules/@supabase/realtime-js/dist/module/realtimechannel.d.ts","./node_modules/.pnpm/@supabase+realtime-js@2.75.0/node_modules/@supabase/realtime-js/dist/module/realtimeclient.d.ts","./node_modules/.pnpm/@supabase+realtime-js@2.75.0/node_modules/@supabase/realtime-js/dist/module/index.d.ts","./node_modules/.pnpm/@supabase+storage-js@2.75.0/node_modules/@supabase/storage-js/dist/module/lib/errors.d.ts","./node_modules/.pnpm/@supabase+storage-js@2.75.0/node_modules/@supabase/storage-js/dist/module/lib/types.d.ts","./node_modules/.pnpm/@supabase+storage-js@2.75.0/node_modules/@supabase/storage-js/dist/module/lib/fetch.d.ts","./node_modules/.pnpm/@supabase+storage-js@2.75.0/node_modules/@supabase/storage-js/dist/module/packages/streamdownloadbuilder.d.ts","./node_modules/.pnpm/@supabase+storage-js@2.75.0/node_modules/@supabase/storage-js/dist/module/packages/blobdownloadbuilder.d.ts","./node_modules/.pnpm/@supabase+storage-js@2.75.0/node_modules/@supabase/storage-js/dist/module/packages/storagefileapi.d.ts","./node_modules/.pnpm/@supabase+storage-js@2.75.0/node_modules/@supabase/storage-js/dist/module/packages/storagebucketapi.d.ts","./node_modules/.pnpm/@supabase+storage-js@2.75.0/node_modules/@supabase/storage-js/dist/module/storageclient.d.ts","./node_modules/.pnpm/@supabase+storage-js@2.75.0/node_modules/@supabase/storage-js/dist/module/index.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/error-codes.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/errors.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/web3/ethereum.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/web3/solana.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/webauthn.dom.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/helpers.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/gotrueclient.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/webauthn.errors.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/webauthn.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/types.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/fetch.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/gotrueadminapi.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/authadminapi.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/authclient.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/lib/locks.d.ts","./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/index.d.ts","./node_modules/.pnpm/@supabase+supabase-js@2.75.0/node_modules/@supabase/supabase-js/dist/module/lib/rest/types/common/common.d.ts","./node_modules/.pnpm/@supabase+supabase-js@2.75.0/node_modules/@supabase/supabase-js/dist/module/lib/types.d.ts","./node_modules/.pnpm/@supabase+supabase-js@2.75.0/node_modules/@supabase/supabase-js/dist/module/lib/supabaseauthclient.d.ts","./node_modules/.pnpm/@supabase+supabase-js@2.75.0/node_modules/@supabase/supabase-js/dist/module/lib/rest/types/common/rpc.d.ts","./node_modules/.pnpm/@supabase+supabase-js@2.75.0/node_modules/@supabase/supabase-js/dist/module/supabaseclient.d.ts","./node_modules/.pnpm/@supabase+supabase-js@2.75.0/node_modules/@supabase/supabase-js/dist/module/index.d.ts","./node_modules/.pnpm/@supabase+ssr@0.4.1_@supabase+supabase-js@2.75.0/node_modules/@supabase/ssr/dist/main/types.d.ts","./node_modules/.pnpm/@supabase+ssr@0.4.1_@supabase+supabase-js@2.75.0/node_modules/@supabase/ssr/dist/main/createbrowserclient.d.ts","./node_modules/.pnpm/@supabase+ssr@0.4.1_@supabase+supabase-js@2.75.0/node_modules/@supabase/ssr/dist/main/createserverclient.d.ts","./node_modules/.pnpm/@supabase+ssr@0.4.1_@supabase+supabase-js@2.75.0/node_modules/@supabase/ssr/dist/main/utils/helpers.d.ts","./node_modules/.pnpm/@supabase+ssr@0.4.1_@supabase+supabase-js@2.75.0/node_modules/@supabase/ssr/dist/main/utils/constants.d.ts","./node_modules/.pnpm/@supabase+ssr@0.4.1_@supabase+supabase-js@2.75.0/node_modules/@supabase/ssr/dist/main/utils/chunker.d.ts","./node_modules/.pnpm/@supabase+ssr@0.4.1_@supabase+supabase-js@2.75.0/node_modules/@supabase/ssr/dist/main/utils/base64url.d.ts","./node_modules/.pnpm/@supabase+ssr@0.4.1_@supabase+supabase-js@2.75.0/node_modules/@supabase/ssr/dist/main/utils/index.d.ts","./node_modules/.pnpm/@supabase+ssr@0.4.1_@supabase+supabase-js@2.75.0/node_modules/@supabase/ssr/dist/main/index.d.ts","./src/lib/access-control.ts","./src/lib/telemetry.ts","./middleware.ts","./next.config.ts","./node_modules/.pnpm/@types+estree@1.0.8/node_modules/@types/estree/index.d.ts","./node_modules/.pnpm/rollup@4.57.1/node_modules/rollup/dist/rollup.d.ts","./node_modules/.pnpm/rollup@4.57.1/node_modules/rollup/dist/parseast.d.ts","./node_modules/.pnpm/vite@5.4.21_@types+node@20.19.21/node_modules/vite/types/hmrpayload.d.ts","./node_modules/.pnpm/vite@5.4.21_@types+node@20.19.21/node_modules/vite/types/customevent.d.ts","./node_modules/.pnpm/vite@5.4.21_@types+node@20.19.21/node_modules/vite/types/hot.d.ts","./node_modules/.pnpm/vite@5.4.21_@types+node@20.19.21/node_modules/vite/dist/node/types.d-agj9qkwt.d.ts","./node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.d.ts","./node_modules/.pnpm/source-map-js@1.2.1/node_modules/source-map-js/source-map.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/previous-map.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/input.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/css-syntax-error.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/declaration.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/root.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/warning.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/lazy-result.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/no-work-result.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/processor.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/result.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/document.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/rule.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/node.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/comment.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/container.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/at-rule.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/list.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/postcss.d.ts","./node_modules/.pnpm/postcss@8.5.6/node_modules/postcss/lib/postcss.d.mts","./node_modules/.pnpm/vite@5.4.21_@types+node@20.19.21/node_modules/vite/dist/node/runtime.d.ts","./node_modules/.pnpm/vite@5.4.21_@types+node@20.19.21/node_modules/vite/types/importglob.d.ts","./node_modules/.pnpm/vite@5.4.21_@types+node@20.19.21/node_modules/vite/types/metadata.d.ts","./node_modules/.pnpm/vite@5.4.21_@types+node@20.19.21/node_modules/vite/dist/node/index.d.ts","./node_modules/.pnpm/@vitest+utils@1.6.1/node_modules/@vitest/utils/dist/types.d.ts","./node_modules/.pnpm/@vitest+utils@1.6.1/node_modules/@vitest/utils/dist/helpers.d.ts","./node_modules/.pnpm/@sinclair+typebox@0.27.8/node_modules/@sinclair/typebox/typebox.d.ts","./node_modules/.pnpm/@jest+schemas@29.6.3/node_modules/@jest/schemas/build/index.d.ts","./node_modules/.pnpm/pretty-format@29.7.0/node_modules/pretty-format/build/index.d.ts","./node_modules/.pnpm/@vitest+utils@1.6.1/node_modules/@vitest/utils/dist/index.d.ts","./node_modules/.pnpm/@vitest+runner@1.6.1/node_modules/@vitest/runner/dist/tasks-k5xerdtv.d.ts","./node_modules/.pnpm/@vitest+utils@1.6.1/node_modules/@vitest/utils/dist/types-9l4nily8.d.ts","./node_modules/.pnpm/@vitest+utils@1.6.1/node_modules/@vitest/utils/dist/diff.d.ts","./node_modules/.pnpm/@vitest+runner@1.6.1/node_modules/@vitest/runner/dist/types.d.ts","./node_modules/.pnpm/@vitest+utils@1.6.1/node_modules/@vitest/utils/dist/error.d.ts","./node_modules/.pnpm/@vitest+runner@1.6.1/node_modules/@vitest/runner/dist/index.d.ts","./node_modules/.pnpm/vite-node@1.6.1_@types+node@20.19.21/node_modules/vite-node/dist/trace-mapping.d-xyifztpm.d.ts","./node_modules/.pnpm/vite-node@1.6.1_@types+node@20.19.21/node_modules/vite-node/dist/index-o2irwhkf.d.ts","./node_modules/.pnpm/vite-node@1.6.1_@types+node@20.19.21/node_modules/vite-node/dist/index.d.ts","./node_modules/.pnpm/@vitest+snapshot@1.6.1/node_modules/@vitest/snapshot/dist/environment-cmigivxz.d.ts","./node_modules/.pnpm/@vitest+snapshot@1.6.1/node_modules/@vitest/snapshot/dist/index-s94asl6q.d.ts","./node_modules/.pnpm/@vitest+snapshot@1.6.1/node_modules/@vitest/snapshot/dist/index.d.ts","./node_modules/.pnpm/@vitest+expect@1.6.1/node_modules/@vitest/expect/dist/chai.d.cts","./node_modules/.pnpm/@vitest+expect@1.6.1/node_modules/@vitest/expect/dist/index.d.ts","./node_modules/.pnpm/@vitest+expect@1.6.1/node_modules/@vitest/expect/index.d.ts","./node_modules/.pnpm/@vitest+runner@1.6.1/node_modules/@vitest/runner/dist/utils.d.ts","./node_modules/.pnpm/tinybench@2.9.0/node_modules/tinybench/dist/index.d.ts","./node_modules/.pnpm/vite-node@1.6.1_@types+node@20.19.21/node_modules/vite-node/dist/client.d.ts","./node_modules/.pnpm/@vitest+snapshot@1.6.1/node_modules/@vitest/snapshot/dist/manager.d.ts","./node_modules/.pnpm/vite-node@1.6.1_@types+node@20.19.21/node_modules/vite-node/dist/server.d.ts","./node_modules/.pnpm/vitest@1.6.1_@types+node@20.19.21/node_modules/vitest/dist/reporters-w_64as5f.d.ts","./node_modules/.pnpm/vitest@1.6.1_@types+node@20.19.21/node_modules/vitest/dist/config.d.ts","./node_modules/.pnpm/vitest@1.6.1_@types+node@20.19.21/node_modules/vitest/config.d.ts","./vitest.config.ts","./src/app/admin/access-control/actions.ts","./src/app/admin/bug-reports/actions.ts","./src/app/admin/papers/actions.ts","./src/types/exam.ts","./src/app/admin/papers/[paperid]/edit/actions.ts","./src/app/admin/questions/actions.ts","./src/app/api/_utils/validation.ts","./src/lib/supabase/service-role.ts","./src/lib/analysis/validateaianalysisexport.ts","./src/lib/analysis/generatecompositecontextpacket.ts","./src/app/api/admin/ai-analysis/[attemptid]/export/route.ts","./src/app/api/admin/papers/[paperid]/export/route.ts","./src/lib/supabase/server.ts","./src/lib/logger.ts","./src/app/api/admin/papers/import/route.ts","./src/app/api/admin/question-sets/route.ts","./src/app/api/attempt-status/route.ts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/json-schema.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/standard-schema.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/registries.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/to-json-schema.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/util.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/versions.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/schemas.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/checks.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/errors.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/core.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/parse.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/regexes.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ar.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/az.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/be.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/bg.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ca.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/cs.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/da.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/de.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/en.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/eo.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/es.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/fa.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/fi.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/fr.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/fr-ca.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/he.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/hu.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/hy.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/id.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/is.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/it.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ja.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ka.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/kh.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/km.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ko.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/lt.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/mk.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ms.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/nl.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/no.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ota.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ps.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/pl.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/pt.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ru.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/sl.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/sv.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ta.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/th.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/tr.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ua.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/uk.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/ur.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/uz.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/vi.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/zh-cn.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/zh-tw.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/yo.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/locales/index.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/doc.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/api.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/json-schema-processors.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/json-schema-generator.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/core/index.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/classic/errors.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/classic/parse.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/classic/schemas.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/classic/checks.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/classic/compat.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/classic/from-json-schema.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/classic/iso.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/classic/coerce.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/v4/classic/external.d.cts","./node_modules/.pnpm/zod@4.3.5/node_modules/zod/index.d.cts","./src/features/exam-engine/lib/validation.ts","./src/features/exam-engine/lib/scoring.ts","./src/features/exam-engine/lib/actions.ts","./src/app/api/pause/route.ts","./src/app/api/progress/route.ts","./src/lib/rate-limit.ts","./src/app/api/save/route.ts","./src/app/api/save-batch/route.ts","./src/app/api/session/route.ts","./src/app/api/submit/route.ts","./src/app/auth/callback/route.ts","./src/app/auth/logout/route.ts","./src/components/usefocustrap.ts","./src/lib/cloudinary.ts","./node_modules/.pnpm/@types+unist@3.0.3/node_modules/@types/unist/index.d.ts","./node_modules/.pnpm/@types+hast@3.0.4/node_modules/@types/hast/index.d.ts","./node_modules/.pnpm/vfile-message@4.0.3/node_modules/vfile-message/lib/index.d.ts","./node_modules/.pnpm/vfile-message@4.0.3/node_modules/vfile-message/index.d.ts","./node_modules/.pnpm/vfile@6.0.3/node_modules/vfile/lib/index.d.ts","./node_modules/.pnpm/vfile@6.0.3/node_modules/vfile/index.d.ts","./node_modules/.pnpm/unified@11.0.5/node_modules/unified/lib/callable-instance.d.ts","./node_modules/.pnpm/trough@2.2.0/node_modules/trough/lib/index.d.ts","./node_modules/.pnpm/trough@2.2.0/node_modules/trough/index.d.ts","./node_modules/.pnpm/unified@11.0.5/node_modules/unified/lib/index.d.ts","./node_modules/.pnpm/unified@11.0.5/node_modules/unified/index.d.ts","./node_modules/.pnpm/@types+mdast@4.0.4/node_modules/@types/mdast/index.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/state.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/footer.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/blockquote.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/break.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/code.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/delete.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/emphasis.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/footnote-reference.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/heading.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/html.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/image-reference.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/image.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/inline-code.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/link-reference.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/link.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/list-item.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/list.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/paragraph.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/root.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/strong.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/table.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/table-cell.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/table-row.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/text.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/thematic-break.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/handlers/index.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/lib/index.d.ts","./node_modules/.pnpm/mdast-util-to-hast@13.2.1/node_modules/mdast-util-to-hast/index.d.ts","./node_modules/.pnpm/remark-rehype@11.1.2/node_modules/remark-rehype/lib/index.d.ts","./node_modules/.pnpm/remark-rehype@11.1.2/node_modules/remark-rehype/index.d.ts","./node_modules/.pnpm/react-markdown@10.1.0_@types+react@19.2.2_react@19.1.0/node_modules/react-markdown/lib/index.d.ts","./node_modules/.pnpm/react-markdown@10.1.0_@types+react@19.2.2_react@19.1.0/node_modules/react-markdown/index.d.ts","./node_modules/.pnpm/micromark-util-types@2.0.2/node_modules/micromark-util-types/index.d.ts","./node_modules/.pnpm/micromark-extension-gfm-footnote@2.1.0/node_modules/micromark-extension-gfm-footnote/lib/html.d.ts","./node_modules/.pnpm/micromark-extension-gfm-footnote@2.1.0/node_modules/micromark-extension-gfm-footnote/lib/syntax.d.ts","./node_modules/.pnpm/micromark-extension-gfm-footnote@2.1.0/node_modules/micromark-extension-gfm-footnote/index.d.ts","./node_modules/.pnpm/micromark-extension-gfm-strikethrough@2.1.0/node_modules/micromark-extension-gfm-strikethrough/lib/html.d.ts","./node_modules/.pnpm/micromark-extension-gfm-strikethrough@2.1.0/node_modules/micromark-extension-gfm-strikethrough/lib/syntax.d.ts","./node_modules/.pnpm/micromark-extension-gfm-strikethrough@2.1.0/node_modules/micromark-extension-gfm-strikethrough/index.d.ts","./node_modules/.pnpm/micromark-extension-gfm@3.0.0/node_modules/micromark-extension-gfm/index.d.ts","./node_modules/.pnpm/mdast-util-from-markdown@2.0.2/node_modules/mdast-util-from-markdown/lib/types.d.ts","./node_modules/.pnpm/mdast-util-from-markdown@2.0.2/node_modules/mdast-util-from-markdown/lib/index.d.ts","./node_modules/.pnpm/mdast-util-from-markdown@2.0.2/node_modules/mdast-util-from-markdown/index.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/types.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/index.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/blockquote.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/break.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/code.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/definition.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/emphasis.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/heading.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/html.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/image.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/image-reference.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/inline-code.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/link.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/link-reference.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/list.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/list-item.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/paragraph.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/root.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/strong.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/text.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/thematic-break.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/lib/handle/index.d.ts","./node_modules/.pnpm/mdast-util-to-markdown@2.1.2/node_modules/mdast-util-to-markdown/index.d.ts","./node_modules/.pnpm/mdast-util-gfm-footnote@2.1.0/node_modules/mdast-util-gfm-footnote/lib/index.d.ts","./node_modules/.pnpm/mdast-util-gfm-footnote@2.1.0/node_modules/mdast-util-gfm-footnote/index.d.ts","./node_modules/.pnpm/markdown-table@3.0.4/node_modules/markdown-table/index.d.ts","./node_modules/.pnpm/mdast-util-gfm-table@2.0.0/node_modules/mdast-util-gfm-table/lib/index.d.ts","./node_modules/.pnpm/mdast-util-gfm-table@2.0.0/node_modules/mdast-util-gfm-table/index.d.ts","./node_modules/.pnpm/mdast-util-gfm@3.1.0/node_modules/mdast-util-gfm/lib/index.d.ts","./node_modules/.pnpm/mdast-util-gfm@3.1.0/node_modules/mdast-util-gfm/index.d.ts","./node_modules/.pnpm/remark-gfm@4.0.1/node_modules/remark-gfm/lib/index.d.ts","./node_modules/.pnpm/remark-gfm@4.0.1/node_modules/remark-gfm/index.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/common/html.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/common/token.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/common/error-codes.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/tokenizer/preprocessor.d.ts","./node_modules/.pnpm/entities@6.0.1/node_modules/entities/dist/esm/generated/decode-data-html.d.ts","./node_modules/.pnpm/entities@6.0.1/node_modules/entities/dist/esm/generated/decode-data-xml.d.ts","./node_modules/.pnpm/entities@6.0.1/node_modules/entities/dist/esm/decode-codepoint.d.ts","./node_modules/.pnpm/entities@6.0.1/node_modules/entities/dist/esm/decode.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/tokenizer/index.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/tree-adapters/interface.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/parser/open-element-stack.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/parser/formatting-element-list.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/parser/index.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/tree-adapters/default.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/serializer/index.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/common/foreign-content.d.ts","./node_modules/.pnpm/parse5@7.3.0/node_modules/parse5/dist/index.d.ts","./node_modules/.pnpm/hast-util-raw@9.1.0/node_modules/hast-util-raw/lib/index.d.ts","./node_modules/.pnpm/hast-util-raw@9.1.0/node_modules/hast-util-raw/index.d.ts","./node_modules/.pnpm/rehype-raw@7.0.0/node_modules/rehype-raw/lib/index.d.ts","./node_modules/.pnpm/rehype-raw@7.0.0/node_modules/rehype-raw/index.d.ts","./src/features/exam-engine/ui/mathtext.tsx","./src/features/admin/ui/markdowntoolbar.tsx","./src/features/admin/config/topicoptions.ts","./src/features/admin/ui/editablequestion.tsx","./src/features/shared/ui/paletteshell.tsx","./src/features/admin/ui/editableexamlayout.tsx","./src/features/admin/ui/questionseteditor.tsx","./src/features/admin/index.ts","./node_modules/.pnpm/zustand@5.0.10_@types+react@19.2.2_react@19.1.0/node_modules/zustand/esm/vanilla.d.mts","./node_modules/.pnpm/zustand@5.0.10_@types+react@19.2.2_react@19.1.0/node_modules/zustand/esm/react.d.mts","./node_modules/.pnpm/zustand@5.0.10_@types+react@19.2.2_react@19.1.0/node_modules/zustand/esm/index.d.mts","./node_modules/.pnpm/zustand@5.0.10_@types+react@19.2.2_react@19.1.0/node_modules/zustand/esm/middleware/redux.d.mts","./node_modules/.pnpm/zustand@5.0.10_@types+react@19.2.2_react@19.1.0/node_modules/zustand/esm/middleware/devtools.d.mts","./node_modules/.pnpm/zustand@5.0.10_@types+react@19.2.2_react@19.1.0/node_modules/zustand/esm/middleware/subscribewithselector.d.mts","./node_modules/.pnpm/zustand@5.0.10_@types+react@19.2.2_react@19.1.0/node_modules/zustand/esm/middleware/combine.d.mts","./node_modules/.pnpm/zustand@5.0.10_@types+react@19.2.2_react@19.1.0/node_modules/zustand/esm/middleware/persist.d.mts","./node_modules/.pnpm/zustand@5.0.10_@types+react@19.2.2_react@19.1.0/node_modules/zustand/esm/middleware/ssrsafe.d.mts","./node_modules/.pnpm/zustand@5.0.10_@types+react@19.2.2_react@19.1.0/node_modules/zustand/esm/middleware.d.mts","./src/lib/examdebug.ts","./src/features/exam-engine/model/useexamstore.ts","./src/features/exam-engine/hooks/useexamtimer.ts","./src/features/exam-engine/ui/questionpalette.tsx","./src/features/exam-engine/ui/examfooter.tsx","./src/features/exam-engine/ui/mcqrenderer.tsx","./src/features/exam-engine/ui/titarenderer.tsx","./src/features/exam-engine/ui/calculator.tsx","./src/features/exam-engine/ui/examlayout.tsx","./src/features/exam-engine/ui/examtimer.tsx","./src/features/exam-engine/ui/questionrenderer.tsx","./src/features/exam-engine/ui/navigationbuttons.tsx","./src/features/exam-engine/ui/resultheader.tsx","./src/features/exam-engine/ui/sectionalperformance.tsx","./src/features/exam-engine/ui/questionanalysis.tsx","./src/features/exam-engine/ui/index.ts","./src/features/exam-engine/index.ts","./src/features/exam-engine/api/client.ts","./src/utils/question-sets.ts","./src/features/exam-engine/lib/assemblepaper.ts","./src/features/exam-engine/lib/index.ts","./node_modules/.pnpm/vitest@1.6.1_@types+node@20.19.21/node_modules/vitest/dist/suite-dwqifb_-.d.ts","./node_modules/.pnpm/@vitest+spy@1.6.1/node_modules/@vitest/spy/dist/index.d.ts","./node_modules/.pnpm/@vitest+snapshot@1.6.1/node_modules/@vitest/snapshot/dist/environment.d.ts","./node_modules/.pnpm/vitest@1.6.1_@types+node@20.19.21/node_modules/vitest/dist/index.d.ts","./src/features/exam-engine/lib/__tests__/scoring.test.ts","./node_modules/.pnpm/fast-uri@3.1.0/node_modules/fast-uri/types/index.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/codegen/code.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/codegen/scope.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/codegen/index.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/rules.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/util.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/validate/subschema.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/errors.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/validate/index.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/validate/datatype.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/additionalitems.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/items2020.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/contains.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/dependencies.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/propertynames.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/additionalproperties.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/not.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/anyof.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/oneof.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/if.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/applicator/index.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/validation/limitnumber.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/validation/multipleof.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/validation/pattern.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/validation/required.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/validation/uniqueitems.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/validation/const.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/validation/enum.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/validation/index.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/format/format.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/unevaluated/unevaluatedproperties.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/unevaluated/unevaluateditems.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/validation/dependentrequired.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/discriminator/types.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/discriminator/index.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/vocabularies/errors.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/types/json-schema.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/types/jtd-schema.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/runtime/validation_error.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/ref_error.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/core.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/resolve.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/compile/index.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/types/index.d.ts","./node_modules/.pnpm/ajv@8.17.1/node_modules/ajv/dist/ajv.d.ts","./node_modules/.pnpm/ajv-formats@2.1.1_ajv@8.17.1/node_modules/ajv-formats/dist/formats.d.ts","./node_modules/.pnpm/ajv-formats@2.1.1_ajv@8.17.1/node_modules/ajv-formats/dist/limit.d.ts","./node_modules/.pnpm/ajv-formats@2.1.1_ajv@8.17.1/node_modules/ajv-formats/dist/index.d.ts","./schemas/paper_schema_v3.json","./src/lib/ajv-validator.ts","./src/lib/devtools.ts","./src/lib/supabase/client.ts","./src/lib/landing-assets.ts","./src/lib/uselandingassets.ts","./src/types/react-katex.d.ts","./src/utils/update-session.ts","./src/components/bugreportfab.tsx","./src/components/authenticatedoverlays.tsx","./src/components/topprogressbar.tsx","./src/app/layout.tsx","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/@next/font/dist/types.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/dist/compiled/@next/font/dist/google/index.d.ts","./node_modules/.pnpm/next@16.1.3_@babel+core@7.28.6_@opentelemetry+api@1.8.0_react-dom@19.1.0_react@19.1.0__react@19.1.0/node_modules/next/font/google/index.d.ts","./src/components/landing/landingpageclient.tsx","./src/app/page.tsx","./node_modules/.pnpm/jwt-decode@4.0.0/node_modules/jwt-decode/build/esm/index.d.ts","./src/app/admin/layout.tsx","./src/app/admin/page.tsx","./src/app/admin/access-control/page.tsx","./src/app/admin/ai-analysis/downloadexportbutton.tsx","./src/app/admin/ai-analysis/page.tsx","./src/app/admin/bug-reports/bugreportstatusselect.tsx","./src/app/admin/bug-reports/page.tsx","./src/app/admin/contexts/page.tsx","./src/app/admin/contexts/new/page.tsx","./src/app/admin/landing-page/landingassetsclient.tsx","./src/app/admin/landing-page/page.tsx","./src/app/admin/papers/importpaperbutton.tsx","./src/app/admin/papers/paperactions.tsx","./src/app/admin/papers/page.tsx","./src/app/admin/papers/[paperid]/edit/exameditorclient.tsx","./src/app/admin/papers/[paperid]/edit/page.tsx","./src/app/admin/papers/[paperid]/preview/previewclient.tsx","./src/app/admin/papers/[paperid]/preview/page.tsx","./src/app/admin/questions/questionrowactions.tsx","./src/app/admin/papers/[paperid]/questions/page.tsx","./src/app/admin/papers/[paperid]/settings/page.tsx","./src/app/admin/papers/new/page.tsx","./src/app/admin/question-sets/page.tsx","./src/app/admin/question-sets/new/newquestionsetclient.tsx","./src/app/admin/question-sets/new/page.tsx","./src/app/admin/questions/page.tsx","./src/app/admin/questions/new/page.tsx","./src/app/auth/sign-in/page.tsx","./src/app/auth/test-login/page.tsx","./src/app/coming-soon/page.tsx","./src/app/dashboard/page.tsx","./src/features/exam-engine/ui/devtoolspanel.tsx","./src/app/exam/[attemptid]/examclient.tsx","./src/features/exam-engine/lib/examclient.tsx","./src/components/backtodashboard.tsx","./src/app/exam/[attemptid]/page.tsx","./src/app/mock/[paperid]/page.tsx","./src/app/mocks/page.tsx","./src/app/result/[attemptid]/aianalysisbutton.tsx","./src/app/result/[attemptid]/resultreviewclient.tsx","./src/app/result/[attemptid]/resulttabsclient.tsx","./src/app/result/[attemptid]/page.tsx","./.next/types/validator.ts","./.next/dev/types/cache-life.d.ts","./.next/dev/types/routes.d.ts","./.next/dev/types/validator.ts"],"fileIdsList":[[97,144,460,461,462,463],[97,144],[97,144,270,504,507,655,656,659,660,661,742,743,745,746,747,748,749,750,964,969,971,972,973,975,977,978,979,981,984,986,988,990,991,992,993,995,996,997,998,999,1000,1001,1006,1007,1008,1012,1015],[97,144,270,504,507,510,656,659,660,661,742,743,745,746,747,748,749,750,964,969,971,972,973,977,978,979,981,984,986,988,990,991,992,993,995,996,997,998,999,1000,1001,1006,1007,1008,1012],[97,144,270,504,578,579,580],[97,144,508,509,510],[97,144,270,508],[97,144,617],[97,144,559],[97,144,554],[97,144,549,557,558],[97,144,549,553,557,558,559],[97,144,549,554,557,559,560,561,562],[97,144,548,557],[97,144,557],[97,144,552,557],[97,144,549,550,551,552,556,558],[97,144,549,552,554,555,557],[97,144,512],[97,144,512,513],[97,144,515,516,520,521,522,523,524,525,527],[97,144,516,517,520],[97,144,516,524,525,526],[97,144,516,519,523],[97,144,516,522,524],[97,144,516,520,521,522,524],[97,144,519,520],[97,144,517,518,519],[97,144,516,520],[97,144,517,518],[97,144,516],[97,144,515,516,517,519],[97,144,529,535,536,537],[97,144,536],[97,144,530,532,533,535,537],[97,144,529,530,531,532,536],[97,144,534,536],[97,144,565,569,570],[97,144,570,571,572,577],[97,144,570],[97,144,573,574,575,576],[97,144,539,540,546],[97,144,540],[97,144,539],[97,144,540,542],[97,144,539,540,541,546],[97,144,539,540,541,543],[97,144,541,544,545],[97,144,514,528,538,563,565,568],[97,144,564],[97,144,563,565],[97,144,528,538,547,563,564],[97,144,514,528,538,547,565,566,567],[97,144,753],[97,141,144],[97,143,144],[144],[97,144,149,177],[97,144,145,150,155,163,174,185],[97,144,145,146,155,163],[92,93,94,97,144],[97,144,147,186],[97,144,148,149,156,164],[97,144,149,174,182],[97,144,150,152,155,163],[97,143,144,151],[97,144,152,153],[97,144,154,155],[97,143,144,155],[97,144,155,156,157,174,185],[97,144,155,156,157,170,174,177],[97,144,152,155,158,163,174,185],[97,144,155,156,158,159,163,174,182,185],[97,144,158,160,174,182,185],[95,96,97,98,99,100,101,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191],[97,144,155,161],[97,144,162,185,190],[97,144,152,155,163,174],[97,144,164],[97,144,165],[97,143,144,166],[97,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191],[97,144,168],[97,144,169],[97,144,155,170,171],[97,144,170,172,186,188],[97,144,155,174,175,177],[97,144,176,177],[97,144,174,175],[97,144,177],[97,144,178],[97,141,144,174,179],[97,144,155,180,181],[97,144,180,181],[97,144,149,163,174,182],[97,144,183],[97,144,163,184],[97,144,158,169,185],[97,144,149,186],[97,144,174,187],[97,144,162,188],[97,144,189],[97,139,144],[97,139,144,155,157,166,174,177,185,188,190],[97,144,174,191],[85,89,97,144,193,194,195,197,455,501],[85,97,144],[85,89,97,144,193,194,195,196,413,455,501],[85,89,97,144,193,194,196,197,455,501],[85,97,144,197,413,414],[85,97,144,197,413],[85,89,97,144,194,195,196,197,455,501],[85,89,97,144,193,195,196,197,455,501],[83,84,97,144],[97,144,620,623],[97,144,634],[97,144,620,621,623,624,625],[97,144,620],[97,144,620,621,623],[97,144,620,621],[97,144,630],[97,144,619,630],[97,144,619,630,631],[97,144,619,622],[97,144,615],[97,144,615,616,619],[97,144,619],[97,144,949],[97,144,949,950,951],[97,144,908,909,913,940,941,943,944,945,947,948],[97,144,906,907],[97,144,906],[97,144,908,948],[97,144,908,909,945,946,948],[97,144,948],[97,144,905,948,949],[97,144,908,909,947,948],[97,144,908,909,911,912,947,948],[97,144,908,909,910,947,948],[97,144,908,909,913,940,941,942,943,944,947,948],[97,144,905,908,909,913,945,947],[97,144,913,948],[97,144,915,916,917,918,919,920,921,922,923,924,948],[97,144,938,948],[97,144,914,925,933,934,935,936,937,939],[97,144,918,948],[97,144,926,927,928,929,930,931,932,948],[97,144,844,845,846],[97,144,758,857],[97,144,754,792,856,858],[97,144,797,800,803,805,806,807],[97,144,764,792,797,800,803,805,807],[97,144,764,792,797,800,803,807],[97,144,830,831,835],[97,144,807,830,832,835],[97,144,807,830,832,834],[97,144,764,792,807,830,832,833,835],[97,144,832,835,836],[97,144,807,830,832,835,837],[97,144,754,764,765,766,790,791,792],[97,144,754,765,792],[97,144,754,764,765,792],[97,144,767,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789],[97,144,754,758,764,766,792],[97,144,808,809,829],[97,144,764,792,830,832,835],[97,144,764,792],[97,144,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828],[97,144,753,764,792],[97,144,797,798,799,803,807],[97,144,797,800,803,807],[97,144,797,800,801,802,807],[97,144,458],[97,144,202,204,208,219,409,439,451],[97,144,204,214,215,216,218,451],[97,144,204,251,253,255,256,259,451,453],[97,144,204,208,210,211,212,242,337,409,429,430,438,451,453],[97,144,451],[97,144,215,307,418,427,447],[97,144,204],[97,144,198,307,447],[97,144,261],[97,144,260,451],[97,144,158,407,418,506],[97,144,158,375,387,427,446],[97,144,158,318],[97,144,432],[97,144,431,432,433],[97,144,431],[91,97,144,158,198,204,208,211,213,215,219,220,233,234,261,337,348,428,439,451,455],[97,144,202,204,217,251,252,257,258,451,506],[97,144,217,506],[97,144,202,234,362,451,506],[97,144,506],[97,144,204,217,218,506],[97,144,254,506],[97,144,220,429,437],[97,144,169,270,447],[97,144,270,447],[85,97,144,270],[85,97,144,379],[97,144,305,315,316,447,483,490],[97,144,304,424,484,485,486,487,489],[97,144,423],[97,144,423,424],[97,144,242,307,308,312],[97,144,307],[97,144,307,311,313],[97,144,307,308,309,310],[97,144,488],[85,97,144,205,477],[85,97,144,185],[85,97,144,217,297],[85,97,144,217,439],[97,144,295,299],[85,97,144,296,457],[97,144,965],[85,89,97,144,158,192,193,194,195,196,197,455,499,500],[97,144,158],[97,144,158,208,241,293,338,359,361,434,435,439,451,452],[97,144,233,436],[97,144,455],[97,144,203],[85,97,144,364,377,386,396,398,446],[97,144,169,364,377,395,396,397,446,505],[97,144,389,390,391,392,393,394],[97,144,391],[97,144,395],[97,144,268,269,270,272],[85,97,144,262,263,264,265,271],[97,144,268,271],[97,144,266],[97,144,267],[85,97,144,270,296,457],[85,97,144,270,456,457],[85,97,144,270,457],[97,144,338,441],[97,144,441],[97,144,158,452,457],[97,144,383],[97,143,144,382],[97,144,243,307,324,361,370,373,375,376,417,446,449,452],[97,144,289,307,404],[97,144,375,446],[85,97,144,375,380,381,383,384,385,386,387,388,399,400,401,402,403,405,406,446,447,506],[97,144,369],[97,144,158,169,205,241,244,265,290,291,338,348,359,360,417,440,451,452,453,455,506],[97,144,446],[97,143,144,215,291,348,372,440,442,443,444,445,452],[97,144,375],[97,143,144,241,278,324,365,366,367,368,369,370,371,373,374,446,447],[97,144,158,278,279,365,452,453],[97,144,215,338,348,361,440,446,452],[97,144,158,451,453],[97,144,158,174,449,452,453],[97,144,158,169,185,198,208,217,243,244,246,275,280,285,289,290,291,293,322,324,326,329,331,334,335,336,337,359,361,439,440,447,449,451,452,453],[97,144,158,174],[97,144,204,205,206,213,449,450,455,457,506],[97,144,202,451],[97,144,274],[97,144,158,174,185,236,259,261,262,263,264,265,272,273,506],[97,144,169,185,198,236,251,284,285,286,322,323,324,329,337,338,344,347,349,359,361,440,447,449,451],[97,144,213,220,233,337,348,440,451],[97,144,158,185,205,208,324,342,449,451],[97,144,363],[97,144,158,274,345,346,356],[97,144,449,451],[97,144,370,372],[97,144,291,324,439,457],[97,144,158,169,247,251,323,329,344,347,351,449],[97,144,158,220,233,251,352],[97,144,204,246,354,439,451],[97,144,158,185,265,451],[97,144,158,217,245,246,247,256,274,353,355,439,451],[91,97,144,158,291,358,455,457],[97,144,321,359],[97,144,158,169,185,208,219,220,233,243,244,280,284,285,286,290,322,323,324,326,338,339,341,343,359,361,439,440,447,448,449,457],[97,144,158,174,220,344,350,356,449],[97,144,223,224,225,226,227,228,229,230,231,232],[97,144,275,330],[97,144,332],[97,144,330],[97,144,332,333],[97,144,158,208,211,241,242,452],[97,144,158,169,203,205,243,289,290,291,292,320,359,449,453,455,457],[97,144,158,169,185,207,242,292,324,370,440,448,452],[97,144,365],[97,144,366],[97,144,307,337,417],[97,144,367],[97,144,235,239],[97,144,158,208,235,243],[97,144,238,239],[97,144,240],[97,144,235,236],[97,144,235,287],[97,144,235],[97,144,275,328,448],[97,144,327],[97,144,236,447,448],[97,144,325,448],[97,144,236,447],[97,144,417],[97,144,208,237,243,291,307,324,358,361,364,370,377,378,408,409,412,416,439,449,452],[97,144,300,303,305,306,315,316],[85,97,144,195,197,270,410,411],[85,97,144,195,197,270,410,411,415],[97,144,426],[97,144,215,279,291,358,361,375,383,387,419,420,421,422,424,425,428,439,446,451],[97,144,315],[97,144,158,320],[97,144,320],[97,144,158,243,288,293,317,319,358,449,455,457],[97,144,300,301,302,303,305,306,315,316,456],[91,97,144,158,169,185,235,236,244,290,291,324,356,357,359,439,440,449,451,452,455],[97,144,279,281,284,440],[97,144,158,275,451],[97,144,278,375],[97,144,277],[97,144,279,280],[97,144,276,278,451],[97,144,158,207,279,281,282,283,451,452],[85,97,144,307,314,447],[97,144,200,201],[85,97,144,205],[85,97,144,304,447],[85,91,97,144,290,291,455,457],[97,144,205,477,478],[85,97,144,299],[85,97,144,169,185,203,258,294,296,298,457],[97,144,217,447,452],[97,144,340,447],[85,97,144,156,158,169,202,203,253,299,455,456],[85,97,144,193,194,195,196,197,455,501],[85,86,87,88,89,97,144],[97,144,149],[97,144,248,249,250],[97,144,248],[85,89,97,144,158,160,169,192,193,194,195,196,197,198,203,244,351,395,453,454,457,501],[97,144,465],[97,144,467],[97,144,469],[97,144,966],[97,144,471],[97,144,473,474,475],[97,144,479],[90,97,144,459,464,466,468,470,472,476,480,482,492,493,495,504,505,506,507],[97,144,481],[97,144,491],[97,144,296],[97,144,494],[97,143,144,279,281,282,284,496,497,498,501,502,503],[97,144,192],[97,144,841],[97,144,840,841],[97,144,840],[97,144,840,841,842,848,849,852,853,854,855],[97,144,841,849],[97,144,840,841,842,848,849,850,851],[97,144,840,849],[97,144,849,853],[97,144,841,842,843,847],[97,144,842],[97,144,840,841,849],[97,144,606],[97,144,604,606],[97,144,595,603,604,605,607,609],[97,144,593],[97,144,596,601,606,609],[97,144,592,609],[97,144,596,597,600,601,602,609],[97,144,596,597,598,600,601,609],[97,144,593,594,595,596,597,601,602,603,605,606,607,609],[97,144,609],[97,144,591,593,594,595,596,597,598,600,601,602,603,604,605,606,607,608],[97,144,591,609],[97,144,596,598,599,601,602,609],[97,144,600,609],[97,144,601,602,606,609],[97,144,594,604],[97,144,618],[97,144,795],[85,97,144,754,763,792,794],[97,144,859],[97,144,754,758,792,858],[97,144,804,837,838],[97,144,839],[97,144,792,793],[97,144,754,758,763,764,792],[97,144,584,613],[97,144,583,584],[97,144,174,192],[97,144,760],[97,111,115,144,185],[97,111,144,174,185],[97,106,144],[97,108,111,144,182,185],[97,144,163,182],[97,106,144,192],[97,108,111,144,163,185],[97,103,104,107,110,144,155,174,185],[97,111,118,144],[97,103,109,144],[97,111,132,133,144],[97,107,111,144,177,185,192],[97,132,144,192],[97,105,106,144,192],[97,111,144],[97,105,106,107,108,109,110,111,112,113,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,133,134,135,136,137,138,144],[97,111,126,144],[97,111,118,119,144],[97,109,111,119,120,144],[97,110,144],[97,103,106,111,144],[97,111,115,119,120,144],[97,115,144],[97,109,111,114,144,185],[97,103,108,111,118,144],[97,144,174],[97,106,111,132,144,190,192],[97,144,758,762],[97,144,753,758,759,761,763],[97,144,755],[97,144,756,757],[97,144,753,756,758],[97,144,627,628],[97,144,627],[97,144,614,627,628,641],[97,144,155,156,158,159,160,163,174,182,185,191,192,584,585,586,587,588,589,590,610,611,612,613],[97,144,586,587,588,589],[97,144,586,587,588],[97,144,586],[97,144,587],[97,144,584],[97,144,642],[97,144,156,174,190,614,620,626,629,632,633,635,636,637,638,639,640,641],[97,144,156,174,190,614,620,623,626,629,632,633,635,636,637,638,639,640,641,900,901,902],[97,144,626,636,637,641],[97,144,737],[97,144,728],[97,144,728,731],[97,144,723,726,728,729,730,731,732,733,734,735,736],[97,144,662,664,731],[97,144,728,729],[97,144,663,728,730],[97,144,664,666,668,669,670,671],[97,144,666,668,670,671],[97,144,666,668,670],[97,144,663,666,668,669,671],[97,144,662,664,665,666,667,668,669,670,671,672,673,723,724,725,726,727],[97,144,662,664,665,668],[97,144,664,665,668],[97,144,668,671],[97,144,662,663,665,666,667,669,670,671],[97,144,662,663,664,668,728],[97,144,668,669,670,671],[97,144,670],[97,144,674,675,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722],[97,144,869,870,872,873,874,876],[97,144,872,873,874,875,876,877],[97,144,869,872,873,874,876],[97,144,270],[97,144,270,476,505,569,578,1014],[97,144,270,645,657],[97,144,270,482,652,974],[97,144,270,476,505,569,578],[85,97,144,270,646],[97,144,270,492,569,657,976],[97,144,270,492],[85,97,144,270,480,956,957],[97,144,270,980],[97,144,270,482,492,657,970],[97,144,270,482,492,645,657],[97,144,270,476,505,569,578,648],[85,97,144,270,492,648,649,866,868],[97,144,270,492,505,569,657,985],[97,144,270,492,505,569,648,657,898,987],[85,97,144,270,482,648,889,898],[97,144,270,482,492,505,569,657,989],[97,144,270,482,492,505,649,657,1014],[85,97,144,270,492],[85,97,144,270,492,658,956],[97,144,270,482,492,657,658,982,983],[85,97,144,270,482,492,647],[85,97,144,270,482,492,648],[97,144,270,492,657,994],[97,144,270,482,492,657],[97,144,270,482,492,569,657,658,989],[85,97,144,270,482,492,650],[97,144,270,504],[97,144,270,476,504,578,652,654],[97,144,270,476,504,569,578],[97,144,149,270,504,569,657,658],[97,144,270,504,569,657],[97,144,270,504,578,651],[97,144,270,504,578,648,651,652,658,741],[97,144,270,504,578,648,651,658,741],[97,144,270,504,578,651,652,658,744],[97,144,270,504,657,741],[97,144,270,504,578,651,652,658,741,744],[97,144,270,504,578,580,658,744],[97,144,270,504,657],[85,97,144,270,492,956],[85,97,144,270,482,956],[97,144,270,482,492,569,579,580,657,744],[97,144,270,482,657],[85,97,144,270,492,648,658,879,895,896,955,956,1002],[97,144,270,492,648,657,658,897,898,1004,1005],[97,144,270,508,962,963],[97,144,270,482,492,508,579,580,648,652,657,658,744],[97,144,270,968],[85,97,144,270,648,741],[97,144,270,482,648,657,740,741,891,892,893,897,1005,1009,1010,1011],[85,97,144,270,648,740,880,889,898],[85,97,144,270,492,956,961],[97,144,270,482],[85,97,144,270,751,752,956],[85,97,144,270,751,956,957,958,967],[97,144,270,648],[97,144,270,864,866,867],[85,97,144,270,482,492,648,752,862,863,865],[85,97,144,270,648,752,861,862,863],[85,97,144,270,648],[85,97,144,270,648,895],[97,144,270,648,880,881,894],[97,144,270,648,740,903],[97,144,270,505,579,648,652,657,658,739,740],[97,144,270,648,897],[85,97,144,270,492,648,658,879,895,896,955,1002],[97,144,270,739,740,741],[97,144,270,738],[97,144,270,648,658,871,878,879],[85,97,144,270,648,880,955],[85,97,144,270,648,861,882,883,884,885,886,895],[97,144,270,895],[97,144,270,882,884,885,886,887,888,889,890,891,892,893],[97,144,270,796,839,860,959],[85,97,144,270,648,861,895],[85,97,144,270,648,740,861,880],[85,97,144,270,648,865,895],[85,97,144,270,648,861,884,885],[85,97,144,270,648,879,895],[97,144,270,949,952,953],[97,144,270,505,648,652,653],[97,144,156,165,270,505],[97,144,270,752,956],[97,144,270,565,569,578],[97,144,270,476,578],[97,144,270,505,569],[85,97,144,270,957],[97,144,270,504,578],[97,144,165,270,643]],"fileInfos":[{"version":"c430d44666289dae81f30fa7b2edebf186ecc91a2d4c71266ea6ae76388792e1","affectsGlobalScope":true,"impliedFormat":1},{"version":"45b7ab580deca34ae9729e97c13cfd999df04416a79116c3bfb483804f85ded4","impliedFormat":1},{"version":"3facaf05f0c5fc569c5649dd359892c98a85557e3e0c847964caeb67076f4d75","impliedFormat":1},{"version":"e44bb8bbac7f10ecc786703fe0a6a4b952189f908707980ba8f3c8975a760962","impliedFormat":1},{"version":"5e1c4c362065a6b95ff952c0eab010f04dcd2c3494e813b493ecfd4fcb9fc0d8","impliedFormat":1},{"version":"68d73b4a11549f9c0b7d352d10e91e5dca8faa3322bfb77b661839c42b1ddec7","impliedFormat":1},{"version":"5efce4fc3c29ea84e8928f97adec086e3dc876365e0982cc8479a07954a3efd4","impliedFormat":1},{"version":"feecb1be483ed332fad555aff858affd90a48ab19ba7272ee084704eb7167569","impliedFormat":1},{"version":"ee7bad0c15b58988daa84371e0b89d313b762ab83cb5b31b8a2d1162e8eb41c2","impliedFormat":1},{"version":"27bdc30a0e32783366a5abeda841bc22757c1797de8681bbe81fbc735eeb1c10","impliedFormat":1},{"version":"8fd575e12870e9944c7e1d62e1f5a73fcf23dd8d3a321f2a2c74c20d022283fe","impliedFormat":1},{"version":"2ab096661c711e4a81cc464fa1e6feb929a54f5340b46b0a07ac6bbf857471f0","impliedFormat":1},{"version":"080941d9f9ff9307f7e27a83bcd888b7c8270716c39af943532438932ec1d0b9","affectsGlobalScope":true,"impliedFormat":1},{"version":"2e80ee7a49e8ac312cc11b77f1475804bee36b3b2bc896bead8b6e1266befb43","affectsGlobalScope":true,"impliedFormat":1},{"version":"c57796738e7f83dbc4b8e65132f11a377649c00dd3eee333f672b8f0a6bea671","affectsGlobalScope":true,"impliedFormat":1},{"version":"dc2df20b1bcdc8c2d34af4926e2c3ab15ffe1160a63e58b7e09833f616efff44","affectsGlobalScope":true,"impliedFormat":1},{"version":"515d0b7b9bea2e31ea4ec968e9edd2c39d3eebf4a2d5cbd04e88639819ae3b71","affectsGlobalScope":true,"impliedFormat":1},{"version":"0559b1f683ac7505ae451f9a96ce4c3c92bdc71411651ca6ddb0e88baaaad6a3","affectsGlobalScope":true,"impliedFormat":1},{"version":"0dc1e7ceda9b8b9b455c3a2d67b0412feab00bd2f66656cd8850e8831b08b537","affectsGlobalScope":true,"impliedFormat":1},{"version":"ce691fb9e5c64efb9547083e4a34091bcbe5bdb41027e310ebba8f7d96a98671","affectsGlobalScope":true,"impliedFormat":1},{"version":"8d697a2a929a5fcb38b7a65594020fcef05ec1630804a33748829c5ff53640d0","affectsGlobalScope":true,"impliedFormat":1},{"version":"4ff2a353abf8a80ee399af572debb8faab2d33ad38c4b4474cff7f26e7653b8d","affectsGlobalScope":true,"impliedFormat":1},{"version":"fb0f136d372979348d59b3f5020b4cdb81b5504192b1cacff5d1fbba29378aa1","affectsGlobalScope":true,"impliedFormat":1},{"version":"d15bea3d62cbbdb9797079416b8ac375ae99162a7fba5de2c6c505446486ac0a","affectsGlobalScope":true,"impliedFormat":1},{"version":"68d18b664c9d32a7336a70235958b8997ebc1c3b8505f4f1ae2b7e7753b87618","affectsGlobalScope":true,"impliedFormat":1},{"version":"eb3d66c8327153d8fa7dd03f9c58d351107fe824c79e9b56b462935176cdf12a","affectsGlobalScope":true,"impliedFormat":1},{"version":"38f0219c9e23c915ef9790ab1d680440d95419ad264816fa15009a8851e79119","affectsGlobalScope":true,"impliedFormat":1},{"version":"69ab18c3b76cd9b1be3d188eaf8bba06112ebbe2f47f6c322b5105a6fbc45a2e","affectsGlobalScope":true,"impliedFormat":1},{"version":"a680117f487a4d2f30ea46f1b4b7f58bef1480456e18ba53ee85c2746eeca012","affectsGlobalScope":true,"impliedFormat":1},{"version":"2f11ff796926e0832f9ae148008138ad583bd181899ab7dd768a2666700b1893","affectsGlobalScope":true,"impliedFormat":1},{"version":"4de680d5bb41c17f7f68e0419412ca23c98d5749dcaaea1896172f06435891fc","affectsGlobalScope":true,"impliedFormat":1},{"version":"954296b30da6d508a104a3a0b5d96b76495c709785c1d11610908e63481ee667","affectsGlobalScope":true,"impliedFormat":1},{"version":"ac9538681b19688c8eae65811b329d3744af679e0bdfa5d842d0e32524c73e1c","affectsGlobalScope":true,"impliedFormat":1},{"version":"0a969edff4bd52585473d24995c5ef223f6652d6ef46193309b3921d65dd4376","affectsGlobalScope":true,"impliedFormat":1},{"version":"9e9fbd7030c440b33d021da145d3232984c8bb7916f277e8ffd3dc2e3eae2bdb","affectsGlobalScope":true,"impliedFormat":1},{"version":"811ec78f7fefcabbda4bfa93b3eb67d9ae166ef95f9bff989d964061cbf81a0c","affectsGlobalScope":true,"impliedFormat":1},{"version":"717937616a17072082152a2ef351cb51f98802fb4b2fdabd32399843875974ca","affectsGlobalScope":true,"impliedFormat":1},{"version":"d7e7d9b7b50e5f22c915b525acc5a49a7a6584cf8f62d0569e557c5cfc4b2ac2","affectsGlobalScope":true,"impliedFormat":1},{"version":"71c37f4c9543f31dfced6c7840e068c5a5aacb7b89111a4364b1d5276b852557","affectsGlobalScope":true,"impliedFormat":1},{"version":"576711e016cf4f1804676043e6a0a5414252560eb57de9faceee34d79798c850","affectsGlobalScope":true,"impliedFormat":1},{"version":"89c1b1281ba7b8a96efc676b11b264de7a8374c5ea1e6617f11880a13fc56dc6","affectsGlobalScope":true,"impliedFormat":1},{"version":"74f7fa2d027d5b33eb0471c8e82a6c87216223181ec31247c357a3e8e2fddc5b","affectsGlobalScope":true,"impliedFormat":1},{"version":"d6d7ae4d1f1f3772e2a3cde568ed08991a8ae34a080ff1151af28b7f798e22ca","affectsGlobalScope":true,"impliedFormat":1},{"version":"063600664504610fe3e99b717a1223f8b1900087fab0b4cad1496a114744f8df","affectsGlobalScope":true,"impliedFormat":1},{"version":"934019d7e3c81950f9a8426d093458b65d5aff2c7c1511233c0fd5b941e608ab","affectsGlobalScope":true,"impliedFormat":1},{"version":"52ada8e0b6e0482b728070b7639ee42e83a9b1c22d205992756fe020fd9f4a47","affectsGlobalScope":true,"impliedFormat":1},{"version":"3bdefe1bfd4d6dee0e26f928f93ccc128f1b64d5d501ff4a8cf3c6371200e5e6","affectsGlobalScope":true,"impliedFormat":1},{"version":"59fb2c069260b4ba00b5643b907ef5d5341b167e7d1dbf58dfd895658bda2867","affectsGlobalScope":true,"impliedFormat":1},{"version":"639e512c0dfc3fad96a84caad71b8834d66329a1f28dc95e3946c9b58176c73a","affectsGlobalScope":true,"impliedFormat":1},{"version":"368af93f74c9c932edd84c58883e736c9e3d53cec1fe24c0b0ff451f529ceab1","affectsGlobalScope":true,"impliedFormat":1},{"version":"af3dd424cf267428f30ccfc376f47a2c0114546b55c44d8c0f1d57d841e28d74","affectsGlobalScope":true,"impliedFormat":1},{"version":"995c005ab91a498455ea8dfb63aa9f83fa2ea793c3d8aa344be4a1678d06d399","affectsGlobalScope":true,"impliedFormat":1},{"version":"959d36cddf5e7d572a65045b876f2956c973a586da58e5d26cde519184fd9b8a","affectsGlobalScope":true,"impliedFormat":1},{"version":"965f36eae237dd74e6cca203a43e9ca801ce38824ead814728a2807b1910117d","affectsGlobalScope":true,"impliedFormat":1},{"version":"3925a6c820dcb1a06506c90b1577db1fdbf7705d65b62b99dce4be75c637e26b","affectsGlobalScope":true,"impliedFormat":1},{"version":"0a3d63ef2b853447ec4f749d3f368ce642264246e02911fcb1590d8c161b8005","affectsGlobalScope":true,"impliedFormat":1},{"version":"8cdf8847677ac7d20486e54dd3fcf09eda95812ac8ace44b4418da1bbbab6eb8","affectsGlobalScope":true,"impliedFormat":1},{"version":"8444af78980e3b20b49324f4a16ba35024fef3ee069a0eb67616ea6ca821c47a","affectsGlobalScope":true,"impliedFormat":1},{"version":"3287d9d085fbd618c3971944b65b4be57859f5415f495b33a6adc994edd2f004","affectsGlobalScope":true,"impliedFormat":1},{"version":"b4b67b1a91182421f5df999988c690f14d813b9850b40acd06ed44691f6727ad","affectsGlobalScope":true,"impliedFormat":1},{"version":"df83c2a6c73228b625b0beb6669c7ee2a09c914637e2d35170723ad49c0f5cd4","affectsGlobalScope":true,"impliedFormat":1},{"version":"436aaf437562f276ec2ddbee2f2cdedac7664c1e4c1d2c36839ddd582eeb3d0a","affectsGlobalScope":true,"impliedFormat":1},{"version":"8e3c06ea092138bf9fa5e874a1fdbc9d54805d074bee1de31b99a11e2fec239d","affectsGlobalScope":true,"impliedFormat":1},{"version":"87dc0f382502f5bbce5129bdc0aea21e19a3abbc19259e0b43ae038a9fc4e326","affectsGlobalScope":true,"impliedFormat":1},{"version":"b1cb28af0c891c8c96b2d6b7be76bd394fddcfdb4709a20ba05a7c1605eea0f9","affectsGlobalScope":true,"impliedFormat":1},{"version":"2fef54945a13095fdb9b84f705f2b5994597640c46afeb2ce78352fab4cb3279","affectsGlobalScope":true,"impliedFormat":1},{"version":"ac77cb3e8c6d3565793eb90a8373ee8033146315a3dbead3bde8db5eaf5e5ec6","affectsGlobalScope":true,"impliedFormat":1},{"version":"56e4ed5aab5f5920980066a9409bfaf53e6d21d3f8d020c17e4de584d29600ad","affectsGlobalScope":true,"impliedFormat":1},{"version":"4ece9f17b3866cc077099c73f4983bddbcb1dc7ddb943227f1ec070f529dedd1","affectsGlobalScope":true,"impliedFormat":1},{"version":"0a6282c8827e4b9a95f4bf4f5c205673ada31b982f50572d27103df8ceb8013c","affectsGlobalScope":true,"impliedFormat":1},{"version":"1c9319a09485199c1f7b0498f2988d6d2249793ef67edda49d1e584746be9032","affectsGlobalScope":true,"impliedFormat":1},{"version":"e3a2a0cee0f03ffdde24d89660eba2685bfbdeae955a6c67e8c4c9fd28928eeb","affectsGlobalScope":true,"impliedFormat":1},{"version":"811c71eee4aa0ac5f7adf713323a5c41b0cf6c4e17367a34fbce379e12bbf0a4","affectsGlobalScope":true,"impliedFormat":1},{"version":"51ad4c928303041605b4d7ae32e0c1ee387d43a24cd6f1ebf4a2699e1076d4fa","affectsGlobalScope":true,"impliedFormat":1},{"version":"60037901da1a425516449b9a20073aa03386cce92f7a1fd902d7602be3a7c2e9","affectsGlobalScope":true,"impliedFormat":1},{"version":"d4b1d2c51d058fc21ec2629fff7a76249dec2e36e12960ea056e3ef89174080f","affectsGlobalScope":true,"impliedFormat":1},{"version":"22adec94ef7047a6c9d1af3cb96be87a335908bf9ef386ae9fd50eeb37f44c47","affectsGlobalScope":true,"impliedFormat":1},{"version":"196cb558a13d4533a5163286f30b0509ce0210e4b316c56c38d4c0fd2fb38405","affectsGlobalScope":true,"impliedFormat":1},{"version":"73f78680d4c08509933daf80947902f6ff41b6230f94dd002ae372620adb0f60","affectsGlobalScope":true,"impliedFormat":1},{"version":"c5239f5c01bcfa9cd32f37c496cf19c61d69d37e48be9de612b541aac915805b","affectsGlobalScope":true,"impliedFormat":1},{"version":"8e7f8264d0fb4c5339605a15daadb037bf238c10b654bb3eee14208f860a32ea","affectsGlobalScope":true,"impliedFormat":1},{"version":"782dec38049b92d4e85c1585fbea5474a219c6984a35b004963b00beb1aab538","affectsGlobalScope":true,"impliedFormat":1},{"version":"170d4db14678c68178ee8a3d5a990d5afb759ecb6ec44dbd885c50f6da6204f6","affectsGlobalScope":true,"impliedFormat":1},{"version":"8a8eb4ebffd85e589a1cc7c178e291626c359543403d58c9cd22b81fab5b1fb9","impliedFormat":1},{"version":"0ff1b165090b491f5e1407ae680b9a0bc3806dc56827ec85f93c57390491e732","impliedFormat":1},{"version":"acd8fd5090ac73902278889c38336ff3f48af6ba03aa665eb34a75e7ba1dccc4","impliedFormat":1},{"version":"d6258883868fb2680d2ca96bc8b1352cab69874581493e6d52680c5ffecdb6cc","impliedFormat":1},{"version":"1b61d259de5350f8b1e5db06290d31eaebebc6baafd5f79d314b5af9256d7153","impliedFormat":1},{"version":"f258e3960f324a956fc76a3d3d9e964fff2244ff5859dcc6ce5951e5413ca826","impliedFormat":1},{"version":"643f7232d07bf75e15bd8f658f664d6183a0efaca5eb84b48201c7671a266979","impliedFormat":1},{"version":"21da358700a3893281ce0c517a7a30cbd46be020d9f0c3f2834d0a8ad1f5fc75","impliedFormat":1},{"version":"70521b6ab0dcba37539e5303104f29b721bfb2940b2776da4cc818c07e1fefc1","affectsGlobalScope":true,"impliedFormat":1},{"version":"ab41ef1f2cdafb8df48be20cd969d875602483859dc194e9c97c8a576892c052","affectsGlobalScope":true,"impliedFormat":1},{"version":"d153a11543fd884b596587ccd97aebbeed950b26933ee000f94009f1ab142848","affectsGlobalScope":true,"impliedFormat":1},{"version":"21d819c173c0cf7cc3ce57c3276e77fd9a8a01d35a06ad87158781515c9a438a","impliedFormat":1},{"version":"a79e62f1e20467e11a904399b8b18b18c0c6eea6b50c1168bf215356d5bebfaf","affectsGlobalScope":true,"impliedFormat":1},{"version":"49a5a44f2e68241a1d2bd9ec894535797998841c09729e506a7cbfcaa40f2180","affectsGlobalScope":true,"impliedFormat":1},{"version":"6d9ef24f9a22a88e3e9b3b3d8c40ab1ddb0853f1bfbd5c843c37800138437b61","affectsGlobalScope":true,"impliedFormat":1},{"version":"1db0b7dca579049ca4193d034d835f6bfe73096c73663e5ef9a0b5779939f3d0","affectsGlobalScope":true,"impliedFormat":1},{"version":"9798340ffb0d067d69b1ae5b32faa17ab31b82466a3fc00d8f2f2df0c8554aaa","affectsGlobalScope":true,"impliedFormat":1},{"version":"f26b11d8d8e4b8028f1c7d618b22274c892e4b0ef5b3678a8ccbad85419aef43","affectsGlobalScope":true,"impliedFormat":1},{"version":"8e9c23ba78aabc2e0a27033f18737a6df754067731e69dc5f52823957d60a4b6","impliedFormat":1},{"version":"5929864ce17fba74232584d90cb721a89b7ad277220627cc97054ba15a98ea8f","impliedFormat":1},{"version":"763fe0f42b3d79b440a9b6e51e9ba3f3f91352469c1e4b3b67bfa4ff6352f3f4","impliedFormat":1},{"version":"25c8056edf4314820382a5fdb4bb7816999acdcb929c8f75e3f39473b87e85bc","impliedFormat":1},{"version":"c464d66b20788266e5353b48dc4aa6bc0dc4a707276df1e7152ab0c9ae21fad8","impliedFormat":1},{"version":"78d0d27c130d35c60b5e5566c9f1e5be77caf39804636bc1a40133919a949f21","impliedFormat":1},{"version":"c6fd2c5a395f2432786c9cb8deb870b9b0e8ff7e22c029954fabdd692bff6195","impliedFormat":1},{"version":"1d6e127068ea8e104a912e42fc0a110e2aa5a66a356a917a163e8cf9a65e4a75","impliedFormat":1},{"version":"5ded6427296cdf3b9542de4471d2aa8d3983671d4cac0f4bf9c637208d1ced43","impliedFormat":1},{"version":"7f182617db458e98fc18dfb272d40aa2fff3a353c44a89b2c0ccb3937709bfb5","impliedFormat":1},{"version":"cadc8aced301244057c4e7e73fbcae534b0f5b12a37b150d80e5a45aa4bebcbd","impliedFormat":1},{"version":"385aab901643aa54e1c36f5ef3107913b10d1b5bb8cbcd933d4263b80a0d7f20","impliedFormat":1},{"version":"9670d44354bab9d9982eca21945686b5c24a3f893db73c0dae0fd74217a4c219","impliedFormat":1},{"version":"0b8a9268adaf4da35e7fa830c8981cfa22adbbe5b3f6f5ab91f6658899e657a7","impliedFormat":1},{"version":"11396ed8a44c02ab9798b7dca436009f866e8dae3c9c25e8c1fbc396880bf1bb","impliedFormat":1},{"version":"ba7bc87d01492633cb5a0e5da8a4a42a1c86270e7b3d2dea5d156828a84e4882","impliedFormat":1},{"version":"4893a895ea92c85345017a04ed427cbd6a1710453338df26881a6019432febdd","impliedFormat":1},{"version":"c21dc52e277bcfc75fac0436ccb75c204f9e1b3fa5e12729670910639f27343e","impliedFormat":1},{"version":"13f6f39e12b1518c6650bbb220c8985999020fe0f21d818e28f512b7771d00f9","impliedFormat":1},{"version":"9b5369969f6e7175740bf51223112ff209f94ba43ecd3bb09eefff9fd675624a","impliedFormat":1},{"version":"4fe9e626e7164748e8769bbf74b538e09607f07ed17c2f20af8d680ee49fc1da","impliedFormat":1},{"version":"24515859bc0b836719105bb6cc3d68255042a9f02a6022b3187948b204946bd2","impliedFormat":1},{"version":"ea0148f897b45a76544ae179784c95af1bd6721b8610af9ffa467a518a086a43","impliedFormat":1},{"version":"24c6a117721e606c9984335f71711877293a9651e44f59f3d21c1ea0856f9cc9","impliedFormat":1},{"version":"dd3273ead9fbde62a72949c97dbec2247ea08e0c6952e701a483d74ef92d6a17","impliedFormat":1},{"version":"405822be75ad3e4d162e07439bac80c6bcc6dbae1929e179cf467ec0b9ee4e2e","impliedFormat":1},{"version":"0db18c6e78ea846316c012478888f33c11ffadab9efd1cc8bcc12daded7a60b6","impliedFormat":1},{"version":"e61be3f894b41b7baa1fbd6a66893f2579bfad01d208b4ff61daef21493ef0a8","impliedFormat":1},{"version":"bd0532fd6556073727d28da0edfd1736417a3f9f394877b6d5ef6ad88fba1d1a","impliedFormat":1},{"version":"89167d696a849fce5ca508032aabfe901c0868f833a8625d5a9c6e861ef935d2","impliedFormat":1},{"version":"615ba88d0128ed16bf83ef8ccbb6aff05c3ee2db1cc0f89ab50a4939bfc1943f","impliedFormat":1},{"version":"a4d551dbf8746780194d550c88f26cf937caf8d56f102969a110cfaed4b06656","impliedFormat":1},{"version":"8bd86b8e8f6a6aa6c49b71e14c4ffe1211a0e97c80f08d2c8cc98838006e4b88","impliedFormat":1},{"version":"317e63deeb21ac07f3992f5b50cdca8338f10acd4fbb7257ebf56735bf52ab00","impliedFormat":1},{"version":"4732aec92b20fb28c5fe9ad99521fb59974289ed1e45aecb282616202184064f","impliedFormat":1},{"version":"2e85db9e6fd73cfa3d7f28e0ab6b55417ea18931423bd47b409a96e4a169e8e6","impliedFormat":1},{"version":"c46e079fe54c76f95c67fb89081b3e399da2c7d109e7dca8e4b58d83e332e605","impliedFormat":1},{"version":"bf67d53d168abc1298888693338cb82854bdb2e69ef83f8a0092093c2d562107","impliedFormat":1},{"version":"2cbe0621042e2a68c7cbce5dfed3906a1862a16a7d496010636cdbdb91341c0f","affectsGlobalScope":true,"impliedFormat":1},{"version":"e2677634fe27e87348825bb041651e22d50a613e2fdf6a4a3ade971d71bac37e","impliedFormat":1},{"version":"7394959e5a741b185456e1ef5d64599c36c60a323207450991e7a42e08911419","impliedFormat":1},{"version":"8c0bcd6c6b67b4b503c11e91a1fb91522ed585900eab2ab1f61bba7d7caa9d6f","impliedFormat":1},{"version":"567b7f607f400873151d7bc63a049514b53c3c00f5f56e9e95695d93b66a138e","affectsGlobalScope":true,"impliedFormat":1},{"version":"68ba7d7e4a34414e812c3fc77727366da26afe1ee575455628db0ba3a1e0ae63","impliedFormat":1},{"version":"b9b881045ea548a057056c0dea01cbed5db634356a5440b715040f5d260bdf68","impliedFormat":1},{"version":"35ec8b6760fd7138bbf5809b84551e31028fb2ba7b6dc91d95d098bf212ca8b4","affectsGlobalScope":true,"impliedFormat":1},{"version":"5524481e56c48ff486f42926778c0a3cce1cc85dc46683b92b1271865bcf015a","impliedFormat":1},{"version":"eff99fb8e69bff92fd8e6c18e4ebf3f762926c498d155729d28dfb2bddfe428c","affectsGlobalScope":true,"impliedFormat":1},{"version":"8d04e3640dd9eb67f7f1e5bd3d0bf96c784666f7aefc8ac1537af6f2d38d4c29","impliedFormat":1},{"version":"9d19808c8c291a9010a6c788e8532a2da70f811adb431c97520803e0ec649991","impliedFormat":1},{"version":"87aad3dd9752067dc875cfaa466fc44246451c0c560b820796bdd528e29bef40","impliedFormat":1},{"version":"4aacb0dd020eeaef65426153686cc639a78ec2885dc72ad220be1d25f1a439df","impliedFormat":1},{"version":"f0bd7e6d931657b59605c44112eaf8b980ba7f957a5051ed21cb93d978cf2f45","impliedFormat":1},{"version":"8db0ae9cb14d9955b14c214f34dae1b9ef2baee2fe4ce794a4cd3ac2531e3255","affectsGlobalScope":true,"impliedFormat":1},{"version":"881a94bbc18ad3616e93c5063bb03e702d82dd9ac4bc286e992e16a931a4f146","impliedFormat":1},{"version":"685657a3ec619ef12aa7f754eee3b28598d3bf9749da89839a72a343fffef5ff","impliedFormat":1},{"version":"f053e5d4a5e7e50c07fced3b13f6aef66c49f92e92c3e83da0da5e025f915543","impliedFormat":1},{"version":"d51990e06fce43eb05e638f1df07558126d588b3b7f92f398b83ec15cfa7e196","impliedFormat":1},{"version":"e1d94cb75140795ba8881a50563ed2872fb6d5954ab21717256fdbcf66a2ac6a","impliedFormat":1},{"version":"5650cf3dace09e7c25d384e3e6b818b938f68f4e8de96f52d9c5a1b3db068e86","impliedFormat":1},{"version":"1354ca5c38bd3fd3836a68e0f7c9f91f172582ba30ab15bb8c075891b91502b7","affectsGlobalScope":true,"impliedFormat":1},{"version":"a87ea9de0593dbcc5d3969188f96b2fdcf55d40b5dd0e89257e5be72d2a548c0","impliedFormat":1},{"version":"e9abad184aca454f338338c8018e5d4dab634cea2d6db7a69ff315d9b8647477","impliedFormat":1},{"version":"afbe24ab0d74694372baa632ecb28bb375be53f3be53f9b07ecd7fc994907de5","impliedFormat":1},{"version":"ca867399f7db82df981d6915bcbb2d81131d7d1ef683bc782b59f71dda59bc85","affectsGlobalScope":true,"impliedFormat":1},{"version":"d846dd3e94a1d15d89e13456d32fbcc1126cd7d08218b7b5e98140da3d206d13","affectsGlobalScope":true,"impliedFormat":1},{"version":"9e043a1bc8fbf2a255bccf9bf27e0f1caf916c3b0518ea34aa72357c0afd42ec","impliedFormat":1},{"version":"b4f70ec656a11d570e1a9edce07d118cd58d9760239e2ece99306ee9dfe61d02","impliedFormat":1},{"version":"3bc2f1e2c95c04048212c569ed38e338873f6a8593930cf5a7ef24ffb38fc3b6","impliedFormat":1},{"version":"6e70e9570e98aae2b825b533aa6292b6abd542e8d9f6e9475e88e1d7ba17c866","impliedFormat":1},{"version":"f9d9d753d430ed050dc1bf2667a1bab711ccbb1c1507183d794cc195a5b085cc","impliedFormat":1},{"version":"9eece5e586312581ccd106d4853e861aaaa1a39f8e3ea672b8c3847eedd12f6e","impliedFormat":1},{"version":"47ab634529c5955b6ad793474ae188fce3e6163e3a3fb5edd7e0e48f14435333","impliedFormat":1},{"version":"37ba7b45141a45ce6e80e66f2a96c8a5ab1bcef0fc2d0f56bb58df96ec67e972","impliedFormat":1},{"version":"125d792ec6c0c0f657d758055c494301cc5fdb327d9d9d5960b3f129aff76093","impliedFormat":1},{"version":"0225ecb9ed86bdb7a2c7fd01f1556906902929377b44483dc4b83e03b3ef227d","affectsGlobalScope":true,"impliedFormat":1},{"version":"1851a3b4db78664f83901bb9cac9e45e03a37bb5933cc5bf37e10bb7e91ab4eb","impliedFormat":1},{"version":"5eab9b3dc9b34f185417342436ec3f106898da5f4801992d8ff38ab3aff346b5","impliedFormat":1},{"version":"12ed4559eba17cd977aa0db658d25c4047067444b51acfdcbf38470630642b23","affectsGlobalScope":true,"impliedFormat":1},{"version":"f3ffabc95802521e1e4bcba4c88d8615176dc6e09111d920c7a213bdda6e1d65","impliedFormat":1},{"version":"e04b85e2b08f6e659387bd37953e89afb219cd2fa9883c7565b61aea84335915","impliedFormat":1},{"version":"ae56f65caf3be91108707bd8dfbccc2a57a91feb5daabf7165a06a945545ed26","impliedFormat":1},{"version":"a136d5de521da20f31631a0a96bf712370779d1c05b7015d7019a9b2a0446ca9","impliedFormat":1},{"version":"dfb96ba5177b68003deec9e773c47257da5c4c8a74053d8956389d832df72002","affectsGlobalScope":true,"impliedFormat":1},{"version":"92d3070580cf72b4bb80959b7f16ede9a3f39e6f4ef2ac87cfa4561844fdc69f","affectsGlobalScope":true,"impliedFormat":1},{"version":"09913a6464bdeae74e00d7cc7d5921847178d74c1eadd3bf14b72988cca15f77","impliedFormat":1},{"version":"3c61ec39cb462f6d1f8598e0ecef780705300409b27e0ed103301d761109d227","impliedFormat":1},{"version":"d91a7d8b5655c42986f1bdfe2105c4408f472831c8f20cf11a8c3345b6b56c8c","impliedFormat":1},{"version":"ed59add13139f84da271cafd32e2171876b0a0af2f798d0c663e8eeb867732cf","affectsGlobalScope":true,"impliedFormat":1},{"version":"e8a979b8af001c9fc2e774e7809d233c8ca955a28756f52ee5dee88ccb0611d2","impliedFormat":1},{"version":"b1810689b76fd473bd12cc9ee219f8e62f54a7d08019a235d07424afbf074d25","impliedFormat":1},{"version":"24259d3dae14de55d22f8b3d3e96954e5175a925ab6a830dc05a1993d4794eda","impliedFormat":1},{"version":"05069916ab9175271d15f9315a41ab28401561fe0e5f85f295c43538a38bd62e","impliedFormat":1},{"version":"be1cc4d94ea60cbe567bc29ed479d42587bf1e6cba490f123d329976b0fe4ee5","impliedFormat":1},{"version":"42bc0e1a903408137c3df2b06dfd7e402cdab5bbfa5fcfb871b22ebfdb30bd0b","impliedFormat":1},{"version":"9894dafe342b976d251aac58e616ac6df8db91fb9d98934ff9dd103e9e82578f","impliedFormat":1},{"version":"413df52d4ea14472c2fa5bee62f7a40abd1eb49be0b9722ee01ee4e52e63beb2","impliedFormat":1},{"version":"db6d2d9daad8a6d83f281af12ce4355a20b9a3e71b82b9f57cddcca0a8964a96","impliedFormat":1},{"version":"446a50749b24d14deac6f8843e057a6355dd6437d1fac4f9e5ce4a5071f34bff","impliedFormat":1},{"version":"182e9fcbe08ac7c012e0a6e2b5798b4352470be29a64fdc114d23c2bab7d5106","impliedFormat":1},{"version":"5c9b31919ea1cb350a7ae5e71c9ced8f11723e4fa258a8cc8d16ae46edd623c7","impliedFormat":1},{"version":"4aa42ce8383b45823b3a1d3811c0fdd5f939f90254bc4874124393febbaf89f6","impliedFormat":1},{"version":"96ffa70b486207241c0fcedb5d9553684f7fa6746bc2b04c519e7ebf41a51205","impliedFormat":1},{"version":"5c24c66b3ba29ce9f2a79c719967e6e944131352a117a0bc43fa5b346b5562b3","impliedFormat":1},{"version":"a86f82d646a739041d6702101afa82dcb935c416dd93cbca7fd754fd0282ce1f","impliedFormat":1},{"version":"ad0d1d75d129b1c80f911be438d6b61bfa8703930a8ff2be2f0e1f8a91841c64","impliedFormat":1},{"version":"ce75b1aebb33d510ff28af960a9221410a3eaf7f18fc5f21f9404075fba77256","impliedFormat":1},{"version":"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","impliedFormat":1},{"version":"02436d7e9ead85e09a2f8e27d5f47d9464bced31738dec138ca735390815c9f0","impliedFormat":1},{"version":"f4625edcb57b37b84506e8b276eb59ca30d31f88c6656d29d4e90e3bc58e69df","impliedFormat":1},{"version":"78a2869ad0cbf3f9045dda08c0d4562b7e1b2bfe07b19e0db072f5c3c56e9584","impliedFormat":1},{"version":"f8d5ff8eafd37499f2b6a98659dd9b45a321de186b8db6b6142faed0fea3de77","impliedFormat":1},{"version":"c86fe861cf1b4c46a0fb7d74dffe596cf679a2e5e8b1456881313170f092e3fa","impliedFormat":1},{"version":"c685d9f68c70fe11ce527287526585a06ea13920bb6c18482ca84945a4e433a7","impliedFormat":1},{"version":"540cc83ab772a2c6bc509fe1354f314825b5dba3669efdfbe4693ecd3048e34f","impliedFormat":1},{"version":"121b0696021ab885c570bbeb331be8ad82c6efe2f3b93a6e63874901bebc13e3","impliedFormat":1},{"version":"4e01846df98d478a2a626ec3641524964b38acaac13945c2db198bf9f3df22ee","impliedFormat":1},{"version":"678d6d4c43e5728bf66e92fc2269da9fa709cb60510fed988a27161473c3853f","impliedFormat":1},{"version":"ffa495b17a5ef1d0399586b590bd281056cee6ce3583e34f39926f8dcc6ecdb5","impliedFormat":1},{"version":"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","impliedFormat":1},{"version":"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","impliedFormat":1},{"version":"8e609bb71c20b858c77f0e9f90bb1319db8477b13f9f965f1a1e18524bf50881","impliedFormat":1},{"version":"8e609bb71c20b858c77f0e9f90bb1319db8477b13f9f965f1a1e18524bf50881","impliedFormat":1},{"version":"aa14cee20aa0db79f8df101fc027d929aec10feb5b8a8da3b9af3895d05b7ba2","impliedFormat":1},{"version":"493c700ac3bd317177b2eb913805c87fe60d4e8af4fb39c41f04ba81fae7e170","impliedFormat":1},{"version":"aeb554d876c6b8c818da2e118d8b11e1e559adbe6bf606cc9a611c1b6c09f670","impliedFormat":1},{"version":"acf5a2ac47b59ca07afa9abbd2b31d001bf7448b041927befae2ea5b1951d9f9","impliedFormat":1},{"version":"8e609bb71c20b858c77f0e9f90bb1319db8477b13f9f965f1a1e18524bf50881","impliedFormat":1},{"version":"d71291eff1e19d8762a908ba947e891af44749f3a2cbc5bd2ec4b72f72ea795f","impliedFormat":1},{"version":"c0480e03db4b816dff2682b347c95f2177699525c54e7e6f6aa8ded890b76be7","impliedFormat":1},{"version":"e2a37ac938c4bede5bb284b9d2d042da299528f1e61f6f57538f1bd37d760869","impliedFormat":1},{"version":"76def37aff8e3a051cf406e10340ffba0f28b6991c5d987474cc11137796e1eb","impliedFormat":1},{"version":"b620391fe8060cf9bedc176a4d01366e6574d7a71e0ac0ab344a4e76576fcbb8","impliedFormat":1},{"version":"3e7efde639c6a6c3edb9847b3f61e308bf7a69685b92f665048c45132f51c218","impliedFormat":1},{"version":"df45ca1176e6ac211eae7ddf51336dc075c5314bc5c253651bae639defd5eec5","impliedFormat":1},{"version":"106c6025f1d99fd468fd8bf6e5bda724e11e5905a4076c5d29790b6c3745e50c","impliedFormat":1},{"version":"ee8df1cb8d0faaca4013a1b442e99130769ce06f438d18d510fed95890067563","impliedFormat":1},{"version":"bfb7f8475428637bee12bdd31bd9968c1c8a1cc2c3e426c959e2f3a307f8936f","impliedFormat":1},{"version":"6f491d0108927478d3247bbbc489c78c2da7ef552fd5277f1ab6819986fdf0b1","impliedFormat":1},{"version":"0d8f2b8781c721170b87a6b662b3cb038fd1a721165ecca390352c818d425872","impliedFormat":1},{"version":"7cb0ee103671d1e201cd53dda12bc1cd0a35f1c63d6102720c6eeb322cb8e17e","impliedFormat":1},{"version":"15a234e5031b19c48a69ccc1607522d6e4b50f57d308ecb7fe863d44cd9f9eb3","impliedFormat":1},{"version":"148679c6d0f449210a96e7d2e562d589e56fcde87f843a92808b3ff103f1a774","impliedFormat":1},{"version":"6459054aabb306821a043e02b89d54da508e3a6966601a41e71c166e4ea1474f","impliedFormat":1},{"version":"2f9c89cbb29d362290531b48880a4024f258c6033aaeb7e59fbc62db26819650","impliedFormat":1},{"version":"bb37588926aba35c9283fe8d46ebf4e79ffe976343105f5c6d45f282793352b2","impliedFormat":1},{"version":"05c97cddbaf99978f83d96de2d8af86aded9332592f08ce4a284d72d0952c391","impliedFormat":1},{"version":"72179f9dd22a86deaad4cc3490eb0fe69ee084d503b686985965654013f1391b","impliedFormat":1},{"version":"2e6114a7dd6feeef85b2c80120fdbfb59a5529c0dcc5bfa8447b6996c97a69f5","impliedFormat":1},{"version":"7b6ff760c8a240b40dab6e4419b989f06a5b782f4710d2967e67c695ef3e93c4","impliedFormat":1},{"version":"c8f004e6036aa1c764ad4ec543cf89a5c1893a9535c80ef3f2b653e370de45e6","impliedFormat":1},{"version":"dd80b1e600d00f5c6a6ba23f455b84a7db121219e68f89f10552c54ba46e4dc9","impliedFormat":1},{"version":"b064c36f35de7387d71c599bfcf28875849a1dbc733e82bd26cae3d1cd060521","impliedFormat":1},{"version":"05c7280d72f3ed26f346cbe7cbbbb002fb7f15739197cbbee6ab3fd1a6cb9347","impliedFormat":1},{"version":"8de9fe97fa9e00ec00666fa77ab6e91b35d25af8ca75dabcb01e14ad3299b150","impliedFormat":1},{"version":"803cd2aaf1921c218916c2c7ee3fce653e852d767177eb51047ff15b5b253893","impliedFormat":1},{"version":"dba114fb6a32b355a9cfc26ca2276834d72fe0e94cd2c3494005547025015369","impliedFormat":1},{"version":"7ab12b2f1249187223d11a589f5789c75177a0b597b9eb7f8e2e42d045393347","impliedFormat":1},{"version":"ad37fb4be61c1035b68f532b7220f4e8236cf245381ce3b90ac15449ecfe7305","impliedFormat":1},{"version":"93436bd74c66baba229bfefe1314d122c01f0d4c1d9e35081a0c4f0470ac1a6c","impliedFormat":1},{"version":"f974e4a06953682a2c15d5bd5114c0284d5abf8bc0fe4da25cb9159427b70072","impliedFormat":1},{"version":"50256e9c31318487f3752b7ac12ff365c8949953e04568009c8705db802776fb","impliedFormat":1},{"version":"7d73b24e7bf31dfb8a931ca6c4245f6bb0814dfae17e4b60c9e194a631fe5f7b","impliedFormat":1},{"version":"d130c5f73768de51402351d5dc7d1b36eaec980ca697846e53156e4ea9911476","impliedFormat":1},{"version":"413586add0cfe7369b64979d4ec2ed56c3f771c0667fbde1bf1f10063ede0b08","impliedFormat":1},{"version":"06472528e998d152375ad3bd8ebcb69ff4694fd8d2effaf60a9d9f25a37a097a","impliedFormat":1},{"version":"50b5bc34ce6b12eccb76214b51aadfa56572aa6cc79c2b9455cdbb3d6c76af1d","impliedFormat":1},{"version":"b7e16ef7f646a50991119b205794ebfd3a4d8f8e0f314981ebbe991639023d0e","impliedFormat":1},{"version":"42c169fb8c2d42f4f668c624a9a11e719d5d07dacbebb63cbcf7ef365b0a75b3","impliedFormat":1},{"version":"a401617604fa1f6ce437b81689563dfdc377069e4c58465dbd8d16069aede0a5","impliedFormat":1},{"version":"6e9082e91370de5040e415cd9f24e595b490382e8c7402c4e938a8ce4bccc99f","impliedFormat":1},{"version":"8695dec09ad439b0ceef3776ea68a232e381135b516878f0901ed2ea114fd0fe","impliedFormat":1},{"version":"304b44b1e97dd4c94697c3313df89a578dca4930a104454c99863f1784a54357","impliedFormat":1},{"version":"d682336018141807fb602709e2d95a192828fcb8d5ba06dda3833a8ea98f69e3","impliedFormat":1},{"version":"6124e973eab8c52cabf3c07575204efc1784aca6b0a30c79eb85fe240a857efa","impliedFormat":1},{"version":"0d891735a21edc75df51f3eb995e18149e119d1ce22fd40db2b260c5960b914e","impliedFormat":1},{"version":"3b414b99a73171e1c4b7b7714e26b87d6c5cb03d200352da5342ab4088a54c85","impliedFormat":1},{"version":"4fbd3116e00ed3a6410499924b6403cc9367fdca303e34838129b328058ede40","impliedFormat":1},{"version":"b01bd582a6e41457bc56e6f0f9de4cb17f33f5f3843a7cf8210ac9c18472fb0f","impliedFormat":1},{"version":"0a437ae178f999b46b6153d79095b60c42c996bc0458c04955f1c996dc68b971","impliedFormat":1},{"version":"74b2a5e5197bd0f2e0077a1ea7c07455bbea67b87b0869d9786d55104006784f","impliedFormat":1},{"version":"4a7baeb6325920044f66c0f8e5e6f1f52e06e6d87588d837bdf44feb6f35c664","impliedFormat":1},{"version":"12d218a49dbe5655b911e6cc3c13b2c655e4c783471c3b0432137769c79e1b3c","impliedFormat":1},{"version":"7274fbffbd7c9589d8d0ffba68157237afd5cecff1e99881ea3399127e60572f","impliedFormat":1},{"version":"6b0fc04121360f752d196ba35b6567192f422d04a97b2840d7d85f8b79921c92","impliedFormat":1},{"version":"65a15fc47900787c0bd18b603afb98d33ede930bed1798fc984d5ebb78b26cf9","impliedFormat":1},{"version":"9d202701f6e0744adb6314d03d2eb8fc994798fc83d91b691b75b07626a69801","impliedFormat":1},{"version":"a365c4d3bed3be4e4e20793c999c51f5cd7e6792322f14650949d827fbcd170f","impliedFormat":1},{"version":"c5426dbfc1cf90532f66965a7aa8c1136a78d4d0f96d8180ecbfc11d7722f1a5","impliedFormat":1},{"version":"9c82171d836c47486074e4ca8e059735bf97b205e70b196535b5efd40cbe1bc5","impliedFormat":1},{"version":"f374cb24e93e7798c4d9e83ff872fa52d2cdb36306392b840a6ddf46cb925cb6","impliedFormat":1},{"version":"42b81043b00ff27c6bd955aea0f6e741545f2265978bf364b614702b72a027ab","impliedFormat":1},{"version":"de9d2df7663e64e3a91bf495f315a7577e23ba088f2949d5ce9ec96f44fba37d","impliedFormat":1},{"version":"c7af78a2ea7cb1cd009cfb5bdb48cd0b03dad3b54f6da7aab615c2e9e9d570c5","impliedFormat":1},{"version":"1ee45496b5f8bdee6f7abc233355898e5bf9bd51255db65f5ff7ede617ca0027","impliedFormat":1},{"version":"97e5ccc7bb88419005cbdf812243a5b3186cdef81b608540acabe1be163fc3e4","affectsGlobalScope":true,"impliedFormat":1},{"version":"3fbdd025f9d4d820414417eeb4107ffa0078d454a033b506e22d3a23bc3d9c41","affectsGlobalScope":true,"impliedFormat":1},{"version":"a8f8e6ab2fa07b45251f403548b78eaf2022f3c2254df3dc186cb2671fe4996d","affectsGlobalScope":true,"impliedFormat":1},{"version":"fa6c12a7c0f6b84d512f200690bfc74819e99efae69e4c95c4cd30f6884c526e","impliedFormat":1},{"version":"f1c32f9ce9c497da4dc215c3bc84b722ea02497d35f9134db3bb40a8d918b92b","impliedFormat":1},{"version":"b73c319af2cc3ef8f6421308a250f328836531ea3761823b4cabbd133047aefa","affectsGlobalScope":true,"impliedFormat":1},{"version":"e433b0337b8106909e7953015e8fa3f2d30797cea27141d1c5b135365bb975a6","impliedFormat":1},{"version":"9f9bb6755a8ce32d656ffa4763a8144aa4f274d6b69b59d7c32811031467216e","impliedFormat":1},{"version":"5c32bdfbd2d65e8fffbb9fbda04d7165e9181b08dad61154961852366deb7540","impliedFormat":1},{"version":"ddff7fc6edbdc5163a09e22bf8df7bef75f75369ebd7ecea95ba55c4386e2441","impliedFormat":1},{"version":"6b3453eebd474cc8acf6d759f1668e6ce7425a565e2996a20b644c72916ecf75","impliedFormat":1},{"version":"0c05e9842ec4f8b7bfebfd3ca61604bb8c914ba8da9b5337c4f25da427a005f2","impliedFormat":1},{"version":"89cd3444e389e42c56fd0d072afef31387e7f4107651afd2c03950f22dc36f77","impliedFormat":1},{"version":"7f2aa4d4989a82530aaac3f72b3dceca90e9c25bee0b1a327e8a08a1262435ad","impliedFormat":1},{"version":"e39a304f882598138a8022106cb8de332abbbb87f3fee71c5ca6b525c11c51fc","impliedFormat":1},{"version":"faed7a5153215dbd6ebe76dfdcc0af0cfe760f7362bed43284be544308b114cf","impliedFormat":1},{"version":"fcdf3e40e4a01b9a4b70931b8b51476b210c511924fcfe3f0dae19c4d52f1a54","impliedFormat":1},{"version":"345c4327b637d34a15aba4b7091eb068d6ab40a3dedaab9f00986253c9704e53","impliedFormat":1},{"version":"3a788c7fb7b1b1153d69a4d1d9e1d0dfbcf1127e703bdb02b6d12698e683d1fb","impliedFormat":1},{"version":"2e4f37ffe8862b14d8e24ae8763daaa8340c0df0b859d9a9733def0eee7562d9","impliedFormat":1},{"version":"d38530db0601215d6d767f280e3a3c54b2a83b709e8d9001acb6f61c67e965fc","impliedFormat":1},{"version":"6ac6715916fa75a1f7ebdfeacac09513b4d904b667d827b7535e84ff59679aff","impliedFormat":1},{"version":"4805f6161c2c8cefb8d3b8bd96a080c0fe8dbc9315f6ad2e53238f9a79e528a6","impliedFormat":1},{"version":"b83cb14474fa60c5f3ec660146b97d122f0735627f80d82dd03e8caa39b4388c","impliedFormat":1},{"version":"2b5b70d7782fe028487a80a1c214e67bd610532b9f978b78fa60f5b4a359f77e","impliedFormat":1},{"version":"7ee86fbb3754388e004de0ef9e6505485ddfb3be7640783d6d015711c03d302d","impliedFormat":1},{"version":"1a82deef4c1d39f6882f28d275cad4c01f907b9b39be9cbc472fcf2cf051e05b","impliedFormat":1},{"version":"162e071992b34bc36ca257d629547f93cb43728d6fe073ad18a237e4f7c52d7d","impliedFormat":1},{"version":"b73cbf0a72c8800cf8f96a9acfe94f3ad32ca71342a8908b8ae484d61113f647","impliedFormat":1},{"version":"bae6dd176832f6423966647382c0d7ba9e63f8c167522f09a982f086cd4e8b23","impliedFormat":1},{"version":"20865ac316b8893c1a0cc383ccfc1801443fbcc2a7255be166cf90d03fac88c9","impliedFormat":1},{"version":"c9958eb32126a3843deedda8c22fb97024aa5d6dd588b90af2d7f2bfac540f23","impliedFormat":1},{"version":"461d0ad8ae5f2ff981778af912ba71b37a8426a33301daa00f21c6ccb27f8156","impliedFormat":1},{"version":"e927c2c13c4eaf0a7f17e6022eee8519eb29ef42c4c13a31e81a611ab8c95577","impliedFormat":1},{"version":"fcafff163ca5e66d3b87126e756e1b6dfa8c526aa9cd2a2b0a9da837d81bbd72","impliedFormat":1},{"version":"70246ad95ad8a22bdfe806cb5d383a26c0c6e58e7207ab9c431f1cb175aca657","impliedFormat":1},{"version":"f00f3aa5d64ff46e600648b55a79dcd1333458f7a10da2ed594d9f0a44b76d0b","impliedFormat":1},{"version":"772d8d5eb158b6c92412c03228bd9902ccb1457d7a705b8129814a5d1a6308fc","impliedFormat":1},{"version":"802e797bcab5663b2c9f63f51bdf67eff7c41bc64c0fd65e6da3e7941359e2f7","impliedFormat":1},{"version":"8b4327413e5af38cd8cb97c59f48c3c866015d5d642f28518e3a891c469f240e","impliedFormat":1},{"version":"7e6ac205dcb9714f708354fd863bffa45cee90740706cc64b3b39b23ebb84744","impliedFormat":1},{"version":"61dc6e3ac78d64aa864eedd0a208b97b5887cc99c5ba65c03287bf57d83b1eb9","impliedFormat":1},{"version":"4b20fcf10a5413680e39f5666464859fc56b1003e7dfe2405ced82371ebd49b6","impliedFormat":1},{"version":"c06ef3b2569b1c1ad99fcd7fe5fba8d466e2619da5375dfa940a94e0feea899b","impliedFormat":1},{"version":"f7d628893c9fa52ba3ab01bcb5e79191636c4331ee5667ecc6373cbccff8ae12","impliedFormat":1},{"version":"5b2323ca2d1bd97e1f32f09452908e015b012e0e4f958f649cbe0c8989a3fb4f","impliedFormat":1},{"version":"8baa8dbdc393e3c6b26e8e31384b938756ce2effdc126648d43e58291ce9869b","impliedFormat":1},{"version":"933aee906d42ea2c53b6892192a8127745f2ec81a90695df4024308ba35a8ff4","impliedFormat":1},{"version":"d663134457d8d669ae0df34eabd57028bddc04fc444c4bc04bc5215afc91e1f4","impliedFormat":1},{"version":"985153f0deb9b4391110331a2f0c114019dbea90cba5ca68a4107700796e0d75","impliedFormat":1},{"version":"a3e3f0efcae272ab8ee3298e4e819f7d9dd9ff411101f45444877e77cfeca9a4","impliedFormat":1},{"version":"43e96a3d5d1411ab40ba2f61d6a3192e58177bcf3b133a80ad2a16591611726d","impliedFormat":1},{"version":"58659b06d33fa430bee1105b75cf876c0a35b2567207487c8578aec51ca2d977","impliedFormat":1},{"version":"71d9eb4c4e99456b78ae182fb20a5dfc20eb1667f091dbb9335b3c017dd1c783","impliedFormat":1},{"version":"cfa846a7b7847a1d973605fbb8c91f47f3a0f0643c18ac05c47077ebc72e71c7","impliedFormat":1},{"version":"30e6520444df1a004f46fdc8096f3fe06f7bbd93d09c53ada9dcdde59919ccca","impliedFormat":1},{"version":"6c800b281b9e89e69165fd11536195488de3ff53004e55905e6c0059a2d8591e","impliedFormat":1},{"version":"7d4254b4c6c67a29d5e7f65e67d72540480ac2cfb041ca484847f5ae70480b62","impliedFormat":1},{"version":"a58beefce74db00dbb60eb5a4bb0c6726fb94c7797c721f629142c0ae9c94306","impliedFormat":1},{"version":"41eeb453ccb75c5b2c3abef97adbbd741bd7e9112a2510e12f03f646dc9ad13d","impliedFormat":1},{"version":"502fa5863df08b806dbf33c54bee8c19f7e2ad466785c0fc35465d7c5ff80995","impliedFormat":1},{"version":"c91a2d08601a1547ffef326201be26db94356f38693bb18db622ae5e9b3d7c92","impliedFormat":1},{"version":"888cda0fa66d7f74e985a3f7b1af1f64b8ff03eb3d5e80d051c3cbdeb7f32ab7","impliedFormat":1},{"version":"60681e13f3545be5e9477acb752b741eae6eaf4cc01658a25ec05bff8b82a2ef","impliedFormat":1},{"version":"8b4b8ebc2d99ae651c5c4169ee8b24e2b0e02a3dfaef84e357d677b663c18fdf","impliedFormat":1},{"version":"a57b1802794433adec9ff3fed12aa79d671faed86c49b09e02e1ac41b4f1d33a","impliedFormat":1},{"version":"ad10d4f0517599cdeca7755b930f148804e3e0e5b5a3847adce0f1f71bbccd74","impliedFormat":1},{"version":"1042064ece5bb47d6aba91648fbe0635c17c600ebdf567588b4ca715602f0a9d","impliedFormat":1},{"version":"c49469a5349b3cc1965710b5b0f98ed6c028686aa8450bcb3796728873eb923e","impliedFormat":1},{"version":"4a889f2c763edb4d55cb624257272ac10d04a1cad2ed2948b10ed4a7fda2a428","impliedFormat":1},{"version":"7bb79aa2fead87d9d56294ef71e056487e848d7b550c9a367523ee5416c44cfa","impliedFormat":1},{"version":"d88ea80a6447d7391f52352ec97e56b52ebec934a4a4af6e2464cfd8b39c3ba8","impliedFormat":1},{"version":"55095860901097726220b6923e35a812afdd49242a1246d7b0942ee7eb34c6e4","impliedFormat":1},{"version":"96171c03c2e7f314d66d38acd581f9667439845865b7f85da8df598ff9617476","impliedFormat":1},{"version":"27ff4196654e6373c9af16b6165120e2dd2169f9ad6abb5c935af5abd8c7938c","impliedFormat":1},{"version":"bb8f2dbc03533abca2066ce4655c119bff353dd4514375beb93c08590c03e023","impliedFormat":1},{"version":"d193c8a86144b3a87b22bc1f5534b9c3e0f5a187873ec337c289a183973a58fe","impliedFormat":1},{"version":"1a6e6ba8a07b74e3ad237717c0299d453f9ceb795dbc2f697d1f2dd07cb782d2","impliedFormat":1},{"version":"58d70c38037fc0f949243388ff7ae20cf43321107152f14a9d36ca79311e0ada","impliedFormat":1},{"version":"f56bdc6884648806d34bc66d31cdb787c4718d04105ce2cd88535db214631f82","impliedFormat":1},{"version":"190da5eac6478d61ab9731ab2146fbc0164af2117a363013249b7e7992f1cccb","impliedFormat":1},{"version":"01479d9d5a5dda16d529b91811375187f61a06e74be294a35ecce77e0b9e8d6c","impliedFormat":1},{"version":"49f95e989b4632c6c2a578cc0078ee19a5831832d79cc59abecf5160ea71abad","impliedFormat":1},{"version":"9666533332f26e8995e4d6fe472bdeec9f15d405693723e6497bf94120c566c8","impliedFormat":1},{"version":"ce0df82a9ae6f914ba08409d4d883983cc08e6d59eb2df02d8e4d68309e7848b","impliedFormat":1},{"version":"796273b2edc72e78a04e86d7c58ae94d370ab93a0ddf40b1aa85a37a1c29ecd7","impliedFormat":1},{"version":"5df15a69187d737d6d8d066e189ae4f97e41f4d53712a46b2710ff9f8563ec9f","impliedFormat":1},{"version":"1a4dc28334a926d90ba6a2d811ba0ff6c22775fcc13679521f034c124269fd40","impliedFormat":1},{"version":"f05315ff85714f0b87cc0b54bcd3dde2716e5a6b99aedcc19cad02bf2403e08c","impliedFormat":1},{"version":"8a8c64dafaba11c806efa56f5c69f611276471bef80a1db1f71316ec4168acef","impliedFormat":1},{"version":"43ba4f2fa8c698f5c304d21a3ef596741e8e85a810b7c1f9b692653791d8d97a","impliedFormat":1},{"version":"5fad3b31fc17a5bc58095118a8b160f5260964787c52e7eb51e3d4fcf5d4a6f0","impliedFormat":1},{"version":"72105519d0390262cf0abe84cf41c926ade0ff475d35eb21307b2f94de985778","impliedFormat":1},{"version":"d0a4cac61fa080f2be5ebb68b82726be835689b35994ba0e22e3ed4d2bc45e3b","impliedFormat":1},{"version":"c857e0aae3f5f444abd791ec81206020fbcc1223e187316677e026d1c1d6fe08","impliedFormat":1},{"version":"ccf6dd45b708fb74ba9ed0f2478d4eb9195c9dfef0ff83a6092fa3cf2ff53b4f","impliedFormat":1},{"version":"2d7db1d73456e8c5075387d4240c29a2a900847f9c1bff106a2e490da8fbd457","impliedFormat":1},{"version":"2b15c805f48e4e970f8ec0b1915f22d13ca6212375e8987663e2ef5f0205e832","impliedFormat":1},{"version":"205a31b31beb7be73b8df18fcc43109cbc31f398950190a0967afc7a12cb478c","impliedFormat":1},{"version":"8fca3039857709484e5893c05c1f9126ab7451fa6c29e19bb8c2411a2e937345","impliedFormat":1},{"version":"35069c2c417bd7443ae7c7cafd1de02f665bf015479fec998985ffbbf500628c","impliedFormat":1},{"version":"dba6c7006e14a98ec82999c6f89fbbbfd1c642f41db148535f3b77b8018829b8","impliedFormat":1},{"version":"7f897b285f22a57a5c4dc14a27da2747c01084a542b4d90d33897216dceeea2e","impliedFormat":1},{"version":"7e0b7f91c5ab6e33f511efc640d36e6f933510b11be24f98836a20a2dc914c2d","impliedFormat":1},{"version":"045b752f44bf9bbdcaffd882424ab0e15cb8d11fa94e1448942e338c8ef19fba","impliedFormat":1},{"version":"2894c56cad581928bb37607810af011764a2f511f575d28c9f4af0f2ef02d1ab","impliedFormat":1},{"version":"0a72186f94215d020cb386f7dca81d7495ab6c17066eb07d0f44a5bf33c1b21a","impliedFormat":1},{"version":"d96b39301d0ded3f1a27b47759676a33a02f6f5049bfcbde81e533fd10f50dcb","impliedFormat":1},{"version":"2ded4f930d6abfaa0625cf55e58f565b7cbd4ab5b574dd2cb19f0a83a2f0be8b","impliedFormat":1},{"version":"0aedb02516baf3e66b2c1db9fef50666d6ed257edac0f866ea32f1aa05aa474f","impliedFormat":1},{"version":"ca0f4d9068d652bad47e326cf6ba424ac71ab866e44b24ddb6c2bd82d129586a","affectsGlobalScope":true,"impliedFormat":1},{"version":"04d36005fcbeac741ac50c421181f4e0316d57d148d37cc321a8ea285472462b","impliedFormat":1},{"version":"9e2739b32f741859263fdba0244c194ca8e96da49b430377930b8f721d77c000","impliedFormat":1},{"version":"56ccb49443bfb72e5952f7012f0de1a8679f9f75fc93a5c1ac0bafb28725fc5f","impliedFormat":1},{"version":"20fa37b636fdcc1746ea0738f733d0aed17890d1cd7cb1b2f37010222c23f13e","impliedFormat":1},{"version":"d90b9f1520366d713a73bd30c5a9eb0040d0fb6076aff370796bc776fd705943","impliedFormat":1},{"version":"88e9caa9c5d2ba629240b5913842e7c57c5c0315383b8dc9d436ef2b60f1c391","impliedFormat":1},{"version":"19df3488557c2fc9b4d8f0bac0fd20fb59aa19dec67c81f93813951a81a867f8","affectsGlobalScope":true,"impliedFormat":1},{"version":"a15cf91ab29d3667801562a95730c5f0d96e1d87dffa00a8a91da0002e89fd2d","affectsGlobalScope":true,"impliedFormat":1},{"version":"bef86adb77316505c6b471da1d9b8c9e428867c2566270e8894d4d773a1c4dc2","impliedFormat":1},{"version":"a46dba563f70f32f9e45ae015f3de979225f668075d7a427f874e0f6db584991","impliedFormat":1},{"version":"6ac6715916fa75a1f7ebdfeacac09513b4d904b667d827b7535e84ff59679aff","impliedFormat":1},{"version":"2652448ac55a2010a1f71dd141f828b682298d39728f9871e1cdf8696ef443fd","impliedFormat":1},{"version":"02c4fc9e6bb27545fa021f6056e88ff5fdf10d9d9f1467f1d10536c6e749ac50","impliedFormat":1},{"version":"120599fd965257b1f4d0ff794bc696162832d9d8467224f4665f713a3119078b","impliedFormat":1},{"version":"5433f33b0a20300cca35d2f229a7fc20b0e8477c44be2affeb21cb464af60c76","impliedFormat":1},{"version":"db036c56f79186da50af66511d37d9fe77fa6793381927292d17f81f787bb195","impliedFormat":1},{"version":"bd4131091b773973ca5d2326c60b789ab1f5e02d8843b3587effe6e1ea7c9d86","impliedFormat":1},{"version":"c7f6485931085bf010fbaf46880a9b9ec1a285ad9dc8c695a9e936f5a48f34b4","impliedFormat":1},{"version":"14f6b927888a1112d662877a5966b05ac1bf7ed25d6c84386db4c23c95a5363b","impliedFormat":1},{"version":"6ac6715916fa75a1f7ebdfeacac09513b4d904b667d827b7535e84ff59679aff","impliedFormat":1},{"version":"622694a8522b46f6310c2a9b5d2530dde1e2854cb5829354e6d1ff8f371cf469","impliedFormat":1},{"version":"d24ff95760ea2dfcc7c57d0e269356984e7046b7e0b745c80fea71559f15bdd8","impliedFormat":1},{"version":"a9e6c0ff3f8186fccd05752cf75fc94e147c02645087ac6de5cc16403323d870","impliedFormat":1},{"version":"49c346823ba6d4b12278c12c977fb3a31c06b9ca719015978cb145eb86da1c61","impliedFormat":1},{"version":"bfac6e50eaa7e73bb66b7e052c38fdc8ccfc8dbde2777648642af33cf349f7f1","impliedFormat":1},{"version":"92f7c1a4da7fbfd67a2228d1687d5c2e1faa0ba865a94d3550a3941d7527a45d","impliedFormat":1},{"version":"f53b120213a9289d9a26f5af90c4c686dd71d91487a0aa5451a38366c70dc64b","impliedFormat":1},{"version":"83fe880c090afe485a5c02262c0b7cdd76a299a50c48d9bde02be8e908fb4ae6","impliedFormat":1},{"version":"13c1b657932e827a7ed510395d94fc8b743b9d053ab95b7cd829b2bc46fb06db","impliedFormat":1},{"version":"57d67b72e06059adc5e9454de26bbfe567d412b962a501d263c75c2db430f40e","impliedFormat":1},{"version":"6511e4503cf74c469c60aafd6589e4d14d5eb0a25f9bf043dcbecdf65f261972","impliedFormat":1},{"version":"078131f3a722a8ad3fc0b724cd3497176513cdcb41c80f96a3acbda2a143b58e","impliedFormat":1},{"version":"8c70ddc0c22d85e56011d49fddfaae3405eb53d47b59327b9dd589e82df672e7","impliedFormat":1},{"version":"a67b87d0281c97dfc1197ef28dfe397fc2c865ccd41f7e32b53f647184cc7307","impliedFormat":1},{"version":"771ffb773f1ddd562492a6b9aaca648192ac3f056f0e1d997678ff97dbb6bf9b","impliedFormat":1},{"version":"232f70c0cf2b432f3a6e56a8dc3417103eb162292a9fd376d51a3a9ea5fbbf6f","impliedFormat":1},{"version":"9e155d2255348d950b1f65643fb26c0f14f5109daf8bd9ee24a866ad0a743648","affectsGlobalScope":true,"impliedFormat":1},{"version":"0b103e9abfe82d14c0ad06a55d9f91d6747154ef7cacc73cf27ecad2bfb3afcf","impliedFormat":1},{"version":"7a883e9c84e720810f86ef4388f54938a65caa0f4d181a64e9255e847a7c9f51","impliedFormat":1},{"version":"a0ba218ac1baa3da0d5d9c1ec1a7c2f8676c284e6f5b920d6d049b13fa267377","impliedFormat":1},{"version":"8a0e762ceb20c7e72504feef83d709468a70af4abccb304f32d6b9bac1129b2c","impliedFormat":1},{"version":"d408d6f32de8d1aba2ff4a20f1aa6a6edd7d92c997f63b90f8ad3f9017cf5e46","impliedFormat":1},{"version":"9252d498a77517aab5d8d4b5eb9d71e4b225bbc7123df9713e08181de63180f6","impliedFormat":1},{"version":"221e915caef37c5cbaabd4946418f97dcc20591469e260732b31008321024dd8","impliedFormat":1},{"version":"35e6379c3f7cb27b111ad4c1aa69538fd8e788ab737b8ff7596a1b40e96f4f90","impliedFormat":1},{"version":"1fffe726740f9787f15b532e1dc870af3cd964dbe29e191e76121aa3dd8693f2","impliedFormat":1},{"version":"371bf6127c1d427836de95197155132501cb6b69ef8709176ce6e0b85d059264","impliedFormat":1},{"version":"2bafd700e617d3693d568e972d02b92224b514781f542f70d497a8fdf92d52a2","affectsGlobalScope":true,"impliedFormat":1},{"version":"5542d8a7ea13168cb573be0d1ba0d29460d59430fb12bb7bf4674efd5604e14c","impliedFormat":1},{"version":"af48e58339188d5737b608d41411a9c054685413d8ae88b8c1d0d9bfabdf6e7e","impliedFormat":1},{"version":"616775f16134fa9d01fc677ad3f76e68c051a056c22ab552c64cc281a9686790","impliedFormat":1},{"version":"65c24a8baa2cca1de069a0ba9fba82a173690f52d7e2d0f1f7542d59d5eb4db0","impliedFormat":1},{"version":"f9fe6af238339a0e5f7563acee3178f51db37f32a2e7c09f85273098cee7ec49","impliedFormat":1},{"version":"1de8c302fd35220d8f29dea378a4ae45199dc8ff83ca9923aca1400f2b28848a","impliedFormat":1},{"version":"77e71242e71ebf8528c5802993697878f0533db8f2299b4d36aa015bae08a79c","impliedFormat":1},{"version":"98a787be42bd92f8c2a37d7df5f13e5992da0d967fab794adbb7ee18370f9849","impliedFormat":1},{"version":"332248ee37cca52903572e66c11bef755ccc6e235835e63d3c3e60ddda3e9b93","impliedFormat":1},{"version":"94e8cc88ae2ef3d920bb3bdc369f48436db123aa2dc07f683309ad8c9968a1e1","impliedFormat":1},{"version":"4545c1a1ceca170d5d83452dd7c4994644c35cf676a671412601689d9a62da35","impliedFormat":1},{"version":"320f4091e33548b554d2214ce5fc31c96631b513dffa806e2e3a60766c8c49d9","impliedFormat":1},{"version":"a2d648d333cf67b9aeac5d81a1a379d563a8ffa91ddd61c6179f68de724260ff","impliedFormat":1},{"version":"d90d5f524de38889d1e1dbc2aeef00060d779f8688c02766ddb9ca195e4a713d","impliedFormat":1},{"version":"a3f41ed1b4f2fc3049394b945a68ae4fdefd49fa1739c32f149d32c0545d67f5","impliedFormat":1},{"version":"b0309e1eda99a9e76f87c18992d9c3689b0938266242835dd4611f2b69efe456","impliedFormat":1},{"version":"47699512e6d8bebf7be488182427189f999affe3addc1c87c882d36b7f2d0b0e","impliedFormat":1},{"version":"6ceb10ca57943be87ff9debe978f4ab73593c0c85ee802c051a93fc96aaf7a20","impliedFormat":1},{"version":"1de3ffe0cc28a9fe2ac761ece075826836b5a02f340b412510a59ba1d41a505a","impliedFormat":1},{"version":"e46d6cc08d243d8d0d83986f609d830991f00450fb234f5b2f861648c42dc0d8","impliedFormat":1},{"version":"1c0a98de1323051010ce5b958ad47bc1c007f7921973123c999300e2b7b0ecc0","impliedFormat":1},{"version":"ff863d17c6c659440f7c5c536e4db7762d8c2565547b2608f36b798a743606ca","impliedFormat":1},{"version":"5412ad0043cd60d1f1406fc12cb4fb987e9a734decbdd4db6f6acf71791e36fe","impliedFormat":1},{"version":"ad036a85efcd9e5b4f7dd5c1a7362c8478f9a3b6c3554654ca24a29aa850a9c5","impliedFormat":1},{"version":"fedebeae32c5cdd1a85b4e0504a01996e4a8adf3dfa72876920d3dd6e42978e7","impliedFormat":1},{"version":"b6c1f64158da02580f55e8a2728eda6805f79419aed46a930f43e68ad66a38fc","impliedFormat":1},{"version":"cdf21eee8007e339b1b9945abf4a7b44930b1d695cc528459e68a3adc39a622e","impliedFormat":1},{"version":"bc9ee0192f056b3d5527bcd78dc3f9e527a9ba2bdc0a2c296fbc9027147df4b2","impliedFormat":1},{"version":"330896c1a2b9693edd617be24fbf9e5895d6e18c7955d6c08f028f272b37314d","impliedFormat":1},{"version":"1d9c0a9a6df4e8f29dc84c25c5aa0bb1da5456ebede7a03e03df08bb8b27bae6","impliedFormat":1},{"version":"84380af21da938a567c65ef95aefb5354f676368ee1a1cbb4cae81604a4c7d17","impliedFormat":1},{"version":"1af3e1f2a5d1332e136f8b0b95c0e6c0a02aaabd5092b36b64f3042a03debf28","impliedFormat":1},{"version":"30d8da250766efa99490fc02801047c2c6d72dd0da1bba6581c7e80d1d8842a4","impliedFormat":1},{"version":"03566202f5553bd2d9de22dfab0c61aa163cabb64f0223c08431fb3fc8f70280","impliedFormat":1},{"version":"4c0a1233155afb94bd4d7518c75c84f98567cd5f13fc215d258de196cdb40d91","impliedFormat":1},{"version":"e7765aa8bcb74a38b3230d212b4547686eb9796621ffb4367a104451c3f9614f","impliedFormat":1},{"version":"1de80059b8078ea5749941c9f863aa970b4735bdbb003be4925c853a8b6b4450","impliedFormat":1},{"version":"1d079c37fa53e3c21ed3fa214a27507bda9991f2a41458705b19ed8c2b61173d","impliedFormat":1},{"version":"5bf5c7a44e779790d1eb54c234b668b15e34affa95e78eada73e5757f61ed76a","impliedFormat":1},{"version":"5835a6e0d7cd2738e56b671af0e561e7c1b4fb77751383672f4b009f4e161d70","impliedFormat":1},{"version":"5c634644d45a1b6bc7b05e71e05e52ec04f3d73d9ac85d5927f647a5f965181a","impliedFormat":1},{"version":"4b7f74b772140395e7af67c4841be1ab867c11b3b82a51b1aeb692822b76c872","impliedFormat":1},{"version":"27be6622e2922a1b412eb057faa854831b95db9db5035c3f6d4b677b902ab3b7","impliedFormat":1},{"version":"a68d4b3182e8d776cdede7ac9630c209a7bfbb59191f99a52479151816ef9f9e","impliedFormat":99},{"version":"39644b343e4e3d748344af8182111e3bbc594930fff0170256567e13bbdbebb0","impliedFormat":99},{"version":"ed7fd5160b47b0de3b1571c5c5578e8e7e3314e33ae0b8ea85a895774ee64749","impliedFormat":99},{"version":"63a7595a5015e65262557f883463f934904959da563b4f788306f699411e9bac","impliedFormat":1},{"version":"4ba137d6553965703b6b55fd2000b4e07ba365f8caeb0359162ad7247f9707a6","impliedFormat":1},{"version":"6de125ea94866c736c6d58d68eb15272cf7d1020a5b459fea1c660027eca9a90","affectsGlobalScope":true,"impliedFormat":1},{"version":"8fac4a15690b27612d8474fb2fc7cc00388df52d169791b78d1a3645d60b4c8b","affectsGlobalScope":true,"impliedFormat":1},{"version":"064ac1c2ac4b2867c2ceaa74bbdce0cb6a4c16e7c31a6497097159c18f74aa7c","impliedFormat":1},{"version":"3dc14e1ab45e497e5d5e4295271d54ff689aeae00b4277979fdd10fa563540ae","impliedFormat":1},{"version":"d3b315763d91265d6b0e7e7fa93cfdb8a80ce7cdd2d9f55ba0f37a22db00bdb8","impliedFormat":1},{"version":"b789bf89eb19c777ed1e956dbad0925ca795701552d22e68fd130a032008b9f9","impliedFormat":1},{"version":"e7dff4a72d3cd4561a7ce9eb7194f3067879966817398c826a2b3acb680455d5","affectsGlobalScope":true},"7b550dda9686c16f36a17bf9051d5dbf31e98555b30d114ac49fc49a1e712651",{"version":"59bb558828d28822b9a5cd2a91e285826ddcb73fd8d300cef4f180f28b702061","impliedFormat":1},{"version":"9ef837ef81ee3ea189ddf0737e9add4b7ec2562dca1141ce79e8f44aa6680573","impliedFormat":1},{"version":"a3628f430f8d502a5c026a0c932a5c41e6361d8e0248287872cd8999bc534399","impliedFormat":1},{"version":"ed774418ed7b67bf7c7c09afec04dc68aaf4b2ce34e83c8385ed32b836bfa1f5","impliedFormat":1},{"version":"20482dc96e81ee7d9d1f41564250d2a081e745484f4d68513c0b150a2e0ba895","impliedFormat":1},{"version":"4466d8a83034d8ad5d8175217d8130fb19215eac27c2be06b17834236b6a3d57","impliedFormat":1},{"version":"faa133dec56f8d63705aada03b659742f3aad8253bc8de4caab30b4fd333f8b3","impliedFormat":1},{"version":"be284a11ca945dc131c6a8c02cab9bb0762657ac9c5177614446e90e8d4100e8","impliedFormat":1},{"version":"783463b6de5d5533008a7c0113ba17b9155b9aac5c9776f1548416632205c629","impliedFormat":1},{"version":"4e47a7016af2e8e8844ed74797dcc3d3a36a1c179e24ab863676b50d43659652","impliedFormat":1},{"version":"3dbd7ed89ca15bb035948014cd31b7c190f55414939f778d0f2d6f19db30e9db","impliedFormat":1},{"version":"499fd4ee7e46c12347bd036e7fcbbaaa2497c2e448226b85a74bf0ba74c313c2","impliedFormat":1},{"version":"3efff2ce3536ffcd0ac17bde116cad13f604ec329d674bc0110b45659f34adec","impliedFormat":1},{"version":"70b4ed934718d0697abcb160f974480280c53a7f096dd02723222e78aadfff92","impliedFormat":1},{"version":"4c203868e4e11d604131c5d84767c64cf5d21393fd31a82412abf20413fb224e","impliedFormat":1},{"version":"83559f657d1a3b540a037e59dcb4c512aca61ad32962dd44bd37a27fc781aac6","impliedFormat":1},{"version":"1f0cbbe3934e998b6e2a6d9f86ca5e598fcfd52eefc3ab78c2e71c627cadbfcc","impliedFormat":1},{"version":"6d40ea659e699ad6f2298108d13b0fdc0d23f6c51b1dd6e650c7fadadb07392a","impliedFormat":1},{"version":"de8b47140491b63544ea5b0c2bfd2c1b53818a24564aaba83e1eb9d25a505988","impliedFormat":1},{"version":"381b623c9ee962965cc3684ee45de6236f91cf24eb845dafc3a74a27d1eed070","impliedFormat":1},{"version":"1f84dff7964146377785aa684028ca62290e0639ac41fd0c5f391a5f5d414adc","impliedFormat":1},{"version":"4edf6371c3fd1f12c91cab0b0c42340ba0205e1a24f95757551ba46b6ab0e8a4","impliedFormat":1},{"version":"f4ae5546352701fd6932fdd86419438bb51253e4627a44808489742035bac644","impliedFormat":1},{"version":"bda1393387e320d7c151a72415d14f77134a99839a0c7b6b990345475cfdb2a7","impliedFormat":1},{"version":"74ab72a65696fc22041b00bb32b79944e1a0e5033a2ad67a7ec5f0e69c08e0bb","impliedFormat":1},{"version":"f3e17346b7411be87dec6f9a591e3205d8fbfdfec91fd99b641efc853460d96d","impliedFormat":1},{"version":"c0e42e780d502d530ce67e30d09a3b81c5d37d500c1f7ef04f4bd806f648b96a","impliedFormat":1},{"version":"e3c8181f9cf79e7c33c3c4da1a41092bd7ed9eaaec9f9998766b52331150edb6","impliedFormat":1},{"version":"af28b25ad131252ea00c2f10086e0af945f7fbe8fc8337eaeef1ca6f954b3f9c","impliedFormat":1},{"version":"138e8936df57e556c630a9421cbda90fe9e93232c71974d2a6fa7ae3d9f9b6ea","impliedFormat":1},{"version":"65e50fccd6a4ddeb0243c6dbd3df154197d3d5e24d63d57789ba54444ef57895","impliedFormat":1},{"version":"7a59ab197ac3a724498a25700e613a2912fd522940b903da42dd4c93fa10613e","impliedFormat":1},{"version":"0c1d046da4b4cc3983952dc5b441e52e81da945bf4cc0bb3b2559a670226bd2b","impliedFormat":1},{"version":"294b4a33e67962cb7e920de93753bad5a53b00ff15442dc1cbb237bbbdda1ec5","impliedFormat":1},{"version":"8861847d6335fa45ade9ff5491902f6f9c5d9d0134ea495483a59de2483ac284","impliedFormat":1},{"version":"5379d0463dac0480db829530c0512f3053ae92fda542bc2e8c48210e2648a63d","impliedFormat":1},{"version":"321a90e602fde8be935b2e4f6f6948b09a109678f652bde1e29357b812622b39","impliedFormat":1},{"version":"450344ec9ee95c67228fe512dd4fe3ea92876320ab008bd4dd7e968787e9171b","impliedFormat":1},{"version":"0eae63800777384563d5727e572982c220d47acf736dcdb569a2749a32378f19","impliedFormat":1},{"version":"9bf41a89bd0bbd4f8a23a7925d04f99267cb84a5a5b239185f3320edea329b9c","impliedFormat":1},{"version":"ba69d5ef968a0350e3216f4dfd39f846ed9a500f360acbe473e4f88278b3c746","impliedFormat":1},{"version":"faeca2efb12c2e347d6166fcb8c9418edc0d4298e592f9888173cdbefa8e5347","impliedFormat":1},{"version":"69a49def2d9320181b6865812951e6ad6f0e01c100eb95a91783334fe6f2f2a1","impliedFormat":1},{"version":"ecfb7796212d2f1d7fc48d7d42dd6ec4c270f3080572d19f24b2638ae0defac3","impliedFormat":1},{"version":"3ceed4cf97cd25ae8e2a31ba6315d2f71d225a35c81013231aa7c25fe4ad96c8","impliedFormat":1},{"version":"4e18d16f28bc23667eb999b37e4f8ca7d683b0d2c5a7fbafebb359105f150911","impliedFormat":1},{"version":"18eaffdf9c5aaf96d3ba7e3d9d788193a119be6792c1f32da4ac3595687a3a59","impliedFormat":1},{"version":"75e6c0fcf71e3b20eb87349df5620cd917ff80289e07b423278214b8805765a9","impliedFormat":1},{"version":"4ae9b50481136302de9c77668621ed3a0b34998f3e091ca3701426f4fe369c8a","impliedFormat":1},{"version":"9ba9ecc57d2f52b3ed3ac229636ee9a36e92e18b80eeae11ffb546c12e56d5e5","impliedFormat":1},{"version":"a35e372b741b6aaf27163d79224fb2d553443bb388c24f84fdde42a450c6e761","impliedFormat":1},{"version":"d182d419bb30a1408784ed95fbabd973dde7517641e04525f0ce761df5d193a5","impliedFormat":1},{"version":"20482dc96e81ee7d9d1f41564250d2a081e745484f4d68513c0b150a2e0ba895","impliedFormat":1},{"version":"1b1f3855f718c1d9ec0070c07036e532fe6b026fa4ee8e1de8d04d8650caeebb","impliedFormat":1},{"version":"ec3e143e22d0b8828c2b99ef926af7ef05475421866ca9915444b383cd9e1db1","impliedFormat":1},{"version":"4c203868e4e11d604131c5d84767c64cf5d21393fd31a82412abf20413fb224e","impliedFormat":1},{"version":"5f07fe5f86384a76750cd9e3f459c66edc8d27aa99bb825426979e7cf78f16cf","impliedFormat":1},{"version":"b1ca4f7eb0410fd213008303a2ce35474134e62581fc75eba9040406677698a0","impliedFormat":1},{"version":"e10e6086685452cce450e8a36e8b21442fc193eb49464f07446940f47c548870","impliedFormat":1},{"version":"c83431bbdf4bc0275f48d6c63a33bdbda7cadd6658327db32c97760f2409afc1","impliedFormat":1},{"version":"743b160f5cf8db8aa68271455ab9a9d937b726ebb5e6c918049c55fa7ea5578d","impliedFormat":1},{"version":"893ab06420a579ff8a971c9c715852b7818858bfea81c83e9200c96d05b5c5de","impliedFormat":1},{"version":"2ed360a6314d0aadeecb8491a6fde17b58b8464acde69501dbd7242544bcce57","impliedFormat":1},{"version":"4158a50e206f82c95e0ad4ea442ff6c99f20b5b85c5444474b8a9504c59294aa","impliedFormat":1},{"version":"c7a9dc2768c7d68337e05a443d0ce8000b0d24d7dfa98751173421e165d44629","impliedFormat":1},{"version":"d93cbdbf9cb855ad40e03d425b1ef98d61160021608cf41b431c0fc7e39a0656","impliedFormat":1},{"version":"561a4879505d41a27c404f637ae50e3da92126aa70d94cc073f6a2e102d565b0","impliedFormat":1},{"version":"a02b18bfe239a3a8beaa4918be2039ab2b85cafb85ffc094723218e20723ed01","signature":"4575b491b17dbdf9dc65af44edfb6d858934e44665e2eaba960b6a8a8d4a27a4"},{"version":"dc552d33cbf0e269c8957551682b6679808eb9b1aeccc1a83f67aeb69f5a90d4","signature":"6df36592f53b695ac9b318bc51cd71acc39c336573d45b68e83b1e211dbfc3da"},{"version":"36eef89bc2e3323eb309157150f4d8a22db04f9a61584c5372a273b4fc6e20d5","signature":"b018e39514275c57f0693bd8d646bd854206d9cf87f1423961f3b8756e30fb13"},{"version":"3b8e2af8db93e60d5c119ccc5691add23e10196485cc02f528ad086158c1d668","signature":"435a1e418e8338be3f39614b96b81a9aa2700bc8c27bc6b98f064ff9ce17c363"},{"version":"151ff381ef9ff8da2da9b9663ebf657eac35c4c9a19183420c05728f31a6761d","impliedFormat":1},{"version":"ee70b8037ecdf0de6c04f35277f253663a536d7e38f1539d270e4e916d225a3f","affectsGlobalScope":true,"impliedFormat":1},{"version":"a660aa95476042d3fdcc1343cf6bb8fdf24772d31712b1db321c5a4dcc325434","impliedFormat":1},{"version":"282f98006ed7fa9bb2cd9bdbe2524595cfc4bcd58a0bb3232e4519f2138df811","impliedFormat":1},{"version":"6222e987b58abfe92597e1273ad7233626285bc2d78409d4a7b113d81a83496b","impliedFormat":1},{"version":"cbe726263ae9a7bf32352380f7e8ab66ee25b3457137e316929269c19e18a2be","impliedFormat":1},{"version":"8b96046bf5fb0a815cba6b0880d9f97b7f3a93cf187e8dcfe8e2792e97f38f87","impliedFormat":99},{"version":"bacf2c84cf448b2cd02c717ad46c3d7fd530e0c91282888c923ad64810a4d511","affectsGlobalScope":true,"impliedFormat":1},{"version":"402e5c534fb2b85fa771170595db3ac0dd532112c8fa44fc23f233bc6967488b","impliedFormat":1},{"version":"8885cf05f3e2abf117590bbb951dcf6359e3e5ac462af1c901cfd24c6a6472e2","impliedFormat":1},{"version":"333caa2bfff7f06017f114de738050dd99a765c7eb16571c6d25a38c0d5365dc","impliedFormat":1},{"version":"e61df3640a38d535fd4bc9f4a53aef17c296b58dc4b6394fd576b808dd2fe5e6","impliedFormat":1},{"version":"459920181700cec8cbdf2a5faca127f3f17fd8dd9d9e577ed3f5f3af5d12a2e4","impliedFormat":1},{"version":"4719c209b9c00b579553859407a7e5dcfaa1c472994bd62aa5dd3cc0757eb077","impliedFormat":1},{"version":"7ec359bbc29b69d4063fe7dad0baaf35f1856f914db16b3f4f6e3e1bca4099fa","impliedFormat":1},{"version":"70790a7f0040993ca66ab8a07a059a0f8256e7bb57d968ae945f696cbff4ac7a","impliedFormat":1},{"version":"d1b9a81e99a0050ca7f2d98d7eedc6cda768f0eb9fa90b602e7107433e64c04c","impliedFormat":1},{"version":"a022503e75d6953d0e82c2c564508a5c7f8556fad5d7f971372d2d40479e4034","impliedFormat":1},{"version":"b215c4f0096f108020f666ffcc1f072c81e9f2f95464e894a5d5f34c5ea2a8b1","impliedFormat":1},{"version":"644491cde678bd462bb922c1d0cfab8f17d626b195ccb7f008612dc31f445d2d","impliedFormat":1},{"version":"dfe54dab1fa4961a6bcfba68c4ca955f8b5bbeb5f2ab3c915aa7adaa2eabc03a","impliedFormat":1},{"version":"1251d53755b03cde02466064260bb88fd83c30006a46395b7d9167340bc59b73","impliedFormat":1},{"version":"47865c5e695a382a916b1eedda1b6523145426e48a2eae4647e96b3b5e52024f","impliedFormat":1},{"version":"4cdf27e29feae6c7826cdd5c91751cc35559125e8304f9e7aed8faef97dcf572","impliedFormat":1},{"version":"331b8f71bfae1df25d564f5ea9ee65a0d847c4a94baa45925b6f38c55c7039bf","impliedFormat":1},{"version":"2a771d907aebf9391ac1f50e4ad37952943515eeea0dcc7e78aa08f508294668","impliedFormat":1},{"version":"0146fd6262c3fd3da51cb0254bb6b9a4e42931eb2f56329edd4c199cb9aaf804","impliedFormat":1},{"version":"183f480885db5caa5a8acb833c2be04f98056bdcc5fb29e969ff86e07efe57ab","impliedFormat":99},{"version":"82e687ebd99518bc63ea04b0c3810fb6e50aa6942decd0ca6f7a56d9b9a212a6","impliedFormat":99},{"version":"7f698624bbbb060ece7c0e51b7236520ebada74b747d7523c7df376453ed6fea","impliedFormat":1},{"version":"8f07f2b6514744ac96e51d7cb8518c0f4de319471237ea10cf688b8d0e9d0225","impliedFormat":1},{"version":"257b83faa134d971c738a6b9e4c47e59bb7b23274719d92197580dd662bfafc3","impliedFormat":99},{"version":"3deed5e2a5f1e7590d44e65a5b61900158a3c38bac9048462d38b1bc8098bb2e","impliedFormat":99},{"version":"d435a43f89ed8794744c59d72ce71e43c1953338303f6be9ef99086faa8591d7","impliedFormat":99},{"version":"c085e9aa62d1ae1375794c1fb927a445fa105fed891a7e24edbb1c3300f7384a","impliedFormat":1},{"version":"f315e1e65a1f80992f0509e84e4ae2df15ecd9ef73df975f7c98813b71e4c8da","impliedFormat":1},{"version":"5b9586e9b0b6322e5bfbd2c29bd3b8e21ab9d871f82346cb71020e3d84bae73e","impliedFormat":1},{"version":"a4f64e674903a21e1594a24c3fc8583f3a587336d17d41ade46aa177a8ab889b","impliedFormat":99},{"version":"b6f69984ffcd00a7cbcef9c931b815e8872c792ed85d9213cb2e2c14c50ca63a","impliedFormat":99},{"version":"2bbc5abe5030aa07a97aabd6d3932ed2e8b7a241cf3923f9f9bf91a0addbe41f","impliedFormat":99},{"version":"1e5e5592594e16bcf9544c065656293374120eb8e78780fb6c582cc710f6db11","impliedFormat":99},{"version":"4abf1e884eecb0bf742510d69d064e33d53ac507991d6c573958356f920c3de4","impliedFormat":99},{"version":"44f1d2dd522c849ca98c4f95b8b2bc84b64408d654f75eb17ec78b8ceb84da11","impliedFormat":99},{"version":"89edc5e1739692904fdf69edcff9e1023d2213e90372ec425b2f17e3aecbaa4a","impliedFormat":99},{"version":"4a27c79c57a6692abb196711f82b8b07a27908c94652148d5469887836390116","impliedFormat":99},{"version":"f42400484f181c2c2d7557c0ed3b8baaace644a9e943511f3d35ac6be6eb5257","impliedFormat":99},{"version":"54b381d36b35df872159a8d3b52e8d852659ee805695a867a388c8ccbf57521b","impliedFormat":99},{"version":"c67b4c864ec9dcde25f7ad51b90ae9fe1f6af214dbd063d15db81194fe652223","impliedFormat":99},{"version":"7a4aa00aaf2160278aeae3cf0d2fc6820cf22b86374efa7a00780fbb965923ff","impliedFormat":99},{"version":"66e3ee0a655ff3698be0aef05f7b76ac34c349873e073cde46d43db795b79f04","impliedFormat":99},{"version":"48c411efce1848d1ed55de41d7deb93cbf7c04080912fd87aa517ed25ef42639","affectsGlobalScope":true,"impliedFormat":1},{"version":"28e065b6fb60a04a538b5fbf8c003d7dac3ae9a49eddc357c2a14f2ffe9b3185","affectsGlobalScope":true,"impliedFormat":99},{"version":"fe2d63fcfdde197391b6b70daf7be8c02a60afa90754a5f4a04bdc367f62793d","impliedFormat":99},{"version":"e7d5bcffc98eded65d620bc0b6707c307b79c21d97a5fb8601e8bdf2296026b6","impliedFormat":99},{"version":"69bf2422313487956e4dacf049f30cb91b34968912058d244cb19e4baa24da97","impliedFormat":99},{"version":"0d87708dafcde5468a130dfe64fac05ecad8328c298a4f0f2bd86603e5fd002e","impliedFormat":99},{"version":"a3f2554ba6726d0da0ffdc15b675b8b3de4aea543deebbbead845680b740a7fd","impliedFormat":99},{"version":"93dda0982b139b27b85dd2924d23e07ee8b4ca36a10be7bdf361163e4ffcc033","impliedFormat":99},{"version":"d7b652822e2a387fd2bcf0b78bcf2b7a9a9e73c4a71c12c5d0bbbb367aea6a87","affectsGlobalScope":true,"impliedFormat":99},{"version":"206c02f1322b7fe341d39bccf3f21ed2e1f9326d2290db5ccbd9b67eb0589abd","impliedFormat":99},{"version":"aa348c4fb2f8ac77df855f07fb66281c9f6e71746fdff3b13c7932aa7642b788","impliedFormat":99},{"version":"bffc26b61e686fac3370a4ebc19e1b9c890b0fe3111c461890a567b9efe21f71","signature":"4b96dd19fd2949d28ce80e913412b0026dc421e5bf6c31d87c7b5eb11b5753b4"},{"version":"6e9b7ee0fcfe9ce7df9fc8cd4734d4fc2bf2012905b34c082470b2fa723d99cc","signature":"95ad2d855b2f36fb6bd22e25bac416e16f760335ec81d6188e691e510683514e"},{"version":"4238361fc0bd1818e8107c06ba69b9a2d270f8ca3b07b269db7952e4b7ca2402","signature":"578254cc1e8fde0258e0503e3dfb945bba64327b68d20147dcc062209163e69f"},{"version":"f32a960d94658be49557e1ed00546200497b6474ff3bd66357ca6df475456125","signature":"fc7cf200608988086c100ef9b4001c2150fe391cc01e6274b8513d5d32da8739"},{"version":"e5bd60c2aa1f1bf75b8592e3e27bb54d4a82b1257189e060a91d3a2e0465e6bb","signature":"8587f65055af888bc291fbf4a501e325b4ccb8ed5685d6d9edcff876522e9e52"},{"version":"74c47e7e81f7d8f7f12b467702c0ce9963b8d9595f6d733143ea4ec8894277b0","signature":"86d9fc28cd7c7583334e569ba9364c2bc7fd99e027c3021376410f0d4dd2ba47"},{"version":"3433fba4c88f6c1e40a7ebbb47d7b379f0fcc219ca58e5959178cf0b8700dec6","signature":"585a4a3a1eef4f0d4e641b85c8972c3fb1d9c1827e7dee0f0ee17fae82701aeb"},{"version":"090db78ea04e0e1aef7c42dde45adf36b57274e8e06d0fdcac56f1f76316a99f","signature":"8a7d776a0348954718be6dc765fe9f2f70cbd22dba65b0af1ca7c2e673aca148"},{"version":"b39f8c4b7b9d7d0c65fded04efa898fd3f4f8478a3569974e1eaa4fbfd506105","signature":"63a04d2fd5db721c8d98a446731f733fba5c9c7563036159a86273666baedaad"},{"version":"f8d87a7186ffe03ec137b2348b980fb09e07790861420faed8d71b01cf96086b","signature":"9fb2f3429bcee8d5c659825ac2401688568e99eb229111ec735e6e96d98f1098"},"b4f81a096f6d17d52a4eca442a91291d2009fddb11dd622623d5410da1e1ba42","f7bef5f817dc4712e96ecbd8b90938477fa2c45f359668db1264d5a32df97796",{"version":"c8216bf04d864be7a2b5c3b44b0bb9667b9dda28b38b2644772333419df42cb5","signature":"cffc311272a8c64bc174f78722a6c5d793dc995e1ee21817cafa81cecc0a90e7"},{"version":"f87e6815313384e07e0a2fdd827c5f007d6b170792352241e92cba10608062af","signature":"0645a24a9b865cf04761543a2b16fd064a76b5542ae8a51e32325f4f2f8bcc74"},{"version":"9354c787f008d22beae6b71d4e04a2c00c642debf356658c1b46417fe825ae75","signature":"2acb714596c86e2790a66e1e5812a6ff2edd789fc833e7aace0c61bf37d34d2d"},{"version":"357eb419e49d3b37f783aa51e8122f74bf7f0c16a288a73fc23770588ed84371","signature":"b46c67dac6680db6b4a1823d0aa773bad93409cf338a6e53f7559c955ed8a41a"},{"version":"eb4d8ef9388511482dfcbbf90790b986d386b933cdcb89452bfcc8b9a9ded9ce","signature":"f3a981aea6e5e80d551346f7e44d047dffbe89d2e987fdd9f8decac795c2e25a"},{"version":"f2d4ceeae858ca773d7dc3af1b7e4b083d6df91117160a3490fda199f0fd77b7","signature":"5482433fe0667e87a55966a30f4389c1bcdb914c2d74f1037bc2651735cac91f"},{"version":"c1a2e05eb6d7ca8d7e4a7f4c93ccf0c2857e842a64c98eaee4d85841ee9855e6","impliedFormat":1},{"version":"835fb2909ce458740fb4a49fc61709896c6864f5ce3db7f0a88f06c720d74d02","impliedFormat":1},{"version":"6e5857f38aa297a859cab4ec891408659218a5a2610cd317b6dcbef9979459cc","impliedFormat":1},{"version":"ead8e39c2e11891f286b06ae2aa71f208b1802661fcdb2425cffa4f494a68854","impliedFormat":1},{"version":"82919acbb38870fcf5786ec1292f0f5afe490f9b3060123e48675831bd947192","impliedFormat":1},{"version":"e222701788ec77bd57c28facbbd142eadf5c749a74d586bc2f317db7e33544b1","impliedFormat":1},{"version":"09154713fae0ed7befacdad783e5bd1970c06fc41a5f866f7f933b96312ce764","impliedFormat":1},{"version":"8d67b13da77316a8a2fabc21d340866ddf8a4b99e76a6c951cc45189142df652","impliedFormat":1},{"version":"a91c8d28d10fee7fe717ddf3743f287b68770c813c98f796b6e38d5d164bd459","impliedFormat":1},{"version":"68add36d9632bc096d7245d24d6b0b8ad5f125183016102a3dad4c9c2438ccb0","impliedFormat":1},{"version":"3a819c2928ee06bbcc84e2797fd3558ae2ebb7e0ed8d87f71732fb2e2acc87b4","impliedFormat":1},{"version":"f6f827cd43e92685f194002d6b52a9408309cda1cec46fb7ca8489a95cbd2fd4","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"e0bfe601a9fdf6defe94ed62dc60ac71597566001a1f86e705c95e431a9c816d","impliedFormat":1},{"version":"a270a1a893d1aee5a3c1c8c276cd2778aa970a2741ee2ccf29cc3210d7da80f5","impliedFormat":1},{"version":"add0ce7b77ba5b308492fa68f77f24d1ed1d9148534bdf05ac17c30763fc1a79","impliedFormat":1},{"version":"8926594ee895917e90701d8cbb5fdf77fc238b266ac540f929c7253f8ad6233d","impliedFormat":1},{"version":"2f67911e4bf4e0717dc2ded248ce2d5e4398d945ee13889a6852c1233ea41508","impliedFormat":1},{"version":"d8430c275b0f59417ea8e173cfb888a4477b430ec35b595bf734f3ec7a7d729f","impliedFormat":1},{"version":"69364df1c776372d7df1fb46a6cb3a6bf7f55e700f533a104e3f9d70a32bec18","impliedFormat":1},{"version":"6042774c61ece4ba77b3bf375f15942eb054675b7957882a00c22c0e4fe5865c","impliedFormat":1},{"version":"5a3bd57ed7a9d9afef74c75f77fce79ba3c786401af9810cdf45907c4e93f30e","impliedFormat":1},{"version":"ed8763205f02fb65e84eff7432155258df7f93b7d938f01785cb447d043d53f3","impliedFormat":1},{"version":"30db853bb2e60170ba11e39ab48bacecb32d06d4def89eedf17e58ebab762a65","impliedFormat":1},{"version":"e27451b24234dfed45f6cf22112a04955183a99c42a2691fb4936d63cfe42761","impliedFormat":1},{"version":"2316301dd223d31962d917999acf8e543e0119c5d24ec984c9f22cb23247160c","impliedFormat":1},{"version":"58d65a2803c3b6629b0e18c8bf1bc883a686fcf0333230dd0151ab6e85b74307","impliedFormat":1},{"version":"e818471014c77c103330aee11f00a7a00b37b35500b53ea6f337aefacd6174c9","impliedFormat":1},{"version":"d4a5b1d2ff02c37643e18db302488cd64c342b00e2786e65caac4e12bda9219b","impliedFormat":1},{"version":"29f823cbe0166e10e7176a94afe609a24b9e5af3858628c541ff8ce1727023cd","impliedFormat":1},{"version":"0d6bac122edc4467df664b6528887e7ede96cb5ddb5c6354a4f0c8cccdfaf387","signature":"7c0ea9ee3fc36ef6345257d512f6384b6b46f53ad1148a3b6ce42753c40797ce"},{"version":"488e567d874e60a60ce5427fa00a2de99c868ce4e8d41bfd0a1fe36d699e0bcd","signature":"f6654859c51cdcad09e09551c85f94b947f202689f8cc6acaa1f20434b8f30b5"},{"version":"1290d043cee0b5ccebfb580deb56216de624a79f66d9e86d6520b4f3be193923","signature":"38209e213238420b13fe65bd1f8ca88a5429e13e2a14cf8c8448ad0dd7c82538"},"efb284fc203392dfd272b79b67018a8527a373a1a61f8d487baaa3b857828b19","43978c7566d5b634934f1a77f0d0bd467c6b46b8f17a430c68c305339813fc12",{"version":"2ca1e96f80f1f8f85c5efaac2f6b568a928d2d1af87adbd58f9ae1fa800bc0a4","signature":"ab7b53541372d8b9da15b9fe54c9c49d43fe829dad58d09440db388760b0a0f0"},{"version":"338f518acf43ecd67b76cddec413656ff2d3ab1dbac674626847734a6269a355","signature":"6086cda58ed2a3b15655ee9520d64bc4e794bbf97b145e4d9839dae200d3796a"},{"version":"6c69d71ca45d7da75ad59eee02e31fd488edc01b9e35780bc143bcfa436f586e","signature":"37f36d8749ed34c02b68aa781321589af8de17e08579a768e3f364978b0f33fd"},"72fe51845f22afe54b62e3c7a6607f0defaa464246326c4382c914ffbe6fcf27","f234eee92118bca2121ce93c7bb99423c9ec7b2e3faf3226af4aca4a2cc9be42",{"version":"af31e2be633139e2d1a5607c3b942618734eb8554ad7a16ff1b3c2c4eff479ce","signature":"ce488622793573d253e0ba00570b8abf66b288f107de6e0e0d1f2c53cd2ebb4e"},{"version":"be4ba7e269ca10088df9f86c1c5842c0a96521fcced848721fdbe2e5e5c5d850","signature":"f2fbef065f1a6fafca6a29c5ca1a8b9c8606da8b36f181007bcdb4dc06dfa5e5"},{"version":"eae16175a154d3591fe04192b42254d9ca81f667c1f1cb070bf2c7e747b68eb9","signature":"175008e887f314e090fb2a41236d870986111772a935e63a7f4456c2b3201b3a"},{"version":"82f65cfcc7535c9327c1001b19d457b7de220e9dff39c426d8c022e0f11a19d1","signature":"14dec3c2c5d9359d505e1b8859a8f1b79f2d7c6637f36eaf6608df61be7bd65b"},{"version":"89121c1bf2990f5219bfd802a3e7fc557de447c62058d6af68d6b6348d64499a","impliedFormat":1},{"version":"79b4369233a12c6fa4a07301ecb7085802c98f3a77cf9ab97eee27e1656f82e6","impliedFormat":1},{"version":"2b37ba54ec067598bf912d56fcb81f6d8ad86a045c757e79440bdef97b52fe1b","impliedFormat":99},{"version":"1bc9dd465634109668661f998485a32da369755d9f32b5a55ed64a525566c94b","impliedFormat":99},{"version":"5702b3c2f5d248290ed99419d77ca1cc3e6c29db5847172377659c50e6303768","impliedFormat":99},{"version":"9764b2eb5b4fc0b8951468fb3dbd6cd922d7752343ef5fbf1a7cd3dfcd54a75e","impliedFormat":99},{"version":"1fc2d3fe8f31c52c802c4dee6c0157c5a1d1f6be44ece83c49174e316cf931ad","impliedFormat":99},{"version":"dc4aae103a0c812121d9db1f7a5ea98231801ed405bf577d1c9c46a893177e36","impliedFormat":99},{"version":"106d3f40907ba68d2ad8ce143a68358bad476e1cc4a5c710c11c7dbaac878308","impliedFormat":99},{"version":"42ad582d92b058b88570d5be95393cf0a6c09a29ba9aa44609465b41d39d2534","impliedFormat":99},{"version":"36e051a1e0d2f2a808dbb164d846be09b5d98e8b782b37922a3b75f57ee66698","impliedFormat":99},{"version":"d4a22007b481fe2a2e6bfd3a42c00cd62d41edb36d30fc4697df2692e9891fc8","impliedFormat":1},{"version":"9d62e577adb05f5aafed137e747b3a1b26f8dce7b20f350d22f6fb3255a3c0ed","impliedFormat":99},{"version":"7ed92bcef308af6e3925b3b61c83ad6157a03ff15c7412cf325f24042fe5d363","impliedFormat":99},{"version":"3da9062d0c762c002b7ab88187d72e1978c0224db61832221edc8f4eb0b54414","impliedFormat":99},{"version":"84dbf6af43b0b5ad42c01e332fddf4c690038248140d7c4ccb74a424e9226d4d","impliedFormat":99},{"version":"00884fc0ea3731a9ffecffcde8b32e181b20e1039977a8ae93ae5bce3ab3d245","impliedFormat":99},{"version":"0bd8b6493d9bf244afe133ccb52d32d293de8d08d15437cca2089beed5f5a6b5","impliedFormat":99},{"version":"7fc3099c95752c6e7b0ea215915464c7203e835fcd6878210f2ce4f0dcbbfe67","impliedFormat":99},{"version":"83b5499dbc74ee1add93aef162f7d44b769dcef3a74afb5f80c70f9a5ce77cc0","impliedFormat":99},{"version":"8bf8b772b38fc4da471248320f49a2219c363a9669938c720e0e0a5a2531eabf","impliedFormat":99},{"version":"7da6e8c98eacf084c961e039255f7ebb9d97a43377e7eee2695cb77fec640c66","impliedFormat":99},{"version":"0b5b064c5145a48cd3e2a5d9528c63f49bac55aa4bc5f5b4e68a160066401375","impliedFormat":99},{"version":"702ff40d28906c05d9d60b23e646c2577ad1cc7cd177d5c0791255a2eab13c07","impliedFormat":99},{"version":"49ff0f30d6e757d865ae0b422103f42737234e624815eee2b7f523240aa0c8f8","impliedFormat":99},{"version":"0389aacf0ffd49a877a46814a21a4770f33fc33e99951a1584de866c8e971993","impliedFormat":99},{"version":"5cb7a51cf151c1056b61f078cf80b811e19787d1f29a33a2a6e4bf00334bbc10","impliedFormat":99},{"version":"215aa8915d707f97ad511b7abbf7eda51d3a7048e9a656955cf0dda767ae7db0","impliedFormat":99},{"version":"0d689a717fbef83da07ab4de33f83db5cbcec9bc4e3b04edb106c538a50a0210","impliedFormat":99},{"version":"d00bc73e8d1f4137f2f6238bb3aa2bbdad8573658cc95920e2cdfa7ad491a8d8","impliedFormat":99},{"version":"e3667aa9f5245d1a99fb4a2a1ac48daf1429040c29cc0d262e3843f9ae3b9d65","impliedFormat":99},{"version":"08c0f3222b50ec2b534be1a59392660102549129246425d33ec43f35aa051dc6","impliedFormat":99},{"version":"612fb780f312e6bb3c40f3cb2b827ea7455b922198f651c799d844fdd44cf2e9","impliedFormat":99},{"version":"bcd98e8f44bc76e4fcb41e4b1a8bab648161a942653a3d1f261775a891d258de","impliedFormat":99},{"version":"5abaa19aa91bb4f63ea58154ada5d021e33b1f39aa026ca56eb95f13b12c497a","impliedFormat":99},{"version":"356a18b0c50f297fee148f4a2c64b0affd352cbd6f21c7b6bfa569d30622c693","impliedFormat":99},{"version":"5876027679fd5257b92eb55d62efee634358012b9f25c5711ad02b918e52c837","impliedFormat":99},{"version":"f5622423ee5642dcf2b92d71b37967b458e8df3cf90b468675ff9fddaa532a0f","impliedFormat":99},{"version":"70265bc75baf24ec0d61f12517b91ea711732b9c349fceef71a446c4ff4a247a","impliedFormat":99},{"version":"41a4b2454b2d3a13b4fc4ec57d6a0a639127369f87da8f28037943019705d619","impliedFormat":99},{"version":"e9b82ac7186490d18dffaafda695f5d975dfee549096c0bf883387a8b6c3ab5a","impliedFormat":99},{"version":"eed9b5f5a6998abe0b408db4b8847a46eb401c9924ddc5b24b1cede3ebf4ee8c","impliedFormat":99},{"version":"af85fde8986fdad68e96e871ae2d5278adaf2922d9879043b9313b18fae920b1","impliedFormat":99},{"version":"8a1f5d2f7cf4bf851cc9baae82056c3316d3c6d29561df28aff525556095554b","impliedFormat":99},{"version":"a5dbd4c9941b614526619bad31047ddd5f504ec4cdad88d6117b549faef34dd3","impliedFormat":99},{"version":"e87873f06fa094e76ac439c7756b264f3c76a41deb8bc7d39c1d30e0f03ef547","impliedFormat":99},{"version":"488861dc4f870c77c2f2f72c1f27a63fa2e81106f308e3fc345581938928f925","impliedFormat":99},{"version":"eff73acfacda1d3e62bb3cb5bc7200bb0257ea0c8857ce45b3fee5bfec38ad12","impliedFormat":99},{"version":"aff4ac6e11917a051b91edbb9a18735fe56bcfd8b1802ea9dbfb394ad8f6ce8e","impliedFormat":99},{"version":"1f68aed2648740ac69c6634c112fcaae4252fbae11379d6eabee09c0fbf00286","impliedFormat":99},{"version":"5e7c2eff249b4a86fb31e6b15e4353c3ddd5c8aefc253f4c3e4d9caeb4a739d4","impliedFormat":99},{"version":"14c8d1819e24a0ccb0aa64f85c61a6436c403eaf44c0e733cdaf1780fed5ec9f","impliedFormat":99},{"version":"011423c04bfafb915ceb4faec12ea882d60acbe482780a667fa5095796c320f8","impliedFormat":99},{"version":"f8eb2909590ec619643841ead2fc4b4b183fbd859848ef051295d35fef9d8469","impliedFormat":99},{"version":"fe784567dd721417e2c4c7c1d7306f4b8611a4f232f5b7ce734382cf34b417d2","impliedFormat":99},{"version":"45d1e8fb4fd3e265b15f5a77866a8e21870eae4c69c473c33289a4b971e93704","impliedFormat":99},{"version":"cd40919f70c875ca07ecc5431cc740e366c008bcbe08ba14b8c78353fb4680df","impliedFormat":99},{"version":"ddfd9196f1f83997873bbe958ce99123f11b062f8309fc09d9c9667b2c284391","impliedFormat":99},{"version":"2999ba314a310f6a333199848166d008d088c6e36d090cbdcc69db67d8ae3154","impliedFormat":99},{"version":"62c1e573cd595d3204dfc02b96eba623020b181d2aa3ce6a33e030bc83bebb41","impliedFormat":99},{"version":"ca1616999d6ded0160fea978088a57df492b6c3f8c457a5879837a7e68d69033","impliedFormat":99},{"version":"835e3d95251bbc48918bb874768c13b8986b87ea60471ad8eceb6e38ddd8845e","impliedFormat":99},{"version":"de54e18f04dbcc892a4b4241b9e4c233cfce9be02ac5f43a631bbc25f479cd84","impliedFormat":99},{"version":"453fb9934e71eb8b52347e581b36c01d7751121a75a5cd1a96e3237e3fd9fc7e","impliedFormat":99},{"version":"bc1a1d0eba489e3eb5c2a4aa8cd986c700692b07a76a60b73a3c31e52c7ef983","impliedFormat":99},{"version":"4098e612efd242b5e203c5c0b9afbf7473209905ab2830598be5c7b3942643d0","impliedFormat":99},{"version":"28410cfb9a798bd7d0327fbf0afd4c4038799b1d6a3f86116dc972e31156b6d2","impliedFormat":99},{"version":"514ae9be6724e2164eb38f2a903ef56cf1d0e6ddb62d0d40f155f32d1317c116","impliedFormat":99},{"version":"970e5e94a9071fd5b5c41e2710c0ef7d73e7f7732911681592669e3f7bd06308","impliedFormat":99},{"version":"491fb8b0e0aef777cec1339cb8f5a1a599ed4973ee22a2f02812dd0f48bd78c1","impliedFormat":99},{"version":"6acf0b3018881977d2cfe4382ac3e3db7e103904c4b634be908f1ade06eb302d","impliedFormat":99},{"version":"2dbb2e03b4b7f6524ad5683e7b5aa2e6aef9c83cab1678afd8467fde6d5a3a92","impliedFormat":99},{"version":"135b12824cd5e495ea0a8f7e29aba52e1adb4581bb1e279fb179304ba60c0a44","impliedFormat":99},{"version":"e4c784392051f4bbb80304d3a909da18c98bc58b093456a09b3e3a1b7b10937f","impliedFormat":99},{"version":"2e87c3480512f057f2e7f44f6498b7e3677196e84e0884618fc9e8b6d6228bed","impliedFormat":99},{"version":"66984309d771b6b085e3369227077da237b40e798570f0a2ddbfea383db39812","impliedFormat":99},{"version":"e41be8943835ad083a4f8a558bd2a89b7fe39619ed99f1880187c75e231d033e","impliedFormat":99},{"version":"260558fff7344e4985cfc78472ae58cbc2487e406d23c1ddaf4d484618ce4cfd","impliedFormat":99},{"version":"413d50bc66826f899c842524e5f50f42d45c8cb3b26fd478a62f26ac8da3d90e","impliedFormat":99},{"version":"d9083e10a491b6f8291c7265555ba0e9d599d1f76282812c399ab7639019f365","impliedFormat":99},{"version":"09de774ebab62974edad71cb3c7c6fa786a3fda2644e6473392bd4b600a9c79c","impliedFormat":99},{"version":"e8bcc823792be321f581fcdd8d0f2639d417894e67604d884c38b699284a1a2a","impliedFormat":99},{"version":"7c99839c518dcf5ab8a741a97c190f0703c0a71e30c6d44f0b7921b0deec9f67","impliedFormat":99},{"version":"44c14e4da99cd71f9fe4e415756585cec74b9e7dc47478a837d5bedfb7db1e04","impliedFormat":99},{"version":"1f46ee2b76d9ae1159deb43d14279d04bcebcb9b75de4012b14b1f7486e36f82","impliedFormat":99},{"version":"2838028b54b421306639f4419606306b940a5c5fcc5bc485954cbb0ab84d90f4","impliedFormat":99},{"version":"7116e0399952e03afe9749a77ceaca29b0e1950989375066a9ddc9cb0b7dd252","impliedFormat":99},{"version":"19990350fca066265b2c190c9b6cde1229f35002ea2d4df8c9e397e9942f6c89","impliedFormat":99},{"version":"8fb8fdda477cd7382477ffda92c2bb7d9f7ef583b1aa531eb6b2dc2f0a206c10","impliedFormat":99},{"version":"66995b0c991b5c5d42eff1d950733f85482c7419f7296ab8952e03718169e379","impliedFormat":99},{"version":"9863f888da357e35e013ca3465b794a490a198226bd8232c2f81fb44e16ff323","impliedFormat":99},{"version":"84bc2d80326a83ee4a6e7cba2fd480b86502660770c0e24da96535af597c9f1e","impliedFormat":99},{"version":"ea27768379b866ee3f5da2419650acdb01125479f7af73580a4bceb25b79e372","impliedFormat":99},{"version":"598931eeb4362542cae5845f95c5f0e45ac668925a40ce201e244d7fe808e965","impliedFormat":99},{"version":"da9ef88cde9f715756da642ad80c4cd87a987f465d325462d6bc2a0b11d202c8","impliedFormat":99},{"version":"b4c6184d78303b0816e779a48bef779b15aea4a66028eb819aac0abee8407dea","impliedFormat":99},{"version":"db085d2171d48938a99e851dafe0e486dce9859e5dfa73c21de5ed3d4d6fb0c5","impliedFormat":99},{"version":"62a3ad1ddd1f5974b3bf105680b3e09420f2230711d6520a521fab2be1a32838","impliedFormat":99},{"version":"a77be6fc44c876bc10c897107f84eaba10790913ebdcad40fcda7e47469b2160","impliedFormat":99},{"version":"06cf55b6da5cef54eaaf51cdc3d4e5ebf16adfdd9ebd20cec7fe719be9ced017","impliedFormat":99},{"version":"91f5dbcdb25d145a56cffe957ec665256827892d779ef108eb2f3864faff523b","impliedFormat":99},{"version":"052ba354bab8fb943e0bc05a0769f7b81d7c3b3c6cd0f5cfa53c7b2da2a525c5","impliedFormat":99},{"version":"927955a3de5857e0a1c575ced5a4245e74e6821d720ed213141347dd1870197f","impliedFormat":99},{"version":"fec804d54cd97dd77e956232fc37dc13f53e160d4bbeeb5489e86eeaa91f7ebd","impliedFormat":99},{"version":"b519d63d817bd0f3a5e639d53d26ff066d59108aae142e0500c11fb651c73171","impliedFormat":99},{"version":"e15c785e33f656752ce3192ad88d240a91ce9eb9d5c5d254220439351c84f42e","impliedFormat":99},{"version":"aca7993c58cb5a83a58d11b31947c91174ba1847d5a6d7d11f289b09a2efb2ac","impliedFormat":99},{"version":"4e3ab6678655e507463a9bfa1aa39a4a5497fac4c75e5f7f7a16c0b7d001c34a","impliedFormat":99},{"version":"3541c2528f6e525c4078187bed33f260ee5b525f4f72c314e2132b0b23388e88","signature":"ec853f4fe95cdcafa1ddbefeaabad88e49cd2dd4b7106c5c8dcd1dfe913bde29"},{"version":"9587dc7d8bc0a09984d6e281e79398aaa5b2837147a56b409ece029c4861083e","signature":"4b270192860c30ce1019e3ee3a17e4184084a5d80d2c59d7614ac0ded20078c8"},{"version":"399ed022a4ae0f9d13d60ede82e8d50998dca202da780e0f6b728510f65ecf2b","signature":"4db92824376122be58fcfbeea8402f8a70b3342211cc179b5157eff7dbabe989"},{"version":"4519748cd238255308f18ca8da3bc7bf41c4f57b269d76e38ca738793f6a2e87","signature":"cee17c21f3f94dfb56e36470677d70da6ab840c8f548c02a601a63415d356b7b"},{"version":"e8a5952c50941e7a7dcad7a6bedd3d534e86a230ea46e398a87476edc9317816","signature":"401b305dbef03ae3be9b6fd992456a0e6bae4452089edf0c43f0f9d207ca392e"},{"version":"374474375a355c2333802cc06084f27de58e14e3e803124dda0fc184a9fd0f62","signature":"07496811b1c68db6b5652a7afdf3946b36657447a19462dac0972f4247015c39"},{"version":"b45ed3d614a32fe73734d67f43dc3c26398a7fc23abcae0eaffc0aeb48d12f32","signature":"8319d6502562484ed1b88dbe68beb3deb61401f20536eb0398761d40e00a58e5"},{"version":"b8f3b433ad08b0d702217e7d109f58e9b893062715eb33383eaccc24dcd2f838","signature":"73858990755e16bdf3c9876ce7c1dfcf1f9ffaa68552697b76e46f3b340643f5"},{"version":"4d7d964609a07368d076ce943b07106c5ebee8138c307d3273ba1cf3a0c3c751","impliedFormat":99},{"version":"0e48c1354203ba2ca366b62a0f22fec9e10c251d9d6420c6d435da1d079e6126","impliedFormat":99},{"version":"0662a451f0584bb3026340c3661c3a89774182976cd373eca502a1d3b5c7b580","impliedFormat":99},{"version":"68219da40672405b0632a0a544d1319b5bfe3fa0401f1283d4c9854b0cc114ce","impliedFormat":99},{"version":"ee40ce45ec7c5888f0c1042abc595649d08f51e509af2c78c77403f1db75482a","impliedFormat":99},{"version":"7841bca23a8296afd82fd036fc8d3b1fed3c1e0c82ee614254693ccd47e916fc","impliedFormat":99},{"version":"b09c433ed46538d0dc7e40f49a9bf532712221219761a0f389e60349c59b3932","impliedFormat":99},{"version":"2fe97c700340d65f35f1bf31a74e2a530d04f47fc2ce7423d4880216452ab085","impliedFormat":99},{"version":"0bb0e644293820a5cc705591150eb1b49ae6b2349636206079aa248333564267","impliedFormat":99},{"version":"4b6a9eda3909125e26a88e76f2906be6735ccff4776a29e68183dd051208273a","impliedFormat":99},{"version":"5aa44b5aa837ac0118866ea555a2fb50726df465ef8a13c7113cae4faac6be6b","signature":"567f2f925c62705cebcf94823b5fc385dd58a81d6906331ed9efdf46819ddd44"},{"version":"b6a3764a309a100775bf36d4e2c43a7f0467faec0f435f90156810ab81bfb1ac","signature":"3fb9d7c7255117ac74bc6f13b4e59c6210e92fc4cc1246def11ae1d6c0c7340f"},{"version":"b131ac8e291593a007372afb7ffd50aea26aa98be68602da47333c58fe308e92","signature":"71efdadca438b0901327640242ebd70151aff12b75ad9a8f1b8289b87316662c"},{"version":"bfe14194cd9ef4223ca1d900616ac559e91465c5b5f24dd98c321d4773f990c1","signature":"0fb213a961b39b1967b0c4ea469612c569fbc47fdffa9efd0fac86be82f0f7ab"},{"version":"89ad68ff5b5cd60f6fb336eccc85c5fb14f43df3e1798eb4043a12d2361f1238","signature":"546623da4d68be7ef75b1631c7ce51b7cce62b3888615bb7a9723768b9522590"},{"version":"677bd346810365560f41b02f013cc67d9fb1057cbb2ed6307a91ae2c56f7d49b","signature":"0c74e2b2d2efa9cd29b0656b22734c019a5ec83aa8304c6d9eac80a2fd04d439"},{"version":"ea3fe330206a462a0798c8873fbd7f7f6d22306fa84da4136e94cfd467e2fa8a","signature":"f6242668302365e05d97247aa023dc4b0afb5b0794f363d0e37c8deb3085bbbf"},{"version":"16d0ae46bfd0a682d1d7e0d1a922c7cb193ed42bd13acfee524f2f2b46aaa1f6","signature":"61512b22b1dc59ef1b411a3e7d1285ec7981a017c14d04de75db6020be01519d"},{"version":"d42d8cfca643a06f4acc968c6d160617b30d8c89e8d8a060a31bc45db5c1c3a5","signature":"03449db3039b4b18e23b1b0ecc3b8d37945fbada4c58ffcf578f821e95cd131b"},{"version":"079d839deae2b349484d82e2df54fa9abf2221c6e793cd58615a4e64a8bbb95d","signature":"63a393a25c5ba97c5dca3b5892ed718d40dcb8ea5e2a7109da779e445829d522"},{"version":"edbacb7ea81bfece5c76e527cea0e9138ac12603dea58aca65bc28c22f502de8","signature":"8b6b5e8ffeb94c004e22382801e2bcc624473d8ebb0849aff061d9d5a4b7c795"},{"version":"1afc179a3f16cddacb367363419b0a1fd8a06c623cc725eb224525d086e5dedb","signature":"ac8ad2520fba31fc23dfffa307833c2390baf13c25ce16e4f5ad446630c44efe"},{"version":"0dac1596740c5979b3534bddd05fd57acd15723bfe18e09a5c896a023a1a2729","signature":"54dc9bb6423424e9066bd109cbc984b80afcd81e28fe6c1ed375580061710faf"},{"version":"22492760f9f2b37bb82f8d669176988ff5fa192c56d307932445ae5b7bb07e76","signature":"929d96e0eb0f1d8ef6dfeb2ed24e0a68d67803353e805966210fa871b32ee3e2"},{"version":"4ac33dcf08672630184b4385ece43528ce33be4d42269d955fec41af645c19d1","signature":"8b781be231d4388ac608283ef322b07c8671f899ee0603c065135261815cb6d9"},{"version":"d64f5a337ed0f41879325ab3fcc4841d3b6556be25ba5b7558ffbcdd7ddc37fa","signature":"012235ccd0a6ab1aa061cb010b3bece07f18a1115d02d693e6b81da68793ba93"},{"version":"217d43fc17284c983876cf1ed09008a9e9c05766188d40b47ddf6d5293314ff1","signature":"3715987f5c065c44cacbd6d52c3803530c79cad931f1f46abab93a82189381d9"},{"version":"f5560955ab889c34f6226cbbe14ffe28feb4dc132152bd1d6062fe0729600c9a","signature":"771a2ed15ecb4700a53c5fd8609a54d52d878f3a28b6a866a75d02b16448a527"},{"version":"55329fd487bf3f77981cfd74b120fd63fc2d130ec05f8f9e3fd6929f1f8fa82d","signature":"290cd725edec6429f8e99813a9699208d6dc8f298e9e809326164ee536e8f768"},{"version":"27856dd1f3536f6a889b7f5b86070392b7ea6841e7c82d4829cc0a3561212748","signature":"e4e8d74814886d9430529dc031eefa006e48ef2389a1b2fb8e9e03be9cefde39"},"ef1934a00183208fd8c96be6cb64c506d46b79755a0c48fbe345e8ac33ef52a0",{"version":"cb80558784fc93165b64809b3ba66266d10585d838709ebf5e4576f63f9f2929","impliedFormat":99},{"version":"dfa6bb848807bc5e01e84214d4ec13ee8ffe5e1142546dcbb32065783a5db468","impliedFormat":99},{"version":"2f1ffc29f9ba7b005c0c48e6389536a245837264c99041669e0b768cfab6711d","impliedFormat":99},{"version":"b4270f889835e50044bf80e479fef2482edd69daf4b168f9e3ee34cf817ae41a","impliedFormat":99},{"version":"24532bf42e969683a5fd3f3a6191eaaabbbfa71f66f360bf86f6dc54f73a8552","signature":"8e609bb71c20b858c77f0e9f90bb1319db8477b13f9f965f1a1e18524bf50881"},{"version":"84bcc7c6b06f4d643a55dc63b56be0c81d990f8d549b66ea615c553268774dc3","impliedFormat":1},{"version":"2d225e7bda2871c066a7079c88174340950fb604f624f2586d3ea27bb9e5f4ff","impliedFormat":1},{"version":"6a785f84e63234035e511817dd48ada756d984dd8f9344e56eb8b2bdcd8fd001","impliedFormat":1},{"version":"c1422d016f7df2ccd3594c06f2923199acd09898f2c42f50ea8159f1f856f618","impliedFormat":1},{"version":"2973b1b7857ca144251375b97f98474e9847a890331e27132d5a8b3aea9350a8","impliedFormat":1},{"version":"0eb6152d37c84d6119295493dfcc20c331c6fda1304a513d159cdaa599dcb78b","impliedFormat":1},{"version":"237df26f8c326ca00cd9d2deb40214a079749062156386b6d75bdcecc6988a6b","impliedFormat":1},{"version":"cd44995ee13d5d23df17a10213fed7b483fabfd5ea08f267ab52c07ce0b6b4da","impliedFormat":1},{"version":"58ce1486f851942bd2d3056b399079bc9cb978ec933fe9833ea417e33eab676e","impliedFormat":1},{"version":"7557d4d7f19f94341f4413575a3453ba7f6039c9591015bcf4282a8e75414043","impliedFormat":1},{"version":"a3b2cc16f3ce2d882eca44e1066f57a24751545f2a5e4a153d4de31b4cac9bb5","impliedFormat":1},{"version":"ac2b3b377d3068bfb6e1cb8889c99098f2c875955e2325315991882a74d92cc8","impliedFormat":1},{"version":"8deb39d89095469957f73bd194d11f01d9894b8c1f1e27fbf3f6e8122576b336","impliedFormat":1},{"version":"a38a9c41f433b608a0d37e645a31eecf7233ef3d3fffeb626988d3219f80e32f","impliedFormat":1},{"version":"8e1428dcba6a984489863935049893631170a37f9584c0479f06e1a5b1f04332","impliedFormat":1},{"version":"1fce9ecb87a2d3898941c60df617e52e50fb0c03c9b7b2ba8381972448327285","impliedFormat":1},{"version":"5ef0597b8238443908b2c4bf69149ed3894ac0ddd0515ac583d38c7595b151f1","impliedFormat":1},{"version":"ac52b775a80badff5f4ac329c5725a26bd5aaadd57afa7ad9e98b4844767312a","impliedFormat":1},{"version":"6ae5b4a63010c82bf2522b4ecfc29ffe6a8b0c5eea6b2b35120077e9ac54d7a1","impliedFormat":1},{"version":"dd7109c49f416f218915921d44f0f28975df78e04e437c62e1e1eb3be5e18a35","impliedFormat":1},{"version":"eee181112e420b345fc78422a6cc32385ede3d27e2eaf8b8c4ad8b2c29e3e52e","impliedFormat":1},{"version":"25fbe57c8ee3079e2201fe580578fab4f3a78881c98865b7c96233af00bf9624","impliedFormat":1},{"version":"62cc8477858487b4c4de7d7ae5e745a8ce0015c1592f398b63ee05d6e64ca295","impliedFormat":1},{"version":"cc2a9ec3cb10e4c0b8738b02c31798fad312d21ef20b6a2f5be1d077e9f5409d","impliedFormat":1},{"version":"4b4fadcda7d34034737598c07e2dca5d7e1e633cb3ba8dd4d2e6a7782b30b296","impliedFormat":1},{"version":"360fdc8829a51c5428636f1f83e7db36fef6c5a15ed4411b582d00a1c2bd6e97","impliedFormat":1},{"version":"1cf0d15e6ab1ecabbf329b906ae8543e6b8955133b7f6655f04d433e3a0597ab","impliedFormat":1},{"version":"7c9f98fe812643141502b30fb2b5ec56d16aaf94f98580276ae37b7924dd44a4","impliedFormat":1},{"version":"b3547893f24f59d0a644c52f55901b15a3fa1a115bc5ea9a582911469b9348b7","impliedFormat":1},{"version":"596e5b88b6ca8399076afcc22af6e6e0c4700c7cd1f420a78d637c3fb44a885e","impliedFormat":1},{"version":"adddf736e08132c7059ee572b128fdacb1c2650ace80d0f582e93d097ed4fbaf","impliedFormat":1},{"version":"d4cad9dc13e9c5348637170ddd5d95f7ed5fdfc856ddca40234fa55518bc99a6","impliedFormat":1},{"version":"d70675ba7ba7d02e52b7070a369957a70827e4b2bca2c1680c38a832e87b61fd","impliedFormat":1},{"version":"3be71f4ce8988a01e2f5368bdd58e1d60236baf511e4510ee9291c7b3729a27e","impliedFormat":1},{"version":"423d2ccc38e369a7527988d682fafc40267bcd6688a7473e59c5eea20a29b64f","impliedFormat":1},{"version":"2f9fde0868ed030277c678b435f63fcf03d27c04301299580a4017963cc04ce6","impliedFormat":1},{"version":"feeb73d48cc41c6dd23d17473521b0af877751504c30c18dc84267c8eeea429a","impliedFormat":1},{"version":"25f1159094dc0bf3a71313a74e0885426af21c5d6564a254004f2cadf9c5b052","impliedFormat":1},{"version":"cde493e09daad4bb29922fe633f760be9f0e8e2f39cdca999cce3b8690b5e13a","impliedFormat":1},{"version":"3d7f9eb12aface876f7b535cc89dcd416daf77f0b3573333f16ec0a70bcf902a","impliedFormat":1},{"version":"b83139ae818dd20f365118f9999335ca4cd84ae518348619adc5728e7e0372d5","impliedFormat":1},{"version":"e0205f04611bea8b5b82168065b8ef1476a8e96236201494eb8c785331c43118","impliedFormat":1},{"version":"62d26d8ba4fa15ab425c1b57a050ed76c5b0ecbffaa53f182110aa3a02405a07","impliedFormat":1},{"version":"9941cbf7ca695e95d588f5f1692ab040b078d44a95d231fa9a8f828186b7b77d","impliedFormat":1},{"version":"41b8775befd7ded7245a627e9f4de6110236688ce4c124d2d40c37bc1a3bfe05","impliedFormat":1},{"version":"18992725cbd51b0846132ec46237bc7de4da1db440deb66a6242e2de8715dcfb","impliedFormat":1},{"version":"44f29187cfbc7aa4a6109204c8e5186509abc3b78874a2ee1498c51ab50f0f62","impliedFormat":1},{"version":"19ab78c1376c16e18c5b87dfa750813c935f0c4ce1d6ef88058ec38f9cf5ef08","impliedFormat":1},{"version":"38c6247d03b91143884f2ec03333c8b0e0479a49c9b8ae2b398971c5b8056e4a","signature":"85c47bc309528f245f38f0bb576a5d13fdf514a6e177e09c56a2260ab2c340ba"},{"version":"046369df9822476fa630221a0395dedb5286ec1bd01b1a12b53500c9f3a4a934","signature":"2d9bf057a68ceb0640cea9685453140173145a226eea621793df1646f1b64176"},{"version":"27583f9dc8325f3a3bbf7b38079fd6d6d6eea1cf03cb9df354238c8c75e07a4c","signature":"7f5fd90149d853b33d159c4008739c1a5a5a374dc9632d107d79230052ef7bcc"},{"version":"99c739861768beb8346a9033c08293e1b2d06fd3cdb5e81c380b13f66ef4b22e","signature":"c0f86b81c275682fdc02d4f7ea909a5265f5f1c4c2174791984d009ed1e48fd9"},{"version":"4ff22cb20309d38656337564ce6e8b79a52b1ffa69b1e7ae71d5fa02e7fda207","signature":"32b83b5537077be4ef46ecf854ed4f9821af95e3231f2d511c9f2a85b7342997"},{"version":"358b382563917d7e38e4db4fa26d26b3314abecd15212292fc2a5f071b350665","signature":"175f3bef2741f66f1d720c809134d0ba31eec8296e273de5fe1ece8e4e43d825"},"e7675b31d497886453830efe644b74a346077f25b4803491a84ad5fbe3621345",{"version":"884ffbff67d84370877a5cd63cc0153bb9e328abd9743a788fd330a8737eb8eb","signature":"d1ae2cf1ddb930e6436e854025538695c5f7329d3ab5957b267bbfbdee1599ad"},{"version":"e22400d6fd23ff4250e549c27f514607c787cc3b2452956d738ce3622959424c","signature":"6f345792cf93b14cf162149723d14a49d0c48f25f0fb6f376a528dc9d59ae558"},{"version":"ea68db5f9608a2e45220dd793470ec1e3affb8efb88213f1ffeb8e16bf3a156f","signature":"21f0d7c281866db090b97a2757ade0d1d076b066537511fc211704493524b6d3"},{"version":"bee1a831d744951dce4bbf119add8618a3df98df31ca398fa16aefcab3170ce3","signature":"09e994f3446f045349b253b7ce968c8e6e8007f6de5f0e40711868d5ef6c1762"},{"version":"c6a1a501d9d82e0ed2fb320ae9da0d3a90fb39fe23b3f9d7dd9e89f42eff4e5c","signature":"12b017e1cf46fbc05b4b6e447a10805ca026e1e615face029d6938bb23e7c490"},{"version":"fe93c474ab38ac02e30e3af073412b4f92b740152cf3a751fdaee8cbea982341","impliedFormat":1},{"version":"f5705d196b442afbdbd971b6e44bad96f4e32afb53cebfa2e5afe3140017bfc6","impliedFormat":1},{"version":"1e00b8bf9e3766c958218cd6144ffe08418286f89ff44ba5a2cc830c03dd22c7","impliedFormat":1},{"version":"4fb6da8b4a04fab9de232474c91c71d707aebd8bc37c514da77dd85e1f4a7ff8","signature":"5676f89eca50bcb3f87279621fdb1b86456f88414cd8c9ff9276d81a06cdcf98"},{"version":"24474db9c0a38abc57c28ee73bd10b051000d1b6bee652d7a02e4cfb9b5e1472","signature":"ff6dfda5378fc7b1ffb6f75724fa0b04c32109d9459a9df45de1ae5186b44a1c"},{"version":"6d575d93896c413b308c3726eed99ddd17e821a00bdd2cc5929510b46fe64de4","impliedFormat":99},{"version":"72d10a124d06c8e6e6a1a3f909ec05e58014d9e9efb90d30a00a872147aff227","signature":"81c7b60770f89833faf95654cf5758a194f67ff9e4f06eba1aec1d91fcc0b30c"},{"version":"52a53794e515c7022eefa349056f10a8a26fa7f0dc408dc579824b43f96e701a","signature":"7fc0fd37fa3ce04ad157c6dfbb5910335b2a66d95dc0bbf7eb462c309327cbee"},{"version":"ff0e90a0c3b2c6dcb5f85ea47654124da2ce8078a189b5367a2bd66c3db702e0","signature":"946a0bbc363832ca30674b873e6fd6b0619b67ed9a03d9c77c5b4886cf3ef3d8"},{"version":"6654eaef103869b9b6abb7bfb54821ba2704862b3ea383279f7ae199c33e3d51","signature":"5c08fe0ab9ba8b761f55deb154c7da4251110bb8dc1426c1a045c6166de564f3"},{"version":"92e6d79c5185da331bfd14f274ccf7480ac0a49bbac5382e3b034501f9ef8455","signature":"e4d62b2cbf0c4e26bf74f0dbb6a969743c688a01010fc86c9d2e00fcaf5ecdaa"},{"version":"6774117314e1617aa0e6e1485108673dfadad3c210a0370bfb0459529bebe37a","signature":"575e3e33107389c85651ff0cdcca66c00e5c3061a4062fd6d7763959d1bd55ea"},{"version":"7198dde36b7604372737a2e3e0ca9c582927a1d887535759e4359a4b1a2177d3","signature":"70b1673666c10f264cb2df781540127e1226f5bfdc4f0a399067d8e90b5e1511"},{"version":"1596cb56a3dcdbdb33178b558b1ed55c32c06b3fc0037de47e8b7a23737cbdb2","signature":"9af79fdf0d025be7d20d841bdab59e065f333d7ef03ed6eaf9cd55a4993974a5"},{"version":"a2e28ccd7dbebb44b823199096df7409a6ce2edff6d623f1ca4c74ae917d7ff5","signature":"0be4365fd3c0e900c5a52e01b6d7135c254a4f807b7cc6739a543b9e38db73e7"},{"version":"92381d93eeb01cf5b005c4abc2eac6fed9d68dbd9c9cc4b4f8006b5a2b57a1c8","signature":"a04d02319c37670e563f0c7c5f42b3d44e27bbbcb717dd723649fc337a5740aa"},{"version":"803bef85e70d4c145fe944d7f4fbfbbf87d1b925181d853187f3550a7e77bd1f","signature":"62a5084f6dcb722b18713cc1a145529a7a3a49dab61361b95bc3b521f5e52893"},{"version":"6b2a460214c63988fad9286139639b45a559d9695062e1260561335143e9c8b9","signature":"88c41623931e9f1eedc5de243d4c799f598d791dfa3ee1e02d40ea34582e8d9d"},{"version":"c59326c257bb1a8098a8a7fde7c60c1be507ea36282831413ba945b3a9bb13cf","signature":"dc8025941ee891b8f1bb44e1bd62ae621594ab2a914c3a8daea766fa553b235b"},{"version":"4f230b848d9211d3f3d34c27389f4c88fb03b2031b341dce9ca39db7211b81c4","signature":"52e334d63462144aa8ad0323b4ab75667e657144cf566df1e9dc80a5b325aed3"},{"version":"6193ec5f33a58a7cb5a18743f71a865e464205844e109d3c765de7ef8f8e7255","signature":"8c4a557c63c13a7af1d7e3a657047dc4074623f046a180b13e3135268598084e"},{"version":"07209f9dbdf8db99d8b491e93e9c1a1b5b09fb37df6b2c6ec0f2c0a9fcfc41f3","signature":"d2e6c03dd3ef0283f91b1718590c3f341e99c4b65b25147337cc7dd1c9340364"},{"version":"416a204a801b0a0e668c5038e628da5bdf376ceaa1a1d110c8c7cafd67e15ad9","signature":"455338497de3501efdc5216d1bf049ffd1fede45bb3963d4a303efbd3dcfcc93"},{"version":"3d64175a2dfdabc4720b5a590c20d739d76f47f23ee3fa36e5f8536bb829a48f","signature":"5bd37abf9da97361649fc2684758f8715c4602aca1bb50aeff9b3e5896c4a3b6"},{"version":"2a5b15bd9271e548595479c489596c5cf85afa7abfa75600b1fd76a1dcde8fcf","signature":"19816569a731ef4a0bb16bfa681773eb7c9d24f3b1a5374e2c05d48033851c2b"},{"version":"3520b25f14b768dc52eb0bf58e6378754303c58687f9879a2fd9201841b8c5d1","signature":"63539b13827445b6d66d14debd8c03bc3c5de92094655462f4c081dc3458b887"},{"version":"05cac57d2303e4430a619dbfbd06e3d8545abe7d93b31510cd2ef3671908d2c4","signature":"65f4c3ed9f9893a5519f9d4c8eb7c47be07d09d6c6c5aa557cce5367a08447af"},{"version":"f55195d322dd3a9c8bcf76377930bee5168c69d45601200e1008ffbe85f1e320","signature":"e83f2bede8656e6fe22a7fe0981f25f854a794720e3b3b968bc19d08c1dba5c0"},{"version":"a575a29568029ed131f8a23d97db9b3b1f55a9762df9b8e214de63c841d4df8e","signature":"f8233d09866e3714ba9f827f6f4038d37d19a72615fafa7bba00b60ed284f298"},{"version":"58a2d545d1d65ea95197c5ad49da160a2c32f76188a672ab3bdf4a4ef9f980e8","signature":"b2c3b2198dbd8dc0f09e3f0f82cc49d869a3ed3d99705bdb0246cfc68a947a3c"},{"version":"67d3dbb59073708d7e4d553b84cb752c70417210c21a6e391981b16c7772517a","signature":"910d4848c3f37d58f311283462738070995ff26055df50a7aacb12953208e48b"},{"version":"ddb853b5b931236918769435a7c182c0ed11a464027668da864604408707ebb6","signature":"32db4a91035349d2aad53db30f5dccd259580059bdd3ffdb2363a036c1da6c1c"},{"version":"137e95eb6144165415b18152431aa559a0e4620bce21b4089c291cf87c0bea0b","signature":"ae12fe7bbad135696f227cff76b605ffbd432f8e216a0d25c9afca0ea1969ba9"},{"version":"c7909e7d0c36ac5f78d07963297615a89535438e29035d86a7b00d347819982d","signature":"3a17026a3a0e87b2e0fc73b419f23f888d34b5d3f0a0a3849395b6b9f931a5dd"},{"version":"d94994db952247d67d38b0a9dabf667f88200ae24c73d9365b537a21faf683e5","signature":"658364d2282b332af2f57eabd02a1ca41f6d6646031b54b849afd06435bd01da"},{"version":"5c07eb8529cfacfc0b8af8e5884a82f862109d6a49f9791ab78bbb8d703f900c","signature":"b40d1273f042aa90418981aa40b3d14f02f8c51f2a31b8d439fdd59355068dc8"},{"version":"d604d89fde062001edb1bc13f97776dbe7cc5703a0b52ea190449ac8e48d9922","signature":"76313712a2dbc372820112aba6bb7720bac355528c6396bd4b99f0f33fd6ff8a"},{"version":"8875ceae553d0cca7a2b683e695cdf5c563fa6891c2035deee3da81d56168faa","signature":"78eb01e6716cee014dc3fcf0c1c3171e32f554b12d78a0ac10b201ee8710dffc"},{"version":"91a29404d4721d4a41ed7192100b7be775ea808c34bd4a7d3a2241570c15b9bf","signature":"470e8d2a79c55adefb1edaa4df45094218903c8e36f747f987b25f4a5e1ca015"},{"version":"3841185228c48e9b885549a8617848c18c76a689352faee1686767efe5d988ef","signature":"4e5304161624152115e316f3f83b7ad40f8a6ce3fe6da0a16ef248d1521051a8"},{"version":"41399b0e03cfb03f21cf249de41183228081a7253fb5042ce01aab114d4b5df3","signature":"c48dac345c7af2f7128262942258ea09c076977ec02069fa9e5b3309ca1891bc"},{"version":"20937f25f57780a8397255b5522ddcd9d0337c84881947cd445b72247b160eec","signature":"ddecbaecea22e7380bc786d92fd209cb517ffb03e802fccb12576f2f61f66632"},{"version":"b4d3bcc32bae3fec936e5ffd4620e9387fd360afbcf9c8734a14a03c7cfde5d1","signature":"11b619e3fc7b0d5cd982a05f9f66ac1e6cda8fc2d8edb4da0b4acc0c10460bb4"},{"version":"89ea24fa5268383da4858165c7c755c16f48303655b543dc407299ef319a997a","signature":"2ba0f4c317cd335e031848efda404fcd772815279a14cbe772e8f14cd8c7411c"},{"version":"7e0d1b06a3ce7513d1df2785446c74259762b1608fcb2e25297ee755d39bf34a","signature":"f36bf01b5730dee5a91a9b0c319913c23172c0c80010b00c65d3261a7c72909a"},{"version":"b1710282be9c07ed38400bf23e186cf06e0e237d578fe5fa0c536beca34af778","signature":"6b899401daed0a16bcf71026ab0c3eb9ce308961ad0e98fe801dcfed1b6fc803"},{"version":"859438d596630dba0d185650ddf12c2bc8bcfc0bf365293323580e8766b46445","signature":"f1b641cea93632df67447d8239199e28678067d1f42a64b6decbded3c9a35a4e"},{"version":"edd6c5d1233ba05aaf81686cc5f083e199137d0a9789739da07bc511443ca543","signature":"f2f3ab5028a11bb70b9f9d921d982d91e900031a1979ef8d0c20894e9e045f18"},"0f4bca46c69ccb930e6f3dee60d259990bb321220ecd7d5bc0d2b1d7c56e0718","d1986184a09a52db8228cb2bb2a61a8c05c9354e5b93cec8e2628d8579c892d7",{"version":"5f21eaa83133eac5a1b851c53922e418df3a3fdb99abf8286590c3441886d13e","affectsGlobalScope":true},"b39555468d9e5c88c68193472062d7f42707c9f69b7974a86c906bedc0646b07"],"root":[510,511,[579,582],[644,661],[739,752],[861,868],[879,899],904,[954,964],968,969,[971,1016]],"options":{"allowJs":true,"esModuleInterop":true,"jsx":4,"module":99,"noUnusedLocals":true,"noUnusedParameters":true,"skipLibCheck":true,"strict":true,"target":4},"referencedMap":[[1014,1],[1015,2],[1016,3],[510,2],[1013,4],[581,5],[511,6],[582,7],[618,8],[253,2],[617,2],[560,9],[561,10],[559,11],[554,12],[563,13],[548,2],[549,14],[558,15],[553,16],[562,2],[557,17],[550,2],[551,2],[556,18],[552,15],[555,16],[513,19],[514,20],[512,2],[528,21],[521,22],[527,23],[515,2],[524,24],[525,25],[523,26],[518,27],[522,28],[517,29],[519,30],[516,2],[526,31],[520,32],[538,33],[530,2],[533,34],[531,2],[532,2],[529,2],[536,35],[537,36],[535,37],[571,38],[572,38],[578,39],[570,2],[576,2],[575,2],[574,40],[573,2],[577,41],[547,42],[539,2],[541,43],[540,44],[543,45],[545,46],[544,47],[542,43],[546,48],[569,49],[564,2],[567,50],[566,51],[565,52],[568,53],[583,2],[754,54],[764,54],[141,55],[142,55],[143,56],[97,57],[144,58],[145,59],[146,60],[92,2],[95,61],[93,2],[94,2],[147,62],[148,63],[149,64],[150,65],[151,66],[152,67],[153,67],[154,68],[155,69],[156,70],[157,71],[98,2],[96,2],[158,72],[159,73],[160,74],[192,75],[161,76],[162,77],[163,78],[164,79],[165,80],[166,81],[167,82],[168,83],[169,84],[170,85],[171,85],[172,86],[173,2],[174,87],[176,88],[175,89],[177,90],[178,91],[179,92],[180,93],[181,94],[182,95],[183,96],[184,97],[185,98],[186,99],[187,100],[188,101],[189,102],[99,2],[100,2],[101,2],[140,103],[190,104],[191,105],[534,2],[196,106],[413,107],[197,108],[195,109],[415,110],[414,111],[193,112],[411,2],[194,113],[83,2],[85,114],[410,107],[270,107],[753,2],[633,2],[634,115],[635,116],[626,117],[621,118],[624,119],[636,120],[630,2],[902,121],[631,122],[632,123],[639,123],[901,2],[623,124],[625,124],[616,125],[620,126],[622,127],[615,2],[950,128],[952,129],[951,128],[949,130],[906,2],[908,131],[907,132],[912,133],[947,134],[944,135],[946,136],[909,135],[910,137],[914,137],[913,138],[911,139],[945,140],[943,135],[948,141],[941,2],[942,2],[915,142],[920,135],[922,135],[917,135],[918,142],[924,135],[925,143],[916,135],[921,135],[923,135],[919,135],[939,144],[938,135],[940,145],[934,135],[936,135],[935,135],[931,135],[937,146],[932,135],[933,147],[926,135],[927,135],[928,135],[929,135],[930,135],[102,2],[84,2],[846,2],[847,148],[844,2],[845,2],[590,2],[905,2],[858,149],[857,150],[970,2],[833,2],[807,151],[806,152],[805,153],[832,154],[831,155],[835,156],[834,157],[837,158],[836,159],[792,160],[766,161],[767,162],[768,162],[769,162],[770,162],[771,162],[772,162],[773,162],[774,162],[775,162],[776,162],[790,163],[777,162],[778,162],[779,162],[780,162],[781,162],[782,162],[783,162],[784,162],[786,162],[787,162],[785,162],[788,162],[789,162],[791,162],[765,164],[830,165],[810,166],[811,166],[812,166],[813,166],[814,166],[815,166],[816,167],[818,166],[817,166],[829,168],[819,166],[821,166],[820,166],[823,166],[822,166],[824,166],[825,166],[826,166],[827,166],[828,166],[809,166],[808,169],[800,170],[798,171],[799,171],[803,172],[801,171],[802,171],[804,171],[797,2],[459,173],[464,1],[454,174],[217,175],[257,176],[439,177],[252,178],[234,2],[409,2],[215,2],[428,179],[283,180],[216,2],[337,181],[260,182],[261,183],[408,184],[425,185],[319,186],[433,187],[434,188],[432,189],[431,2],[429,190],[259,191],[218,192],[362,2],[363,193],[289,194],[219,195],[290,194],[285,194],[206,194],[255,196],[254,2],[438,197],[450,2],[242,2],[384,198],[385,199],[379,107],[486,2],[387,2],[388,200],[380,201],[491,202],[490,203],[485,2],[304,2],[424,204],[423,2],[484,205],[381,107],[313,206],[309,207],[314,208],[312,2],[311,209],[310,2],[487,2],[483,2],[489,210],[488,2],[308,207],[478,211],[481,212],[298,213],[297,214],[296,215],[494,107],[295,216],[277,2],[497,2],[966,217],[965,2],[500,2],[499,107],[501,218],[199,2],[435,219],[436,220],[437,221],[212,2],[245,2],[211,222],[198,2],[400,107],[204,223],[399,224],[398,225],[389,2],[390,2],[397,2],[392,2],[395,226],[391,2],[393,227],[396,228],[394,227],[214,2],[209,2],[210,194],[265,2],[271,229],[272,230],[269,231],[267,232],[268,233],[263,2],[406,200],[292,200],[458,234],[465,235],[469,236],[442,237],[441,2],[280,2],[502,238],[453,239],[382,240],[383,241],[377,242],[368,2],[405,243],[444,107],[369,244],[407,245],[402,246],[401,2],[403,2],[374,2],[361,247],[443,248],[446,249],[371,250],[375,251],[366,252],[420,253],[452,254],[323,255],[338,256],[207,257],[451,258],[203,259],[273,260],[264,2],[274,261],[350,262],[262,2],[349,263],[91,2],[343,264],[244,2],[364,265],[339,2],[208,2],[238,2],[347,266],[213,2],[275,267],[373,268],[440,269],[372,2],[346,2],[266,2],[352,270],[353,271],[430,2],[355,272],[357,273],[356,274],[247,2],[345,257],[359,275],[322,276],[344,277],[351,278],[222,2],[226,2],[225,2],[224,2],[229,2],[223,2],[232,2],[231,2],[228,2],[227,2],[230,2],[233,279],[221,2],[331,280],[330,2],[335,281],[332,282],[334,283],[336,281],[333,282],[243,284],[293,285],[449,286],[503,2],[473,287],[475,288],[370,289],[474,290],[447,248],[386,248],[220,2],[324,291],[239,292],[240,293],[241,294],[237,295],[419,295],[287,295],[325,296],[288,296],[236,297],[235,2],[329,298],[328,299],[327,300],[326,301],[448,302],[418,303],[417,304],[378,305],[412,306],[416,307],[427,308],[426,309],[422,310],[321,311],[318,312],[320,313],[317,314],[358,315],[348,2],[463,2],[360,316],[421,2],[276,317],[367,219],[365,318],[278,319],[281,320],[498,2],[279,321],[282,321],[461,2],[460,2],[462,2],[496,2],[284,322],[445,2],[315,323],[307,107],[258,2],[202,324],[291,2],[467,107],[201,2],[477,325],[306,107],[471,200],[305,326],[456,327],[303,325],[205,2],[479,328],[301,107],[302,107],[294,2],[200,2],[300,329],[299,330],[246,331],[376,84],[286,84],[354,2],[341,332],[340,2],[404,207],[316,107],[457,333],[86,107],[89,334],[90,335],[87,107],[88,2],[256,336],[251,337],[250,2],[249,338],[248,2],[455,339],[466,340],[468,341],[470,342],[967,343],[472,344],[476,345],[509,346],[480,346],[508,347],[482,348],[492,349],[493,350],[495,351],[504,352],[507,222],[506,2],[505,353],[842,354],[855,355],[840,2],[841,356],[856,357],[851,358],[852,359],[850,360],[854,361],[848,362],[843,363],[853,364],[849,355],[607,365],[605,366],[606,367],[594,368],[595,366],[602,369],[593,370],[598,371],[608,2],[599,372],[604,373],[610,374],[609,375],[592,376],[600,377],[601,378],[596,379],[603,365],[597,380],[619,381],[796,382],[795,383],[860,384],[859,385],[839,386],[838,387],[794,388],[793,389],[585,390],[584,391],[342,392],[591,2],[637,2],[761,393],[760,2],[81,2],[82,2],[13,2],[14,2],[16,2],[15,2],[2,2],[17,2],[18,2],[19,2],[20,2],[21,2],[22,2],[23,2],[24,2],[3,2],[25,2],[26,2],[4,2],[27,2],[31,2],[28,2],[29,2],[30,2],[32,2],[33,2],[34,2],[5,2],[35,2],[36,2],[37,2],[38,2],[6,2],[42,2],[39,2],[40,2],[41,2],[43,2],[7,2],[44,2],[49,2],[50,2],[45,2],[46,2],[47,2],[48,2],[8,2],[54,2],[51,2],[52,2],[53,2],[55,2],[9,2],[56,2],[57,2],[58,2],[60,2],[59,2],[61,2],[62,2],[10,2],[63,2],[64,2],[65,2],[11,2],[66,2],[67,2],[68,2],[69,2],[70,2],[1,2],[71,2],[72,2],[12,2],[76,2],[74,2],[79,2],[78,2],[73,2],[77,2],[75,2],[80,2],[118,394],[128,395],[117,394],[138,396],[109,397],[108,398],[137,353],[131,399],[136,400],[111,401],[125,402],[110,403],[134,404],[106,405],[105,353],[135,406],[107,407],[112,408],[113,2],[116,408],[103,2],[139,409],[129,410],[120,411],[121,412],[123,413],[119,414],[122,415],[132,353],[114,416],[115,417],[124,418],[104,419],[127,410],[126,408],[130,2],[133,420],[763,421],[759,2],[762,422],[756,423],[755,54],[758,424],[757,425],[638,426],[628,427],[629,426],[640,428],[627,2],[614,429],[611,430],[589,431],[587,432],[586,2],[588,433],[612,2],[613,434],[643,435],[642,436],[903,437],[641,436],[900,438],[738,439],[732,440],[736,441],[733,441],[729,440],[737,442],[734,443],[735,441],[730,444],[731,445],[725,446],[669,447],[671,448],[724,2],[670,449],[728,450],[727,451],[726,452],[662,2],[672,447],[673,2],[664,453],[668,454],[663,2],[665,455],[666,456],[667,2],[674,457],[675,457],[676,457],[677,457],[678,457],[679,457],[680,457],[681,457],[682,457],[683,457],[684,457],[685,457],[686,457],[688,457],[687,457],[689,457],[690,457],[691,457],[692,457],[723,458],[693,457],[694,457],[695,457],[696,457],[697,457],[698,457],[699,457],[700,457],[701,457],[702,457],[703,457],[704,457],[705,457],[707,457],[706,457],[708,457],[709,457],[710,457],[711,457],[712,457],[713,457],[714,457],[715,457],[716,457],[717,457],[718,457],[719,457],[722,457],[720,457],[721,457],[871,459],[878,460],[875,461],[873,461],[876,461],[872,461],[877,461],[874,461],[870,461],[869,2],[953,462],[645,463],[973,464],[974,200],[975,465],[646,466],[976,467],[977,468],[979,469],[978,469],[980,470],[981,471],[971,472],[972,473],[649,474],[985,475],[986,476],[988,477],[987,478],[990,479],[991,480],[647,463],[982,481],[992,482],[984,483],[983,484],[994,485],[995,486],[993,487],[650,466],[997,482],[996,488],[989,489],[651,490],[655,491],[656,492],[659,493],[660,494],[661,495],[742,496],[743,497],[746,498],[745,498],[747,499],[748,500],[749,501],[750,502],[998,503],[999,504],[1000,505],[1001,506],[1003,507],[1006,508],[964,509],[1007,510],[1008,506],[969,511],[1009,512],[1012,513],[1010,514],[1011,200],[962,515],[1005,516],[961,517],[968,518],[963,481],[751,200],[863,519],[868,520],[866,521],[864,522],[862,200],[867,523],[896,519],[881,524],[895,525],[904,526],[741,527],[898,528],[1004,529],[899,530],[740,519],[739,531],[880,532],[886,200],[1002,533],[883,462],[887,534],[888,535],[894,536],[861,537],[884,538],[890,524],[893,539],[882,540],[889,541],[891,462],[892,519],[885,542],[865,200],[579,462],[954,543],[654,544],[653,545],[752,462],[955,519],[879,462],[957,546],[658,462],[744,462],[956,547],[657,548],[652,549],[580,462],[958,550],[648,462],[959,107],[897,519],[960,551],[644,552]],"semanticDiagnosticsPerFile":[[645,[{"start":5131,"length":14,"code":2551,"category":1,"messageText":"Property 'getUserByEmail' does not exist on type 'GoTrueAdminApi'. Did you mean 'getUserById'?","relatedInformation":[{"file":"./node_modules/.pnpm/@supabase+auth-js@2.75.0/node_modules/@supabase/auth-js/dist/module/gotrueadminapi.d.ts","start":3094,"length":11,"messageText":"'getUserById' is declared here.","category":3,"code":2728}]}]]],"affectedFilesPendingEmit":[1016,1013,581,582,645,973,974,975,646,976,977,979,978,980,981,971,972,649,985,986,988,987,990,991,647,982,992,984,983,994,995,993,650,997,996,989,651,655,656,659,660,661,742,743,746,745,747,748,749,750,998,999,1000,1001,1003,1006,964,1007,1008,969,1009,1012,1010,1011,962,1005,961,968,963,751,863,868,866,864,862,867,896,881,895,904,741,898,1004,899,740,739,880,886,1002,883,887,888,894,861,884,890,893,882,889,891,892,885,865,579,954,654,653,752,955,879,957,658,744,956,657,652,580,958,648,897,960,644],"version":"5.9.3"}
````

## File: .gitignore
````
# --- Security & Secrets ---
.env
.env.local
.env.*.local
*.pem
*.key
service-account*.json

# --- Data Protection ---
data/*
!data/sample-paper-template.json

# --- Dependencies & Build ---
node_modules/
.pnpm-store/
.next/
out/
build/
dist/
.venv/

# --- Generated Reports ---
gemini_*.md
VS_Codebase*.md
repomix-output*
.export_sanitized/
.export_tmp/
.repomix-vs-codebase.json

# --- System ---
*.log
npm-debug.log*
yarn-debug.log*
pnpm-debug.log*
.DS_Store
Thumbs.db
````

## File: README.md
````markdown
# CAT Mock Website

A Next.js 16 application for CAT exam mock tests with Supabase authentication.

## Quick Start

```bash
pnpm install
pnpm dev
```

Open [http://localhost:3000](http://localhost:3000) to view the app.

## Exam Integrity & Security (Phase 1)

### Scoring System

- **TypeScript Scoring Engine**: The sole source of truth for exam scoring is the TypeScript `calculateScore()` function in `src/features/exam-engine/lib/scoring.ts`.
- **Legacy SQL Removed**: The legacy SQL `finalize_attempt()` function has been removed to prevent divergent scoring outcomes.
- **Marking Scheme**: 
  - MCQ: +3 for correct, -1 for incorrect, 0 for unanswered
  - TITA: +3 for correct, 0 for incorrect/unanswered (no negative marking)

### Attempt Limits

- Papers can specify an `attempt_limit` (e.g., 3 attempts per user).
- Non-expired attempts (in_progress, submitted, completed, abandoned) count toward the limit.
- Enforced at both client-side (UI check) and server-side (RLS policy).
- Users attempting to exceed the limit see a friendly error message.

### Pause/Resume Rules

- Papers have an `allow_pause` flag (default: false).
- When `allow_pause = false`:
  - The pause button is hidden/disabled in the UI.
  - The `/api/pause` endpoint returns an error.
  - The `pause_exam_state` RPC rejects pause requests.
- When `allow_pause = true`:
  - Users can pause and resume from the dashboard.
  - Timer state is preserved server-side.

### Session Token Security

- Each exam session generates a unique `session_token`.
- All save/submit operations require a valid session token.
- Multi-device/tab detection: If tokens don't match, a `SESSION_CONFLICT` error is returned.
- Force Resume: Users can explicitly take over a session from another device/tab.
- Session tokens are not directly accessible by authenticated users (REVOKE SELECT/UPDATE).

### Admin API Security

- All admin routes (`/api/admin/*`) require admin verification.
- Admin verification checks:
  1. JWT claim `user_role = 'admin'`
  2. Fallback to `is_admin()` RPC (checks `user_roles` table)
- Admin routes use `getServiceRoleClient()` to bypass RLS for data operations.
- Non-admins are redirected to dashboard with an error.

### Sensitive Data Protection (RLS)

- `questions.correct_answer`: Not accessible to users until attempt is completed.
- `attempts.session_token`: Not readable or writable by authenticated users directly.
- `attempts.total_score`, etc.: Not directly writable by users (set by scoring engine).
- Secure views:
  - `questions_exam`: For exam runtime (excludes correct_answer, solutions)
  - `fetch_attempt_solutions()`: RPC for post-completion solution access

## Access Control & Waitlist (Soft Launch)

- **Global mode**: `app_settings.signup_mode` toggles OPEN vs GATED for new users.
- **Per-user status**: `user_access.status` = active | pending | rejected. Assigned on signup (fail-closed to pending if settings missing).
- **Waitlist**: `/coming-soon` lets gated users request access (stored in `access_requests`).
- **Enforcement**: middleware + server actions check active access; RLS blocks attempts/responses for non-active users.
- **Admin controls**: `/admin/access-control` (mode toggle + approve/reject) and dashboard "Launch Controls" card.
- **Guardrails**: basic rate limits for auth callback, access requests, and start mock; in-memory telemetry counters for spikes.


## Database Migrations

Apply migrations in order from the `docs/migrations/` directory:

```bash
# Core migrations (apply in numeric order)
002_session_locking.sql
003_question_container_architecture.sql
004_fetch_attempt_solutions.sql
005_attempt_state_lockdown.sql
006_force_resume_session.sql
007_content_ingestion_phases.sql
008_ingestion_semantic_keys.sql
009_attempt_submit_rls.sql
010_force_resume_lenient.sql
011_prevent_paper_delete_with_attempts.sql
012_phase1_security_hardening.sql  # Deprecated (use 013)
013_phase1_security_complete.sql   # Full Phase 1 security hardening
014_soften_submit_rls.sql          # Optional relaxations
015_landing_assets.sql
016_bug_reports.sql
017_bug_report_status.sql
018_purge_attempts_on_auth_delete.sql
019_force_resume_ultra_lenient.sql
020_pause_tracking.sql
021_validate_session_token_atomic.sql
022_validate_session_token_single_signature.sql
023_access_control_foundations.sql
024_access_control_rls.sql
```

**Note**: Migration `012_phase1_security_hardening.sql` is deprecated. Use `013_phase1_security_complete.sql` instead.

## Running Tests

```bash
# Run all tests
pnpm test

# Run scoring tests only
pnpm exec vitest run src/features/exam-engine/lib/__tests__/scoring.test.ts

# Run type checking
pnpm exec tsc --noEmit

# Run linting
pnpm lint
```

## Architecture

```
src/
├── app/                    # Next.js App Router pages and API routes
│   ├── api/               # API endpoints
│   │   ├── submit/        # Exam submission
│   │   ├── save/          # Response saving
│   │   ├── pause/         # Exam pausing
│   │   ├── session/       # Session initialization
│   │   ├── progress/      # Progress updates
│   │   └── admin/         # Admin-only endpoints
│   ├── exam/              # Exam taking pages
│   ├── result/            # Result viewing pages
│   └── mock/              # Mock selection pages
├── features/
│   └── exam-engine/       # Core exam functionality
│       ├── lib/           # Actions, scoring, validation
│       ├── model/         # Zustand store (useExamStore)
│       ├── hooks/         # React hooks (useExamTimer)
│       ├── ui/            # UI components
│       └── api/           # Client-side API wrappers
├── lib/
│   └── supabase/          # Supabase client configurations
└── types/
    └── exam.ts            # TypeScript types for exam system
```
````

## File: src/app/admin/page.tsx
````typescript
/**
 * @fileoverview Admin Dashboard
 * @description Main admin page with overview statistics and quick actions
 */

import { sbSSR } from '@/lib/supabase/server';
import Link from 'next/link';
import { redirect } from 'next/navigation';
import { updateSignupMode } from './access-control/actions';

export default async function AdminPage() {
    const supabase = await sbSSR();

    // Server-side admin verification
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/auth/sign-in');
    }

    const { data: { session } } = await supabase.auth.getSession();
    let role: string | null = session?.user?.app_metadata?.user_role ?? null;

    if (!role && session?.access_token) {
        try {
            const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                user_role?: string;
                app_metadata?: { user_role?: string };
            };
            role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
        } catch {
            role = null;
        }
    }

    let isAdmin = role === 'admin' || role === 'dev';

    if (!isAdmin) {
        const { data: isAdminRpc, error: rpcError } = await supabase.rpc('is_admin');
        isAdmin = !rpcError && Boolean(isAdminRpc);
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    // Fetch statistics
    const [papersResult, questionsResult, attemptsResult] = await Promise.all([
        supabase.from('papers').select('id, published', { count: 'exact' }),
        supabase.from('questions').select('id', { count: 'exact' }),
        supabase.from('attempts').select('id, status', { count: 'exact' }),
    ]);

    let signupMode = 'GATED';
    let pendingAccessRequests = 0;

    try {
        const { data: settingRow } = await supabase
            .from('app_settings')
            .select('setting_value')
            .eq('setting_key', 'signup_mode')
            .maybeSingle();
        if (settingRow?.setting_value === 'OPEN' || settingRow?.setting_value === 'GATED') {
            signupMode = settingRow.setting_value;
        }

        const { count } = await supabase
            .from('access_requests')
            .select('id', { count: 'exact', head: true })
            .eq('status', 'pending');
        pendingAccessRequests = count ?? 0;
    } catch {
        // Ignore missing tables during early migrations.
    }

    const totalPapers = papersResult.count || 0;
    const publishedPapers = papersResult.data?.filter(p => p.published).length || 0;
    const totalQuestions = questionsResult.count || 0;
    const totalAttempts = attemptsResult.count || 0;
    const completedAttempts = attemptsResult.data?.filter(a => a.status === 'completed').length || 0;

    return (
        <div className="space-y-8">
            <div className="flex items-center justify-between">
                <h1 className="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
            </div>

            {/* Statistics Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm font-medium text-gray-500">Total Papers</p>
                            <p className="text-3xl font-bold text-gray-900">{totalPapers}</p>
                        </div>
                        <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                    </div>
                    <p className="text-sm text-gray-500 mt-2">{publishedPapers} published</p>
                </div>

                <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm font-medium text-gray-500">Total Questions</p>
                            <p className="text-3xl font-bold text-gray-900">{totalQuestions}</p>
                        </div>
                        <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg className="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                    <p className="text-sm text-gray-500 mt-2">Across all papers</p>
                </div>

                <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm font-medium text-gray-500">Total Attempts</p>
                            <p className="text-3xl font-bold text-gray-900">{totalAttempts}</p>
                        </div>
                        <div className="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <svg className="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                        </div>
                    </div>
                    <p className="text-sm text-gray-500 mt-2">{completedAttempts} completed</p>
                </div>

                <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm font-medium text-gray-500">Completion Rate</p>
                            <p className="text-3xl font-bold text-gray-900">
                                {totalAttempts > 0 ? Math.round((completedAttempts / totalAttempts) * 100) : 0}%
                            </p>
                        </div>
                        <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg className="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                            </svg>
                        </div>
                    </div>
                    <p className="text-sm text-gray-500 mt-2">Of all attempts</p>
                </div>
            </div>

            {/* Access Control */}
            <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center justify-between mb-4">
                    <div>
                        <h2 className="text-lg font-semibold text-gray-900">Launch Controls</h2>
                        <p className="text-sm text-gray-500">Pending requests: {pendingAccessRequests}</p>
                    </div>
                    <Link
                        href="/admin/access-control"
                        className="text-sm text-indigo-600 hover:text-indigo-700"
                    >
                        Manage access
                    </Link>
                </div>
                <form action={updateSignupMode} className="flex flex-wrap items-center gap-3">
                    <select
                        name="signup_mode"
                        defaultValue={signupMode}
                        className="border border-gray-300 rounded-lg px-3 py-2 text-sm"
                    >
                        <option value="OPEN">OPEN (auto-approve)</option>
                        <option value="GATED">GATED (waitlist)</option>
                    </select>
                    <button
                        type="submit"
                        className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold hover:bg-indigo-700"
                    >
                        Update mode
                    </button>
                    <span className={`text-xs font-semibold px-2 py-1 rounded ${signupMode === 'OPEN' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                        {signupMode}
                    </span>
                </form>
            </div>

            {/* Quick Actions */}
            <div className="bg-white rounded-lg shadow p-6">
                <h2 className="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <Link
                        href="/admin/papers"
                        className="flex items-center gap-3 p-4 border-2 border-indigo-500 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition-colors"
                    >
                        <div className="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center">
                            <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </div>
                        <div>
                            <p className="font-semibold text-indigo-900">Live Edit Papers</p>
                            <p className="text-sm text-indigo-600">Edit papers in mock exam view</p>
                        </div>
                    </Link>

                    <Link
                        href="/admin/papers/new"
                        className="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors"
                    >
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                        </div>
                        <div>
                            <p className="font-medium text-gray-900">Create New Paper</p>
                            <p className="text-sm text-gray-500">Add a new mock test paper</p>
                        </div>
                    </Link>

                    <Link
                        href="/admin/questions/new"
                        className="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors"
                    >
                        <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                        </div>
                        <div>
                            <p className="font-medium text-gray-900">Add Question</p>
                            <p className="text-sm text-gray-500">Add a question to a paper</p>
                        </div>
                    </Link>

                    <Link
                        href="/admin/access-control"
                        className="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors"
                    >
                        <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5s-3 1.343-3 3 1.343 3 3 3zm0 0c-2.21 0-4 1.79-4 4v2h8v-2c0-2.21-1.79-4-4-4z" />
                            </svg>
                        </div>
                        <div>
                            <p className="font-medium text-gray-900">Access Control</p>
                            <p className="text-sm text-gray-500">Review waitlist & mode</p>
                        </div>
                    </Link>

                </div>
            </div>
        </div>
    );
}
````

## File: src/app/admin/questions/page.tsx
````typescript
/**
 * @fileoverview Questions List Page
 * @description Admin page to view and manage all questions
 */

import { sbSSR } from '@/lib/supabase/server';
import { adminLogger } from '@/lib/logger';
import { createClient } from '@supabase/supabase-js';
import Link from 'next/link';
import { redirect } from 'next/navigation';
import QuestionRowActions from './QuestionRowActions';

function getAdminClient() {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!url || !serviceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY. Admin pages require service role access.');
    }

    return createClient(url, serviceKey, {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    });
}

export default async function QuestionsPage() {
    const supabase = await sbSSR();

    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/auth/sign-in');
    }

    const { data: { session } } = await supabase.auth.getSession();
    let role: string | null = session?.user?.app_metadata?.user_role ?? null;

    if (!role && session?.access_token) {
        try {
            const payload = JSON.parse(Buffer.from(session.access_token.split('.')[1], 'base64').toString('utf-8')) as {
                user_role?: string;
                app_metadata?: { user_role?: string };
            };
            role = payload.user_role ?? payload.app_metadata?.user_role ?? null;
        } catch {
            role = null;
        }
    }

    let isAdmin = role === 'admin' || role === 'dev';

    if (!isAdmin) {
        const { data: isAdminRpc, error: rpcError } = await supabase.rpc('is_admin');
        isAdmin = !rpcError && Boolean(isAdminRpc);
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    const adminClient = getAdminClient();

    // Fetch questions with their paper info
    const { data: questions, error } = await adminClient
        .from('questions')
        .select(`
            *,
            papers (id, title, slug)
        `)
        .order('created_at', { ascending: false })
        .limit(100);

    if (error) {
        adminLogger.dataModified('questions', 'fetch_error', { error });
    }

    // TODO: Implement paper filter dropdown
    // Future: Fetch papers for filter
    // const { data: papers } = await supabase.from('papers').select('id, title').order('title');

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                <h1 className="text-2xl font-bold text-gray-900">Questions</h1>
                <Link
                    href="/admin/questions/new"
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                    </svg>
                    New Question
                </Link>
            </div>

            <div className="bg-white rounded-lg shadow overflow-hidden">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                #
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Question
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Paper
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Section
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Type
                            </th>
                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {questions && questions.length > 0 ? (
                            questions.map((question) => (
                                <tr key={question.id} className="hover:bg-gray-50">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {question.question_number}
                                    </td>
                                    <td className="px-6 py-4">
                                        <div className="text-sm text-gray-900 line-clamp-2 max-w-md">
                                            {question.question_text.substring(0, 100)}...
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {question.papers?.title || 'Unknown'}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap">
                                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${question.section === 'VARC' ? 'bg-blue-100 text-blue-800' :
                                            question.section === 'DILR' ? 'bg-purple-100 text-purple-800' :
                                                'bg-green-100 text-green-800'
                                            }`}>
                                            {question.section}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap">
                                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${question.question_type === 'MCQ'
                                            ? 'bg-gray-100 text-gray-800'
                                            : 'bg-yellow-100 text-yellow-800'
                                            }`}>
                                            {question.question_type}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <QuestionRowActions
                                            questionId={question.id}
                                            isActive={question.is_active}
                                            editHref={`/admin/papers/${question.paper_id}/edit`}
                                        />
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colSpan={6} className="px-6 py-12 text-center text-gray-500">
                                    No questions found. <Link href="/admin/questions/new" className="text-blue-600 hover:underline">Add your first question</Link>
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
}
````

## File: src/app/api/progress/route.ts
````typescript
import { NextRequest, NextResponse } from 'next/server';
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { updateAttemptProgress } from '@/features/exam-engine/lib/actions';
import { examLogger } from '@/lib/logger';
import {
    isNonEmptyString,
    isFiniteNumber,
    isValidTimeRemaining,
    getSupabaseConfig,
    serverMisconfiguredResponse,
    addVersionHeader,
} from '../_utils/validation';

type ValidateSessionResult = { data: boolean | null; error: { code?: string; message?: string } | null };

function isMissingValidateFn(error?: { code?: string; message?: string } | null): boolean {
    if (!error) return false;
    return error.code === '42883' || Boolean(error.message?.includes('validate_session_token'));
}

async function validateSessionTokenRpc(
    supabase: { rpc: (fn: string, args: Record<string, unknown>) => PromiseLike<ValidateSessionResult> },
    attemptId: string,
    sessionToken: string,
    userId: string
): Promise<ValidateSessionResult> {
    const primary = await supabase.rpc('validate_session_token', {
        p_attempt_id: attemptId,
        p_session_token: sessionToken,
        p_user_id: userId,
    });

    if (!primary.error || !isMissingValidateFn(primary.error)) return primary;

    return supabase.rpc('validate_session_token', {
        p_attempt_id: attemptId,
        p_session_token: sessionToken,
        p_user_id: userId,
        p_force_resume: false,
    });
}

export async function POST(req: NextRequest) {
    const res = NextResponse.next();

    try {
        const { attemptId, timeRemaining, currentSection, currentQuestion, sessionToken, force_resume } = await req.json();

        if (!isNonEmptyString(attemptId)) {
            return addVersionHeader(NextResponse.json({ error: 'attemptId is required' }, { status: 400 }));
        }
        if (!isValidTimeRemaining(timeRemaining)) {
            return addVersionHeader(NextResponse.json({ error: 'timeRemaining is invalid' }, { status: 400 }));
        }
        if (!isNonEmptyString(currentSection)) {
            return addVersionHeader(NextResponse.json({ error: 'currentSection is required' }, { status: 400 }));
        }
        // CRITICAL: Use isFiniteNumber to correctly handle currentQuestion = 0
        if (!isFiniteNumber(currentQuestion)) {
            return addVersionHeader(NextResponse.json({ error: 'currentQuestion is invalid' }, { status: 400 }));
        }

        // Phase 4: Validate session token if provided (keeps heartbeat consistent)
        if (sessionToken) {
            const config = getSupabaseConfig();
            if (!config) {
                return addVersionHeader(serverMisconfiguredResponse());
            }

            const supabase = createServerClient(config.url, config.anonKey, {
                cookies: {
                    getAll() {
                        return req.cookies.getAll();
                    },
                    setAll(cookiesToSet: Array<{ name: string; value: string; options: CookieOptions }>) {
                        cookiesToSet.forEach(({ name, value, options }) => {
                            res.cookies.set({ name, value, ...options });
                        });
                    },
                },
            });

            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: isValidSession, error: validateError } = await validateSessionTokenRpc(
                    supabase,
                    attemptId,
                    sessionToken,
                    user.id
                );

                if (validateError) {
                    examLogger.securityEvent('Progress session validation RPC error', {
                        attemptId,
                        errorMessage: validateError.message,
                        errorCode: validateError.code,
                    });
                    if (force_resume === true) {
                        const { error: forceResumeError } = await supabase.rpc('force_resume_exam_session', {
                            p_attempt_id: attemptId,
                            p_new_session_token: sessionToken,
                        });
                        if (forceResumeError) {
                            return addVersionHeader(NextResponse.json(
                                { error: 'Failed to validate session', code: 'VALIDATION_RPC_ERROR' },
                                { status: 500 }
                            ));
                        }
                    } else {
                        return addVersionHeader(NextResponse.json(
                            { error: 'Failed to validate session', code: 'VALIDATION_RPC_ERROR' },
                            { status: 500 }
                        ));
                    }
                }

                if (isValidSession === false) {
                    if (force_resume === true) {
                        const { error: forceResumeError } = await supabase.rpc('force_resume_exam_session', {
                            p_attempt_id: attemptId,
                            p_new_session_token: sessionToken,
                        });
                        if (forceResumeError) {
                            if (
                                forceResumeError.message?.includes('FORCE_RESUME_STALE') ||
                                forceResumeError.message?.includes('stale')
                            ) {
                                return addVersionHeader(NextResponse.json(
                                    { error: 'Force resume denied. Session is too old.', code: 'FORCE_RESUME_STALE' },
                                    { status: 409 }
                                ));
                            }
                            return addVersionHeader(NextResponse.json(
                                { error: 'Failed to force resume session' },
                                { status: 500 }
                            ));
                        }
                    } else {
                        console.log('API_PROGRESS_SESSION_MISMATCH', {
                            attemptId,
                            userId: user.id,
                            status: null,
                            errorCode: 'SESSION_CONFLICT',
                            errorMessage: 'Progress session mismatch',
                        });
                        examLogger.securityEvent('Progress session mismatch', { attemptId });
                        return addVersionHeader(NextResponse.json({
                            error: 'Session conflict detected',
                            code: 'SESSION_CONFLICT',
                            canForceResume: true,
                        }, { status: 409 }));
                    }
                }
            }
        }

        const result = await updateAttemptProgress({
            attemptId,
            timeRemaining,
            currentSection: currentSection as import('@/types/exam').SectionName,
            currentQuestion,
        });

        if (!result.success) {
            if (result.error === 'Authentication required' || result.error === 'Unauthorized') {
                return addVersionHeader(NextResponse.json({ error: 'Session expired. Please sign in again.' }, { status: 401 }));
            }
            console.log('API_PROGRESS_UPDATE_FAILED', {
                attemptId,
                userId: null,
                status: null,
                errorCode: 'UPDATE_FAILED',
                errorMessage: result.error ?? 'Failed to update progress',
            });
            return addVersionHeader(NextResponse.json({ error: result.error || 'Failed to update progress' }, { status: 400 }));
        }

        const success = NextResponse.json({ success: true });
        res.cookies.getAll().forEach((cookie) => success.cookies.set(cookie));
        return addVersionHeader(success);
    } catch {
        return addVersionHeader(NextResponse.json({ error: 'Invalid JSON' }, { status: 400 }));
    }
}
````

## File: src/app/auth/sign-in/page.tsx
````typescript
'use client';

import { Suspense, useCallback, useMemo, useState } from 'react';
import { useSearchParams } from 'next/navigation';
import { sb } from '../../../lib/supabase/client';

export default function SignInPage() {
    return (
        <Suspense
            fallback={
                <main className="min-h-screen bg-gray-50 flex items-center justify-center px-4">
                    <div className="w-full max-w-md bg-white border border-gray-200 rounded-2xl p-8 shadow-sm">
                        <div className="h-6 w-32 bg-gray-200 rounded mb-4" />
                        <div className="h-4 w-64 bg-gray-100 rounded mb-8" />
                        <div className="h-11 w-full bg-gray-200 rounded-lg" />
                    </div>
                </main>
            }
        >
            <SignInContent />
        </Suspense>
    );
}

function SignInContent() {
    const [loading, setLoading] = useState(false);
    const params = useSearchParams();
    const redirectTo = useMemo(() => params.get('redirect_to') || '/dashboard', [params]);
    const error = useMemo(() => params.get('error'), [params]);

    const onSignIn = useCallback(async () => {
        setLoading(true);
        try {
            const configuredSiteUrl = process.env.NEXT_PUBLIC_SITE_URL || '';
            const origin = configuredSiteUrl || (typeof window !== 'undefined' ? window.location.origin : '');
            const callbackUrl = `${origin}/auth/callback?redirect_to=${encodeURIComponent(redirectTo)}`;
            await sb().auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: callbackUrl },
            });
        } finally {
            setLoading(false);
        }
    }, [redirectTo]);

    return (
        <main className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
            <div className="w-full max-w-md">
                {/* Logo / Brand */}
                <div className="text-center mb-8">
                    <div className="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-2xl mb-4">
                        <span className="text-2xl font-bold text-white">CAT</span>
                    </div>
                    <h1 className="text-2xl font-bold text-gray-900">Welcome to CAT Mocks</h1>
                    <p className="text-gray-600 mt-1">Practice makes perfect</p>
                </div>

                {/* Sign In Card */}
                <div className="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                    <div className="text-center mb-6">
                        <h2 className="text-xl font-semibold text-gray-900">Sign in to continue</h2>
                        <p className="text-sm text-gray-500 mt-1">
                            Access your dashboard, take mocks, and track progress
                        </p>
                    </div>

                    {error === 'rate_limited' && (
                        <div className="mb-4 rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-700">
                            Too many sign-in attempts. Please wait a minute and try again.
                        </div>
                    )}

                    {/* Google Sign In Button */}
                    <button
                        type="button"
                        onClick={onSignIn}
                        disabled={loading}
                        className="w-full h-12 inline-flex items-center justify-center gap-3 rounded-lg
                          border border-gray-300 bg-white text-gray-700 font-medium
                          hover:bg-gray-50 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                          disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                    >
                        {loading ? (
                            <div className="w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin" />
                        ) : (
                            <svg className="w-5 h-5" viewBox="0 0 24 24">
                                <path
                                    fill="#4285F4"
                                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                                />
                                <path
                                    fill="#34A853"
                                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                                />
                                <path
                                    fill="#FBBC05"
                                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                                />
                                <path
                                    fill="#EA4335"
                                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                                />
                            </svg>
                        )}
                        <span>{loading ? 'Redirecting...' : 'Continue with Google'}</span>
                    </button>

                    {/* Divider */}
                    <div className="relative my-6">
                        <div className="absolute inset-0 flex items-center">
                            <div className="w-full border-t border-gray-200" />
                        </div>
                        <div className="relative flex justify-center text-sm">
                            <span className="px-2 bg-white text-gray-400">Secure authentication</span>
                        </div>
                    </div>

                    {/* Features */}
                    <div className="space-y-3 text-sm text-gray-600">
                        <div className="flex items-center gap-2">
                            <svg className="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                            <span>Free access to CAT mock tests</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <svg className="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                            <span>Track your progress and percentile</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <svg className="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                            <span>Detailed solutions and analytics</span>
                        </div>
                    </div>
                </div>

                {/* Footer */}
                <p className="text-xs text-gray-500 text-center mt-6">
                    By continuing, you agree to our Terms of Service and Privacy Policy
                </p>
            </div>
        </main>
    );
}
````

## File: src/features/admin/ui/EditableExamLayout.tsx
````typescript
/**
 * @fileoverview Editable Exam Layout (Mirror Principle)
 * @description Exact replica of ExamLayout but with editable fields
 * @blueprint M6+ - Mirror Principle - Admin sees exactly what student sees
 */

'use client';

import { useState, useCallback, useMemo, useEffect, useRef, useId } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import type {
    Paper,
    QuestionWithAnswer,
    SectionName,
    QuestionContext,
    QuestionType,
    QuestionSet,
    ContentLayoutType,
} from '@/types/exam';
import { uploadToCloudinary } from '@/lib/cloudinary';
import { PaletteShell } from '@/features/shared/ui/PaletteShell';
import { MarkdownToolbar } from './MarkdownToolbar';
import { getTopicOptions, getSubtopicOptions } from '../config/topicOptions';

// =============================================================================
// TYPES
// =============================================================================

interface EditableExamLayoutProps {
    paper: Paper;
    questions: QuestionWithAnswer[];
    questionSets: QuestionSet[];
    contexts: QuestionContext[];
    onSaveQuestion: (question: Partial<QuestionWithAnswer>) => Promise<void>;
    onSaveQuestionSet: (set: Partial<QuestionSet>) => Promise<void>;
    onCreateQuestionSet: (set: Partial<QuestionSet>) => Promise<QuestionSet | null>;
    onSaveContext?: (context: Partial<QuestionContext>) => Promise<void>;
    onDeleteContext?: (contextId: string) => Promise<void>;
    onUpdatePaperTitle?: (title: string) => Promise<{ success: boolean; error?: string }>;
    initialNavigation?: EditorNavigationState | null;
    onNavigate?: (navigation: EditorNavigationUpdate) => void;
}

export interface EditorNavigationState {
    section?: SectionName;
    qid?: string | null;
    setId?: string | null;
    q?: number | null;
}

export interface EditorNavigationUpdate {
    section: SectionName;
    qid?: string | null;
    setId?: string | null;
    q: number;
}

const OPTION_LABELS = ['A', 'B', 'C', 'D'] as const;
const SECTIONS: SectionName[] = ['VARC', 'DILR', 'QA'];
const SECTION_TOTALS: Record<SectionName, number> = { VARC: 24, DILR: 20, QA: 22 };

// =============================================================================
// EDITABLE HEADER (Mirrors ExamHeader)
// =============================================================================

interface EditableHeaderProps {
    paper: Paper;
    currentSectionIndex: number;
    onSectionChange: (index: number) => void;
    onUpdatePaperTitle?: (title: string) => Promise<{ success: boolean; error?: string }>;
}

function EditableHeader({ paper, currentSectionIndex, onSectionChange, onUpdatePaperTitle }: EditableHeaderProps) {
    const router = useRouter();
    const [isEditingTitle, setIsEditingTitle] = useState(false);
    const [titleDraft, setTitleDraft] = useState(paper.title);
    const [titleError, setTitleError] = useState<string | null>(null);
    const [isSavingTitle, setIsSavingTitle] = useState(false);
    const editButtonRef = useRef<HTMLButtonElement | null>(null);
    const titleInputRef = useRef<HTMLInputElement | null>(null);

    useEffect(() => {
        if (isEditingTitle) {
            setTitleDraft(paper.title);
            setTitleError(null);
            requestAnimationFrame(() => titleInputRef.current?.focus());
        }
    }, [isEditingTitle, paper.title]);

    const exitEditMode = useCallback(() => {
        setIsEditingTitle(false);
        setTitleError(null);
        requestAnimationFrame(() => editButtonRef.current?.focus());
    }, []);

    const handleSaveTitle = useCallback(async () => {
        if (isSavingTitle) return;

        const trimmed = titleDraft.trim();
        if (!trimmed) {
            setTitleError('Title cannot be empty.');
            return;
        }

        if (!onUpdatePaperTitle) {
            exitEditMode();
            return;
        }

        setIsSavingTitle(true);
        setTitleError(null);

        try {
            const result = await onUpdatePaperTitle(trimmed);
            if (!result.success) {
                setTitleError(result.error || 'Failed to update title.');
                return;
            }
            exitEditMode();
        } finally {
            setIsSavingTitle(false);
        }
    }, [exitEditMode, isSavingTitle, onUpdatePaperTitle, titleDraft]);

    return (
        <header className="sticky top-0 z-50 bg-gradient-to-r from-exam-header-from to-exam-header-to text-white shadow-md">
            <div className="max-w-screen-2xl mx-auto px-4 py-3">
                <div className="flex items-center justify-between">
                    {/* Left - Back Button + Paper Info */}
                    <div className="flex items-center gap-4">
                        <button
                            onClick={() => router.push('/admin/papers')}
                            className="p-2 hover:bg-white/10 rounded-lg transition-colors"
                            title="Back to Papers"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth={2}
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"
                                />
                            </svg>
                        </button>

                        <div className="flex items-center gap-2">
                            <span className="px-1.5 py-0.5 bg-yellow-500/80 text-gray-900 text-[10px] font-bold rounded tracking-wider">
                                ✏️ EDIT
                            </span>

                            {!isEditingTitle ? (
                                <div className="flex items-center gap-2">
                                    <h1 className="text-xl font-bold">{paper.title}</h1>
                                    <button
                                        ref={editButtonRef}
                                        type="button"
                                        onClick={() => setIsEditingTitle(true)}
                                        className="px-2 py-1 text-xs font-semibold bg-white/10 hover:bg-white/20 rounded-md transition-colors"
                                        aria-label="Edit mock test name"
                                    >
                                        Edit name
                                    </button>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-1">
                                    <div className="flex flex-wrap items-center gap-2">
                                        <label className="sr-only" htmlFor="paper-title-input">
                                            Mock test name
                                        </label>
                                        <input
                                            ref={titleInputRef}
                                            id="paper-title-input"
                                            type="text"
                                            value={titleDraft}
                                            onChange={(e) => setTitleDraft(e.target.value)}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter') {
                                                    e.preventDefault();
                                                    handleSaveTitle();
                                                }
                                                if (e.key === 'Escape') {
                                                    e.preventDefault();
                                                    if (!isSavingTitle) exitEditMode();
                                                }
                                            }}
                                            className="w-64 sm:w-80 px-2 py-1 rounded-md text-sm text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-white"
                                            aria-invalid={titleError ? 'true' : 'false'}
                                        />
                                        <button
                                            type="button"
                                            onClick={handleSaveTitle}
                                            disabled={isSavingTitle}
                                            className="px-3 py-1 text-xs font-semibold bg-white text-exam-header-from rounded-md disabled:opacity-60 disabled:cursor-not-allowed"
                                        >
                                            {isSavingTitle ? 'Saving...' : 'Save'}
                                        </button>
                                        <button
                                            type="button"
                                            onClick={exitEditMode}
                                            disabled={isSavingTitle}
                                            className="px-3 py-1 text-xs font-semibold bg-white/10 hover:bg-white/20 rounded-md disabled:opacity-60 disabled:cursor-not-allowed"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                    {titleError && (
                                        <span className="text-xs text-yellow-200" role="alert">
                                            {titleError}
                                        </span>
                                    )}
                                </div>
                            )}
                        </div>

                        <div className="hidden sm:flex items-center gap-2 text-sm text-blue-100">
                            <span className="px-2 py-1 bg-white/10 rounded border border-white/20">
                                {paper.total_questions} Questions
                            </span>
                        </div>
                    </div>

                    {/* Center - Section Tabs */}
                    <div className="hidden md:flex items-center gap-2">
                        {SECTIONS.map((section, index) => {
                            const base =
                                'px-4 py-2 rounded-md text-sm font-semibold transition-colors border cursor-pointer';
                            const inactive = `${base} bg-white/10 text-blue-100 border-white/20 hover:bg-white/20`;

                            const active = (() => {
                                switch (section) {
                                    case 'VARC':
                                        return `${base} bg-section-varc text-white border-section-varc`;
                                    case 'DILR':
                                        return `${base} bg-section-dilr text-white border-section-dilr`;
                                    case 'QA':
                                        return `${base} bg-section-qa text-white border-section-qa`;
                                    default:
                                        return `${base} bg-white text-exam-header-from border-white`;
                                }
                            })();

                            return (
                                <button
                                    key={section}
                                    onClick={() => onSectionChange(index)}
                                    className={index === currentSectionIndex ? active : inactive}
                                >
                                    {section}
                                </button>
                            );
                        })}
                    </div>

                    {/* Right - Quick Links + Exit Button */}
                    <div className="flex items-center gap-2">
                        <Link
                            href={`/admin/papers/${paper.id}/questions`}
                            className="px-3 py-2 bg-white/10 hover:bg-white/20 text-white text-xs font-semibold rounded-md transition-colors"
                        >
                            Questions
                        </Link>
                        <Link
                            href={`/admin/papers/${paper.id}/settings`}
                            className="px-3 py-2 bg-white/10 hover:bg-white/20 text-white text-xs font-semibold rounded-md transition-colors"
                        >
                            Settings
                        </Link>
                        <Link
                            href="/admin/papers"
                            className="px-3 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-md text-sm transition-colors flex items-center gap-1"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth={2}
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                                />
                            </svg>
                            <span className="hidden sm:inline">Exit Editor</span>
                        </Link>
                    </div>
                </div>
            </div>
        </header>
    );
}

// =============================================================================
// EDITABLE MCQ OPTION (Mirrors MCQOption)
// =============================================================================

interface EditableOptionProps {
    label: string;
    value: string;
    isCorrect: boolean;
    onChange: (value: string) => void;
    onMarkCorrect: () => void;
}

function EditableOption({ label, value, isCorrect, onChange, onMarkCorrect }: EditableOptionProps) {
    return (
        <div
            className={`
                w-full flex items-start gap-3 p-4 rounded-lg border-2 transition-all
                ${isCorrect ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white hover:border-gray-300'}
            `}
        >
            <button
                type="button"
                onClick={onMarkCorrect}
                title={isCorrect ? 'Correct answer' : 'Click to mark as correct'}
                className={`
                    flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center
                    text-sm font-bold transition-colors cursor-pointer
                    ${isCorrect
                        ? 'bg-green-500 text-white'
                        : 'bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-600'}
                `}
            >
                {label}
            </button>

            <textarea
                value={value}
                onChange={(e) => onChange(e.target.value)}
                placeholder={`Enter option ${label}...`}
                rows={2}
                className="flex-1 text-left bg-transparent border border-gray-200 hover:border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 rounded px-2 py-1.5 outline-none text-gray-800 transition-colors resize-y min-h-[40px]"
            />

            {isCorrect && <span className="flex-shrink-0 text-green-500 text-sm font-medium">✓ Correct</span>}
        </div>
    );
}

// =============================================================================
// IMAGE UPLOAD ZONE (Where diagrams appear in exam)
// =============================================================================

interface ImageUploadZoneProps {
    imageUrl: string | null;
    onUpload: (file: File) => Promise<void>;
    onRemove: () => void;
    isUploading: boolean;
    label?: string;
}

function ImageUploadZone({ imageUrl, onUpload, onRemove, isUploading, label = 'Diagram/Image' }: ImageUploadZoneProps) {
    const [isDragging, setIsDragging] = useState(false);
    const inputId = useId();

    const handleDrop = useCallback(
        async (e: React.DragEvent) => {
            e.preventDefault();
            setIsDragging(false);
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                await onUpload(file);
            }
        },
        [onUpload]
    );

    const handleFileSelect = useCallback(
        async (e: React.ChangeEvent<HTMLInputElement>) => {
            const file = e.target.files?.[0];
            if (file) {
                await onUpload(file);
            }
        },
        [onUpload]
    );

    const handleDragOver = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(true);
    }, []);

    const handleDragLeave = useCallback(() => {
        setIsDragging(false);
    }, []);

    if (imageUrl) {
        return (
            <div className="relative rounded-lg overflow-hidden border border-gray-200 bg-gray-50">
                <img src={imageUrl} alt={label} className="w-full max-h-64 object-contain" />
                <button
                    onClick={onRemove}
                    className="absolute top-2 right-2 p-1.5 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors shadow-lg"
                    title="Remove image"
                >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        );
    }

    return (
        <div
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            className={`
                border-2 border-dashed rounded-lg p-6 text-center transition-colors cursor-pointer
                ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400 bg-gray-50'}
                ${isUploading ? 'opacity-50 pointer-events-none' : ''}
            `}
        >
            <input type="file" accept="image/*" onChange={handleFileSelect} className="hidden" id={inputId} />
            <label htmlFor={inputId} className="cursor-pointer">
                {isUploading ? (
                    <div className="flex flex-col items-center gap-2">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500" />
                        <span className="text-sm text-gray-500">Uploading...</span>
                    </div>
                ) : (
                    <div className="flex flex-col items-center gap-2">
                        <svg className="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={1.5}
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                            />
                        </svg>
                        <span className="text-sm font-medium text-gray-600">{label}</span>
                        <span className="text-xs text-gray-400">Drop image here or click to upload</span>
                    </div>
                )}
            </label>
        </div>
    );
}

// =============================================================================
// EDITABLE CONTEXT PANE (Mirrors ContextPane from ExamLayout)
// =============================================================================

interface EditableSetPaneProps {
    questionSet: QuestionSet | null;
    questionSets: QuestionSet[];
    section: SectionName;
    paperId: string;
    onSave: (set: Partial<QuestionSet>) => Promise<void>;
    onCreateSet: (setType: QuestionSet['set_type']) => Promise<QuestionSet | null>;
    onSelectSet: (setId: string | null) => void;
    selectedSetId: string | null;
}

function EditableSetPane({
    questionSet,
    questionSets,
    section,
    paperId,
    onSave,
    onCreateSet,
    onSelectSet,
    selectedSetId,
}: EditableSetPaneProps) {
    const [isEditing, setIsEditing] = useState(false);
    const [title, setTitle] = useState(questionSet?.context_title ?? '');
    const [content, setContent] = useState(questionSet?.context_body ?? '');
    const [layout, setLayout] = useState<ContentLayoutType>(
        questionSet?.content_layout ?? (section === 'QA' ? 'single_focus' : 'split_passage')
    );
    const [imageUrl, setImageUrl] = useState<string | null>(questionSet?.context_image_url ?? null);
    const [imagePosition, setImagePosition] = useState<string>(
        questionSet?.metadata?.image_position ?? 'before'
    );
    const [isUploading, setIsUploading] = useState(false);
    const [isSaving, setIsSaving] = useState(false);
    const contentTextareaRef = useRef<HTMLTextAreaElement | null>(null);

    // Count paragraphs in content for image position options
    const paragraphCount = useMemo(() => {
        if (!content) return 0;
        return content.split(/\n\n+/).filter(p => p.trim()).length;
    }, [content]);

    useEffect(() => {
        setTitle(questionSet?.context_title ?? '');
        setContent(questionSet?.context_body ?? '');
        setLayout(questionSet?.content_layout ?? (section === 'QA' ? 'single_focus' : 'split_passage'));
        setImageUrl(questionSet?.context_image_url ?? null);
        setImagePosition(questionSet?.metadata?.image_position ?? 'before');
        setIsEditing(false);
    }, [questionSet?.id, section]);

    const handleImageUpload = async (file: File) => {
        setIsUploading(true);
        try {
            const url = await uploadToCloudinary(file);
            setImageUrl(url);
        } catch (error) {
            console.error('Failed to upload context image:', error);
        } finally {
            setIsUploading(false);
        }
    };

    const sectionSets = questionSets.filter((s) => s.section === section);
    const createLabel =
        section === 'VARC' ? 'New VARC set (RC passage)' : section === 'DILR' ? 'New DILR set' : 'New ATOMIC set';

    const handleSave = async () => {
        if (!questionSet?.id) return;
        setIsSaving(true);
        try {
            await onSave({
                id: questionSet.id,
                paper_id: paperId,
                section,
                set_type: questionSet.set_type,
                content_layout: layout,
                context_title: title || undefined,
                context_body: content || undefined,
                context_image_url: imageUrl ?? undefined,
                context_additional_images: questionSet.context_additional_images ?? [],
                context_type: questionSet.context_type ?? undefined,
                metadata: {
                    ...questionSet.metadata,
                    image_position: imagePosition as 'before' | 'after' | `after_para_${number}`,
                },
                is_active: true,
            });
            setIsEditing(false);
        } finally {
            setIsSaving(false);
        }
    };

    return (
        <div className="bg-gray-50 border-r border-gray-200 h-[calc(100vh-220px)] flex flex-col overflow-hidden">
            <div className="sticky top-0 bg-gray-100 border-b border-gray-200 px-4 py-3 z-10">
                <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <svg className="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            />
                        </svg>
                        Set Stimulus
                    </h3>
                    <div className="flex items-center gap-2">
                        {!isEditing && questionSet && (
                            <button onClick={() => setIsEditing(true)} className="text-xs text-blue-600 hover:text-blue-800">
                                Edit
                            </button>
                        )}
                        {section !== 'QA' && (
                            <button
                                onClick={() => onCreateSet(section === 'VARC' ? 'VARC' : 'DILR')}
                                className="text-xs text-emerald-600 hover:text-emerald-800"
                            >
                                {createLabel}
                            </button>
                        )}
                    </div>
                </div>

                <select
                    value={selectedSetId ?? ''}
                    onChange={(e) => onSelectSet(e.target.value || null)}
                    className="w-full text-sm border border-gray-300 rounded px-2 py-1.5 bg-white"
                >
                    <option value="">— Select Set —</option>
                    {sectionSets.map((set) => (
                        <option key={set.id} value={set.id}>
                            {set.context_title || `Set ${set.display_order}`}
                        </option>
                    ))}
                </select>
            </div>

            <div className="flex-1 overflow-y-auto px-4 py-4">
                {questionSet ? (
                    isEditing ? (
                        <div className="space-y-3">
                            <select
                                value={layout}
                                onChange={(e) => setLayout(e.target.value as ContentLayoutType)}
                                className="w-full text-sm border border-gray-300 rounded px-2 py-1.5 bg-white"
                            >
                                <option value="split_passage">Split Passage</option>
                                <option value="split_chart">Split Chart</option>
                                <option value="split_table">Split Table</option>
                                <option value="single_focus">Single Focus</option>
                                <option value="image_top">Image Top</option>
                            </select>

                            <input
                                type="text"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                placeholder="Set title (e.g., Passage 1)"
                                className="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                            />

                            <MarkdownToolbar
                                textareaRef={contentTextareaRef}
                                value={content}
                                onChange={setContent}
                            />
                            <textarea
                                ref={contentTextareaRef}
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                placeholder="Set stimulus / passage"
                                rows={12}
                                className="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-y font-mono leading-relaxed"
                            />

                            <div className="space-y-2">
                                <label className="block text-xs font-medium text-gray-600">Context Image (optional)</label>
                                <ImageUploadZone
                                    onUpload={handleImageUpload}
                                    imageUrl={imageUrl}
                                    onRemove={() => setImageUrl(null)}
                                    label="Drop image or click to upload"
                                    isUploading={isUploading}
                                />
                            </div>

                            {/* Image Position Selector - only show when image is uploaded */}
                            {imageUrl && (
                                <div className="space-y-2">
                                    <label className="block text-xs font-medium text-gray-600">
                                        Image Placement Position
                                    </label>
                                    <select
                                        value={imagePosition}
                                        onChange={(e) => setImagePosition(e.target.value)}
                                        className="w-full text-sm border border-gray-300 rounded px-2 py-1.5 bg-white"
                                    >
                                        <option value="before">Before text (top)</option>
                                        <option value="after">After text (bottom)</option>
                                        {paragraphCount > 0 && Array.from({ length: paragraphCount }, (_, i) => (
                                            <option key={`para-${i + 1}`} value={`after_para_${i + 1}`}>
                                                After paragraph {i + 1}
                                            </option>
                                        ))}
                                    </select>
                                    <p className="text-[10px] text-gray-400">
                                        Choose where the image appears relative to the passage text. Paragraphs are detected by double line breaks.
                                    </p>
                                </div>
                            )}

                            <div className="flex justify-end gap-2">
                                <button
                                    type="button"
                                    onClick={() => setIsEditing(false)}
                                    className="px-3 py-1.5 text-gray-600 hover:bg-gray-200 rounded text-sm transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="button"
                                    onClick={handleSave}
                                    disabled={isSaving}
                                    className="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-colors disabled:opacity-50"
                                >
                                    {isSaving ? 'Saving...' : 'Save Set'}
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {questionSet.context_image_url && (
                                <div className="rounded-lg overflow-hidden border border-gray-200 bg-white">
                                    <img
                                        src={questionSet.context_image_url}
                                        alt={questionSet.context_title || 'Set image'}
                                        className="w-full object-contain max-h-80"
                                    />
                                </div>
                            )}
                            <div className="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">
                                {questionSet.context_body || 'No set stimulus.'}
                            </div>
                        </div>
                    )
                ) : (
                    <div className="text-center py-8 text-gray-400">
                        <svg className="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={1.5}
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            />
                        </svg>
                        <p className="text-sm">No set selected</p>
                        <p className="text-xs mt-1">Choose a set to edit stimulus</p>
                    </div>
                )}
            </div>
        </div>
    );
}

interface EditableContextPaneProps {
    context: QuestionContext | null;
    contexts: QuestionContext[];
    section: SectionName;
    paperId: string;
    onSave: (context: Partial<QuestionContext>) => Promise<void>;
    onDeleteContext?: (contextId: string) => Promise<void>;
    onSelectContext: (contextId: string | null) => void;
    selectedContextId: string | null;
}

function EditableContextPane({
    context,
    contexts,
    section,
    paperId,
    onSave,
    onDeleteContext,
    onSelectContext,
    selectedContextId,
}: EditableContextPaneProps) {
    const [isEditing, setIsEditing] = useState(false);
    const [title, setTitle] = useState(context?.title ?? '');
    const [content, setContent] = useState(context?.content ?? '');
    const [contextType, setContextType] = useState<'passage' | 'data_set' | 'image' | 'table'>(
        (context?.context_type as 'passage' | 'data_set' | 'image' | 'table') ?? 'passage'
    );
    const [imageUrl, setImageUrl] = useState<string | null>(context?.image_url ?? null);
    const [isUploading, setIsUploading] = useState(false);
    const [isSaving, setIsSaving] = useState(false);
    const [isDeleting, setIsDeleting] = useState(false);
    const contentTextareaRef = useRef<HTMLTextAreaElement | null>(null);

    useEffect(() => {
        setTitle(context?.title ?? '');
        setContent(context?.content ?? '');
        setContextType((context?.context_type as 'passage' | 'data_set' | 'image' | 'table') ?? 'passage');
        setImageUrl(context?.image_url ?? null);
        setIsEditing(!context);
    }, [context?.id]);

    const handleImageUpload = async (file: File) => {
        setIsUploading(true);
        try {
            const url = await uploadToCloudinary(file);
            setImageUrl(url);
        } catch (error) {
            console.error('Failed to upload context image:', error);
        } finally {
            setIsUploading(false);
        }
    };

    const sectionContexts = contexts.filter((c) => c.section === section);

    const handleSave = async () => {
        setIsSaving(true);
        try {
            await onSave({
                ...context,
                paper_id: paperId,
                section,
                title: title || undefined,
                content,
                context_type: contextType,
                image_url: imageUrl ?? undefined,
                is_active: true,
                display_order: context?.display_order ?? sectionContexts.length + 1,
            });
            setIsEditing(false);
        } finally {
            setIsSaving(false);
        }
    };

    return (
        <div className="bg-gray-50 border-r border-gray-200 h-[calc(100vh-220px)] flex flex-col overflow-hidden">
            <div className="sticky top-0 bg-gray-100 border-b border-gray-200 px-4 py-3 z-10">
                <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                        <svg className="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            />
                        </svg>
                        {section === 'VARC' ? 'Reading Passage' : 'Data Set / Context'}
                    </h3>

                    <div className="flex items-center gap-2">
                        {!isEditing && context && (
                            <button onClick={() => setIsEditing(true)} className="text-xs text-blue-600 hover:text-blue-800">
                                Edit
                            </button>
                        )}
                        {!isEditing && context && onDeleteContext && (
                            <button
                                onClick={async () => {
                                    if (!context?.id || isDeleting) return;
                                    const confirmed = window.confirm(
                                        'Delete this context? This will hide it from selection.'
                                    );
                                    if (!confirmed) return;
                                    setIsDeleting(true);
                                    try {
                                        await onDeleteContext(context.id);
                                        onSelectContext(null);
                                        setIsEditing(false);
                                    } finally {
                                        setIsDeleting(false);
                                    }
                                }}
                                disabled={isDeleting}
                                className="text-xs text-red-600 hover:text-red-800 disabled:opacity-50"
                            >
                                {isDeleting ? 'Deleting...' : 'Delete'}
                            </button>
                        )}
                    </div>
                </div>

                <select
                    value={selectedContextId ?? 'none'}
                    onChange={(e) => onSelectContext(e.target.value === 'none' ? null : e.target.value)}
                    className="w-full text-sm border border-gray-300 rounded px-2 py-1.5 bg-white"
                >
                    <option value="none">— No Context —</option>
                    <option value="new">+ Create New Context</option>
                    {sectionContexts.map((c) => (
                        <option key={c.id} value={c.id}>
                            {c.title || `Context ${c.display_order}`}
                        </option>
                    ))}
                </select>
            </div>

            <div className="flex-1 overflow-y-auto px-4 py-4">
                {selectedContextId === 'new' || isEditing ? (
                    <div className="space-y-3">
                        <select
                            value={contextType}
                            onChange={(e) => setContextType(e.target.value as typeof contextType)}
                            className="w-full text-sm border border-gray-300 rounded px-2 py-1.5 bg-white"
                        >
                            <option value="passage">Passage</option>
                            <option value="data_set">Data Set</option>
                            <option value="table">Table</option>
                            <option value="image">Image Only</option>
                        </select>

                        <input
                            type="text"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            placeholder="Context title (e.g., Passage 1, Set A)..."
                            className="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                        />

                        <MarkdownToolbar
                            textareaRef={contentTextareaRef}
                            value={content}
                            onChange={setContent}
                        />
                        <textarea
                            ref={contentTextareaRef}
                            value={content}
                            onChange={(e) => setContent(e.target.value)}
                            placeholder={
                                section === 'VARC'
                                    ? 'Paste the reading passage here...'
                                    : 'Enter the data set, table description, or context...'
                            }
                            rows={12}
                            className="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-y font-mono leading-relaxed"
                        />

                        <div className="space-y-2">
                            <label className="block text-xs font-medium text-gray-600">
                                Context Image (Diagrams, Charts, Tables)
                            </label>
                            <ImageUploadZone
                                onUpload={handleImageUpload}
                                imageUrl={imageUrl}
                                onRemove={() => setImageUrl(null)}
                                label="Drop context image or click to upload"
                                isUploading={isUploading}
                            />
                        </div>

                        <div className="flex justify-end gap-2">
                            <button
                                type="button"
                                onClick={() => {
                                    setIsEditing(false);
                                    if (selectedContextId === 'new') onSelectContext(null);
                                }}
                                className="px-3 py-1.5 text-gray-600 hover:bg-gray-200 rounded text-sm transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                type="button"
                                onClick={handleSave}
                                disabled={isSaving || !content.trim()}
                                className="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-colors disabled:opacity-50"
                            >
                                {isSaving ? 'Saving...' : 'Save Context'}
                            </button>
                        </div>
                    </div>
                ) : context ? (
                    <div className="space-y-4">
                        {context.image_url && (
                            <div className="rounded-lg overflow-hidden border border-gray-200 bg-white">
                                <img
                                    src={context.image_url}
                                    alt={context.title || 'Context image'}
                                    className="w-full object-contain max-h-80"
                                />
                            </div>
                        )}
                        <div className="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">{context.content}</div>
                    </div>
                ) : (
                    <div className="text-center py-8 text-gray-400">
                        <svg className="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={1.5}
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            />
                        </svg>
                        <p className="text-sm">No context selected</p>
                        <p className="text-xs mt-1">Select or create a context above</p>
                    </div>
                )}
            </div>
        </div>
    );
}

// =============================================================================
// EDITABLE QUESTION AREA (Mirrors QuestionArea exactly)
// =============================================================================

interface EditableQuestionAreaProps {
    question: Partial<QuestionWithAnswer> | null;
    questionNumber: number;
    totalQuestions: number;
    section: SectionName;
    paperId: string;
    onSave: (question: Partial<QuestionWithAnswer>) => Promise<void>;
    selectedSetId: string | null;
    selectedContextId: string | null;
    isSaving: boolean;
}

function EditableQuestionArea({
    question,
    questionNumber,
    totalQuestions,
    section,
    paperId,
    onSave,
    selectedSetId,
    selectedContextId,
    isSaving,
}: EditableQuestionAreaProps) {
    const [questionText, setQuestionText] = useState(question?.question_text ?? '');
    const [questionType, setQuestionType] = useState<QuestionType>(question?.question_type ?? 'MCQ');
    const [options, setOptions] = useState<string[]>(() =>
        Array.isArray(question?.options) ? [...question.options] : ['', '', '', '']
    );
    const [correctAnswer, setCorrectAnswer] = useState(question?.correct_answer ?? 'A');
    const [positiveMarks, setPositiveMarks] = useState(question?.positive_marks ?? 3);
    const [negativeMarks, setNegativeMarks] = useState(question?.negative_marks ?? 1);
    const [solutionText, setSolutionText] = useState(question?.solution_text ?? '');
    const [imageUrl, setImageUrl] = useState<string | null>(null);
    const [isUploading, setIsUploading] = useState(false);
    const questionTextareaRef = useRef<HTMLTextAreaElement | null>(null);
    const solutionTextareaRef = useRef<HTMLTextAreaElement | null>(null);
    const [topic, setTopic] = useState(question?.topic ?? '');
    const [subtopic, setSubtopic] = useState(question?.subtopic ?? '');

    const topicOptions = useMemo(() => getTopicOptions(section, topic), [section, topic]);
    const subtopicOptions = useMemo(() => getSubtopicOptions(section, topic, subtopic), [section, topic, subtopic]);

    useEffect(() => {
        if (!question) {
            setQuestionText('');
            setQuestionType('MCQ');
            setOptions(['', '', '', '']);
            setCorrectAnswer('A');
            setPositiveMarks(3);
            setNegativeMarks(1);
            setSolutionText('');
            setImageUrl(null);
            setTopic('');
            setSubtopic('');
            return;
        }

        setQuestionText(question.question_text ?? '');
        setQuestionType(question.question_type ?? 'MCQ');
        setOptions(Array.isArray(question.options) ? [...question.options] : ['', '', '', '']);
        setCorrectAnswer(question.correct_answer ?? 'A');
        setPositiveMarks(question.positive_marks ?? 3);
        setNegativeMarks(question.negative_marks ?? 1);
        setImageUrl(question.question_image_url ?? null);
        setSolutionText(question.solution_text ?? '');
        setTopic(question.topic ?? '');
        setSubtopic(question.subtopic ?? '');
    }, [question?.id]);

    useEffect(() => {
        const textarea = questionTextareaRef.current;
        if (!textarea) return;
        textarea.style.height = 'auto';
        textarea.style.height = `${textarea.scrollHeight}px`;
    }, [questionText]);

    const handleOptionChange = useCallback((index: number, value: string) => {
        setOptions((prev) => {
            const next = [...prev];
            next[index] = value;
            return next;
        });
    }, []);

    const handleImageUpload = useCallback(async (file: File) => {
        setIsUploading(true);
        try {
            const url = await uploadToCloudinary(file);
            setImageUrl(url);
        } catch (err) {
            console.error('Upload failed:', err);
        } finally {
            setIsUploading(false);
        }
    }, []);

    const handleSave = useCallback(async () => {
        const useSet = Boolean(selectedSetId);
        const questionData: Partial<QuestionWithAnswer> = {
            ...question,
            id: question?.id,
            paper_id: paperId,
            section,
            question_number: questionNumber,
            question_text: questionText,
            question_type: questionType,
            options: questionType === 'MCQ' ? options : null,
            correct_answer: correctAnswer,
            positive_marks: positiveMarks,
            negative_marks: questionType === 'TITA' ? 0 : negativeMarks,
            solution_text: solutionText || undefined,
            question_image_url: imageUrl || undefined,
            topic: topic || undefined,
            subtopic: subtopic || undefined,
            set_id: useSet ? selectedSetId ?? undefined : undefined,
            context_id: useSet ? undefined : selectedContextId && selectedContextId !== 'new' ? selectedContextId : undefined,
            is_active: true,
        };

        await onSave(questionData);
    }, [
        question,
        paperId,
        section,
        questionNumber,
        questionText,
        questionType,
        options,
        correctAnswer,
        positiveMarks,
        negativeMarks,
        solutionText,
        imageUrl,
        topic,
        subtopic,
        selectedSetId,
        selectedContextId,
        onSave,
    ]);

    return (
        <div className="bg-white h-full overflow-y-auto">
            <div className="p-6">
                <div className="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                    <div>
                        <span className="text-sm text-gray-500">{section}</span>
                        <h2 className="text-lg font-semibold text-gray-800">
                            Question {questionNumber} of {totalQuestions}
                        </h2>
                    </div>

                    <div className="flex items-center gap-2">
                        <div className="flex items-center gap-1">
                            <span className="text-xs text-gray-500">+</span>
                            <input
                                type="number"
                                value={positiveMarks}
                                onChange={(e) => setPositiveMarks(Number(e.target.value))}
                                className="w-12 px-2 py-1 text-sm border border-green-300 rounded bg-green-50 text-green-700 text-center"
                                min={0}
                                step={0.5}
                            />
                        </div>
                        <div className="flex items-center gap-1">
                            <span className="text-xs text-gray-500">−</span>
                            <input
                                type="number"
                                value={negativeMarks}
                                onChange={(e) => setNegativeMarks(Number(e.target.value))}
                                className="w-12 px-2 py-1 text-sm border border-red-300 rounded bg-red-50 text-red-700 text-center"
                                min={0}
                                step={0.25}
                            />
                        </div>
                        <select
                            value={questionType}
                            onChange={(e) => setQuestionType(e.target.value as QuestionType)}
                            className="px-2 py-1 text-sm border border-gray-300 rounded bg-white"
                        >
                            <option value="MCQ">MCQ</option>
                            <option value="TITA">TITA</option>
                        </select>
                    </div>
                </div>

                <div className="mb-6">
                    <ImageUploadZone
                        imageUrl={imageUrl}
                        onUpload={handleImageUpload}
                        onRemove={() => setImageUrl(null)}
                        isUploading={isUploading}
                        label="Question Diagram/Image"
                    />
                </div>

                <div className="mb-6">
                    <MarkdownToolbar
                        textareaRef={questionTextareaRef}
                        value={questionText}
                        onChange={setQuestionText}
                        className="mb-2"
                    />
                    <div className="prose prose-lg max-w-none">
                        <textarea
                            ref={questionTextareaRef}
                            value={questionText}
                            onChange={(e) => setQuestionText(e.target.value)}
                            placeholder="Enter question text..."
                            rows={1}
                            className="w-full bg-transparent border border-transparent hover:border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 rounded-lg outline-none resize-none overflow-hidden text-gray-800 whitespace-pre-wrap transition-colors"
                        />
                    </div>
                </div>

                {questionType === 'MCQ' ? (
                    <div className="space-y-3">
                        {OPTION_LABELS.map((label, index) => (
                            <EditableOption
                                key={label}
                                label={label}
                                value={options[index] || ''}
                                isCorrect={correctAnswer === label}
                                onChange={(value) => handleOptionChange(index, value)}
                                onMarkCorrect={() => setCorrectAnswer(label)}
                            />
                        ))}
                    </div>
                ) : (
                    <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Correct Answer (Numeric)</label>
                        <input
                            type="text"
                            value={correctAnswer}
                            onChange={(e) => setCorrectAnswer(e.target.value)}
                            placeholder="Enter the correct numeric answer..."
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                    </div>
                )}

                <details className="mt-6">
                    <summary className="cursor-pointer text-sm font-medium text-gray-600 hover:text-gray-800">
                        Solution (Optional)
                    </summary>
                    <MarkdownToolbar
                        textareaRef={solutionTextareaRef}
                        value={solutionText}
                        onChange={setSolutionText}
                        className="mt-3"
                    />
                    <textarea
                        ref={solutionTextareaRef}
                        value={solutionText}
                        onChange={(e) => setSolutionText(e.target.value)}
                        placeholder="Enter solution explanation..."
                        rows={3}
                        className="mt-3 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                    />
                </details>

                <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Topic
                        </label>
                        <select
                            value={topic}
                            onChange={(e) => {
                                const nextTopic = e.target.value;
                                setTopic(nextTopic);
                                if (!getSubtopicOptions(section, nextTopic).includes(subtopic)) {
                                    setSubtopic('');
                                }
                            }}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                        >
                            <option value="">— Select Topic —</option>
                            {topicOptions.map((option) => (
                                <option key={option} value={option}>
                                    {option}
                                </option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Subtopic
                        </label>
                        <select
                            value={subtopic}
                            onChange={(e) => setSubtopic(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                        >
                            <option value="">— Select Subtopic —</option>
                            {subtopicOptions.map((option) => (
                                <option key={option} value={option}>
                                    {option}
                                </option>
                            ))}
                        </select>
                    </div>
                </div>

                <div className="mt-6 pt-4 border-t border-gray-200 flex justify-end">
                    <button
                        onClick={handleSave}
                        disabled={isSaving}
                        className={`
                        px-6 py-2.5 rounded-lg font-medium transition-colors flex items-center gap-2
                        ${isSaving ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}
                    `}
                    >
                        {isSaving ? (
                            <>
                                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" />
                                Saving...
                            </>
                        ) : (
                            <>
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                                Save Question
                            </>
                        )}
                    </button>
                </div>
            </div>
        </div>
    );
}

// =============================================================================
// EDITABLE QUESTION PALETTE (Mirrors QuestionPalette)
// =============================================================================

interface EditablePaletteProps {
    questions: QuestionWithAnswer[];
    section: SectionName;
    currentIndex: number;
    onSelect: (index: number) => void;
    onAddNew: () => void;
}

function EditablePalette({ questions, section, currentIndex, onSelect, onAddNew }: EditablePaletteProps) {
    const sectionQuestions = questions.filter((q) => q.section === section);
    const expectedCount = SECTION_TOTALS[section];

    return (
        <PaletteShell>
            <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-gray-800">{section} Questions</h3>
                <span className="text-sm text-gray-500">
                    {sectionQuestions.length}/{expectedCount}
                </span>
            </div>

            <div className="grid grid-cols-5 gap-2 mb-4">
                {Array.from({ length: expectedCount }, (_, i) => {
                    const q = sectionQuestions[i];
                    const hasContent = q && q.question_text?.trim();

                    return (
                        <button
                            key={i}
                            onClick={() => onSelect(i)}
                            className={`
                                w-10 h-10 rounded-lg text-sm font-medium transition-colors
                                ${currentIndex === i
                                    ? 'bg-blue-600 text-white ring-2 ring-blue-300'
                                    : hasContent
                                        ? 'bg-green-100 text-green-700 hover:bg-green-200'
                                        : 'bg-gray-100 text-gray-400 hover:bg-gray-200'
                                }
                            `}
                        >
                            {i + 1}
                        </button>
                    );
                })}
            </div>

            <button
                onClick={onAddNew}
                className="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-500 transition-colors flex items-center justify-center gap-2"
            >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                </svg>
                Add Question
            </button>

            <div className="mt-4 pt-4 border-t border-gray-200 flex items-center gap-4 text-xs text-gray-500">
                <div className="flex items-center gap-1">
                    <span className="w-3 h-3 rounded bg-green-100 border border-green-300" />
                    <span>Has content</span>
                </div>
                <div className="flex items-center gap-1">
                    <span className="w-3 h-3 rounded bg-gray-100 border border-gray-300" />
                    <span>Empty</span>
                </div>
            </div>
        </PaletteShell>
    );
}

// =============================================================================
// MAIN EDITABLE EXAM LAYOUT
// =============================================================================

export function EditableExamLayout({
    paper,
    questions,
    questionSets,
    contexts,
    onSaveQuestion,
    onSaveQuestionSet,
    onCreateQuestionSet,
    onSaveContext,
    onDeleteContext,
    onUpdatePaperTitle,
    initialNavigation,
    onNavigate,
}: EditableExamLayoutProps) {
    const [currentSectionIndex, setCurrentSectionIndex] = useState(0);
    const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
    const [isSaving, setIsSaving] = useState(false);
    const [selectedSetId, setSelectedSetId] = useState<string | null>(null);
    const [selectedContextId, setSelectedContextId] = useState<string | null>(null);
    const appliedNavKeyRef = useRef<string | null>(null);

    const currentSection = SECTIONS[currentSectionIndex];

    const sectionQuestions = useMemo(
        () => questions.filter((q) => q.section === currentSection),
        [questions, currentSection]
    );

    const currentQuestion = sectionQuestions[currentQuestionIndex] ?? null;
    const totalExpected = SECTION_TOTALS[currentSection];

    const currentSet = selectedSetId ? questionSets.find((set) => set.id === selectedSetId) ?? null : null;
    const useSetStimulus = Boolean(currentSet);

    const showContextColumn = useSetStimulus
        ? currentSet?.set_type !== 'ATOMIC'
        : currentSection === 'VARC' || currentSection === 'DILR';

    const questionColSpan = showContextColumn ? '' : 'lg:col-span-2';

    const currentContext =
        selectedContextId && selectedContextId !== 'new'
            ? contexts.find((c) => c.id === selectedContextId) ?? null
            : null;

    useEffect(() => {
        if (currentQuestion?.set_id) setSelectedSetId(currentQuestion.set_id);
        setSelectedContextId(currentQuestion?.context_id ?? null);
    }, [currentQuestion?.id, currentQuestion?.set_id, currentQuestion?.context_id]);

    useEffect(() => {
        if (!initialNavigation) return;

        const navKey = `${initialNavigation.section ?? ''}|${initialNavigation.qid ?? ''}|${initialNavigation.setId ?? ''}|${initialNavigation.q ?? ''}`;
        if (appliedNavKeyRef.current === navKey) return;
        appliedNavKeyRef.current = navKey;

        let nextSection = initialNavigation.section;

        const questionFromId = initialNavigation.qid ? questions.find((q) => q.id === initialNavigation.qid) ?? null : null;
        const setFromId = initialNavigation.setId ? questionSets.find((set) => set.id === initialNavigation.setId) ?? null : null;

        if (questionFromId) nextSection = questionFromId.section;
        else if (setFromId) nextSection = setFromId.section;

        if (!nextSection || !SECTIONS.includes(nextSection)) nextSection = SECTIONS[0];

        const nextSectionIndex = SECTIONS.indexOf(nextSection);
        const sectionQuestionsResolved = questions.filter((q) => q.section === nextSection);

        let nextQuestionIndex = 0;

        if (questionFromId && questionFromId.section === nextSection) {
            const idx = sectionQuestionsResolved.findIndex((q) => q.id === questionFromId.id);
            if (idx >= 0) nextQuestionIndex = idx;
        }

        if (!questionFromId && initialNavigation.setId) {
            const idx = sectionQuestionsResolved.findIndex((q) => q.set_id === initialNavigation.setId);
            if (idx >= 0) nextQuestionIndex = idx;
        }

        if (!questionFromId && typeof initialNavigation.q === 'number' && Number.isFinite(initialNavigation.q)) {
            const fallbackIndex = Math.max(0, initialNavigation.q - 1);
            nextQuestionIndex = Math.min(fallbackIndex, Math.max(sectionQuestionsResolved.length - 1, 0));
        }

        setCurrentSectionIndex(nextSectionIndex);
        setCurrentQuestionIndex(nextQuestionIndex);

        if (initialNavigation.setId) setSelectedSetId(initialNavigation.setId);
        else if (questionFromId?.set_id) setSelectedSetId(questionFromId.set_id);
    }, [initialNavigation, questions, questionSets]);

    const emitNavigation = useCallback(
        (sectionIndex: number, questionIndex: number, setOverride?: string | null) => {
            if (!onNavigate) return;

            const sectionName = SECTIONS[Math.max(0, Math.min(sectionIndex, SECTIONS.length - 1))];
            const sectionQuestionsForNav = questions.filter((q) => q.section === sectionName);

            const maxIndex = Math.max(0, sectionQuestionsForNav.length - 1);
            const resolvedIndex = Math.max(0, Math.min(questionIndex, maxIndex));
            const q = sectionQuestionsForNav[resolvedIndex] ?? null;

            onNavigate({
                section: sectionName,
                qid: q?.id ?? null,
                setId: setOverride ?? q?.set_id ?? null,
                q: resolvedIndex + 1,
            });
        },
        [onNavigate, questions]
    );

    useEffect(() => {
        const maxIndex = Math.max(0, sectionQuestions.length - 1);
        if (currentQuestionIndex > maxIndex) {
            setCurrentQuestionIndex(maxIndex);
            emitNavigation(currentSectionIndex, maxIndex, selectedSetId);
        }
    }, [sectionQuestions.length, currentQuestionIndex, currentSectionIndex, emitNavigation, selectedSetId]);

    useEffect(() => {
        if (process.env.NODE_ENV === 'production') return;

        if (sectionQuestions.length === 0 && currentQuestionIndex !== 0) {
            console.warn('[ExamEditor] Navigation state invalid (section/q/set mismatch)', {
                section: currentSection,
                questionIndex: currentQuestionIndex,
                sectionQuestionCount: sectionQuestions.length,
            });
        }

        if (currentQuestion && currentQuestion.section !== currentSection) {
            console.warn('[ExamEditor] Navigation state invalid (section/q/set mismatch)', {
                section: currentSection,
                questionId: currentQuestion.id,
                questionSection: currentQuestion.section,
            });
        }

        if (currentQuestion && selectedSetId && currentQuestion.set_id && currentQuestion.set_id !== selectedSetId) {
            console.warn('[ExamEditor] Navigation state invalid (section/q/set mismatch)', {
                section: currentSection,
                questionId: currentQuestion.id,
                questionSetId: currentQuestion.set_id,
                selectedSetId,
            });
        }
    }, [currentSection, currentQuestionIndex, currentQuestion, sectionQuestions.length, selectedSetId]);

    const handleSave = useCallback(
        async (questionData: Partial<QuestionWithAnswer>) => {
            setIsSaving(true);
            try {
                await onSaveQuestion(questionData);
            } finally {
                setIsSaving(false);
            }
        },
        [onSaveQuestion]
    );

    const handleSaveContext = useCallback(
        async (contextData: Partial<QuestionContext>) => {
            if (onSaveContext) await onSaveContext(contextData);
        },
        [onSaveContext]
    );

    const handleCreateSet = useCallback(
        async (setType: QuestionSet['set_type']) => {
            const sectionSets = questionSets.filter((set) => set.section === currentSection);
            const nextOrder = sectionSets.reduce((max, set) => Math.max(max, set.display_order ?? 0), 0) + 1;

            const defaultLayout: Record<QuestionSet['set_type'], ContentLayoutType> = {
                VARC: 'split_passage',
                DILR: 'split_chart',
                CASELET: 'split_table',
                ATOMIC: 'single_focus',
            };

            const defaultContextTitle =
                setType === 'VARC' ? `Passage ${sectionSets.length + 1}` : `Set ${sectionSets.length + 1}`;

            const created = await onCreateQuestionSet({
                paper_id: paper.id,
                section: currentSection,
                set_type: setType,
                content_layout: defaultLayout[setType],
                context_title: setType === 'ATOMIC' ? undefined : defaultContextTitle,
                context_body: setType === 'ATOMIC' ? undefined : '',
                context_image_url: undefined,
                context_additional_images: [],
                display_order: nextOrder,
                question_count: 0,
                metadata: {},
                is_active: true,
                is_published: false,
            });

            if (created) setSelectedSetId(created.id);
            return created;
        },
        [questionSets, currentSection, onCreateQuestionSet, paper.id]
    );

    const handleAddQuestionToSet = useCallback(async () => {
        let targetSetId = selectedSetId;

        if (!targetSetId) {
            const autoSetType = currentSection === 'QA' ? 'ATOMIC' : currentSection === 'VARC' ? 'VARC' : 'DILR';
            const created = await handleCreateSet(autoSetType);
            if (!created) return;
            targetSetId = created.id;
        }

        const nextQuestionNumber =
            sectionQuestions.reduce((max, q) => Math.max(max, q.question_number ?? 0), 0) + 1;

        const setQuestions = questions.filter((q) => q.set_id === targetSetId);
        const nextSequence = setQuestions.reduce((max, q) => Math.max(max, q.sequence_order ?? 0), 0) + 1;

        await handleSave({
            paper_id: paper.id,
            section: currentSection,
            question_number: nextQuestionNumber,
            question_text: '',
            question_type: 'MCQ',
            question_format: 'MCQ',
            options: ['', '', '', ''],
            correct_answer: 'A',
            positive_marks: 3,
            negative_marks: 1,
            set_id: targetSetId,
            sequence_order: nextSequence,
            is_active: true,
        });

        setSelectedSetId(targetSetId);
        const nextIndex = sectionQuestions.length;
        setCurrentQuestionIndex(nextIndex);
        emitNavigation(currentSectionIndex, nextIndex, targetSetId);
    }, [
        selectedSetId,
        currentSection,
        handleCreateSet,
        sectionQuestions,
        questions,
        handleSave,
        paper.id,
        emitNavigation,
        currentSectionIndex,
    ]);

    const handleSectionChange = useCallback(
        (index: number) => {
            setCurrentSectionIndex(index);
            setCurrentQuestionIndex(0);
            setSelectedSetId(null);
            emitNavigation(index, 0, null);
        },
        [emitNavigation]
    );

    const handleQuestionSelect = useCallback(
        (index: number) => {
            setCurrentQuestionIndex(index);
            emitNavigation(currentSectionIndex, index, selectedSetId);
        },
        [currentSectionIndex, emitNavigation, selectedSetId]
    );

    const handleSelectSet = useCallback(
        (setId: string | null) => {
            setSelectedSetId(setId);
            emitNavigation(currentSectionIndex, currentQuestionIndex, setId);
        },
        [currentSectionIndex, currentQuestionIndex, emitNavigation]
    );

    return (
        <div className="min-h-screen bg-[#f5f7fa] flex flex-col">
            <EditableHeader
                paper={paper}
                currentSectionIndex={currentSectionIndex}
                onSectionChange={handleSectionChange}
                onUpdatePaperTitle={onUpdatePaperTitle}
            />

            <main className="flex-1 max-w-screen-2xl mx-auto w-full px-4 py-6">
                <div className="grid grid-cols-1 lg:grid-cols-[48%_33%_19%] gap-6 lg:gap-0 min-h-[calc(100vh-220px)]">
                    {showContextColumn && (
                        <div className="border border-gray-200 bg-gray-50 min-h-0 lg:border-r-0">
                            {useSetStimulus ? (
                                <EditableSetPane
                                    questionSet={currentSet}
                                    questionSets={questionSets}
                                    section={currentSection}
                                    paperId={paper.id}
                                    onSave={onSaveQuestionSet}
                                    onCreateSet={handleCreateSet}
                                    onSelectSet={handleSelectSet}
                                    selectedSetId={selectedSetId}
                                />
                            ) : (
                                <EditableContextPane
                                    context={currentContext}
                                    contexts={contexts}
                                    section={currentSection}
                                    paperId={paper.id}
                                    onSave={handleSaveContext}
                                    onDeleteContext={onDeleteContext}
                                    onSelectContext={setSelectedContextId}
                                    selectedContextId={selectedContextId}
                                />
                            )}
                        </div>
                    )}

                    <div
                        className={`border border-gray-200 bg-white min-h-0 ${questionColSpan} ${showContextColumn ? 'lg:border-l-0' : ''
                            }`}
                    >
                        <EditableQuestionArea
                            question={currentQuestion}
                            questionNumber={currentQuestionIndex + 1}
                            totalQuestions={totalExpected}
                            section={currentSection}
                            paperId={paper.id}
                            selectedSetId={selectedSetId}
                            selectedContextId={selectedContextId}
                            onSave={handleSave}
                            isSaving={isSaving}
                        />
                    </div>

                    <aside className="hidden lg:flex flex-col border border-gray-200 bg-white min-h-0 lg:border-l-0">
                        <div className="sticky top-6 space-y-4 p-4">
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                                <h3 className="font-semibold text-gray-800 mb-3">Set Actions</h3>
                                <button
                                    type="button"
                                    onClick={handleAddQuestionToSet}
                                    className="w-full px-3 py-2 bg-emerald-600 text-white text-sm font-semibold rounded-md hover:bg-emerald-700"
                                >
                                    Add question to this set
                                </button>
                            </div>

                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                                <h3 className="font-semibold text-gray-800 mb-2">Progress</h3>
                                <div className="space-y-2">
                                    {SECTIONS.map((sec) => {
                                        const count = questions.filter((q) => q.section === sec && q.question_text?.trim()).length;
                                        const total = SECTION_TOTALS[sec];
                                        const percent = Math.round((count / total) * 100);
                                        return (
                                            <div key={sec}>
                                                <div className="flex justify-between text-sm text-gray-600 mb-1">
                                                    <span>{sec}</span>
                                                    <span>
                                                        {count}/{total}
                                                    </span>
                                                </div>
                                                <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                                    <div className="h-full bg-blue-500 transition-all" style={{ width: `${percent}%` }} />
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <EditablePalette
                                questions={questions}
                                section={currentSection}
                                currentIndex={currentQuestionIndex}
                                onSelect={handleQuestionSelect}
                                onAddNew={() => handleQuestionSelect(sectionQuestions.length)}
                            />
                        </div>
                    </aside>
                </div>
            </main>
        </div>
    );
}
````

## File: src/features/admin/ui/EditableQuestion.tsx
````typescript
/**
 * @fileoverview Editable Question Component (Mirror Principle)
 * @description In-context editor that mirrors the exam interface but with editable fields
 * @blueprint M6+ - Mirror Principle - Admin sees exactly what student sees, but editable
 */

'use client';

import { useEffect, useState, useCallback, useRef, useMemo } from 'react';
import type { QuestionWithAnswer, SectionName, QuestionType } from '@/types/exam';
import { uploadToCloudinary } from '@/lib/cloudinary';
import { MathText } from '@/features/exam-engine/ui/MathText';
import { MarkdownToolbar } from './MarkdownToolbar';
import { getTopicOptions, getSubtopicOptions } from '../config/topicOptions';

// =============================================================================
// TYPES
// =============================================================================

interface EditableQuestionProps {
    /** Initial question data (null for new question) */
    question: Partial<QuestionWithAnswer> | null;
    /** Paper ID for new questions */
    paperId: string;
    /** Current section */
    section: SectionName;
    /** Question number in the section */
    questionNumber: number;
    /** Total questions in section */
    totalQuestions: number;
    /** Callback when question is saved */
    onSave: (question: Partial<QuestionWithAnswer>) => Promise<void>;
    /** Callback when cancelled */
    onCancel?: () => void;
    /** Is saving in progress */
    isSaving?: boolean;
}

interface EditableOptionProps {
    label: string;
    value: string;
    isCorrect: boolean;
    onChange: (value: string) => void;
    onMarkCorrect: () => void;
}

// =============================================================================
// OPTION LABELS
// =============================================================================

const OPTION_LABELS = ['A', 'B', 'C', 'D'] as const;

// =============================================================================
// EDITABLE OPTION COMPONENT
// =============================================================================

function EditableOption({
    label,
    value,
    isCorrect,
    onChange,
    onMarkCorrect,
}: EditableOptionProps) {
    return (
        <div
            className={`
                flex items-start gap-3 p-4 rounded-lg border-2 transition-all
                ${isCorrect
                    ? 'border-green-500 bg-green-50'
                    : 'border-gray-200 bg-white hover:border-gray-300'
                }
            `}
        >
            {/* Option Label (A, B, C, D) */}
            <button
                type="button"
                onClick={onMarkCorrect}
                title={isCorrect ? 'Correct answer' : 'Click to mark as correct'}
                className={`
                    flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center
                    text-sm font-bold transition-colors cursor-pointer
                    ${isCorrect
                        ? 'bg-green-500 text-white'
                        : 'bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-600'
                    }
                `}
            >
                {label}
            </button>

            {/* Editable Option Text - Using textarea for full content visibility */}
            <textarea
                value={value}
                onChange={(e) => onChange(e.target.value)}
                placeholder={`Enter option ${label}...`}
                rows={2}
                className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-y min-h-[40px]"
            />

            {/* Correct Indicator */}
            {isCorrect && (
                <span className="flex-shrink-0 text-green-500 flex items-center gap-1 text-sm font-medium">
                    <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            fillRule="evenodd"
                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                            clipRule="evenodd"
                        />
                    </svg>
                    Correct
                </span>
            )}
        </div>
    );
}

// =============================================================================
// IMAGE DROP ZONE COMPONENT
// =============================================================================

interface ImageDropZoneProps {
    imageUrl: string | null;
    onImageUpload: (file: File) => Promise<void>;
    onImageRemove: () => void;
    isUploading?: boolean;
}

function ImageDropZone({ imageUrl, onImageUpload, onImageRemove, isUploading }: ImageDropZoneProps) {
    const [isDragOver, setIsDragOver] = useState(false);

    const handleDrop = useCallback(async (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragOver(false);

        const files = Array.from(e.dataTransfer.files);
        const imageFile = files.find(f => f.type.startsWith('image/'));

        if (imageFile) {
            await onImageUpload(imageFile);
        }
    }, [onImageUpload]);

    const handleDragOver = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        setIsDragOver(true);
    }, []);

    const handleDragLeave = useCallback(() => {
        setIsDragOver(false);
    }, []);

    const handleFileInput = useCallback(async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            await onImageUpload(file);
        }
    }, [onImageUpload]);

    if (imageUrl) {
        return (
            <div className="relative border-2 border-gray-200 rounded-lg p-2 bg-gray-50">
                <img
                    src={imageUrl}
                    alt="Question diagram"
                    className="max-w-full max-h-64 mx-auto rounded"
                />
                <button
                    type="button"
                    onClick={onImageRemove}
                    className="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
                    title="Remove image"
                >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        );
    }

    return (
        <div
            onDrop={handleDrop}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            className={`
                border-2 border-dashed rounded-lg p-6 text-center transition-colors cursor-pointer
                ${isDragOver
                    ? 'border-blue-500 bg-blue-50'
                    : 'border-gray-300 hover:border-gray-400 bg-gray-50'
                }
                ${isUploading ? 'opacity-50 pointer-events-none' : ''}
            `}
        >
            <input
                type="file"
                accept="image/*"
                onChange={handleFileInput}
                className="hidden"
                id="image-upload"
                disabled={isUploading}
            />
            <label htmlFor="image-upload" className="cursor-pointer">
                <svg className="w-10 h-10 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p className="text-sm text-gray-600">
                    {isUploading ? 'Uploading...' : 'Drag & drop an image here, or click to browse'}
                </p>
                <p className="text-xs text-gray-400 mt-1">
                    PNG, JPG, WEBP, AVIF up to 5MB
                </p>
            </label>
        </div>
    );
}

// =============================================================================
// MAIN EDITABLE QUESTION COMPONENT
// =============================================================================

export function EditableQuestion({
    question,
    paperId,
    section,
    questionNumber,
    totalQuestions,
    onSave,
    onCancel,
    isSaving = false,
}: EditableQuestionProps) {
    // Form state
    const [questionText, setQuestionText] = useState(question?.question_text ?? '');
    const [questionFormat, setQuestionFormat] = useState<QuestionType>(
        (question?.question_format ?? question?.question_type ?? 'MCQ')
    );
    const [options, setOptions] = useState<string[]>(() =>
        Array.isArray(question?.options) ? [...question.options] : ['', '', '', '']
    );
    const [correctAnswer, setCorrectAnswer] = useState(question?.correct_answer ?? 'A');
    const [positiveMarks, setPositiveMarks] = useState(question?.positive_marks ?? 3);
    const [negativeMarks, setNegativeMarks] = useState(question?.negative_marks ?? 1);
    const [solutionText, setSolutionText] = useState(question?.solution_text ?? '');
    const [imageUrl, setImageUrl] = useState<string | null>(question?.question_image_url ?? null);
    const [isUploading, setIsUploading] = useState(false);
    const [topic, setTopic] = useState(question?.topic ?? '');
    const [subtopic, setSubtopic] = useState(question?.subtopic ?? '');
    const [taxonomyType, setTaxonomyType] = useState(question?.taxonomy_type ?? '');
    const [topicTag, setTopicTag] = useState(question?.topic_tag ?? '');
    const [difficultyRationale, setDifficultyRationale] = useState(question?.difficulty_rationale ?? '');
    const [difficulty, setDifficulty] = useState(question?.difficulty ?? 'medium');
    const [showPreview, setShowPreview] = useState(false);
    const [saveError, setSaveError] = useState<string | null>(null);
    const questionTextareaRef = useRef<HTMLTextAreaElement | null>(null);
    const solutionTextareaRef = useRef<HTMLTextAreaElement | null>(null);

    const topicOptions = useMemo(() => getTopicOptions(section, topic), [section, topic]);
    const subtopicOptions = useMemo(() => getSubtopicOptions(section, topic, subtopic), [section, topic, subtopic]);

    useEffect(() => {
        setQuestionText(question?.question_text ?? '');
        setQuestionFormat((question?.question_format ?? question?.question_type ?? 'MCQ'));
        setOptions(Array.isArray(question?.options) ? [...question.options] : ['', '', '', '']);
        setCorrectAnswer(question?.correct_answer ?? 'A');
        setPositiveMarks(question?.positive_marks ?? 3);
        setNegativeMarks(question?.negative_marks ?? 1);
        setSolutionText(question?.solution_text ?? '');
        setImageUrl(question?.question_image_url ?? null);
        setTopic(question?.topic ?? '');
        setSubtopic(question?.subtopic ?? '');
        setTaxonomyType(question?.taxonomy_type ?? '');
        setTopicTag(question?.topic_tag ?? '');
        setDifficultyRationale(question?.difficulty_rationale ?? '');
        setDifficulty(question?.difficulty ?? 'medium');
    }, [question?.id]);

    // Handle option text change
    const handleOptionChange = useCallback((index: number, value: string) => {
        setOptions(prev => {
            const updated = [...prev];
            updated[index] = value;
            return updated;
        });
    }, []);

    // Handle correct answer selection
    const handleMarkCorrect = useCallback((label: string) => {
        setCorrectAnswer(label);
    }, []);

    // Handle image upload to Cloudinary
    const handleImageUpload = useCallback(async (file: File) => {
        setIsUploading(true);
        try {
            const url = await uploadToCloudinary(file);
            setImageUrl(url);
        } catch (err) {
            console.error('Upload failed:', err);
        } finally {
            setIsUploading(false);
        }
    }, []);

    // Handle image remove
    const handleImageRemove = useCallback(() => {
        setImageUrl(null);
    }, []);

    // Handle save
    const handleSave = useCallback(async () => {
        if (isSaving) {
            return;
        }
        setSaveError(null);
        const questionData: Partial<QuestionWithAnswer> = {
            ...question,
            id: question?.id,
            paper_id: paperId,
            section,
            question_number: questionNumber,
            question_text: questionText,
            question_type: questionFormat,
            question_format: questionFormat,
            taxonomy_type: taxonomyType || undefined,
            topic_tag: topicTag || undefined,
            difficulty_rationale: difficultyRationale || undefined,
            options: questionFormat === 'MCQ' ? options : null,
            correct_answer: correctAnswer, // For TITA, this is the numeric answer
            positive_marks: positiveMarks,
            negative_marks: questionFormat === 'TITA' ? 0 : negativeMarks,
            solution_text: solutionText || undefined,
            question_image_url: imageUrl || undefined,
            topic: topic || undefined,
            subtopic: subtopic || undefined,
            difficulty: difficulty as 'easy' | 'medium' | 'hard',
            is_active: true,
        };

        try {
            await onSave(questionData);
        } catch (err) {
            const message = err instanceof Error ? err.message : 'Failed to save question.';
            setSaveError(message);
        }
    }, [
        question, paperId, section, questionNumber, questionText, questionFormat,
        options, correctAnswer, positiveMarks, negativeMarks, solutionText,
        topic, subtopic, taxonomyType, topicTag, difficultyRationale, difficulty, imageUrl, onSave, isSaving
    ]);

    return (
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            {/* Question Header - Mirror the exam UI */}
            <div className="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                <div>
                    <span className="text-sm text-gray-500">{section}</span>
                    <h2 className="text-lg font-semibold text-gray-800">
                        Question {questionNumber} of {totalQuestions}
                    </h2>
                </div>

                {/* Question Type Toggle */}
                <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2">
                        <button
                            type="button"
                            onClick={() => setQuestionFormat('MCQ')}
                            className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${questionFormat === 'MCQ'
                                ? 'bg-blue-500 text-white'
                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                }`}
                        >
                            MCQ
                        </button>
                        <button
                            type="button"
                            onClick={() => {
                                setQuestionFormat('TITA');
                                setNegativeMarks(0);
                            }}
                            className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${questionFormat === 'TITA'
                                ? 'bg-blue-500 text-white'
                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                }`}
                        >
                            TITA
                        </button>
                    </div>

                    {/* Marks Config */}
                    <div className="flex items-center gap-2 text-sm">
                        <label className="flex items-center gap-1">
                            <span className="text-green-600">+</span>
                            <input
                                type="number"
                                value={positiveMarks}
                                onChange={(e) => setPositiveMarks(Number(e.target.value))}
                                className="w-12 px-2 py-1 border border-gray-300 rounded text-center"
                                min={0}
                            />
                        </label>
                        <label className="flex items-center gap-1">
                            <span className="text-red-600">-</span>
                            <input
                                type="number"
                                value={negativeMarks}
                                onChange={(e) => setNegativeMarks(Number(e.target.value))}
                                className="w-12 px-2 py-1 border border-gray-300 rounded text-center"
                                min={0}
                                disabled={questionFormat === 'TITA'}
                            />
                        </label>
                    </div>
                </div>
            </div>

            {/* Image Drop Zone */}
            <div className="mb-6">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                    Diagram / Image (optional)
                </label>
                <ImageDropZone
                    imageUrl={imageUrl}
                    onImageUpload={handleImageUpload}
                    onImageRemove={handleImageRemove}
                    isUploading={isUploading}
                />
            </div>

            {/* Question Text - Editable */}
            <div className="mb-6">
                <div className="flex items-center justify-between mb-2">
                    <label className="block text-sm font-medium text-gray-700">
                        Question Text <span className="text-red-500">*</span>
                    </label>
                    <button
                        type="button"
                        onClick={() => setShowPreview((prev) => !prev)}
                        className="text-sm text-blue-600 hover:underline"
                    >
                        {showPreview ? 'Hide Preview' : 'Preview'}
                    </button>
                </div>
                <MarkdownToolbar
                    textareaRef={questionTextareaRef}
                    value={questionText}
                    onChange={setQuestionText}
                    className="mb-2"
                />
                <textarea
                    ref={questionTextareaRef}
                    value={questionText}
                    onChange={(e) => setQuestionText(e.target.value)}
                    placeholder="Enter the question text... (Supports Markdown and LaTeX with $...$)"
                    rows={4}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-y"
                />
                <p className="mt-1 text-xs text-gray-400">
                    Tip: Use $...$ for inline math, $$...$$ for block math
                </p>
                {showPreview && (
                    <div className="mt-4 rounded-lg border border-gray-200 bg-gray-50 p-4 space-y-4">
                        <div className="text-sm font-medium text-gray-600">Preview</div>
                        <div className="prose prose-sm max-w-none text-gray-800">
                            <MathText text={questionText} />
                        </div>
                        {questionFormat === 'MCQ' && (
                            <div className="space-y-2">
                                {options.map((optionText, index) => {
                                    const label = OPTION_LABELS[index];
                                    return (
                                        <div key={label} className="flex items-start gap-3">
                                            <span className="w-6 h-6 rounded-full bg-gray-200 text-gray-700 text-xs font-bold flex items-center justify-center">
                                                {label}
                                            </span>
                                            <div className="text-sm text-gray-700">
                                                <MathText text={optionText} />
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        {solutionText && (
                            <div className="rounded-md bg-white border border-gray-200 p-3">
                                <div className="text-xs font-medium text-gray-500 mb-2">Solution Preview</div>
                                <div className="prose prose-sm max-w-none text-gray-700">
                                    <MathText text={solutionText} />
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>

            {/* Options (MCQ only) or Answer Input (TITA) */}
            {questionFormat === 'MCQ' ? (
                <div className="space-y-3 mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        Options <span className="text-red-500">*</span>
                        <span className="font-normal text-gray-400 ml-2">(Click letter to mark correct)</span>
                    </label>
                    {options.map((optionText, index) => {
                        const label = OPTION_LABELS[index];
                        return (
                            <EditableOption
                                key={label}
                                label={label}
                                value={optionText}
                                isCorrect={correctAnswer === label}
                                onChange={(value) => handleOptionChange(index, value)}
                                onMarkCorrect={() => handleMarkCorrect(label)}
                            />
                        );
                    })}
                </div>
            ) : (
                <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        Correct Answer <span className="text-red-500">*</span>
                    </label>
                    <input
                        type="text"
                        value={correctAnswer}
                        onChange={(e) => setCorrectAnswer(e.target.value)}
                        placeholder="Enter the exact answer (e.g., 42, 3.14)"
                        className="w-full max-w-xs px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                    />
                    <p className="mt-1 text-xs text-gray-400">
                        Enter the exact numeric/text answer students must type
                    </p>
                </div>
            )}

            {/* Solution */}
            <div className="mb-6">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                    Solution / Explanation
                </label>
                <MarkdownToolbar
                    textareaRef={solutionTextareaRef}
                    value={solutionText}
                    onChange={setSolutionText}
                    className="mb-2"
                />
                <textarea
                    ref={solutionTextareaRef}
                    value={solutionText}
                    onChange={(e) => setSolutionText(e.target.value)}
                    placeholder="Explain the solution... (Supports Markdown and LaTeX)"
                    rows={3}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-y"
                />
            </div>

            {/* Metadata Row */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        Topic
                    </label>
                    <select
                        value={topic}
                        onChange={(e) => {
                            const nextTopic = e.target.value;
                            setTopic(nextTopic);
                            if (!getSubtopicOptions(section, nextTopic).includes(subtopic)) {
                                setSubtopic('');
                            }
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                    >
                        <option value="">— Select Topic —</option>
                        {topicOptions.map((option) => (
                            <option key={option} value={option}>
                                {option}
                            </option>
                        ))}
                    </select>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        Subtopic
                    </label>
                    <select
                        value={subtopic}
                        onChange={(e) => setSubtopic(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                    >
                        <option value="">— Select Subtopic —</option>
                        {subtopicOptions.map((option) => (
                            <option key={option} value={option}>
                                {option}
                            </option>
                        ))}
                    </select>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        Difficulty
                    </label>
                    <select
                        value={difficulty}
                        onChange={(e) => setDifficulty(e.target.value as 'easy' | 'medium' | 'hard')}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                    >
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
            </div>

            {/* Taxonomy Fields */}
            <div className="grid grid-cols-1 gap-4 mb-6">
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Taxonomy Type (optional)
                        </label>
                        <input
                            type="text"
                            value={taxonomyType}
                            onChange={(e) => setTaxonomyType(e.target.value)}
                            placeholder="e.g., rc_inference, para_summary"
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Topic Tag (optional)
                        </label>
                        <input
                            type="text"
                            value={topicTag}
                            onChange={(e) => setTopicTag(e.target.value)}
                            placeholder="e.g., inference, main_idea"
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                        />
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        Difficulty Rationale (optional)
                    </label>
                    <textarea
                        value={difficultyRationale}
                        onChange={(e) => setDifficultyRationale(e.target.value)}
                        placeholder="Why this difficulty rating?"
                        rows={2}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-y"
                    />
                </div>
            </div>

            {/* Action Buttons */}
            <div className="flex items-center justify-between pt-4 border-t border-gray-200">
                <div className="text-sm text-gray-500">
                    {question?.id ? 'Editing existing question' : 'Creating new question'}
                </div>
                {saveError && (
                    <div className="text-sm text-red-600" role="alert">
                        {saveError}
                    </div>
                )}
                <div className="flex items-center gap-3">
                    {onCancel && (
                        <button
                            type="button"
                            onClick={onCancel}
                            disabled={isSaving}
                            className="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors disabled:opacity-50"
                        >
                            Cancel
                        </button>
                    )}
                    <button
                        type="button"
                        onClick={handleSave}
                        disabled={isSaving || !questionText.trim()}
                        className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                    >
                        {isSaving ? (
                            <>
                                <svg className="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
                                </svg>
                                Saving...
                            </>
                        ) : (
                            <>Save Question</>
                        )}
                    </button>
                </div>
            </div>
        </div>
    );
}
````

## File: src/features/exam-engine/lib/ExamClient.tsx
````typescript
/**
 * @fileoverview Exam Client Component
 * @description Client-side exam interface that integrates with the exam engine
 * @blueprint Milestone 4 SOP-SSOT - Integration
 * 
 * PHASE 4 FIX: Robust submission with better error handling
 * PHASE 5: Cleanup - localStorage key hygiene
 */

'use client';

import { useEffect, useCallback, useRef, useState } from 'react';
import { useRouter } from 'next/navigation';
import {
    useExamStore,
    ExamLayout,
} from '@/features/exam-engine';
import {
    saveResponse,
    saveResponsesBatch,
    updateAttemptProgress,
    submitExam,
    pauseExam,
    initializeExamSession,
} from '@/features/exam-engine/api/client';
import { logger, examLogger } from '@/lib/logger';
import { examDebug, cleanupOrphanedExamState, clearAllExamState } from '@/lib/examDebug';
import { DevToolsPanel } from '@/features/exam-engine/ui/DevToolsPanel';
import { isDevSyncPaused } from '@/lib/devTools';
import type { Paper, Question, Attempt, SectionName, TimeRemaining, Response } from '@/types/exam';
import { getSectionByIndex } from '@/types/exam';

// =============================================================================
// TYPES
// =============================================================================

interface ExamClientProps {
    paper: Paper;
    questions: Question[];
    attempt: Attempt;
    responses?: Response[];
}

type BatchSaveItem = {
    questionId: string;
    answer: string | null;
    status: string;
    isMarkedForReview: boolean;
    isVisited: boolean;
    timeSpentSeconds: number;
    visitCount?: number;
};

type BatchSaveResult = { success: boolean; failedQuestionIds?: string[] };

type SubmissionStage = 'idle' | 'validating' | 'saving' | 'submitting' | 'finalizing';

type SubmissionProgress = {
    percent: number;
    activeLabel?: string;
    steps: Array<{ label: string; status: 'pending' | 'active' | 'done' }>;
};

const SUBMISSION_STEP_LABELS: Record<Exclude<SubmissionStage, 'idle'>, string> = {
    validating: 'Validating session',
    saving: 'Saving responses',
    submitting: 'Submitting exam',
    finalizing: 'Preparing analysis',
};

const SUBMISSION_STAGE_ORDER: Array<Exclude<SubmissionStage, 'idle'>> = [
    'validating',
    'saving',
    'submitting',
    'finalizing',
];

// =============================================================================
// DEBOUNCE HELPER
// =============================================================================

function useDebouncedCallback<T extends (...args: Parameters<T>) => void>(
    callback: T,
    delay: number
): T {
    const timeoutRef = useRef<NodeJS.Timeout | null>(null);
    const callbackRef = useRef(callback);

    // Update callback ref when callback changes
    useEffect(() => {
        callbackRef.current = callback;
    }, [callback]);

    return useCallback(
        ((...args: Parameters<T>) => {
            if (timeoutRef.current) {
                clearTimeout(timeoutRef.current);
            }
            timeoutRef.current = setTimeout(() => {
                callbackRef.current(...args);
            }, delay);
        }) as T,
        [delay]
    );
}

// =============================================================================
// MAIN COMPONENT
// =============================================================================

const AUTO_SAVE_INTERVAL_MS = 60000;
const PROGRESS_DEBOUNCE_MS = 1000;
const MAX_BEACON_BYTES = 60 * 1024;
const EXAM_LAYOUT_MODE = (process.env.NEXT_PUBLIC_EXAM_LAYOUT_MODE ?? 'current') as
    | 'current'
    | 'three-column';

function isNonEmptyString(value: unknown): value is string {
    return typeof value === 'string' && value.trim().length > 0;
}

export function ExamClient({ paper, questions, attempt, responses: serverResponses }: ExamClientProps) {
    const router = useRouter();

    // Store actions
    const initializeExam = useExamStore((s) => s.initializeExam);
    const setSessionToken = useExamStore((s) => s.setSessionToken);
    const setSubmitting = useExamStore((s) => s.setSubmitting);
    const hasHydrated = useExamStore((s) => s.hasHydrated);
    const isInitialized = useExamStore((s) => s.isInitialized);
    const attemptId = attempt.id;
    const currentSectionIndex = useExamStore((s) => s.currentSectionIndex);
    const currentQuestionIndex = useExamStore((s) => s.currentQuestionIndex);
    const sectionTimers = useExamStore((s) => s.sectionTimers);
    const responses = useExamStore((s) => s.responses);
    const isSubmitting = useExamStore((s) => s.isSubmitting);
    const isAutoSubmitting = useExamStore((s) => s.isAutoSubmitting);
    const sessionToken = useExamStore((s) => s.sessionToken);
    const submissionIdRef = useRef<string>(
        typeof crypto !== 'undefined' && crypto.randomUUID
            ? crypto.randomUUID()
            : `${Date.now()}-${Math.random().toString(36).slice(2)}`
    );
    const responsesRef = useRef(responses);
    const sectionTimersRef = useRef(sectionTimers);
    const attemptIdRef = useRef(attemptId);
    const sessionTokenRef = useRef(sessionToken);
    const currentSectionIndexRef = useRef(currentSectionIndex);
    const currentQuestionIndexRef = useRef(currentQuestionIndex);
    const sessionTokenPromiseRef = useRef<Promise<string | null> | null>(null);
    const sessionVerifiedRef = useRef(false);
    const attemptFinalizedRef = useRef(false);

    const [sessionConflict, setSessionConflict] = useState<
        | { type: 'save'; payload: Parameters<typeof saveResponse>[0] }
        | { type: 'submit' }
        | null
    >(null);
    const [isResolvingConflict, setIsResolvingConflict] = useState(false);
    const [uiError, setUiError] = useState<string | null>(null);
    const [submissionProgress, setSubmissionProgress] = useState<SubmissionProgress | null>(null);

    const updateSubmissionProgress = useCallback((stage: Exclude<SubmissionStage, 'idle'>, percent: number) => {
        const stageIndex = SUBMISSION_STAGE_ORDER.indexOf(stage);
        const steps = SUBMISSION_STAGE_ORDER.map((step, index) => ({
            label: SUBMISSION_STEP_LABELS[step],
            status: index < stageIndex ? 'done' : index === stageIndex ? 'active' : 'pending',
        })) as SubmissionProgress['steps'];

        setSubmissionProgress({
            percent,
            activeLabel: SUBMISSION_STEP_LABELS[stage],
            steps,
        });
    }, []);

    const withTimeout = useCallback(async <T,>(promise: Promise<T>, ms: number, label: string): Promise<T> => {
        let timeoutId: ReturnType<typeof setTimeout> | null = null;
        const timeoutPromise = new Promise<never>((_, reject) => {
            timeoutId = setTimeout(() => {
                reject(new Error(`${label} timed out after ${ms}ms`));
            }, ms);
        });

        try {
            return await Promise.race([promise, timeoutPromise]);
        } finally {
            if (timeoutId) clearTimeout(timeoutId);
        }
    }, []);

    useEffect(() => {
        responsesRef.current = responses;
    }, [responses]);

    useEffect(() => {
        sectionTimersRef.current = sectionTimers;
    }, [sectionTimers]);

    useEffect(() => {
        attemptIdRef.current = attemptId;
    }, [attemptId]);

    useEffect(() => {
        sessionTokenRef.current = sessionToken;
    }, [sessionToken]);

    useEffect(() => {
        currentSectionIndexRef.current = currentSectionIndex;
        currentQuestionIndexRef.current = currentQuestionIndex;
    }, [currentSectionIndex, currentQuestionIndex]);

    // Initialize exam on mount - but only once per session
    // The initializeExam function now handles the case where state is already loaded
    useEffect(() => {
        if (!hasHydrated) return;
        // PHASE 5: Clean up orphaned temp state
        cleanupOrphanedExamState(attempt.id);

        // Always call initializeExam. It will preserve state for the same attempt,
        // and reset if a different attempt is detected (e.g., stale persisted data).
        examDebug.log('Initializing exam', { attemptId: attempt.id, paperId: paper.id });
        initializeExam({
            paper,
            questions,
            attempt,
            responses: serverResponses,
        });
    }, [paper, questions, attempt, serverResponses, initializeExam, hasHydrated]);

    useEffect(() => {
        if (!isSubmitting && !isAutoSubmitting) {
            setSubmissionProgress(null);
        }
    }, [isSubmitting, isAutoSubmitting]);

    // Initialize session token server-side (RPC) once per mount
    useEffect(() => {
        const initializeSession = async () => {
            const result = await initializeExamSession(attempt.id);
            if (result.success && result.data?.sessionToken) {
                setSessionToken(result.data.sessionToken);
                sessionVerifiedRef.current = true;
            }
        };

        void initializeSession();
    }, [attempt.id, setSessionToken]);

    const flushInProgressRef = useRef(false);
    const popstateGuardRef = useRef(false);
    const popstateInFlightRef = useRef(false);
    // Prevent race conditions when saving the same question multiple times
    const savingQuestionsRef = useRef<Set<string>>(new Set());
    const hasAnswer = useCallback((answer: string | null) => typeof answer === 'string' && answer.trim() !== '', []);
    const getPersistedAnswer = useCallback(
        (_status: string, answer: string | null) => (hasAnswer(answer) ? answer : null),
        [hasAnswer]
    );
    const getIsVisited = useCallback(
        (status: string, answer: string | null) => status !== 'not_visited' || hasAnswer(answer),
        [hasAnswer]
    );

    const ensureSessionToken = useCallback(async (opts?: { force?: boolean; reason?: string }): Promise<string | null> => {
        const force = opts?.force === true;
        const reason = opts?.reason ?? 'unknown';
        const current = sessionTokenRef.current;

        if (!force && sessionVerifiedRef.current && isNonEmptyString(current)) {
            return current;
        }

        if (sessionTokenPromiseRef.current) return sessionTokenPromiseRef.current;

        const aId = attemptIdRef.current;
        sessionTokenPromiseRef.current = (async () => {
            try {
                const result = await withTimeout(initializeExamSession(aId), 8000, 'initializeExamSession');
                if (result.success && isNonEmptyString(result.data?.sessionToken)) {
                    const token = result.data.sessionToken;
                    setSessionToken(token);
                    sessionVerifiedRef.current = true;
                    return token;
                }

                if (isNonEmptyString(current)) {
                    logger.warn('ensureSessionToken: refresh failed; using existing token', { attemptId: aId, reason });
                    return current;
                }

                logger.warn('ensureSessionToken: no token available', { attemptId: aId, reason });
                return null;
            } catch (error) {
                if (isNonEmptyString(current)) {
                    logger.warn('ensureSessionToken: exception; using existing token', { attemptId: aId, reason, error });
                    return current;
                }
                logger.warn('ensureSessionToken: exception; no token available', { attemptId: aId, reason, error });
                return null;
            } finally {
                sessionTokenPromiseRef.current = null;
            }
        })();

        return sessionTokenPromiseRef.current;
    }, [setSessionToken, withTimeout]);

    /**
     * Force get a fresh session token from server.
     * Always calls API, regardless of existing token.
     */
    const forceRefreshSessionToken = useCallback(async (): Promise<string | null> => {
        return ensureSessionToken({ force: true, reason: 'forceRefreshSessionToken' });
    }, [ensureSessionToken]);

    const flushNow = useCallback(async () => {
        if (!attemptId) return;
        if (!isInitialized) return;
        if (isSubmitting || isAutoSubmitting) return;
        if (isDevSyncPaused()) return;
        if (attemptFinalizedRef.current) return;
        if (flushInProgressRef.current) return;
        flushInProgressRef.current = true;

        try {
            const timeRemaining: TimeRemaining = {
                VARC: sectionTimers.VARC.remainingSeconds,
                DILR: sectionTimers.DILR.remainingSeconds,
                QA: sectionTimers.QA.remainingSeconds,
            };

            const currentSection = getSectionByIndex(currentSectionIndex);

            const progressResult = await updateAttemptProgress({
                attemptId,
                timeRemaining,
                currentSection,
                currentQuestion: currentQuestionIndex + 1,
            });
            if (!progressResult.success) {
                if (progressResult.error === 'Attempt is not in progress') {
                    attemptFinalizedRef.current = true;
                } else {
                    logger.warn('Flush progress failed', progressResult.error);
                }
            }
        } catch (error) {
            logger.warn('Flush progress failed', error);
        }

        try {
            if (!attemptFinalizedRef.current) {
                const activeSessionToken = await ensureSessionToken({ reason: 'flushNow' });
                if (!activeSessionToken) {
                    return;
                }
                const batch = Object.entries(responses)
                    .filter(([, response]) => hasAnswer(response.answer) || response.status !== 'not_visited')
                    .map(([questionId, response]) => {
                        const persistedAnswer = getPersistedAnswer(response.status, response.answer);
                        return {
                            questionId,
                            answer: persistedAnswer,
                            status: response.status,
                            isMarkedForReview: response.isMarkedForReview,
                            isVisited: getIsVisited(response.status, persistedAnswer),
                            timeSpentSeconds: response.timeSpentSeconds,
                            visitCount: response.visitCount,
                        };
                    });

                if (batch.length > 0) {
                    const batchResult = await saveResponsesBatch({
                        attemptId,
                        sessionToken: activeSessionToken,
                        responses: batch,
                    });
                    if (!batchResult.success) {
                        if (batchResult.error === 'SESSION_CONFLICT') {
                            const refreshed = await forceRefreshSessionToken();
                            if (refreshed) {
                                const retry = await saveResponsesBatch({
                                    attemptId,
                                    sessionToken: refreshed,
                                    force_resume: true,
                                    responses: batch,
                                });
                                if (!retry.success) {
                                    // FIX: Don't warn if attempt already submitted - this is expected
                                    if (retry.error === 'Attempt is not in progress') {
                                        attemptFinalizedRef.current = true;
                                        logger.debug?.('Flush skipped after force resume - attempt already submitted', { attemptId });
                                    } else {
                                        logger.warn('Flush responses failed after force resume', retry.error, { attemptId });
                                    }
                                }
                            } else {
                                logger.warn('Flush responses failed (no session token to force resume)', { attemptId });
                            }
                        } else if (batchResult.error === 'Attempt is not in progress') {
                            // FIX: Don't warn if attempt already submitted - this is expected during/after submit
                            attemptFinalizedRef.current = true;
                            logger.debug?.('Flush skipped - attempt already submitted', { attemptId });
                        } else {
                            logger.warn('Flush responses failed', batchResult.error, { attemptId });
                        }
                    }
                }
            }
        } catch (error) {
            logger.warn('Flush responses failed', error);
        } finally {
            flushInProgressRef.current = false;
        }
    }, [
        attemptId,
        sectionTimers,
        currentSectionIndex,
        currentQuestionIndex,
        responses,
        ensureSessionToken,
        hasAnswer,
        getPersistedAnswer,
        getIsVisited,
        isSubmitting,
        isAutoSubmitting,
        forceRefreshSessionToken,
        isInitialized,
    ]);

    // Debounced save to server
    const debouncedSaveProgress = useDebouncedCallback(
        async (sectionTimers: Record<SectionName, { remainingSeconds: number }>) => {
            if (!attemptId) return;
            if (isDevSyncPaused()) return;
            if (attemptFinalizedRef.current) return;

            const timeRemaining: TimeRemaining = {
                VARC: sectionTimers.VARC.remainingSeconds,
                DILR: sectionTimers.DILR.remainingSeconds,
                QA: sectionTimers.QA.remainingSeconds,
            };

            const currentSection = getSectionByIndex(currentSectionIndex);

            const progressResult = await updateAttemptProgress({
                attemptId,
                timeRemaining,
                currentSection,
                currentQuestion: currentQuestionIndex + 1,
            });
            if (!progressResult.success && progressResult.error === 'Attempt is not in progress') {
                attemptFinalizedRef.current = true;
            }
        },
        PROGRESS_DEBOUNCE_MS
    );

    // Auto-save progress periodically
    useEffect(() => {
        if (!attemptId || !isInitialized) return;

        const interval = setInterval(() => {
            debouncedSaveProgress(sectionTimers);
        }, AUTO_SAVE_INTERVAL_MS);

        return () => clearInterval(interval);
    }, [attemptId, isInitialized, sectionTimers, debouncedSaveProgress]);

    // Persist progress promptly when section/question changes (helps resume after refresh)
    useEffect(() => {
        if (!attemptId || !isInitialized) return;
        if (isSubmitting || isAutoSubmitting) return;
        if (attemptFinalizedRef.current) return;

        debouncedSaveProgress(sectionTimersRef.current);
    }, [attemptId, isInitialized, isSubmitting, isAutoSubmitting, currentSectionIndex, currentQuestionIndex, debouncedSaveProgress]);

    // Save on exit / visibility changes (best-effort sendBeacon + fallback flush)
    useEffect(() => {
        const sendBeaconProgress = () => {
            const aId = attemptIdRef.current;
            if (!aId || !isInitialized) return;
            if (isSubmitting || isAutoSubmitting) return;
            if (attemptFinalizedRef.current) return;

            const timers = sectionTimersRef.current;
            const timeRemaining: TimeRemaining = {
                VARC: Math.max(0, Math.floor(timers.VARC?.remainingSeconds ?? 0)),
                DILR: Math.max(0, Math.floor(timers.DILR?.remainingSeconds ?? 0)),
                QA: Math.max(0, Math.floor(timers.QA?.remainingSeconds ?? 0)),
            };
            const currentSection = getSectionByIndex(currentSectionIndexRef.current);
            const currentQuestion = currentQuestionIndexRef.current + 1;

            if (typeof navigator === 'undefined' || !navigator.sendBeacon) {
                void updateAttemptProgress({
                    attemptId: aId,
                    timeRemaining,
                    currentSection,
                    currentQuestion,
                    sessionToken: sessionTokenRef.current ?? undefined,
                    force_resume: true,
                });
                return;
            }

            const payload = JSON.stringify({
                attemptId: aId,
                timeRemaining,
                currentSection,
                currentQuestion,
                sessionToken: sessionTokenRef.current ?? undefined,
                force_resume: true,
            });

            navigator.sendBeacon('/api/progress', new Blob([payload], { type: 'application/json' }));
        };

        const sendBeaconBatchSave = () => {
            if (!isInitialized) return;
            const aId = attemptIdRef.current;
            if (!aId) return;
            if (isSubmitting || isAutoSubmitting) return;
            if (attemptFinalizedRef.current) return;

            const snapshot = responsesRef.current;
            const token = sessionTokenRef.current;

            const responsesPayload = Object.entries(snapshot)
                .filter(([, response]) => hasAnswer(response.answer) || response.status !== 'not_visited')
                .map(([questionId, response]) => {
                    const persistedAnswer = getPersistedAnswer(response.status, response.answer);
                    return {
                        questionId,
                        answer: persistedAnswer,
                        status: response.status,
                        isMarkedForReview: response.isMarkedForReview,
                        isVisited: getIsVisited(response.status, persistedAnswer),
                        timeSpentSeconds: response.timeSpentSeconds,
                        visitCount: response.visitCount,
                    };
                });

            if (responsesPayload.length === 0) return;

            if (!token || typeof navigator === 'undefined' || !navigator.sendBeacon) {
                void flushNow();
                return;
            }

            const basePayload = {
                attemptId: aId,
                sessionToken: token,
                force_resume: true,
            };

            const fullPayload = JSON.stringify({ ...basePayload, responses: responsesPayload });
            const fullBlob = new Blob([fullPayload], { type: 'application/json' });

            if (fullBlob.size <= MAX_BEACON_BYTES) {
                const sent = navigator.sendBeacon('/api/save-batch', fullBlob);
                if (!sent) {
                    void flushNow();
                }
                return;
            }

            const chunks: typeof responsesPayload[] = [];
            let currentChunk: typeof responsesPayload = [];

            for (const item of responsesPayload) {
                currentChunk.push(item);
                const chunkPayload = JSON.stringify({ ...basePayload, responses: currentChunk });
                const chunkSize = new Blob([chunkPayload], { type: 'application/json' }).size;

                if (chunkSize > MAX_BEACON_BYTES) {
                    currentChunk.pop();
                    if (currentChunk.length === 0) {
                        void flushNow();
                        return;
                    }
                    chunks.push(currentChunk);
                    currentChunk = [item];
                }
            }

            if (currentChunk.length) {
                chunks.push(currentChunk);
            }

            for (const chunk of chunks) {
                const chunkPayload = JSON.stringify({ ...basePayload, responses: chunk });
                const sent = navigator.sendBeacon(
                    '/api/save-batch',
                    new Blob([chunkPayload], { type: 'application/json' })
                );
                if (!sent) {
                    void flushNow();
                    return;
                }
            }
        };

        const handleVisibilityChange = () => {
            if (document.visibilityState === 'hidden') {
                sendBeaconBatchSave();
                sendBeaconProgress();
            }
        };

        const handlePageHide = () => {
            sendBeaconBatchSave();
            sendBeaconProgress();
        };

        const handleBeforeUnload = (event: BeforeUnloadEvent) => {
            if (!attemptIdRef.current || !isInitialized || isSubmitting || isAutoSubmitting) return;
            if (attemptFinalizedRef.current) return;
            sendBeaconBatchSave();
            sendBeaconProgress();
            event.preventDefault();
            event.returnValue = '';
        };

        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('pagehide', handlePageHide);
        window.addEventListener('beforeunload', handleBeforeUnload);

        return () => {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('pagehide', handlePageHide);
            window.removeEventListener('beforeunload', handleBeforeUnload);
        };
    }, [flushNow, getPersistedAnswer, getIsVisited, hasAnswer, isSubmitting, isAutoSubmitting, updateAttemptProgress, isInitialized]);

    // Warn + save on browser back (popstate)
    useEffect(() => {
        const handlePopState = () => {
            const aId = attemptIdRef.current;
            if (!aId || !isInitialized || isSubmitting || isAutoSubmitting) return;
            if (attemptFinalizedRef.current) return;
            if (popstateGuardRef.current) {
                popstateGuardRef.current = false;
                return;
            }

            const shouldLeave = window.confirm(
                'You have an active attempt. Leaving will pause your attempt and save progress. Do you want to continue?'
            );
            if (!shouldLeave) {
                popstateGuardRef.current = true;
                window.history.forward();
                return;
            }

            if (popstateInFlightRef.current) return;
            popstateInFlightRef.current = true;

            // Stay on the exam page while we save + pause, then navigate back.
            popstateGuardRef.current = true;
            window.history.forward();

            void (async () => {
                try {
                    await withTimeout(flushNow(), 8000, 'flushNow');
                } catch {
                    // best-effort
                }

                const timers = sectionTimersRef.current;
                const timeRemaining: TimeRemaining = {
                    VARC: Math.max(0, Math.floor(timers.VARC?.remainingSeconds ?? 0)),
                    DILR: Math.max(0, Math.floor(timers.DILR?.remainingSeconds ?? 0)),
                    QA: Math.max(0, Math.floor(timers.QA?.remainingSeconds ?? 0)),
                };
                const currentSection = getSectionByIndex(currentSectionIndexRef.current);
                const currentQuestion = currentQuestionIndexRef.current + 1;

                const token = await ensureSessionToken({ force: true, reason: 'popstate-pause' });
                try {
                    const pauseResult = await withTimeout(
                        pauseExam({
                            attemptId: aId,
                            timeRemaining,
                            currentSection,
                            currentQuestion,
                            sessionToken: token ?? undefined,
                        }),
                        8000,
                        'pauseExam'
                    );
                    if (!pauseResult.success) {
                        logger.warn('Pause on back navigation failed', pauseResult.error, { attemptId: aId });
                    }
                } catch (error) {
                    logger.warn('Pause on back navigation failed', error, { attemptId: aId });
                } finally {
                    popstateInFlightRef.current = false;
                    popstateGuardRef.current = true;
                    window.history.back();
                }
            })();
        };

        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
    }, [isInitialized, isSubmitting, isAutoSubmitting, flushNow, withTimeout, ensureSessionToken]);

    // Ensure progress is flushed when navigating away (SPA route change unmount)
    // FIX: Skip flush if submit is in progress - submit handles final save
    useEffect(() => {
        return () => {
            // Check refs directly to avoid stale closure issues
            if (submitLockRef.current) {
                logger.debug?.('Skipping unmount flush - submit in progress');
                return;
            }
            void flushNow();
        };
    }, [flushNow]);

    // Handle individual response save
    const handleSaveResponse = useCallback(async (
        questionId: string,
        answer: string | null
    ) => {
        if (!attemptId) return;
        if (isDevSyncPaused()) return;
        if (attemptFinalizedRef.current) return;

        // Prevent concurrent saves for the same question
        if (savingQuestionsRef.current.has(questionId)) {
            return;
        }
        savingQuestionsRef.current.add(questionId);

        try {
            const activeSessionToken = await ensureSessionToken({ reason: 'saveResponse' });
            if (!activeSessionToken) return;
            const response = responses[questionId];
            if (!response) return;

            const persistedAnswer = getPersistedAnswer(response.status, answer);
            const payload = {
                attemptId,
                questionId,
                answer: persistedAnswer,
                status: response.status,
                isMarkedForReview: response.isMarkedForReview,
                isVisited: getIsVisited(response.status, persistedAnswer),
                timeSpentSeconds: response.timeSpentSeconds,
                visitCount: response.visitCount,
                sessionToken: activeSessionToken,
            };

            const result = await saveResponse(payload);
            if (!result.success && result.error === 'Attempt is not in progress') {
                attemptFinalizedRef.current = true;
                return;
            }
            if (!result.success && result.error === 'SESSION_CONFLICT') {
                const refreshed = await forceRefreshSessionToken();
                if (refreshed) {
                    const retry = await saveResponse({
                        ...payload,
                        sessionToken: refreshed,
                        force_resume: true,
                    });
                    if (!retry.success && retry.error === 'SESSION_CONFLICT') {
                        setSessionConflict({ type: 'save', payload });
                    }
                } else {
                    setSessionConflict({ type: 'save', payload });
                }
            }
        } finally {
            savingQuestionsRef.current.delete(questionId);
        }
    }, [attemptId, responses, ensureSessionToken, getPersistedAnswer, getIsVisited, forceRefreshSessionToken]);

    const handleSaveResponsesBatch = useCallback(async (items: BatchSaveItem[]): Promise<BatchSaveResult> => {
        if (!attemptId) return { success: false };
        if (isDevSyncPaused()) return { success: false };
        if (attemptFinalizedRef.current) return { success: false };

        const activeSessionToken = await ensureSessionToken({ reason: 'batch-save' });
        if (!activeSessionToken) return { success: false };

        let result;
        try {
            result = await withTimeout(
                saveResponsesBatch({
                    attemptId,
                    sessionToken: activeSessionToken,
                    responses: items,
                }),
                8000,
                'saveResponsesBatch'
            );
        } catch (error) {
            logger.warn('Batch save timed out', { attemptId, error });
            return { success: false };
        }

        if (!result.success) {
            if (result.error === 'SESSION_CONFLICT') {
                const refreshed = await ensureSessionToken({ force: true, reason: 'batch-save-conflict' });
                if (refreshed) {
                    let retry;
                    try {
                        retry = await withTimeout(
                            saveResponsesBatch({
                                attemptId,
                                sessionToken: refreshed,
                                force_resume: true,
                                responses: items,
                            }),
                            8000,
                            'saveResponsesBatch'
                        );
                    } catch (error) {
                        logger.warn('Batch save retry timed out', { attemptId, error });
                        return { success: false };
                    }
                    if (retry.success) {
                        return { success: true };
                    }
                }
                logger.warn('Session conflict during batch save', { attemptId });
            } else if (result.error === 'Attempt is not in progress') {
                attemptFinalizedRef.current = true;
            }
            return { success: false };
        }

        return { success: true };
    }, [attemptId, ensureSessionToken, withTimeout]);

    // Handle section expiry
    const handleSectionExpire = useCallback(async (sectionName: SectionName) => {
        examLogger.sectionExpired(attemptId || '', sectionName);

        // Save all current responses for this section before transitioning
        if (!attemptId) return;
        if (isDevSyncPaused()) return;
        if (attemptFinalizedRef.current) return;

        // FIX: Skip save if submit is already in progress (prevents race condition)
        if (submitLockRef.current) {
            logger.debug?.('Skipping section expire save - submit in progress', { sectionName });
            return;
        }

        // Find questions in this section and save their responses
        const sectionQuestions = questions.filter(q => q.section === sectionName);

        const activeSessionToken = await ensureSessionToken({ reason: 'section-expire' });
        if (activeSessionToken) {
            const batch = sectionQuestions
                .map((q) => {
                    const response = responses[q.id];
                    if (!response || (!hasAnswer(response.answer) && response.status === 'not_visited')) {
                        return null;
                    }
                    const persistedAnswer = getPersistedAnswer(response.status, response.answer);
                    return {
                        questionId: q.id,
                        answer: persistedAnswer,
                        status: response.status,
                        isMarkedForReview: response.isMarkedForReview,
                        isVisited: getIsVisited(response.status, persistedAnswer),
                        timeSpentSeconds: response.timeSpentSeconds,
                        visitCount: response.visitCount,
                    };
                })
                .filter(Boolean) as Array<{
                    questionId: string;
                    answer: string | null;
                    status: string;
                    isMarkedForReview: boolean;
                    isVisited: boolean;
                    timeSpentSeconds: number;
                    visitCount?: number;
                }>;

            if (batch.length > 0) {
                const batchResult = await saveResponsesBatch({
                    attemptId: attemptId!,
                    sessionToken: activeSessionToken,
                    responses: batch,
                });
                if (!batchResult.success) {
                    // FIX: Don't warn if error is due to completed submit - this is expected
                    if (batchResult.error === 'Attempt is not in progress') {
                        attemptFinalizedRef.current = true;
                        logger.debug?.('Section save skipped - attempt already submitted', { sectionName, attemptId });
                    } else {
                        logger.warn('Section save batch failed', batchResult.error, { attemptId });
                    }
                }
            }
        }
    }, [attemptId, questions, responses, ensureSessionToken, hasAnswer, getPersistedAnswer, getIsVisited]);

    // RACE CONDITION FIX: Mutex lock to prevent concurrent submits
    const submitLockRef = useRef<boolean>(false);

    // Handle exam submit
    const handleSubmitExam = useCallback(async () => {
        if (!attemptId) return;

        // CRITICAL: Atomic check-and-set to prevent race conditions
        if (submitLockRef.current) {
            logger.warn('Submit already in progress, ignoring duplicate call', { attemptId });
            return;
        }
        submitLockRef.current = true;

        // Also check isSubmitting flag. Allow auto-submit to proceed.
        if (isSubmitting) {
            logger.warn('Submit blocked by isSubmitting flag', { attemptId, isSubmitting, isAutoSubmitting });
            submitLockRef.current = false;
            return;
        }

        setSubmitting(true);
        setUiError(null);
        updateSubmissionProgress('validating', 15);

        try {
            // CRITICAL: Always get a fresh session token before submit
            // This ensures we have a valid token even if the old one expired
            let activeSessionToken = await forceRefreshSessionToken();
            if (!activeSessionToken) {
                setUiError('Unable to establish session. Please check your connection and try again.');
                return;
            }

            // PHASE 4: Debug logging for submit attempt
            examDebug.submitAttempt({
                attemptId,
                sessionToken: activeSessionToken,
                submissionId: submissionIdRef.current,
                responsesCount: Object.keys(responses).length,
            });

            // PHASE 4 FIX: Batch-save remaining responses before submit (best-effort)
            try {
                updateSubmissionProgress('saving', 45);
                const batch = Object.entries(responses)
                    .filter(([, response]) => hasAnswer(response.answer) || response.status !== 'not_visited')
                    .map(([questionId, response]) => {
                        const persistedAnswer = getPersistedAnswer(response.status, response.answer);
                        return {
                            questionId,
                            answer: persistedAnswer,
                            status: response.status,
                            isMarkedForReview: response.isMarkedForReview,
                            isVisited: getIsVisited(response.status, persistedAnswer),
                            timeSpentSeconds: response.timeSpentSeconds,
                            visitCount: response.visitCount,
                        };
                    });

                if (batch.length > 0) {
                    const batchResult = await withTimeout(
                        saveResponsesBatch({
                            attemptId: attemptId!,
                            sessionToken: activeSessionToken,
                            responses: batch,
                        }),
                        8000,
                        'saveResponsesBatch'
                    );
                    if (!batchResult.success) {
                        examDebug.warn('Some saves failed during submit', { error: batchResult.error });
                    }
                }
            } catch (err) {
                logger.warn('Some responses failed to save during submit', err);
            }

            updateSubmissionProgress('submitting', 75);
            // Submit exam - proceed regardless of save failures
            const forceResumePreferred = isAutoSubmitting;
            let result;
            try {
                result = await withTimeout(
                    submitExam({
                        attemptId,
                        sessionToken: activeSessionToken,
                        submissionId: submissionIdRef.current,
                        force_resume: forceResumePreferred,
                    }),
                    30000, // Increased from 15s to 30s to handle slow connections
                    'submitExam'
                );
            } catch (error) {
                logger.error('Submit timed out', error, { attemptId });

                // FIX: Check if submit actually succeeded on server before showing error
                try {
                    const res = await fetch('/api/attempt-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ attemptId }),
                    });
                    const payload = await res.json().catch(() => ({}));
                    const statusCheck = payload?.data?.status as string | undefined;

                    if (statusCheck === 'submitted' || statusCheck === 'completed') {
                        // Submit actually succeeded - redirect to results
                        logger.info('Submit succeeded despite timeout', { attemptId, status: statusCheck });
                        attemptFinalizedRef.current = true;
                        updateSubmissionProgress('finalizing', 100);
                        clearAllExamState();
                        router.replace(`/result/${attemptId}`);
                        return;
                    }
                } catch (checkError) {
                    logger.warn('Failed to check attempt status after timeout', checkError);
                }

                setUiError('Submitting timed out. Please try again.');
                return;
            }

            // PHASE 4: Debug logging for submit result
            examDebug.submitResult({
                success: result.success,
                error: result.error,
                attemptId,
            });

            if (result.success) {
                attemptFinalizedRef.current = true;
                updateSubmissionProgress('finalizing', 100);
                clearAllExamState();

                // Redirect to results
                router.replace(`/result/${attemptId}`);
                return;
            }

            // If backend already marked the attempt submitted, treat as success
            const invalidStatus =
                result.error === 'Attempt is not in progress' ||
                result.error === 'INVALID_ATTEMPT_STATUS' ||
                result.error?.toLowerCase().includes('already submitted');
            if (invalidStatus) {
                try {
                    const res = await fetch('/api/attempt-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ attemptId }),
                    });
                    const payload = await res.json().catch(() => ({}));
                    const statusCheck = payload?.data?.status as string | undefined;

                    if (statusCheck === 'submitted' || statusCheck === 'completed') {
                        attemptFinalizedRef.current = true;
                        updateSubmissionProgress('finalizing', 100);
                        clearAllExamState();
                        router.replace(`/result/${attemptId}`);
                        return;
                    }
                } catch (checkError) {
                    logger.warn('Failed to check attempt status after invalid status', checkError);
                }
            }

            if (result.error === 'ATTEMPT_NOT_FOUND' || result.error?.toLowerCase().includes('attempt not found')) {
                clearAllExamState();
                setUiError('This exam attempt was removed. Please restart from the dashboard.');
                router.push('/dashboard');
                return;
            }

            // Handle retry scenarios
            const shouldRetry =
                result.error === 'Failed to validate session' ||
                result.error === 'INVALID_SESSION_TOKEN' ||
                result.error === 'Missing session token' ||
                result.error?.includes('session') ||
                result.error?.includes('VALIDATION_RPC_ERROR');

            if (shouldRetry) {
                logger.warn('Session validation failed, attempting retry with force_resume', { attemptId, error: result.error });

                // Get a completely fresh token
                updateSubmissionProgress('validating', 20);
                const refreshed = await forceRefreshSessionToken();
                if (refreshed) {
                    // CRITICAL: Use force_resume on retry to bypass validation issues
                    updateSubmissionProgress('submitting', 80);
                    let retry;
                    try {
                        retry = await withTimeout(
                            submitExam({
                                attemptId,
                                sessionToken: refreshed,
                                submissionId: submissionIdRef.current,
                                force_resume: true,  // Force resume on retry
                            }),
                            30000, // Increased from 15s to 30s
                            'submitExam'
                        );
                    } catch (error) {
                        logger.error('Submit retry timed out', error, { attemptId });

                        // FIX: Check server status after retry timeout too
                        try {
                            const res = await fetch('/api/attempt-status', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ attemptId }),
                            });
                            const payload = await res.json().catch(() => ({}));
                            const statusCheck = payload?.data?.status as string | undefined;

                            if (statusCheck === 'submitted' || statusCheck === 'completed') {
                                logger.info('Submit retry succeeded despite timeout', { attemptId });
                                attemptFinalizedRef.current = true;
                                updateSubmissionProgress('finalizing', 100);
                                clearAllExamState();
                                router.replace(`/result/${attemptId}`);
                                return;
                            }
                        } catch (checkError) {
                            logger.warn('Failed to check attempt status after retry timeout', checkError);
                        }

                        setUiError('Submitting timed out. Please try again.');
                        return;
                    }

                    if (retry.success) {
                        attemptFinalizedRef.current = true;
                        updateSubmissionProgress('finalizing', 100);
                        clearAllExamState();
                        router.replace(`/result/${attemptId}`);
                        return;
                    }

                    // If retry also fails with session conflict, show dialog
                    if (retry.error === 'SESSION_CONFLICT') {
                        setSessionConflict({ type: 'submit' });
                        return;
                    }

                    logger.error('Submit retry failed', retry.error, { attemptId });
                }
            }

            if (result.error === 'SESSION_CONFLICT') {
                setSessionConflict({ type: 'submit' });
                return;
            }

            logger.error('Failed to submit exam', result.error, { attemptId });

            // PHASE 4 FIX: Show more specific error message
            const errorMessage = result.error === 'INVALID_ATTEMPT_STATUS' ||
                result.error?.toLowerCase().includes('already submitted')
                ? 'Exam has already been submitted or is in an invalid state.'
                : result.error === 'ATTEMPT_NOT_FOUND' || result.error?.toLowerCase().includes('attempt not found')
                    ? 'This exam attempt was removed. Please restart from the dashboard.'
                    : result.error === 'INVALID_SESSION_TOKEN' || result.error?.includes('session')
                        ? 'Session expired. Please try submitting again.'
                        : `Failed to submit exam. Please try again. (${result.error || 'Unknown error'})`;
            setUiError(errorMessage);
        } catch (error) {
            logger.error('Submit flow failed', error, { attemptId });
            setUiError('Failed to submit exam. Please try again.');
        } finally {
            submitLockRef.current = false;
            setSubmitting(false);
        }
    }, [attemptId, responses, router, setUiError, hasAnswer, getPersistedAnswer, getIsVisited, forceRefreshSessionToken, isSubmitting, isAutoSubmitting, setSubmitting, withTimeout]);

    const handleResolveConflict = useCallback(async (resumeHere: boolean) => {
        if (!sessionConflict) return;

        if (!resumeHere) {
            setSessionConflict(null);
            return;
        }

        setIsResolvingConflict(true);
        try {
            // CRITICAL: Get a fresh session token before retrying
            const freshToken = await forceRefreshSessionToken();
            if (!freshToken) {
                setUiError('Unable to establish session. Please check your connection.');
                return;
            }

            if (sessionConflict.type === 'save') {
                const retry = await saveResponse({
                    ...sessionConflict.payload,
                    sessionToken: freshToken,
                    force_resume: true,
                });
                if (!retry.success && retry.error !== 'SESSION_CONFLICT') {
                    logger.error('Force resume save failed', retry.error);
                    setUiError('Failed to save response. Your progress may not be saved.');
                }
            }

            if (sessionConflict.type === 'submit') {
                const retry = await submitExam({
                    attemptId: attemptId!,
                    sessionToken: freshToken,
                    force_resume: true,
                    submissionId: submissionIdRef.current,
                });
                if (retry.success) {
                    attemptFinalizedRef.current = true;
                    clearAllExamState();
                    router.replace(`/result/${attemptId}`);
                } else if (retry.error === 'ATTEMPT_NOT_FOUND' || retry.error?.toLowerCase().includes('attempt not found')) {
                    clearAllExamState();
                    setUiError('This exam attempt was removed. Please restart from the dashboard.');
                    router.push('/dashboard');
                } else if (retry.error !== 'SESSION_CONFLICT') {
                    logger.error('Force resume submit failed', retry.error, { attemptId });
                    setUiError('Failed to submit exam. Please try again.');
                }
            }
        } finally {
            setIsResolvingConflict(false);
            setSessionConflict(null);
        }
    }, [sessionConflict, attemptId, router, forceRefreshSessionToken, setUiError]);

    // Handle pause exam
    const handlePauseExam = useCallback(async () => {
        if (!attemptId) return;
        setUiError(null);

        const confirmed = window.confirm(
            'Are you sure you want to pause the exam? You can resume it later from the dashboard.'
        );

        if (!confirmed) return;

        // Get fresh session token before pausing
        const activeSessionToken = sessionToken || await forceRefreshSessionToken();

        // Save all current responses with session token
        await Promise.all(
            Object.entries(responses).map(async ([questionId, response]) => {
                const persistedAnswer = getPersistedAnswer(response.status, response.answer);
                if (persistedAnswer !== null || response.status !== 'not_visited') {
                    await saveResponse({
                        attemptId: attemptId!,
                        questionId,
                        answer: persistedAnswer,
                        status: response.status,
                        isMarkedForReview: response.isMarkedForReview,
                        isVisited: getIsVisited(response.status, persistedAnswer),
                        timeSpentSeconds: response.timeSpentSeconds,
                        visitCount: response.visitCount,
                        sessionToken: activeSessionToken,
                    });
                }
            })
        );

        // Build time remaining from current section timers
        const timeRemaining: TimeRemaining = {
            VARC: sectionTimers.VARC.remainingSeconds,
            DILR: sectionTimers.DILR.remainingSeconds,
            QA: sectionTimers.QA.remainingSeconds,
        };

        const currentSection = getSectionByIndex(currentSectionIndex);

        // Pause the exam with session token
        const result = await pauseExam({
            attemptId,
            timeRemaining,
            currentSection,
            currentQuestion: currentQuestionIndex + 1,
            sessionToken: activeSessionToken,
        });

        if (result.success) {
            // Clear local storage
            clearAllExamState();

            // Redirect to dashboard
            router.push('/dashboard');
        } else {
            examLogger.examPaused(attemptId, false, result.error);
            // Show more helpful error message for pause-not-allowed
            const errorMessage = result.error?.includes('not allowed')
                ? 'Pausing is not allowed for this exam.'
                : 'Failed to pause exam. Please try again.';
            setUiError(errorMessage);
        }
    }, [attemptId, responses, sectionTimers, currentSectionIndex, currentQuestionIndex, router, sessionToken, getPersistedAnswer, getIsVisited, forceRefreshSessionToken, setUiError]);

    // Show loading while initializing
    if (!hasHydrated || !isInitialized) {
        return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4" />
                    <p className="text-gray-600">Loading exam...</p>
                </div>
            </div>
        );
    }

    return (
        <>
            {uiError && (
                <div className="px-6 py-3 bg-red-50 border-b border-red-200 text-red-700 text-sm" role="alert">
                    {uiError}
                </div>
            )}
            <ExamLayout
                paper={paper}
                questions={questions}
                onSaveResponse={handleSaveResponse}
                onSaveResponsesBatch={handleSaveResponsesBatch}
                onSubmitExam={handleSubmitExam}
                onSectionExpire={handleSectionExpire}
                onPauseExam={handlePauseExam}
                layoutMode={EXAM_LAYOUT_MODE}
                submissionProgress={submissionProgress}
            />

            {sessionConflict && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                        <h3 className="text-lg font-semibold text-gray-800 mb-2">
                            Active session detected
                        </h3>
                        <p className="text-sm text-gray-600 mb-6">
                            You have an active session on another device. Do you want to terminate it and resume here?
                        </p>
                        <div className="flex items-center justify-end gap-3">
                            <button
                                type="button"
                                onClick={() => handleResolveConflict(false)}
                                className="px-4 py-2 text-sm rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50"
                                disabled={isResolvingConflict}
                            >
                                Cancel
                            </button>
                            <button
                                type="button"
                                onClick={() => handleResolveConflict(true)}
                                className="px-4 py-2 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700"
                                disabled={isResolvingConflict}
                            >
                                {isResolvingConflict ? 'Resuming...' : 'Resume Here'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Dev-only testing panel - completely removed in production */}
            {process.env.NODE_ENV === 'development' && (
                <DevToolsPanel onTriggerSubmit={handleSubmitExam} />
            )}
        </>
    );
}
````

## File: src/features/exam-engine/lib/validation.ts
````typescript
/**
 * @fileoverview Zod Validation Schemas for Exam Engine
 * @description Schema validation for API requests and responses
 * @blueprint Milestone 4 SOP-SSOT - Phase 4.3
 */

import { z } from 'zod';

// =============================================================================
// BASE SCHEMAS
// =============================================================================

/** Section name enum */
export const SectionNameSchema = z.enum(['VARC', 'DILR', 'QA']);

/** Question type enum */
export const QuestionTypeSchema = z.enum(['MCQ', 'TITA']);

/** Question status enum */
export const QuestionStatusSchema = z.enum([
    'not_visited',
    'visited',
    'answered',
    'marked',
    'answered_marked',
]);

/** Attempt status enum */
export const AttemptStatusSchema = z.enum([
    'in_progress',
    'paused',
    'submitted',
    'completed',
    'abandoned',
    'expired',
]);

/** Difficulty level enum */
export const DifficultySchema = z.enum(['easy', 'medium', 'hard']);

/** Paper difficulty enum */
export const PaperDifficultySchema = z.enum(['easy', 'medium', 'hard', 'cat-level']);

// =============================================================================
// SECTION CONFIG SCHEMA
// =============================================================================

export const SectionConfigSchema = z.object({
    name: SectionNameSchema,
    questions: z.number().int().positive(),
    time: z.number().int().positive(), // minutes
    marks: z.number().int().positive(),
});

// =============================================================================
// QUESTION SCHEMA
// =============================================================================

export const QuestionSchema = z.object({
    id: z.string().uuid(),
    paper_id: z.string().uuid(),
    section: SectionNameSchema,
    question_number: z.number().int().positive(),
    question_text: z.string().min(1),
    question_type: QuestionTypeSchema,
    options: z.array(z.string()).nullable(),
    positive_marks: z.number().default(3.0),
    negative_marks: z.number().default(1.0),
    solution_text: z.string().optional().nullable(),
    solution_image_url: z.string().url().optional().nullable(),
    video_solution_url: z.string().url().optional().nullable(),
    question_image_url: z.string().url().optional().nullable(),
    difficulty: DifficultySchema.optional().nullable(),
    topic: z.string().optional().nullable(),
    subtopic: z.string().optional().nullable(),
    is_active: z.boolean().default(true),
    created_at: z.string(),
    updated_at: z.string(),
});

/** Question with correct answer (for results) */
export const QuestionWithAnswerSchema = QuestionSchema.extend({
    correct_answer: z.string(),
});

// =============================================================================
// PAPER SCHEMA
// =============================================================================

export const PaperSchema = z.object({
    id: z.string().uuid(),
    slug: z.string().min(1),
    title: z.string().min(1),
    description: z.string().optional().nullable(),
    year: z.number().int(),
    total_questions: z.number().int().positive(),
    total_marks: z.number().int().positive(),
    duration_minutes: z.number().int().positive(),
    sections: z.array(SectionConfigSchema),
    default_positive_marks: z.number().default(3.0),
    default_negative_marks: z.number().default(1.0),
    published: z.boolean(),
    available_from: z.string().optional().nullable(),
    available_until: z.string().optional().nullable(),
    difficulty_level: PaperDifficultySchema.optional().nullable(),
    is_free: z.boolean().default(true),
    attempt_limit: z.number().int().positive().optional().nullable(),
    created_at: z.string(),
    updated_at: z.string(),
});

// =============================================================================
// ATTEMPT SCHEMA
// =============================================================================

/** Time remaining per section */
export const TimeRemainingSchema = z.object({
    VARC: z.number().int().min(0),
    DILR: z.number().int().min(0),
    QA: z.number().int().min(0),
});

/** Section scores */
export const SectionScoreSchema = z.object({
    score: z.number(),
    correct: z.number().int().min(0),
    incorrect: z.number().int().min(0),
    unanswered: z.number().int().min(0),
});

export const SectionScoresSchema = z.object({
    VARC: SectionScoreSchema.optional(),
    DILR: SectionScoreSchema.optional(),
    QA: SectionScoreSchema.optional(),
});

export const AttemptSchema = z.object({
    id: z.string().uuid(),
    user_id: z.string().uuid(),
    paper_id: z.string().uuid(),
    started_at: z.string(),
    submitted_at: z.string().optional().nullable(),
    completed_at: z.string().optional().nullable(),
    submission_id: z.string().uuid().optional().nullable(),
    time_taken_seconds: z.number().int().optional().nullable(),
    paused_at: z.string().optional().nullable(),
    total_paused_seconds: z.number().int().optional().nullable(),
    status: AttemptStatusSchema,
    current_section: SectionNameSchema.optional().nullable(),
    current_question: z.number().int().min(1).default(1),
    time_remaining: TimeRemainingSchema.optional().nullable(),
    total_score: z.number().optional().nullable(),
    max_possible_score: z.number().optional().nullable(),
    correct_count: z.number().int().default(0),
    incorrect_count: z.number().int().default(0),
    unanswered_count: z.number().int().default(0),
    accuracy: z.number().optional().nullable(),
    attempt_rate: z.number().optional().nullable(),
    section_scores: SectionScoresSchema.optional().nullable(),
    percentile: z.number().optional().nullable(),
    rank: z.number().int().optional().nullable(),
    created_at: z.string(),
    updated_at: z.string(),
});

// =============================================================================
// RESPONSE SCHEMA
// =============================================================================

export const ResponseSchema = z.object({
    id: z.string().uuid(),
    attempt_id: z.string().uuid(),
    question_id: z.string().uuid(),
    answer: z.string().nullable(),
    is_correct: z.boolean().optional().nullable(),
    marks_obtained: z.number().optional().nullable(),
    status: QuestionStatusSchema,
    is_marked_for_review: z.boolean().default(false),
    is_visited: z.boolean().default(false),
    time_spent_seconds: z.number().int().min(0).default(0),
    visit_count: z.number().int().min(0).default(0),
    created_at: z.string(),
    updated_at: z.string(),
});

// =============================================================================
// API REQUEST SCHEMAS
// =============================================================================

/** Fetch paper request */
export const FetchPaperRequestSchema = z.object({
    paperId: z.string().uuid(),
    resume: z.boolean().optional(),
});

/** Save response request */
export const SaveResponseRequestSchema = z.object({
    attemptId: z.string().uuid(),
    questionId: z.string().uuid(),
    answer: z.string().nullable(),
    status: QuestionStatusSchema,
    isMarkedForReview: z.boolean(),
    isVisited: z.boolean().optional(),
    timeSpentSeconds: z.number().int().min(0),
    visitCount: z.number().int().min(0).optional(),
    sessionToken: z.string().nullable().optional(),
    force_resume: z.boolean().optional(),
});

/** Update section timer request */
export const UpdateTimerRequestSchema = z.object({
    attemptId: z.string().uuid(),
    timeRemaining: TimeRemainingSchema,
    currentSection: SectionNameSchema,
    currentQuestion: z.number().int().min(1),
});

/** Submit exam request */
export const SubmitExamRequestSchema = z.object({
    attemptId: z.string().uuid(),
    sessionToken: z.string().nullable().optional(),
    force_resume: z.boolean().optional(),
    submissionId: z.string().uuid().optional(),
});

// =============================================================================
// API RESPONSE SCHEMAS
// =============================================================================

/** Generic API response wrapper */
export const ApiResponseSchema = <T extends z.ZodType>(dataSchema: T) =>
    z.object({
        success: z.boolean(),
        data: dataSchema.optional(),
        error: z.string().optional(),
    });

/** Fetch paper response */
export const FetchPaperResponseSchema = z.object({
    paper: PaperSchema,
    questions: z.array(QuestionSchema),
    attempt: AttemptSchema,
});

/** Submit exam response */
export const SubmitExamResponseSchema = z.object({
    success: z.boolean(),
    total_score: z.number(),
    max_score: z.number(),
    correct: z.number().int(),
    incorrect: z.number().int(),
    unanswered: z.number().int(),
    accuracy: z.number(),
    attempt_rate: z.number(),
    section_scores: SectionScoresSchema,
});

// =============================================================================
// TYPE EXPORTS
// =============================================================================

export type SectionNameInput = z.infer<typeof SectionNameSchema>;
export type QuestionInput = z.infer<typeof QuestionSchema>;
export type QuestionWithAnswerInput = z.infer<typeof QuestionWithAnswerSchema>;
export type PaperInput = z.infer<typeof PaperSchema>;
export type AttemptInput = z.infer<typeof AttemptSchema>;
export type ResponseInput = z.infer<typeof ResponseSchema>;
export type TimeRemainingInput = z.infer<typeof TimeRemainingSchema>;
export type SaveResponseRequest = z.infer<typeof SaveResponseRequestSchema>;
export type UpdateTimerRequest = z.infer<typeof UpdateTimerRequestSchema>;
export type SubmitExamRequest = z.infer<typeof SubmitExamRequestSchema>;
export type FetchPaperResponse = z.infer<typeof FetchPaperResponseSchema>;
export type SubmitExamResponse = z.infer<typeof SubmitExamResponseSchema>;
````

## File: src/features/exam-engine/ui/index.ts
````typescript
/**
 * @fileoverview Exam Engine UI Components - Barrel Export
 * @description Public API for exam engine UI components
 * @blueprint Milestone 4 - Feature-Sliced Design (FSD)
 */

// Layout
export { ExamLayout } from './ExamLayout';

// Timer
export { ExamTimer, SectionTimerSummary } from './ExamTimer';

// Question Palette
export { QuestionPalette } from './QuestionPalette';

// Question Renderers
export { MCQRenderer } from './MCQRenderer';
export { TITARenderer } from './TITARenderer';
export { QuestionRenderer } from './QuestionRenderer';  // Question Container Architecture

// Calculator
export { Calculator } from './Calculator';

// Navigation
export { NavigationButtons, ExamSubmitButton } from './NavigationButtons';

// Result Components (Milestone 5)
export { ResultHeader } from './ResultHeader';
export { SectionalPerformance } from './SectionalPerformance';
export { QuestionAnalysis } from './QuestionAnalysis';
````

## File: src/features/exam-engine/ui/MathText.tsx
````typescript
/**
 * @fileoverview MathText Utility Component
 * @description Renders inline and block LaTeX using KaTeX
 */

'use client';

import { BlockMath, InlineMath } from 'react-katex';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import rehypeRaw from 'rehype-raw';

interface MathTextProps {
    text?: string | null;
    className?: string;
}

const MATH_PATTERN = /(\$\$[\s\S]+?\$\$|\$[^$]+\$)/g;
const CODE_LANG_PATTERN = /language-([\w-]+)/i;

type TableJson = {
    headers?: Array<string | number>;
    rows?: Array<Array<string | number>>;
    caption?: string;
};

type ChartJson = {
    title?: string;
    labels?: Array<string | number>;
    values?: number[];
};

type DiagramJson = {
    title?: string;
    nodes?: Array<{ id: string; label?: string; x?: number; y?: number }>;
    edges?: Array<{ from: string; to: string } | { source: string; target: string }>;
};

function tryParseJson(raw: string): { data?: unknown; error?: string } {
    try {
        return { data: JSON.parse(raw) };
    } catch (err) {
        const message = err instanceof Error ? err.message : 'Invalid JSON.';
        return { error: message };
    }
}

function renderJsonError(message: string, raw: string) {
    return (
        <div className="rounded-md border border-yellow-300 bg-yellow-50 p-3 text-sm text-yellow-900">
            <p className="font-semibold">Unable to render JSON block.</p>
            <p className="mt-1">{message}</p>
            <pre className="mt-2 whitespace-pre-wrap text-xs text-yellow-800">{raw}</pre>
        </div>
    );
}

function renderTableBlock(json: TableJson, raw: string) {
    const headers = json.headers ?? [];
    const rows = json.rows ?? [];

    if (!headers.length || !rows.length) {
        return renderJsonError('Expected "headers" and "rows" arrays.', raw);
    }

    return (
        <div className="overflow-x-auto">
            <table className="min-w-full border-collapse text-left">
                {json.caption && (
                    <caption className="caption-bottom mt-2 text-xs text-gray-500">{json.caption}</caption>
                )}
                <thead>
                    <tr>
                        {headers.map((header, index) => (
                            <th key={index} className="border px-3 py-2 text-xs font-semibold text-gray-700">
                                {header}
                            </th>
                        ))}
                    </tr>
                </thead>
                <tbody>
                    {rows.map((row, rowIndex) => (
                        <tr key={rowIndex} className="odd:bg-gray-50">
                            {row.map((cell, cellIndex) => (
                                <td key={cellIndex} className="border px-3 py-2 text-xs text-gray-700">
                                    {cell}
                                </td>
                            ))}
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
}

function renderChartBlock(json: ChartJson, raw: string) {
    const labels = json.labels ?? [];
    const values = json.values ?? [];

    if (!labels.length || !values.length || labels.length !== values.length) {
        return renderJsonError('Expected matching "labels" and "values" arrays.', raw);
    }

    const maxValue = Math.max(...values, 0);
    const width = 320;
    const height = 180;
    const barGap = 8;
    const barWidth = (width - barGap * (values.length + 1)) / values.length;

    return (
        <div className="overflow-x-auto">
            <svg
                width={width}
                height={height}
                viewBox={`0 0 ${width} ${height}`}
                role="img"
                aria-label={json.title || 'Bar chart'}
                className="max-w-full"
            >
                {json.title && <title>{json.title}</title>}
                {values.map((value, index) => {
                    const barHeight = maxValue > 0 ? (value / maxValue) * (height - 30) : 0;
                    const x = barGap + index * (barWidth + barGap);
                    const y = height - barHeight - 20;
                    return (
                        <g key={labels[index]}>
                            <rect x={x} y={y} width={barWidth} height={barHeight} fill="#3b82f6" rx={3} />
                            <text x={x + barWidth / 2} y={height - 6} textAnchor="middle" fontSize="10" fill="#475569">
                                {labels[index]}
                            </text>
                        </g>
                    );
                })}
            </svg>
        </div>
    );
}

function renderDiagramBlock(json: DiagramJson, raw: string) {
    const nodes = json.nodes ?? [];
    const edges = json.edges ?? [];

    if (!nodes.length) {
        return renderJsonError('Expected a "nodes" array.', raw);
    }

    const width = 360;
    const height = 200;
    const defaultY = height / 2;
    const spacing = nodes.length > 1 ? (width - 60) / (nodes.length - 1) : 0;

    const nodePositions = nodes.map((node, index) => ({
        ...node,
        x: node.x ?? 30 + index * spacing,
        y: node.y ?? defaultY,
    }));

    const nodeById = new Map(nodePositions.map(node => [node.id, node]));

    return (
        <div className="overflow-x-auto">
            <svg
                width={width}
                height={height}
                viewBox={`0 0 ${width} ${height}`}
                role="img"
                aria-label={json.title || 'Diagram'}
                className="max-w-full"
            >
                {json.title && <title>{json.title}</title>}
                {edges.map((edge, index) => {
                    const fromId = 'from' in edge ? edge.from : edge.source;
                    const toId = 'to' in edge ? edge.to : edge.target;
                    const fromNode = nodeById.get(fromId);
                    const toNode = nodeById.get(toId);
                    if (!fromNode || !toNode) {
                        return null;
                    }
                    return (
                        <line
                            key={`${fromId}-${toId}-${index}`}
                            x1={fromNode.x}
                            y1={fromNode.y}
                            x2={toNode.x}
                            y2={toNode.y}
                            stroke="#94a3b8"
                            strokeWidth={2}
                        />
                    );
                })}
                {nodePositions.map((node) => (
                    <g key={node.id}>
                        <circle cx={node.x} cy={node.y} r={14} fill="#f1f5f9" stroke="#64748b" strokeWidth={2} />
                        <text x={node.x} y={node.y + 4} textAnchor="middle" fontSize="10" fill="#334155">
                            {node.label ?? node.id}
                        </text>
                    </g>
                ))}
            </svg>
            <p className="mt-2 text-xs text-gray-500">Diagram rendering is basic; unsupported structures fall back to JSON.</p>
        </div>
    );
}

function renderMath(token: string, key: number) {
    if (token.startsWith('$$') && token.endsWith('$$')) {
        const math = token.slice(2, -2).trim();
        if (!math) return <span key={key} />;
        return <BlockMath key={key} math={math} />;
    }

    if (token.startsWith('$') && token.endsWith('$')) {
        const math = token.slice(1, -1).trim();
        if (!math) return <span key={key} />;
        return <InlineMath key={key} math={math} />;
    }

    return (
        <span key={key} className="whitespace-pre-wrap">
            {token}
        </span>
    );
}

/**
 * Detect para jumble questions and format sentences with numbers.
 * Para jumbles typically have an instruction followed by 4 sentences separated by newlines.
 */
function formatParaJumbleText(rawText: string): string {
    // Check if this looks like a para jumble question
    const lowerText = rawText.toLowerCase();
    const isParaJumble = (
        (lowerText.includes('labelled 1, 2, 3') || lowerText.includes('labeled 1, 2, 3')) &&
        (lowerText.includes('sequenced') || lowerText.includes('sequence'))
    );

    if (!isParaJumble) return rawText;

    // Split by double newlines to find instruction and sentences
    const parts = rawText.split(/\n\s*\n/).filter(p => p.trim());
    if (parts.length < 2) return rawText;

    // First part is the instruction
    const instruction = parts[0].trim();
    const sentences = parts.slice(1);

    // If we have 2-6 sentences, number them
    if (sentences.length >= 2 && sentences.length <= 6) {
        const numberedSentences = sentences.map((s, i) => `${i + 1}. ${s.trim()}`);
        return `${instruction}\n\n${numberedSentences.join('\n\n')}`;
    }

    return rawText;
}

export function MathText({ text, className }: MathTextProps) {
    if (text === null || text === undefined || text === '') {
        return null;
    }

    // Format para jumble questions with numbered sentences
    const formattedText = formatParaJumbleText(String(text));

    const normalizedText = formattedText
        .replace(/\\\[((?:.|\n)+?)\\\]/g, (_match, math) => `$$${math}$$`)
        .replace(/\\\(((?:.|\n)+?)\\\)/g, (_match, math) => `$${math}$`);

    const parts = normalizedText.split(MATH_PATTERN).filter(Boolean);

    return (
        <div className={`prose prose-sm max-w-none ${className ?? ''}`}>
            {parts.map((part, index) => {
                if ((part.startsWith('$$') && part.endsWith('$$')) || (part.startsWith('$') && part.endsWith('$'))) {
                    return renderMath(part, index);
                }

                return (
                    <ReactMarkdown
                        key={index}
                        remarkPlugins={[remarkGfm]}
                        rehypePlugins={[rehypeRaw]}
                        components={{
                            p: ({ children }) => <div className="whitespace-pre-wrap">{children}</div>,
                            ol: ({ children, ...props }) => (
                                <ol
                                    {...props}
                                    className="list-decimal list-inside ml-4 space-y-1"
                                >
                                    {children}
                                </ol>
                            ),
                            ul: ({ children, ...props }) => (
                                <ul
                                    {...props}
                                    className="list-disc list-inside ml-4 space-y-1"
                                >
                                    {children}
                                </ul>
                            ),
                            li: ({ children, ...props }) => (
                                <li {...props} className="leading-relaxed">
                                    {children}
                                </li>
                            ),
                            pre: ({ children }) => (
                                <div className="overflow-x-auto rounded bg-gray-100 p-3 text-xs whitespace-pre font-mono">
                                    {children}
                                </div>
                            ),
                            table: ({ children }) => <table className="table-auto border-collapse">{children}</table>,
                            th: ({ children }) => <th className="border px-2 py-1">{children}</th>,
                            td: ({ children }) => <td className="border px-2 py-1">{children}</td>,
                            code: (props) => {
                                const { className, children } = props;
                                const inline = 'inline' in props ? Boolean(props.inline) : false;
                                const raw = String(children ?? '').replace(/\n$/, '');
                                if (inline) {
                                    return <code className="rounded bg-gray-100 px-1 py-0.5 text-xs">{children}</code>;
                                }

                                const lang = className?.match(CODE_LANG_PATTERN)?.[1]?.toLowerCase() ?? '';
                                const normalized = lang.trim();

                                if (['table-json', 'chart-json', 'diagram-json'].includes(normalized)) {
                                    const { data, error } = tryParseJson(raw);
                                    if (error || !data) {
                                        return renderJsonError(error || 'Invalid JSON.', raw);
                                    }

                                    if (normalized === 'table-json') {
                                        return renderTableBlock(data as TableJson, raw);
                                    }

                                    if (normalized === 'chart-json') {
                                        return renderChartBlock(data as ChartJson, raw);
                                    }

                                    if (normalized === 'diagram-json') {
                                        return renderDiagramBlock(data as DiagramJson, raw);
                                    }
                                }

                                // Use div instead of pre to avoid hydration error when wrapped in <p>
                                return (
                                    <div className="overflow-x-auto rounded bg-gray-100 p-3 text-xs whitespace-pre font-mono">
                                        <code className={className}>{children}</code>
                                    </div>
                                );
                            },
                        }}
                    >
                        {part}
                    </ReactMarkdown>
                );
            })}
        </div>
    );
}
````

## File: src/features/exam-engine/ui/NavigationButtons.tsx
````typescript
/**
 * @fileoverview Navigation Buttons Component
 * @description Save & Next, Mark for Review, Clear Response, Previous buttons
 * @blueprint Milestone 4 SOP-SSOT - Phase 3.5
 */

'use client';

import { useCallback } from 'react';
import { useExamStore, selectResponse, selectCurrentSection } from '@/features/exam-engine';
import type { Question } from '@/types/exam';
import { getQuestionsForSection } from '@/types/exam';

// =============================================================================
// TYPES
// =============================================================================

interface NavigationButtonsProps {
    /** Current question */
    question: Question;
    /** All questions in the paper */
    questions: Question[];
    /** Callback when moving to next question */
    onNextQuestion?: () => void;
    /** Callback when moving to previous question */
    onPrevQuestion?: () => void;
    /** Callback for saving answer */
    onSave?: (questionId: string, answer: string | null) => Promise<void>;
    /** Optional CSS class name */
    className?: string;
}

interface ButtonProps {
    onClick: () => void;
    disabled?: boolean;
    variant: 'primary' | 'secondary' | 'warning' | 'danger';
    children: React.ReactNode;
    className?: string;
}

// =============================================================================
// BUTTON COMPONENT
// =============================================================================

function NavButton({ onClick, disabled, variant, children, className = '' }: ButtonProps) {
    // TCS iON-inspired palette
    const variantStyles = {
        // Primary action: Save & Next (yellow with dark text)
        primary: 'bg-[#f7c600] text-[#1a1a1a] hover:bg-[#f0b800] focus:ring-[#f7c600] border border-[#d9a400] shadow-sm',

        // Secondary: Previous (cool gray)
        secondary: 'bg-[#eceff1] text-[#37474f] hover:bg-[#e0e6e9] focus:ring-[#cfd8dc] border border-[#cfd8dc] shadow-sm',

        // Warning: Mark for Review (indigo/purple)
        warning: 'bg-[#5c6bc0] text-white hover:bg-[#4652a3] focus:ring-[#5c6bc0] border border-[#4652a3] shadow-sm',

        // Danger: Clear Response (red)
        danger: 'bg-[#e53935] text-white hover:bg-[#d32f2f] focus:ring-[#e53935] border border-[#c62828] shadow-sm',
    };

    return (
        <button
            type="button"
            onClick={onClick}
            disabled={disabled}
            className={`
                px-4 py-2.5 rounded-md font-medium transition-all
        focus:outline-none focus:ring-2 focus:ring-offset-2
        disabled:opacity-50 disabled:cursor-not-allowed
        ${variantStyles[variant]}
        ${className}
      `}
        >
            {children}
        </button>
    );
}

// =============================================================================
// MAIN COMPONENT
// =============================================================================

export function NavigationButtons({
    question,
    questions,
    onNextQuestion,
    onPrevQuestion,
    onSave,
    className = '',
}: NavigationButtonsProps) {
    const currentSection = useExamStore(selectCurrentSection);
    const currentQuestionIndex = useExamStore((s) => s.currentQuestionIndex);
    const currentSectionIndex = useExamStore((s) => s.currentSectionIndex);
    const response = useExamStore(selectResponse(question.id));

    const goToQuestion = useExamStore((s) => s.goToQuestion);
    const clearAnswer = useExamStore((s) => s.clearAnswer);
    const toggleMarkForReview = useExamStore((s) => s.toggleMarkForReview);
    const setResponseStatus = useExamStore((s) => s.setResponseStatus);
    // FIX: Use saveAnswer to update status when saving
    const saveAnswer = useExamStore((s) => s.saveAnswer);
    // NOTE: moveToNextSection removed - sections advance only via timer expiry (SOP requirement)

    // Get questions for current section
    const sectionQuestions = getQuestionsForSection(questions, currentSection);
    const totalQuestionsInSection = sectionQuestions.length;

    // Check if at first/last question in section
    const isFirstQuestion = currentQuestionIndex === 0;
    const isLastQuestion = currentQuestionIndex === totalQuestionsInSection - 1;
    const isLastSection = currentSectionIndex === 2; // QA is index 2

    // Current response state
    const isMarked = response?.isMarkedForReview ?? false;
    const hasLocalAnswer = response?.answer !== null && response?.answer !== '';

    // Handle Save & Next - FIX: Use saveAnswer to set status to 'answered'
    const handleSaveAndNext = useCallback(async () => {
        // Only save if there's an answer
        if (hasLocalAnswer && response?.answer) {
            // Update status to 'answered' in store
            saveAnswer(question.id, response.answer);
            // Persist to database
            if (onSave) {
                await onSave(question.id, response.answer);
            }
        }

        if (isLastQuestion) {
            return;
        }

        // Move to next question
        const nextIndex = currentQuestionIndex + 1;
        const nextQuestion = sectionQuestions[nextIndex];
        if (nextQuestion) {
            goToQuestion(nextQuestion.id, currentSectionIndex, nextIndex);
            onNextQuestion?.();
        }
    }, [
        currentQuestionIndex,
        currentSectionIndex,
        goToQuestion,
        hasLocalAnswer,
        isLastQuestion,
        onNextQuestion,
        onSave,
        question.id,
        response?.answer,
        saveAnswer,
        sectionQuestions,
    ]);

    // Handle Mark for Review & Next
    // FIX: Correct logic for Mark & Next:
    // 1) Has local answer → SAVE + MARK → answered_marked (purple with check)
    // 2) No local answer → just MARK → marked (purple, no check)
    const handleMarkAndNext = useCallback(async () => {
        if (hasLocalAnswer && response?.answer) {
            // Has answer - save it AND mark
            toggleMarkForReview(question.id);
            saveAnswer(question.id, response.answer);  // Sets status to answered_marked
            if (onSave) {
                await onSave(question.id, response.answer);
            }
        } else {
            // No answer - just mark
            toggleMarkForReview(question.id);
            setResponseStatus(question.id, 'marked', true);
            if (onSave) {
                await onSave(question.id, null);
            }
        }

        if (isLastQuestion) {
            return;
        }

        // Move to next question
        const nextIndex = currentQuestionIndex + 1;
        const nextQuestion = sectionQuestions[nextIndex];
        if (nextQuestion) {
            goToQuestion(nextQuestion.id, currentSectionIndex, nextIndex);
            onNextQuestion?.();
        }
    }, [
        currentQuestionIndex,
        currentSectionIndex,
        goToQuestion,
        hasLocalAnswer,
        isLastQuestion,
        onNextQuestion,
        onSave,
        question.id,
        response?.answer,
        saveAnswer,
        sectionQuestions,
        setResponseStatus,
        toggleMarkForReview,
    ]);

    // Handle Clear Response
    const handleClear = useCallback(() => {
        clearAnswer(question.id);
    }, [clearAnswer, question.id]);

    // Handle Previous
    const handlePrevious = useCallback(() => {
        if (isFirstQuestion) return;

        const prevIndex = currentQuestionIndex - 1;
        const prevQuestion = sectionQuestions[prevIndex];
        if (prevQuestion) {
            goToQuestion(prevQuestion.id, currentSectionIndex, prevIndex);
            onPrevQuestion?.();
        }
    }, [
        currentQuestionIndex,
        currentSectionIndex,
        goToQuestion,
        isFirstQuestion,
        onPrevQuestion,
        sectionQuestions,
    ]);

    // NOTE: Section submit removed - sections advance only via timer expiry (SOP requirement)

    return (
        <div className={`flex flex-wrap items-center justify-between gap-4 ${className}`}>
            {/* Left Side - Clear & Previous */}
            <div className="flex items-center gap-3">
                <NavButton
                    variant="danger"
                    onClick={handleClear}
                    disabled={!hasLocalAnswer}
                >
                    Clear Response
                </NavButton>

                <NavButton
                    variant="secondary"
                    onClick={handlePrevious}
                    disabled={isFirstQuestion}
                >
                    ← Previous
                </NavButton>
            </div>

            {/* Right Side - Mark, Save, Submit Section */}
            <div className="flex items-center gap-3">
                <NavButton
                    variant="warning"
                    onClick={handleMarkAndNext}
                >
                    {isMarked ? '★ Marked' : 'Mark for Review'} & Next
                </NavButton>

                {isLastQuestion ? (
                    // Last question in section - no manual submit allowed
                    // Section advances only when timer expires (per SOP)
                    <NavButton
                        variant="secondary"
                        onClick={() => { }}
                        disabled
                    >
                        {isLastSection ? 'Last Question' : 'Wait for Timer'}
                    </NavButton>
                ) : (
                    <NavButton
                        variant="primary"
                        onClick={handleSaveAndNext}
                    >
                        Save & Next →
                    </NavButton>
                )}
            </div>
        </div>
    );
}

// =============================================================================
// EXAM SUBMIT BUTTON (Only shown in last section - QA)
// Sections advance via timer expiry only (per SOP for full-length mocks)
// =============================================================================

interface ExamSubmitProps {
    onSubmitExam: () => void;
    isLastSection: boolean;
    className?: string;
}

export function ExamSubmitButton({
    onSubmitExam,
    isLastSection,
    className = '',
}: ExamSubmitProps) {
    // Only render submit button in last section (QA)
    if (!isLastSection) {
        return (
            <div className={`flex items-center gap-4 ${className}`}>
                <p className="text-sm text-gray-500 italic">
                    Section will auto-submit when timer expires
                </p>
            </div>
        );
    }

    return (
        <div className={`flex items-center gap-4 ${className}`}>
            <button
                type="button"
                onClick={onSubmitExam}
                className="px-6 py-3 bg-green-600 text-white font-bold rounded-lg
            hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500
            transition-colors"
            >
                Submit Exam
            </button>
        </div>
    );
}
````

## File: src/features/exam-engine/ui/QuestionRenderer.tsx
````typescript
/**
 * @fileoverview Question Set Renderer Component
 * @description Renders question sets with appropriate layout based on set_type
 * @architecture Question Container Architecture - Parent-Child Model
 * 
 * Layout Decision Logic:
 * - Composite Sets (VARC/DILR/CASELET): SplitPaneLayout with context on left
 * - Atomic Sets: SingleFocusLayout with centered question
 */

'use client';

import { useMemo, useCallback } from 'react';
import type {
    QuestionSet,
    QuestionSetType,
    QuestionInSet,
} from '@/types/exam';
import { isCompositeSet } from '@/types/exam';
import { MathText } from './MathText';
import { MCQRenderer } from './MCQRenderer';
import { TITARenderer } from './TITARenderer';

// =============================================================================
// TYPES
// =============================================================================

interface QuestionRendererProps {
    /** The question set to render */
    questionSet: QuestionSet;
    /** Currently active question index within the set (0-based) */
    activeQuestionIndex: number;
    /** Callback when user navigates to different question in set */
    onQuestionChange?: (index: number) => void;
    /** User's responses for questions in this set */
    responses?: Record<string, string | null>;
    /** Callback when user selects an answer */
    onAnswerChange?: (questionId: string, answer: string | null) => void;
    /** Whether exam is in review mode (show correct answers) */
    isReviewMode?: boolean;
    /** Render in read-only mode (review) */
    readOnly?: boolean;
    /** Show correct answers in review mode */
    showCorrectAnswer?: boolean;
    /** Correct answers keyed by question id */
    correctAnswerMap?: Record<string, string>;
    /** Optional: solution content keyed by question id (review mode) */
    solutionMap?: Record<string, {
        solution_text?: string | null;
        solution_image_url?: string | null;
        video_solution_url?: string | null;
    }>;
    /** Optional: show bookmark toggle for the active question */
    showBookmarkToggle?: boolean;
    /** Optional: list of bookmarked question ids */
    bookmarkedQuestionIds?: Set<string> | Record<string, boolean>;
    /** Optional: callback to toggle bookmark for a question */
    onToggleBookmark?: (questionId: string) => void;
}

// =============================================================================
// SPLIT PANE SECTIONS (For VARC / DILR / CASELET)
// =============================================================================

interface ContextPaneProps {
    questionSet: QuestionSet;
}

export function ContextPane({ questionSet }: ContextPaneProps) {
    // Get image position from metadata, default to 'before'
    const imagePosition = questionSet.metadata?.image_position ?? 'before';

    // Helper to render the context image
    const renderContextImage = () => {
        if (!questionSet.context_image_url) return null;
        return (
            <div className="mb-4">
                <img
                    src={questionSet.context_image_url}
                    alt={questionSet.context_title || 'Context diagram'}
                    className="max-w-full h-auto rounded-lg border border-gray-200 shadow-sm"
                />
            </div>
        );
    };

    // Helper to render context body with optional image insertion after specific paragraph
    const renderContextBody = () => {
        if (!questionSet.context_body) return null;

        // Check if image should be placed after a specific paragraph
        const afterParaMatch = imagePosition.match(/^after_para_(\d+)$/);

        if (afterParaMatch && questionSet.context_image_url) {
            const paraNumber = parseInt(afterParaMatch[1], 10);
            // Split context by double newlines (paragraphs)
            const paragraphs = questionSet.context_body.split(/\n\n+/);

            return (
                <div className="prose prose-sm max-w-none text-exam-text-body leading-exam">
                    {paragraphs.map((para, idx) => (
                        <div key={idx}>
                            <MathText text={para} />
                            {/* Insert image after the specified paragraph */}
                            {idx + 1 === paraNumber && (
                                <div className="my-4">
                                    <img
                                        src={questionSet.context_image_url}
                                        alt={questionSet.context_title || 'Context diagram'}
                                        className="max-w-full h-auto rounded-lg border border-gray-200 shadow-sm"
                                    />
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            );
        }

        return (
            <div className="prose prose-sm max-w-none text-exam-text-body leading-exam">
                <MathText text={questionSet.context_body} />
            </div>
        );
    };

    return (
        <div className="h-full overflow-y-auto border-r border-exam-bg-border bg-exam-bg-white">
            <div className="sticky top-0 bg-exam-bg-pane border-b border-exam-bg-border px-4 py-2 z-10">
                <h3 className="text-sm font-semibold text-exam-header-from flex items-center gap-2">
                    <ContextIcon setType={questionSet.set_type} />
                    {questionSet.context_title || getDefaultContextTitle(questionSet.set_type)}
                </h3>
            </div>

            <div className="p-6">
                {/* Image before text (default) */}
                {imagePosition === 'before' && renderContextImage()}

                {/* Context Body (passage text) with potential inline image */}
                {renderContextBody()}

                {/* Image after text */}
                {imagePosition === 'after' && renderContextImage()}

                {/* Additional Images */}
                {questionSet.context_additional_images?.map((img, idx) => (
                    <figure key={img.url || `img-${idx}`} className="mt-4">
                        <img
                            src={img.url}
                            alt={img.caption || `Additional figure ${idx + 1}`}
                            className="max-w-full h-auto rounded border border-gray-200"
                        />
                        {img.caption && (
                            <figcaption className="text-xs text-gray-500 mt-1 text-center">
                                {img.caption}
                            </figcaption>
                        )}
                    </figure>
                ))}
            </div>
        </div>
    );
}

interface QuestionPaneProps {
    activeQuestion: QuestionInSet;
    activeQuestionIndex: number;
    totalQuestions: number;
    onQuestionChange: (index: number) => void;
    response: string | null;
    onAnswerChange: (questionId: string, answer: string | null) => void;
    isReviewMode?: boolean;
    readOnly?: boolean;
    showCorrectAnswer?: boolean;
    responses?: Record<string, string | null>;
    correctAnswerMap?: Record<string, string>;
    solutionMap?: Record<string, {
        solution_text?: string | null;
        solution_image_url?: string | null;
        video_solution_url?: string | null;
    }>;
    showBookmarkToggle?: boolean;
    isBookmarked?: boolean;
    onToggleBookmark?: (questionId: string) => void;
}

export function QuestionPane({
    activeQuestion,
    activeQuestionIndex,
    totalQuestions,
    onQuestionChange,
    response,
    onAnswerChange,
    isReviewMode,
    readOnly,
    showCorrectAnswer,
    responses,
    correctAnswerMap,
    solutionMap,
    showBookmarkToggle,
    isBookmarked,
    onToggleBookmark,
}: QuestionPaneProps) {
    return (
        <div className="h-full overflow-y-auto bg-exam-bg-white">
            {/* Question Navigation within Set */}
            <div className="sticky top-0 bg-exam-bg-pane border-b border-exam-bg-border px-4 py-2 z-10">
                <div className="flex items-center justify-between">
                    <span className="text-sm text-exam-text-secondary">
                        Question {activeQuestionIndex + 1} of {totalQuestions}
                    </span>
                    <div className="flex gap-1">
                        {Array.from({ length: totalQuestions }).map((_, idx) => (
                            <button
                                key={idx}
                                onClick={() => onQuestionChange(idx)}
                                className={`
                                    w-7 h-7 rounded text-xs font-medium transition-colors
                                    ${idx === activeQuestionIndex
                                        ? 'bg-status-current text-white'
                                        : 'bg-white border border-status-border text-exam-text-primary hover:bg-gray-100'
                                    }
                                `}
                            >
                                {idx + 1}
                            </button>
                        ))}
                    </div>
                </div>
            </div>

            {/* Question Content */}
            <div className="p-6">
                <QuestionContent
                    question={activeQuestion}
                    response={response}
                    onAnswerChange={onAnswerChange}
                    isReviewMode={isReviewMode}
                    readOnly={readOnly}
                    showCorrectAnswer={showCorrectAnswer}
                    responses={responses}
                    correctAnswerMap={correctAnswerMap}
                    solutionMap={solutionMap}
                    showBookmarkToggle={showBookmarkToggle}
                    isBookmarked={isBookmarked}
                    onToggleBookmark={onToggleBookmark}
                />
            </div>
        </div>
    );
}

interface SplitPaneLayoutProps {
    questionSet: QuestionSet;
    activeQuestion: QuestionInSet;
    activeQuestionIndex: number;
    totalQuestions: number;
    onQuestionChange: (index: number) => void;
    response: string | null;
    onAnswerChange: (questionId: string, answer: string | null) => void;
    isReviewMode?: boolean;
    readOnly?: boolean;
    showCorrectAnswer?: boolean;
    responses?: Record<string, string | null>;
    correctAnswerMap?: Record<string, string>;
    solutionMap?: Record<string, {
        solution_text?: string | null;
        solution_image_url?: string | null;
        video_solution_url?: string | null;
    }>;
    showBookmarkToggle?: boolean;
    isBookmarked?: boolean;
    onToggleBookmark?: (questionId: string) => void;
}

function SplitPaneLayout({
    questionSet,
    activeQuestion,
    activeQuestionIndex,
    totalQuestions,
    onQuestionChange,
    response,
    onAnswerChange,
    isReviewMode,
    readOnly,
    showCorrectAnswer,
    responses,
    correctAnswerMap,
    solutionMap,
    showBookmarkToggle,
    isBookmarked,
    onToggleBookmark,
}: SplitPaneLayoutProps) {
    return (
        <div className="contents">
            <ContextPane questionSet={questionSet} />
            <QuestionPane
                activeQuestion={activeQuestion}
                activeQuestionIndex={activeQuestionIndex}
                totalQuestions={totalQuestions}
                onQuestionChange={onQuestionChange}
                response={response}
                onAnswerChange={onAnswerChange}
                isReviewMode={isReviewMode}
                readOnly={readOnly}
                showCorrectAnswer={showCorrectAnswer}
                responses={responses}
                correctAnswerMap={correctAnswerMap}
                solutionMap={solutionMap}
                showBookmarkToggle={showBookmarkToggle}
                isBookmarked={isBookmarked}
                onToggleBookmark={onToggleBookmark}
            />
        </div>
    );
}

// =============================================================================
// SINGLE FOCUS LAYOUT (For ATOMIC questions)
// =============================================================================

interface SingleFocusLayoutProps {
    questionSet: QuestionSet;
    activeQuestion: QuestionInSet;
    response: string | null;
    onAnswerChange: (questionId: string, answer: string | null) => void;
    isReviewMode?: boolean;
    /** P4.1: When true, render context body inline above question (for single-question text-only sets) */
    showInlineContext?: boolean;
    readOnly?: boolean;
    showCorrectAnswer?: boolean;
    responses?: Record<string, string | null>;
    correctAnswerMap?: Record<string, string>;
    solutionMap?: Record<string, {
        solution_text?: string | null;
        solution_image_url?: string | null;
        video_solution_url?: string | null;
    }>;
    showBookmarkToggle?: boolean;
    isBookmarked?: boolean;
    onToggleBookmark?: (questionId: string) => void;
}

function SingleFocusLayout({
    questionSet,
    activeQuestion,
    response,
    onAnswerChange,
    isReviewMode,
    showInlineContext = false,
    readOnly,
    showCorrectAnswer,
    responses,
    correctAnswerMap,
    solutionMap,
    showBookmarkToggle,
    isBookmarked,
    onToggleBookmark,
}: SingleFocusLayoutProps) {
    return (
        <div className="h-full overflow-y-auto bg-exam-bg-white">
            <div className="max-w-3xl mx-auto p-8">
                {/* P4.1: Inline context for single-question text-only sets */}
                {showInlineContext && questionSet.context_body && (
                    <div className="mb-6 pb-6 border-b border-gray-200">
                        {questionSet.context_title && (
                            <h3 className="text-[15px] font-semibold text-exam-header-from mb-3 flex items-center gap-2">
                                <ContextIcon setType={questionSet.set_type} />
                                {questionSet.context_title}
                            </h3>
                        )}
                        <div className="prose prose-sm max-w-none text-exam-text-body leading-exam">
                            <MathText text={questionSet.context_body} />
                        </div>
                    </div>
                )}

                {/* Optional: Image at top for diagram-based questions */}
                {questionSet.context_image_url && (
                    <div className="mb-6">
                        <img
                            src={questionSet.context_image_url}
                            alt="Question diagram"
                            className="max-w-full h-auto rounded-lg border border-gray-200 shadow-sm mx-auto"
                        />
                    </div>
                )}

                {/* Question Content */}
                <QuestionContent
                    question={activeQuestion}
                    response={response}
                    onAnswerChange={onAnswerChange}
                    isReviewMode={isReviewMode}
                    showImage={true}
                    readOnly={readOnly}
                    showCorrectAnswer={showCorrectAnswer}
                    responses={responses}
                    correctAnswerMap={correctAnswerMap}
                    solutionMap={solutionMap}
                    showBookmarkToggle={showBookmarkToggle}
                    isBookmarked={isBookmarked}
                    onToggleBookmark={onToggleBookmark}
                />
            </div>
        </div>
    );
}

// =============================================================================
// SHARED QUESTION CONTENT COMPONENT
// =============================================================================

interface QuestionContentProps {
    question: QuestionInSet;
    response: string | null;
    onAnswerChange: (questionId: string, answer: string | null) => void;
    isReviewMode?: boolean;
    showImage?: boolean;
    readOnly?: boolean;
    showCorrectAnswer?: boolean;
    responses?: Record<string, string | null>;
    correctAnswerMap?: Record<string, string>;
    solutionMap?: Record<string, {
        solution_text?: string | null;
        solution_image_url?: string | null;
        video_solution_url?: string | null;
    }>;
    showBookmarkToggle?: boolean;
    isBookmarked?: boolean;
    onToggleBookmark?: (questionId: string) => void;
}

function QuestionContent({
    question,
    response: _response,
    onAnswerChange: _onAnswerChange,
    isReviewMode: _isReviewMode,
    showImage = false,
    readOnly = false,
    showCorrectAnswer = false,
    responses,
    correctAnswerMap,
    solutionMap,
    showBookmarkToggle,
    isBookmarked = false,
    onToggleBookmark,
}: QuestionContentProps) {
    // Create a Question object compatible with existing renderers
    const questionForRenderer = useMemo(() => ({
        id: question.id,
        paper_id: question.paper_id,
        section: question.section,
        question_number: question.question_number,
        question_text: question.question_text,
        question_type: question.question_type,
        options: question.options,
        positive_marks: question.positive_marks,
        negative_marks: question.negative_marks,
        difficulty: question.difficulty,
        topic: question.topic,
        subtopic: question.subtopic,
        question_image_url: question.question_image_url,
        is_active: question.is_active,
        created_at: '',
        updated_at: '',
    }), [question]);

    const answerOverride = responses?.[question.id] ?? null;
    const correctAnswer = correctAnswerMap?.[question.id];
    const solution = solutionMap?.[question.id];
    const hasSolution = Boolean(solution?.solution_text || solution?.solution_image_url || solution?.video_solution_url);

    return (
        <div className="space-y-6">
            {showBookmarkToggle && onToggleBookmark && (
                <div className="flex justify-end">
                    <button
                        type="button"
                        onClick={() => onToggleBookmark(question.id)}
                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs font-semibold transition-colors ${isBookmarked
                            ? 'border-amber-300 bg-amber-50 text-amber-600'
                            : 'border-gray-200 text-gray-500 hover:bg-gray-50'
                            }`}
                        aria-pressed={isBookmarked}
                    >
                        <svg
                            className="h-4 w-4"
                            viewBox="0 0 24 24"
                            fill={isBookmarked ? 'currentColor' : 'none'}
                            stroke="currentColor"
                            strokeWidth={2}
                        >
                            <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                d="M5 4a2 2 0 012-2h10a2 2 0 012 2v18l-7-4-7 4V4z"
                            />
                        </svg>
                        {isBookmarked ? 'Bookmarked' : 'Bookmark'}
                    </button>
                </div>
            )}
            {/* Question Image (if shown in single focus mode) */}
            {showImage && question.question_image_url && (
                <div className="mb-4">
                    <img
                        src={question.question_image_url}
                        alt="Question diagram"
                        className="max-w-full max-h-64 w-auto h-auto object-contain rounded border border-gray-200"
                    />
                </div>
            )}

            {/* Question Text */}
            <div className="text-base leading-exam text-exam-text-body">
                <MathText text={question.question_text} />
            </div>

            {/* Marks Info */}
            <div className="text-sm text-exam-text-muted">
                Marks: +{question.positive_marks} / -{question.negative_marks}
            </div>

            {/* Answer Options */}
            <div className="mt-4">
                {question.question_type === 'MCQ' ? (
                    <MCQRenderer
                        question={questionForRenderer}
                        readOnly={readOnly}
                        showCorrectAnswer={showCorrectAnswer}
                        correctAnswer={correctAnswer}
                        answerOverride={answerOverride}
                    />
                ) : (
                    <TITARenderer
                        question={questionForRenderer}
                        readOnly={readOnly}
                        showCorrectAnswer={showCorrectAnswer}
                        correctAnswer={correctAnswer}
                        answerOverride={answerOverride}
                    />
                )}
            </div>

            {hasSolution && (
                <details className="rounded-lg border border-gray-200 bg-white p-3">
                    <summary className="cursor-pointer text-sm font-semibold text-blue-600">
                        View solution
                    </summary>
                    <div className="mt-3 space-y-3 text-sm text-gray-700">
                        {solution?.solution_text && (
                            <div className="prose prose-sm max-w-none">
                                <MathText text={solution.solution_text} />
                            </div>
                        )}
                        {solution?.solution_image_url && (
                            <div className="rounded border border-gray-200 overflow-hidden">
                                <img
                                    src={solution.solution_image_url}
                                    alt="Solution"
                                    className="w-full h-auto"
                                />
                            </div>
                        )}
                        {solution?.video_solution_url && (
                            <a
                                href={solution.video_solution_url}
                                target="_blank"
                                rel="noreferrer"
                                className="text-blue-600 hover:underline text-sm"
                            >
                                Watch video solution
                            </a>
                        )}
                    </div>
                </details>
            )}
        </div>
    );
}

// =============================================================================
// HELPER COMPONENTS
// =============================================================================

function ContextIcon({ setType }: { setType: QuestionSetType }) {
    switch (setType) {
        case 'VARC':
            return (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                    />
                </svg>
            );
        case 'DILR':
            return (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                    />
                </svg>
            );
        case 'CASELET':
            return (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                    />
                </svg>
            );
        default:
            return null;
    }
}

function getDefaultContextTitle(setType: QuestionSetType): string {
    switch (setType) {
        case 'VARC': return 'Reading Passage';
        case 'DILR': return 'Data Set';
        case 'CASELET': return 'Case Study';
        default: return 'Context';
    }
}

// =============================================================================
// MAIN RENDERER COMPONENT
// =============================================================================

/**
 * QuestionRenderer - Main component for rendering question sets
 * 
 * Decides layout based on set_type:
 * - Composite (VARC/DILR/CASELET): SplitPaneLayout
 * - Atomic: SingleFocusLayout
 */
export function QuestionRenderer({
    questionSet,
    activeQuestionIndex,
    onQuestionChange,
    responses = {},
    onAnswerChange,
    isReviewMode = false,
    readOnly = false,
    showCorrectAnswer = false,
    correctAnswerMap,
    solutionMap,
    showBookmarkToggle = false,
    bookmarkedQuestionIds,
    onToggleBookmark,
}: QuestionRendererProps) {
    // Get questions from the set
    const questions = questionSet.questions ?? [];

    // Validate we have questions
    if (questions.length === 0) {
        return (
            <div className="h-full flex items-center justify-center bg-exam-bg-page">
                <div className="text-center">
                    <p className="text-exam-text-muted">No questions in this set.</p>
                </div>
            </div>
        );
    }

    // Get active question (clamp index to valid range)
    const safeIndex = Math.max(0, Math.min(activeQuestionIndex, questions.length - 1));
    const activeQuestion = questions[safeIndex];

    // Get current response
    const currentResponse = responses[activeQuestion.id] ?? null;

    const isBookmarked = useMemo(() => {
        if (!bookmarkedQuestionIds) return false;
        if (bookmarkedQuestionIds instanceof Set) {
            return bookmarkedQuestionIds.has(activeQuestion.id);
        }
        return Boolean(bookmarkedQuestionIds[activeQuestion.id]);
    }, [bookmarkedQuestionIds, activeQuestion.id]);

    // Handle answer changes
    const handleAnswerChange = useCallback((questionId: string, answer: string | null) => {
        onAnswerChange?.(questionId, answer);
    }, [onAnswerChange]);

    // Handle question navigation within set
    const handleQuestionChange = useCallback((index: number) => {
        onQuestionChange?.(index);
    }, [onQuestionChange]);

    // Determine layout based on set_type
    const isComposite = isCompositeSet(questionSet.set_type);

    // P4.1: Edge-case layout rule - single question + text-only context = full-width
    // If set has only 1 question AND context has no media (no image_url, no additional_images),
    // default to full-width (SingleFocusLayout) instead of split-pane
    const hasContextMedia = Boolean(
        questionSet.context_image_url ||
        (questionSet.context_additional_images && questionSet.context_additional_images.length > 0)
    );
    const isSingleQuestionSet = questions.length === 1;
    const useFullWidthForEdgeCase = isComposite && isSingleQuestionSet && !hasContextMedia;

    // Render appropriate layout
    if (isComposite && !useFullWidthForEdgeCase) {
        return (
            <SplitPaneLayout
                questionSet={questionSet}
                activeQuestion={activeQuestion}
                activeQuestionIndex={safeIndex}
                totalQuestions={questions.length}
                onQuestionChange={handleQuestionChange}
                response={currentResponse}
                onAnswerChange={handleAnswerChange}
                isReviewMode={isReviewMode}
                readOnly={readOnly}
                showCorrectAnswer={showCorrectAnswer}
                responses={responses}
                correctAnswerMap={correctAnswerMap}
                solutionMap={solutionMap}
                showBookmarkToggle={showBookmarkToggle}
                isBookmarked={isBookmarked}
                onToggleBookmark={onToggleBookmark}
            />
        );
    }

    // Atomic / Single Focus Layout (including edge-case single-question text-only sets)
    // For edge-case: inline the context above the question
    return (
        <SingleFocusLayout
            questionSet={questionSet}
            activeQuestion={activeQuestion}
            response={currentResponse}
            onAnswerChange={handleAnswerChange}
            isReviewMode={isReviewMode}
            showInlineContext={useFullWidthForEdgeCase && Boolean(questionSet.context_body)}
            readOnly={readOnly}
            showCorrectAnswer={showCorrectAnswer}
            responses={responses}
            correctAnswerMap={correctAnswerMap}
            solutionMap={solutionMap}
            showBookmarkToggle={showBookmarkToggle}
            isBookmarked={isBookmarked}
            onToggleBookmark={onToggleBookmark}
        />
    );
}
````

## File: src/features/exam-engine/ui/ResultHeader.tsx
````typescript
/**
 * @fileoverview Result Header Component
 * @description Summary card displaying total score, accuracy, and key metrics
 * @blueprint Milestone 5 - Milestone_Change_Log.md - Change 002
 */

interface ResultHeaderProps {
    paperTitle: string;
    totalScore: number;
    maxScore: number;
    accuracy: number | null;
    attemptRate: number | null;
    correctCount: number;
    incorrectCount: number;
    unansweredCount: number;
    timeTakenSeconds: number | null;
    percentile: number | null;
    rank: number | null;
    submittedAt: string | null;
    reviewAnchorId?: string;
}

/**
 * Format seconds to human-readable time string
 */
function formatTime(seconds: number | null): string {
    if (!seconds) return '—';
    const hours = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;

    if (hours > 0) {
        return `${hours}h ${mins}m`;
    }
    return `${mins}m ${secs}s`;
}

export function ResultHeader({
    paperTitle,
    totalScore,
    maxScore,
    accuracy,
    attemptRate,
    correctCount,
    incorrectCount,
    unansweredCount,
    timeTakenSeconds,
    percentile,
    rank,
    submittedAt,
    reviewAnchorId,
}: ResultHeaderProps) {
    const scorePercentage = maxScore > 0 ? (totalScore / maxScore) * 100 : 0;
    const scoreColor = scorePercentage >= 70
        ? 'text-green-600'
        : scorePercentage >= 40
            ? 'text-yellow-600'
            : 'text-red-600';

    return (
        <div className="mb-8">
            {/* Title */}
            <div className="text-center mb-6">
                <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
                    {paperTitle}
                </h1>
                {submittedAt && (
                    <p className="text-gray-500 text-sm">
                        Submitted: {new Date(submittedAt).toLocaleString('en-IN', {
                            dateStyle: 'medium',
                            timeStyle: 'short',
                        })}
                    </p>
                )}
            </div>

            {reviewAnchorId && (
                <div className="mt-4 flex justify-center">
                    <a
                        href={`#${reviewAnchorId}`}
                        className="inline-flex items-center gap-2 rounded-full border border-blue-200 bg-blue-50 px-4 py-2 text-sm font-semibold text-blue-700 hover:bg-blue-100"
                    >
                        Review in Exam UI
                        <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                            <path strokeLinecap="round" strokeLinejoin="round" d="M5 12h14m-7-7l7 7-7 7" />
                        </svg>
                    </a>
                </div>
            )}

            {/* Main Score Card */}
            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 shadow-sm border border-blue-100">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    {/* Score */}
                    <div className="text-center p-4 bg-white/70 rounded-xl">
                        <p className="text-xs md:text-sm font-medium text-gray-500 uppercase tracking-wider mb-1">
                            Score
                        </p>
                        <p className={`text-2xl md:text-4xl font-bold ${scoreColor}`}>
                            {totalScore}
                        </p>
                        <p className="text-sm text-gray-400">
                            of {maxScore}
                        </p>
                    </div>

                    {/* Percentile */}
                    <div className="text-center p-4 bg-white/70 rounded-xl">
                        <p className="text-xs md:text-sm font-medium text-gray-500 uppercase tracking-wider mb-1">
                            Percentile
                        </p>
                        <p className="text-2xl md:text-4xl font-bold text-purple-600">
                            {percentile?.toFixed(1) ?? '—'}
                        </p>
                        {rank && (
                            <p className="text-sm text-gray-400">
                                Rank #{rank}
                            </p>
                        )}
                    </div>

                    {/* Accuracy */}
                    <div className="text-center p-4 bg-white/70 rounded-xl">
                        <p className="text-xs md:text-sm font-medium text-gray-500 uppercase tracking-wider mb-1">
                            Accuracy
                        </p>
                        <p className="text-2xl md:text-4xl font-bold text-orange-500">
                            {accuracy?.toFixed(1) ?? '—'}%
                        </p>
                        <p className="text-sm text-gray-400">
                            {correctCount}/{correctCount + incorrectCount} correct
                        </p>
                    </div>

                    {/* Time Taken */}
                    <div className="text-center p-4 bg-white/70 rounded-xl">
                        <p className="text-xs md:text-sm font-medium text-gray-500 uppercase tracking-wider mb-1">
                            Time Taken
                        </p>
                        <p className="text-2xl md:text-4xl font-bold text-teal-600">
                            {formatTime(timeTakenSeconds)}
                        </p>
                        <p className="text-sm text-gray-400">
                            of 120 min
                        </p>
                    </div>
                </div>
            </div>

            {/* Question Stats Bar */}
            <div className="mt-4 bg-white rounded-xl p-4 shadow-sm border flex flex-wrap justify-center gap-6">
                <div className="flex items-center gap-3">
                    <span className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-bold">
                        ✓
                    </span>
                    <div className="leading-tight">
                        <span className="block text-[10px] uppercase tracking-wide text-gray-400">Correct</span>
                        <span className="text-sm font-semibold text-green-600">{correctCount}</span>
                    </div>
                </div>
                <div className="flex items-center gap-3">
                    <span className="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold">
                        ✗
                    </span>
                    <div className="leading-tight">
                        <span className="block text-[10px] uppercase tracking-wide text-gray-400">Incorrect</span>
                        <span className="text-sm font-semibold text-red-600">{incorrectCount}</span>
                    </div>
                </div>
                <div className="flex items-center gap-3">
                    <span className="w-6 h-6 bg-gray-400 rounded-full flex items-center justify-center text-white text-xs font-bold">
                        –
                    </span>
                    <div className="leading-tight">
                        <span className="block text-[10px] uppercase tracking-wide text-gray-400">Skipped</span>
                        <span className="text-sm font-semibold text-gray-500">{unansweredCount}</span>
                    </div>
                </div>
                {attemptRate !== null && (
                    <div className="flex items-center gap-2 text-gray-600">
                        Attempt Rate: <strong>{attemptRate.toFixed(1)}%</strong>
                    </div>
                )}
            </div>
        </div>
    );
}
````

## File: src/features/exam-engine/ui/TITARenderer.tsx
````typescript
/**
 * @fileoverview TITA Question Renderer Component
 * @description Numeric input component for Type-In-The-Answer questions
 * @blueprint Milestone 4 SOP-SSOT - Phase 3.4
 * @note TITA questions have NO negative marking
 * 
 * PHASE 3 FIX: Fixed useEffect loop causing duplicate script execution
 */

'use client';

import { useCallback, useState, useEffect, useRef } from 'react';
import { useExamStore, selectResponse } from '@/features/exam-engine';
import { examDebug } from '@/lib/examDebug';
import type { Question } from '@/types/exam';

// =============================================================================
// TYPES
// =============================================================================

interface TITARendererProps {
    /** The question to render */
    question: Question;
    /** Optional CSS class name */
    className?: string;
    /** Read-only mode (for review) */
    readOnly?: boolean;
    /** Show correct answer (for results) */
    showCorrectAnswer?: boolean;
    /** Correct answer (only available in results) */
    correctAnswer?: string;
    /** Optional answer override for review mode */
    answerOverride?: string | null;
}

// =============================================================================
// MAIN COMPONENT
// =============================================================================

export function TITARenderer({
    question,
    className = '',
    readOnly = false,
    showCorrectAnswer = false,
    correctAnswer,
    answerOverride = null,
}: TITARendererProps) {
    const response = useExamStore(selectResponse(question.id));
    // FIX: Use setLocalAnswer to store answer locally without changing status
    // Status only changes when user clicks "Save and Next"
    const setLocalAnswer = useExamStore((s) => s.setLocalAnswer);

    // Local state for input (debounced save)
    const [localValue, setLocalValue] = useState(answerOverride ?? response?.answer ?? '');
    const [cursorIndex, setCursorIndex] = useState(() => (answerOverride ?? response?.answer ?? '').length);
    const inputRef = useRef<HTMLInputElement | null>(null);

    // PHASE 3 FIX: Track if we're updating from store to prevent loops
    const isUpdatingFromStore = useRef(false);

    // PHASE 3 FIX: Sync local state with store on mount and when response changes externally
    // Only update if the value is different AND we're not in the middle of a local update
    useEffect(() => {
        const storeValue = response?.answer ?? '';
        const nextValue = answerOverride ?? storeValue;
        if (nextValue !== localValue && !isUpdatingFromStore.current) {
            isUpdatingFromStore.current = true;
            setLocalValue(nextValue);
            // Reset flag after state update
            requestAnimationFrame(() => {
                setCursorIndex(nextValue.length);
                isUpdatingFromStore.current = false;
            });
        }
    }, [response?.answer, answerOverride, localValue]);

    // Determine if answer is correct (for results view)
    const isCorrect = showCorrectAnswer && localValue === correctAnswer;
    const isIncorrect = showCorrectAnswer && localValue && localValue !== correctAnswer;

    // Commit value to local state + store (local only, no status change)
    const commitValue = useCallback((value: string, nextCursorIndex?: number) => {
        const oldValue = localValue;
        setLocalValue(value);
        const clampedCursor = Math.max(0, Math.min(value.length, nextCursorIndex ?? value.length));
        setCursorIndex(clampedCursor);
        if (!readOnly) {
            // Use setLocalAnswer - does NOT change status, palette stays same color
            setLocalAnswer(question.id, value || null);

            // PHASE 3: Debug logging for TITA input
            examDebug.titaInput({
                questionId: question.id,
                key: 'commit',
                oldValue,
                newValue: value,
            });
        }
    }, [question.id, readOnly, setLocalAnswer, localValue]);

    // Block physical keyboard input (TITA keypad-only)
    const blockPhysicalInput = useCallback((e: React.SyntheticEvent) => {
        e.preventDefault();
    }, []);

    // Apply keypad input with numeric validity rules
    const applyKeypadInput = useCallback((key: string) => {
        if (readOnly) return;

        const current = localValue;

        // PHASE 3: Debug logging for keypad input
        examDebug.titaInput({
            questionId: question.id,
            key,
            oldValue: current,
            newValue: '(pending)',
        });

        if (key === 'BACKSPACE') {
            if (cursorIndex <= 0) return;
            const nextValue = `${current.slice(0, cursorIndex - 1)}${current.slice(cursorIndex)}`;
            commitValue(nextValue, cursorIndex - 1);
            return;
        }

        if (key === 'CLEAR') {
            commitValue('', 0);
            return;
        }

        if (key === '-') {
            if (current.startsWith('-') || current.length > 0 || cursorIndex !== 0) return;
            commitValue('-', 1);
            return;
        }

        if (key === '.') {
            if (current.includes('.')) return;
            if (current === '') {
                commitValue('0.', 2);
            } else if (current === '-') {
                commitValue('-0.', 3);
            } else {
                const nextValue = `${current.slice(0, cursorIndex)}.${current.slice(cursorIndex)}`;
                commitValue(nextValue, cursorIndex + 1);
            }
            return;
        }

        if (/^[0-9]$/.test(key)) {
            const nextValue = `${current.slice(0, cursorIndex)}${key}${current.slice(cursorIndex)}`;
            commitValue(nextValue, cursorIndex + 1);
        }
    }, [commitValue, localValue, readOnly, cursorIndex]);

    const moveCursor = useCallback((direction: 'left' | 'right') => {
        if (readOnly) return;
        setCursorIndex((prev) => {
            const delta = direction === 'left' ? -1 : 1;
            return Math.max(0, Math.min(localValue.length, prev + delta));
        });
    }, [localValue.length, readOnly]);

    useEffect(() => {
        if (!inputRef.current) return;
        try {
            inputRef.current.setSelectionRange(cursorIndex, cursorIndex);
        } catch {
            // ignore selection errors in unsupported environments
        }
    }, [cursorIndex, localValue]);

    // Get input styles based on state
    let inputStyles = 'border-gray-300 focus:border-blue-500 focus:ring-blue-500';
    if (isCorrect) {
        inputStyles = 'border-green-500 bg-green-50 focus:border-green-500 focus:ring-green-500';
    } else if (isIncorrect) {
        inputStyles = 'border-red-500 bg-red-50 focus:border-red-500 focus:ring-red-500';
    }

    return (
        <div className={`space-y-6 ${className}`}>
            {/* Answer Input */}
            <div className="space-y-2">
                <label
                    htmlFor={`tita-${question.id}`}
                    className="block text-sm font-medium text-gray-700"
                >
                    Your Answer
                </label>

                <div className="relative max-w-xs">
                    <input
                        type="text"
                        id={`tita-${question.id}`}
                        ref={inputRef}
                        value={localValue}
                        readOnly
                        placeholder="Enter your answer"
                        className={`
                            w-full px-4 py-3 text-lg font-mono rounded-lg border-2
                            transition-colors
                            ${inputStyles}
                            ${readOnly ? 'bg-gray-100 cursor-not-allowed' : 'bg-white'}
                        `}
                        inputMode="decimal"
                        autoComplete="off"
                        aria-readonly={true}
                        aria-describedby={`tita-help-${question.id}`}
                        onKeyDown={blockPhysicalInput}
                        onKeyPress={blockPhysicalInput}
                        onBeforeInput={blockPhysicalInput}
                        onPaste={blockPhysicalInput}
                        onDrop={blockPhysicalInput}
                    />

                    {/* Correct/Incorrect Icon */}
                    {showCorrectAnswer && localValue && (
                        <span className="absolute right-3 top-1/2 -translate-y-1/2">
                            {isCorrect ? (
                                <svg className="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        fillRule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clipRule="evenodd"
                                    />
                                </svg>
                            ) : (
                                <svg className="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        fillRule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clipRule="evenodd"
                                    />
                                </svg>
                            )}
                        </span>
                    )}
                </div>

                {/* Help Text */}
                <p id={`tita-help-${question.id}`} className="text-sm text-gray-500">
                    Use the keypad below. Decimals are allowed if needed.
                </p>
            </div>

            {/* TITA Keypad (keypad-only input) */}
            <div
                className="w-[220px] rounded-md bg-[#f2f2f2] p-[5px]"
                role="group"
                aria-label="TITA keypad"
                style={{ fontFamily: 'Arial, Helvetica, sans-serif' }}
            >
                <button
                    type="button"
                    disabled={readOnly}
                    onClick={() => applyKeypadInput('BACKSPACE')}
                    className="h-10 w-full rounded border border-[#bdbdbd] bg-gradient-to-b from-white to-[#eaeaea] text-sm font-bold font-sans text-gray-800 hover:bg-white disabled:cursor-not-allowed disabled:opacity-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#2D89EF]"
                    aria-label="Backspace"
                >
                    Backspace
                </button>

                <div className="mt-[5px] grid grid-cols-3 gap-[5px]">
                    {[
                        '7', '8', '9',
                        '4', '5', '6',
                        '1', '2', '3',
                        '0', '.', '-',
                    ].map((digit) => (
                        <button
                            key={digit}
                            type="button"
                            disabled={readOnly}
                            onClick={() => applyKeypadInput(digit)}
                            className="aspect-square w-full rounded border border-[#bdbdbd] bg-gradient-to-b from-white to-[#eaeaea] text-base font-bold font-sans text-gray-800 hover:bg-white disabled:cursor-not-allowed disabled:opacity-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#2D89EF]"
                            aria-label={digit === '.' ? 'Decimal point' : digit === '-' ? 'Minus sign' : `Digit ${digit}`}
                        >
                            {digit}
                        </button>
                    ))}
                </div>

                <div className="mt-[5px] grid grid-cols-2 gap-[5px]">
                    <button
                        type="button"
                        disabled={readOnly}
                        onClick={() => moveCursor('left')}
                        className="h-10 rounded border border-[#bdbdbd] bg-gradient-to-b from-white to-[#eaeaea] text-base font-bold font-sans text-gray-800 hover:bg-white disabled:cursor-not-allowed disabled:opacity-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#2D89EF]"
                        aria-label="Move cursor left"
                    >
                        &larr;
                    </button>
                    <button
                        type="button"
                        disabled={readOnly}
                        onClick={() => moveCursor('right')}
                        className="h-10 rounded border border-[#bdbdbd] bg-gradient-to-b from-white to-[#eaeaea] text-base font-bold font-sans text-gray-800 hover:bg-white disabled:cursor-not-allowed disabled:opacity-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#2D89EF]"
                        aria-label="Move cursor right"
                    >
                        &rarr;
                    </button>
                </div>

                <button
                    type="button"
                    disabled={readOnly}
                    onClick={() => applyKeypadInput('CLEAR')}
                    className="mt-[5px] h-10 w-full rounded border border-[#bdbdbd] bg-gradient-to-b from-white to-[#eaeaea] text-sm font-bold font-sans text-gray-800 hover:bg-white disabled:cursor-not-allowed disabled:opacity-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#2D89EF]"
                    aria-label="Clear all"
                >
                    Clear All
                </button>
            </div>

            {/* Show correct answer in results */}
            {showCorrectAnswer && correctAnswer && (
                <div className={`p-4 rounded-lg ${isCorrect ? 'bg-green-50' : 'bg-yellow-50'}`}>
                    <span className="text-sm font-medium text-gray-600">Correct Answer: </span>
                    <span className="text-lg font-mono font-bold text-gray-800">{correctAnswer}</span>
                </div>
            )}

            {/* Marking Info */}
            <div className="flex items-center gap-4 text-sm text-gray-500 pt-2">
                <span>+{question.positive_marks} for correct</span>
                <span className="text-green-600 font-medium">No negative marking</span>
            </div>
        </div>
    );
}
````

## File: src/lib/supabase/client.ts
````typescript
// Supabase browser client helper using @supabase/ssr
import type { SupabaseClient } from '@supabase/supabase-js';
import type { GenericSchema } from '@supabase/supabase-js/dist/module/lib/types';
import { createBrowserClient } from '@supabase/ssr';

export type AppDatabase = { public: GenericSchema };
export type BrowserSupabaseClient = SupabaseClient<AppDatabase, 'public', 'public', GenericSchema, { PostgrestVersion: '12' }>;

let cachedClient: BrowserSupabaseClient | null = null;
let warnedMissingEnv = false;

function safeFetch(input: RequestInfo | URL, init?: RequestInit) {
    return fetch(input, init).catch((error) => {
        if (process.env.NODE_ENV !== 'production') {
            console.warn('[supabase] fetch failed', error);
        }
        const body = JSON.stringify({ message: 'Network error' });
        return new Response(body, {
            status: 503,
            headers: { 'Content-Type': 'application/json' },
        });
    });
}

export function sb(): BrowserSupabaseClient {
    if (cachedClient) {
        return cachedClient;
    }

    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string | undefined;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as
        | string
        | undefined;
    const configured = Boolean(url && anon);

    if (!configured && !warnedMissingEnv) {
        console.warn(
            'Supabase env vars missing. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY (or NEXT_PUBLIC_SUPABASE_ANON_KEY).'
        );
        warnedMissingEnv = true;
    }

    cachedClient = createBrowserClient(url || 'http://localhost:54321', anon || 'anon', {
        global: { fetch: safeFetch },
        auth: {
            autoRefreshToken: configured,
            persistSession: configured,
            detectSessionInUrl: configured,
        },
    }) as unknown as BrowserSupabaseClient;

    return cachedClient;
}
````

## File: src/app/admin/layout.tsx
````typescript
/**
 * @fileoverview Admin Layout
 * @description Layout wrapper for admin pages with navigation
 * @blueprint M6+ - Hybrid RBAC enforcement via JWT claims
 */

import { redirect } from 'next/navigation';
import { sbSSR } from '@/lib/supabase/server';
import Link from 'next/link';
import { jwtDecode } from 'jwt-decode';

interface JWTClaims {
    user_role?: string;
    app_metadata?: {
        user_role?: string;
    };
}

export default async function AdminLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    const supabase = await sbSSR();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
        redirect('/auth/sign-in');
    }

    // DEV MODE: Skip RBAC check only in non-production environments
    const skipAdminCheck = process.env.SKIP_ADMIN_CHECK === 'true' && process.env.NODE_ENV !== 'production';

    let isAdmin = skipAdminCheck; // Default to true if skip is enabled

    if (!skipAdminCheck) {
        // M6+ RBAC: Check JWT claims for admin role
        const { data: { session } } = await supabase.auth.getSession();
        let role: string | null = session?.user?.app_metadata?.user_role ?? null;

        if (!role && session?.access_token) {
            try {
                const decoded = jwtDecode<JWTClaims>(session.access_token);
                role = decoded?.user_role ?? decoded?.app_metadata?.user_role ?? null;
            } catch {
                // JWT decode failed - no role
                role = null;
            }
        }

        isAdmin = role === 'admin' || role === 'dev';

        // Fallback: Check database function if claims not available
        if (!isAdmin) {
            const { data: isAdminRpc } = await supabase.rpc('is_admin');
            isAdmin = Boolean(isAdminRpc);
        }
    }

    if (!isAdmin) {
        redirect('/dashboard?error=unauthorized');
    }

    return (
        <div className="min-h-screen bg-gray-100">
            {/* Admin Header */}
            <header className="bg-[#0b3d91] text-white shadow-md">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex items-center justify-between h-16">
                        <div className="flex items-center gap-8">
                            {/* Back to Dashboard */}
                            <Link
                                href="/dashboard"
                                className="p-2 hover:bg-white/10 rounded-lg transition-colors"
                                title="Back to Dashboard"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                            </Link>
                            <Link href="/admin" className="font-bold text-xl">
                                CAT Mocks Admin
                            </Link>
                            <nav className="flex gap-6">
                                <Link
                                    href="/admin/papers"
                                    className="text-gray-200 hover:text-white transition-colors"
                                >
                                    Papers
                                </Link>
                                <Link
                                    href="/admin/landing-page"
                                    className="text-gray-200 hover:text-white transition-colors"
                                >
                                    Landing Page
                                </Link>
                                <Link
                                    href="/admin/question-sets"
                                    className="text-gray-200 hover:text-white transition-colors"
                                >
                                    Question Sets
                                </Link>
                                <Link
                                    href="/admin/questions"
                                    className="text-gray-200 hover:text-white transition-colors"
                                >
                                    Questions
                                </Link>
                                <Link
                                    href="/admin/bug-reports"
                                    className="text-gray-200 hover:text-white transition-colors"
                                >
                                    Bug Reports
                                </Link>
                                <Link
                                    href="/admin/access-control"
                                    className="text-gray-200 hover:text-white transition-colors"
                                >
                                    Access Control
                                </Link>
                                <Link
                                    href="/admin/ai-analysis"
                                    className="text-gray-200 hover:text-white transition-colors"
                                >
                                    AI Analysis
                                </Link>
                            </nav>
                        </div>
                        <div className="flex items-center gap-4">
                            <span className="text-xs bg-green-500 px-2 py-0.5 rounded">Admin</span>
                            <span className="text-sm text-gray-300">{user.email}</span>
                            <Link
                                href="/dashboard"
                                className="text-sm bg-yellow-500 text-gray-900 px-3 py-1.5 rounded hover:bg-yellow-400 transition-colors"
                            >
                                Back to Dashboard
                            </Link>
                        </div>
                    </div>
                </div>
            </header>

            {/* Main Content */}
            <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {children}
            </main>
        </div>
    );
}
````

## File: src/app/mocks/page.tsx
````typescript
import Link from 'next/link';
import { sbSSR } from '@/lib/supabase/server';

type Paper = {
    id: string;
    slug: string | null;
    title: string;
    description: string | null;
    year: number;
    total_questions: number;
    total_marks: number;
    duration_minutes: number | null;
    difficulty_level: string | null;
    is_free: boolean;
    available_from?: string | null;
    available_until?: string | null;
};

export default async function MocksPage() {
    const supabase = await sbSSR();
    const {
        data: { user },
    } = await supabase.auth.getUser();

    // Fetch published papers. Availability window is filtered in code for reliability.
    const { data, error } = await supabase
        .from('papers')
        .select('id, slug, title, description, year, total_questions, total_marks, duration_minutes, difficulty_level, is_free, available_from, available_until')
        .eq('published', true)
        .order('year', { ascending: false })
        .order('created_at', { ascending: false });

    const inProgressAttemptsByPaper = new Map<string, { id: string }>();
    if (user) {
        const { data: inProgressAttempts } = await supabase
            .from('attempts')
            .select('id, paper_id, created_at, status, time_remaining')
            .eq('user_id', user.id)
            .in('status', ['in_progress', 'paused'])
            .order('created_at', { ascending: false });

        const hasRemainingTime = (timeRemaining: unknown) => {
            if (!timeRemaining || typeof timeRemaining !== 'object') return false;
            return Object.values(timeRemaining as Record<string, unknown>).some((value) => {
                const num =
                    typeof value === 'number'
                        ? value
                        : typeof value === 'string'
                            ? Number(value)
                            : NaN;
                return Number.isFinite(num) && num > 0;
            });
        };

        (inProgressAttempts ?? []).forEach((attempt) => {
            if (!hasRemainingTime(attempt.time_remaining)) return;
            if (!inProgressAttemptsByPaper.has(attempt.paper_id)) {
                inProgressAttemptsByPaper.set(attempt.paper_id, { id: attempt.id });
            }
        });
    }

    const now = Date.now();
    const papers: Paper[] = (data ?? []).filter((p: Paper) => {
        const fromOk = !p.available_from || Date.parse(p.available_from) <= now;
        const untilOk = !p.available_until || Date.parse(p.available_until) >= now;
        return (fromOk && untilOk) || inProgressAttemptsByPaper.has(p.id);
    });

    // Group papers by year
    const papersByYear = papers.reduce((acc, paper) => {
        const year = paper.year;
        if (!acc[year]) acc[year] = [];
        acc[year].push(paper);
        return acc;
    }, {} as Record<number, Paper[]>);

    const getDifficultyColor = (level: string | null) => {
        switch (level) {
            case 'easy': return '#4caf50';
            case 'medium': return '#ff9800';
            case 'hard': return '#f44336';
            case 'cat-level': return '#9c27b0';
            default: return '#666';
        }
    };

    return (
        <main style={{ padding: 24, maxWidth: 1000, margin: '0 auto' }}>
            <h1 style={{ marginBottom: 8 }}>CAT Mock Tests</h1>
            <p style={{ color: '#666', marginBottom: 32 }}>
                Practice with full-length CAT mock tests designed to simulate the actual exam experience.
            </p>

            {error ? (
                <p style={{ color: 'crimson' }}>Failed to load papers. Please try again later.</p>
            ) : papers.length === 0 ? (
                <div style={{ textAlign: 'center', padding: 48, background: '#f5f5f5', borderRadius: 12 }}>
                    <h2>No Mock Tests Available</h2>
                    <p style={{ color: '#666' }}>Check back soon for new mock tests!</p>
                </div>
            ) : (
                Object.entries(papersByYear)
                    .sort(([a], [b]) => Number(b) - Number(a))
                    .map(([year, yearPapers]) => (
                        <div key={year} style={{ marginBottom: 32 }}>
                            <h2 style={{ borderBottom: '2px solid #1976d2', paddingBottom: 8, marginBottom: 16 }}>
                                CAT {year} Pattern
                            </h2>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: 16 }}>
                                {yearPapers.map((p) => {
                                    const inProgressAttempt = inProgressAttemptsByPaper.get(p.id);
                                    const href = inProgressAttempt ? `/exam/${inProgressAttempt.id}` : `/mock/${p.slug || p.id}`;
                                    const ctaLabel = inProgressAttempt ? 'Continue Mock' : 'Start Mock';
                                    return (
                                        <div key={p.id} style={{
                                            border: '1px solid #ddd',
                                            borderRadius: 12,
                                            padding: 20,
                                            background: '#fff',
                                            boxShadow: '0 2px 4px rgba(0,0,0,0.05)',
                                            transition: 'box-shadow 0.2s',
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12 }}>
                                                <h3 style={{ margin: 0, fontSize: 18 }}>{p.title}</h3>
                                                <div style={{ display: 'flex', gap: 6 }}>
                                                    {p.is_free && (
                                                        <span style={{
                                                            padding: '2px 8px',
                                                            background: '#4caf50',
                                                            color: 'white',
                                                            borderRadius: 4,
                                                            fontSize: 11,
                                                            fontWeight: 'bold'
                                                        }}>FREE</span>
                                                    )}
                                                    {p.difficulty_level && (
                                                        <span style={{
                                                            padding: '2px 8px',
                                                            background: getDifficultyColor(p.difficulty_level),
                                                            color: 'white',
                                                            borderRadius: 4,
                                                            fontSize: 11,
                                                            fontWeight: 'bold'
                                                        }}>{p.difficulty_level.toUpperCase()}</span>
                                                    )}
                                                </div>
                                            </div>

                                            {p.description && (
                                                <p style={{ margin: '0 0 12px', color: '#666', fontSize: 14, lineHeight: 1.4 }}>
                                                    {p.description.length > 100 ? p.description.substring(0, 100) + '...' : p.description}
                                                </p>
                                            )}

                                            <div style={{
                                                display: 'flex',
                                                gap: 16,
                                                fontSize: 13,
                                                color: '#666',
                                                marginBottom: 16,
                                                paddingTop: 12,
                                                borderTop: '1px solid #eee'
                                            }}>
                                                <span>📝 {p.total_questions} Qs</span>
                                                <span>🎯 {p.total_marks} marks</span>
                                                <span>⏱️ {p.duration_minutes} min</span>
                                            </div>

                                            <Link href={href} style={{
                                                display: 'block',
                                                textAlign: 'center',
                                                padding: '10px 16px',
                                                background: '#1976d2',
                                                color: 'white',
                                                textDecoration: 'none',
                                                borderRadius: 6,
                                                fontWeight: 'bold',
                                                fontSize: 14
                                            }}>
                                                {ctaLabel}
                                            </Link>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))
            )}
        </main>
    );
}
````

## File: src/features/exam-engine/hooks/useExamTimer.ts
````typescript
/**
 * @fileoverview High-Precision Exam Timer Hook
 * @description Delta-time computation timer for CAT exam sections
 * @blueprint Milestone 4 SOP-SSOT - Phase 2.1 & 2.2
 * @deviation Uses delta-time (Date.now() - startedAt) instead of setInterval decrement
 * @rationale Survives tab sleep, browser throttling, and provides accurate time even after resume
 */

import { useEffect, useRef, useCallback } from 'react';
import { useExamStore, selectCurrentSection, selectCurrentTimer } from '../index';
import type { SectionName, SectionTimerState } from '@/types/exam';

// =============================================================================
// TYPES
// =============================================================================

export interface UseExamTimerOptions {
    onSectionExpire?: (sectionName: SectionName) => void | Promise<void>;
    onExamComplete?: () => void | Promise<void>;
    intervalMs?: number;
    warningThresholdSeconds?: number;
    criticalThresholdSeconds?: number;
}

export interface TimerDisplayData {
    minutes: number;
    seconds: number;
    totalSeconds: number;
    /** Formatted time string "HH:MM:SS" */
    displayTime: string;
    state: 'normal' | 'warning' | 'critical' | 'expired';
    sectionName: SectionName;
    isExpired: boolean;
    progressPercent: number;
}

// =============================================================================
// DELTA-TIME CALCULATION
// =============================================================================

function calculateRemainingSeconds(timer: SectionTimerState): number {
    if (timer.isExpired) return 0;
    if (timer.startedAt === 0) return timer.durationSeconds;

    // Guard against clock skew (e.g., system time changes)
    const elapsedSeconds = Math.max(0, Math.floor((Date.now() - timer.startedAt) / 1000));
    return Math.max(0, timer.durationSeconds - elapsedSeconds);
}

/** Format seconds to "HH:MM:SS" */
function formatTime(totalSeconds: number): string {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds
        .toString()
        .padStart(2, '0')}`;
}

function getTimerState(
    remainingSeconds: number,
    isExpired: boolean,
    warningThreshold: number,
    criticalThreshold: number
): 'normal' | 'warning' | 'critical' | 'expired' {
    if (isExpired || remainingSeconds <= 0) return 'expired';
    if (remainingSeconds <= criticalThreshold) return 'critical';
    if (remainingSeconds <= warningThreshold) return 'warning';
    return 'normal';
}

// =============================================================================
// MAIN HOOK
// =============================================================================

export function useExamTimer(options: UseExamTimerOptions = {}) {
    const {
        onSectionExpire,
        onExamComplete,
        intervalMs = 1000,
        warningThresholdSeconds = 300,
        criticalThresholdSeconds = 60,
    } = options;

    const currentSection = useExamStore(selectCurrentSection);
    const currentTimer = useExamStore(selectCurrentTimer);
    const isInitialized = useExamStore((s) => s.isInitialized);
    const isSubmitting = useExamStore((s) => s.isSubmitting);
    const isAutoSubmitting = useExamStore((s) => s.isAutoSubmitting);

    const updateSectionTimer = useExamStore((s) => s.updateSectionTimer);
    const expireSection = useExamStore((s) => s.expireSection);
    const moveToNextSection = useExamStore((s) => s.moveToNextSection);
    const setAutoSubmitting = useExamStore((s) => s.setAutoSubmitting);

    const onSectionExpireRef = useRef(onSectionExpire);
    const onExamCompleteRef = useRef(onExamComplete);
    const currentSectionRef = useRef(currentSection);

    const intervalRef = useRef<ReturnType<typeof setInterval> | null>(null);
    const isActiveRef = useRef(false);

    // Manual pause should survive re-renders/effects
    const isManuallyPausedRef = useRef(false);

    // Prevent double-trigger of expiry (interval ticks + visibility effect + delayed ticks)
    const expiryInProgressRef = useRef(false);

    // CRITICAL: Track sections that have COMPLETED expiry processing
    // Once a section is in this set, it should NEVER be processed again
    // This prevents the loop caused by refs resetting in finally blocks
    const expiredSectionsProcessedRef = useRef<Set<SectionName>>(new Set());

    useEffect(() => {
        onSectionExpireRef.current = onSectionExpire;
        onExamCompleteRef.current = onExamComplete;
    }, [onSectionExpire, onExamComplete]);

    // Keep currentSectionRef in sync to avoid stale closures in tick
    useEffect(() => {
        currentSectionRef.current = currentSection;
    }, [currentSection]);

    const stopTimer = useCallback(() => {
        if (intervalRef.current) {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
        }
        isActiveRef.current = false;
    }, []);

    const handleSectionExpiry = useCallback(
        async (sectionName: SectionName) => {
            // CRITICAL: Check if this section was ALREADY processed - permanent gate
            if (expiredSectionsProcessedRef.current.has(sectionName)) {
                console.log('[useExamTimer] Section already processed, skipping', { sectionName });
                return;
            }

            // Atomic check-and-set to prevent race conditions
            // Check both local ref AND store state before proceeding
            const storeState = useExamStore.getState();
            if (expiryInProgressRef.current) {
                console.log('[useExamTimer] Section expiry blocked: already in progress', { sectionName });
                return;
            }
            if (storeState.isAutoSubmitting || storeState.isSubmitting) {
                console.log('[useExamTimer] Section expiry blocked: submit in progress', { sectionName });
                return;
            }

            // Set flag immediately to block any concurrent calls
            expiryInProgressRef.current = true;
            // CRITICAL: Mark section as processed IMMEDIATELY (before any async work)
            // This is the permanent gate that prevents re-processing
            expiredSectionsProcessedRef.current.add(sectionName);

            // Stop ticks immediately (don’t wait for state re-render)
            stopTimer();

            // CRITICAL: Mark section as expired FIRST (before setAutoSubmitting)
            // This ensures tick() won't re-trigger even if state updates are delayed
            expireSection(sectionName);

            setAutoSubmitting(true);
            try {
                console.log('[useExamTimer] Section expiry processing', { sectionName });

                // Persist section responses / server-side save (if provided)
                await onSectionExpireRef.current?.(sectionName);

                // Determine completion based on sectionName (most reliable)
                if (sectionName === 'QA') {
                    console.log('[useExamTimer] QA expired - calling onExamComplete');
                    await onExamCompleteRef.current?.();
                    console.log('[useExamTimer] onExamComplete returned');
                } else {
                    moveToNextSection();
                }
            } finally {
                console.log('[useExamTimer] Section expiry cleanup - setting isAutoSubmitting=false');
                setAutoSubmitting(false);
                // CRITICAL: Only reset expiryInProgressRef, NOT expiredSectionsProcessedRef
                // The section remains in expiredSectionsProcessedRef FOREVER to prevent re-processing
                expiryInProgressRef.current = false;

                // If not submitting and not manually paused, resume ticking for the next section
                const st = useExamStore.getState();
                if (!isManuallyPausedRef.current && st.isInitialized && !st.isSubmitting && !st.isAutoSubmitting) {
                    // start will happen via effect too, but doing nothing here keeps it simple
                }
            }
        },
        [expireSection, moveToNextSection, setAutoSubmitting, stopTimer]
    );

    const tick = useCallback(() => {
        const st = useExamStore.getState();
        if (!st.isInitialized || st.isSubmitting || st.isAutoSubmitting) return;
        if (isManuallyPausedRef.current) return;
        if (expiryInProgressRef.current) return;

        // Use ref to get current section (avoids stale closure)
        const section = currentSectionRef.current;

        // CRITICAL: Skip if this section was already processed
        if (expiredSectionsProcessedRef.current.has(section)) return;

        const timer = st.sectionTimers[section];
        if (!timer) return;

        // If not started or already expired, nothing to do
        if (timer.startedAt === 0 || timer.isExpired) return;

        const remaining = calculateRemainingSeconds(timer);

        // Avoid redundant state updates if store already has this remainingSeconds
        const currentRemainingSeconds =
            (timer as unknown as { remainingSeconds?: number }).remainingSeconds ??
            (timer as unknown as { remaining_seconds?: number }).remaining_seconds;

        if (typeof currentRemainingSeconds !== 'number' || currentRemainingSeconds !== remaining) {
            updateSectionTimer(section, remaining);
        }

        if (remaining <= 0 && !timer.isExpired) {
            void handleSectionExpiry(section);
        }
    }, [updateSectionTimer, handleSectionExpiry]);

    const startTimer = useCallback(() => {
        stopTimer();

        if (intervalMs <= 0) {
            // Fallback: no interval, but still do one sync tick.
            isActiveRef.current = true;
            tick();
            return;
        }

        isActiveRef.current = true;
        intervalRef.current = setInterval(tick, intervalMs);
        tick();
    }, [intervalMs, stopTimer, tick]);

    const pause = useCallback(() => {
        isManuallyPausedRef.current = true;
        stopTimer();
    }, [stopTimer]);

    const resume = useCallback(() => {
        isManuallyPausedRef.current = false;
        const st = useExamStore.getState();
        if (st.isInitialized && !st.isSubmitting && !st.isAutoSubmitting) {
            startTimer();
        }
    }, [startTimer]);

    // Start/stop lifecycle
    useEffect(() => {
        const st = useExamStore.getState();
        const shouldRun = st.isInitialized && !st.isSubmitting && !st.isAutoSubmitting && !isManuallyPausedRef.current;

        if (shouldRun) startTimer();
        else stopTimer();

        return () => stopTimer();
    }, [isInitialized, isSubmitting, isAutoSubmitting, startTimer, stopTimer]);

    // Ensure expiry is handled even if interval ticks are delayed (tab sleep / throttling)
    useEffect(() => {
        if (!isInitialized || isSubmitting || isAutoSubmitting) return;
        if (isManuallyPausedRef.current) return;
        if (expiryInProgressRef.current) return;
        // CRITICAL: Skip if this section was already processed
        if (expiredSectionsProcessedRef.current.has(currentSection)) return;

        // CRITICAL FIX: If timer is already marked expired from initialization, don't trigger expiry
        // This prevents auto-submit when opening an already-expired exam
        if (currentTimer.isExpired) return;
        if (currentTimer.startedAt === 0) return;

        const remaining = calculateRemainingSeconds(currentTimer);
        if (remaining <= 0) {
            void handleSectionExpiry(currentSection);
        }
    }, [currentSection, currentTimer, handleSectionExpiry, isInitialized, isSubmitting, isAutoSubmitting]);

    // Recovery: if the current timer transitions to expired DURING the exam (not from init), force expiry handling.
    // CRITICAL FIX: Added a ref to track if we saw the timer as non-expired first
    const sawTimerRunningRef = useRef<Set<SectionName>>(new Set());

    useEffect(() => {
        // Track if we've seen this timer running (not expired)
        if (!currentTimer.isExpired && currentTimer.startedAt > 0) {
            sawTimerRunningRef.current.add(currentSection);
        }
    }, [currentSection, currentTimer.isExpired, currentTimer.startedAt]);

    useEffect(() => {
        if (!isInitialized || isSubmitting || isAutoSubmitting) return;
        if (isManuallyPausedRef.current) return;
        if (expiryInProgressRef.current) return;
        // CRITICAL: Skip if this section was already processed
        if (expiredSectionsProcessedRef.current.has(currentSection)) return;
        if (!currentTimer.isExpired) return;

        // CRITICAL FIX: Only trigger expiry if we SAW the timer running
        // This prevents auto-submit when opening an already-expired exam
        if (!sawTimerRunningRef.current.has(currentSection)) {
            console.log('[useExamTimer] Skipping expiry - timer was never seen running', { currentSection });
            return;
        }

        void handleSectionExpiry(currentSection);
    }, [currentSection, currentTimer.isExpired, handleSectionExpiry, isInitialized, isSubmitting, isAutoSubmitting]);

    // Sync on tab focus
    useEffect(() => {
        const handleVisibilityChange = () => {
            if (!document.hidden) tick();
        };

        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
    }, [tick]);

    const timerData: TimerDisplayData = (() => {
        const remaining = calculateRemainingSeconds(currentTimer);
        const state = getTimerState(remaining, currentTimer.isExpired, warningThresholdSeconds, criticalThresholdSeconds);

        const progressPercent =
            currentTimer.durationSeconds > 0 ? (remaining / currentTimer.durationSeconds) * 100 : 0;

        return {
            minutes: Math.floor(remaining / 60),
            seconds: remaining % 60,
            totalSeconds: remaining,
            displayTime: formatTime(remaining),
            state,
            sectionName: currentSection,
            isExpired: currentTimer.isExpired || remaining <= 0,
            progressPercent: Math.max(0, Math.min(100, progressPercent)),
        };
    })();

    return {
        timerData,
        isActive: isActiveRef.current,
        isAutoSubmitting,
        pause,
        resume,
        sync: tick,
    };
}

// =============================================================================
// UTILITY HOOKS
// =============================================================================

export function useSectionTimer(sectionName: SectionName) {
    const timer = useExamStore((s) => s.sectionTimers[sectionName]);
    const remaining = calculateRemainingSeconds(timer);

    return {
        remaining,
        displayTime: formatTime(remaining),
        isExpired: timer.isExpired || remaining <= 0,
        isStarted: timer.startedAt > 0,
        progressPercent: timer.durationSeconds > 0 ? (remaining / timer.durationSeconds) * 100 : 0,
    };
}

export function useAllSectionTimers() {
    const timers = useExamStore((s) => s.sectionTimers);

    return {
        VARC: { remaining: calculateRemainingSeconds(timers.VARC), isExpired: timers.VARC.isExpired },
        DILR: { remaining: calculateRemainingSeconds(timers.DILR), isExpired: timers.DILR.isExpired },
        QA: { remaining: calculateRemainingSeconds(timers.QA), isExpired: timers.QA.isExpired },
        totalRemaining:
            calculateRemainingSeconds(timers.VARC) +
            calculateRemainingSeconds(timers.DILR) +
            calculateRemainingSeconds(timers.QA),
    };
}

export { calculateRemainingSeconds, formatTime, getTimerState };
````

## File: src/features/exam-engine/ui/QuestionAnalysis.tsx
````typescript
/**
 * @fileoverview Question Analysis Component
 * @description Detailed question-by-question review with Masked Review Mode and Peer Stats
 * @blueprint Milestone 5 - Milestone_Change_Log.md - Change 002
 */

'use client';

import { useCallback, useEffect, useMemo, useState } from 'react';
import { type SectionName, type QuestionType, type PerformanceReason } from '@/types/exam';
import { getAnalysisStore } from '@/features/exam-engine/model/useExamStore';
import { compareAnswers } from '@/features/exam-engine/lib/scoring';
import { MathText } from './MathText';

interface QuestionData {
    id: string;
    section: SectionName;
    question_number: number;
    question_text: string;
    question_type: QuestionType;
    options: string[] | null;
    correct_answer: string;
    solution_text?: string | null;
    question_image_url?: string | null;
    topic?: string | null;
    subtopic?: string | null;
    context_title?: string | null;
    context_body?: string | null;
    context_image_url?: string | null;
    difficulty?: string | null;
}

interface ResponseData {
    question_id: string;
    answer: string | null;
    status?: string | null;
    is_correct: boolean | null;
    marks_obtained: number | null;
    time_spent_seconds?: number | null;
    visit_count?: number | null;
    updated_at?: string | null;
}

/** Peer statistics for a paper - aggregated response counts */
interface PaperStats {
    [questionId: string]: {
        total: number;
        options: Record<string, number>;
    };
}

interface QuestionAnalysisProps {
    questions: QuestionData[];
    responses: ResponseData[];
    peerStats?: PaperStats;
    attemptSequenceLabel?: string | null;
    attemptId?: string | null;
    showDetailedList?: boolean;
    showHeader?: boolean;
}

type FilterType = 'all' | 'correct' | 'incorrect' | 'unanswered';
/** Get response for a question */
function getResponse(questionId: string, responses: ResponseData[]): ResponseData | undefined {
    return responses.find(r => r.question_id === questionId);
}

function resolveIsCorrect(question: QuestionData, response?: ResponseData): boolean | null {
    if (!response) return null;
    if (typeof response.is_correct === 'boolean') return response.is_correct;
    const answer = response.answer;
    if (answer === null || answer.trim() === '') return null;
    const correct = question.correct_answer;
    if (!correct || correct.trim() === '') return null;
    return compareAnswers(answer, correct, question.question_type);
}

/** Get status styling - ONLY used when answer is revealed */
function getStatusStyle(isCorrect: boolean | null, hasAnswer: boolean): {
    bgClass: string;
    borderClass: string;
    textClass: string;
    label: string;
} {
    if (!hasAnswer) {
        return {
            bgClass: 'bg-gray-100',
            borderClass: 'border-gray-300',
            textClass: 'text-gray-600',
            label: 'Unanswered',
        };
    }
    if (isCorrect) {
        return {
            bgClass: 'bg-green-50',
            borderClass: 'border-green-400',
            textClass: 'text-green-700',
            label: 'Correct',
        };
    }
    return {
        bgClass: 'bg-red-50',
        borderClass: 'border-red-400',
        textClass: 'text-red-700',
        label: 'Incorrect',
    };
}

/** Get neutral styling for masked mode (before reveal) */
function getMaskedStyle(): {
    bgClass: string;
    borderClass: string;
    textClass: string;
    label: string;
} {
    return {
        bgClass: 'bg-white',
        borderClass: 'border-gray-200',
        textClass: 'text-gray-700',
        label: 'Review',
    };
}

/** Format option label (A, B, C, D) */
function getOptionLabel(index: number): string {
    return String.fromCharCode(65 + index); // A, B, C, D
}

function formatDuration(seconds?: number | null): string {
    const totalSeconds = Math.max(0, Math.floor(seconds ?? 0));
    const minutes = Math.floor(totalSeconds / 60);
    const remainingSeconds = totalSeconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
}

const REASON_OPTIONS: Array<{ value: PerformanceReason; label: string }> = [
    { value: 'concept_gap', label: 'Concept gap' },
    { value: 'careless_error', label: 'Silly mistake' },
    { value: 'time_pressure', label: 'Time pressure' },
    { value: 'guess', label: 'Guess/unsure' },
];

export function QuestionAnalysis({
    questions,
    responses,
    peerStats = {},
    attemptSequenceLabel,
    attemptId,
    showDetailedList = true,
    showHeader = true,
}: QuestionAnalysisProps) {
    const [filter, setFilter] = useState<FilterType>('all');
    const [expandedQuestions, setExpandedQuestions] = useState<Set<string>>(new Set());
    const [visibleSolutions, setVisibleSolutions] = useState<Set<string>>(new Set());
    // Masked Review: Track which questions have had their answer/solution revealed
    const [revealedIds, setRevealedIds] = useState<Set<string>>(new Set());
    const [activeSection, setActiveSection] = useState<SectionName | 'all'>('all');
    const [activeTopic, setActiveTopic] = useState<string>('all');
    const analysisStore = getAnalysisStore(attemptId ?? 'temp');
    const analysisReasons = analysisStore((s) => s.reasons);
    const bookmarkedQuestions = analysisStore((s) => s.bookmarks);
    const setAnalysisReason = analysisStore((s) => s.setReason);
    const toggleBookmark = analysisStore((s) => s.toggleBookmark);

    const isAnswered = useCallback((response?: ResponseData) => {
        if (!response) return false;
        const status = response.status;
        if (status === 'answered' || status === 'answered_marked') return true;
        const answer = response.answer;
        return answer !== null && answer !== undefined && answer.trim() !== '';
    }, []);

    // Filter questions (section + status)
    const baseFilteredQuestions = questions.filter(q => {
        const response = getResponse(q.id, responses);
        const hasAnswer = isAnswered(response);
        const isCorrect = resolveIsCorrect(q, response);

        // Section filter
        if (activeSection !== 'all' && q.section !== activeSection) return false;

        // Status filter
        switch (filter) {
            case 'correct':
                return hasAnswer && isCorrect === true;
            case 'incorrect':
                return hasAnswer && isCorrect === false;
            case 'unanswered':
                return !hasAnswer;
            default:
                return true;
        }
    });

    const topics = useMemo(() => {
        const counts = new Map<string, number>();
        baseFilteredQuestions.forEach((q) => {
            const topic = q.topic?.trim() || 'Uncategorized';
            counts.set(topic, (counts.get(topic) ?? 0) + 1);
        });
        return Array.from(counts.entries()).map(([name, count]) => ({ name, count }));
    }, [baseFilteredQuestions]);

    useEffect(() => {
        if (activeTopic === 'all') return;
        const exists = topics.some(t => t.name === activeTopic);
        if (!exists) {
            setActiveTopic('all');
        }
    }, [activeTopic, topics]);

    const filteredQuestions = activeTopic === 'all'
        ? baseFilteredQuestions
        : baseFilteredQuestions.filter(q => (q.topic?.trim() || 'Uncategorized') === activeTopic);

    // Toggle question expansion
    const toggleQuestion = (questionId: string) => {
        setExpandedQuestions(prev => {
            const newSet = new Set(prev);
            if (newSet.has(questionId)) {
                newSet.delete(questionId);
            } else {
                newSet.add(questionId);
            }
            return newSet;
        });
    };

    // Reveal correct answer and solution (Masked Review Mode)
    const revealAnswer = (questionId: string) => {
        setRevealedIds(prev => {
            const newSet = new Set(prev);
            newSet.add(questionId);
            return newSet;
        });
        // Also show solution when revealing
        setVisibleSolutions(prev => {
            const newSet = new Set(prev);
            newSet.add(questionId);
            return newSet;
        });
    };

    const toggleSolution = (questionId: string) => {
        setVisibleSolutions(prev => {
            const newSet = new Set(prev);
            if (newSet.has(questionId)) {
                newSet.delete(questionId);
            } else {
                newSet.add(questionId);
            }
            return newSet;
        });
    };

    // Calculate peer percentage for an option
    const getOptionPercentage = (questionId: string, optionLabel: string): number | null => {
        const stats = peerStats[questionId];
        if (!stats || stats.total === 0) return null;
        const count = stats.options[optionLabel] ?? 0;
        return Math.round((count / stats.total) * 100);
    };

    // Stats for filters
    const stats = {
        correct: questions.filter(q => {
            const r = getResponse(q.id, responses);
            return isAnswered(r) && resolveIsCorrect(q, r) === true;
        }).length,
        incorrect: questions.filter(q => {
            const r = getResponse(q.id, responses);
            return isAnswered(r) && resolveIsCorrect(q, r) === false;
        }).length,
        unanswered: questions.filter(q => {
            const r = getResponse(q.id, responses);
            return !isAnswered(r);
        }).length,
    };

    return (
        <div className="mb-8">
            {showHeader && (
                <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
                    <h2 className="text-xl font-semibold text-gray-800">Question Analysis</h2>
                    {attemptSequenceLabel && (
                        <span className="text-xs font-semibold uppercase tracking-wide text-blue-700 bg-blue-50 border border-blue-100 px-3 py-1 rounded-full">
                            {attemptSequenceLabel}
                        </span>
                    )}
                </div>
            )}

            {/* Filters */}
            <div className="flex flex-wrap gap-3 mb-6">
                {/* Section Filter */}
                <div className="flex gap-1 bg-gray-100 rounded-lg p-1">
                    {(['all', 'VARC', 'DILR', 'QA'] as const).map((section) => (
                        <button
                            key={section}
                            onClick={() => setActiveSection(section)}
                            className={`px-3 py-1.5 text-sm rounded-md transition-colors ${activeSection === section
                                ? 'bg-white shadow text-blue-600 font-medium'
                                : 'text-gray-600 hover:bg-gray-50'
                                }`}
                        >
                            {section === 'all' ? 'All' : section}
                        </button>
                    ))}
                </div>

                {/* Status Filter */}
                <div className="flex gap-1 bg-gray-100 rounded-lg p-1">
                    <button
                        onClick={() => setFilter('all')}
                        className={`px-3 py-1.5 text-sm rounded-md transition-colors ${filter === 'all'
                            ? 'bg-white shadow text-gray-800 font-medium'
                            : 'text-gray-600 hover:bg-gray-50'
                            }`}
                    >
                        All ({questions.length})
                    </button>
                    <button
                        onClick={() => setFilter('correct')}
                        className={`px-3 py-1.5 text-sm rounded-md transition-colors ${filter === 'correct'
                            ? 'bg-green-100 text-green-700 font-medium'
                            : 'text-gray-600 hover:bg-gray-50'
                            }`}
                    >
                        ✓ Correct ({stats.correct})
                    </button>
                    <button
                        onClick={() => setFilter('incorrect')}
                        className={`px-3 py-1.5 text-sm rounded-md transition-colors ${filter === 'incorrect'
                            ? 'bg-red-100 text-red-700 font-medium'
                            : 'text-gray-600 hover:bg-gray-50'
                            }`}
                    >
                        ✗ Wrong ({stats.incorrect})
                    </button>
                    <button
                        onClick={() => setFilter('unanswered')}
                        className={`px-3 py-1.5 text-sm rounded-md transition-colors ${filter === 'unanswered'
                            ? 'bg-gray-300 text-gray-700 font-medium'
                            : 'text-gray-600 hover:bg-gray-50'
                            }`}
                    >
                        – Skipped ({stats.unanswered})
                    </button>
                </div>
            </div>

            {showDetailedList && (
                <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    {/* Question List */}
                    <div className="space-y-3 lg:col-span-3">
                        {filteredQuestions.length === 0 ? (
                            <div className="text-center py-8 text-gray-500">
                                No questions match the selected filters.
                            </div>
                        ) : (
                            filteredQuestions.map((question) => {
                                const response = getResponse(question.id, responses);
                                const hasAnswer = isAnswered(response);
                                const isCorrect = resolveIsCorrect(question, response);
                                const isExpanded = expandedQuestions.has(question.id);
                                const isSolutionVisible = visibleSolutions.has(question.id);
                                // Masked Review Mode: Only show correct/incorrect styling after reveal
                                const isRevealed = revealedIds.has(question.id);
                                const style = isRevealed
                                    ? getStatusStyle(isCorrect, hasAnswer)
                                    : getMaskedStyle();
                                const isBookmarked = Boolean(bookmarkedQuestions[question.id]);
                                const selectedReason = analysisReasons[question.id] ?? null;
                                const isIncorrect = hasAnswer && isCorrect === false;
                                const isSkipped = !hasAnswer;
                                const showReasonPicker = isIncorrect || isSkipped;

                                return (
                                    <div
                                        key={question.id}
                                        id={`question-${question.id}`}
                                        className={`border-2 ${style.borderClass} ${style.bgClass} rounded-lg overflow-hidden transition-all`}
                                    >
                                        {/* Question Header (Click to expand) */}
                                        <div
                                            role="button"
                                            tabIndex={0}
                                            onClick={() => toggleQuestion(question.id)}
                                            onKeyDown={(event) => {
                                                if (event.key === 'Enter' || event.key === ' ') {
                                                    event.preventDefault();
                                                    toggleQuestion(question.id);
                                                }
                                            }}
                                            className="w-full flex items-center gap-4 p-4 text-left hover:bg-white/50 transition-colors cursor-pointer"
                                        >
                                            {/* Question Number */}
                                            <div className="flex-shrink-0 w-12 h-12 rounded-lg bg-white border flex items-center justify-center">
                                                <span className="text-sm text-gray-500">Q{question.question_number}</span>
                                            </div>

                                            {/* Status & Section */}
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    {isRevealed ? (
                                                        <span className={`text-xs font-medium px-2 py-0.5 rounded ${style.textClass} bg-white`}>
                                                            {style.label}
                                                        </span>
                                                    ) : (
                                                        <span className="text-xs font-medium px-2 py-0.5 rounded text-blue-600 bg-blue-50">
                                                            {hasAnswer ? 'Attempted' : 'Skipped'}
                                                        </span>
                                                    )}
                                                    <span className="text-xs text-gray-500">
                                                        {question.section}
                                                    </span>
                                                    {question.topic && (
                                                        <span className="text-xs text-gray-400">
                                                            • {question.topic}
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="text-sm text-gray-700">
                                                    <MathText
                                                        text={question.question_text}
                                                        className="line-clamp-2 [&_p]:line-clamp-2 [&_p]:whitespace-pre-wrap"
                                                    />
                                                </div>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    Time: {response?.time_spent_seconds ? formatDuration(response.time_spent_seconds) : '—'}
                                                    {' '}• Visits: {response?.visit_count ?? '—'}
                                                </p>
                                            </div>

                                            {/* Marks - only show after reveal */}
                                            <div className="flex-shrink-0 text-right">
                                                {isRevealed ? (
                                                    <>
                                                        <span className={`text-lg font-bold ${style.textClass}`}>
                                                            {response?.marks_obtained !== null && response?.marks_obtained !== undefined
                                                                ? (response.marks_obtained > 0 ? '+' : '') + response.marks_obtained
                                                                : '0'
                                                            }
                                                        </span>
                                                        <span className="text-xs text-gray-400 block">marks</span>
                                                    </>
                                                ) : (
                                                    <span className="text-xs text-gray-400">Click to review</span>
                                                )}
                                            </div>

                                            {/* Bookmark Toggle */}
                                            <button
                                                type="button"
                                                onClick={(event) => {
                                                    event.stopPropagation();
                                                    toggleBookmark(question.id);
                                                }}
                                                className={`flex-shrink-0 inline-flex items-center justify-center w-10 h-10 rounded-full border transition-colors ${isBookmarked
                                                    ? 'border-amber-300 bg-amber-50 text-amber-600'
                                                    : 'border-gray-200 text-gray-400 hover:bg-gray-50'
                                                    }`}
                                                aria-pressed={isBookmarked}
                                                aria-label={isBookmarked ? 'Remove bookmark' : 'Bookmark question'}
                                            >
                                                <svg
                                                    className="w-5 h-5"
                                                    viewBox="0 0 24 24"
                                                    fill={isBookmarked ? 'currentColor' : 'none'}
                                                    stroke="currentColor"
                                                    strokeWidth={2}
                                                >
                                                    <path
                                                        strokeLinecap="round"
                                                        strokeLinejoin="round"
                                                        d="M5 4a2 2 0 012-2h10a2 2 0 012 2v18l-7-4-7 4V4z"
                                                    />
                                                </svg>
                                            </button>

                                            {/* Expand Icon */}
                                            <div className="flex-shrink-0">
                                                <svg
                                                    className={`w-5 h-5 text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`}
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                </svg>
                                            </div>
                                        </div>

                                        {/* Expanded Content */}
                                        {isExpanded && (
                                        <div className="border-t bg-white p-4 space-y-4">
                                            {/* Question Image */}
                                            {question.question_image_url && (
                                                <div className="mb-4">
                                                    <img
                                                        src={question.question_image_url}
                                                        alt={`Question ${question.question_number} diagram`}
                                                        className="max-w-full max-h-96 object-contain rounded-lg border border-gray-200"
                                                    />
                                                </div>
                                            )}

                                            {/* Full Question Text */}
                                            <div>
                                                <h4 className="text-sm font-medium text-gray-500 mb-2">Question</h4>
                                                <div className="text-gray-800 prose prose-sm max-w-none">
                                                    <MathText text={question.question_text} />
                                                </div>
                                            </div>

                                            {/* Response Analytics */}
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-gray-600">
                                                <div>
                                                    <span className="text-xs text-gray-500 block">Time Spent</span>
                                                    <span className="font-semibold text-gray-800">
                                                        {formatDuration(response?.time_spent_seconds)}
                                                    </span>
                                                </div>
                                                <div>
                                                    <span className="text-xs text-gray-500 block">Visits</span>
                                                    <span className="font-semibold text-gray-800">
                                                        {response?.visit_count ?? 0}
                                                    </span>
                                                </div>
                                            </div>

                                            {showReasonPicker && (
                                                <div className="rounded-lg border border-amber-100 bg-amber-50/70 p-3">
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-xs font-semibold text-amber-700">Reason for Performance</span>
                                                        <span className="text-[10px] uppercase tracking-wide text-amber-600">
                                                            {isSkipped ? 'Skipped' : 'Incorrect'}
                                                        </span>
                                                    </div>
                                                    <div className="mt-2 flex flex-wrap gap-2">
                                                        {REASON_OPTIONS.map((option) => {
                                                            const isActive = selectedReason === option.value;
                                                            return (
                                                                <button
                                                                    key={option.value}
                                                                    type="button"
                                                                    onClick={() => setAnalysisReason(question.id, isActive ? null : option.value)}
                                                                    className={`px-3 py-1.5 text-xs rounded-full border transition-colors ${isActive
                                                                        ? 'bg-amber-500 text-white border-amber-500'
                                                                        : 'bg-white text-amber-700 border-amber-200 hover:bg-amber-100'
                                                                        }`}
                                                                >
                                                                    {option.label}
                                                                </button>
                                                            );
                                                        })}
                                                    </div>
                                                    <p className="mt-2 text-[10px] text-amber-600">
                                                        Tap again to clear a selection.
                                                    </p>
                                                </div>
                                            )}

                                            {/* Options (for MCQ) with Masked Review Mode */}
                                            {question.question_type === 'MCQ' && question.options && (
                                                <div>
                                                    <h4 className="text-sm font-medium text-gray-500 mb-2">Options</h4>
                                                    <div className="space-y-2">
                                                        {question.options.map((option, idx) => {
                                                            const optionLabel = getOptionLabel(idx);
                                                            const isUserAnswer = response?.answer === optionLabel;
                                                            const isCorrectAnswer = question.correct_answer === optionLabel;
                                                            const peerPercent = isRevealed ? getOptionPercentage(question.id, optionLabel) : null;

                                                            // Masked mode: only show user's answer (neutral), no correct/incorrect
                                                            let optionBgClass = 'bg-gray-50';
                                                            let optionBorderClass = '';
                                                            let badgeClass = 'bg-gray-200 text-gray-600';

                                                            if (isRevealed) {
                                                                // Revealed: show correct/incorrect highlighting
                                                                if (isCorrectAnswer) {
                                                                    optionBgClass = 'bg-green-100';
                                                                    optionBorderClass = 'border border-green-300';
                                                                    badgeClass = 'bg-green-500 text-white';
                                                                } else if (isUserAnswer) {
                                                                    optionBgClass = 'bg-red-100';
                                                                    optionBorderClass = 'border border-red-300';
                                                                    badgeClass = 'bg-red-500 text-white';
                                                                }
                                                            } else {
                                                                // Masked: only highlight user's selection neutrally
                                                                if (isUserAnswer) {
                                                                    optionBgClass = 'bg-blue-50';
                                                                    optionBorderClass = 'border border-blue-200';
                                                                    badgeClass = 'bg-blue-500 text-white';
                                                                }
                                                            }

                                                            return (
                                                                <div
                                                                    key={idx}
                                                                    className={`flex items-start gap-3 p-2 rounded-lg ${optionBgClass} ${optionBorderClass}`}
                                                                >
                                                                    <span className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${badgeClass}`}>
                                                                        {optionLabel}
                                                                    </span>
                                                                    <span className="flex-1 text-sm text-gray-700">
                                                                        <MathText text={option} />
                                                                    </span>

                                                                    {/* Peer Stats Overlay - only after reveal */}
                                                                    {isRevealed && peerPercent !== null && (
                                                                        <div className="flex items-center gap-2 ml-auto">
                                                                            <div className="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                                                <div
                                                                                    className={`h-full rounded-full ${isCorrectAnswer ? 'bg-green-400' : 'bg-gray-400'}`}
                                                                                    style={{ width: `${peerPercent}%` }}
                                                                                />
                                                                            </div>
                                                                            <span className="text-xs text-gray-500 w-8">{peerPercent}%</span>
                                                                        </div>
                                                                    )}

                                                                    {/* Labels */}
                                                                    {isRevealed && isCorrectAnswer && (
                                                                        <span className="text-xs text-green-600 font-medium whitespace-nowrap">
                                                                            ✓ Correct
                                                                        </span>
                                                                    )}
                                                                    {isRevealed && isUserAnswer && !isCorrectAnswer && (
                                                                        <span className="text-xs text-red-600 font-medium whitespace-nowrap">
                                                                            Your answer
                                                                        </span>
                                                                    )}
                                                                    {!isRevealed && isUserAnswer && (
                                                                        <span className="text-xs text-blue-600 font-medium whitespace-nowrap">
                                                                            Your answer
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            )}

                                            {/* TITA Answer - Masked Review Mode */}
                                            {question.question_type === 'TITA' && (
                                                <div className="flex gap-6">
                                                    {isRevealed ? (
                                                        <>
                                                            <div>
                                                                <h4 className="text-sm font-medium text-gray-500 mb-1">Correct Answer</h4>
                                                                <MathText
                                                                    text={question.correct_answer}
                                                                    className="text-lg font-bold text-green-600 [&_p]:my-0"
                                                                />
                                                            </div>
                                                            <div>
                                                                <h4 className="text-sm font-medium text-gray-500 mb-1">Your Answer</h4>
                                                                <MathText
                                                                    text={response?.answer || '(Not answered)'}
                                                                    className={`text-lg font-bold ${isCorrect === true ? 'text-green-600' : isCorrect === false ? 'text-red-600' : 'text-gray-500'} [&_p]:my-0`}
                                                                />
                                                            </div>
                                                        </>
                                                    ) : (
                                                        <div>
                                                            <h4 className="text-sm font-medium text-gray-500 mb-1">Your Answer</h4>
                                                            <MathText
                                                                text={response?.answer || '(Not answered)'}
                                                                className="text-lg font-bold text-blue-600 [&_p]:my-0"
                                                            />
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* Check Answer Button - Masked Review Mode */}
                                            {!isRevealed && (
                                                <div className="pt-2">
                                                    <button
                                                        type="button"
                                                        onClick={() => revealAnswer(question.id)}
                                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm"
                                                    >
                                                        🔍 Check Answer & Show Solution
                                                    </button>
                                                </div>
                                            )}

                                            {/* Solution - only after reveal */}
                                            {isRevealed && question.solution_text && (
                                                <div>
                                                    <div className="flex items-center justify-between mb-2">
                                                        <h4 className="text-sm font-medium text-gray-500">Solution</h4>
                                                        <button
                                                            type="button"
                                                            onClick={() => toggleSolution(question.id)}
                                                            className="text-blue-600 hover:underline text-sm"
                                                            aria-expanded={isSolutionVisible}
                                                        >
                                                            {isSolutionVisible ? 'Hide Solution' : 'View Solution'}
                                                        </button>
                                                    </div>
                                                    <div
                                                        className={`transition-all duration-200 ${isSolutionVisible ? 'max-h-[800px] opacity-100' : 'max-h-0 opacity-0 overflow-hidden'}`}
                                                    >
                                                        <div className="text-gray-700 prose prose-sm max-w-none bg-blue-50 p-4 rounded-lg">
                                                            <MathText text={question.solution_text ?? ''} />
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    )}
                </div>

                {/* Topic Navigator */}
                <aside className="lg:col-span-1">
                    <div className="sticky top-4 space-y-3">
                        <div className="bg-white border border-gray-200 rounded-lg p-4">
                            <h3 className="text-sm font-semibold text-gray-800 mb-3">Topics</h3>
                            <button
                                type="button"
                                onClick={() => setActiveTopic('all')}
                                className={`w-full text-left text-sm px-2 py-1.5 rounded transition-colors ${activeTopic === 'all'
                                    ? 'bg-blue-50 text-blue-700'
                                    : 'text-gray-600 hover:bg-gray-50'
                                    }`}
                            >
                                All Topics ({baseFilteredQuestions.length})
                            </button>
                            <div className="mt-2 space-y-1">
                                {topics.length === 0 ? (
                                    <div className="text-xs text-gray-400">No topics available.</div>
                                ) : (
                                    topics.map((topic) => (
                                        <button
                                            key={topic.name}
                                            type="button"
                                            onClick={() => setActiveTopic(topic.name)}
                                            className={`w-full text-left text-sm px-2 py-1.5 rounded transition-colors ${activeTopic === topic.name
                                                ? 'bg-blue-50 text-blue-700'
                                                : 'text-gray-600 hover:bg-gray-50'
                                                }`}
                                        >
                                            {topic.name} ({topic.count})
                                        </button>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
            )}

        </div>
    );
}
````

## File: src/app/api/save/route.ts
````typescript
/**
 * @fileoverview Save Response API Route
 * @description Saves user's answer to a question during exam
 * @blueprint Security Audit - P0 Fix - Rate Limiting, Session Locking
 */

import { NextRequest, NextResponse } from 'next/server';
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { checkRateLimit, RATE_LIMITS, userRateLimitKey, getRateLimitHeaders } from '@/lib/rate-limit';
import { examLogger } from '@/lib/logger';
import { getServiceRoleClient } from '@/lib/supabase/service-role';
import {
    isNonEmptyString,
    getSupabaseConfig,
    serverMisconfiguredResponse,
    addVersionHeader,
} from '../_utils/validation';

type ValidateSessionResult = { data: boolean | null; error: { code?: string; message?: string } | null };

function isMissingValidateFn(error?: { code?: string; message?: string } | null): boolean {
    if (!error) return false;
    return error.code === '42883' || Boolean(error.message?.includes('validate_session_token'));
}

async function validateSessionTokenRpc(
    supabase: { rpc: (fn: string, args: Record<string, unknown>) => PromiseLike<ValidateSessionResult> },
    attemptId: string,
    sessionToken: string,
    userId: string
): Promise<ValidateSessionResult> {
    const primary = await supabase.rpc('validate_session_token', {
        p_attempt_id: attemptId,
        p_session_token: sessionToken,
        p_user_id: userId,
    });

    if (!primary.error || !isMissingValidateFn(primary.error)) return primary;

    return supabase.rpc('validate_session_token', {
        p_attempt_id: attemptId,
        p_session_token: sessionToken,
        p_user_id: userId,
        p_force_resume: false,
    });
}

export async function POST(req: NextRequest) {
    // Create a single response object up-front so any auth cookie mutations
    // made by supabase SSR actually get returned to the client.
    const res = NextResponse.next();

    try {
        const body = await req.json();
        const {
            attemptId,
            questionId,
            answer,
            sessionToken,
            force_resume,
            status,
            isMarkedForReview,
            isVisited,
            timeSpentSeconds,
            visitCount,
        } = body ?? {};

        const referer = req.headers.get('referer') ?? '';
        let refererAttemptId: string | null = null;
        try {
            const path = new URL(referer).pathname;
            const parts = path.split('/');
            if (parts[1] === 'exam' && parts[2]) refererAttemptId = parts[2];
        } catch {
            // ignore malformed referer
        }

        if (!isNonEmptyString(attemptId)) {
            return addVersionHeader(NextResponse.json({ error: 'attemptId is required' }, { status: 400 }));
        }
        if (!isNonEmptyString(questionId)) {
            return addVersionHeader(NextResponse.json({ error: 'questionId is required' }, { status: 400 }));
        }

        const config = getSupabaseConfig();
        if (!config) {
            return addVersionHeader(serverMisconfiguredResponse());
        }

        const supabase = createServerClient(config.url, config.anonKey, {
            cookies: {
                get(name: string) {
                    return req.cookies.get(name)?.value;
                },
                set(name: string, value: string, options: CookieOptions) {
                    res.cookies.set({ name, value, ...options });
                },
                remove(name: string, options: CookieOptions) {
                    res.cookies.set({ name, value: '', ...options });
                },
            },
        });

        const {
            data: { session },
        } = await supabase.auth.getSession();

        if (!session) {
            return addVersionHeader(NextResponse.json({ error: 'Unauthorized' }, { status: 401 }));
        }

        // P0 FIX: Rate limiting per user
        const rateLimitKey = userRateLimitKey('save', session.user.id);
        const rateLimitResult = checkRateLimit(rateLimitKey, RATE_LIMITS.SAVE_RESPONSE);

        if (!rateLimitResult.allowed) {
            const headers = getRateLimitHeaders(rateLimitResult, RATE_LIMITS.SAVE_RESPONSE.limit);
            return NextResponse.json(
                {
                    error: 'Rate limit exceeded. Please slow down.',
                    retryAfterSeconds: Math.ceil(rateLimitResult.retryAfterMs / 1000),
                },
                { status: 429, headers }
            );
        }

        // Ensure the attempt belongs to the user (service role read to avoid RLS false negatives)
        const adminClient = getServiceRoleClient();
        let effectiveAttemptId = attemptId;
        let { data: attempt, error: attemptError } = await adminClient
            .from('attempts')
            .select('id, user_id, status, started_at, paper_id')
            .eq('id', attemptId)
            .maybeSingle();

        if ((!attempt || attemptError) && refererAttemptId && refererAttemptId !== attemptId) {
            const { data: refererAttempt, error: refererError } = await adminClient
                .from('attempts')
                .select('id, user_id, status, started_at, paper_id')
                .eq('id', refererAttemptId)
                .maybeSingle();
            if (refererAttempt && !refererError) {
                attempt = refererAttempt;
                effectiveAttemptId = refererAttemptId;
            }
        }

        if (attemptError) {
            console.log('API_SAVE_ATTEMPT_LOOKUP_FAILED', {
                attemptId,
                userId: session.user.id,
                status: null,
                errorCode: attemptError.code ?? null,
                errorMessage: attemptError.message ?? 'Attempt lookup failed',
            });
            return NextResponse.json(
                {
                    error: 'Failed to fetch attempt',
                    ...(process.env.NODE_ENV !== 'production'
                        ? {
                            debug: {
                                attemptId,
                                refererAttemptId,
                                userId: session.user.id,
                                supabaseUrl: process.env.NEXT_PUBLIC_SUPABASE_URL ?? null,
                                hasServiceRoleKey: Boolean(process.env.SUPABASE_SERVICE_ROLE_KEY),
                                attemptErrorCode: attemptError.code ?? null,
                                attemptErrorMessage: attemptError.message ?? null,
                            },
                        }
                        : {}),
                },
                { status: 500 }
            );
        }

        if (!attempt || attempt.user_id !== session.user.id) {
            const {
                data: { user },
            } = await supabase.auth.getUser();

            if (!user) {
                return NextResponse.json({ error: 'Session expired. Please sign in again.' }, { status: 401 });
            }

            console.log('API_SAVE_ATTEMPT_FORBIDDEN', {
                attemptId,
                userId: session.user.id,
                status: attempt?.status ?? null,
                errorCode: 'FORBIDDEN',
                errorMessage: 'Attempt not found or not owned by user',
            });
            return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
        }

        // P0 FIX: Don't allow saves on completed/submitted attempts
        if (attempt.status !== 'in_progress') {
            console.log('API_SAVE_ATTEMPT_STATUS_MISMATCH', {
                attemptId,
                userId: session.user.id,
                status: attempt.status,
                errorCode: 'INVALID_ATTEMPT_STATUS',
                errorMessage: 'Attempt is not in progress',
            });
            return NextResponse.json({ error: 'Attempt is not in progress' }, { status: 400 });
        }

        if (!sessionToken) {
            return NextResponse.json({ error: 'Missing session token' }, { status: 400 });
        }

        const { data: isValidSession, error: validateError } = await validateSessionTokenRpc(
            supabase,
            effectiveAttemptId,
            sessionToken,
            session.user.id
        );

        if (validateError) {
            examLogger.securityEvent('Save session validation RPC error', {
                attemptId,
                errorMessage: validateError.message,
                errorCode: validateError.code,
            });
            // If RPC error and force_resume is set, try to proceed with force resume
            if (force_resume === true) {
                const { error: forceResumeError } = await supabase.rpc('force_resume_exam_session', {
                    p_attempt_id: effectiveAttemptId,
                    p_new_session_token: sessionToken,
                });
                if (!forceResumeError) {
                    // Force resume succeeded, continue with save
                } else {
                    return NextResponse.json(
                        {
                            error: 'Failed to validate session',
                            code: 'VALIDATION_RPC_ERROR',
                            ...(process.env.NODE_ENV !== 'production'
                                ? {
                                    debug: {
                                        attemptId: effectiveAttemptId,
                                        validateErrorCode: validateError.code ?? null,
                                        validateErrorMessage: validateError.message ?? null,
                                    },
                                }
                                : {}),
                        },
                        { status: 500 }
                    );
                }
            } else {
                return NextResponse.json(
                    {
                        error: 'Failed to validate session',
                        code: 'VALIDATION_RPC_ERROR',
                        ...(process.env.NODE_ENV !== 'production'
                            ? {
                                debug: {
                                    attemptId: effectiveAttemptId,
                                    validateErrorCode: validateError.code ?? null,
                                    validateErrorMessage: validateError.message ?? null,
                                },
                            }
                            : {}),
                    },
                    { status: 500 }
                );
            }
        }

        if (!isValidSession) {
            if (force_resume === true) {
                const ip = req.headers.get('x-forwarded-for') ?? 'unknown';
                const userAgent = req.headers.get('user-agent') ?? 'unknown';

                examLogger.securityEvent('Force resume (save)', {
                    attemptId: effectiveAttemptId,
                    ip,
                    userAgent,
                });

                const { error: forceResumeError } = await supabase.rpc('force_resume_exam_session', {
                    p_attempt_id: effectiveAttemptId,
                    p_new_session_token: sessionToken,
                });

                if (forceResumeError) {
                    if (
                        forceResumeError.message?.includes('FORCE_RESUME_STALE') ||
                        forceResumeError.message?.includes('stale')
                    ) {
                        return NextResponse.json(
                            {
                                error: 'Force resume denied. Session is too old.',
                                code: 'FORCE_RESUME_STALE',
                            },
                            { status: 409 }
                        );
                    }

                    return NextResponse.json({ error: 'Failed to force resume session' }, { status: 500 });
                }
            } else {
                examLogger.securityEvent('Save session token mismatch', { attemptId: effectiveAttemptId });
                return NextResponse.json(
                    {
                        error: 'Session conflict detected. This exam may be open in another tab or device.',
                        code: 'SESSION_CONFLICT',
                        canForceResume: true,
                    },
                    { status: 409 }
                );
            }
        }

        // P0 FIX: Server-side section timer validation
        // Check if too much time has elapsed since exam started (dynamic per paper)
        if (attempt.started_at) {
            const { data: paperTiming, error: paperTimingError } = await supabase
                .from('papers')
                .select('sections')
                .eq('id', attempt.paper_id)
                .maybeSingle();

            if (paperTimingError) {
                return NextResponse.json(
                    {
                        error: 'Failed to fetch paper timing',
                        ...(process.env.NODE_ENV !== 'production'
                            ? {
                                debug: {
                                    attemptId: effectiveAttemptId,
                                    paperId: attempt.paper_id,
                                    paperTimingErrorCode: paperTimingError.code ?? null,
                                    paperTimingErrorMessage: paperTimingError.message ?? null,
                                },
                            }
                            : {}),
                    },
                    { status: 500 }
                );
            }

            const totalMinutes = (paperTiming?.sections || []).reduce(
                (sum: number, s: { time?: number }) => sum + (s.time || 0),
                0
            );

            const maxDurationMs = Math.max(1, totalMinutes || 120) * 60 * 1000;
            const GRACE_PERIOD_MS = 2 * 60 * 1000; // 2 minutes grace

            const startedAt = new Date(attempt.started_at).getTime();
            const elapsed = Date.now() - startedAt;

            if (elapsed > maxDurationMs + GRACE_PERIOD_MS) {
                return NextResponse.json(
                    {
                        error: 'Exam time has expired. Saves are no longer accepted.',
                        code: 'TIME_EXPIRED',
                    },
                    { status: 400 }
                );
            }
        }

        // Upsert response
        const upsertPayload: Record<string, unknown> = {
            attempt_id: effectiveAttemptId,
            question_id: questionId,
            answer: answer ?? null,
        };

        if (typeof status === 'string') upsertPayload.status = status;
        if (typeof isMarkedForReview === 'boolean') upsertPayload.is_marked_for_review = isMarkedForReview;
        if (typeof isVisited === 'boolean') upsertPayload.is_visited = isVisited;
        if (typeof timeSpentSeconds === 'number') upsertPayload.time_spent_seconds = timeSpentSeconds;
        if (typeof visitCount === 'number') upsertPayload.visit_count = visitCount;

        const { data, error } = await supabase
            .from('responses')
            .upsert(upsertPayload, { onConflict: 'attempt_id,question_id' })
            .select('attempt_id, question_id, answer, updated_at')
            .single();

        if (error) {
            const errorMessage = error.message ?? 'Upsert failed';
            const errorCode = error.code ?? null;
            const isRls =
                errorCode === '42501' ||
                errorMessage.toLowerCase().includes('row-level security') ||
                errorMessage.toLowerCase().includes('permission denied');

            if (isRls) {
                const {
                    data: { user },
                } = await supabase.auth.getUser();

                if (!user) {
                    return NextResponse.json(
                        { error: 'Session expired. Please sign in again.' },
                        { status: 401 }
                    );
                }

                return NextResponse.json(
                    { error: 'Insufficient permissions to save response.' },
                    { status: 403 }
                );
            }

            console.log('API_SAVE_RESPONSE_UPSERT_FAILED', {
                attemptId,
                userId: session.user.id,
                status: attempt.status,
                errorCode,
                errorMessage,
            });
            return NextResponse.json(
                {
                    error: errorMessage,
                    ...(process.env.NODE_ENV !== 'production'
                        ? {
                            debug: {
                                attemptId: effectiveAttemptId,
                                questionId,
                                errorCode,
                                errorMessage,
                            },
                        }
                        : {}),
                },
                { status: 500 }
            );
        }

        // Add rate limit headers to successful response
        const successHeaders = getRateLimitHeaders(rateLimitResult, RATE_LIMITS.SAVE_RESPONSE.limit);

        // Create proper JSON response with cookie mutations from res preserved
        const response = NextResponse.json({ success: true, data }, { status: 200 });
        Object.entries(successHeaders).forEach(([k, v]) => response.headers.set(k, String(v)));
        // Copy any auth cookies set by supabase SSR
        res.cookies.getAll().forEach(cookie => {
            response.cookies.set(cookie.name, cookie.value);
        });

        return addVersionHeader(response);
    } catch {
        return addVersionHeader(NextResponse.json({ error: 'Invalid JSON' }, { status: 400 }));
    }
}
````

## File: src/app/auth/callback/route.ts
````typescript
import { NextRequest, NextResponse } from 'next/server';
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { logger } from '@/lib/logger';
import { checkRateLimit, RATE_LIMITS, ipRateLimitKey, getRateLimitHeaders } from '@/lib/rate-limit';
import { incrementMetric } from '@/lib/telemetry';

export async function GET(req: NextRequest) {
    incrementMetric('auth_callback');
    const ip = req.headers.get('x-forwarded-for')?.split(',')[0]?.trim()
        || req.headers.get('x-real-ip')
        || 'unknown';
    const rateKey = ipRateLimitKey('auth_callback', ip);
    const rateResult = checkRateLimit(rateKey, RATE_LIMITS.AUTH);
    if (!rateResult.allowed) {
        incrementMetric('auth_callback_rate_limited');
        const errorUrl = new URL('/auth/sign-in', req.nextUrl.origin);
        errorUrl.searchParams.set('error', 'rate_limited');
        const response = NextResponse.redirect(errorUrl);
        const headers = getRateLimitHeaders(rateResult, RATE_LIMITS.AUTH.limit);
        Object.entries(headers).forEach(([key, value]) => response.headers.set(key, value));
        return response;
    }

    const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string | undefined;
    const anon = (process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) as string | undefined;

    const redirectTo = req.nextUrl.searchParams.get('redirect_to') || '/dashboard';
    const requestOrigin = req.nextUrl.origin;
    const configuredSiteUrl = process.env.NEXT_PUBLIC_SITE_URL;
    // Prefer configured site URL to enforce primary domain.
    let baseUrl = requestOrigin;
    if (configuredSiteUrl) {
        try {
            baseUrl = new URL(configuredSiteUrl).origin;
        } catch {
            // Ignore invalid NEXT_PUBLIC_SITE_URL values.
        }
    }
    const finalUrl = new URL(redirectTo, baseUrl);
    const response = NextResponse.redirect(finalUrl);

    const supabase = createServerClient(url || 'http://localhost:54321', anon || 'anon', {
        cookies: {
            getAll() {
                return req.cookies.getAll();
            },
            setAll(cookiesToSet: Array<{ name: string; value: string; options: CookieOptions }>) {
                cookiesToSet.forEach(({ name, value, options }) => {
                    response.cookies.set({ name, value, ...options });
                });
            },
        },
    });

    // Exchange the auth code for a session and set cookies
    const code = req.nextUrl.searchParams.get('code');
    if (code) {
        const { error } = await supabase.auth.exchangeCodeForSession(code);
        if (error) {
            incrementMetric('auth_callback_error');
            logger.error('Auth callback error', error.message, { redirectTo });
            const errorUrl = new URL('/auth/sign-in', req.nextUrl.origin);
            errorUrl.searchParams.set('error', 'auth_failed');
            return NextResponse.redirect(errorUrl);
        }

        const { data: { user } } = await supabase.auth.getUser();
        if (user?.created_at) {
            const createdAtMs = Date.parse(user.created_at);
            if (Number.isFinite(createdAtMs) && Date.now() - createdAtMs < 5 * 60 * 1000) {
                incrementMetric('signup_detected');
            }
        }
    }

    return response;
}
````

## File: src/app/exam/[attemptId]/ExamClient.tsx
````typescript
/**
 * @fileoverview Exam Client Component
 * @description Client-side exam interface that integrates with the exam engine
 * @blueprint Milestone 4 SOP-SSOT - Integration
 *
 * PHASE 4 FIX: Robust submission with better error handling
 * PHASE 5: Cleanup - localStorage key hygiene
 *
 * PATCH (2026-01-30): Session-token hardening
 * - Ensure every save/submit uses a server-issued session token
 * - Avoid retry requiring a second token refresh (use same token + force_resume)
 * - Graceful fallback if token refresh fails mid-submit
 */

'use client';

import { useEffect, useCallback, useRef, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useExamStore, ExamLayout } from '@/features/exam-engine';
import {
    saveResponse,
    updateAttemptProgress,
    submitExam,
    pauseExam,
    initializeExamSession,
} from '@/features/exam-engine/api/client';
import { logger, examLogger } from '@/lib/logger';
import { examDebug, cleanupOrphanedExamState, clearAllExamState } from '@/lib/examDebug';
import { DevToolsPanel } from '@/features/exam-engine/ui/DevToolsPanel';
import { isDevSyncPaused } from '@/lib/devTools';
import { sb } from '@/lib/supabase/client';
import type { Paper, Question, Attempt, SectionName, TimeRemaining, Response, SectionTimerState } from '@/types/exam';
import { getSectionByIndex } from '@/types/exam';

// =============================================================================
// TYPES
// =============================================================================

interface ExamClientProps {
    paper: Paper;
    questions: Question[];
    attempt: Attempt;
    responses?: Response[];
}

// =============================================================================
// HELPERS
// =============================================================================

const AUTO_SAVE_INTERVAL_MS = 60000;
const PROGRESS_DEBOUNCE_MS = 1000;
const MAX_BEACON_BYTES = 60 * 1024;
const EXAM_LAYOUT_MODE = (process.env.NEXT_PUBLIC_EXAM_LAYOUT_MODE ?? 'current') as 'current' | 'three-column';

type SectionTimersSnapshot = Partial<Record<SectionName, Pick<SectionTimerState, 'remainingSeconds'>>>;

function getPersistedAnswer(status: string, answer: string | null) {
    return status === 'answered' || status === 'answered_marked' ? answer : null;
}

function buildTimeRemainingSafe(timers: SectionTimersSnapshot | null | undefined): TimeRemaining | null {
    const varc = timers?.VARC?.remainingSeconds;
    const dilr = timers?.DILR?.remainingSeconds;
    const qa = timers?.QA?.remainingSeconds;

    if (typeof varc !== 'number' || typeof dilr !== 'number' || typeof qa !== 'number') return null;

    return { VARC: varc, DILR: dilr, QA: qa };
}

// Most Supabase-style tokens are UUIDs; if yours is TEXT, this still works (we just refresh more often).
function isProbablyUUID(v: unknown): v is string {
    if (typeof v !== 'string') return false;
    const s = v.trim();
    if (!s) return false;
    const uuid =
        /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    return uuid.test(s);
}

function isNonEmptyString(v: unknown): v is string {
    return typeof v === 'string' && v.trim().length > 0;
}

// =============================================================================
// DEBOUNCE HELPER
// =============================================================================

function useDebouncedCallback<Args extends unknown[], R>(
    callback: (...args: Args) => R,
    delay: number
): ((...args: Args) => void) & { cancel: () => void } {
    const timeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
    const callbackRef = useRef(callback);

    useEffect(() => {
        callbackRef.current = callback;
    }, [callback]);

    useEffect(() => {
        return () => {
            if (timeoutRef.current) clearTimeout(timeoutRef.current);
        };
    }, []);

    const debounced = useCallback(
        (...args: Args) => {
            if (timeoutRef.current) clearTimeout(timeoutRef.current);
            timeoutRef.current = setTimeout(() => {
                callbackRef.current(...args);
            }, delay);
        },
        [delay]
    ) as ((...args: Args) => void) & { cancel: () => void };

    debounced.cancel = () => {
        if (timeoutRef.current) clearTimeout(timeoutRef.current);
        timeoutRef.current = null;
    };

    return debounced;
}

// =============================================================================
// MAIN COMPONENT
// =============================================================================

export function ExamClient({ paper, questions, attempt, responses: serverResponses }: ExamClientProps) {
    const router = useRouter();

    // Store actions / state
    const initializeExam = useExamStore((s) => s.initializeExam);
    const setSessionToken = useExamStore((s) => s.setSessionToken);
    const hasHydrated = useExamStore((s) => s.hasHydrated);
    const isInitialized = useExamStore((s) => s.isInitialized);
    const attemptId = useExamStore((s) => s.attemptId);
    const currentSectionIndex = useExamStore((s) => s.currentSectionIndex);
    const currentQuestionIndex = useExamStore((s) => s.currentQuestionIndex);
    const sectionTimers = useExamStore((s) => s.sectionTimers);
    const responses = useExamStore((s) => s.responses);
    const isSubmitting = useExamStore((s) => s.isSubmitting);
    const isAutoSubmitting = useExamStore((s) => s.isAutoSubmitting);
    const sessionToken = useExamStore((s) => s.sessionToken);
    const setSubmitting = useExamStore((s) => s.setSubmitting);
    const setAutoSubmitting = useExamStore((s) => s.setAutoSubmitting);

    // Refs to avoid effect re-binding / stale values in event listeners & intervals
    const attemptIdRef = useRef<typeof attemptId>(attemptId);
    const currentSectionIndexRef = useRef(currentSectionIndex);
    const currentQuestionIndexRef = useRef(currentQuestionIndex);
    const sectionTimersRef = useRef(sectionTimers);
    const responsesRef = useRef(responses);
    const isSubmittingRef = useRef(isSubmitting);
    const isAutoSubmittingRef = useRef(isAutoSubmitting);
    const sessionTokenRef = useRef(sessionToken);

    // Keep refs fresh every render
    attemptIdRef.current = attemptId;
    currentSectionIndexRef.current = currentSectionIndex;
    currentQuestionIndexRef.current = currentQuestionIndex;
    sectionTimersRef.current = sectionTimers;
    responsesRef.current = responses;
    isSubmittingRef.current = isSubmitting;
    isAutoSubmittingRef.current = isAutoSubmitting;
    sessionTokenRef.current = sessionToken;

    const submissionIdRef = useRef<string>(
        typeof crypto !== 'undefined' && crypto.randomUUID
            ? crypto.randomUUID()
            : `${Date.now()}-${Math.random().toString(36).slice(2)}`
    );

    const [sessionConflict, setSessionConflict] = useState<
        | { type: 'save'; payload: Parameters<typeof saveResponse>[0] }
        | { type: 'submit' }
        | null
    >(null);
    const [isResolvingConflict, setIsResolvingConflict] = useState(false);
    const [uiError, setUiError] = useState<string | null>(null);
    const [showAuthExpiredModal, setShowAuthExpiredModal] = useState(false);

    // Track if we've already attempted initialization
    const initAttemptedRef = useRef(false);
    const sessionInitRef = useRef(false);
    const flushInProgressRef = useRef(false);

    // Single-flight session initialization to prevent token spam
    const sessionTokenPromiseRef = useRef<Promise<string | null> | null>(null);

    const ensureSessionToken = useCallback(
        async (opts?: { force?: boolean; reason?: string }): Promise<string | null> => {
            const force = opts?.force === true;
            const reason = opts?.reason ?? 'unknown';

            const current = sessionTokenRef.current;

            // If we already have a server-looking token and not forcing, reuse it.
            // (If your tokens are TEXT not UUID, still OK: force refresh on submit handles correctness.)
            if (!force && isNonEmptyString(current) && isProbablyUUID(current)) {
                return current;
            }

            // De-dupe concurrent refreshes
            if (sessionTokenPromiseRef.current) return sessionTokenPromiseRef.current;

            const aId = attemptIdRef.current ?? attempt.id;

            sessionTokenPromiseRef.current = (async () => {
                try {
                    const result = await initializeExamSession(aId);
                    if (result.success && isNonEmptyString(result.data?.sessionToken)) {
                        const token = result.data!.sessionToken;
                        setSessionToken(token);
                        return token;
                    }

                    // Refresh failed: fall back to whatever we have (better than null)
                    if (isNonEmptyString(current)) {
                        logger.warn('ensureSessionToken: refresh failed; using existing token', {
                            attemptId: aId,
                            reason,
                        });
                        return current;
                    }

                    logger.warn('ensureSessionToken: no token available', { attemptId: aId, reason });
                    return null;
                } catch (e) {
                    // Same fallback behavior on exception
                    if (isNonEmptyString(current)) {
                        logger.warn('ensureSessionToken: exception; using existing token', e, {
                            attemptId: aId,
                            reason,
                        });
                        return current;
                    }
                    logger.warn('ensureSessionToken: exception; no token available', e, { attemptId: aId, reason });
                    return null;
                } finally {
                    sessionTokenPromiseRef.current = null;
                }
            })();

            return sessionTokenPromiseRef.current;
        },
        [attempt.id, setSessionToken]
    );

    /**
     * Force get a fresh session token from server.
     * Always calls API; falls back to existing token if refresh fails.
     */
    const forceRefreshSessionToken = useCallback(async (): Promise<string | null> => {
        return ensureSessionToken({ force: true, reason: 'forceRefreshSessionToken' });
    }, [ensureSessionToken]);

    // Initialize exam on mount - but only once per session
    useEffect(() => {
        cleanupOrphanedExamState(attempt.id);

        if (!initAttemptedRef.current) {
            initAttemptedRef.current = true;
            examDebug.log('Initializing exam', { attemptId: attempt.id, paperId: paper.id });
            initializeExam({
                paper,
                questions,
                attempt,
                responses: serverResponses,
            });
        }
    }, [paper, questions, attempt, serverResponses, initializeExam]);

    // Initialize session token server-side (RPC) once per mount
    useEffect(() => {
        if (sessionInitRef.current) return;
        sessionInitRef.current = true;

        void ensureSessionToken({ force: true, reason: 'initial-mount' });
    }, [ensureSessionToken]);

    const flushNow = useCallback(async () => {
        const aId = attemptIdRef.current ?? attempt.id;
        if (!aId) return;
        if (!isInitialized) return;
        if (isDevSyncPaused()) return;
        if (isSubmittingRef.current || isAutoSubmittingRef.current) return;
        if (flushInProgressRef.current) return;

        const timers = sectionTimersRef.current;
        const timeRemaining = buildTimeRemainingSafe(timers);
        if (!timeRemaining) return;

        flushInProgressRef.current = true;

        try {
            await updateAttemptProgress({
                attemptId: aId,
                timeRemaining,
                currentSection: getSectionByIndex(currentSectionIndexRef.current),
                currentQuestion: currentQuestionIndexRef.current + 1,
            });
        } catch (error) {
            logger.warn('Flush progress failed', error);
        }

        try {
            const token = await ensureSessionToken({ reason: 'flushNow' });
            if (!token) return;

            const snapshot = responsesRef.current;

            await Promise.all(
                Object.entries(snapshot).map(async ([questionId, response]) => {
                    if (response.answer === null && response.status === 'not_visited') return;

                    const persistedAnswer = getPersistedAnswer(response.status, response.answer);

                    await saveResponse({
                        attemptId: aId,
                        questionId,
                        answer: persistedAnswer,
                        status: response.status,
                        isMarkedForReview: response.isMarkedForReview,
                        isVisited: response.status !== 'not_visited',
                        timeSpentSeconds: response.timeSpentSeconds,
                        sessionToken: token,
                    });
                })
            );
        } catch (error) {
            logger.warn('Flush responses failed', error);
        } finally {
            flushInProgressRef.current = false;
        }
    }, [attempt.id, ensureSessionToken, isInitialized]);

    // Debounced save to server (wrap in try/catch to avoid unhandled rejections)
    const debouncedSaveProgress = useDebouncedCallback(
        async (timers: Record<SectionName, SectionTimerState>) => {
            const aId = attemptIdRef.current ?? attempt.id;
            if (!aId) return;
            if (isDevSyncPaused()) return;
            if (isSubmittingRef.current || isAutoSubmittingRef.current) return;

            const timeRemaining: TimeRemaining = {
                VARC: timers.VARC.remainingSeconds,
                DILR: timers.DILR.remainingSeconds,
                QA: timers.QA.remainingSeconds,
            };

            try {
                await updateAttemptProgress({
                    attemptId: aId,
                    timeRemaining,
                    currentSection: getSectionByIndex(currentSectionIndexRef.current),
                    currentQuestion: currentQuestionIndexRef.current + 1,
                });
            } catch (e) {
                logger.warn('Auto-save progress failed', e, { attemptId: aId });
            }
        },
        PROGRESS_DEBOUNCE_MS
    );

    // Auto-save progress periodically (do NOT re-create interval on every timer tick)
    useEffect(() => {
        if (!attemptId || !isInitialized) return;
        if (isSubmittingRef.current || isAutoSubmittingRef.current) return;

        const interval = setInterval(() => {
            debouncedSaveProgress(sectionTimersRef.current);
        }, AUTO_SAVE_INTERVAL_MS);

        return () => clearInterval(interval);
    }, [attemptId, isInitialized, debouncedSaveProgress]);

    // Save on exit / visibility changes (bind once; handlers read refs)
    // Use sendBeacon for pagehide/visibility to ensure data is persisted even during unload
    useEffect(() => {
        const sendBeaconBatchSave = () => {
            if (!isInitialized) return;
            const aId = attemptIdRef.current ?? attempt.id;
            if (!aId || isSubmittingRef.current || isAutoSubmittingRef.current) return;

            const snapshot = responsesRef.current;
            const token = sessionTokenRef.current;

            // Build batch of responses to save
            const responses = Object.entries(snapshot)
                .filter(([, response]) => response.answer !== null || response.status !== 'not_visited')
                .map(([questionId, response]) => ({
                    questionId,
                    answer: getPersistedAnswer(response.status, response.answer),
                    status: response.status,
                    isMarkedForReview: response.isMarkedForReview,
                    isVisited: response.status !== 'not_visited',
                    timeSpentSeconds: response.timeSpentSeconds,
                    visitCount: response.visitCount,
                }));

            if (responses.length === 0) return;

            const basePayload = {
                attemptId: aId,
                sessionToken: token,
                force_resume: true,
            };

            const fullPayload = JSON.stringify({ ...basePayload, responses });
            const fullBlob = new Blob([fullPayload], { type: 'application/json' });

            if (fullBlob.size <= MAX_BEACON_BYTES) {
                const sent = navigator.sendBeacon('/api/save-batch', fullBlob);
                if (sent) {
                    logger.info('sendBeacon batch save successful', { attemptId: aId, count: responses.length });
                } else {
                    logger.warn('sendBeacon batch save failed, attempting async flush', { attemptId: aId });
                    void flushNow();
                }
                return;
            }

            const chunks: typeof responses[] = [];
            let currentChunk: typeof responses = [];

            for (const item of responses) {
                currentChunk.push(item);
                const chunkPayload = JSON.stringify({ ...basePayload, responses: currentChunk });
                const chunkSize = new Blob([chunkPayload], { type: 'application/json' }).size;

                if (chunkSize > MAX_BEACON_BYTES) {
                    currentChunk.pop();
                    if (currentChunk.length === 0) {
                        logger.warn('sendBeacon payload too large, falling back to flush', { attemptId: aId });
                        void flushNow();
                        return;
                    }
                    chunks.push(currentChunk);
                    currentChunk = [item];
                }
            }

            if (currentChunk.length) {
                chunks.push(currentChunk);
            }

            for (const chunk of chunks) {
                const chunkPayload = JSON.stringify({ ...basePayload, responses: chunk });
                const sent = navigator.sendBeacon(
                    '/api/save-batch',
                    new Blob([chunkPayload], { type: 'application/json' })
                );
                if (!sent) {
                    logger.warn('sendBeacon chunk failed, attempting async flush', { attemptId: aId });
                    void flushNow();
                    return;
                }
            }
        };

        const handleVisibilityChange = () => {
            if (document.visibilityState === 'hidden') {
                sendBeaconBatchSave();
            }
        };

        const handlePageHide = () => {
            sendBeaconBatchSave();
        };

        const handleBeforeUnload = (event: BeforeUnloadEvent) => {
            const aId = attemptIdRef.current ?? attempt.id;
            if (!aId || !isInitialized) return;

            // CRITICAL FIX: Always try to save responses via beacon, even during submission
            // This ensures data is not lost if user reloads during auto-submit
            sendBeaconBatchSave();

            // Only show the "are you sure" prompt if NOT currently submitting
            if (isSubmittingRef.current || isAutoSubmittingRef.current) {
                // During submission, don't prompt but still save
                return;
            }

            event.preventDefault();
            event.returnValue = '';
        };

        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('pagehide', handlePageHide);
        window.addEventListener('beforeunload', handleBeforeUnload);

        return () => {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('pagehide', handlePageHide);
            window.removeEventListener('beforeunload', handleBeforeUnload);
        };
    }, [attempt.id, flushNow, isInitialized]);

    // Handle individual response save
    const handleSaveResponse = useCallback(
        async (questionId: string, answer: string | null) => {
            const aId = attemptIdRef.current ?? attempt.id;
            if (!aId) return;
            if (isDevSyncPaused()) return;
            if (isSubmittingRef.current || isAutoSubmittingRef.current) return;

            const snapshot = responsesRef.current;
            const response = snapshot[questionId];
            if (!response) return;

            const token = await ensureSessionToken({ reason: 'handleSaveResponse' });
            if (!token) return;

            const persistedAnswer = getPersistedAnswer(response.status, answer);

            const payload = {
                attemptId: aId,
                questionId,
                answer: persistedAnswer,
                status: response.status,
                isMarkedForReview: response.isMarkedForReview,
                isVisited: response.status !== 'not_visited',
                timeSpentSeconds: response.timeSpentSeconds,
                sessionToken: token,
            };

            try {
                const result = await saveResponse(payload);
                if (!result.success && result.error === 'SESSION_CONFLICT') {
                    setSessionConflict({ type: 'save', payload });
                }
            } catch (e) {
                logger.warn('Save response failed', e, { attemptId: aId, questionId });
            }
        },
        [attempt.id, ensureSessionToken]
    );

    // Handle section expiry
    const handleSectionExpire = useCallback(
        async (sectionName: SectionName) => {
            const aId = attemptIdRef.current ?? attempt.id;
            examLogger.sectionExpired(aId || '', sectionName);
            if (!aId) return;
            if (isDevSyncPaused()) return;

            setAutoSubmitting(true);
            debouncedSaveProgress.cancel();

            try {
                const token = await ensureSessionToken({ reason: 'handleSectionExpire' });
                if (!token) return;

                const sectionQuestions = questions.filter((q) => q.section === sectionName);
                const snapshot = responsesRef.current;

                await Promise.all(
                    sectionQuestions.map(async (q) => {
                        const response = snapshot[q.id];
                        if (!response || (response.answer === null && response.status === 'not_visited')) return;

                        const persistedAnswer = getPersistedAnswer(response.status, response.answer);

                        const payload = {
                            attemptId: aId,
                            questionId: q.id,
                            answer: persistedAnswer,
                            status: response.status,
                            isMarkedForReview: response.isMarkedForReview,
                            isVisited: response.status !== 'not_visited',
                            timeSpentSeconds: response.timeSpentSeconds,
                            sessionToken: token,
                        };

                        try {
                            const result = await saveResponse(payload);
                            if (!result.success && result.error === 'SESSION_CONFLICT') {
                                setSessionConflict({ type: 'save', payload });
                            }
                        } catch (e) {
                            logger.warn('Failed to save response on section expire', e, {
                                attemptId: aId,
                                questionId: q.id,
                            });
                        }
                    })
                );
            } finally {
                setAutoSubmitting(false);
            }
        },
        [attempt.id, ensureSessionToken, questions, setAutoSubmitting, debouncedSaveProgress]
    );

    // RACE CONDITION FIX: Mutex lock to prevent concurrent submits
    const submitLockRef = useRef<boolean>(false);

    // Helper: Aggressive cleanup of ALL exam localStorage keys
    const clearAllExamStates = useCallback(() => {
        clearAllExamState();
    }, []);

    // Handle exam submit
    const handleSubmitExam = useCallback(async () => {
        const aId = attemptIdRef.current ?? attempt.id;
        if (!aId) return;

        // CRITICAL: Atomic check-and-set IMMEDIATELY to prevent race conditions
        // This handles both timer auto-submit and manual submit racing
        if (submitLockRef.current) {
            logger.warn('Submit already in progress, ignoring duplicate call', { attemptId: aId });
            return;
        }
        submitLockRef.current = true;

        // Also check ref (belt and suspenders). Allow auto-submit to proceed.
        if (isSubmittingRef.current) {
            logger.warn('Submit blocked by isSubmitting flag', {
                attemptId: aId,
                isSubmitting: isSubmittingRef.current,
                isAutoSubmitting: isAutoSubmittingRef.current,
            });
            submitLockRef.current = false;
            return;
        }

        // Set submitting state IMMEDIATELY after lock to inform ExamLayout
        setSubmitting(true);

        debouncedSaveProgress.cancel();
        setUiError(null);

        const { data, error } = await sb().auth.getSession();
        if (error || !data?.session) {
            submitLockRef.current = false;
            setSubmitting(false);
            setShowAuthExpiredModal(true);
            setUiError('Your session has expired. Please sign in again to submit your exam.');
            return;
        }

        try {

            // Get a fresh token (best effort); if refresh fails, fallback to existing token.
            const activeSessionToken = await forceRefreshSessionToken();
            if (!activeSessionToken) {
                setUiError('Unable to establish session. Please check your connection and try again.');
                return;
            }

            const snapshot = responsesRef.current;

            examDebug.submitAttempt({
                attemptId: aId,
                sessionToken: activeSessionToken,
                submissionId: submissionIdRef.current,
                responsesCount: Object.keys(snapshot).length,
            });

            const saveResults: Array<{ questionId: string; success: boolean; error?: string }> = [];

            // Best-effort save before submit (do not block submit if some saves fail)
            try {
                await Promise.all(
                    Object.entries(snapshot).map(async ([questionId, response]) => {
                        if (response.answer === null && response.status === 'not_visited') return;

                        const persistedAnswer = getPersistedAnswer(response.status, response.answer);

                        const payload = {
                            attemptId: aId,
                            questionId,
                            answer: persistedAnswer,
                            status: response.status,
                            isMarkedForReview: response.isMarkedForReview,
                            isVisited: response.status !== 'not_visited',
                            timeSpentSeconds: response.timeSpentSeconds,
                            sessionToken: activeSessionToken,
                        };

                        try {
                            const r = await saveResponse(payload);
                            saveResults.push({ questionId, success: r.success, error: r.error });

                            if (!r.success && r.error === 'SESSION_CONFLICT') {
                                setSessionConflict({ type: 'save', payload });
                            }
                        } catch (err) {
                            logger.warn('Failed to save response during submit', err, { questionId, attemptId: aId });
                            saveResults.push({ questionId, success: false, error: 'SAVE_EXCEPTION' });
                        }
                    })
                );
            } catch (err) {
                logger.warn('Some responses failed to save during submit', err, { attemptId: aId });
            }

            const failedSaves = saveResults.filter((r) => !r.success);
            if (failedSaves.length > 0) {
                examDebug.warn('Some saves failed during submit', { failedSaves });
            }

            const clearLocalExamState = () => {
                // PHASE 2 FIX: Aggressive cleanup - remove ALL cat-exam-state-* keys
                // to prevent zombie states from different/stale attempts
                clearAllExamStates();
            };

            // CRITICAL FIX: Always use force_resume to prevent session conflicts
            // The server now automatically handles session recovery
            const result = await submitExam({
                attemptId: aId,
                sessionToken: activeSessionToken,
                submissionId: submissionIdRef.current,
                force_resume: true, // Always force_resume to prevent stuck submissions
            });

            examDebug.submitResult({
                success: result.success,
                error: result.error,
                attemptId: aId,
            });

            if (result.success) {
                clearLocalExamState();
                router.replace(`/result/${aId}`);
                return;
            }

            const invalidStatus =
                result.error === 'Attempt is not in progress' ||
                result.error === 'INVALID_ATTEMPT_STATUS' ||
                result.error?.toLowerCase().includes('already submitted');
            if (invalidStatus) {
                try {
                    const res = await fetch('/api/attempt-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ attemptId: aId }),
                    });
                    const payload = await res.json().catch(() => ({}));
                    const statusCheck = payload?.data?.status as string | undefined;

                    if (statusCheck === 'submitted' || statusCheck === 'completed') {
                        clearLocalExamState();
                        router.replace(`/result/${aId}`);
                        return;
                    }
                } catch (checkError) {
                    logger.warn('Failed to check attempt status after invalid status', checkError);
                }
            }

            if (result.error === 'Unauthorized' || result.error === 'Authentication required') {
                setShowAuthExpiredModal(true);
                setUiError('Your session has expired. Please sign in again to submit your exam.');
                return;
            }

            if (result.error === 'ATTEMPT_NOT_FOUND' || result.error?.toLowerCase().includes('attempt not found')) {
                // PHASE 2 FIX: Use aggressive cleanup on ATTEMPT_NOT_FOUND
                clearAllExamStates();
                setUiError('This exam attempt was removed. Please restart from the dashboard.');
                router.push('/dashboard');
                return;
            }

            // Session conflict -> let user decide
            if (result.error === 'SESSION_CONFLICT') {
                setSessionConflict({ type: 'submit' });
                return;
            }

            // If validation failed, retry IMMEDIATELY using the SAME token + force_resume.
            // This avoids needing a second token refresh that can fail and leave you stuck.
            const looksLikeSessionValidationFailure =
                result.error === 'Failed to validate session' ||
                result.error === 'INVALID_SESSION_TOKEN' ||
                result.error === 'Missing session token' ||
                (typeof result.error === 'string' && result.error.toLowerCase().includes('session'));

            if (looksLikeSessionValidationFailure) {
                const retry = await submitExam({
                    attemptId: aId,
                    sessionToken: activeSessionToken,
                    submissionId: submissionIdRef.current,
                    force_resume: true,
                });

                if (retry.success) {
                    clearLocalExamState();
                    router.replace(`/result/${aId}`);
                    return;
                }

                if (retry.error === 'SESSION_CONFLICT') {
                    setSessionConflict({ type: 'submit' });
                    return;
                }

                // If server reports stale force-resume token, refresh once and retry force-resume.
                if (retry.error === 'FORCE_RESUME_STALE') {
                    const refreshed = await forceRefreshSessionToken();
                    if (refreshed) {
                        const retry2 = await submitExam({
                            attemptId: aId,
                            sessionToken: refreshed,
                            submissionId: submissionIdRef.current,
                            force_resume: true,
                        });

                        if (retry2.success) {
                            clearLocalExamState();
                            router.replace(`/result/${aId}`);
                            return;
                        }

                        if (retry2.error === 'SESSION_CONFLICT') {
                            setSessionConflict({ type: 'submit' });
                            return;
                        }

                        logger.error('Submit retry (stale->refresh) failed', retry2.error, { attemptId: aId });
                        setUiError('Failed to submit exam. Please try again.');
                        return;
                    }
                }

                logger.error('Submit retry (force_resume) failed', retry.error, { attemptId: aId });
                setUiError('Failed to submit exam. Please try again.');
                return;
            }

            // Non-session-related errors
            logger.error('Failed to submit exam', result.error, { attemptId: aId });

            const finalError = result.error;

            const errorMessage =
                finalError === 'INVALID_ATTEMPT_STATUS' ||
                    finalError?.toLowerCase().includes('already submitted')
                    ? 'Exam has already been submitted or is in an invalid state.'
                    : finalError === 'Attempt not found' || finalError?.toLowerCase().includes('attempt not found')
                        ? 'This exam attempt no longer exists. Please restart the exam.'
                        : finalError === 'INVALID_SESSION_TOKEN' || finalError?.toLowerCase().includes('session')
                            ? 'Session expired. Please try submitting again.'
                            : `Failed to submit exam. Please try again. (${finalError || 'Unknown error'})`;

            setUiError(errorMessage);
        } finally {
            setSubmitting(false);
            submitLockRef.current = false; // Release the mutex lock
        }
    }, [attempt.id, forceRefreshSessionToken, router, setSubmitting, debouncedSaveProgress, clearAllExamStates]);

    const handleResolveConflict = useCallback(
        async (resumeHere: boolean) => {
            if (!sessionConflict) return;

            if (!resumeHere) {
                setSessionConflict(null);
                return;
            }

            setIsResolvingConflict(true);
            try {
                const aId = attemptIdRef.current ?? attempt.id;
                if (!aId) return;

                // Always refresh token before force-resume actions to avoid stale/empty token
                const refreshedToken = await forceRefreshSessionToken();

                if (sessionConflict.type === 'save') {
                    const retry = await saveResponse({
                        ...sessionConflict.payload,
                        sessionToken: refreshedToken ?? sessionConflict.payload.sessionToken,
                        force_resume: true,
                    });

                    if (!retry.success && retry.error !== 'SESSION_CONFLICT') {
                        logger.error('Force resume save failed', retry.error, { attemptId: aId });
                    }
                }

                if (sessionConflict.type === 'submit') {
                    if (!refreshedToken) {
                        setUiError('Unable to establish session. Please try again.');
                        return;
                    }

                    const retry = await submitExam({
                        attemptId: aId,
                        sessionToken: refreshedToken,
                        force_resume: true,
                        submissionId: submissionIdRef.current,
                    });

                    if (retry.success) {
                        clearAllExamStates();
                        router.replace(`/result/${aId}`);
                    } else if (retry.error === 'ATTEMPT_NOT_FOUND' || retry.error?.toLowerCase().includes('attempt not found')) {
                        clearAllExamStates();
                        setUiError('This exam attempt was removed. Please restart from the dashboard.');
                        router.push('/dashboard');
                    } else if (retry.error !== 'SESSION_CONFLICT') {
                        logger.error('Force resume submit failed', retry.error, { attemptId: aId });
                        setUiError('Failed to submit exam. Please try again.');
                    }
                }
            } finally {
                setIsResolvingConflict(false);
                setSessionConflict(null);
            }
        },
        [attempt.id, sessionConflict, forceRefreshSessionToken, router]
    );

    // Handle pause exam
    const handlePauseExam = useCallback(async () => {
        const aId = attemptIdRef.current ?? attempt.id;
        if (!aId) return;

        if (paper.allow_pause === false) {
            setUiError('Pausing is not allowed for this exam.');
            return;
        }

        setUiError(null);

        const confirmed = window.confirm(
            'Are you sure you want to pause the exam? You can resume it later from the dashboard.'
        );
        if (!confirmed) return;

        const token = await ensureSessionToken({ reason: 'handlePauseExam' });
        const snapshot = responsesRef.current;

        // Best-effort save before pausing (do not fail pause if some saves fail)
        if (token) {
            await Promise.all(
                Object.entries(snapshot).map(async ([questionId, response]) => {
                    if (response.answer === null && response.status === 'not_visited') return;

                    const persistedAnswer = getPersistedAnswer(response.status, response.answer);

                    try {
                        await saveResponse({
                            attemptId: aId,
                            questionId,
                            answer: persistedAnswer,
                            status: response.status,
                            isMarkedForReview: response.isMarkedForReview,
                            isVisited: response.status !== 'not_visited',
                            timeSpentSeconds: response.timeSpentSeconds,
                            sessionToken: token,
                        });
                    } catch (e) {
                        logger.warn('Failed to save response during pause', e, { attemptId: aId, questionId });
                    }
                })
            );
        }

        const timeRemaining = buildTimeRemainingSafe(sectionTimersRef.current);
        if (!timeRemaining) {
            setUiError('Failed to pause exam. Please try again.');
            return;
        }

        try {
            const result = await pauseExam({
                attemptId: aId,
                timeRemaining,
                currentSection: getSectionByIndex(currentSectionIndexRef.current),
                currentQuestion: currentQuestionIndexRef.current + 1,
                sessionToken: token ?? undefined,
            });

            if (result.success) {
                clearAllExamStates();
                router.push('/dashboard');
            } else {
                examLogger.examPaused(aId, false, result.error);
                setUiError('Failed to pause exam. Please try again.');
            }
        } catch (e) {
            examLogger.examPaused(aId, false, 'PAUSE_EXCEPTION');
            logger.warn('Pause exam failed', e, { attemptId: aId });
            setUiError('Failed to pause exam. Please try again.');
        }
    }, [attempt.id, ensureSessionToken, router, paper.allow_pause]);

    // Show loading while initializing
    if (!hasHydrated || !isInitialized) {
        return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4" />
                    <p className="text-gray-600">Loading exam...</p>
                </div>
            </div>
        );
    }

    return (
        <>
            {uiError && (
                <div className="px-6 py-3 bg-red-50 border-b border-red-200 text-red-700 text-sm" role="alert">
                    {uiError}
                </div>
            )}

            {showAuthExpiredModal && (
                <div
                    className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4"
                    role="dialog"
                    aria-modal="true"
                >
                    <div className="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl border border-gray-200">
                        <h2 className="text-lg font-semibold text-gray-900">Session expired</h2>
                        <p className="mt-2 text-sm text-gray-600">
                            Your login session has expired. Please sign in again to submit your exam safely.
                        </p>
                        <div className="mt-6 flex items-center justify-end gap-3">
                            <button
                                type="button"
                                onClick={() => setShowAuthExpiredModal(false)}
                                className="inline-flex items-center justify-center rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                            >
                                Not now
                            </button>
                            <button
                                type="button"
                                onClick={() => {
                                    const redirectTo =
                                        typeof window !== 'undefined'
                                            ? `${window.location.pathname}${window.location.search}`
                                            : `/exam/${attemptIdRef.current ?? attempt.id}`;
                                    router.push(`/auth/sign-in?redirect_to=${encodeURIComponent(redirectTo)}`);
                                }}
                                className="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700"
                            >
                                Sign in
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <ExamLayout
                paper={paper}
                questions={questions}
                onSaveResponse={handleSaveResponse}
                onSubmitExam={handleSubmitExam}
                onSectionExpire={handleSectionExpire}
                onPauseExam={handlePauseExam}
                layoutMode={EXAM_LAYOUT_MODE}
            />

            {sessionConflict && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                        <h3 className="text-lg font-semibold text-gray-800 mb-2">Active session detected</h3>
                        <p className="text-sm text-gray-600 mb-6">
                            You have an active session on another device. Do you want to terminate it and resume here?
                        </p>
                        <div className="flex items-center justify-end gap-3">
                            <button
                                type="button"
                                onClick={() => handleResolveConflict(false)}
                                className="px-4 py-2 text-sm rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50"
                                disabled={isResolvingConflict}
                            >
                                Cancel
                            </button>
                            <button
                                type="button"
                                onClick={() => handleResolveConflict(true)}
                                className="px-4 py-2 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700"
                                disabled={isResolvingConflict}
                            >
                                {isResolvingConflict ? 'Resuming...' : 'Resume Here'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Dev-only testing panel - completely removed in production */}
            {process.env.NODE_ENV === 'development' && (
                <DevToolsPanel onTriggerSubmit={handleSubmitExam} />
            )}
        </>
    );
}
````

## File: middleware.ts
````typescript
/**
 * @fileoverview Next.js Middleware
 * @description Auth session management and security headers
 * @blueprint Security Audit - P0 Fix - Security Headers
 * 
 * CRITICAL FIX (2026-02-02): 
 * - Avoid double Supabase client creation (was causing cookie race conditions)
 * - Skip session refresh for API routes (they handle their own auth)
 * - Single client instance for protected route checks
 */

import { NextRequest, NextResponse } from 'next/server';
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { fetchAccessStatus, resolveIsAdmin } from '@/lib/access-control';
import { incrementMetric } from '@/lib/telemetry';

/**
 * Apply security headers to response
 * @blueprint Security Audit - P0 Fix - Prevent clickjacking, XSS, MIME sniffing
 */
function applySecurityHeaders(res: NextResponse): NextResponse {
    // Prevent MIME type sniffing
    res.headers.set('X-Content-Type-Options', 'nosniff');

    // Prevent clickjacking - only allow same origin framing
    res.headers.set('X-Frame-Options', 'SAMEORIGIN');

    // Legacy XSS protection for older browsers
    res.headers.set('X-XSS-Protection', '1; mode=block');

    // Control referrer information sent with requests
    res.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');

    // Prevent caching of sensitive pages (exam content)
    res.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');
    res.headers.set('Pragma', 'no-cache');
    res.headers.set('Expires', '0');

    return res;
}

/**
 * Get Supabase configuration from environment
 */
function getSupabaseConfig(): { url: string; anonKey: string } | null {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

    if (!url || !anonKey) {
        console.error('Middleware: Missing Supabase configuration');
        return null;
    }

    return { url, anonKey };
}

export async function middleware(req: NextRequest) {
    const pathname = req.nextUrl.pathname;

    // =========================================================================
    // API ROUTES: Skip middleware auth entirely - APIs handle their own auth
    // This prevents token refresh race conditions during exam submit
    // =========================================================================
    if (pathname.startsWith('/api/')) {
        const res = NextResponse.next({ request: { headers: req.headers } });
        applySecurityHeaders(res);
        return res;
    }

    // =========================================================================
    // PAGE ROUTES: Handle session refresh and protection
    // =========================================================================

    // Create response object
    const res = NextResponse.next({ request: { headers: req.headers } });
    applySecurityHeaders(res);

    // Block test login in production
    if (pathname.startsWith('/auth/test-login') && process.env.NODE_ENV === 'production') {
        return NextResponse.redirect(new URL('/auth/sign-in', req.url));
    }

    // Determine if route needs protection
    const isProtected = pathname.startsWith('/exam/') ||
        pathname.startsWith('/result/') ||
        pathname.startsWith('/dashboard') ||
        pathname.startsWith('/mocks') ||
        pathname.startsWith('/mock/');
    const isAdminRoute = pathname.startsWith('/admin');
    const needsAuthCheck = isProtected || isAdminRoute || pathname === '/coming-soon';

    // Only create Supabase client if we need to check auth
    if (!needsAuthCheck) {
        return res;
    }

    // Get Supabase config
    const config = getSupabaseConfig();
    if (!config) {
        // Allow request to proceed - let page handle the error
        return res;
    }

    try {
        // Create SINGLE Supabase client for this request
        const supabase = createServerClient(config.url, config.anonKey, {
            cookies: {
                getAll() {
                    return req.cookies.getAll();
                },
                setAll(cookiesToSet: Array<{ name: string; value: string; options: CookieOptions }>) {
                    cookiesToSet.forEach(({ name, value, options }) => {
                        res.cookies.set({ name, value, ...options });
                    });
                },
            },
        });

        // Get user (this also refreshes session if needed)
        const { data: { user }, error: userError } = await supabase.auth.getUser();

        if (userError || !user) {
            // Not authenticated - redirect to sign in
            const redirect = new URL('/auth/sign-in', req.url);
            const returnTo = pathname + (req.nextUrl.search || '');
            redirect.searchParams.set('redirect_to', returnTo);
            return NextResponse.redirect(redirect);
        }

        const env = process.env.NODE_ENV;
        const skipAdminCheck =
            process.env.SKIP_ADMIN_CHECK === 'true' && (env === 'development' || env === 'test');

        const isAdmin = skipAdminCheck ? true : await resolveIsAdmin(supabase, user);

        // Admin routes require admin role
        if (isAdminRoute && !skipAdminCheck && !isAdmin) {
            const redirect = new URL('/dashboard', req.url);
            redirect.searchParams.set('error', 'unauthorized');
            return NextResponse.redirect(redirect);
        }

        // Access gating for protected routes (non-admins only)
        if (isProtected && !isAdmin) {
            const accessStatus = await fetchAccessStatus(supabase, user.id);
            if (accessStatus !== 'active') {
                const redirect = new URL('/coming-soon', req.url);
                const returnTo = pathname + (req.nextUrl.search || '');
                redirect.searchParams.set('redirect_to', returnTo);
                return NextResponse.redirect(redirect);
            }
        }

        return res;
    } catch (err) {
        console.error('Middleware error:', err);
        incrementMetric('middleware_error');
        // On error, allow request to proceed - let page handle the error
        return res;
    }
}

export const config = {
    matcher: [
        '/dashboard/:path*',
        '/exam/:path*',
        '/result/:path*',
        '/mocks/:path*',
        '/mock/:path*',
        '/admin/:path*',
        '/coming-soon',
        '/auth/test-login',
        // API routes included only for security headers - auth skipped
        '/api/:path*',
    ],
};
````

## File: src/app/dashboard/page.tsx
````typescript
import Link from 'next/link';
import { sbSSR } from '@/lib/supabase/server';

type Attempt = {
    id: string;
    paper_id: string;
    status: string;
    total_score: number | null;
    max_possible_score: number | null;
    accuracy: number | null;
    percentile: number | null;
    rank: number | null;
    correct_count: number | null;
    incorrect_count: number | null;
    started_at: string | null;
    completed_at: string | null;
    time_taken_seconds: number | null;
    papers: { title: string; total_marks: number } | null;
};

type UserProfile = {
    id: string;
    name: string | null;
    email: string;
    avatar_url: string | null;
    total_mocks_taken: number;
    best_percentile: number | null;
    target_percentile: number | null;
};

export default async function DashboardPage({
    searchParams,
}: {
    searchParams: Promise<{ error?: string }>;
}) {
    const params = await searchParams;
    const supabase = await sbSSR();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
        return (
            <main style={{ padding: 24, maxWidth: 1000, margin: '0 auto' }}>
                <h1>My Dashboard</h1>
                <p>You need to sign in to access your dashboard.</p>
                <Link href="/auth/sign-in?redirect_to=/dashboard" style={{
                    display: 'inline-block',
                    padding: '12px 24px',
                    background: '#1976d2',
                    color: 'white',
                    textDecoration: 'none',
                    borderRadius: 6
                }}>Sign In</Link>
            </main>
        );
    }

    // Get user profile
    const { data: profile } = await supabase
        .from('users')
        .select('id, name, email, avatar_url, total_mocks_taken, best_percentile, target_percentile')
        .eq('id', user.id)
        .maybeSingle() as { data: UserProfile | null };

    // Get attempts with paper details
    const { data, error } = await supabase
        .from('attempts')
        .select(`
            id, paper_id, status, total_score, max_possible_score, accuracy, percentile, rank,
            correct_count, incorrect_count, started_at, completed_at, time_taken_seconds,
            papers (title, total_marks)
        `)
        .eq('user_id', user.id)
        .order('started_at', { ascending: false });

    const attempts: Attempt[] = (data ?? []).map(a => ({
        ...a,
        papers: Array.isArray(a.papers) ? a.papers[0] : a.papers
    }));

    // Calculate stats
    const completedAttempts = attempts.filter(a => a.status === 'completed');
    const totalMocks = completedAttempts.length;
    const averageScore = totalMocks > 0
        ? completedAttempts.reduce((sum, a) => sum + (a.total_score || 0), 0) / totalMocks
        : 0;
    const bestScore = totalMocks > 0
        ? Math.max(...completedAttempts.map(a => a.total_score || 0))
        : 0;
    const bestPercentile = totalMocks > 0
        ? Math.max(...completedAttempts.map(a => a.percentile || 0))
        : 0;

    const formatTime = (seconds: number | null) => {
        if (!seconds && seconds !== 0) return '—';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        const paddedSecs = secs.toString().padStart(2, '0');
        return `${mins}m ${paddedSecs}s`;
    };

    const getStatusColor = (status: string) => {
        switch (status) {
            case 'completed': return '#4caf50';
            case 'in_progress': return '#ff9800';
            case 'paused': return '#f57c00';
            case 'abandoned': return '#9e9e9e';
            default: return '#666';
        }
    };

    return (
        <main style={{ padding: 24, maxWidth: 1000, margin: '0 auto' }}>
            {/* Unauthorized Error Banner */}
            {params.error === 'unauthorized' && (
                <div style={{
                    padding: '12px 16px',
                    background: '#ffebee',
                    border: '1px solid #ef5350',
                    borderRadius: 8,
                    marginBottom: 24,
                    color: '#c62828',
                    display: 'flex',
                    alignItems: 'center',
                    gap: 12
                }}>
                    <span style={{ fontSize: 20 }}>⚠️</span>
                    <span>You don&apos;t have admin access. Contact the administrator to request access.</span>
                </div>
            )}

            {/* Header */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 32 }}>
                <div>
                    <h1 style={{ margin: 0 }}>My Dashboard</h1>
                    <p style={{ margin: '8px 0 0', color: '#666' }}>
                        Welcome back, {profile?.name || user.email}
                    </p>
                </div>
                <div style={{ display: 'flex', gap: 12 }}>
                    <Link href="/admin" style={{
                        padding: '12px 24px',
                        background: '#0b3d91',
                        color: 'white',
                        textDecoration: 'none',
                        borderRadius: 6,
                        fontWeight: 'bold'
                    }}>Admin Panel</Link>
                    <Link href="/mocks" style={{
                        padding: '12px 24px',
                        background: '#1976d2',
                        color: 'white',
                        textDecoration: 'none',
                        borderRadius: 6,
                        fontWeight: 'bold'
                    }}>Take New Mock</Link>
                    <a href="/auth/logout" style={{
                        padding: '12px 24px',
                        background: '#f5f5f5',
                        color: '#666',
                        textDecoration: 'none',
                        borderRadius: 6,
                        fontWeight: 'bold',
                        border: '1px solid #ddd'
                    }}>Logout</a>
                </div>
            </div>

            {/* Stats Cards */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(4, 1fr)',
                gap: 16,
                marginBottom: 32
            }}>
                <div style={{ padding: 20, background: '#e3f2fd', borderRadius: 12, textAlign: 'center' }}>
                    <p style={{ margin: 0, fontSize: 14, color: '#1976d2' }}>Mocks Completed</p>
                    <p style={{ margin: '8px 0 0', fontSize: 32, fontWeight: 'bold', color: '#1976d2' }}>{totalMocks}</p>
                </div>
                <div style={{ padding: 20, background: '#e8f5e9', borderRadius: 12, textAlign: 'center' }}>
                    <p style={{ margin: 0, fontSize: 14, color: '#4caf50' }}>Best Score</p>
                    <p style={{ margin: '8px 0 0', fontSize: 32, fontWeight: 'bold', color: '#4caf50' }}>{bestScore.toFixed(0)}</p>
                </div>
                <div style={{ padding: 20, background: '#fff3e0', borderRadius: 12, textAlign: 'center' }}>
                    <p style={{ margin: 0, fontSize: 14, color: '#ff9800' }}>Average Score</p>
                    <p style={{ margin: '8px 0 0', fontSize: 32, fontWeight: 'bold', color: '#ff9800' }}>{averageScore.toFixed(1)}</p>
                </div>
                <div style={{ padding: 20, background: '#f3e5f5', borderRadius: 12, textAlign: 'center' }}>
                    <p style={{ margin: 0, fontSize: 14, color: '#9c27b0' }}>Best Percentile</p>
                    <p style={{ margin: '8px 0 0', fontSize: 32, fontWeight: 'bold', color: '#9c27b0' }}>
                        {bestPercentile > 0 ? bestPercentile.toFixed(1) : '—'}
                    </p>
                </div>
            </div>

            {/* Target Progress */}
            {profile?.target_percentile && (
                <div style={{
                    padding: 20,
                    background: '#f5f5f5',
                    borderRadius: 12,
                    marginBottom: 32
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
                        <span>Progress to Target ({profile.target_percentile}%ile)</span>
                        <span>{bestPercentile > 0 ? `${((bestPercentile / profile.target_percentile) * 100).toFixed(0)}%` : '0%'}</span>
                    </div>
                    <div style={{ height: 8, background: '#ddd', borderRadius: 4, overflow: 'hidden' }}>
                        <div style={{
                            height: '100%',
                            width: `${Math.min((bestPercentile / profile.target_percentile) * 100, 100)}%`,
                            background: '#4caf50',
                            borderRadius: 4
                        }}></div>
                    </div>
                </div>
            )}

            {/* Attempts List */}
            <h2 style={{ marginBottom: 16 }}>My Attempts</h2>
            {error ? (
                <p style={{ color: 'crimson' }}>Failed to load attempts. Please try again later.</p>
            ) : attempts.length === 0 ? (
                <div style={{ textAlign: 'center', padding: 48, background: '#f5f5f5', borderRadius: 12 }}>
                    <h3>No attempts yet</h3>
                    <p style={{ color: '#666' }}>Start your CAT preparation by taking a mock test!</p>
                    <Link href="/mocks" style={{
                        display: 'inline-block',
                        marginTop: 16,
                        padding: '12px 24px',
                        background: '#1976d2',
                        color: 'white',
                        textDecoration: 'none',
                        borderRadius: 6
                    }}>Browse Mocks</Link>
                </div>
            ) : (
                <div style={{ border: '1px solid #ddd', borderRadius: 12, overflow: 'hidden' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                            <tr style={{ background: '#f5f5f5' }}>
                                <th style={{ padding: 12, textAlign: 'left', borderBottom: '1px solid #ddd' }}>Paper</th>
                                <th style={{ padding: 12, textAlign: 'center', borderBottom: '1px solid #ddd' }}>Status</th>
                                <th style={{ padding: 12, textAlign: 'center', borderBottom: '1px solid #ddd' }}>Score</th>
                                <th style={{ padding: 12, textAlign: 'center', borderBottom: '1px solid #ddd' }}>Accuracy</th>
                                <th style={{ padding: 12, textAlign: 'center', borderBottom: '1px solid #ddd' }}>Percentile</th>
                                <th style={{ padding: 12, textAlign: 'center', borderBottom: '1px solid #ddd' }}>
                                    <div title="Duration (not submission timestamp)">Time Taken</div>
                                    <div style={{ fontSize: 11, color: '#777', marginTop: 2 }}>Duration</div>
                                </th>
                                <th style={{ padding: 12, textAlign: 'center', borderBottom: '1px solid #ddd' }}>Date</th>
                                <th style={{ padding: 12, textAlign: 'center', borderBottom: '1px solid #ddd' }}>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {attempts.map((a) => (
                                <tr key={a.id} style={{ borderBottom: '1px solid #eee' }}>
                                    <td style={{ padding: 12 }}>
                                        <strong>{a.papers?.title ?? `Paper ${a.paper_id.slice(0, 8)}…`}</strong>
                                    </td>
                                    <td style={{ padding: 12, textAlign: 'center' }}>
                                        <span style={{
                                            padding: '4px 8px',
                                            background: getStatusColor(a.status),
                                            color: 'white',
                                            borderRadius: 4,
                                            fontSize: 12,
                                            fontWeight: 'bold'
                                        }}>{a.status.replace('_', ' ').toUpperCase()}</span>
                                    </td>
                                    <td style={{ padding: 12, textAlign: 'center', fontWeight: 'bold' }}>
                                        {a.total_score !== null ? `${a.total_score}/${a.max_possible_score || a.papers?.total_marks || 198}` : '—'}
                                    </td>
                                    <td style={{ padding: 12, textAlign: 'center' }}>
                                        {a.accuracy !== null ? `${a.accuracy.toFixed(1)}%` : '—'}
                                    </td>
                                    <td style={{ padding: 12, textAlign: 'center' }}>
                                        {a.percentile !== null ? a.percentile.toFixed(1) : '—'}
                                    </td>
                                    <td style={{ padding: 12, textAlign: 'center' }}>
                                        {formatTime(a.time_taken_seconds)}
                                    </td>
                                    <td style={{ padding: 12, textAlign: 'center', color: '#666', fontSize: 13 }}>
                                        {a.started_at ? new Date(a.started_at).toLocaleDateString() : '—'}
                                    </td>
                                    <td style={{ padding: 12, textAlign: 'center' }}>
                                        {a.status === 'in_progress' || a.status === 'paused' ? (
                                            <Link href={`/exam/${a.id}`} style={{
                                                color: '#ff9800',
                                                fontWeight: 'bold',
                                                textDecoration: 'none'
                                            }}>Continue</Link>
                                        ) : a.status === 'completed' ? (
                                            <Link href={`/result/${a.id}`} style={{
                                                color: '#1976d2',
                                                fontWeight: 'bold',
                                                textDecoration: 'none'
                                            }}>View Result</Link>
                                        ) : (
                                            <span style={{ color: '#999' }}>—</span>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </main>
    );
}
````

## File: src/features/exam-engine/model/useExamStore.ts
````typescript
/**
 * @fileoverview Exam Engine Zustand Store
 * @description Global state management for the CAT exam engine with localStorage persistence
 * @blueprint Milestone 4 SOP-SSOT - Phase 1.2
 * @architecture Uses Zustand with persist middleware for offline resilience
 *
 * PHASE 1 FIX: Attempt-scoped persistence + proper resume position
 * PHASE 2 FIX: Consolidated marking logic with proper status transitions
 */

import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { logger } from '@/lib/logger';
import { examDebug, cleanupOrphanedExamState, clearAllExamState } from '@/lib/examDebug';
import type {
    ExamStore,
    ExamData,
    ResponseState,
    SectionName,
    SectionTimerState,
    QuestionStatus,
    Question,
    PerformanceReason,
} from '@/types/exam';
import {
    SECTION_ORDER,
    getSectionByIndex,
    getSectionDurationSecondsMap,
    calculateQuestionStatus,
} from '@/types/exam';

type MutableSectionTimerState = {
    sectionName: SectionName;
    startedAt: number;
    durationSeconds: number;
    remainingSeconds: number;
    isExpired: boolean;
};

type MutableSectionTimers = Record<SectionName, MutableSectionTimerState>;

// =============================================================================
// SAFE STORAGE (SSR GUARD)
// =============================================================================

const noopStorage: Storage = {
    getItem: () => null,
    setItem: () => {
        /* noop */
    },
    removeItem: () => {
        /* noop */
    },
    clear: () => {
        /* noop */
    },
    key: () => null,
    length: 0,
};

// =============================================================================
// INITIAL STATE
// =============================================================================

const createInitialTimerState = (sectionName: SectionName, durationSeconds: number): MutableSectionTimerState => ({
    sectionName,
    startedAt: 0,
    durationSeconds,
    remainingSeconds: durationSeconds,
    isExpired: false,
});

const initialState: Omit<ExamStore, keyof import('@/types/exam').ExamEngineActions> = {
    // Hydration
    hasHydrated: false,
    // Initialization
    isInitialized: false,

    // Exam metadata
    attemptId: null,
    paperId: null,
    sessionToken: null, // P0 FIX: Session token for multi-device/tab prevention

    // Navigation
    currentSectionIndex: 0,
    currentQuestionIndex: 0,

    // Section locking
    lockedSections: [],

    // Responses
    responses: {},

    // Pending sync queue (local-first responses awaiting backend sync)
    pendingSyncResponses: {},
    lastSyncTimestamp: 0,

    // Timer state per section
    sectionTimers: (() => {
        const defaults = getSectionDurationSecondsMap();
        return {
            VARC: createInitialTimerState('VARC', defaults.VARC),
            DILR: createInitialTimerState('DILR', defaults.DILR),
            QA: createInitialTimerState('QA', defaults.QA),
        };
    })(),

    // Question tracking
    visitedQuestions: new Set<string>(),
    markedQuestions: new Set<string>(),

    // Submission state
    isSubmitting: false,
    isAutoSubmitting: false,
};

// =============================================================================
// STORE CREATION
// =============================================================================

/**
 * Creates an exam store with optional persistence
 * @param attemptId - If provided, enables localStorage persistence keyed to this attempt
 */
export const createExamStore = (attemptId?: string) => {
    const storeName = attemptId ? `cat-exam-state-${attemptId}` : 'cat-exam-state-temp';

    // PHASE 0: Clean up orphaned temp state on store creation
    if (typeof window !== 'undefined') {
        cleanupOrphanedExamState();
    }

    examDebug.log('Creating exam store', { attemptId, storeName });

    return create<ExamStore>()(
        persist(
            (set, get) => ({
                ...initialState,

                // =====================================================================
                // INITIALIZATION
                // =====================================================================

                initializeExam: (data: ExamData) => {
                    const { paper, questions, attempt, responses: serverResponses } = data;
                    let currentState = get();

                    // PHASE 2 FIX: If the persisted state belongs to a different attempt, NUKE ALL exam state.
                    // This prevents zombie states where localStorage holds an old attemptId that no longer exists.
                    if (currentState.attemptId && currentState.attemptId !== attempt.id) {
                        try {
                            clearAllExamState();
                        } catch {
                            // best-effort cleanup
                        }
                        // Reset in-memory state to avoid reusing stale attemptId/timers.
                        set({
                            ...initialState,
                            hasHydrated: false,
                            isInitialized: false,
                        });
                        currentState = get();
                    }

                    // PHASE 1 FIX: Check if we're resuming the same attempt with persisted state
                    const normalizeSectionName = (value?: string | null): SectionName => {
                        const normalized = (value ?? '').toUpperCase().trim();
                        if (normalized === 'LRDI') return 'DILR';
                        if (normalized === 'QUANT' || normalized === 'QUANTS') return 'QA';
                        if (normalized === 'VARC' || normalized === 'DILR' || normalized === 'QA') {
                            return normalized as SectionName;
                        }
                        return 'VARC';
                    };

                    if (currentState.attemptId === attempt.id && currentState.hasHydrated) {
                        const now = Date.now();
                        const sectionDurations = getSectionDurationSecondsMap(paper.sections);
                        const serverTimeRemaining = attempt.time_remaining ?? {};
                        const resumeSection = normalizeSectionName(attempt.current_section as string | null | undefined);

                        const sections: SectionName[] = ['VARC', 'DILR', 'QA'];
                        const nextSectionTimers = { ...currentState.sectionTimers } as MutableSectionTimers;

                        for (const section of sections) {
                            const duration = sectionDurations[section];
                            const localTimer = currentState.sectionTimers[section];
                            const localRemaining =
                                typeof localTimer?.remainingSeconds === 'number' ? localTimer.remainingSeconds : duration;
                            const serverRemaining =
                                typeof (serverTimeRemaining as Partial<Record<SectionName, number>>)[section] === 'number'
                                    ? (serverTimeRemaining as Partial<Record<SectionName, number>>)[section]!
                                    : null;

                            let mergedRemaining = serverRemaining !== null
                                ? (localRemaining <= 0 && serverRemaining > 0
                                    ? serverRemaining
                                    : Math.min(localRemaining, serverRemaining))
                                : localRemaining;
                            if (serverRemaining !== null && serverRemaining <= 0 && localRemaining <= 0) {
                                // Avoid instant auto-submit on resume when server/local timers are stale.
                                mergedRemaining = duration;
                            }
                            const clampedRemaining = Math.max(0, Math.min(duration, mergedRemaining));

                            const shouldHaveStarted =
                                section === resumeSection ||
                                localTimer.startedAt > 0 ||
                                clampedRemaining < duration;

                            const nextStartedAt = shouldHaveStarted
                                ? now - (duration - clampedRemaining) * 1000
                                : 0;

                            nextSectionTimers[section] = {
                                ...localTimer,
                                durationSeconds: duration,
                                remainingSeconds: clampedRemaining,
                                startedAt: shouldHaveStarted ? nextStartedAt : 0,
                                isExpired:
                                    serverRemaining !== null
                                        ? clampedRemaining <= 0 && serverRemaining > 0
                                        : (localTimer.isExpired || clampedRemaining <= 0),
                            };
                        }

                        const serverSection = resumeSection;
                        const serverSectionIndex = SECTION_ORDER[serverSection];
                        let nextSectionIndex = currentState.currentSectionIndex;
                        let nextQuestionIndex = currentState.currentQuestionIndex;

                        if (serverSectionIndex > currentState.currentSectionIndex) {
                            nextSectionIndex = serverSectionIndex;
                            nextQuestionIndex = Math.max(0, (attempt.current_question ?? 1) - 1);
                        } else if (serverSectionIndex === currentState.currentSectionIndex && attempt.current_question) {
                            nextQuestionIndex = Math.max(currentState.currentQuestionIndex, attempt.current_question - 1);
                        }

                        const lockedSections = new Set(currentState.lockedSections);
                        for (let i = 0; i < nextSectionIndex; i++) {
                            lockedSections.add(getSectionByIndex(i));
                        }

                        // PHASE 5 FIX: Merge server responses with local state to recover any
                        // answers that were saved to DB but not in localStorage
                        const mergedResponses = { ...currentState.responses };
                        if (serverResponses && serverResponses.length > 0) {
                            serverResponses.forEach((r) => {
                                const localResponse = mergedResponses[r.question_id];
                                if (!localResponse) return;

                                const serverHasAnswer = typeof r.answer === 'string' && r.answer.trim() !== '';
                                const localHasAnswer =
                                    typeof localResponse.answer === 'string' && localResponse.answer.trim() !== '';
                                const serverIsAnswered =
                                    serverHasAnswer || r.status === 'answered' || r.status === 'answered_marked';
                                const localIsAnswered =
                                    localHasAnswer ||
                                    localResponse.status === 'answered' ||
                                    localResponse.status === 'answered_marked';

                                if (serverIsAnswered && !localIsAnswered) {
                                    // Server has answer and local doesn't - use server data
                                    mergedResponses[r.question_id] = {
                                        answer: r.answer ?? null,
                                        status: r.status,
                                        isMarkedForReview: r.is_marked_for_review ?? false,
                                        timeSpentSeconds: Math.max(localResponse.timeSpentSeconds, r.time_spent_seconds ?? 0),
                                        visitCount: Math.max(localResponse.visitCount, r.visit_count ?? 0),
                                    };
                                } else if (localIsAnswered) {
                                    // Local has answer but server doesn't - keep local (might be unsaved)
                                    // Just update time spent if server has more
                                    mergedResponses[r.question_id] = {
                                        ...localResponse,
                                        timeSpentSeconds: Math.max(localResponse.timeSpentSeconds, r.time_spent_seconds ?? 0),
                                        visitCount: Math.max(localResponse.visitCount, r.visit_count ?? 0),
                                    };
                                } else {
                                    // Neither has answer - merge metadata
                                    mergedResponses[r.question_id] = {
                                        ...localResponse,
                                        status: localResponse.status === 'not_visited' ? r.status : localResponse.status,
                                        isMarkedForReview: localResponse.isMarkedForReview || r.is_marked_for_review,
                                        timeSpentSeconds: Math.max(localResponse.timeSpentSeconds, r.time_spent_seconds ?? 0),
                                        visitCount: Math.max(localResponse.visitCount, r.visit_count ?? 0),
                                    };
                                }
                            });
                        }

                        examDebug.resume({
                            attemptId: attempt.id,
                            fromSection: currentState.currentSectionIndex,
                            fromQuestion: currentState.currentQuestionIndex,
                            preservedState: true,
                        });
                        logger.debug('Resuming existing attempt, syncing server timers and merging responses', { attemptId: attempt.id });

                        set({
                            responses: mergedResponses,
                            sectionTimers: nextSectionTimers,
                            currentSectionIndex: nextSectionIndex,
                            currentQuestionIndex: nextQuestionIndex,
                            lockedSections: Array.from(lockedSections),
                            isSubmitting: false,
                            isAutoSubmitting: false,
                            isInitialized: true,
                        });
                        return;
                    }

                    // Create initial response states for all questions
                    const responses: Record<string, ResponseState> = {};
                    questions.forEach((q) => {
                        responses[q.id] = {
                            answer: null,
                            status: 'not_visited',
                            isMarkedForReview: false,
                            timeSpentSeconds: 0,
                            visitCount: 0,
                        };
                    });

                    // Hydrate responses from server if available
                    if (serverResponses && serverResponses.length > 0) {
                        serverResponses.forEach((r) => {
                            if (!responses[r.question_id]) return;
                            responses[r.question_id] = {
                                answer: r.answer ?? null,
                                status: r.status,
                                isMarkedForReview: r.is_marked_for_review ?? false,
                                timeSpentSeconds: r.time_spent_seconds ?? 0,
                                visitCount: r.visit_count ?? 0,
                            };
                        });
                    }

                    const now = Date.now();
                    const attemptStartedAt = attempt.started_at ? new Date(attempt.started_at).getTime() : now;
                    const rawTimeRemaining = attempt.time_remaining as Partial<Record<SectionName, number>> | null | undefined;
                    const hasTimeRemaining =
                        rawTimeRemaining &&
                        Object.values(rawTimeRemaining).some((value) => typeof value === 'number' && value > 0);
                    const isLikelyNewAttempt = !hasTimeRemaining &&
                        (attempt.current_section == null || attempt.current_section === 'VARC') &&
                        (attempt.current_question == null || attempt.current_question <= 1);
                    const baseStartTime = hasTimeRemaining ? attemptStartedAt : (isLikelyNewAttempt ? now : attemptStartedAt);

                    const sectionDurations = getSectionDurationSecondsMap(paper.sections);
                    const sectionTimers: MutableSectionTimers = {
                        VARC: {
                            sectionName: 'VARC',
                            startedAt: baseStartTime,
                            durationSeconds: sectionDurations.VARC,
                            remainingSeconds: sectionDurations.VARC,
                            isExpired: false,
                        },
                        DILR: {
                            sectionName: 'DILR',
                            startedAt: 0,
                            durationSeconds: sectionDurations.DILR,
                            remainingSeconds: sectionDurations.DILR,
                            isExpired: false,
                        },
                        QA: {
                            sectionName: 'QA',
                            startedAt: 0,
                            durationSeconds: sectionDurations.QA,
                            remainingSeconds: sectionDurations.QA,
                            isExpired: false,
                        },
                    };

                    // Parse existing time_remaining from server if resuming
                    if (hasTimeRemaining && rawTimeRemaining) {
                        const timeRemaining = rawTimeRemaining;

                        if (timeRemaining.VARC !== undefined) {
                            sectionTimers.VARC.remainingSeconds = timeRemaining.VARC;
                            if (timeRemaining.VARC < sectionDurations.VARC) {
                                const elapsedSeconds = sectionDurations.VARC - timeRemaining.VARC;
                                sectionTimers.VARC.startedAt = now - elapsedSeconds * 1000;
                            }
                        }
                        if (timeRemaining.DILR !== undefined) {
                            sectionTimers.DILR.remainingSeconds = timeRemaining.DILR;
                        }
                        if (timeRemaining.QA !== undefined) {
                            sectionTimers.QA.remainingSeconds = timeRemaining.QA;
                        }
                    }

                    const currentSection = normalizeSectionName(attempt.current_section as string | null | undefined);
                    const currentSectionIndex = SECTION_ORDER[currentSection];

                    const currentQuestionFromServer = attempt.current_question ?? 1;
                    const currentQuestionIndex = Math.max(0, currentQuestionFromServer - 1);

                    // Normalize current section start time based on remainingSeconds to avoid instant expiry.
                    const currentTimer = sectionTimers[currentSection];
                    if (currentTimer) {
                        const duration = sectionDurations[currentSection];
                        // CRITICAL FIX: If remaining is 0 or negative from server, this is a completed/expired exam
                        // Mark it as expired immediately rather than triggering auto-submit
                        const serverRemaining = currentTimer.remainingSeconds;
                        if (serverRemaining <= 0) {
                            // Timer already expired - mark it as expired but don't trigger auto-submit cascade
                            currentTimer.remainingSeconds = 0;
                            currentTimer.isExpired = true;
                            currentTimer.startedAt = now - duration * 1000;
                        } else {
                            const clampedRemaining = Math.max(1, Math.min(duration, serverRemaining));
                            currentTimer.remainingSeconds = clampedRemaining;
                            currentTimer.startedAt =
                                clampedRemaining >= duration ? now : now - (duration - clampedRemaining) * 1000;
                        }
                    }

                    // P0 FIX: Prefer any existing token (e.g., server-initialized) to avoid overwriting it.
                    const existingSessionToken =
                        typeof currentState.sessionToken === 'string' && currentState.sessionToken.trim().length > 0
                            ? currentState.sessionToken
                            : null;
                    const sessionToken =
                        existingSessionToken ??
                        (typeof crypto !== 'undefined' && crypto.randomUUID
                            ? crypto.randomUUID()
                            : `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`);

                    const visitedQuestions = new Set<string>();
                    const markedQuestions = new Set<string>();

                    Object.entries(responses).forEach(([questionId, response]) => {
                        if (response.status !== 'not_visited') visitedQuestions.add(questionId);
                        if (response.isMarkedForReview) markedQuestions.add(questionId);
                    });

                    const lockedSections: SectionName[] = [];
                    const sectionOrder: SectionName[] = ['VARC', 'DILR', 'QA'];
                    for (let i = 0; i < currentSectionIndex; i++) lockedSections.push(sectionOrder[i]);

                    examDebug.storeInit({
                        attemptId: attempt.id,
                        storeName,
                        sessionToken,
                        currentSectionIndex,
                        currentQuestionIndex,
                    });

                    set({
                        hasHydrated: true,
                        isInitialized: true,
                        attemptId: attempt.id,
                        paperId: paper.id,
                        sessionToken,
                        currentSectionIndex,
                        currentQuestionIndex,
                        lockedSections,
                        responses,
                        sectionTimers,
                        visitedQuestions,
                        markedQuestions,
                        isSubmitting: false,
                        isAutoSubmitting: false,
                    });
                },

                setHasHydrated: (hydrated: boolean) => {
                    set({
                        hasHydrated: hydrated,
                        ...(hydrated ? {} : { isInitialized: false }),
                    });
                },

                setSessionToken: (sessionToken: string | null) => {
                    set({ sessionToken });
                },

                // =====================================================================
                // NAVIGATION
                // =====================================================================

                goToQuestion: (questionId: string, sectionIndex: number, questionIndex: number) => {
                    const state = get();

                    if (sectionIndex !== state.currentSectionIndex) {
                        logger.warn('Section locked. Navigation restricted to current section', {
                            attemptId: state.attemptId,
                            targetSection: sectionIndex,
                            currentSection: state.currentSectionIndex,
                        });
                        return;
                    }

                    const newVisitedQuestions = new Set(state.visitedQuestions);
                    newVisitedQuestions.add(questionId);

                    const response = state.responses[questionId];
                    if (response && response.status === 'not_visited') {
                        set({
                            currentSectionIndex: sectionIndex,
                            currentQuestionIndex: questionIndex,
                            visitedQuestions: newVisitedQuestions,
                            responses: {
                                ...state.responses,
                                [questionId]: {
                                    ...response,
                                    status: 'visited',
                                    visitCount: response.visitCount + 1,
                                },
                            },
                        });
                    } else if (response) {
                        set({
                            currentSectionIndex: sectionIndex,
                            currentQuestionIndex: questionIndex,
                            visitedQuestions: newVisitedQuestions,
                            responses: {
                                ...state.responses,
                                [questionId]: {
                                    ...response,
                                    visitCount: response.visitCount + 1,
                                },
                            },
                        });
                    } else {
                        set({
                            currentSectionIndex: sectionIndex,
                            currentQuestionIndex: questionIndex,
                            visitedQuestions: newVisitedQuestions,
                        });
                    }
                },

                goToNextQuestion: () => {
                    const state = get();
                    set({ currentQuestionIndex: state.currentQuestionIndex + 1 });
                },

                goToPreviousQuestion: () => {
                    const state = get();
                    if (state.currentQuestionIndex > 0) {
                        set({ currentQuestionIndex: state.currentQuestionIndex - 1 });
                    }
                },

                // =====================================================================
                // ANSWER MANAGEMENT
                // =====================================================================

                setLocalAnswer: (questionId: string, answer: string | null) => {
                    const state = get();
                    const response = state.responses[questionId];

                    if (!response) {
                        logger.warn('Response not found for question', { questionId, attemptId: state.attemptId });
                        return;
                    }

                    examDebug.log('setLocalAnswer - storing locally only', {
                        questionId,
                        answer,
                        currentStatus: response.status,
                    });

                    set({
                        responses: {
                            ...state.responses,
                            [questionId]: {
                                ...response,
                                answer,
                            },
                        },
                    });
                },

                saveAnswer: (questionId: string, answer: string | null) => {
                    const state = get();
                    const response = state.responses[questionId];

                    if (!response) {
                        logger.warn('Response not found for question', { questionId, attemptId: state.attemptId });
                        return;
                    }

                    const hasAnswer = answer !== null && answer !== '';
                    let newStatus = response.status;

                    if (hasAnswer) {
                        newStatus = response.isMarkedForReview ? 'answered_marked' : 'answered';
                    } else {
                        newStatus = response.isMarkedForReview ? 'marked' : 'visited';
                    }

                    examDebug.log('saveAnswer - updating status', {
                        questionId,
                        answer,
                        oldStatus: response.status,
                        newStatus,
                        isMarkedForReview: response.isMarkedForReview,
                    });

                    set({
                        responses: {
                            ...state.responses,
                            [questionId]: {
                                ...response,
                                answer,
                                status: newStatus,
                            },
                        },
                    });
                },

                setAnswer: (questionId: string, answer: string | null) => {
                    const state = get();
                    const response = state.responses[questionId];

                    if (!response) {
                        logger.warn('Response not found for question', { questionId, attemptId: state.attemptId });
                        return;
                    }

                    const hasAnswer = answer !== null && answer !== '';
                    let newStatus = response.status;

                    if (hasAnswer) {
                        newStatus = response.isMarkedForReview ? 'answered_marked' : 'answered';
                    } else {
                        newStatus = response.isMarkedForReview ? 'marked' : 'visited';
                    }

                    const newMarkedQuestions = new Set(state.markedQuestions);
                    if (response.isMarkedForReview) {
                        newMarkedQuestions.add(questionId);
                    }

                    examDebug.responseStatus({
                        questionId,
                        oldStatus: response.status,
                        newStatus,
                        answer,
                        isMarkedForReview: response.isMarkedForReview,
                    });

                    set({
                        responses: {
                            ...state.responses,
                            [questionId]: {
                                ...response,
                                answer,
                                status: newStatus,
                            },
                        },
                        markedQuestions: newMarkedQuestions,
                        pendingSyncResponses: {
                            ...state.pendingSyncResponses,
                            [questionId]: {
                                answer,
                                timestamp: Date.now(),
                            },
                        },
                    });
                },

                // ✅ FIXED: clearAnswer now ALSO unmarks the question for review.
                clearAnswer: (questionId: string) => {
                    const state = get();
                    const response = state.responses[questionId];
                    if (!response) return;

                    // Clearing implies: no answer + NOT marked + visited
                    const newStatus = calculateQuestionStatus(false, false, true);

                    // Ensure sets reflect unmarking + visited
                    const newMarkedQuestions = new Set(state.markedQuestions);
                    newMarkedQuestions.delete(questionId);

                    const newVisitedQuestions = new Set(state.visitedQuestions);
                    newVisitedQuestions.add(questionId);

                    set({
                        visitedQuestions: newVisitedQuestions,
                        markedQuestions: newMarkedQuestions,
                        responses: {
                            ...state.responses,
                            [questionId]: {
                                ...response,
                                answer: null,
                                isMarkedForReview: false,
                                status: newStatus,
                            },
                        },
                        pendingSyncResponses: {
                            ...state.pendingSyncResponses,
                            [questionId]: {
                                answer: null,
                                timestamp: Date.now(),
                            },
                        },
                    });
                },

                toggleMarkForReview: (questionId: string) => {
                    const state = get();
                    const response = state.responses[questionId];
                    if (!response) return;

                    const newIsMarked = !response.isMarkedForReview;
                    const hasAnswer = response.answer !== null && response.answer !== '';

                    const hadSavedAnswer = response.status === 'answered' || response.status === 'answered_marked';

                    let newStatus: QuestionStatus;
                    if (newIsMarked) {
                        newStatus = hadSavedAnswer ? 'answered_marked' : 'marked';
                    } else {
                        newStatus = hadSavedAnswer ? 'answered' : hasAnswer ? 'visited' : 'visited';
                    }

                    examDebug.markForReview({
                        questionId,
                        hadSavedAnswer,
                        newStatus,
                        isMarking: newIsMarked,
                    });

                    const newMarkedQuestions = new Set(state.markedQuestions);
                    if (newIsMarked) newMarkedQuestions.add(questionId);
                    else newMarkedQuestions.delete(questionId);

                    set({
                        responses: {
                            ...state.responses,
                            [questionId]: {
                                ...response,
                                isMarkedForReview: newIsMarked,
                                status: newStatus,
                            },
                        },
                        markedQuestions: newMarkedQuestions,
                    });
                },

                queuePendingSync: (questionId: string, answer: string | null) => {
                    const state = get();
                    set({
                        pendingSyncResponses: {
                            ...state.pendingSyncResponses,
                            [questionId]: {
                                answer,
                                timestamp: Date.now(),
                            },
                        },
                    });
                },

                clearPendingSync: (questionIds?: string[]) => {
                    if (!questionIds || questionIds.length === 0) {
                        set({ pendingSyncResponses: {} });
                        return;
                    }

                    const state = get();
                    const nextQueue = { ...state.pendingSyncResponses };
                    for (const id of questionIds) delete nextQueue[id];
                    set({ pendingSyncResponses: nextQueue });
                },

                setLastSyncTimestamp: (timestamp: number) => {
                    set({ lastSyncTimestamp: timestamp });
                },

                setResponseStatus: (questionId: string, status: QuestionStatus, isMarkedForReview?: boolean) => {
                    const state = get();
                    const response = state.responses[questionId];
                    if (!response) return;

                    const nextIsMarked = isMarkedForReview ?? response.isMarkedForReview;
                    const newMarkedQuestions = new Set(state.markedQuestions);
                    if (nextIsMarked) newMarkedQuestions.add(questionId);
                    else newMarkedQuestions.delete(questionId);

                    examDebug.responseStatus({
                        questionId,
                        oldStatus: response.status,
                        newStatus: status,
                        answer: response.answer,
                        isMarkedForReview: nextIsMarked,
                    });

                    set({
                        responses: {
                            ...state.responses,
                            [questionId]: {
                                ...response,
                                status,
                                isMarkedForReview: nextIsMarked,
                            },
                        },
                        markedQuestions: newMarkedQuestions,
                    });
                },

                // =====================================================================
                // STATUS UPDATES
                // =====================================================================

                markQuestionVisited: (questionId: string) => {
                    const state = get();
                    const newVisitedQuestions = new Set(state.visitedQuestions);
                    newVisitedQuestions.add(questionId);

                    const response = state.responses[questionId];
                    if (response && response.status === 'not_visited') {
                        set({
                            visitedQuestions: newVisitedQuestions,
                            responses: {
                                ...state.responses,
                                [questionId]: {
                                    ...response,
                                    status: 'visited',
                                    visitCount: response.visitCount + 1,
                                },
                            },
                        });
                    } else {
                        set({ visitedQuestions: newVisitedQuestions });
                    }
                },

                updateTimeSpent: (questionId: string, seconds: number) => {
                    const state = get();
                    const response = state.responses[questionId];
                    if (!response) return;

                    set({
                        responses: {
                            ...state.responses,
                            [questionId]: {
                                ...response,
                                timeSpentSeconds: response.timeSpentSeconds + seconds,
                            },
                        },
                    });
                },

                // =====================================================================
                // SECTION MANAGEMENT
                // =====================================================================

                completeSection: (sectionName: SectionName) => {
                    const state = get();
                    if (!state.lockedSections.includes(sectionName)) {
                        set({ lockedSections: [...state.lockedSections, sectionName] });
                    }
                },

                moveToNextSection: () => {
                    const state = get();
                    const currentSection = getSectionByIndex(state.currentSectionIndex);

                    const newLockedSections = state.lockedSections.includes(currentSection)
                        ? state.lockedSections
                        : [...state.lockedSections, currentSection];

                    if (state.currentSectionIndex < 2) {
                        const nextSectionIndex = state.currentSectionIndex + 1;
                        const nextSection = getSectionByIndex(nextSectionIndex);
                        const now = Date.now();

                        set({
                            currentSectionIndex: nextSectionIndex,
                            currentQuestionIndex: 0,
                            lockedSections: newLockedSections,
                            sectionTimers: {
                                ...state.sectionTimers,
                                [nextSection]: {
                                    ...state.sectionTimers[nextSection],
                                    startedAt: now,
                                },
                            },
                        });
                    } else {
                        set({ lockedSections: newLockedSections });
                    }
                },

                // =====================================================================
                // TIMER
                // =====================================================================

                updateSectionTimer: (sectionName: SectionName, remainingSeconds: number) => {
                    const state = get();
                    set({
                        sectionTimers: {
                            ...state.sectionTimers,
                            [sectionName]: {
                                ...state.sectionTimers[sectionName],
                                remainingSeconds: Math.max(0, remainingSeconds),
                            },
                        },
                    });
                },
                setSectionTimerOverride: (sectionName: SectionName, remainingSeconds: number) => {
                    const state = get();
                    const safeRemaining = Math.max(0, Math.floor(remainingSeconds));
                    const durationSeconds = Math.max(1, safeRemaining);
                    set({
                        sectionTimers: {
                            ...state.sectionTimers,
                            [sectionName]: {
                                ...state.sectionTimers[sectionName],
                                sectionName,
                                startedAt: Date.now(),
                                durationSeconds,
                                remainingSeconds: safeRemaining,
                                isExpired: safeRemaining <= 0,
                            },
                        },
                    });
                },

                expireSection: (sectionName: SectionName) => {
                    const state = get();
                    set({
                        sectionTimers: {
                            ...state.sectionTimers,
                            [sectionName]: {
                                ...state.sectionTimers[sectionName],
                                remainingSeconds: 0,
                                isExpired: true,
                            },
                        },
                    });
                },

                // =====================================================================
                // SUBMISSION
                // =====================================================================

                setSubmitting: (isSubmitting: boolean) => {
                    set({ isSubmitting });
                },

                setAutoSubmitting: (isAutoSubmitting: boolean) => {
                    set({ isAutoSubmitting });
                },

                // =====================================================================
                // RESET
                // =====================================================================

                resetExam: () => {
                    set({
                        ...initialState,
                        hasHydrated: true,
                        isInitialized: false,
                    });
                },
            }),
            {
                name: storeName,
                storage: createJSONStorage(() => (typeof window !== 'undefined' ? localStorage : noopStorage)),
                partialize: (state) => ({
                    attemptId: state.attemptId,
                    paperId: state.paperId,
                    sessionToken: state.sessionToken,
                    currentSectionIndex: state.currentSectionIndex,
                    currentQuestionIndex: state.currentQuestionIndex,
                    lockedSections: state.lockedSections,
                    responses: state.responses,
                    pendingSyncResponses: state.pendingSyncResponses,
                    lastSyncTimestamp: state.lastSyncTimestamp,
                    sectionTimers: state.sectionTimers,
                    visitedQuestions: Array.from(state.visitedQuestions),
                    markedQuestions: Array.from(state.markedQuestions),
                }),
                onRehydrateStorage: () => (state) => {
                    if (state) {
                        const writableState = state as unknown as {
                            visitedQuestions: Set<string>;
                            markedQuestions: Set<string>;
                            hasHydrated: boolean;
                            isInitialized: boolean;
                            attemptId: string | null;
                            resetExam: () => void;
                        };
                        writableState.visitedQuestions = new Set(
                            Array.isArray(state.visitedQuestions) ? state.visitedQuestions : []
                        );
                        writableState.markedQuestions = new Set(
                            Array.isArray(state.markedQuestions) ? state.markedQuestions : []
                        );
                        writableState.hasHydrated = true;
                        writableState.isInitialized = false;

                        // Guard against stale persisted state for a different attempt.
                        if (typeof window !== 'undefined') {
                            const parts = window.location.pathname.split('/');
                            const currentAttemptId = parts[1] === 'exam' ? (parts[2] ?? null) : null;
                            if (
                                currentAttemptId &&
                                writableState.attemptId &&
                                writableState.attemptId !== currentAttemptId
                            ) {
                                writableState.resetExam();
                            }
                        }
                    }
                },
            }
        )
    );
};

// =============================================================================
// DEFAULT STORE INSTANCE
// =============================================================================

export const useExamStore = createExamStore();

// =============================================================================
// SELECTORS (for optimized re-renders)
// =============================================================================

export const selectCurrentSection = (state: ExamStore): SectionName => getSectionByIndex(state.currentSectionIndex);

export const selectCurrentTimer = (state: ExamStore): SectionTimerState => {
    const section = getSectionByIndex(state.currentSectionIndex);
    return state.sectionTimers[section];
};

export const selectResponse = (questionId: string) => (state: ExamStore): ResponseState | undefined => state.responses[questionId];

export const selectIsSectionLocked = (sectionName: SectionName) => (state: ExamStore): boolean =>
    state.lockedSections.includes(sectionName);

export const selectQuestionStatus = (questionId: string) => (state: ExamStore): QuestionStatus => {
    const response = state.responses[questionId];
    return response?.status ?? 'not_visited';
};

export const selectSectionCounts = (questions: Question[]) => (state: ExamStore) => {
    const counts = {
        total: questions.length,
        notVisited: 0,
        visited: 0,
        answered: 0,
        marked: 0,
        answeredMarked: 0,
    };

    questions.forEach((q) => {
        const response = state.responses[q.id];
        if (!response) {
            counts.notVisited++;
            return;
        }

        switch (response.status) {
            case 'not_visited':
                counts.notVisited++;
                break;
            case 'visited':
                counts.visited++;
                break;
            case 'answered':
                counts.answered++;
                break;
            case 'marked':
                counts.marked++;
                break;
            case 'answered_marked':
                counts.answeredMarked++;
                break;
        }
    });

    return counts;
};

// =============================================================================
// ANALYSIS STORE (Reason Tags + Bookmarks)
// =============================================================================

interface AnalysisStoreState {
    attemptId: string;
    reasons: Record<string, PerformanceReason | null>;
    bookmarks: Record<string, boolean>;
}

interface AnalysisStoreActions {
    setReason: (questionId: string, reason: PerformanceReason | null) => void;
    toggleBookmark: (questionId: string) => void;
    clearReason: (questionId: string) => void;
    resetAnalysis: () => void;
}

const analysisStoreCache = new Map<string, ReturnType<typeof createAnalysisStore>>();

const createAnalysisStore = (attemptId: string) => {
    const storageKey = `cat-exam-analysis-${attemptId}`;

    return create<AnalysisStoreState & AnalysisStoreActions>()(
        persist(
            (set) => ({
                attemptId,
                reasons: {},
                bookmarks: {},
                setReason: (questionId, reason) => {
                    set((state) => ({
                        reasons: {
                            ...state.reasons,
                            [questionId]: reason,
                        },
                    }));
                },
                toggleBookmark: (questionId) => {
                    set((state) => {
                        const next = { ...state.bookmarks };
                        if (next[questionId]) {
                            delete next[questionId];
                        } else {
                            next[questionId] = true;
                        }
                        return { bookmarks: next };
                    });
                },
                clearReason: (questionId) => {
                    set((state) => {
                        if (!(questionId in state.reasons)) {
                            return state;
                        }
                        const next = { ...state.reasons };
                        delete next[questionId];
                        return { reasons: next };
                    });
                },
                resetAnalysis: () => {
                    set({ reasons: {}, bookmarks: {} });
                },
            }),
            {
                name: storageKey,
                storage: createJSONStorage(() => (typeof window !== 'undefined' ? localStorage : noopStorage)),
            }
        )
    );
};

export const getAnalysisStore = (attemptId?: string | null) => {
    const key = attemptId || 'temp';
    const existing = analysisStoreCache.get(key);
    if (existing) {
        return existing;
    }
    const created = createAnalysisStore(key);
    analysisStoreCache.set(key, created);
    return created;
};
````

## File: src/types/exam.ts
````typescript
/**
 * @fileoverview Exam Engine Type Definitions
 * @description TypeScript interfaces matching the "Nuclear Fix" database schema
 * @blueprint Milestone 4 SOP-SSOT - Phase 1.1
 * @optimization Implements Base Entities, Readonly constraints, and Shared Interfaces
 */

// =============================================================================
// SHARED INTERFACES (DRY & UTILITY)
// =============================================================================

/** Base entity fields for almost all DB tables */
export interface BaseEntity {
    readonly id: string;
    readonly created_at: string;
    readonly updated_at: string;
}

/** Entities that track active/inactive state */
export interface Activable {
    readonly is_active: boolean;
}

/** Entities that track start/end/duration */
export interface TimeTracked {
    readonly started_at: string;
    readonly completed_at?: string;
    readonly time_taken_seconds?: number;
}

// =============================================================================
// SECTION TYPES (CAT 2024 Format)
// =============================================================================

/** CAT exam section names - strict order: VARC → DILR → QA */
export type SectionName = 'VARC' | 'DILR' | 'QA';

/** Section order mapping for strict navigation enforcement */
export const SECTION_ORDER: Record<SectionName, number> = {
    VARC: 0,
    DILR: 1,
    QA: 2,
} as const;

/** Short display labels for sections used in analytics UI */
export const SECTION_DISPLAY_LABELS: Record<SectionName, string> = {
    VARC: 'VARC',
    DILR: 'LRDI',
    QA: 'QA',
} as const;

/** Get short display label for a section */
export function getSectionDisplayLabel(section: SectionName): string {
    return SECTION_DISPLAY_LABELS[section] ?? section;
}

/** Section configuration from paper.sections JSONB */
export interface SectionConfig {
    readonly name: SectionName;
    readonly questions: number;  // VARC: 24, DILR: 20, QA: 22
    readonly time: number;       // Minutes (40)
    readonly marks: number;
}

/** CAT 2024 default section configuration */
export const CAT_2024_SECTIONS: readonly SectionConfig[] = [
    { name: 'VARC', questions: 24, time: 40, marks: 72 },
    { name: 'DILR', questions: 20, time: 40, marks: 60 },
    { name: 'QA', questions: 22, time: 40, marks: 66 },
] as const;

// =============================================================================
// QUESTION TYPES
// =============================================================================

export type QuestionType = 'MCQ' | 'TITA';

export interface MCQOptions {
    readonly A: string;
    readonly B: string;
    readonly C: string;
    readonly D: string;
}

export type DifficultyLevel = 'easy' | 'medium' | 'hard';

// =============================================================================
// QUESTION CONTAINER ARCHITECTURE (Parent-Child Model)
// =============================================================================

export type QuestionSetType = 'VARC' | 'DILR' | 'CASELET' | 'ATOMIC';

export type ContextType =
    | 'rc_passage'
    | 'dilr_set'
    | 'caselet'
    | 'data_table'
    | 'graph'
    | 'other_shared_stimulus';

export type ContentLayoutType =
    | 'split_passage'
    | 'split_chart'
    | 'split_table'
    | 'single_focus'
    | 'image_top';

export interface QuestionSetMetadata {
    readonly difficulty?: DifficultyLevel;
    readonly topic?: string;
    readonly subtopic?: string;
    readonly tags?: readonly string[];
    readonly source?: string;
    readonly estimated_time_minutes?: number;
    /** Where to place the context image relative to text: 'before' (default), 'after', 'after_para_1', 'after_para_2', etc. */
    readonly image_position?: 'before' | 'after' | `after_para_${number}`;
}

/** Question Set Entity (Parent Container) */
export interface QuestionSet extends BaseEntity, Activable {
    readonly paper_id: string;
    readonly section: SectionName;

    // Set classification
    readonly set_type: QuestionSetType;
    readonly content_layout: ContentLayoutType;
    readonly context_type?: ContextType | null;

    // Context content
    readonly context_title?: string;
    readonly context_body?: string;
    readonly context_image_url?: string;
    readonly context_additional_images?: ReadonlyArray<{
        readonly url: string;
        readonly caption?: string;
    }>;

    // Display configuration
    readonly display_order: number;
    readonly question_count: number;

    // Metadata
    readonly metadata: QuestionSetMetadata;
    readonly is_published: boolean;

    // Child questions (populated via JOIN)
    readonly questions?: readonly QuestionInSet[];
}

/** Question within a Set (Child entity) */
export interface QuestionInSet {
    readonly id: string;
    readonly set_id: string;
    readonly paper_id: string;
    readonly section: SectionName;

    // Position
    readonly sequence_order: number;
    readonly question_number: number;

    // Content
    readonly question_text: string;
    readonly question_type: QuestionType;
    readonly options: readonly string[] | null;

    // Marking
    readonly positive_marks: number;
    readonly negative_marks: number;

    // Categorization
    readonly difficulty?: DifficultyLevel;
    readonly topic?: string;
    readonly subtopic?: string;

    // Media
    readonly question_image_url?: string;

    // Management
    readonly is_active: boolean;
}

/** Question in Set with correct answer (admin/results only) */
export interface QuestionInSetWithAnswer extends QuestionInSet {
    readonly correct_answer: string;
    readonly solution_text?: string;
    readonly solution_image_url?: string;
    readonly video_solution_url?: string;
}

export interface QuestionSetComplete extends QuestionSet {
    readonly questions: readonly QuestionInSet[];
}

export interface QuestionSetWithAnswers extends QuestionSet {
    readonly questions: readonly QuestionInSetWithAnswer[];
}

// Helpers
export function isCompositeSet(setType: QuestionSetType): boolean {
    return setType === 'VARC' || setType === 'DILR' || setType === 'CASELET';
}

export function isSplitLayout(layout: ContentLayoutType): boolean {
    return layout.startsWith('split_');
}

// =============================================================================
// LEGACY: Context/Passage (Deprecated)
// =============================================================================

/** @deprecated Use QuestionSet instead */
export interface QuestionContext extends BaseEntity, Activable {
    readonly paper_id: string;
    readonly section: SectionName;
    readonly title?: string;
    readonly content: string;
    readonly context_type: 'passage' | 'data_set' | 'image' | 'table';
    readonly image_url?: string;
    readonly display_order: number;
}

/** Question entity from database */
export interface Question extends BaseEntity, Activable {
    readonly paper_id: string;
    readonly section: SectionName;
    readonly question_number: number;

    // Relationships
    readonly set_id?: string | null;
    readonly sequence_order?: number | null;
    readonly exam_order?: number;

    // Content
    readonly question_text: string;
    readonly question_type: QuestionType;
    readonly question_format?: QuestionType;
    readonly taxonomy_type?: string;
    readonly topic_tag?: string;
    readonly difficulty_rationale?: string;
    readonly options: readonly string[] | null;
    readonly context_id?: string;
    readonly context?: QuestionContext;

    // Marking
    readonly positive_marks: number;
    readonly negative_marks: number;

    // Solution
    readonly solution_text?: string;
    readonly solution_image_url?: string;
    readonly video_solution_url?: string;
    readonly question_image_url?: string;

    // Categorization
    readonly difficulty?: DifficultyLevel;
    readonly topic?: string;
    readonly subtopic?: string;
}

export interface QuestionWithAnswer extends Question {
    readonly correct_answer: string;
}

// =============================================================================
// STATISTICS TYPES
// =============================================================================

export interface QuestionStats {
    readonly total: number;
    readonly options: Readonly<Record<string, number>>;
}

export type PaperStats = Record<string, QuestionStats>;

// =============================================================================
// PAPER TYPES
// =============================================================================

export type PaperDifficulty = 'easy' | 'medium' | 'hard' | 'cat-level';

export interface Paper extends BaseEntity {
    readonly slug: string;
    readonly title: string;
    readonly description?: string;
    readonly year: number;

    // Configuration
    readonly total_questions: number;
    readonly total_marks: number;
    readonly duration_minutes: number;
    readonly sections: readonly SectionConfig[];

    // Marking Defaults
    readonly default_positive_marks: number;
    readonly default_negative_marks: number;

    // Publishing
    readonly published: boolean;
    readonly available_from?: string;
    readonly available_until?: string;

    // Metadata
    readonly difficulty_level?: PaperDifficulty;
    readonly is_free: boolean;
    readonly attempt_limit?: number;
    readonly allow_pause?: boolean;
}

// =============================================================================
// RESPONSE/ANSWER TYPES
// =============================================================================

export type QuestionStatus =
    | 'not_visited'
    | 'visited'
    | 'answered'
    | 'marked'
    | 'answered_marked';

export type PerformanceReason = 'concept_gap' | 'careless_error' | 'time_pressure' | 'guess';

/** Response entity from database */
export interface Response extends BaseEntity {
    readonly attempt_id: string;
    readonly question_id: string;

    // Answer data
    readonly answer: string | null;
    readonly is_correct?: boolean;
    readonly marks_obtained?: number;

    // State
    readonly status: QuestionStatus;
    readonly is_marked_for_review: boolean;
    readonly is_visited: boolean;

    // Analytics
    readonly time_spent_seconds: number;
    readonly visit_count: number;
}

/** Response input (no server fields) */
export interface ResponseInput {
    readonly attempt_id: string;
    readonly question_id: string;
    readonly answer: string | null;
    readonly status: QuestionStatus;
    readonly is_marked_for_review: boolean;
    readonly is_visited: boolean;
    readonly time_spent_seconds: number;
    readonly visit_count: number;
}

// =============================================================================
// ATTEMPT TYPES
// =============================================================================

export type AttemptStatus = 'in_progress' | 'paused' | 'submitted' | 'completed' | 'abandoned' | 'expired';

/** AI analysis lifecycle states (matches ai_analysis_status_type enum in DB) */
export type AIAnalysisStatus = 'none' | 'requested' | 'exported' | 'processed' | 'failed';

export interface SectionScore {
    readonly score: number;
    readonly correct: number;
    readonly incorrect: number;
    readonly unanswered: number;
}

export type SectionScores = Record<SectionName, SectionScore>;
export type TimeRemaining = Record<SectionName, number>;

export interface Attempt extends BaseEntity, TimeTracked {
    readonly user_id: string;
    readonly paper_id: string;

    // Timing specifics
    readonly submitted_at?: string;
    readonly submission_id?: string;
    readonly paused_at?: string | null;
    readonly total_paused_seconds?: number | null;

    // Status
    readonly status: AttemptStatus;
    readonly current_section?: SectionName;
    readonly current_question: number;
    readonly time_remaining?: TimeRemaining;

    // Scores
    readonly total_score?: number;
    readonly max_possible_score?: number;

    // Analytics
    readonly correct_count: number;
    readonly incorrect_count: number;
    readonly unanswered_count: number;
    readonly accuracy?: number;
    readonly attempt_rate?: number;
    readonly section_scores?: SectionScores;

    // Ranking
    readonly percentile?: number;
    readonly rank?: number;

    // AI Analysis lifecycle (Migration 031)
    readonly ai_analysis_status?: AIAnalysisStatus;
    readonly ai_analysis_requested_at?: string;
    readonly ai_analysis_exported_at?: string;
    readonly ai_analysis_error?: string | null;

    // Paper version snapshot (set at attempt creation, Migration 031)
    readonly paper_ingest_run_id?: string | null;
}

export interface AttemptInput {
    readonly user_id: string;
    readonly paper_id: string;
    readonly current_section: SectionName;
    readonly time_remaining: TimeRemaining;
}

// =============================================================================
// EXAM ENGINE STATE TYPES (Zustand)
// =============================================================================

export interface ExamData {
    readonly paper: Paper;
    readonly questions: readonly Question[];
    readonly attempt: Attempt;
    readonly responses?: readonly Response[];
}

export interface ResponseState {
    readonly answer: string | null;
    readonly status: QuestionStatus;
    readonly isMarkedForReview: boolean;
    readonly timeSpentSeconds: number;
    readonly visitCount: number;
}

export interface SectionTimerState {
    readonly sectionName: SectionName;
    readonly startedAt: number;
    readonly durationSeconds: number;
    readonly remainingSeconds: number;
    readonly isExpired: boolean;
}

export interface ExamEngineState {
    // System State
    readonly hasHydrated: boolean;
    readonly isInitialized: boolean;
    readonly attemptId: string | null;
    readonly paperId: string | null;
    readonly sessionToken: string | null;

    // Navigation
    readonly currentSectionIndex: number;
    readonly currentQuestionIndex: number;
    readonly lockedSections: readonly SectionName[];

    // Data
    readonly responses: Record<string, ResponseState>;
    readonly pendingSyncResponses: Record<string, { answer: string | null; timestamp: number }>;
    readonly lastSyncTimestamp: number;
    readonly sectionTimers: Record<SectionName, SectionTimerState>;

    // Sets
    readonly visitedQuestions: ReadonlySet<string>;
    readonly markedQuestions: ReadonlySet<string>;

    // Submission
    readonly isSubmitting: boolean;
    readonly isAutoSubmitting: boolean;
}

export interface ExamEngineActions {
    // Initialization
    initializeExam: (data: ExamData) => void;
    setHasHydrated: (hydrated: boolean) => void;
    setSessionToken: (token: string | null) => void;

    // Navigation
    goToQuestion: (qId: string, sIdx: number, qIdx: number) => void;
    goToNextQuestion: () => void;
    goToPreviousQuestion: () => void;

    // Answers
    setLocalAnswer: (qId: string, answer: string | null) => void;
    saveAnswer: (qId: string, answer: string | null) => void;
    /** @deprecated Use setLocalAnswer or saveAnswer instead */
    setAnswer: (qId: string, answer: string | null) => void;
    clearAnswer: (qId: string) => void;
    setResponseStatus: (qId: string, status: QuestionStatus, isMarked?: boolean) => void;
    toggleMarkForReview: (qId: string) => void;

    // Sync
    queuePendingSync: (qId: string, answer: string | null) => void;
    clearPendingSync: (qIds?: string[]) => void;
    setLastSyncTimestamp: (ts: number) => void;

    // Status
    markQuestionVisited: (qId: string) => void;
    updateTimeSpent: (qId: string, seconds: number) => void;

    // Section
    completeSection: (name: SectionName) => void;
    moveToNextSection: () => void;

    // Timer
    updateSectionTimer: (name: SectionName, remaining: number) => void;
    setSectionTimerOverride: (name: SectionName, remaining: number) => void;
    expireSection: (name: SectionName) => void;

    // Submission
    setSubmitting: (isSubmitting: boolean) => void;
    setAutoSubmitting: (isAutoSubmitting: boolean) => void;

    // Reset
    resetExam: () => void;
}

export type ExamStore = ExamEngineState & ExamEngineActions;

// =============================================================================
// UTILITY TYPES & HELPERS
// =============================================================================

/** Get questions for a section (Optimized with slice to prevent mutation) */
export function getQuestionsForSection(
    questions: readonly Question[],
    section: SectionName
): Question[] {
    return questions
        .filter(q => q.section === section)
        .slice() // Create copy before sorting
        .sort((a, b) => a.question_number - b.question_number);
}

export function calculateQuestionStatus(
    hasAnswer: boolean,
    isMarkedForReview: boolean,
    isVisited: boolean
): QuestionStatus {
    if (hasAnswer) return isMarkedForReview ? 'answered_marked' : 'answered';
    if (isMarkedForReview) return 'marked';
    return isVisited ? 'visited' : 'not_visited';
}

export function getSectionByIndex(index: number): SectionName {
    const sections: readonly SectionName[] = ['VARC', 'DILR', 'QA'];
    return sections[index] ?? 'VARC';
}

export const CAT_CONSTANTS = {
    TOTAL_QUESTIONS: 66,
    TOTAL_MARKS: 198,
    TOTAL_DURATION_MINUTES: 120,
    SECTION_DURATION_MINUTES: 40,
    SECTION_DURATION_SECONDS: 2400,
    POSITIVE_MARKS: 3,
    NEGATIVE_MARKS_MCQ: 1,
    NEGATIVE_MARKS_TITA: 0,
    SECTIONS: ['VARC', 'DILR', 'QA'] as const,
} as const;

// =============================================================================
// DYNAMIC TIMING HELPERS
// =============================================================================

export function getSectionDurationSecondsMap(
    sections?: readonly SectionConfig[] | null
): Record<SectionName, number> {
    const defaults: Record<SectionName, number> = {
        VARC: CAT_CONSTANTS.SECTION_DURATION_SECONDS,
        DILR: CAT_CONSTANTS.SECTION_DURATION_SECONDS,
        QA: CAT_CONSTANTS.SECTION_DURATION_SECONDS,
    };

    if (!sections?.length) return defaults;

    // Apply overrides without mutating defaults
    return sections.reduce((acc, section) => {
        if (section.time > 0) {
            acc[section.name] = section.time * 60;
        }
        return acc;
    }, { ...defaults });
}

export function getPaperTotalDurationSeconds(sections?: readonly SectionConfig[] | null): number {
    if (!sections?.length) return CAT_CONSTANTS.TOTAL_DURATION_MINUTES * 60;

    const totalMinutes = sections.reduce((sum, s) => sum + (s.time || 0), 0);
    return Math.max(1, totalMinutes) * 60;
}

// =============================================================================
// RBAC TYPES (Milestone 6+)
// =============================================================================

export type AppRole = 'user' | 'admin' | 'editor' | 'dev';

export interface UserRole extends BaseEntity {
    readonly user_id: string;
    readonly role: AppRole;
    readonly granted_by?: string;
    readonly granted_at: string;
}

export interface JWTClaims {
    readonly user_role?: AppRole;
    readonly app_metadata?: {
        readonly user_role?: AppRole;
    };
    readonly sub: string;
    readonly email?: string;
    readonly exp: number;
    readonly iat: number;
}

export interface AdminAuditLog extends BaseEntity {
    readonly admin_id: string;
    readonly action: 'create' | 'update' | 'delete' | 'publish' | 'unpublish';
    readonly entity_type: 'paper' | 'question' | 'context' | 'user_role';
    readonly entity_id: string;
    readonly changes?: Record<string, { before: unknown; after: unknown }>;
    readonly ip_address?: string;
    readonly user_agent?: string;
}
````

## File: package.json
````json
{
  "name": "temp_app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "cross-env NEXT_DISABLE_TURBOPACK=1 next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "lint:unused": "eslint --max-warnings=0",
    "test": "vitest run",
    "knip": "knip",
    "depcheck": "depcheck",
    "ts-prune": "ts-prune -p tsconfig.json",
    "export:vs_codebase": "node scripts/export-vs-codebase.mjs",
    "export:vs_codebase:v2": "node scripts/export-vs-codebase-v2.mjs",
    "maintenance:update-descriptions": "node scripts/maintenance/update-paper-descriptions.mjs"
  },
  "dependencies": {
    "@supabase/ssr": "^0.4.1",
    "@supabase/supabase-js": "^2.75.0",
    "ajv": "^8.17.1",
    "ajv-formats": "^2.1.1",
    "jwt-decode": "^4.0.0",
    "katex": "^0.16.25",
    "next": "16.1.3",
    "react": "19.1.0",
    "react-dom": "19.1.0",
    "react-katex": "^3.1.0",
    "react-markdown": "^10.1.0",
    "rehype-raw": "^7.0.0",
    "remark-gfm": "^4.0.1",
    "zod": "^4.3.5",
    "zustand": "^5.0.10"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@next/eslint-plugin-next": "^16.1.3",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@typescript-eslint/eslint-plugin": "^8.53.0",
    "@typescript-eslint/parser": "^8.53.0",
    "autoprefixer": "^10.4.21",
    "cross-env": "^7.0.3",
    "depcheck": "^1.4.7",
    "dotenv": "^17.2.3",
    "eslint": "^9",
    "eslint-config-next": "16.1.3",
    "eslint-plugin-unused-imports": "^4.1.4",
    "knip": "^5.51.0",
    "netlify-cli": "^23.9.1",
    "postcss": "^8.5.6",
    "source-map-explorer": "^2.5.3",
    "tailwindcss": "^3.4.0",
    "ts-prune": "^0.10.3",
    "typescript": "^5",
    "vite-tsconfig-paths": "^5.1.4",
    "vitest": "^1.6.0"
  },
  "engines": {
    "node": ">=20"
  }
}
````

## File: src/features/exam-engine/ui/ExamLayout.tsx
````typescript
/**
 * @fileoverview TCS iON CAT Exam Layout Component
 * @description Pixel-perfect recreation of the CAT exam interface
 * @blueprint TCS iON CAT 2025 Interface Specification
 */

'use client';

import { useMemo, useCallback, useEffect, useRef, useState } from 'react';
import { useExamStore, useExamTimer, useSectionTimer, selectCurrentSection } from '@/features/exam-engine';
import { QuestionPalette } from './QuestionPalette';
import { ExamFooter } from './ExamFooter';
import { MCQRenderer } from './MCQRenderer';
import { TITARenderer } from './TITARenderer';
import { Calculator } from './Calculator';
import { MathText } from './MathText';
import type { Paper, Question, SectionName } from '@/types/exam';
import { getQuestionsForSection } from '@/types/exam';

// =============================================================================
// CONSTANTS
// =============================================================================

const SECTIONS = ['VARC', 'DILR', 'QA'] as const;

// =============================================================================
// TYPES
// =============================================================================

interface ExamLayoutProps {
    paper: Paper;
    questions: Question[];
    onSaveResponse?: (questionId: string, answer: string | null) => void | Promise<void>;
    onSaveResponsesBatch?: (items: BatchSaveItem[]) => BatchSaveResult | Promise<BatchSaveResult>;
    onSubmitExam?: () => void | Promise<void>;
    onSectionExpire?: (sectionName: SectionName) => void | Promise<void>;
    onExamComplete?: () => void | Promise<void>;
    onPauseExam?: () => void | Promise<void>;
    layoutMode?: 'current' | 'three-column';
    submissionProgress?: SubmissionProgress | null;
}

type BatchSaveItem = {
    questionId: string;
    answer: string | null;
    status: string;
    isMarkedForReview: boolean;
    isVisited: boolean;
    timeSpentSeconds: number;
    visitCount?: number;
};

type BatchSaveResult = { success: boolean; failedQuestionIds?: string[] } | void;

type SubmissionProgressStep = {
    label: string;
    status: 'pending' | 'active' | 'done';
};

type SubmissionProgress = {
    percent: number;
    activeLabel?: string;
    steps: SubmissionProgressStep[];
};

// =============================================================================
// TCS iON HEADER
// =============================================================================

interface ExamHeaderProps {
    paper: Paper;
    candidateName?: string;
    candidatePhotoUrl?: string;
    onSectionSelect: (section: SectionName) => void;
    onToggleCalculator: () => void;
    isCalculatorVisible: boolean;
    onPauseExam?: () => void | Promise<void>;
    allowPause: boolean;
    timeLeftDisplay: string;
}

function ExamTimerController({
    onSectionExpire,
    onExamComplete,
}: Pick<ExamLayoutProps, 'onSectionExpire' | 'onExamComplete'>) {
    useExamTimer({
        onSectionExpire,
        onExamComplete,
    });
    return null;
}

function ExamHeaderContainer(props: Omit<ExamHeaderProps, 'timeLeftDisplay'>) {
    const currentSection = useExamStore(selectCurrentSection);
    const { displayTime } = useSectionTimer(currentSection);
    return <ExamHeader {...props} timeLeftDisplay={displayTime} />;
}

function ExamHeader({
    paper,
    candidateName = 'Candidate',
    candidatePhotoUrl,
    onSectionSelect,
    onToggleCalculator,
    isCalculatorVisible,
    onPauseExam,
    allowPause,
    timeLeftDisplay,
}: ExamHeaderProps) {
    const currentSectionIndex = useExamStore((s) => s.currentSectionIndex);

    const initials = useMemo(
        () =>
            candidateName
                .split(' ')
                .filter(Boolean)
                .map((n) => n[0])
                .join('')
                .toUpperCase()
                .slice(0, 2),
        [candidateName]
    );

    return (
        <header className="h-16 flex items-center justify-between px-5 bg-gradient-to-r from-exam-header-from to-exam-header-to border-b-2 border-exam-header-border">
            {/* Left: Section Tabs (CAT sections are LOCKED; keep tabs for UI, disable navigation) */}
            <div className="flex items-center gap-1 pl-36" role="tablist" aria-label="Exam sections">
                {SECTIONS.map((section, index) => {
                    const isActive = index === currentSectionIndex;
                    const displayName = section === 'DILR' ? 'LRDI' : section === 'QA' ? 'Quant' : section;

                    return (
                        <button
                            key={section}
                            type="button"
                            role="tab"
                            aria-selected={isActive}
                            aria-controls={`section-panel-${section}`}
                            disabled={!isActive}
                            className={`px-4 py-2 text-sm font-semibold rounded transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white focus-visible:ring-offset-2 focus-visible:ring-offset-[#0b3d91] ${isActive
                                ? 'bg-[#2D89EF] text-white'
                                : 'bg-white/10 text-white/60 opacity-70 cursor-not-allowed'
                                }`}
                            onClick={() => {
                                // Prevent accidental calls into store navigation that is intentionally restricted
                                if (isActive) onSectionSelect(section);
                            }}
                        >
                            {displayName}
                        </button>
                    );
                })}
            </div>

            {/* Center: Exam Title */}
            <h1 className="text-lg font-semibold text-white">{paper.title}</h1>

            {/* Right: Profile + Timer */}
            <div className="flex items-center gap-5">
                <div className="flex items-center gap-2 px-3 py-1.5 rounded bg-white/10">
                    {candidatePhotoUrl ? (
                        <img
                            src={candidatePhotoUrl}
                            alt=""
                            aria-hidden="true"
                            className="w-8 h-8 rounded-full object-cover border border-white/30"
                        />
                    ) : (
                        <div
                            className="w-8 h-8 rounded-full bg-[#2D89EF] flex items-center justify-center text-xs font-semibold text-white border border-white/30"
                            aria-hidden="true"
                        >
                            {initials}
                        </div>
                    )}
                    <span className="text-white text-sm">{candidateName}</span>
                </div>

                <div className="text-base font-bold text-timer font-mono">Time Left : {timeLeftDisplay}</div>

                <div className="flex items-center gap-2">
                    {allowPause && onPauseExam && (
                        <button
                            type="button"
                            onClick={onPauseExam}
                            className="px-2.5 py-1 rounded bg-white/10 text-white text-xs font-semibold hover:bg-white/20"
                        >
                            Pause
                        </button>
                    )}
                    <button
                        type="button"
                        onClick={onToggleCalculator}
                        className={`px-2.5 py-1 rounded text-xs font-semibold ${isCalculatorVisible ? 'bg-white text-[#0b3d91]' : 'bg-white/10 text-white hover:bg-white/20'
                            }`}
                    >
                        Calculator
                    </button>
                </div>
            </div>
        </header>
    );
}

// =============================================================================
// QUESTION METADATA BAR
// =============================================================================

interface QuestionMetadataBarProps {
    question: Question;
    questionNumber: number;
}

function QuestionMetadataBar({ question, questionNumber }: QuestionMetadataBarProps) {
    const marks =
        question.negative_marks > 0
            ? `+${question.positive_marks} / -${question.negative_marks}`
            : `+${question.positive_marks} / -0`;

    return (
        <div className="h-metadata-bar flex items-center justify-between px-5 bg-exam-bg-pane border-y border-exam-bg-border-light">
            <span className="text-[15px] font-semibold text-exam-text-primary">Question No. {questionNumber}</span>
            <span className="text-sm text-exam-text-secondary">
                Type : {question.question_type} | Marks : {marks}
            </span>
        </div>
    );
}

// =============================================================================
// QUESTION PANE
// =============================================================================

interface QuestionPaneProps {
    question: Question;
}

function QuestionPane({ question }: QuestionPaneProps) {
    return (
        <div className="w-full bg-exam-bg-white px-6 py-6">
            {question.question_image_url && (
                <div className="mb-5">
                    <img
                        src={question.question_image_url}
                        alt="Question diagram"
                        className="max-w-full max-h-64 w-auto h-auto object-contain rounded border border-gray-200"
                    />
                </div>
            )}

            <div className="text-[15px] leading-exam text-exam-text-body mb-5">
                <MathText text={question.question_text} />
            </div>

            {question.question_type === 'MCQ' ? <MCQRenderer question={question} /> : <TITARenderer question={question} />}
        </div>
    );
}

// =============================================================================
// CONTEXT PANE
// =============================================================================

interface ContextPaneProps {
    question: Question;
    sectionLabel: string;
}

function ContextPane({ question, sectionLabel }: ContextPaneProps) {
    const context = question.context;

    return (
        <div className="w-full h-full bg-exam-bg-white px-6 py-6 overflow-y-auto">
            <div className="mb-4">
                <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-600 text-white">
                    {sectionLabel}
                </span>
            </div>

            {context ? (
                <div>
                    {context.title && <h3 className="text-[15px] font-semibold text-exam-header-from mb-3">{context.title}</h3>}
                    {context.image_url && (
                        <div className="mb-4">
                            <img
                                src={context.image_url}
                                alt="Context diagram"
                                className="max-w-full max-h-64 w-auto h-auto object-contain rounded border border-gray-200"
                            />
                        </div>
                    )}
                    <div className="text-[15px] leading-exam text-exam-text-body whitespace-pre-wrap mb-5">
                        <MathText text={context.content} />
                    </div>
                </div>
            ) : (
                <div className="text-sm text-gray-500">No passage for this question.</div>
            )}
        </div>
    );
}

// =============================================================================
// MAIN LAYOUT
// =============================================================================

export function ExamLayout({
    paper,
    questions,
    onSaveResponse,
    onSaveResponsesBatch,
    onSubmitExam,
    onSectionExpire,
    onPauseExam,
    layoutMode = 'current',
    submissionProgress,
}: ExamLayoutProps) {
    const currentSection = useExamStore(selectCurrentSection);
    const currentQuestionIndex = useExamStore((s) => s.currentQuestionIndex);
    const currentSectionIndex = useExamStore((s) => s.currentSectionIndex);
    const responses = useExamStore((s) => s.responses);

    const goToQuestion = useExamStore((s) => s.goToQuestion);
    const toggleMarkForReview = useExamStore((s) => s.toggleMarkForReview);
    const clearAnswer = useExamStore((s) => s.clearAnswer);
    const saveAnswer = useExamStore((s) => s.saveAnswer);
    const setResponseStatus = useExamStore((s) => s.setResponseStatus);
    const updateTimeSpent = useExamStore((s) => s.updateTimeSpent);

    const queuePendingSync = useExamStore((s) => s.queuePendingSync);
    const pendingSyncResponses = useExamStore((s) => s.pendingSyncResponses);
    const clearPendingSync = useExamStore((s) => s.clearPendingSync);
    const setLastSyncTimestamp = useExamStore((s) => s.setLastSyncTimestamp);

    const isInitialized = useExamStore((s) => s.isInitialized);
    const isSubmitting = useExamStore((s) => s.isSubmitting);
    const isAutoSubmitting = useExamStore((s) => s.isAutoSubmitting);

    // Persist sidebar visibility to localStorage (prevents “lost sidebar” after refresh)
    const [isSidebarVisible, setIsSidebarVisible] = useState(() => {
        if (typeof window !== 'undefined') {
            const saved = localStorage.getItem('exam-sidebar-visible');
            return saved !== null ? saved === 'true' : true;
        }
        return true;
    });
    const [isCalculatorVisible, setIsCalculatorVisible] = useState(false);
    const [isSyncing, setIsSyncing] = useState(false);

    useEffect(() => {
        if (typeof window !== 'undefined') {
            localStorage.setItem('exam-sidebar-visible', String(isSidebarVisible));
        }
    }, [isSidebarVisible]);

    const hasPendingSync = useMemo(() => Object.keys(pendingSyncResponses).length > 0, [pendingSyncResponses]);

    const syncInFlight = useRef(false);
    const pendingSyncRef = useRef(pendingSyncResponses);

    // Keep ref in sync for unload handler / async flows
    useEffect(() => {
        pendingSyncRef.current = pendingSyncResponses;
    }, [pendingSyncResponses]);

    const runWithTimeout = useCallback(
        async <T,>(promise: Promise<T>, ms: number, label: string): Promise<T> => {
            let timeoutId: ReturnType<typeof setTimeout> | null = null;
            const timeoutPromise = new Promise<never>((_, reject) => {
                timeoutId = setTimeout(() => {
                    reject(new Error(`${label} timed out after ${ms}ms`));
                }, ms);
            });

            try {
                return await Promise.race([promise, timeoutPromise]);
            } finally {
                if (timeoutId) clearTimeout(timeoutId);
            }
        },
        []
    );

    // Sync Logic
    const syncPendingResponses = useCallback(async () => {
        if (!onSaveResponse && !onSaveResponsesBatch) return;
        if (syncInFlight.current) return;

        const entries = Object.entries(pendingSyncRef.current);
        if (entries.length === 0) return;

        const batchItems = onSaveResponsesBatch
            ? (entries
                .map(([questionId, payload]) => {
                    const response = responses[questionId];
                    if (!response) return null;
                    const answer = payload?.answer === '' ? null : (payload?.answer ?? null);
                    return {
                        questionId,
                        answer,
                        status: response.status,
                        isMarkedForReview: response.isMarkedForReview,
                        isVisited: response.status !== 'not_visited',
                        timeSpentSeconds: response.timeSpentSeconds,
                        visitCount: response.visitCount,
                    };
                })
                .filter(Boolean) as BatchSaveItem[])
            : null;

        if (onSaveResponsesBatch && (!batchItems || batchItems.length === 0)) return;

        syncInFlight.current = true;
        setIsSyncing(true);

        const succeeded: string[] = [];
        try {
            if (onSaveResponsesBatch && batchItems) {
                try {
                    const result = await onSaveResponsesBatch(batchItems);
                    let failedIds: Set<string> | null = null;
                    if (result && typeof result === 'object' && 'success' in result && result.success === false) {
                        const ids = Array.isArray(result.failedQuestionIds) ? result.failedQuestionIds : [];
                        failedIds = new Set(ids.length > 0 ? ids : batchItems.map((item) => item.questionId));
                    }

                    for (const item of batchItems) {
                        if (!failedIds || !failedIds.has(item.questionId)) {
                            succeeded.push(item.questionId);
                        }
                    }
                } catch {
                    // keep all pending; next sync attempt will retry
                }
            } else if (onSaveResponse) {
                for (const [questionId, payload] of entries) {
                    // Normalize empty-string to null (backend usually expects null for "no answer")
                    const answer = payload?.answer === '' ? null : (payload?.answer ?? null);

                    try {
                        await onSaveResponse(questionId, answer);
                        succeeded.push(questionId);
                    } catch {
                        // keep it pending; next sync attempt will retry
                    }
                }
            }

            if (succeeded.length > 0) {
                clearPendingSync(succeeded);
                setLastSyncTimestamp(Date.now());
            }
        } finally {
            syncInFlight.current = false;
            setIsSyncing(false);
        }
    }, [onSaveResponse, onSaveResponsesBatch, responses, clearPendingSync, setLastSyncTimestamp]);

    // Auto-sync pending responses shortly after changes (best-effort)
    useEffect(() => {
        if (!hasPendingSync) return;
        const timeoutId = setTimeout(() => {
            void syncPendingResponses();
        }, 3000);

        return () => clearTimeout(timeoutId);
    }, [hasPendingSync, pendingSyncResponses, syncPendingResponses]);

    // Ref to coordinate auto-submit vs manual submit
    const autoSubmitInProgressRef = useRef(false);
    // Track sync-in-progress for submit coordination
    const submitSyncCompletedRef = useRef(false);
    // CRITICAL: Track if auto-submit has COMPLETED successfully - prevents re-entry forever
    const autoSubmitCompletedRef = useRef(false);

    const handleAutoSubmitExam = useCallback(async () => {
        // CRITICAL: If auto-submit has already completed, never process again
        if (autoSubmitCompletedRef.current) {
            console.log('[ExamLayout] Auto-submit skipped: already completed');
            return;
        }

        // RACE CONDITION FIX: Only block if MANUAL submit is in progress
        // DO NOT check isAutoSubmittingFromStore here - that flag is set by the timer
        // BEFORE calling this function, so checking it would block the auto-submit itself!
        if (isSubmitting) {
            console.log('[ExamLayout] Auto-submit skipped: manual submit in progress');
            return;
        }

        // Prevent duplicate auto-submit calls via ref (synchronous check)
        if (autoSubmitInProgressRef.current) {
            console.log('[ExamLayout] Auto-submit skipped: already in progress (ref)');
            return;
        }
        autoSubmitInProgressRef.current = true;
        console.log('[ExamLayout] Auto-submit STARTING');

        try {
            // Only sync if not already synced by another submit path
            if (!submitSyncCompletedRef.current && !syncInFlight.current) {
                try {
                    await runWithTimeout(syncPendingResponses(), 8000, 'syncPendingResponses');
                    submitSyncCompletedRef.current = true;
                } catch {
                    // best-effort; still submit
                }
            }
        } catch {
            // best-effort
        }
        try {
            await runWithTimeout(onSubmitExam?.() ?? Promise.resolve(), 20000, 'onSubmitExam');
            // Mark as completed ONLY after successful submission
            autoSubmitCompletedRef.current = true;
            console.log('[ExamLayout] Auto-submit COMPLETED SUCCESSFULLY');
        } finally {
            autoSubmitInProgressRef.current = false;
            submitSyncCompletedRef.current = false;
            console.log('[ExamLayout] Auto-submit FINISHED');
        }
    }, [syncPendingResponses, onSubmitExam, isSubmitting, runWithTimeout]);

    const handleSectionExpire = useCallback(
        async (sectionName: SectionName) => {
            try {
                await runWithTimeout(syncPendingResponses(), 8000, 'syncPendingResponses');
            } catch {
                // best-effort
            }
            try {
                await runWithTimeout(
                    onSectionExpire?.(sectionName) ?? Promise.resolve(),
                    8000,
                    'onSectionExpire'
                );
            } catch {
                // best-effort
            }
        },
        [syncPendingResponses, onSectionExpire, runWithTimeout]
    );

    // Timer controller lives in a leaf component to avoid 1Hz re-renders of the full layout.

    const handleManualSubmitExam = useCallback(async () => {
        // Also check the autoSubmitInProgressRef for extra safety
        if (isSyncing || isSubmitting || isAutoSubmitting || autoSubmitInProgressRef.current) {
            console.log('[ExamLayout] Manual submit blocked', { isSyncing, isSubmitting, isAutoSubmitting, autoSubmitInProgress: autoSubmitInProgressRef.current });
            return;
        }

        const confirmed = window.confirm('Are you sure you want to submit the exam? This action cannot be undone.');
        if (!confirmed) return;

        try {
            // Only sync if not already synced
            if (!submitSyncCompletedRef.current && !syncInFlight.current) {
                await runWithTimeout(syncPendingResponses(), 8000, 'syncPendingResponses');
                submitSyncCompletedRef.current = true;
            }
        } catch {
            // best-effort; still submit
        }
        try {
            await runWithTimeout(onSubmitExam?.() ?? Promise.resolve(), 20000, 'onSubmitExam');
        } finally {
            submitSyncCompletedRef.current = false;
        }
    }, [isSyncing, isSubmitting, isAutoSubmitting, syncPendingResponses, onSubmitExam, runWithTimeout]);

    const sectionQuestions = useMemo(() => getQuestionsForSection(questions, currentSection), [questions, currentSection]);
    const currentQuestion = sectionQuestions[currentQuestionIndex];

    // Track per-question time spent while the exam is active
    useEffect(() => {
        if (!isInitialized || isSubmitting || isAutoSubmitting) return;
        if (!currentQuestion?.id) return;

        let lastTick = Date.now();
        const interval = setInterval(() => {
            const now = Date.now();
            if (document.hidden) {
                lastTick = now;
                return;
            }
            const deltaSeconds = Math.floor((now - lastTick) / 1000);
            if (deltaSeconds > 0) {
                updateTimeSpent(currentQuestion.id, deltaSeconds);
                lastTick = now;
            }
        }, 1000);

        return () => clearInterval(interval);
    }, [currentQuestion?.id, isInitialized, isSubmitting, isAutoSubmitting, updateTimeSpent]);

    // Tabs are disabled, but keep handler in case you later allow same-section jumps.
    const handleSectionSelect = useCallback(
        (section: SectionName) => {
            const sectionIndex = SECTIONS.indexOf(section);
            const sectionQs = getQuestionsForSection(questions, section);
            const firstQuestion = sectionQs[0];

            if (firstQuestion) {
                goToQuestion(firstQuestion.id, sectionIndex, 0);
            }
        },
        [questions, goToQuestion]
    );

    const handleSaveNext = useCallback(() => {
        if (!currentQuestion) return;
        if (isSyncing || isSubmitting || isAutoSubmitting) return;

        const response = responses[currentQuestion.id];

        if (response) {
            const hasAnswer = response.answer !== null && response.answer !== undefined && response.answer !== '';
            const answer = hasAnswer ? response.answer : null;

            if (hasAnswer) {
                saveAnswer(currentQuestion.id, response.answer);
            } else {
                setResponseStatus(currentQuestion.id, 'visited', false);
            }

            // Always queue the latest answer on Save & Next (prevents “saved locally but never synced”)
            queuePendingSync(currentQuestion.id, answer);
        }

        if (currentQuestionIndex < sectionQuestions.length - 1) {
            const nextQ = sectionQuestions[currentQuestionIndex + 1];
            goToQuestion(nextQ.id, currentSectionIndex, currentQuestionIndex + 1);
        }
    }, [
        currentQuestion,
        responses,
        saveAnswer,
        setResponseStatus,
        queuePendingSync,
        currentQuestionIndex,
        sectionQuestions,
        goToQuestion,
        currentSectionIndex,
        isSyncing,
        isSubmitting,
        isAutoSubmitting,
    ]);

    const handleClearResponse = useCallback(() => {
        if (!currentQuestion) return;
        if (isSyncing || isSubmitting || isAutoSubmitting) return;
        clearAnswer(currentQuestion.id);
        // clearAnswer action already queues pending sync in the store
    }, [currentQuestion, clearAnswer, isSyncing, isSubmitting, isAutoSubmitting]);

    const handleMarkForReview = useCallback(() => {
        if (!currentQuestion) return;
        if (isSyncing || isSubmitting || isAutoSubmitting) return;

        const response = responses[currentQuestion.id];
        const hasLocalAnswer = response?.answer !== null && response?.answer !== '' && response?.answer !== undefined;

        if (hasLocalAnswer) {
            toggleMarkForReview(currentQuestion.id);
            saveAnswer(currentQuestion.id, response!.answer);
            queuePendingSync(currentQuestion.id, response!.answer ?? null);
        } else {
            toggleMarkForReview(currentQuestion.id);
            setResponseStatus(currentQuestion.id, 'marked', true);
            queuePendingSync(currentQuestion.id, null);
        }

        if (currentQuestionIndex < sectionQuestions.length - 1) {
            const nextQ = sectionQuestions[currentQuestionIndex + 1];
            goToQuestion(nextQ.id, currentSectionIndex, currentQuestionIndex + 1);
        }
    }, [
        currentQuestion,
        responses,
        toggleMarkForReview,
        saveAnswer,
        setResponseStatus,
        queuePendingSync,
        currentQuestionIndex,
        sectionQuestions,
        goToQuestion,
        currentSectionIndex,
        isSyncing,
        isSubmitting,
        isAutoSubmitting,
    ]);

    // Try to sync before unload if anything is pending (best-effort)
    useEffect(() => {
        const handleBeforeUnload = (event: BeforeUnloadEvent) => {
            if (Object.keys(pendingSyncRef.current).length === 0) return;
            void syncPendingResponses();
            event.preventDefault();
            event.returnValue = '';
        };

        window.addEventListener('beforeunload', handleBeforeUnload);
        return () => window.removeEventListener('beforeunload', handleBeforeUnload);
    }, [syncPendingResponses]);

    // Calculator hotkey: Ctrl+Shift+C
    // Sidebar toggle hotkey: Ctrl+B
    useEffect(() => {
        const handleKeyDown = (event: KeyboardEvent) => {
            if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'c') {
                event.preventDefault();
                setIsCalculatorVisible((prev) => !prev);
            }
            if (event.ctrlKey && !event.shiftKey && event.key.toLowerCase() === 'b') {
                event.preventDefault();
                setIsSidebarVisible((prev) => !prev);
            }
        };

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, []);

    // Loading State
    if (!isInitialized) {
        return (
            <div className="min-h-screen bg-exam-bg-page flex items-center justify-center">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-section-varc mx-auto mb-4" />
                    <p className="text-exam-text-muted">Loading exam...</p>
                </div>
            </div>
        );
    }

    // Submitting State
    if (isSubmitting || isAutoSubmitting) {
        const title = isAutoSubmitting ? 'Time is up - submitting your attempt' : 'Submitting your attempt';
        const subtitle = isAutoSubmitting
            ? 'Locking your answers and finalizing your score.'
            : 'Locking answers, validating session, and building analytics.';
        const progressPercent = submissionProgress?.percent ?? 66;
        const progressSteps = submissionProgress?.steps ?? [
            { label: 'Validating session', status: 'active' as const },
            { label: 'Saving responses', status: 'pending' as const },
            { label: 'Submitting exam', status: 'pending' as const },
            { label: 'Preparing analysis', status: 'pending' as const },
        ];
        const activeLabel = submissionProgress?.activeLabel ?? 'Preparing analysis';

        return (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-950 via-blue-950 to-indigo-950 text-white">
                <div className="relative w-full max-w-xl px-6">
                    <div className="absolute -inset-6 rounded-3xl bg-[radial-gradient(circle_at_top,rgba(59,130,246,0.25),transparent_55%)] blur-2xl" />
                    <div className="relative rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl px-6 py-8 shadow-2xl">
                        <div className="flex items-center gap-4">
                            <div className="relative h-12 w-12 rounded-2xl bg-white/10 border border-white/15 flex items-center justify-center">
                                <div className="absolute inset-1 rounded-xl border border-white/20 animate-pulse" />
                                <div className="h-5 w-5 rounded-full border-2 border-white border-t-transparent animate-spin" />
                            </div>
                            <div>
                                <p className="text-lg font-semibold">{title}</p>
                                <p className="text-sm text-white/70">{subtitle}</p>
                            </div>
                        </div>

                        <div className="mt-6 space-y-3">
                            <div className="h-2 w-full rounded-full bg-white/10 overflow-hidden">
                                <div
                                    className="h-full bg-gradient-to-r from-emerald-400 via-cyan-400 to-blue-500 transition-all duration-500"
                                    style={{ width: `${Math.min(100, Math.max(5, progressPercent))}%` }}
                                />
                            </div>
                            <div className="flex items-center justify-between text-xs text-white/60">
                                {progressSteps.map((step) => (
                                    <span
                                        key={step.label}
                                        className={step.status === 'active' ? 'text-white' : step.status === 'done' ? 'text-emerald-200' : ''}
                                    >
                                        {step.label}
                                    </span>
                                ))}
                            </div>
                            <div className="text-xs text-white/70">Current step: {activeLabel}</div>
                            <p className="text-xs text-white/50">
                                Please keep this tab open. This usually takes a few seconds.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    if (!currentQuestion) {
        return (
            <div className="min-h-screen bg-exam-bg-page flex items-center justify-center">
                <div className="text-center">
                    <p className="text-exam-text-muted">No questions found for this section.</p>
                </div>
            </div>
        );
    }

    const isLastSection = currentSectionIndex === 2;

    const hasContext = Boolean(
        currentQuestion.context &&
        (currentQuestion.context.title || currentQuestion.context.content || currentQuestion.context.image_url)
    );

    const sectionLabel = currentSection === 'DILR' ? 'LRDI' : currentSection === 'QA' ? 'Quant' : currentSection;

    const getGridCols = () => {
        if (layoutMode === 'three-column') {
            if (isSidebarVisible) return 'grid-cols-[48%_33%_19%]';
            return hasContext ? 'grid-cols-[48%_52%]' : 'grid-cols-1';
        }
        if (!hasContext) {
            return isSidebarVisible ? 'grid-cols-[81%_19%]' : 'grid-cols-1';
        }
        return isSidebarVisible ? 'grid-cols-[48%_33%_19%]' : 'grid-cols-[48%_52%]';
    };

    const questionPaneColSpan = layoutMode === 'three-column' && !hasContext && isSidebarVisible ? 'col-span-2' : '';

    return (
        <div className="relative h-screen w-screen overflow-hidden flex flex-col min-h-0 min-w-0 font-exam text-sm leading-normal bg-exam-bg-page">
            <ExamTimerController onSectionExpire={handleSectionExpire} onExamComplete={handleAutoSubmitExam} />

            <ExamHeaderContainer
                paper={paper}
                onSectionSelect={handleSectionSelect}
                onToggleCalculator={() => setIsCalculatorVisible((prev) => !prev)}
                isCalculatorVisible={isCalculatorVisible}
                onPauseExam={onPauseExam}
                allowPause={paper.allow_pause !== false}
            />

            {!isSidebarVisible && (
                <button
                    type="button"
                    onClick={() => setIsSidebarVisible(true)}
                    className="absolute z-30 top-24 right-2 px-3 py-2 rounded-full bg-slate-900 text-white text-xs shadow-lg hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#2D89EF]"
                    aria-label="Open navigation"
                >
                    Open Navigation
                </button>
            )}

            <div className="flex-1 flex flex-col overflow-hidden min-h-0">
                <div className={`flex-1 grid overflow-hidden min-h-0 min-w-0 ${getGridCols()}`}>
                    {hasContext && (
                        <div className="border-r border-exam-bg-border-light min-h-0">
                            <ContextPane question={currentQuestion} sectionLabel={sectionLabel} />
                        </div>
                    )}

                    <div className={`relative flex flex-col bg-exam-bg-white min-h-0 min-w-0 ${questionPaneColSpan}`}>
                        <QuestionMetadataBar question={currentQuestion} questionNumber={currentQuestionIndex + 1} />

                        <div className="flex-1 overflow-y-auto min-h-0">
                            <QuestionPane question={currentQuestion} />
                        </div>

                        {/* Sidebar toggle kept INSIDE pane (no negative right), so it never gets clipped by overflow-hidden parents */}
                        <button
                            type="button"
                            onClick={() => setIsSidebarVisible((prev) => !prev)}
                            className="absolute z-20 top-1/2 right-0 -translate-y-1/2 w-6 h-12 rounded-r bg-slate-200 border border-slate-300 shadow-sm flex items-center justify-center text-xs text-slate-600 hover:bg-slate-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#2D89EF]"
                            aria-label={isSidebarVisible ? 'Hide sidebar' : 'Show sidebar'}
                        >
                            {isSidebarVisible ? '›' : '‹'}
                        </button>
                    </div>

                    {isSidebarVisible && (
                        <aside className="border-l border-exam-bg-border-light flex flex-col bg-slate-50 overflow-y-auto min-h-0 min-w-0">
                            <QuestionPalette
                                questions={questions}
                                className="h-full rounded-none shadow-none border-0 bg-transparent sticky top-0"
                            />
                        </aside>
                    )}
                </div>

                <ExamFooter
                    onSaveNext={handleSaveNext}
                    onClear={handleClearResponse}
                    onMarkReview={handleMarkForReview}
                    onSubmit={handleManualSubmitExam}
                    isLastSection={isLastSection}
                    isSaving={isSyncing}
                    isSubmitting={isSubmitting}
                    isAutoSubmitting={isAutoSubmitting}
                    isSidebarVisible={isSidebarVisible}
                />
            </div>

            <Calculator isVisible={isCalculatorVisible} onClose={() => setIsCalculatorVisible(false)} />
        </div>
    );
}
````

## File: src/app/exam/[attemptId]/page.tsx
````typescript
/**
 * @fileoverview Exam Page (Server Component)
 * @description Fetches exam data and renders the client-side exam interface
 * @blueprint Milestone 4 SOP-SSOT - Exam Engine
 */

import { sbSSR } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { ExamClient } from '@/features/exam-engine/lib/ExamClient';
import { BackToDashboard } from '@/components/BackToDashboard';
import type {
    Paper,
    Question,
    Attempt,
    SectionConfig,
    QuestionSetComplete,
    QuestionSetMetadata,
    QuestionSetType,
    ContentLayoutType,
    QuestionType,
    SectionName,
    QuestionContext,
    Response,
} from '@/types/exam';
import { buildLegacyQuestionSets } from '@/utils/question-sets';
import { assemblePaper } from '@/features/exam-engine/lib/assemblePaper';
import { logger } from '@/lib/logger';

type PageProps = {
    params: { attemptId: string } | Promise<{ attemptId: string }>;
};

type PaperRow = {
    id: string;
    slug: string;
    title: string;
    description?: string | null;
    year: number;
    total_questions: number;
    total_marks: number;
    duration_minutes: number;
    sections: SectionConfig[];
    default_positive_marks: number;
    default_negative_marks: number;
    published: boolean;
    available_from?: string | null;
    available_until?: string | null;
    difficulty_level?: Paper['difficulty_level'] | null;
    is_free: boolean;
    attempt_limit?: number | null;
    allow_pause?: boolean | null;
    created_at: string;
    updated_at: string;
};

type ResponseRow = {
    id: string;
    attempt_id: string;
    question_id: string;
    answer: string | null;
    status: Response['status'];
    is_marked_for_review?: boolean | null;
    is_visited?: boolean | null;
    time_spent_seconds?: number | null;
    visit_count?: number | null;
    created_at: string;
    updated_at: string;
};

export default async function ExamPage({ params }: PageProps) {
    const { attemptId } = await params;

    if (!attemptId || typeof attemptId !== 'string') {
        return (
            <main className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="text-center">
                    <h1 className="text-2xl font-bold text-gray-800 mb-4">Invalid Attempt</h1>
                    <p className="text-gray-600 mb-6">The attempt id is missing or invalid.</p>
                    <BackToDashboard />
                </div>
            </main>
        );
    }

    const supabase = await sbSSR();

    const {
        data: { user },
        error: userError,
    } = await supabase.auth.getUser();

    if (userError || !user) {
        redirect(`/auth/sign-in?redirect_to=${encodeURIComponent(`/exam/${attemptId}`)}`);
    }

    // Get attempt with paper details
    const { data: attemptData, error: attemptError } = await supabase
        .from('attempts')
        .select(
            `
            id, user_id, paper_id, status, started_at, submitted_at, completed_at,
            current_section, current_question, time_remaining,
            total_score, correct_count, incorrect_count, unanswered_count,
            section_scores, percentile, rank, created_at, updated_at,
            papers (
                id, slug, title, description, year,
                total_questions, total_marks, duration_minutes, sections,
                default_positive_marks, default_negative_marks,
                published, available_from, available_until,
                difficulty_level, is_free, attempt_limit, allow_pause,
                created_at, updated_at
            )
        `
        )
        .eq('id', attemptId)
        .single();

    if (attemptError || !attemptData) {
        return (
            <main className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="text-center">
                    <h1 className="text-2xl font-bold text-gray-800 mb-4">Attempt Not Found</h1>
                    <p className="text-gray-600 mb-6">
                        This exam attempt does not exist or you don&apos;t have access to it.
                    </p>
                    <BackToDashboard />
                </div>
            </main>
        );
    }

    // Verify user owns this attempt
    if (attemptData.user_id !== user.id) {
        return (
            <main className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="text-center">
                    <h1 className="text-2xl font-bold text-gray-800 mb-4">Unauthorized</h1>
                    <p className="text-gray-600 mb-6">You don&apos;t have access to this exam attempt.</p>
                    <BackToDashboard />
                </div>
            </main>
        );
    }

    // Check if attempt is already completed
    if (attemptData.status === 'completed' || attemptData.status === 'submitted') {
        redirect(`/result/${attemptId}`);
    }

    // CRITICAL FIX: Allow both in_progress and paused attempts to continue
    // Paused exams should be resumable without showing "Attempt Not Available" error
    if (attemptData.status !== 'in_progress' && attemptData.status !== 'paused') {
        // Handle abandoned status with a clearer message
        const isAbandoned = attemptData.status === 'abandoned';
        return (
            <main className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="text-center">
                    <h1 className="text-2xl font-bold text-gray-800 mb-4">
                        {isAbandoned ? 'Exam Session Ended' : 'Attempt Not Available'}
                    </h1>
                    <p className="text-gray-600 mb-6">
                        {isAbandoned
                            ? 'This exam session has ended. If you believe this is an error, please contact support.'
                            : 'This exam attempt is not in progress and cannot be resumed.'}
                    </p>
                    <BackToDashboard />
                </div>
            </main>
        );
    }

    // Supabase can return a single relation as object OR array depending on relationship config.
    const paperRaw = attemptData.papers as unknown;
    const paperData =
        Array.isArray(paperRaw) && paperRaw.length > 0
            ? (paperRaw[0] as PaperRow | null)
            : (paperRaw as PaperRow | null);

    if (!paperData?.id) {
        return (
            <main className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="text-center">
                    <h1 className="text-2xl font-bold text-gray-800 mb-4">Paper Not Found</h1>
                    <p className="text-gray-600 mb-6">This attempt is missing its paper data.</p>
                    <BackToDashboard />
                </div>
            </main>
        );
    }

    const paper: Paper = {
        id: paperData.id,
        slug: paperData.slug,
        title: paperData.title,
        description: paperData.description ?? undefined,
        year: paperData.year,
        total_questions: paperData.total_questions,
        total_marks: paperData.total_marks,
        duration_minutes: paperData.duration_minutes,
        sections: paperData.sections as SectionConfig[],
        default_positive_marks: paperData.default_positive_marks,
        default_negative_marks: paperData.default_negative_marks,
        published: paperData.published,
        available_from: paperData.available_from ?? undefined,
        available_until: paperData.available_until ?? undefined,
        difficulty_level: paperData.difficulty_level as Paper['difficulty_level'],
        is_free: paperData.is_free,
        attempt_limit: paperData.attempt_limit ?? undefined,
        allow_pause: paperData.allow_pause ?? true,
        created_at: paperData.created_at,
        updated_at: paperData.updated_at,
    };

    const attempt: Attempt = {
        id: attemptData.id,
        user_id: attemptData.user_id,
        paper_id: attemptData.paper_id,
        started_at: attemptData.started_at,
        submitted_at: attemptData.submitted_at ?? undefined,
        completed_at: attemptData.completed_at ?? undefined,
        status: attemptData.status as Attempt['status'],
        current_section: attemptData.current_section as Attempt['current_section'],
        current_question: attemptData.current_question ?? 1,
        time_remaining: attemptData.time_remaining as Attempt['time_remaining'],
        total_score: attemptData.total_score ?? undefined,
        correct_count: attemptData.correct_count ?? 0,
        incorrect_count: attemptData.incorrect_count ?? 0,
        unanswered_count: attemptData.unanswered_count ?? 0,
        section_scores: attemptData.section_scores as Attempt['section_scores'],
        percentile: attemptData.percentile ?? undefined,
        rank: attemptData.rank ?? undefined,
        created_at: attemptData.created_at,
        updated_at: attemptData.updated_at,
    };

    type QuestionSetViewRow = {
        id: string;
        paper_id: string;
        section: string;
        set_type: string;
        content_layout: string;
        context_title?: string | null;
        context_body?: string | null;
        context_image_url?: string | null;
        context_additional_images?: unknown;
        display_order: number;
        question_count: number;
        metadata?: QuestionSetMetadata | null;
        is_active: boolean;
        is_published: boolean;
        created_at: string;
        updated_at: string;
        questions: Array<{
            id: string;
            question_text: string;
            question_type: string;
            options: unknown;
            positive_marks: number;
            negative_marks: number;
            question_number: number;
            sequence_order: number | null;
            question_image_url?: string | null;
            difficulty?: string | null;
            topic?: string | null;
            subtopic?: string | null;
            is_active: boolean;
        }>;
    };

    // Prefer set-aware view when available
    const { data: questionSetRows, error: questionSetError } = await supabase
        .from('question_sets_with_questions')
        .select('*')
        .eq('paper_id', attemptData.paper_id);

    if (questionSetError) {
        logger?.warn?.('Failed to fetch question_sets_with_questions', questionSetError, {
            paperId: attemptData.paper_id,
            attemptId,
        });
    }

    let questionSets: QuestionSetComplete[] = [];

    if (questionSetRows && questionSetRows.length > 0) {
        questionSets = (questionSetRows as QuestionSetViewRow[]).map((row) => ({
            id: row.id,
            paper_id: row.paper_id,
            section: row.section as SectionName,
            set_type: row.set_type as QuestionSetType,
            content_layout: row.content_layout as ContentLayoutType,
            context_title: row.context_title ?? undefined,
            context_body: row.context_body ?? undefined,
            context_image_url: row.context_image_url ?? undefined,
            context_additional_images: Array.isArray(row.context_additional_images)
                ? (row.context_additional_images as QuestionSetComplete['context_additional_images'])
                : [],
            display_order: row.display_order,
            question_count: row.question_count,
            metadata: (row.metadata ?? {}) as QuestionSetMetadata,
            is_active: row.is_active,
            is_published: row.is_published,
            created_at: row.created_at,
            updated_at: row.updated_at,
            questions: (row.questions ?? []).map((q, index) => ({
                id: q.id,
                set_id: row.id,
                paper_id: row.paper_id,
                section: row.section as SectionName,
                sequence_order: q.sequence_order ?? index + 1,
                question_number: q.question_number,
                question_text: q.question_text,
                question_type: q.question_type as QuestionType,
                options: q.options as Question['options'],
                positive_marks: q.positive_marks,
                negative_marks: q.negative_marks,
                question_image_url: q.question_image_url ?? undefined,
                difficulty: q.difficulty as Question['difficulty'],
                topic: q.topic ?? undefined,
                subtopic: q.subtopic ?? undefined,
                is_active: q.is_active,
            })),
        }));

        // IMPORTANT: Supabase .order('section') sorts alphabetically (DILR, QA, VARC),
        // which is not the exam flow order. Force deterministic section ordering in JS.
        const sectionOrder: Record<SectionName, number> = { VARC: 0, DILR: 1, QA: 2 };
        questionSets.sort((a, b) => {
            const sd = (sectionOrder[a.section] ?? 99) - (sectionOrder[b.section] ?? 99);
            if (sd) return sd;
            return (a.display_order ?? 9999) - (b.display_order ?? 9999);
        });
    }

    // Fallback to legacy assembly if set view not available / empty
    if (questionSets.length === 0) {
        const { data: questionsData, error: questionsError } = await supabase
            .from('questions_exam')
            .select('*')
            .eq('paper_id', attemptData.paper_id)
            .eq('is_active', true)
            .order('question_number');

        if (questionsError || !questionsData) {
            return (
                <main className="min-h-screen flex items-center justify-center bg-gray-50">
                    <div className="text-center max-w-xl px-4">
                        <h1 className="text-2xl font-bold text-gray-800 mb-4">Failed to Load Questions</h1>
                        <p className="text-gray-600 mb-2">There was an error loading the exam questions.</p>
                        <p className="text-gray-600 mb-6">
                            Ensure the secure questions_exam view and its RLS policies are deployed.
                        </p>
                        <BackToDashboard />
                    </div>
                </main>
            );
        }

        // Force correct section ordering (VARC → DILR → QA)
        const sectionOrder: Record<SectionName, number> = { VARC: 0, DILR: 1, QA: 2 };
        const orderedQuestions = [...(questionsData as Question[])].sort((a, b) => {
            const sd = (sectionOrder[a.section] ?? 99) - (sectionOrder[b.section] ?? 99);
            if (sd) return sd;
            return (a.question_number ?? 0) - (b.question_number ?? 0);
        });

        const contextIds = Array.from(
            new Set(
                orderedQuestions
                    .map((q) => q.context_id)
                    .filter((id): id is string => Boolean(id))
            )
        );

        let contexts: QuestionContext[] = [];
        if (contextIds.length > 0) {
            const { data: contextsData, error: contextsError } = await supabase
                .from('question_contexts')
                .select(
                    'id, title, section, content, context_type, paper_id, display_order, is_active, image_url, created_at, updated_at'
                )
                .in('id', contextIds);

            if (contextsError) {
                logger?.warn?.('Failed to fetch question_contexts', contextsError, {
                    paperId: attemptData.paper_id,
                    attemptId,
                });
            } else {
                contexts = (contextsData ?? []) as QuestionContext[];
            }
        }

        questionSets = buildLegacyQuestionSets(orderedQuestions, contexts, attemptData.paper_id);
    }

    const { questions: assembledQuestions } = assemblePaper(questionSets);
    // Hide topic/subtopic metadata + context titles during active exam attempts.
    const questions = assembledQuestions.map((question) => ({
        ...question,
        topic: undefined,
        subtopic: undefined,
        context: question.context
            ? {
                ...question.context,
                title: undefined,
            }
            : undefined,
    }));

    const { data: responseRows, error: responsesError } = await supabase
        .from('responses')
        .select(
            'id, attempt_id, question_id, answer, status, is_marked_for_review, is_visited, time_spent_seconds, visit_count, created_at, updated_at'
        )
        .eq('attempt_id', attemptId);

    if (responsesError) {
        logger?.warn?.('Failed to fetch responses for exam page', responsesError, { attemptId });
    }

    const responses: Response[] = (responseRows as ResponseRow[] ?? []).map((r) => ({
        id: r.id,
        attempt_id: r.attempt_id,
        question_id: r.question_id,
        answer: r.answer,
        status: r.status,
        is_marked_for_review: r.is_marked_for_review ?? false,
        is_visited: r.is_visited ?? false,
        time_spent_seconds: r.time_spent_seconds ?? 0,
        visit_count: r.visit_count ?? 0,
        created_at: r.created_at,
        updated_at: r.updated_at,
    }));

    return (
        <>
            <BackToDashboard variant="fixed" />
            <ExamClient key={attempt.id} paper={paper} questions={questions} attempt={attempt} responses={responses} />
        </>
    );
}
````

## File: src/app/api/submit/route.ts
````typescript
/**
 * @fileoverview Submit Exam API Route
 * @description Submits exam attempt and triggers scoring
 * @blueprint Security Audit - P0 Fix - Rate Limiting, Integrity & Session Locking
 * @blueprint Phase 4 - Idempotent submit (duplicate calls return success)
 */

import { NextRequest, NextResponse } from 'next/server';
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { checkRateLimit, RATE_LIMITS, userRateLimitKey, getRateLimitHeaders } from '@/lib/rate-limit';
import { submitExam } from '@/features/exam-engine/lib/actions';
import { examLogger } from '@/lib/logger';
import { getServiceRoleClient } from '@/lib/supabase/service-role';
import {
    isNonEmptyString,
    getSupabaseConfig,
    serverMisconfiguredResponse,
    addVersionHeader,
} from '../_utils/validation';

type ValidateSessionResult = { data: boolean | null; error: { code?: string; message?: string } | null };

function isMissingValidateFn(error?: { code?: string; message?: string } | null): boolean {
    if (!error) return false;
    return error.code === '42883' || Boolean(error.message?.includes('validate_session_token'));
}

async function validateSessionTokenRpc(
    supabase: { rpc: (fn: string, args: Record<string, unknown>) => PromiseLike<ValidateSessionResult> },
    attemptId: string,
    sessionToken: string,
    userId: string
): Promise<ValidateSessionResult> {
    const primary = await supabase.rpc('validate_session_token', {
        p_attempt_id: attemptId,
        p_session_token: sessionToken,
        p_user_id: userId,
    });

    if (!primary.error || !isMissingValidateFn(primary.error)) return primary;

    return supabase.rpc('validate_session_token', {
        p_attempt_id: attemptId,
        p_session_token: sessionToken,
        p_user_id: userId,
        p_force_resume: false,
    });
}

export async function POST(req: NextRequest) {
    const res = NextResponse.next();

    try {
        const { attemptId, sessionToken, force_resume, submissionId } = await req.json();

        if (!isNonEmptyString(attemptId)) {
            return addVersionHeader(NextResponse.json({ error: 'attemptId required' }, { status: 400 }));
        }

        // Attempt ID from body; also try to extract from Referer as a fallback.
        const referer = req.headers.get('referer') ?? '';
        let refererAttemptId: string | null = null;
        try {
            const path = new URL(referer).pathname;
            const parts = path.split('/');
            if (parts[1] === 'exam' && parts[2]) refererAttemptId = parts[2];
        } catch {
            // ignore malformed referer
        }

        console.log('SUBMIT_ATTEMPT_ID_RECEIVED:', attemptId, 'submissionId:', submissionId ?? 'none');
        if (refererAttemptId) {
            console.log('SUBMIT_REFERER_ATTEMPT_ID:', refererAttemptId);
        }

        const config = getSupabaseConfig();
        if (!config) {
            return addVersionHeader(serverMisconfiguredResponse());
        }

        const supabase = createServerClient(config.url, config.anonKey, {
            cookies: {
                getAll() {
                    return req.cookies.getAll();
                },
                setAll(cookiesToSet: Array<{ name: string; value: string; options: CookieOptions }>) {
                    cookiesToSet.forEach(({ name, value, options }) => {
                        res.cookies.set({ name, value, ...options });
                    });
                },
            },
        });

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            const unauthorized = addVersionHeader(NextResponse.json({ error: 'Unauthorized' }, { status: 401 }));
            res.cookies.getAll().forEach((cookie) => unauthorized.cookies.set(cookie));
            return unauthorized;
        }

        // P0 FIX: Rate limiting for submissions (strict - 5 per minute)
        const rateLimitKey = userRateLimitKey('submit', user.id);
        const rateLimitResult = checkRateLimit(rateLimitKey, RATE_LIMITS.SUBMIT_EXAM);

        if (!rateLimitResult.allowed) {
            const headers = getRateLimitHeaders(rateLimitResult, RATE_LIMITS.SUBMIT_EXAM.limit);
            return addVersionHeader(NextResponse.json(
                {
                    error: 'Too many submission attempts. Please wait before trying again.',
                    retryAfterSeconds: Math.ceil(rateLimitResult.retryAfterMs / 1000),
                },
                { status: 429, headers }
            ));
        }

        const adminClient = getServiceRoleClient();
        let { data: attempt, error: attemptError } = await adminClient
            .from('attempts')
            .select('id, user_id, status')
            .eq('id', attemptId)
            .maybeSingle();

        // If the schema doesn't have submission_id, avoid hard failure by retrying without it.
        if (attemptError?.code === '42703') {
            const retry = await adminClient
                .from('attempts')
                .select('id, user_id, status')
                .eq('id', attemptId)
                .maybeSingle();
            attempt = retry.data ?? attempt;
            attemptError = retry.error ?? null;
        }

        console.log('SUBMIT_ATTEMPT_QUERY_RESULT:', attempt);

        // Track the effective attemptId - may change if fallback or referer is used
        let effectiveAttemptId = attemptId;

        if (attemptError || !attempt) {
            const reason = attemptError
                ? `error:${attemptError.code ?? 'unknown'}`
                : 'no_rows';
            console.log('SUBMIT_ATTEMPT_QUERY_ERROR:', attemptError);
            console.log('SUBMIT_ATTEMPT_QUERY_REASON:', reason);

            // First, try referer attempt id (common mismatch when client has stale state)
            if (refererAttemptId && refererAttemptId !== attemptId) {
                const { data: refererAttempt, error: refererError } = await adminClient
                    .from('attempts')
                    .select('id, user_id, status')
                    .eq('id', refererAttemptId)
                    .maybeSingle();
                if (refererAttempt && !refererError) {
                    console.log('SUBMIT_REFERER_ATTEMPT_USED:', refererAttempt);
                    console.log('SUBMIT_REFERER_ID_PROMOTION:', `${attemptId} -> ${refererAttempt.id}`);
                    attempt = refererAttempt;
                    effectiveAttemptId = refererAttempt.id;
                }
            }

            if (!attempt) {
            const { data: fallbackAttempt, error: fallbackError } = await adminClient
                .from('attempts')
                .select('id, user_id, status')
                .eq('user_id', user.id)
                .eq('status', 'in_progress')
                .order('created_at', { ascending: false })
                .limit(1)
                .maybeSingle();

                if (fallbackAttempt && !fallbackError) {
                    console.log('SUBMIT_FALLBACK_ATTEMPT_USED:', fallbackAttempt);
                    console.log('SUBMIT_FALLBACK_ID_PROMOTION:', `${attemptId} -> ${fallbackAttempt.id}`);
                    attempt = fallbackAttempt;
                    // CRITICAL FIX: Promote the fallback attempt ID for all downstream operations
                    effectiveAttemptId = fallbackAttempt.id;
                }
            }

            if (!attempt) {
                const { data: recentAttempts, error: recentError } = await adminClient
                    .from('attempts')
                    .select('id, status, user_id, paper_id, created_at')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(5);
                console.log('SUBMIT_RECENT_ATTEMPTS_FOR_USER:', recentAttempts ?? null, 'error:', recentError ?? null);
                console.log('API_SUBMIT_ATTEMPT_LOOKUP_FAILED', {
                    attemptId,
                    userId: user.id,
                    status: null,
                    errorCode: attemptError?.code ?? null,
                    errorMessage: attemptError?.message ?? 'Attempt not found',
                });
                const notFound = addVersionHeader(NextResponse.json(
                    {
                        error: 'Attempt not found',
                        code: 'ATTEMPT_NOT_FOUND',
                        ...(process.env.NODE_ENV !== 'production'
                            ? {
                                debug: {
                                    attemptId,
                                    refererAttemptId,
                                    userId: user.id,
                                    supabaseUrl: config.url,
                                    hasServiceRoleKey: Boolean(process.env.SUPABASE_SERVICE_ROLE_KEY),
                                    attemptErrorCode: attemptError?.code ?? null,
                                    attemptErrorMessage: attemptError?.message ?? null,
                                    recentAttempts: recentAttempts ?? null,
                                },
                            }
                            : {}),
                    },
                    { status: 404 }
                ));
                res.cookies.getAll().forEach((cookie) => notFound.cookies.set(cookie));
                return notFound;
            }
        }

        if (attempt.user_id !== user.id) {
            const forbidden = addVersionHeader(NextResponse.json({ error: 'Unauthorized' }, { status: 403 }));
            res.cookies.getAll().forEach((cookie) => forbidden.cookies.set(cookie));
            return forbidden;
        }

        // IDEMPOTENT: If already submitted, return success (don't error on retries)
        if (attempt.status === 'completed' || attempt.status === 'submitted') {
            console.log('SUBMIT_ALREADY_COMPLETED:', effectiveAttemptId, 'status:', attempt.status);
            const already = addVersionHeader(NextResponse.json({ success: true, already_submitted: true }, { status: 200 }));
            res.cookies.getAll().forEach((cookie) => already.cookies.set(cookie));
            return already;
        }

        if (attempt.status !== 'in_progress' && attempt.status !== 'paused') {
            console.log('API_SUBMIT_ATTEMPT_STATUS_MISMATCH', {
                attemptId: effectiveAttemptId,
                userId: user.id,
                status: attempt.status,
                errorCode: 'INVALID_ATTEMPT_STATUS',
                errorMessage: 'Attempt is not in progress',
            });
            const invalidStatus = addVersionHeader(NextResponse.json(
                { error: 'Attempt is not in progress', code: 'INVALID_ATTEMPT_STATUS' },
                { status: 409 }
            ));
            res.cookies.getAll().forEach((cookie) => invalidStatus.cookies.set(cookie));
            return invalidStatus;
        }

        // P0 FIX: Pre-validate session token before calling submitExam
        // This catches multi-device/tab attacks at the API layer
        if (!sessionToken) {
            return addVersionHeader(NextResponse.json({ error: 'Missing session token' }, { status: 400 }));
        }

        const { data: isValidSession, error: validateError } = await validateSessionTokenRpc(
            supabase,
            effectiveAttemptId,
            sessionToken,
            user.id
        );

        if (validateError) {
            examLogger.securityEvent('Session validation RPC error', {
                attemptId: effectiveAttemptId,
                errorMessage: validateError.message,
                errorCode: validateError.code,
            });
            // If RPC error and force_resume is set, try to proceed with force resume
            if (force_resume === true) {
                const ip = req.headers.get('x-forwarded-for') ?? 'unknown';
                const userAgent = req.headers.get('user-agent') ?? 'unknown';

                examLogger.securityEvent('Force resume on RPC error (submit)', {
                    attemptId: effectiveAttemptId,
                    ip,
                    userAgent,
                });

                const { error: forceResumeError } = await supabase
                    .rpc('force_resume_exam_session', {
                        p_attempt_id: effectiveAttemptId,
                        p_new_session_token: sessionToken,
                    });

                if (!forceResumeError) {
                    // Force resume succeeded, continue with submit
                    const result = await submitExam(effectiveAttemptId, { sessionToken, force_resume: true, submissionId });
                    if (!result.success) {
                        return addVersionHeader(NextResponse.json({ error: result.error }, { status: 400 }));
                    }
                    const successHeaders = getRateLimitHeaders(rateLimitResult, RATE_LIMITS.SUBMIT_EXAM.limit);
                    const success = addVersionHeader(NextResponse.json({ success: true, ...result.data }, { headers: successHeaders }));
                    res.cookies.getAll().forEach((cookie) => success.cookies.set(cookie));
                    return success;
                }
            }
            return addVersionHeader(NextResponse.json({ error: 'Failed to validate session', code: 'VALIDATION_RPC_ERROR' }, { status: 500 }));
        }

        if (!isValidSession) {
            if (force_resume === true) {
                const ip = req.headers.get('x-forwarded-for') ?? 'unknown';
                const userAgent = req.headers.get('user-agent') ?? 'unknown';

                examLogger.securityEvent('Force resume (submit)', {
                    attemptId: effectiveAttemptId,
                    ip,
                    userAgent,
                });

                const { error: forceResumeError } = await supabase
                    .rpc('force_resume_exam_session', {
                        p_attempt_id: effectiveAttemptId,
                        p_new_session_token: sessionToken,
                    });

                if (forceResumeError) {
                    if (forceResumeError.message?.includes('FORCE_RESUME_STALE') || forceResumeError.message?.includes('stale')) {
                        return addVersionHeader(NextResponse.json({
                            error: 'Force resume denied. Session is too old.',
                            code: 'FORCE_RESUME_STALE',
                        }, { status: 409 }));
                    }

                    return addVersionHeader(NextResponse.json({ error: 'Failed to force resume session' }, { status: 500 }));
                }
            } else {
                examLogger.securityEvent('Submit session mismatch', { attemptId: effectiveAttemptId });
                return addVersionHeader(NextResponse.json({
                    error: 'Session conflict detected. This exam may be open in another tab or device.',
                    code: 'SESSION_CONFLICT',
                    canForceResume: true
                }, { status: 409 }));
            }
        }

        // Use the server action which has full validation, timer checks, and scoring
        const result = await submitExam(effectiveAttemptId, { sessionToken, force_resume, submissionId });

        if (!result.success) {
            if (result.error === 'Access pending') {
                const denied = addVersionHeader(NextResponse.json(
                    { error: 'Access pending', code: 'ACCESS_PENDING' },
                    { status: 403 }
                ));
                res.cookies.getAll().forEach((cookie) => denied.cookies.set(cookie));
                return denied;
            }

            const invalidStatus =
                result.error === 'Attempt is not in progress' ||
                result.error === 'INVALID_ATTEMPT_STATUS' ||
                result.error === 'Attempt already submitted by another request';

            if (invalidStatus) {
                const { data: statusAttempt } = await adminClient
                    .from('attempts')
                    .select('status')
                    .eq('id', effectiveAttemptId)
                    .maybeSingle();

                if (statusAttempt?.status === 'submitted' || statusAttempt?.status === 'completed') {
                    const successHeaders = getRateLimitHeaders(rateLimitResult, RATE_LIMITS.SUBMIT_EXAM.limit);
                    const already = addVersionHeader(
                        NextResponse.json({ success: true, already_submitted: true }, { headers: successHeaders })
                    );
                    res.cookies.getAll().forEach((cookie) => already.cookies.set(cookie));
                    return already;
                }
            }

            // Phase 1: Include code for SESSION_CONFLICT so client can handle it
            const isConflict = result.error === 'SESSION_CONFLICT' || result.error?.includes('session');
            const failure = addVersionHeader(NextResponse.json(
                {
                    error: result.error,
                    code: isConflict ? 'SESSION_CONFLICT' : undefined,
                    canForceResume: isConflict
                },
                { status: isConflict ? 409 : 400 }
            ));
            res.cookies.getAll().forEach((cookie) => failure.cookies.set(cookie));
            return failure;
        }

        // Add rate limit headers to successful response
        const successHeaders = getRateLimitHeaders(rateLimitResult, RATE_LIMITS.SUBMIT_EXAM.limit);
        const success = addVersionHeader(NextResponse.json({ success: true, ...result.data }, { headers: successHeaders }));
        res.cookies.getAll().forEach((cookie) => success.cookies.set(cookie));
        return success;
    } catch {
        return addVersionHeader(NextResponse.json({ error: 'Invalid JSON' }, { status: 400 }));
    }
}
````

## File: src/app/mock/[paperId]/page.tsx
````typescript
import type { Metadata } from "next";
import { redirect } from 'next/navigation';
import { sbSSR } from '@/lib/supabase/server';
import { logger } from '@/lib/logger';
import Link from 'next/link';
import { getSectionDurationSecondsMap, type SectionName, type SectionConfig } from '@/types/exam';
import { getServiceRoleClient } from '@/lib/supabase/service-role';
import { ensureActiveAccess } from '@/lib/access-control';
import { checkRateLimit, RATE_LIMITS, userRateLimitKey } from '@/lib/rate-limit';
import { incrementMetric } from '@/lib/telemetry';

export const metadata: Metadata = {
    title: "Mock Details",
};

interface Paper {
    id: string;
    slug: string;
    title: string;
    description: string | null;
    year: number;
    total_questions: number;
    total_marks: number;
    duration_minutes: number;
    sections: SectionConfig[];
    published: boolean;
    difficulty_level: string | null;
    is_free: boolean;
    attempt_limit: number | null;
}

export default async function MockDetailPage({
    params,
    searchParams,
}: {
    params: Promise<Record<string, unknown>>;
    searchParams?: { error?: string };
}) {
    const { paperId } = (await params) as { paperId: string };

    const supabase = await sbSSR();

    // Get paper details - try by UUID first, then by slug
    let paper: Paper | null = null;
    let paperError: unknown = null;

    // Check if paperId looks like a UUID
    const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(paperId);

    if (isUUID) {
        const result = await supabase
            .from('papers')
            .select('id, slug, title, description, year, total_questions, total_marks, duration_minutes, sections, published, difficulty_level, is_free, attempt_limit')
            .eq('id', paperId)
            .maybeSingle();
        paper = result.data as Paper | null;
        paperError = result.error;
    }

    // If not found by UUID or not a UUID, try by slug
    if (!paper && !paperError) {
        const result = await supabase
            .from('papers')
            .select('id, slug, title, description, year, total_questions, total_marks, duration_minutes, sections, published, difficulty_level, is_free, attempt_limit')
            .eq('slug', paperId)
            .maybeSingle();
        paper = result.data as Paper | null;
        paperError = result.error;
    }

    // Get user's previous attempts on this paper
    const { data: { user } } = await supabase.auth.getUser();
    let previousAttempts: { id: string; status: string; total_score: number | null; created_at: string }[] = [];

    if (user && paper) {
        const { data: attempts } = await supabase
            .from('attempts')
            .select('id, status, total_score, created_at')
            .eq('paper_id', paper.id)
            .eq('user_id', user.id)
            .order('created_at', { ascending: false });
        previousAttempts = attempts || [];
    }

    // Check attempt limit (count completed + submitted only)
    const attemptLimitStatuses = new Set(['completed', 'submitted']);
    const activeAttemptsCount = previousAttempts.filter((a) => attemptLimitStatuses.has(a.status)).length;
    const attemptLimit = paper?.attempt_limit ?? null;
    const canAttempt = attemptLimit === null || attemptLimit <= 0 || activeAttemptsCount < attemptLimit;

    async function startExam() {
        'use server';
        const s = await sbSSR();
        const { data: { user: currentUser } } = await s.auth.getUser();

        if (!currentUser) {
            redirect(`/auth/sign-in?redirect_to=${encodeURIComponent(`/mock/${paperId}`)}`);
        }

        const access = await ensureActiveAccess(s, currentUser.id, currentUser);
        if (!access.allowed) {
            redirect(`/coming-soon?redirect_to=${encodeURIComponent(`/mock/${paperId}`)}`);
        }

        const rateKey = userRateLimitKey('start_mock', currentUser.id);
        const rateResult = checkRateLimit(rateKey, RATE_LIMITS.START_MOCK);
        if (!rateResult.allowed) {
            redirect(`/mock/${paperId}?error=rate_limited`);
        }

        // Check if paperId looks like a UUID
        const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(paperId);

        type PaperData = { id: string; published: boolean; sections: SectionConfig[]; duration_minutes: number; attempt_limit: number | null };
        let p: PaperData | null = null;

        if (isUUID) {
            const { data } = await s
                .from('papers')
                .select('id, published, sections, duration_minutes, attempt_limit')
                .eq('id', paperId)
                .maybeSingle();
            p = data as PaperData | null;
        }

        if (!p) {
            const { data } = await s
                .from('papers')
                .select('id, published, sections, duration_minutes, attempt_limit')
                .eq('slug', paperId)
                .maybeSingle();
            p = data as PaperData | null;
        }

        if (!p || p.published !== true) {
            throw new Error('Paper not available');
        }

        // Prepare section durations for attempt validation and initialization
        const sections = (p.sections as SectionConfig[]) || [];
        const sectionDurations = getSectionDurationSecondsMap(sections);

        // Start Mock always creates a new attempt.
        // If an existing in-progress/paused attempt exists, abandon it (resume only via Continue button).
        try {
            const adminClient = getServiceRoleClient();
            const { data: existingAttempt } = await adminClient
                .from('attempts')
                .select('id, status')
                .eq('paper_id', p.id)
                .eq('user_id', currentUser.id)
                .in('status', ['in_progress', 'paused'])
                .order('created_at', { ascending: false })
                .limit(1)
                .maybeSingle();

            if (existingAttempt) {
                await adminClient
                    .from('attempts')
                    .update({
                        status: 'abandoned',
                        completed_at: new Date().toISOString(),
                    })
                    .eq('id', existingAttempt.id)
                    .eq('user_id', currentUser.id)
                    .in('status', ['in_progress', 'paused']);
            }
        } catch (error) {
            logger.warn('Failed to abandon existing attempt for new mock', error, {
                paperId: p.id,
                userId: currentUser.id,
            });
        }

        const attemptLimitServer = p.attempt_limit ?? null;
        if (attemptLimitServer !== null && attemptLimitServer > 0) {
            const { count: attemptCount } = await s
                .from('attempts')
                .select('id', { count: 'exact', head: true })
                .eq('paper_id', p.id)
                .eq('user_id', currentUser.id)
                .in('status', ['completed', 'submitted']);

            if ((attemptCount ?? 0) >= attemptLimitServer) {
                redirect(`/mock/${paperId}?limit_reached=1`);
            }
        }

        // Initialize time remaining for each section
        const timeRemaining: Record<SectionName, number> = {
            VARC: sectionDurations.VARC,
            DILR: sectionDurations.DILR,
            QA: sectionDurations.QA,
        };

        const { data: attempt, error: insertErr } = await s
            .from('attempts')
            .insert({
                paper_id: p.id,
                user_id: currentUser.id,
                status: 'in_progress',
                current_section: 'VARC',
                current_question: 1,
                time_remaining: timeRemaining
            })
            .select('id')
            .single();

        if (insertErr || !attempt) {
            logger.error('Failed to create attempt', insertErr, { paperId: p.id, userId: currentUser.id });
            throw new Error('Failed to create attempt');
        }

        incrementMetric('attempt_created');

        redirect(`/exam/${attempt.id}`);
    }

    if (paperError) {
        return (
            <main style={{ padding: 24, maxWidth: 800, margin: '0 auto' }}>
                <h1>Error Loading Paper</h1>
                <p style={{ color: 'crimson' }}>Failed to load paper. Please try again later.</p>
                <Link href="/mocks">Back to Mocks</Link>
            </main>
        );
    }

    if (!paper) {
        return (
            <main style={{ padding: 24, maxWidth: 800, margin: '0 auto' }}>
                <h1>Paper Not Found</h1>
                <p>The requested mock test does not exist.</p>
                <Link href="/mocks">Browse Available Mocks</Link>
            </main>
        );
    }

    const sections = paper.sections || [];
    const queryError = searchParams?.error ?? null;

    return (
        <main style={{ padding: 24, maxWidth: 800, margin: '0 auto' }}>
            {queryError === 'rate_limited' && (
                <div style={{ marginBottom: 16, color: 'crimson' }}>
                    Too many start attempts. Please wait a minute and try again.
                </div>
            )}

            {/* Paper Header */}
            <div style={{ marginBottom: 32 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>
                    <h1 style={{ margin: 0 }}>{paper.title}</h1>
                    {paper.is_free && (
                        <span style={{
                            padding: '4px 8px',
                            background: '#4caf50',
                            color: 'white',
                            borderRadius: 4,
                            fontSize: 12
                        }}>FREE</span>
                    )}
                    {paper.difficulty_level && (
                        <span style={{
                            padding: '4px 8px',
                            background: paper.difficulty_level === 'hard' ? '#f44336' : paper.difficulty_level === 'medium' ? '#ff9800' : '#4caf50',
                            color: 'white',
                            borderRadius: 4,
                            fontSize: 12
                        }}>{paper.difficulty_level.toUpperCase()}</span>
                    )}
                </div>
                {paper.description && <p style={{ color: '#666', marginTop: 8 }}>{paper.description}</p>}
            </div>

            {/* Paper Stats */}
            <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(4, 1fr)',
                gap: 16,
                marginBottom: 32,
                padding: 20,
                background: '#f5f5f5',
                borderRadius: 12
            }}>
                <div style={{ textAlign: 'center' }}>
                    <p style={{ margin: 0, fontSize: 14, color: '#666' }}>Questions</p>
                    <p style={{ margin: '4px 0 0', fontSize: 24, fontWeight: 'bold' }}>{paper.total_questions}</p>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <p style={{ margin: 0, fontSize: 14, color: '#666' }}>Total Marks</p>
                    <p style={{ margin: '4px 0 0', fontSize: 24, fontWeight: 'bold' }}>{paper.total_marks}</p>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <p style={{ margin: 0, fontSize: 14, color: '#666' }}>Duration</p>
                    <p style={{ margin: '4px 0 0', fontSize: 24, fontWeight: 'bold' }}>{paper.duration_minutes} min</p>
                </div>
                <div style={{ textAlign: 'center' }}>
                    <p style={{ margin: 0, fontSize: 14, color: '#666' }}>Year</p>
                    <p style={{ margin: '4px 0 0', fontSize: 24, fontWeight: 'bold' }}>{paper.year}</p>
                </div>
            </div>

            {/* Section Breakdown */}
            <h2 style={{ marginBottom: 16 }}>Section Details</h2>
            <div style={{ marginBottom: 32 }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr style={{ background: '#f0f0f0' }}>
                            <th style={{ padding: 12, textAlign: 'left', borderBottom: '2px solid #ddd' }}>Section</th>
                            <th style={{ padding: 12, textAlign: 'center', borderBottom: '2px solid #ddd' }}>Questions</th>
                            <th style={{ padding: 12, textAlign: 'center', borderBottom: '2px solid #ddd' }}>Time (min)</th>
                            <th style={{ padding: 12, textAlign: 'center', borderBottom: '2px solid #ddd' }}>Marks</th>
                        </tr>
                    </thead>
                    <tbody>
                        {sections.map((section: SectionConfig, idx: number) => (
                            <tr key={`${section.name}-${idx}`} style={{ borderBottom: '1px solid #eee' }}>
                                <td style={{ padding: 12 }}>{section.name}</td>
                                <td style={{ padding: 12, textAlign: 'center' }}>{section.questions}</td>
                                <td style={{ padding: 12, textAlign: 'center' }}>{section.time}</td>
                                <td style={{ padding: 12, textAlign: 'center' }}>{section.marks}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Marking Scheme */}
            <h2 style={{ marginBottom: 16 }}>Marking Scheme</h2>
            <div style={{
                padding: 16,
                background: '#fff3e0',
                borderRadius: 8,
                marginBottom: 32,
                fontSize: 14
            }}>
                <p style={{ margin: '0 0 8px' }}><strong>MCQ Questions:</strong> +3 for correct, -1 for incorrect, 0 for unanswered</p>
                <p style={{ margin: 0 }}><strong>TITA Questions:</strong> +3 for correct, 0 for incorrect/unanswered (No negative marking)</p>
            </div>

            {/* Previous Attempts */}
            {previousAttempts.length > 0 && (
                <>
                    <h2 style={{ marginBottom: 16 }}>Your Previous Attempts</h2>
                    <div style={{ marginBottom: 32 }}>
                        {previousAttempts.map((attempt, idx) => (
                            <div key={attempt.id} style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                padding: 12,
                                background: idx % 2 === 0 ? '#f9f9f9' : '#fff',
                                borderRadius: 4,
                                marginBottom: 4
                            }}>
                                <span>Attempt {previousAttempts.length - idx}</span>
                                <span style={{ color: '#666' }}>{new Date(attempt.created_at).toLocaleDateString()}</span>
                                <span style={{
                                    color: attempt.status === 'completed' || attempt.status === 'submitted' ? '#4caf50' : '#ff9800'
                                }}>{attempt.status}</span>
                                <span style={{ fontWeight: 'bold' }}>
                                    {attempt.total_score !== null ? `${attempt.total_score} marks` : '—'}
                                </span>
                                {attempt.status === 'completed' || attempt.status === 'submitted' ? (
                                    <Link href={`/result/${attempt.id}`} style={{ color: '#1976d2' }}>View Result</Link>
                                ) : attempt.status === 'in_progress' ? (
                                    <Link href={`/exam/${attempt.id}`} style={{ color: '#ff9800' }}>Continue</Link>
                                ) : (
                                    <span style={{ color: '#999' }}>—</span>
                                )}
                            </div>
                        ))}
                    </div>
                </>
            )}

            {/* Start Exam Button */}
            <div style={{ textAlign: 'center' }}>
                {!paper.published ? (
                    <p style={{ color: '#666' }}>This paper is not yet available.</p>
                ) : !canAttempt ? (
                    <p style={{ color: '#f44336' }}>You have reached the maximum number of attempts for this paper.</p>
                ) : (
                    <form action={startExam}>
                        <button type="submit" style={{
                            padding: '16px 48px',
                            background: '#1976d2',
                            color: 'white',
                            border: 'none',
                            borderRadius: 8,
                            fontSize: 18,
                            fontWeight: 'bold',
                            cursor: 'pointer'
                        }}>
                            {previousAttempts.length > 0 ? 'Start New Attempt' : 'Start Exam'}
                        </button>
                    </form>
                )}
            </div>

            <div style={{ marginTop: 24, textAlign: 'center' }}>
                <Link href="/mocks" style={{ color: '#666' }}>← Back to All Mocks</Link>
            </div>
        </main>
    );
}
````

## File: src/app/result/[attemptId]/page.tsx
````typescript
/**
 * @fileoverview Exam Result Page
 * @description Displays detailed exam results with sectional analysis
 * @blueprint Milestone 5 - Milestone_Change_Log.md - Change 002
 * @blueprint Step 0.95 - Uses canonical fetchExamResults action (no duplicate logic)
 */

import Link from 'next/link';
import { sbSSR } from '@/lib/supabase/server';
import { fetchExamResults } from '@/features/exam-engine/lib/actions';
import { ResultHeader } from '@/features/exam-engine/ui/ResultHeader';
import { SectionalPerformance } from '@/features/exam-engine/ui/SectionalPerformance';
import { QuestionAnalysis } from '@/features/exam-engine/ui/QuestionAnalysis';
import { BackToDashboard } from '@/components/BackToDashboard';
import { ResultReviewClient } from './ResultReviewClient';
import { ResultTabsClient } from './ResultTabsClient';
import { AIAnalysisButton } from './AIAnalysisButton';
import { buildLegacyQuestionSetsWithAnswers } from '@/utils/question-sets';
import { calculateScore } from '@/features/exam-engine/lib/scoring';
import type {
    Question,
    QuestionSetComplete,
    QuestionSetMetadata,
    QuestionSetType,
    ContentLayoutType,
    QuestionContext,
    QuestionWithAnswer,
    SectionName,
    QuestionType,
    AIAnalysisStatus,
} from '@/types/exam';
import type { ResponseForScoring } from '@/features/exam-engine/lib/scoring';

export const dynamic = 'force-dynamic';

interface SectionScore {
    score: number;
    correct: number;
    incorrect: number;
    unanswered: number;
}

// Error UI component for consistent error display
function ErrorState({ title, message, linkHref, linkText, icon }: {
    title: string;
    message: string;
    linkHref: string;
    linkText: string;
    icon?: 'error' | 'warning' | 'info';
}) {
    const iconConfig = {
        error: { bg: 'bg-red-100', color: 'text-red-600', path: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' },
        warning: { bg: 'bg-yellow-100', color: 'text-yellow-600', path: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' },
        info: { bg: 'bg-gray-100', color: 'text-gray-400', path: 'M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
    };
    const cfg = iconConfig[icon || 'error'];

    return (
        <main className="min-h-screen bg-gray-50 flex items-center justify-center p-6">
            <div className="text-center max-w-md">
                <div className={`w-16 h-16 ${cfg.bg} rounded-full flex items-center justify-center mx-auto mb-4`}>
                    <svg className={`w-8 h-8 ${cfg.color}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={cfg.path} />
                    </svg>
                </div>
                <h1 className="text-2xl font-bold text-gray-900 mb-2">{title}</h1>
                <p className="text-gray-600 mb-6">{message}</p>
                <Link
                    href={linkHref}
                    className="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                    {linkText}
                </Link>
            </div>
        </main>
    );
}

export default async function ResultPage({ params }: { params: Promise<Record<string, unknown>> }) {
    const { attemptId } = (await params) as { attemptId: string };

    // Use canonical fetchExamResults action (Step 0.95 compliance)
    // This ensures all security checks are centralized in one place
    const result = await fetchExamResults(attemptId);

    // Handle errors from the canonical action
    if (!result.success) {
        const errorMap: Record<string, { title: string; message: string; linkHref: string; linkText: string; icon: 'error' | 'warning' | 'info' }> = {
            'Authentication required': {
                title: 'Authentication Required',
                message: 'Please sign in to view your results.',
                linkHref: '/auth/sign-in',
                linkText: 'Sign In',
                icon: 'warning',
            },
            'Attempt not found': {
                title: 'Result Not Found',
                message: 'No attempt found with this ID.',
                linkHref: '/dashboard',
                linkText: 'Back to Dashboard',
                icon: 'info',
            },
            'Unauthorized': {
                title: 'Access Denied',
                message: 'You do not have permission to view this result.',
                linkHref: '/dashboard',
                linkText: 'Back to Dashboard',
                icon: 'error',
            },
            'Attempt not yet completed': {
                title: 'Exam Not Completed',
                message: 'This exam has not been submitted yet.',
                linkHref: `/exam/${attemptId}`,
                linkText: 'Continue Exam',
                icon: 'warning',
            },
            'Failed to fetch solutions': {
                title: 'Error Loading Solutions',
                message: 'Failed to load answer key for this attempt.',
                linkHref: '/dashboard',
                linkText: 'Back to Dashboard',
                icon: 'error',
            },
        };

        const errorConfig = errorMap[result.error || ''] || {
            title: 'Error Loading Result',
            message: result.error || 'An unexpected error occurred. Please try again later.',
            linkHref: '/dashboard',
            linkText: 'Back to Dashboard',
            icon: 'error' as const,
        };

        return <ErrorState {...errorConfig} />;
    }

    const { attempt, questions, responses } = result.data!;

    const responsesForScoring: ResponseForScoring[] = responses.map((r) => ({
        question_id: r.question_id,
        answer: r.answer ?? null,
        time_spent_seconds: r.time_spent_seconds ?? 0,
    }));
    const derivedScore = questions.length > 0
        ? calculateScore(questions as Array<Question & { correct_answer: string }>, responsesForScoring)
        : null;

    const derivedResultMap = derivedScore
        ? new Map(derivedScore.question_results.map((qr) => [qr.question_id, qr]))
        : null;

    const normalizedResponses = derivedResultMap
        ? responses.map((r) => {
            const derived = derivedResultMap.get(r.question_id);
            return {
                ...r,
                is_correct: r.is_correct ?? derived?.is_correct ?? null,
                marks_obtained: r.marks_obtained ?? derived?.marks_obtained ?? null,
            };
        })
        : responses;

    const answerMap = Object.fromEntries(normalizedResponses.map((r) => [r.question_id, r.answer ?? null]));
    const correctAnswerMap = Object.fromEntries(questions.map((q) => [q.id, q.correct_answer ?? '']));
    const solutionMap = Object.fromEntries(
        questions.map((q) => [
            q.id,
            {
                solution_text: q.solution_text ?? null,
                solution_image_url: q.solution_image_url ?? null,
                video_solution_url: q.video_solution_url ?? null,
            },
        ])
    );
    const responseMetaMap = Object.fromEntries(
        normalizedResponses.map((r) => [
            r.question_id,
            {
                time_spent_seconds: r.time_spent_seconds ?? null,
                visit_count: r.visit_count ?? null,
                updated_at: r.updated_at ?? null,
            },
        ])
    );
    const responseStatusMap = Object.fromEntries(normalizedResponses.map((r) => [r.question_id, r.status]));

    // Fetch paper details for display
    const supabase = await sbSSR();
    const { data: { user } } = await supabase.auth.getUser();

    let attemptSequenceLabel: string | null = null;
    if (user) {
        const { data: attemptHistory } = await supabase
            .from('attempts')
            .select('id, created_at')
            .eq('user_id', user.id)
            .eq('paper_id', attempt.paper_id)
            .order('created_at', { ascending: true });

        if (attemptHistory && attemptHistory.length > 0) {
            const index = attemptHistory.findIndex((a) => a.id === attempt.id);
            if (index >= 0) {
                attemptSequenceLabel = `Attempt ${index + 1} of ${attemptHistory.length}`;
            }
        }
    }
    const { data: paper } = await supabase
        .from('papers')
        .select('title, total_marks, total_questions')
        .eq('id', attempt.paper_id)
        .single();

    const paperTitle = paper?.title || 'Exam Result';
    const totalMarks = paper?.total_marks || attempt.max_possible_score || 198;
    const totalScore = derivedScore?.total_score ?? attempt.total_score ?? 0;
    const maxScore = derivedScore?.max_possible_score ?? attempt.max_possible_score ?? totalMarks;
    const correctCount = derivedScore?.correct_count ?? attempt.correct_count ?? 0;
    const incorrectCount = derivedScore?.incorrect_count ?? attempt.incorrect_count ?? 0;
    const unansweredCount = derivedScore?.unanswered_count ?? attempt.unanswered_count ?? 0;
    const accuracy = derivedScore ? derivedScore.accuracy : (attempt.accuracy ?? null);
    const attemptRate = derivedScore ? derivedScore.attempt_rate : (attempt.attempt_rate ?? null);

    type QuestionSetViewRow = {
        id: string;
        paper_id: string;
        section: string;
        set_type: string;
        content_layout: string;
        context_title?: string | null;
        context_body?: string | null;
        context_image_url?: string | null;
        context_additional_images?: unknown;
        display_order: number;
        question_count: number;
        metadata?: QuestionSetMetadata | null;
        is_active: boolean;
        is_published: boolean;
        created_at: string;
        updated_at: string;
        questions: Array<{
            id: string;
            question_text: string;
            question_type: string;
            options: unknown;
            positive_marks: number;
            negative_marks: number;
            question_number: number;
            sequence_order: number | null;
            question_image_url?: string | null;
            difficulty?: string | null;
            topic?: string | null;
            subtopic?: string | null;
            is_active: boolean;
        }>;
    };

    const { data: questionSetRows, error: questionSetError } = await supabase
        .from('question_sets_with_questions')
        .select('*')
        .eq('paper_id', attempt.paper_id);

    if (questionSetError) {
        console.warn('[ResultPage] Failed to fetch question_sets_with_questions', questionSetError);
    }

    let questionSets: QuestionSetComplete[] = [];

    const questionContextIds = Array.from(
        new Set(
            questions
                .map((q) => (q as { context_id?: string | null }).context_id)
                .filter((id): id is string => Boolean(id))
        )
    );

    const contextById = new Map<string, QuestionContext>();
    if (questionContextIds.length > 0) {
        const { data: contextsData, error: contextsError } = await supabase
            .from('question_contexts')
            .select(
                'id, title, section, content, context_type, paper_id, display_order, is_active, image_url, created_at, updated_at'
            )
            .in('id', questionContextIds);

        if (contextsError) {
            console.warn('[ResultPage] Failed to fetch question_contexts', contextsError);
        } else {
            (contextsData ?? []).forEach((ctx) => {
                contextById.set(ctx.id as string, ctx as QuestionContext);
            });
        }
    }

    if (questionSetRows && questionSetRows.length > 0) {
        questionSets = (questionSetRows as QuestionSetViewRow[]).map((row) => ({
            id: row.id,
            paper_id: row.paper_id,
            section: row.section as SectionName,
            set_type: row.set_type as QuestionSetType,
            content_layout: row.content_layout as ContentLayoutType,
            context_title: row.context_title ?? undefined,
            context_body: row.context_body ?? undefined,
            context_image_url: row.context_image_url ?? undefined,
            context_additional_images: Array.isArray(row.context_additional_images)
                ? (row.context_additional_images as QuestionSetComplete['context_additional_images'])
                : [],
            display_order: row.display_order,
            question_count: row.question_count,
            metadata: (row.metadata ?? {}) as QuestionSetMetadata,
            is_active: row.is_active,
            is_published: row.is_published,
            created_at: row.created_at,
            updated_at: row.updated_at,
            questions: (row.questions ?? []).map((q, index) => ({
                id: q.id,
                set_id: row.id,
                paper_id: row.paper_id,
                section: row.section as SectionName,
                sequence_order: q.sequence_order ?? index + 1,
                question_number: q.question_number,
                question_text: q.question_text,
                question_type: q.question_type as QuestionType,
                options: q.options as Question['options'],
                positive_marks: q.positive_marks,
                negative_marks: q.negative_marks,
                question_image_url: q.question_image_url ?? undefined,
                difficulty: q.difficulty as Question['difficulty'],
                topic: q.topic ?? undefined,
                subtopic: q.subtopic ?? undefined,
                is_active: q.is_active,
            })),
        }));

        const sectionOrder: Record<SectionName, number> = { VARC: 0, DILR: 1, QA: 2 };
        questionSets.sort((a, b) => {
            const sd = (sectionOrder[a.section] ?? 99) - (sectionOrder[b.section] ?? 99);
            if (sd) return sd;
            return (a.display_order ?? 9999) - (b.display_order ?? 9999);
        });
    }

    if (questionSets.length === 0) {
        const questionsWithAnswers = questions as QuestionWithAnswer[];
        const contexts = Array.from(contextById.values());
        questionSets = buildLegacyQuestionSetsWithAnswers(questionsWithAnswers, contexts, attempt.paper_id);
    }

    const questionContextMap = new Map<string, { title?: string | null; body?: string | null; imageUrl?: string | null }>();
    questionSets.forEach((set) => {
        const hasContext = Boolean(set.context_title || set.context_body || set.context_image_url);
        if (!hasContext) return;
        (set.questions ?? []).forEach((q) => {
            questionContextMap.set(q.id, {
                title: set.context_title ?? null,
                body: set.context_body ?? null,
                imageUrl: set.context_image_url ?? null,
            });
        });
    });

    // Fill in any standalone contexts missing from set-based mapping
    questions.forEach((q) => {
        if (questionContextMap.has(q.id)) return;
        const ctxId = (q as { context_id?: string | null }).context_id;
        if (!ctxId) return;
        const ctx = contextById.get(ctxId);
        if (!ctx) return;
        questionContextMap.set(q.id, {
            title: ctx.title ?? null,
            body: (ctx as { content?: string | null }).content ?? null,
            imageUrl: (ctx as { image_url?: string | null }).image_url ?? null,
        });
    });

    const normalizeSection = (value?: string | null): SectionName => {
        const normalized = (value ?? '').toUpperCase().trim();
        if (normalized === 'LRDI') return 'DILR';
        if (normalized === 'QUANT' || normalized === 'QUANTS') return 'QA';
        if (normalized === 'VARC' || normalized === 'DILR' || normalized === 'QA') {
            return normalized as SectionName;
        }
        return value as SectionName;
    };

    const questionSectionMap = new Map<string, SectionName>();
    questionSets.forEach((set) => {
        (set.questions ?? []).forEach((q) => {
            questionSectionMap.set(q.id, set.section as SectionName);
        });
    });

    // Fetch peer statistics for this paper
    type PaperStats = Record<string, { total: number; options: Record<string, number> }>;
    let paperStats: PaperStats = {};

    const { data: statsData } = await supabase
        .rpc('get_paper_stats', { p_paper_id: attempt.paper_id });

    if (statsData && typeof statsData === 'object') {
        paperStats = statsData as PaperStats;
    }

    const sectionScores = (derivedScore?.section_scores || attempt.section_scores || {}) as Record<string, SectionScore>;

    return (
        <main className="min-h-screen bg-gray-50">
            <BackToDashboard variant="fixed" />
            {/* Header with paper title and submission info */}
            <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-8 px-6">
                <div className="max-w-5xl mx-auto">
                    <h1 className="text-3xl font-bold mb-2">{paperTitle}</h1>
                    <p className="text-blue-100">
                        Submitted: {attempt.submitted_at ? new Date(attempt.submitted_at).toLocaleString() : '—'}
                    </p>
                    {attemptSequenceLabel && (
                        <div className="mt-3 inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-white">
                            {attemptSequenceLabel}
                        </div>
                    )}
                </div>
            </div>

            {/* Main content */}
            <div className="max-w-5xl mx-auto px-6 py-8 space-y-8">
                <ResultTabsClient
                    analytics={(
                        <>
                            <ResultHeader
                                paperTitle={paperTitle}
                                totalScore={totalScore}
                                maxScore={maxScore}
                                accuracy={accuracy}
                                attemptRate={attemptRate}
                                correctCount={correctCount}
                                incorrectCount={incorrectCount}
                                unansweredCount={unansweredCount}
                                timeTakenSeconds={attempt.time_taken_seconds ?? null}
                                percentile={attempt.percentile ?? null}
                                rank={attempt.rank ?? null}
                                submittedAt={attempt.submitted_at ?? null}
                                reviewAnchorId="exam-review"
                            />

                            <SectionalPerformance
                                sectionScores={sectionScores as Record<string, {
                                    score: number;
                                    maxScore: number;
                                    correct: number;
                                    incorrect: number;
                                    unanswered: number;
                                    timeTakenSeconds?: number;
                                }>}
                            />

                            {questions && questions.length > 0 && (
                                <QuestionAnalysis
                                    questions={questions.map(q => ({
                                        ...(questionContextMap.get(q.id)
                                            ? {
                                                context_title: questionContextMap.get(q.id)?.title ?? null,
                                                context_body: questionContextMap.get(q.id)?.body ?? null,
                                                context_image_url: questionContextMap.get(q.id)?.imageUrl ?? null,
                                            }
                                            : {}),
                                        id: q.id,
                                        section: questionSectionMap.get(q.id) ?? normalizeSection(q.section as string | null | undefined),
                                        question_number: q.question_number,
                                        question_text: q.question_text,
                                        question_type: q.question_type as 'MCQ' | 'TITA',
                                        options: q.options as string[] | null,
                                        correct_answer: q.correct_answer,
                                        solution_text: q.solution_text ?? null,
                                        question_image_url: q.question_image_url ?? null,
                                        topic: q.topic ?? null,
                                        subtopic: q.subtopic ?? null,
                                        difficulty: q.difficulty ?? null,
                                    }))}
                                    responses={normalizedResponses}
                                    peerStats={paperStats}
                                    attemptSequenceLabel={attemptSequenceLabel}
                                    attemptId={attempt.id}
                                    showHeader={false}
                                />
                            )}
                        </>
                    )}
                    review={questionSets.length > 0 ? (
                        <ResultReviewClient
                            paperTitle={paperTitle}
                            questionSets={questionSets}
                            answerMap={answerMap}
                            correctAnswerMap={correctAnswerMap}
                            solutionMap={solutionMap}
                            responseMetaMap={responseMetaMap}
                            responseStatusMap={responseStatusMap}
                            attemptId={attempt.id}
                        />
                    ) : null}
                />

                {/* Action buttons */}
                <div className="flex flex-wrap justify-center gap-4 pt-4">
                    <Link
                        href="/dashboard"
                        className="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
                    >
                        <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        Back to Dashboard
                    </Link>
                    <Link
                        href="/mocks"
                        className="inline-flex items-center px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors shadow-sm"
                    >
                        <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        Take Another Mock
                    </Link>
                    <AIAnalysisButton
                        attemptId={attempt.id}
                        initialStatus={(attempt.ai_analysis_status as AIAnalysisStatus) ?? 'none'}
                    />
                </div>
            </div>
        </main>
    );
}
````

## File: src/features/exam-engine/lib/actions.ts
````typescript
'use server';

/**
 * @fileoverview Exam Engine Server Actions
 * @description Server-side actions for fetching, saving, and submitting exams
 * @blueprint Milestone 4 SOP-SSOT - Phase 4.1, 4.2, 4.4
 * @blueprint M6+ Architecture - Structured Logging
 */

import 'server-only';

import { sbSSR } from '@/lib/supabase/server';
import { logger, examLogger } from '@/lib/logger';
import { ensureActiveAccess } from '@/lib/access-control';
import {
    FetchPaperRequestSchema,
    SaveResponseRequestSchema,
    UpdateTimerRequestSchema,
    SubmitExamRequestSchema,
    type FetchPaperResponse,
    type SubmitExamResponse,
} from './validation';
import type { Question, Attempt, SectionName, TimeRemaining, QuestionContext } from '@/types/exam';
import { getSectionDurationSecondsMap, getPaperTotalDurationSeconds } from '@/types/exam';

export interface ActionResult<T> {
    success: boolean;
    data?: T;
    error?: string;
}

type ValidateSessionResult = { data: boolean | null; error: { code?: string; message?: string } | null };

function isMissingValidateFn(error?: { code?: string; message?: string } | null): boolean {
    if (!error) return false;
    return error.code === '42883' || Boolean(error.message?.includes('validate_session_token'));
}

async function validateSessionTokenRpc(
    supabase: { rpc: (fn: string, args: Record<string, unknown>) => PromiseLike<ValidateSessionResult> },
    attemptId: string,
    sessionToken: string,
    userId: string
): Promise<ValidateSessionResult> {
    const primary = await supabase.rpc('validate_session_token', {
        p_attempt_id: attemptId,
        p_session_token: sessionToken,
        p_user_id: userId,
    });

    if (!primary.error || !isMissingValidateFn(primary.error)) return primary;

    return supabase.rpc('validate_session_token', {
        p_attempt_id: attemptId,
        p_session_token: sessionToken,
        p_user_id: userId,
        p_force_resume: false,
    });
}

// =============================================================================
// FETCH PAPER WITH QUESTIONS
// =============================================================================

export async function fetchPaperForExam(
    paperId: string,
    options?: { resume?: boolean }
): Promise<ActionResult<FetchPaperResponse>> {
    try {
        const parsed = FetchPaperRequestSchema.safeParse({ paperId, resume: options?.resume });
        if (!parsed.success) return { success: false, error: 'Invalid paper ID' };

        const supabase = await sbSSR();

        const {
            data: { user },
            error: authError,
        } = await supabase.auth.getUser();
        if (authError || !user) return { success: false, error: 'Authentication required' };

        const access = await ensureActiveAccess(supabase, user.id, user);
        if (!access.allowed) return { success: false, error: 'Access pending' };

        const { data: paper, error: paperError } = await supabase
            .from('papers')
            .select('*')
            .eq('id', paperId)
            .eq('published', true)
            .single();

        if (paperError || !paper) return { success: false, error: 'Paper not found' };

        // Secure view (excludes correct_answer). Fail fast if view isn't deployed.
        const { data: questionsData, error: questionsError } = await supabase
            .from('questions_exam')
            .select('*')
            .eq('paper_id', paperId)
            .eq('is_active', true)
            .order('section')
            .order('question_number');

        if (questionsError || !questionsData) {
            logger.error('Failed to fetch questions from questions_exam', questionsError, { paperId });
            return { success: false, error: 'Failed to fetch questions' };
        }

        let questions = questionsData as unknown as Question[];

        // Phase D: set-aware ordering
        const setIds = Array.from(
            new Set(
                questions
                    .map((q) => (q as { set_id?: string | null }).set_id)
                    .filter((id): id is string => Boolean(id))
            )
        );

        const setById = new Map<string, { display_order: number }>();
        if (setIds.length) {
            const { data: sets, error: setsError } = await supabase
                .from('question_sets')
                .select('id, display_order')
                .in('id', setIds);

            if (!setsError && sets) {
                for (const s of sets) setById.set(s.id, { display_order: s.display_order ?? 9999 });
            }
        }

        // Attach contexts (if any)
        const contextIds = Array.from(
            new Set(
                questions
                    .map((q) => (q as { context_id?: string | null }).context_id)
                    .filter((id): id is string => Boolean(id))
            )
        );

        if (contextIds.length) {
            const { data: contexts, error: contextsError } = await supabase
                .from('question_contexts')
                .select('id, title, section, content, context_type, paper_id, display_order, is_active')
                .in('id', contextIds);

            if (!contextsError && contexts) {
                const contextMap = new Map(contexts.map((c) => [c.id, c as QuestionContext]));
                questions = questions.map((q) => {
                    const ctxId = (q as { context_id?: string | null }).context_id;
                    const ctx = ctxId ? contextMap.get(ctxId) : undefined;
                    return ctx ? ({ ...q, context: ctx } as Question) : q;
                });
            } else {
                logger.warn('Failed to fetch question contexts', contextsError, { contextIds });
            }
        }

        // Deterministic ordering: section → set.display_order → sequence_order/question_number
        const sectionOrder: Record<SectionName, number> = { VARC: 0, DILR: 1, QA: 2 };
        questions.sort((a, b) => {
            const sectionDiff = (sectionOrder[a.section] ?? 99) - (sectionOrder[b.section] ?? 99);
            if (sectionDiff) return sectionDiff;

            const aSetOrder = a.set_id ? (setById.get(a.set_id)?.display_order ?? 9999) : 9999;
            const bSetOrder = b.set_id ? (setById.get(b.set_id)?.display_order ?? 9999) : 9999;
            const setDiff = aSetOrder - bSetOrder;
            if (setDiff) return setDiff;

            const aSeq = a.sequence_order ?? a.question_number;
            const bSeq = b.sequence_order ?? b.question_number;
            return aSeq - bSeq;
        });

        // Compute exam_order per section for stable palette navigation
        let curSection: SectionName | null = null;
        let examOrderInSection = 0;
        questions = questions.map((q) => {
            if (q.section !== curSection) {
                curSection = q.section;
                examOrderInSection = 0;
            }
            examOrderInSection += 1;
            return { ...q, exam_order: examOrderInSection };
        });

        const shouldResume = options?.resume === true;

        // Resume existing in-progress attempt (if explicitly requested)
        // BUG FIX: .single() would throw when 0 rows; use maybeSingle() to safely detect absence.
        const { data: existingAttempt, error: existingAttemptError } = await supabase
            .from('attempts')
            .select('*')
            .eq('user_id', user.id)
            .eq('paper_id', paperId)
            .in('status', ['in_progress', 'paused'])
            .order('created_at', { ascending: false })
            .limit(1)
            .maybeSingle();

        if (existingAttemptError) {
            logger.warn('Failed to check existing attempt', existingAttemptError, { paperId, userId: user.id });
        }

        let attempt: Attempt;

        if (existingAttempt && shouldResume) {
            attempt = existingAttempt as Attempt;
        } else {
            if (existingAttempt && !shouldResume) {
                try {
                    const { getServiceRoleClient } = await import('@/lib/supabase/service-role');
                    const adminClient = getServiceRoleClient();
                    await adminClient
                        .from('attempts')
                        .update({
                            status: 'abandoned',
                            completed_at: new Date().toISOString(),
                        })
                        .eq('id', existingAttempt.id)
                        .eq('user_id', user.id)
                        .in('status', ['in_progress', 'paused']);
                } catch (error) {
                    logger.warn('Failed to abandon existing attempt', error, {
                        attemptId: existingAttempt.id,
                        userId: user.id,
                    });
                }
            }

            const durations = getSectionDurationSecondsMap(paper.sections);
            const initialTimeRemaining: TimeRemaining = {
                VARC: durations.VARC,
                DILR: durations.DILR,
                QA: durations.QA,
            };

            const { data: newAttempt, error: attemptError } = await supabase
                .from('attempts')
                .insert({
                    user_id: user.id,
                    paper_id: paperId,
                    status: 'in_progress',
                    current_section: 'VARC',
                    current_question: 1,
                    time_remaining: initialTimeRemaining,
                })
                .select()
                .single();

            if (attemptError || !newAttempt) return { success: false, error: 'Failed to create attempt' };

            attempt = newAttempt as Attempt;

            const responseInserts = questions.map((q) => ({
                attempt_id: attempt.id,
                question_id: q.id,
                answer: null,
                status: 'not_visited',
                is_marked_for_review: false,
                is_visited: false,
                time_spent_seconds: 0,
                visit_count: 0,
            }));

            const { error: responsesError } = await supabase.from('responses').insert(responseInserts);
            if (responsesError) {
                logger.warn('Failed to create initial responses', responsesError, { attemptId: attempt.id });
            }
        }

        const normalizedPaper = {
            ...paper,
            sections: Array.isArray(paper.sections) ? [...paper.sections] : [],
        };
        const normalizedQuestions = questions.map((q) => ({
            ...q,
            options: Array.isArray(q.options) ? [...q.options] : q.options,
        }));
        return {
            success: true,
            data: {
                paper: normalizedPaper as FetchPaperResponse['paper'],
                questions: normalizedQuestions as FetchPaperResponse['questions'],
                attempt,
            },
        };
    } catch (error) {
        logger.error('fetchPaperForExam error', error, { paperId });
        return { success: false, error: 'An unexpected error occurred' };
    }
}

// =============================================================================
// SESSION INITIALIZATION
// =============================================================================

export async function initializeExamSession(attemptId: string): Promise<ActionResult<{ sessionToken: string }>> {
    try {
        if (!attemptId) return { success: false, error: 'Invalid attempt ID' };

        const supabase = await sbSSR();

        const {
            data: { user },
            error: authError,
        } = await supabase.auth.getUser();
        if (authError || !user) return { success: false, error: 'Authentication required' };

        const access = await ensureActiveAccess(supabase, user.id, user);
        if (!access.allowed) return { success: false, error: 'Access pending' };

        const { data: token, error: rpcError } = await supabase.rpc('initialize_exam_session', {
            p_attempt_id: attemptId,
            p_user_id: user.id,
        });

        if (rpcError || !token) {
            logger.error('initializeExamSession RPC error', rpcError, { attemptId });
            return { success: false, error: 'Failed to initialize session' };
        }

        return { success: true, data: { sessionToken: token as string } };
    } catch (error) {
        logger.error('initializeExamSession error', error, { attemptId });
        return { success: false, error: 'An unexpected error occurred' };
    }
}

// =============================================================================
// SAVE RESPONSE
// =============================================================================

export async function saveResponse(data: {
    attemptId: string;
    questionId: string;
    answer: string | null;
    status: string;
    isMarkedForReview: boolean;
    isVisited?: boolean;
    timeSpentSeconds: number;
    visitCount?: number;
    sessionToken?: string | null;
    force_resume?: boolean;
}): Promise<ActionResult<void>> {
    try {
        const parsed = SaveResponseRequestSchema.safeParse(data);
        if (!parsed.success) return { success: false, error: 'Invalid response data' };

        const supabase = await sbSSR();

        const {
            data: { user },
            error: authError,
        } = await supabase.auth.getUser();
        if (authError || !user) return { success: false, error: 'Authentication required' };

        const { data: attempt, error: attemptError } = await supabase
            .from('attempts')
            .select('user_id, status, paper_id')
            .eq('id', data.attemptId)
            .single();

        if (attemptError || !attempt) return { success: false, error: 'Attempt not found' };
        if (attempt.user_id !== user.id) return { success: false, error: 'Unauthorized' };
        if (attempt.status !== 'in_progress') return { success: false, error: 'Attempt is not in progress' };
        if (!data.sessionToken) return { success: false, error: 'Missing session token' };

        const { data: isValidSession, error: validateError } = await validateSessionTokenRpc(
            supabase,
            data.attemptId,
            data.sessionToken,
            user.id
        );

        if (validateError) {
            logger.error('saveResponse validate_session_token error', validateError, { attemptId: data.attemptId });
            return { success: false, error: 'Failed to validate session' };
        }

        if (!isValidSession) {
            if (data.force_resume === true) {
                examLogger.securityEvent('Force resume (saveResponse)', { attemptId: data.attemptId });

                const { error: forceResumeError } = await supabase.rpc('force_resume_exam_session', {
                    p_attempt_id: data.attemptId,
                    p_new_session_token: data.sessionToken,
                });

                if (forceResumeError) {
                    if (
                        forceResumeError.message?.includes('FORCE_RESUME_STALE') ||
                        forceResumeError.message?.includes('stale')
                    ) {
                        return { success: false, error: 'FORCE_RESUME_STALE' };
                    }
                    logger.error('saveResponse force_resume_exam_session error', forceResumeError, {
                        attemptId: data.attemptId,
                    });
                    return { success: false, error: 'Failed to force resume session' };
                }
            } else {
                examLogger.securityEvent('Session conflict (saveResponse)', { attemptId: data.attemptId });
                return { success: false, error: 'SESSION_CONFLICT' };
            }
        }

        // Integrity check: questionId must belong to attempt's paper (safe view)
        const { data: question, error: questionError } = await supabase
            .from('questions_exam')
            .select('id, paper_id')
            .eq('id', data.questionId)
            .eq('paper_id', attempt.paper_id)
            .eq('is_active', true)
            .maybeSingle();

        if (questionError || !question) {
            examLogger.validationError('Invalid questionId for attempt', {
                attemptId: data.attemptId,
                userId: user.id,
                questionId: data.questionId,
                paperId: attempt.paper_id,
            });
            return { success: false, error: 'Invalid question' };
        }

        const inferredVisited =
            data.isVisited ?? (data.status !== 'not_visited' || (data.answer !== null && data.answer !== ''));

        const { error: upsertError } = await supabase.from('responses').upsert(
            {
                attempt_id: data.attemptId,
                question_id: data.questionId,
                answer: data.answer,
                status: data.status,
                is_marked_for_review: data.isMarkedForReview,
                is_visited: inferredVisited,
                time_spent_seconds: data.timeSpentSeconds,
                visit_count: typeof data.visitCount === 'number' ? data.visitCount : undefined,
            },
            { onConflict: 'attempt_id,question_id' }
        );

        if (upsertError) {
            logger.error('saveResponse upsert error', upsertError, {
                attemptId: data.attemptId,
                questionId: data.questionId,
            });
            return { success: false, error: 'Failed to save response' };
        }

        return { success: true };
    } catch (error) {
        logger.error('saveResponse error', error, { attemptId: data.attemptId });
        return { success: false, error: 'An unexpected error occurred' };
    }
}

// =============================================================================
// UPDATE TIMER / PROGRESS
// =============================================================================

export async function updateAttemptProgress(data: {
    attemptId: string;
    timeRemaining: TimeRemaining;
    currentSection: SectionName;
    currentQuestion: number;
}): Promise<ActionResult<void>> {
    try {
        const parsed = UpdateTimerRequestSchema.safeParse(data);
        if (!parsed.success) return { success: false, error: 'Invalid timer data' };

        const supabase = await sbSSR();

        const {
            data: { user },
            error: authError,
        } = await supabase.auth.getUser();
        if (authError || !user) return { success: false, error: 'Authentication required' };

        const { error: rpcError } = await supabase.rpc('save_attempt_state', {
            p_attempt_id: data.attemptId,
            p_time_remaining: data.timeRemaining,
            p_current_section: data.currentSection,
            p_current_question: data.currentQuestion,
            p_client_now: new Date().toISOString(),
        });

        if (!rpcError) return { success: true };

        const msg = rpcError.message || 'Failed to update progress';

        if (msg.includes('Unauthorized')) return { success: false, error: 'Unauthorized' };
        if (msg.includes('not in progress')) return { success: false, error: 'Attempt is not in progress' };
        if (msg.includes('not found')) return { success: false, error: 'Attempt not found' };

        if (msg.includes('time cannot increase')) {
            examLogger.securityEvent('Progress update rejected: time inflation attempt', {
                attemptId: data.attemptId,
                userId: user.id,
            });
            return { success: false, error: 'Invalid timer state' };
        }

        logger.error('updateAttemptProgress RPC error', rpcError, { attemptId: data.attemptId });
        return { success: false, error: 'Failed to update progress' };
    } catch (error) {
        logger.error('updateAttemptProgress error', error, { attemptId: data.attemptId });
        return { success: false, error: 'An unexpected error occurred' };
    }
}

// =============================================================================
// SUBMIT EXAM
// =============================================================================

// Overloads to support BOTH calling conventions safely:
// 1) submitExam(attemptId, options?)
// 2) submitExam({ attemptId, sessionToken, force_resume, submissionId })
export async function submitExam(
    attemptId: string,
    options?: { sessionToken?: string | null; force_resume?: boolean; submissionId?: string }
): Promise<ActionResult<SubmitExamResponse>>;
export async function submitExam(data: {
    attemptId: string;
    sessionToken?: string | null;
    force_resume?: boolean;
    submissionId?: string;
}): Promise<ActionResult<SubmitExamResponse>>;
export async function submitExam(
    arg1:
        | string
        | {
            attemptId: string;
            sessionToken?: string | null;
            force_resume?: boolean;
            submissionId?: string;
        },
    arg2?: { sessionToken?: string | null; force_resume?: boolean; submissionId?: string }
): Promise<ActionResult<SubmitExamResponse>> {
    // Normalize inputs - use let so we can promote fallback attempt ID if needed
    let normalizedAttemptId = typeof arg1 === 'string' ? arg1 : arg1.attemptId;
    const options =
        typeof arg1 === 'string'
            ? arg2
            : {
                sessionToken: arg1.sessionToken,
                force_resume: arg1.force_resume,
                submissionId: arg1.submissionId,
            };

    try {
        const parsed = SubmitExamRequestSchema.safeParse({
            attemptId: normalizedAttemptId,
            sessionToken: options?.sessionToken,
            force_resume: options?.force_resume,
            submissionId: options?.submissionId,
        });
        if (!parsed.success) return { success: false, error: 'Invalid attempt ID' };

        const supabase = await sbSSR();
        const { getServiceRoleClient } = await import('@/lib/supabase/service-role');
        const adminClient = getServiceRoleClient();

        const {
            data: { user },
            error: authError,
        } = await supabase.auth.getUser();
        if (authError || !user) return { success: false, error: 'Authentication required' };

        const access = await ensureActiveAccess(supabase, user.id, user);
        if (!access.allowed) return { success: false, error: 'Access pending' };

        // CRITICAL: Select 'id' so we can promote fallback attempt ID
        let { data: attempt, error: attemptError } = await adminClient
            .from('attempts')
            .select('id, user_id, status, paper_id, started_at, paused_at, total_paused_seconds')
            .eq('id', normalizedAttemptId)
            .maybeSingle();

        if (attemptError?.code === '42703') {
            const retry = await adminClient
                .from('attempts')
                .select('id, user_id, status, paper_id, started_at')
                .eq('id', normalizedAttemptId)
                .maybeSingle();
            attempt = retry.data
                ? { ...retry.data, paused_at: null, total_paused_seconds: 0 }
                : attempt;
            attemptError = retry.error ?? null;
        }

        if (attemptError || !attempt) {
            const reason = attemptError ? `error:${attemptError.code ?? 'unknown'}` : 'no_rows';
            logger.error('submitExam attempt lookup failed', attemptError, {
                attemptId: normalizedAttemptId,
                userId: user.id,
                reason,
            });

            const { data: recentAttempts, error: recentError } = await adminClient
                .from('attempts')
                .select('id, status, user_id, paper_id, created_at')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false })
                .limit(5);
            logger.error('submitExam recent attempts for user', recentError, {
                attemptId: normalizedAttemptId,
                userId: user.id,
                recentAttempts,
            });
            return { success: false, error: 'Attempt not found' };
        }
        if (attempt.user_id !== user.id) return { success: false, error: 'Unauthorized' };

        // Phase 5: Treat already-submitted as success (idempotent)
        // PHASE 3 FIX: Return data matching successful first submission shape for proper UI redirect
        if (attempt.status === 'completed' || attempt.status === 'submitted') {
            logger.info('submitExam: attempt already submitted, returning success (idempotent)', {
                attemptId: normalizedAttemptId,
                status: attempt.status,
            });
            return {
                success: true,
                data: {
                    success: true,
                    already_submitted: true,
                    attemptId: normalizedAttemptId,
                } as unknown as SubmitExamResponse,
            };
        }
        // CRITICAL FIX: Allow both in_progress AND paused attempts to be submitted
        // Paused exams should be submittable without needing to resume first
        if (attempt.status !== 'in_progress' && attempt.status !== 'paused') {
            return { success: false, error: 'Attempt is not in progress' };
        }
        if (!options?.sessionToken) return { success: false, error: 'Missing session token' };

        // NOTE: Auto-force-resume is always enabled for submissions to prevent stuck states

        const basePausedSeconds = Number.isFinite(attempt.total_paused_seconds as number)
            ? Math.max(0, Math.floor(Number(attempt.total_paused_seconds)))
            : 0;
        const pausedAtMs = attempt.paused_at ? new Date(attempt.paused_at).getTime() : null;
        const inFlightPausedSeconds = pausedAtMs ? Math.max(0, Math.floor((Date.now() - pausedAtMs) / 1000)) : 0;
        const effectivePausedSeconds = basePausedSeconds + inFlightPausedSeconds;

        const { data: isValidSession, error: validateError } = await validateSessionTokenRpc(
            supabase,
            normalizedAttemptId,
            options.sessionToken,
            user.id
        );

        const tryForceResume = async () => {
            examLogger.securityEvent('Force resume (submitExam)', { attemptId: normalizedAttemptId });
            return supabase.rpc('force_resume_exam_session', {
                p_attempt_id: normalizedAttemptId,
                p_new_session_token: options.sessionToken,
            });
        };

        // CRITICAL FIX: Always try force_resume on session issues during submit
        // This prevents auto-submit from getting stuck due to session mismatches
        const handleSessionConflict = async (reason: string): Promise<{ proceed: boolean; error?: string }> => {
            examLogger.securityEvent(`Auto force_resume on submit (${reason})`, { attemptId: normalizedAttemptId });

            const { error: forceResumeError } = await tryForceResume();
            if (forceResumeError) {
                const isStale = forceResumeError.message?.includes('FORCE_RESUME_STALE') ||
                    forceResumeError.message?.includes('stale');
                if (isStale) {
                    // Even on stale, try to proceed with submit if attempt is still valid
                    logger.warn('submitExam: force_resume stale but proceeding with submit', {
                        attemptId: normalizedAttemptId,
                    });
                    return { proceed: true };
                }
                logger.error('submitExam force_resume_exam_session error', forceResumeError, {
                    attemptId: normalizedAttemptId,
                    reason,
                });
                // Even on error, still try to proceed with submit
                return { proceed: true };
            }
            return { proceed: true };
        };

        if (validateError) {
            logger.warn('submitExam validate_session_token error, auto-recovering', validateError, { attemptId: normalizedAttemptId });
            await handleSessionConflict('validate_error');
        } else if (!isValidSession) {
            logger.info('submitExam session invalid, auto-recovering', { attemptId: normalizedAttemptId });
            await handleSessionConflict('invalid_session');
        }

        // Server-side timer validation (dynamic per paper)
        const { data: paperTiming, error: paperTimingError } = await supabase
            .from('papers')
            .select('sections')
            .eq('id', attempt.paper_id)
            .maybeSingle();

        if (paperTimingError) {
            logger.warn('Failed to fetch paper timing for submitExam', paperTimingError, {
                attemptId: normalizedAttemptId,
                paperId: attempt.paper_id,
            });
        }

        const MAX_EXAM_DURATION_SECONDS = getPaperTotalDurationSeconds(paperTiming?.sections);
        const GRACE_PERIOD_SECONDS = 120;

        // Guard: if timing cannot be computed, skip late-submit rejection rather than breaking valid submits.
        if (typeof MAX_EXAM_DURATION_SECONDS === 'number' && MAX_EXAM_DURATION_SECONDS > 0) {
            const startedAtMs = new Date(attempt.started_at).getTime();
            const rawElapsedSeconds = Math.floor((Date.now() - startedAtMs) / 1000);
            const elapsedSeconds = Math.max(0, rawElapsedSeconds - effectivePausedSeconds);

            if (elapsedSeconds > MAX_EXAM_DURATION_SECONDS + GRACE_PERIOD_SECONDS) {
                examLogger.securityEvent('Late submission rejected', {
                    attemptId: normalizedAttemptId,
                    elapsedSeconds,
                    maxAllowed: MAX_EXAM_DURATION_SECONDS + GRACE_PERIOD_SECONDS,
                });

                await adminClient
                    .from('attempts')
                    .update({
                        status: 'completed',
                        submitted_at: new Date().toISOString(),
                        completed_at: new Date().toISOString(),
                    })
                    .eq('id', normalizedAttemptId);

                return { success: false, error: 'Exam time exceeded. Late submissions are not accepted.' };
            }
        }

        const submittedAt = new Date().toISOString();
        const submissionId = options?.submissionId ?? null;

        // Atomic status transition (prevents races/double submit)
        const primaryUpdatePayload: Record<string, unknown> = {
            status: 'submitted',
            submitted_at: submittedAt,
        };
        if (submissionId) {
            primaryUpdatePayload.submission_id = submissionId;
        }

        // CRITICAL FIX: Allow both in_progress AND paused attempts to submit
        // Using .in() to match either status for the atomic transition
        let updateQuery = adminClient
            .from('attempts')
            .update(primaryUpdatePayload)
            .eq('id', normalizedAttemptId)
            .in('status', ['in_progress', 'paused']);

        // Best-effort: if submission_id exists in this DB, attempt idempotent update.
        if (submissionId) {
            try {
                updateQuery = updateQuery.or(`submission_id.is.null,submission_id.eq.${submissionId}`);
            } catch {
                // ignore if column doesn't exist
            }
        }

        let { data: updatedAttempt, error: updateStatusError } = await updateQuery.select('id').maybeSingle();

        if (updateStatusError?.code === '42703') {
            // Retry without submission_id (handles missing column)
            const retry = await adminClient
                .from('attempts')
                .update({ status: 'submitted', submitted_at: submittedAt })
                .eq('id', normalizedAttemptId)
                .in('status', ['in_progress', 'paused'])
                .select('id')
                .maybeSingle();
            updatedAttempt = retry.data ?? updatedAttempt;
            updateStatusError = retry.error ?? null;
        }

        if (updateStatusError?.code === '42703') {
            // Retry without submitted_at (handles older schemas)
            const retry = await adminClient
                .from('attempts')
                .update({ status: 'submitted' })
                .eq('id', normalizedAttemptId)
                .in('status', ['in_progress', 'paused'])
                .select('id')
                .maybeSingle();
            updatedAttempt = retry.data ?? updatedAttempt;
            updateStatusError = retry.error ?? null;
        }

        if (updateStatusError) {
            logger.error('Failed to mark attempt as submitted', updateStatusError, { attemptId: normalizedAttemptId });
            const detail = updateStatusError.message || updateStatusError.code || 'unknown';
            return {
                success: false,
                error:
                    process.env.NODE_ENV !== 'production'
                        ? `Failed to submit exam: ${detail}`
                        : 'Failed to submit exam',
            };
        }

        if (!updatedAttempt) {
            const { data: latestAttempt, error: latestError } = await adminClient
                .from('attempts')
                .select('status')
                .eq('id', normalizedAttemptId)
                .maybeSingle();

            if (!latestError && latestAttempt) {
                if (latestAttempt.status === 'submitted' || latestAttempt.status === 'completed') {
                    logger.info('submitExam: idempotent success after concurrent submit', {
                        attemptId: normalizedAttemptId,
                        status: latestAttempt.status,
                    });
                    return {
                        success: true,
                        data: {
                            success: true,
                            already_submitted: true,
                            attemptId: normalizedAttemptId,
                        } as unknown as SubmitExamResponse,
                    };
                }
            }

            return { success: false, error: 'Attempt already submitted by another request' };
        }

        // Fetch all questions WITH correct_answer (server-side only)
        const { data: questions, error: questionsError } = await adminClient
            .from('questions')
            .select('*')
            .eq('paper_id', attempt.paper_id)
            .eq('is_active', true)
            .order('section')
            .order('question_number');

        if (questionsError || !questions) {
            logger.error('Failed to fetch questions for scoring', questionsError, {
                attemptId: normalizedAttemptId,
                paperId: attempt.paper_id,
            });
            return { success: false, error: 'Failed to fetch questions for scoring' };
        }

        const { data: responses, error: responsesError } = await supabase
            .from('responses')
            .select('question_id, answer, time_spent_seconds')
            .eq('attempt_id', normalizedAttemptId);

        if (responsesError) {
            logger.error('Failed to fetch responses for scoring', responsesError, { attemptId: normalizedAttemptId });
            return { success: false, error: 'Failed to fetch responses' };
        }

        // Submission integrity check (log-only)
        const validQuestionIds = new Set(questions.map((q) => q.id));
        const invalidResponses = (responses || []).filter((r) => !validQuestionIds.has(r.question_id));

        if (invalidResponses.length) {
            examLogger.securityEvent('Invalid responses detected', {
                attemptId: normalizedAttemptId,
                invalidQuestionIds: invalidResponses.map((r) => r.question_id),
            });
        }

        const validResponses = (responses || []).filter((r) => validQuestionIds.has(r.question_id));

        const { calculateScore, calculateTimeTaken } = await import('./scoring');

        const scoringResult = calculateScore(questions as Array<Question & { correct_answer: string }>, validResponses);

        const timeTakenSeconds = calculateTimeTaken(
            attempt.started_at,
            submittedAt,
            effectivePausedSeconds
        );

        const { error: scoreUpdateError } = await adminClient
            .from('attempts')
            .update({
                status: 'completed',
                completed_at: submittedAt,
                total_score: scoringResult.total_score,
                max_possible_score: scoringResult.max_possible_score,
                correct_count: scoringResult.correct_count,
                incorrect_count: scoringResult.incorrect_count,
                unanswered_count: scoringResult.unanswered_count,
                accuracy: scoringResult.accuracy,
                attempt_rate: scoringResult.attempt_rate,
                section_scores: scoringResult.section_scores,
                time_taken_seconds: timeTakenSeconds,
            })
            .eq('id', normalizedAttemptId);

        if (scoreUpdateError) {
            logger.error('Failed to update attempt with scores', scoreUpdateError, { attemptId: normalizedAttemptId });
        }

        const responseScoreUpdates = scoringResult.question_results.map((qr) => ({
            attempt_id: normalizedAttemptId,
            question_id: qr.question_id,
            is_correct: qr.is_correct,
            marks_obtained: qr.marks_obtained,
        }));

        if (responseScoreUpdates.length > 0) {
            const { error: responseScoreError } = await adminClient
                .from('responses')
                .upsert(responseScoreUpdates, { onConflict: 'attempt_id,question_id' });

            if (responseScoreError) {
                logger.error('Failed to update response scores', responseScoreError, {
                    attemptId: normalizedAttemptId,
                });
            }
        }

        return {
            success: true,
            data: {
                success: true,
                total_score: scoringResult.total_score,
                max_score: scoringResult.max_possible_score,
                correct: scoringResult.correct_count,
                incorrect: scoringResult.incorrect_count,
                unanswered: scoringResult.unanswered_count,
                accuracy: scoringResult.accuracy,
                attempt_rate: scoringResult.attempt_rate,
                section_scores: scoringResult.section_scores,
            },
        };
    } catch (error) {
        logger.error('submitExam error', error, { attemptId: normalizedAttemptId });
        return { success: false, error: 'An unexpected error occurred' };
    }
}

// =============================================================================
// FETCH RESULTS
// =============================================================================

export async function fetchExamResults(
    attemptId: string
): Promise<
    ActionResult<{
        attempt: Attempt;
        questions: Array<Question & { correct_answer: string }>;
        responses: Array<{
            question_id: string;
            answer: string | null;
            status?: string | null;
            is_correct: boolean | null;
            marks_obtained: number | null;
            time_spent_seconds?: number | null;
            visit_count?: number | null;
            updated_at?: string | null;
        }>;
    }>
> {
    try {
        const supabase = await sbSSR();

        const {
            data: { user },
            error: authError,
        } = await supabase.auth.getUser();
        if (authError || !user) return { success: false, error: 'Authentication required' };

        const { data: attempt, error: attemptError } = await supabase.from('attempts').select('*').eq('id', attemptId).single();

        if (attemptError || !attempt) return { success: false, error: 'Attempt not found' };
        if (attempt.user_id !== user.id) return { success: false, error: 'Unauthorized' };

        if (attempt.status !== 'completed' && attempt.status !== 'submitted') {
            return { success: false, error: 'Attempt not yet completed' };
        }

        const { data: questions, error: questionsError } = await supabase
            .from('questions_exam')
            .select('*')
            .eq('paper_id', attempt.paper_id)
            .eq('is_active', true)
            .order('section')
            .order('question_number');

        if (questionsError) return { success: false, error: 'Failed to fetch questions' };

        const { data: solutionsData, error: solutionsError } = await supabase.rpc('fetch_attempt_solutions', {
            p_attempt_id: attemptId,
        });

        if (solutionsError) return { success: false, error: 'Failed to fetch solutions' };

        const solutions = Array.isArray(solutionsData) ? solutionsData : solutionsData ? [solutionsData] : [];

        const solutionMap = new Map(
            solutions.map(
                (s: {
                    question_id: string;
                    correct_answer: string;
                    solution_text: string | null;
                    solution_image_url: string | null;
                    video_solution_url: string | null;
                }) => [s.question_id, s]
            )
        );

        const mergedQuestions = (questions || []).map((q) => {
            const solution = solutionMap.get(q.id);
            return {
                ...q,
                correct_answer: solution?.correct_answer ?? '',
                solution_text: solution?.solution_text ?? null,
                solution_image_url: solution?.solution_image_url ?? null,
                video_solution_url: solution?.video_solution_url ?? null,
            } as Question & {
                correct_answer: string;
                solution_text: string | null;
                solution_image_url: string | null;
                video_solution_url: string | null;
            };
        });

        const { data: responses, error: responsesError } = await supabase
            .from('responses')
            .select('question_id, answer, status, is_correct, marks_obtained, time_spent_seconds, visit_count, updated_at')
            .eq('attempt_id', attemptId);

        if (responsesError) return { success: false, error: 'Failed to fetch responses' };

        return {
            success: true,
            data: {
                attempt: attempt as Attempt,
                questions: mergedQuestions as Array<Question & { correct_answer: string }>,
                responses: responses as Array<{
                    question_id: string;
                    answer: string | null;
                    status?: string | null;
                    is_correct: boolean | null;
                    marks_obtained: number | null;
                    time_spent_seconds?: number | null;
                    visit_count?: number | null;
                    updated_at?: string | null;
                }>,
            },
        };
    } catch (error) {
        logger.error('fetchExamResults error', error, { attemptId });
        return { success: false, error: 'An unexpected error occurred' };
    }
}

// =============================================================================
// PAUSE EXAM
// =============================================================================

export async function pauseExam(data: {
    attemptId: string;
    timeRemaining: TimeRemaining;
    currentSection: SectionName;
    currentQuestion: number;
}): Promise<ActionResult<void>> {
    try {
        const supabase = await sbSSR();

        const {
            data: { user },
            error: authError,
        } = await supabase.auth.getUser();
        if (authError || !user) return { success: false, error: 'Authentication required' };

        // Client hint timeRemaining is intentionally unused; RPC is server-authoritative.
        const { error: rpcError } = await supabase.rpc('pause_exam_state', {
            p_attempt_id: data.attemptId,
            p_current_section: data.currentSection,
            p_current_question: data.currentQuestion,
        });

        if (!rpcError) return { success: true };

        const msg = rpcError.message || 'Failed to pause exam';

        if (msg.includes('Unauthorized')) return { success: false, error: 'Unauthorized' };
        if (msg.includes('not in progress')) return { success: false, error: 'Attempt is not in progress' };
        if (msg.includes('not allowed')) return { success: false, error: 'Pause is not allowed for this paper' };
        if (msg.includes('not found')) return { success: false, error: 'Attempt not found' };

        logger.error('pauseExam RPC error', rpcError, { attemptId: data.attemptId });
        return { success: false, error: 'Failed to pause exam' };
    } catch (error) {
        logger.error('pauseExam error', error, { attemptId: data.attemptId });
        return { success: false, error: 'An unexpected error occurred' };
    }
}

// =============================================================================
// REQUEST AI ANALYSIS
// =============================================================================

export async function requestAIAnalysis(
    attemptId: string
): Promise<ActionResult<{ status: string }>> {
    try {
        const supabase = await sbSSR();

        // 1) Auth check
        const {
            data: { user },
            error: authError,
        } = await supabase.auth.getUser();
        if (authError || !user) return { success: false, error: 'Authentication required' };

        // 2) Fetch attempt & verify ownership
        const { data: attempt, error: attemptError } = await supabase
            .from('attempts')
            .select('id, user_id, status, submitted_at, ai_analysis_status')
            .eq('id', attemptId)
            .single();

        if (attemptError || !attempt) return { success: false, error: 'Attempt not found' };
        if (attempt.user_id !== user.id) return { success: false, error: 'Unauthorized' };

        // 3) Must be submitted / completed
        if (attempt.status !== 'submitted' && attempt.status !== 'completed') {
            return { success: false, error: 'Attempt must be submitted before requesting analysis' };
        }
        if (!attempt.submitted_at) {
            return { success: false, error: 'Attempt has no submission timestamp' };
        }

        // 4) Idempotent: if already requested (or further), return success
        if (attempt.ai_analysis_status && attempt.ai_analysis_status !== 'none') {
            return {
                success: true,
                data: { status: attempt.ai_analysis_status },
            };
        }

        // 5) Update status → requested
        const { error: updateError } = await supabase
            .from('attempts')
            .update({
                ai_analysis_status: 'requested',
                ai_analysis_requested_at: new Date().toISOString(),
            })
            .eq('id', attemptId)
            .eq('user_id', user.id);   // RLS-safe: user can only update own rows

        if (updateError) {
            logger.error('requestAIAnalysis update error', updateError, { attemptId });
            return { success: false, error: 'Failed to request analysis' };
        }

        return { success: true, data: { status: 'requested' } };
    } catch (error) {
        logger.error('requestAIAnalysis error', error, { attemptId });
        return { success: false, error: 'An unexpected error occurred' };
    }
}
````
